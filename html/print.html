<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Eunomia-bpf Documents</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="introduction/index.html"><strong aria-hidden="true">1.</strong> Introduction</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="introduction/introduction.html"><strong aria-hidden="true">1.1.</strong> Detail introduction</a></li><li class="chapter-item "><a href="wasm-bpf.html"><strong aria-hidden="true">1.2.</strong> Wasm-bpf subproject</a></li></ol></li><li class="chapter-item "><li class="part-title">User Manual</li><li class="chapter-item "><a href="installation/index.html"><strong aria-hidden="true">2.</strong> Installation</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="installation/build.html"><strong aria-hidden="true">2.1.</strong> Build</a></li><li class="chapter-item "><a href="installation/build-android-arm.html"><strong aria-hidden="true">2.2.</strong> Build on Android or ARM</a></li></ol></li><li class="chapter-item "><a href="quickstart.html"><strong aria-hidden="true">3.</strong> Quick Start</a></li><li class="chapter-item "><a href="ecli-dockerfile-usage.html"><strong aria-hidden="true">4.</strong> Docker manual</a></li><li class="chapter-item "><a href="mannual.html"><strong aria-hidden="true">5.</strong> Manual (Chinese)</a></li><li class="chapter-item "><a href="online.html"><strong aria-hidden="true">6.</strong> Online Demo</a></li><li class="chapter-item "><a href="common_problems.html"><strong aria-hidden="true">7.</strong> Common problems</a></li><li class="chapter-item "><a href="supporting-external-BTF.html"><strong aria-hidden="true">8.</strong> External BTF support</a></li><li class="chapter-item "><a href="benchmark.html"><strong aria-hidden="true">9.</strong> Benchmark</a></li><li class="chapter-item affix "><li class="part-title">videos</li><li class="chapter-item "><a href="video.html"><strong aria-hidden="true">10.</strong> Public talk video</a></li><li class="chapter-item "><a href="blog/index.html"><strong aria-hidden="true">11.</strong> Blog</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="blog/introduce-to-wasm-bpf-bpf-community.html"><strong aria-hidden="true">11.1.</strong> Wasm-bpf: æ¶èµ· Webassembly å’Œ eBPF å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢</a></li><li class="chapter-item "><a href="blog/how-to-write-c-in-wasm.html"><strong aria-hidden="true">11.2.</strong> åœ¨ WebAssembly ä¸­ä½¿ç”¨ C/C++ å’Œ libbpf ç¼–å†™ eBPF ç¨‹åº</a></li><li class="chapter-item "><a href="blog/how-to-write-rust-in-wasm.html"><strong aria-hidden="true">11.3.</strong> åœ¨ WebAssembly ä¸­ä½¿ç”¨ Rust ç¼–å†™ eBPF ç¨‹åºå¹¶å‘å¸ƒ OCI é•œåƒ</a></li><li class="chapter-item "><a href="blog/GPTtrace.html"><strong aria-hidden="true">11.4.</strong> ä½¿ç”¨ ChatGPT ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€ç¼–å†™ eBPF ç¨‹åºå’Œè¿½è¸ª Linux ç³»ç»Ÿ</a></li><li class="chapter-item "><a href="blog/ebpf-wasm.html"><strong aria-hidden="true">11.5.</strong> å½“ Wasm é‡è§ eBPF ï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åº</a></li><li class="chapter-item "><a href="blog/lmp-eunomia.html"><strong aria-hidden="true">11.6.</strong> å¦‚ä½•åœ¨ Linux æ˜¾å¾®é•œï¼ˆLMPï¼‰é¡¹ç›®ä¸­å¼€å¯ eBPF ä¹‹æ—…</a></li><li class="chapter-item "><a href="blog/0.3.0-release.html"><strong aria-hidden="true">11.7.</strong> eunomia-bpf 0.3.0 å‘å¸ƒï¼šåªéœ€ç¼–å†™å†…æ ¸æ€ä»£ç ï¼Œè½»æ¾æ„å»ºã€æ‰“åŒ…ã€å‘å¸ƒå®Œæ•´çš„ eBPF åº”ç”¨</a></li><li class="chapter-item "><a href="blog/coolbpf-eunomia.html"><strong aria-hidden="true">11.8.</strong> eunomia-bpfï¼šå±•æœ› 2023ï¼Œè®© eBPF æ’ä¸Š Wasm çš„ç¿…è†€</a></li><li class="chapter-item "><a href="blog/bpf-news.html"><strong aria-hidden="true">11.9.</strong> eBPF è¿›é˜¶: å†…æ ¸æ–°ç‰¹æ€§è¿›å±•ä¸€è§ˆ</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Eunomia-bpf Documents</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/eunomia-bpf/eunomia-bpf" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="introduction/../img/logo.png" alt="logo" /></p>
<h1 id="eunomia-bpf-simplify-and-enhance-ebpf-with-co-re1-and-webassembly2"><a class="header" href="#eunomia-bpf-simplify-and-enhance-ebpf-with-co-re1-and-webassembly2">eunomia-bpf: simplify and enhance eBPF with CO-RE<sup class="footnote-reference"><a href="#1">1</a></sup> and WebAssembly<sup class="footnote-reference"><a href="#2">2</a></sup></a></h1>
<p><a href="https://github.com/eunomia-bpf/eunomia-bpf/actions"><img src="https://github.com/eunomia-bpf/eunomia-bpf/workflows/Ubuntu/badge.svg" alt="Actions Status" /></a>
<a href="https://github.com/eunomia-bpf/eunomia-bpf/releases"><img src="https://img.shields.io/github/v/release/eunomia-bpf/eunomia-bpf" alt="GitHub release (latest by date)" /></a>
<a href="https://codecov.io/gh/eunomia-bpf/eunomia-bpf"><img src="https://codecov.io/gh/eunomia-bpf/eunomia-bpf/branch/master/graph/badge.svg?token=YTR1M16I70" alt="codecov" /></a>
<a href="https://deepsource.io/gh/eunomia-bpf/eunomia-bpf/?ref=repository-badge"><img src="https://deepsource.io/gh/eunomia-bpf/eunomia-bpf.svg/?label=active+issues&amp;show_trend=true&amp;token=rcSI3J1-gpwLIgZWtKZC-N6C" alt="DeepSource" /></a>
<a href="https://www.codefactor.io/repository/github/eunomia-bpf/eunomia-bpf"><img src="https://www.codefactor.io/repository/github/eunomia-bpf/eunomia-bpf/badge" alt="CodeFactor" /></a></p>
<p><strong>A compiler and runtime framework to help you build and distribute eBPF program easier.</strong></p>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p><code>eunomia-bpf</code> is a dynamic loading library/runtime and a compile toolchain framework, aim at helping you build and distribute eBPF programs easier.</p>
<p>With eunnomia-bpf, you can:</p>
<ul>
<li>A library to simplify <code>writing</code> eBPF programs:
<ul>
<li>simplify building CO-RE<sup class="footnote-reference"><a href="#1">1</a></sup> <code>libbpf</code> eBPF applications: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/introduction.md#simplify-building-co-re-libbpf-ebpf-applications">write eBPF kernel code only</a> and automatically exposing your data with <code>perf event</code> or <code>ring buffer</code> from kernel.</li>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/introduction.md#automatically-sample-the-data-and-print-hists-in-userspace">Automatically sample the data</a> from hash maps and print <code>hists</code> in userspace.</li>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/introduction.md#automatically-generate-and-config-command-line-arguments">Automatically generate</a> and config <code>command line arguments</code> for eBPF programs.</li>
<li>You can writing the kernel part in both <code>BCC</code> and <code>libbpf</code> styles.</li>
</ul>
</li>
<li>Build eBPF programs with <code>Wasm</code><sup class="footnote-reference"><a href="#2">2</a></sup>: see <a href="https://github.com/eunomia-bpf/wasm-bpf"><code>Wasm-bpf</code></a> project
<ul>
<li>Runtime, libraries and toolchains to <a href="https://github.com/eunomia-bpf/wasm-bpf">write eBPF with Wasm</a> in C/C++, Rust, Go...covering the use cases from <code>tracing</code>, <code>networking</code>, <code>security</code>.</li>
</ul>
</li>
<li>simplify <code>distributing</code> eBPF programs:
<ul>
<li>A <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/ecli">tool</a> for push, pull and run pre-compiled eBPF programs as <code>OCI</code> images in Wasm module</li>
<li>Run eBPF programs from <code>cloud</code> or <code>URL</code> within <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/introduction.md#dynamic-load-and-run-co-re-ebpf-kernel-code-from-the-cloud-with-url-or-oci-image"><code>1</code> line of bash</a> without recompiling, kernel version and architecture independent.</li>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/bpf-loader">Dynamically load</a> eBPF programs with <code>JSON</code> config file or <code>Wasm</code> module.</li>
</ul>
</li>
</ul>
<p>For more information, see <a href="introduction/introduction.html">next</a>.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>CO-RE: <a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">Compile Once â€“ Run Everywhere</a>
<sup class="footnote-reference"><a href="#2">2</a></sup>: WebAssembly or Wasm: https://webassembly.org/</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-1"><a class="header" href="#introduction-1">introduction</a></h1>
<p><code>eunomia-bpf</code> is a dynamic loading library/runtime and a compile toolchain framework, aim at helping you build and distribute eBPF programs easier.</p>
<h3 id="simplify-building-co-re-libbpf-ebpf-applications"><a class="header" href="#simplify-building-co-re-libbpf-ebpf-applications">Simplify building CO-RE libbpf eBPF applications</a></h3>
<p>Just Write libbpf eBPF kernel code only, auto config the userspace part!</p>
<h4 id="automatically-exposing-your-data-from-kernel"><a class="header" href="#automatically-exposing-your-data-from-kernel">Automatically exposing your data from kernel</a></h4>
<ul>
<li>
<p>Get data automatically from <code>perf event</code> or <code>ring buffer</code> to userspace:</p>
<pre><code class="language-c">struct {
  __uint(type, BPF_MAP_TYPE_RINGBUF);
  __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
  ....
  e = bpf_ringbuf_reserve(&amp;rb, sizeof(*e), 0);
  ....
  bpf_ringbuf_submit(e, 0);
  return 0;
}
</code></pre>
<p>Compile and Run the program:</p>
<pre><code class="language-console">$ ecc bootstrap.bpf.c bootstrap.h
Compiling bpf object...
Generating export types...
Packing ebpf object and config into package.json...
$ sudo ./ecli examples/bpftools/bootstrap/package.json
TIME     PID     PPID    EXIT_CODE  DURATION_NS  COMM    FILENAME  EXIT_EVENT  
22:01:04  46310  2915    0          0            sh      /bin/sh   0
22:01:04  46311  46310   0          0            which   /usr/bin/which 0
22:01:04  46311  46310   0          2823776      which             1
22:01:04  46310  2915    0          6288891      sh                1
22:01:04  46312  2915    0          0            sh      /bin/sh   0
22:01:04  46313  46312   0          0            ps      /usr/bin/ps 0
</code></pre>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/examples/bpftools/bootstrap">bootstrap</a> for example. This is exactly the same as <a href="https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/bootstrap.bpf.c">bootstrap.bpf.c</a> in <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a> project, but only kernel code is needed.</p>
</li>
</ul>
<h4 id="automatically-sample-the-data-and-print-hists-in-userspace"><a class="header" href="#automatically-sample-the-data-and-print-hists-in-userspace">Automatically sample the data and print <code>hists</code> in userspace</a></h4>
<ul>
<li>
<p>Sample the data from hash maps and print them in human readable format with comments:</p>
<pre><code class="language-c">/// @sample {&quot;interval&quot;: 1000, &quot;type&quot; : &quot;log2_hist&quot;}
struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, MAX_ENTRIES);
    __type(key, u32);
    __type(value, struct hist);
} hists SEC(&quot;.maps&quot;);
</code></pre>
<p>and Get <code>hist</code> data from <code>hists</code> map and print them in human readable format:</p>
<pre><code class="language-bash">$ sudo ecli  examples/bpftools/runqlat/package.json --targ_per_process
key = 8326
comm = containerd

      usec              : count    distribution
        0 -&gt; 1          : 0        |                                        |
        2 -&gt; 3          : 0        |                                        |
        4 -&gt; 7          : 0        |                                        |
        8 -&gt; 15         : 0        |                                        |
       16 -&gt; 31         : 2        |*************                           |
       32 -&gt; 63         : 2        |*************                           |
       64 -&gt; 127        : 6        |****************************************|
      128 -&gt; 255        : 0        |                                        |
      256 -&gt; 511        : 2        |*************                           |
</code></pre>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/examples/bpftools/runqlat/runqlat.bpf.c">examples/bpftools/mdflush.bpf.c</a> for example.</p>
</li>
</ul>
<h4 id="automatically-generate-and-config-command-line-arguments"><a class="header" href="#automatically-generate-and-config-command-line-arguments">Automatically generate and config command line arguments</a></h4>
<ul>
<li>
<p>Automatically generate and config command line arguments for your eBPF program from the comments in your kernel code:</p>
<pre><code class="language-c">/// Process ID to trace
const volatile pid_t pid_target = 0;
/// Thread ID to trace
const volatile pid_t tgid_target = 0;
/// @description User ID to trace
const volatile uid_t uid_target = 0;
/// @cmdarg {&quot;default&quot;: false, &quot;short&quot;: &quot;f&quot;, &quot;long&quot;: &quot;failed&quot;}
/// @description target pid to trace
const volatile bool targ_failed = false;
</code></pre>
<p>and Get:</p>
<pre><code class="language-console">$ sudo ecli  examples/bpftools/opensnoop/package.json -h
Usage: opensnoop_bpf [--help] [--version] [--verbose] [--pid_target VAR] [--tgid_target VAR] [--uid_target VAR] [--failed]

Trace open family syscalls.

Optional arguments:
  -h, --help    shows help message and exits 
  -v, --version prints version information and exits 
  --verbose     prints libbpf debug information 
  --pid_target  Process ID to trace 
  --tgid_target Thread ID to trace
</code></pre>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/examples/bpftools/opensnoop/opensnoop.bpf.c">examples/bpftools/opensnoop/opensnoop.bpf.c</a> for example.</p>
</li>
<li>
<p><code>100%</code> compatible with <code>libbpf</code>, <a href="https://github.com/libbpf/libbpf-bootstrap/tree/master/examples/c">libbpf-bootstrap</a> and <code>libbpf-rs</code>, etc: you can compile <a href="https://github.com/iovisor/bcc/blob/master/libbpf-tools">libbpf-tools</a> kernel code with <code>eunomia-bpf</code> and run them without many modification!</p>
</li>
<li>
<p>Not limited to tracing: support <code>tracepoints</code>, <code>kprobe</code>, <code>uprobe</code>, <code>lsm</code>, <code>xdp</code>, <code>tc</code> etc...</p>
</li>
</ul>
<h3 id="compile-and-pack-co-re-ebpf-kernel-code-to-a-config-file"><a class="header" href="#compile-and-pack-co-re-ebpf-kernel-code-to-a-config-file">Compile and pack CO-RE eBPF kernel code to a config file</a></h3>
<ul>
<li>
<p>Compile and pack CO-RE eBPF kernel code to a <code>JSON</code> or <code>YAML</code> config file:</p>
<pre><code class="language-console">$ ecc cmd/test/opensnoop.bpf.c opensnoop.h
Compiling bpf object...
Generating export types...
Packing ebpf object and config into package.json...
$ docker run -it -v `pwd`/:/src/ ghcr.io/eunomia-bpf/ecc-`uname -m`:latest # build with docker for x86_64 and aarch64
Packing ebpf object and config into package.json...
</code></pre>
<p>You can modify the config file and config the eBPF program behavior to your need.</p>
</li>
</ul>
<h3 id="dynamic-load-and-run-co-re-ebpf-kernel-code-from-the-cloud-with-url-or-oci-image"><a class="header" href="#dynamic-load-and-run-co-re-ebpf-kernel-code-from-the-cloud-with-url-or-oci-image">Dynamic load and run CO-RE eBPF kernel code from the cloud with URL or OCI image</a></h3>
<ul>
<li>
<p>you can dynamically load it on different kernel version without recompile, and without clang/llvm dependency:</p>
<pre><code class="language-console">$ sudo ecli opensnoop.json
TIME     PID     TPID    SIG     RET     COMM    
22:58:28  77121  3168    0       0       cpptools-srv
22:58:29  69044  3168    0       0       cpptools-srv
22:58:29  3014   2906    0       0       code
22:58:29  6952   4061    0       0       node
22:58:29  4061   3937    0       0       node
22:58:29  75263  3168    0       0       cpptools-srv
22:58:29  2906   2488    0       0       code
22:58:29  69149  3168    0       0       cpptools-srv
22:58:29  73541  3168    0       0       cpptools-srv
22:58:29  73468  3168    0       0       cpptools-srv
22:58:29  2906   2488    0       0       code
22:58:29  69094  3168    0       0       cpptools-srv
</code></pre>
</li>
<li>
<p>Get pre-compiled eBPF programs running from the cloud to the kernel in <code>1</code> line of bash, kernel version and architecture independent:</p>
<pre><code class="language-bash"># download the release from https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecli
$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
$ sudo ./ecli https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/package.json # simply run a pre-compiled ebpf code from a url
$ sudo ./ecli sigsnoop:latest # run with a name and download the latest version bpf tool from our repo
</code></pre>
</li>
<li>
<p>very small and simple! The library itself <code>&lt;1MB</code> and no <code>LLVM/Clang</code> dependence, can be embedded easily in you project</p>
</li>
<li>
<p>as fast as <code>&lt;100ms</code> and little resource need to dynamically load and run eBPF program</p>
</li>
</ul>
<p>Base on <code>eunomia-bpf</code>, we have an eBPF pacakge manager in <a href="https://github.com/linuxkerneltravel/lmp">LMP</a> project, with OCI images and <a href="https://github.com/oras-project/oras">ORAS</a> for distribution.</p>
<h3 id="wasm-bpf-write-user-space-code-for-your-ebpf-program-in-webassembly"><a class="header" href="#wasm-bpf-write-user-space-code-for-your-ebpf-program-in-webassembly"><a href="https://github.com/eunomia-bpf/wasm-bpf">wasm-bpf</a>: Write user space code for your eBPF program in WebAssembly</a></h3>
<p>see <a href="https://github.com/eunomia-bpf/wasm-bpf">wasm-bpf</a> project:</p>
<p>A WebAssembly eBPF library, toolchain and runtime powered by <a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">CO-RE</a>(Compile Once â€“ Run Everywhere) <a href="https://github.com/libbpf/libbpf">libbpf</a> and <a href="https://github.com/bytecodealliance/wasm-micro-runtime">WAMR</a>.</p>
<ul>
<li><strong><code>General purpose</code></strong>: provide most abilities from eBPF to Wasm, <code>polling</code> from the ring buffer or perf buffer, bidirectional communications between <code>kernel</code> eBPF and <code>userspace</code> Wasm using <code>maps</code>, dynamically <code>loading</code>, <code>attaching</code> or <code>detaching</code>, etc. Supports a large number of eBPF program types and map types, covering the use cases from <code>tracing</code>, <code>networking</code>, <code>security</code>.</li>
<li><strong><code>High performance</code></strong>: No <code>serialization</code> overhead for complex data types, using <code>shared memory</code> to avoid copy overhead between host and Wasm.</li>
<li><strong><code>Easy to use</code></strong>: provide a similar developing experience as the <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a>, <code>auto generate</code> the Wasm-eBPF skeleton headers and type definitions for bindings.</li>
<li><strong><code>Ultralightweight</code></strong>: the sample runtime has only <code>300+</code> lines of code, binary only <code>1.5 MB</code> in size. Compiled Wasm module would be only <code>~90K</code>. With the same toolchain, you can easily build your own Wasm-eBPF runtime in any languages and platforms!</li>
</ul>
<h2 id="project-architecture"><a class="header" href="#project-architecture">Project Architecture</a></h2>
<p>we have a loader library, a compile toolchain, and some additional tools like cli and a custom metrics exporter.</p>
<p><img src="introduction/../img/eunomia-arch.png" alt="eunomia-arch.png" /></p>
<h3 id="an-bpf-loader-library"><a class="header" href="#an-bpf-loader-library">An bpf-loader library</a></h3>
<p>A wrapper of main functions of libbpf, provide the ability to dynamically load eBPF code to the kernel and run it with a simple JSON and a few API.</p>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/bpf-loader">bpf-loader</a> for details.</p>
<p>A <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/ecli">simple cli interface</a> is provided for bpf-loader library, which you can use it to start any eBPF program from a url in a command. You can download it from <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases/">release</a>.</p>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples">examples</a> for more examples.</p>
<h3 id="a-library-to-load-and-operate-ebpf-program-from-a-wasm-module"><a class="header" href="#a-library-to-load-and-operate-ebpf-program-from-a-wasm-module">A library to load and operate eBPF program from a WASM module</a></h3>
<p>Use the <code>eunomia-bpf</code> library to load <code>eBPF</code> program from a <code>WASM</code> module, you can write a WASM module to operate the eBPF program or process the data in user space <code>WASM</code> runtime. The idea is simple:</p>
<ol>
<li>compile the kernel eBPF code skeleton to the <code>JSON</code> format with <code>eunomia-cc</code> toolchain</li>
<li>embed the <code>JSON</code> data in the <code>WASM</code> module, and provide some API for operating the eBPF program skeleton</li>
<li>load the <code>JSON</code> data from the <code>WASM</code> module and run the eBPF program skeleton with <code>eunomia-bpf</code> library</li>
</ol>
<p>You can have multiple <code>eBPF</code> program in a single <code>WASM</code> module.</p>
<p>See <a href="https://github.com/eunomia-bpf/wasm-bpf">wasm-runtime</a> for details. In fact, <code>wasm-bpf</code> library only exports a few functions from <code>bpf-loader</code> library to the <code>VM</code>, so you can replace the <code>WASM</code> runtime with your own easily.</p>
<p>For example, you can run an eBPF program with a WASM module for an URL:</p>
<pre><code class="language-bash">sudo ./ecli run https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/app.wasm
</code></pre>
<p>You can also generate a WASM program template for eBPF or build WASM module with <code>compiler</code> container:</p>
<pre><code class="language-shell"># for x86_64 and aarch64
docker run -it -v `pwd`/:/src/ ghcr.io/eunomia-bpf/ecc-`uname -m`:latest gen-wasm-skel # generate WASM app template for eBPF
docker run -it -v `pwd`/:/src/ ghcr.io/eunomia-bpf/ecc-`uname -m`:latest build-wasm    # Build WASM module
</code></pre>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/sigsnoop">sigsnoop example</a> for more detail.</p>
<h3 id="a-compile-toolchain-to-help-you-generate-pre-compiled-ebpf-data"><a class="header" href="#a-compile-toolchain-to-help-you-generate-pre-compiled-ebpf-data">A compile toolchain to help you generate pre compiled eBPF data</a></h3>
<p>The toolchain can be used as a docker to generate pre-compiled eBPF data in one command:</p>
<p>see the compile toolchains <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/compiler">compiler</a> for details.</p>
<p>you can also simply use the <a href="https://github.com/eunomia-bpf/ebpm-template">ebpm-template</a> repo as a template in github, just push to it and github action can help you compile CO-RE ebpf code!</p>
<h3 id="other-related-projects"><a class="header" href="#other-related-projects">other related projects</a></h3>
<ul>
<li>
<p>LMP eBPF Hub: <a href="https://github.com/linuxkerneltravel/lmp">github.com/linuxkerneltravel/lmp</a></p>
<blockquote>
<p>a package manager for eBPF based on wasm modules</p>
</blockquote>
</li>
<li>
<p>bolipi online compiler &amp; runner: <a href="https://bolipi.com/ebpf/home/online">https://bolipi.com/ebpf/home/online</a></p>
<blockquote>
<p>an online compiler and runner for eBPF program newbies</p>
</blockquote>
</li>
<li>
<p>An Observability tool</p>
<blockquote>
<p>An prometheus and OpenTelemetry exporter for custom eBPF metrics, written in async rust: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/eunomia-sdks/eunomia-otel">eunomia-exporter</a>. You can compile it or download from <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases/">release</a></p>
</blockquote>
</li>
</ul>
<h2 id="build-the-project"><a class="header" href="#build-the-project">build the project</a></h2>
<p>see <a href="introduction/../installation/build.html">build</a> for details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="-wasm-bpf-wasm-library-and-toolchain-for-ebpf"><a class="header" href="#-wasm-bpf-wasm-library-and-toolchain-for-ebpf">ğŸ“¦ Wasm-bpf: Wasm library and toolchain for eBPF</a></h1>
<p><a href="https://github.com/eunomia-bpf/wasm-bpf/actions"><img src="https://github.com/eunomia-bpf/wasm-bpf/workflows/Ubuntu/badge.svg" alt="Actions Status" /></a>
<a href="https://www.codefactor.io/repository/github/eunomia-bpf/wasm-bpf"><img src="https://www.codefactor.io/repository/github/eunomia-bpf/wasm-bpf/badge" alt="CodeFactor" /></a>
<a href="https://deepsource.io/gh/eunomia-bpf/wasm-bpf/?ref=repository-badge"><img src="https://deepsource.io/gh/eunomia-bpf/wasm-bpf.svg/?label=active+issues&amp;show_trend=true&amp;token=rcSI3J1-gpwLIgZWtKZC-N6C" alt="DeepSource" /></a></p>
<p><a href="https://github.com/eunomia-bpf/wasm-bpf/tree/main/README_zh.md">ä¸­æ–‡æ–‡æ¡£</a> <a href="https://gitee.com/eunomia-bpf/wasm-bpf">Gitee</a> <a href="https://github.com/eunomia-bpf/wasm-bpf">Github</a></p>
<p><code>Wasm-bpf</code> is a WebAssembly eBPF library, toolchain and runtime powered by <a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">CO-RE</a>(Compile Once â€“ Run Everywhere) <a href="https://github.com/libbpf/libbpf">libbpf</a>. It can help you build almost every eBPF programs or usecases to <code>Wasm</code> with nearly zero modification, and run them cross platforms with Wasm sandbox.</p>
<h2 id="introduction-2"><a class="header" href="#introduction-2">Introduction</a></h2>
<p><code>WebAssembly</code> (Wasm) is a portable binary format for executable code. The code is executed at a nearly-native speed in a memory-safe (for host) sandbox, with clearly defined resource constraints, and APIs for communicating with the embedding host environment (eg. proxy).The <code>wasm-bpf</code> project combines Wasm and eBPF technologies to enhance the performance and programmability of eBPF applications.</p>
<p>With <code>wasm-bpf</code>, users can dynamically load and securely execute user-defined or community-contributed Wasm-eBPF codes as <code>plug-ins</code> in their software products, such as observability platforms or service proxy. This enables efficient and scalable data collection, while also allowing for advanced processing and analysis of that data.</p>
<p>It also enables developers to write eBPF programs in familiar languages like <code>C/C++</code>, <code>Rust</code>, <code>Go</code>, and more than 30 other programming languages, and deploy them easily across different Linux distributions. Additionally, cloud providers can leverage wasm-bpf to offer a <code>secure</code> and <code>high-performance</code> environment for their customers to develop and deploy eBPF applications in their cloud environments.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li><strong><code>General purpose</code></strong>: provide most abilities from eBPF to Wasm, <code>polling</code> from the ring buffer or perf buffer, bidirectional communications between <code>kernel</code> eBPF and <code>userspace</code> Wasm using <code>maps</code>, dynamically <code>loading</code>, <code>attaching</code> or <code>detaching</code>, etc. Supports a large number of eBPF program types and map types.</li>
<li><strong><code>High performance</code></strong>: No <code>serialization</code> overhead for complex data types, using <code>shared memory</code> to avoid copy overhead between host and Wasm.</li>
<li><strong><code>Easy to use</code></strong>: provide a similar developing experience as the <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a>, <code>auto generate</code> the Wasm-eBPF skeleton headers and type definitions for bindings. Write your eBPF programs in <code>C/C++</code>, <code>Rust</code>, <code>Go</code> and compile to Wasm.</li>
<li><strong><code>Ultralightweight</code></strong>: the miminal runtime has only <code>1.5 MB</code> in binary size. Compiled Wasm module would be only <code>~90K</code>. With the same toolchain, you can easily build your own Wasm-eBPF runtime in any languages and platforms!</li>
</ul>
<p>See the <a href="https://github.com/eunomia-bpf/wasm-bpf/tree/main/examples">examples</a> directory for examples of eBPF programs written in C, Rust, Go and compiled to Wasm, covering the use cases from <code>tracing</code>, <code>networking</code> to <code>security</code>.</p>
<p>For tools to distribute Wasm-eBPF programs in <a href="https://opencontainers.org/"><code>OCI</code></a> images, please refer to <a href="https://github.com/eunomia-bpf/eunomia-bpf">eunomia-bpf</a> repo.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install"><a class="header" href="#install">Install</a></h1>
<ul>
<li>
<p>Install the <code>ecli</code> tool for running eBPF program from the cloud:</p>
<pre><code class="language-console">$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
$ ./ecli -h
Usage: ecli [--help] [--version] [--json] [--no-cache] url-and-args
....
</code></pre>
</li>
<li>
<p>Install the <code>ecc</code> compiler-toolchain for compiling eBPF kernel code to a <code>config</code> file or <code>Wasm</code> module(<code>clang</code>, <code>llvm</code>, and <code>libclang</code> should be installed for compiling):</p>
<pre><code class="language-console">$ wget https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecc &amp;&amp; chmod +x ./ecc
$ ./ecc -h
eunomia-bpf compiler
Usage: ecc [OPTIONS] &lt;SOURCE_PATH&gt; [EXPORT_EVENT_HEADER]
....
</code></pre>
<p>or use the docker image for compile:</p>
<pre><code class="language-bash"># for x86_64 and aarch64
docker run -it -v `pwd`/:/src/ ghcr.io/eunomia-bpf/ecc-`uname -m`:latest # compile with docker. `pwd` should contains *.bpf.c files and *.h files.
</code></pre>
</li>
<li>
<p>build the compiler, runtime library and tools:</p>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/build.md">build</a> for building details.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build"><a class="header" href="#build">build</a></h1>
<p>If you want to run the cli, in most cases, you don't need to build your own.</p>
<h1 id="building"><a class="header" href="#building">Building</a></h1>
<p>libbpf-bootstrap supports multiple build systems that do the same thing.
This serves as a cross reference for folks coming from different backgrounds.</p>
<h2 id="install-dependencies"><a class="header" href="#install-dependencies">Install Dependencies</a></h2>
<p>You will need <code>clang</code>, <code>libelf</code> and <code>zlib</code> to build the examples, package names may vary across distros.</p>
<p>On Ubuntu/Debian, you need:</p>
<pre><code class="language-shell">$ apt install clang libelf1 libelf-dev zlib1g-dev
</code></pre>
<p>On CentOS/Fedora, you need:</p>
<pre><code class="language-shell">$ dnf install clang elfutils-libelf elfutils-libelf-devel zlib-devel
</code></pre>
<p>install rust toolchain</p>
<pre><code class="language-shell">curl https://sh.rustup.rs -sSf | sh -s
</code></pre>
<h2 id="build-bpf-loader"><a class="header" href="#build-bpf-loader">build bpf-loader</a></h2>
<p>bpf-loader is our core library written in C++17. It has no other dependencies except libbpf.</p>
<pre><code class="language-shell">$ git submodule update --init --recursive --remote       # check out libbpf
$ make bpf-loader                              # build ebpf-loader
</code></pre>
<p>The recommended compiler is gcc9 or later.</p>
<h2 id="build-ecli"><a class="header" href="#build-ecli">build ecli:</a></h2>
<p>After compile the bpf-loader, you can build the cli tool in C++:</p>
<pre><code class="language-shell">$ make ecli
</code></pre>
<p>reference: https://github.com/libbpf/libbpf-bootstrap</p>
<h2 id="build-wasm-lib"><a class="header" href="#build-wasm-lib">build wasm lib</a></h2>
<pre><code class="language-shell">$ make wasm-runtime
</code></pre>
<p>Please install WASI SDK, download the <a href="https://github.com/CraneStation/wasi-sdk/releases">wasi-sdk</a> release and extract the archive to default path /opt/wasi-sdk if you want to compile c code to wasm.</p>
<h2 id="build-compiler"><a class="header" href="#build-compiler">build compiler</a></h2>
<pre><code class="language-shell">$ make ecc
</code></pre>
<h2 id="more-details"><a class="header" href="#more-details">more details</a></h2>
<ul>
<li>You can check the Makefile at project root for more details: <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/compiler/Makefile">Makefile</a></li>
<li>You may want to refer to our CI for more build info: <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/.github/workflows/ecc.yml">ecc.yml</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-on--android"><a class="header" href="#build-on--android">Build on  Android</a></h1>
<p>Androidä¸Šbuildéœ€è¦å…ˆInstalling Debian on Android in Termux </p>
<p>åœ¨Androidä¸Šæ„å»ºæ—¶ï¼Œéœ€è¦å…ˆInstalling Debian on Android in Termux </p>
<ol>
<li>install termux</li>
</ol>
<p>https://github.com/termux/termux-app/releases/tag/v0.118.0</p>
<ol start="2">
<li>install proot-distro</li>
</ol>
<p>select debian distro</p>
<pre><code class="language-sh">pkg install proot-distro
proot-distro install debian
proot-distro login debian
</code></pre>
<ol start="3">
<li>install packages</li>
</ol>
<p>remember <code>proot-distro login debian</code> first</p>
<pre><code class="language-sh">apk update
apt install clang cmake libelf1 libelf-dev zlib1g-dev
</code></pre>
<p>ä¹‹åçš„æ­¥éª¤å’Œåœ¨ARMä¸Šbuildä¸Šç›¸åŒ</p>
<h1 id="build-on--arm"><a class="header" href="#build-on--arm">Build on  ARM</a></h1>
<ol>
<li>åŒæ­¥ eunomia-bpf åˆ°æœ¬åœ°</li>
</ol>
<pre><code class="language-sh">git clone https://github.com/eunomia-bpf/eunomia-bpf.git
cd eunomia-bpf
git submodule update --init --recursive --remote
</code></pre>
<p>2.é…ç½®ç¯å¢ƒå˜é‡</p>
<pre><code class="language-sh">export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
</code></pre>
<p>3.å®‰è£…ä¾èµ–</p>
<pre><code class="language-sh">apt update
apt install clang cmake libelf1 libelf-dev zlib1g-dev
</code></pre>
<p>4.ä¿®æ”¹wasm-runtime/CMakeLists.txt<code>ä¸­çš„</code>WAMR_BUILD_TARGETï¼ˆmay not required)</p>
<p>change <code>set (WAMR_BUILD_TARGET &quot;X86_64&quot;)</code> to <code>set (WAMR_BUILD_TARGET &quot;AARCH64&quot;)</code></p>
<p>5.ç¼–è¯‘</p>
<pre><code class="language-sh">make bpf-loader
make ecli
</code></pre>
<p>6.æ£€æŸ¥è¾“å‡º</p>
<pre><code class="language-sh">root@localhost:~/eunomia-bpf# file ecli/build/bin/Release/ecli
ecli: ELF 64-bit LSB pie executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=eab42b79be75951e3a573aa7c61136239d35c868, for GNU/Linux 3.7.0, with debug_info, not stripped
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<ul>
<li>Github Templateï¼š<a href="https://github.com/eunomia-bpf/ebpm-template">eunomia-bpf/ebpm-template</a></li>
<li>example bpf programs: <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/examples/bpftools">examples/bpftools</a></li>
<li>tutorial: <a href="https://github.com/eunomia-bpf/bpf-developer-tutorial">eunomia-bpf/bpf-developer-tutorial</a></li>
</ul>
<p>You can get pre-compiled eBPF programs running from the cloud to the kernel in <code>1</code> line of bash:</p>
<pre><code class="language-bash">    # download the release from https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecli
    $ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
    $ sudo ./ecli https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/package.json # simply run a pre-compiled ebpf code from a url
    $ sudo ./ecli sigsnoop:latest # run with a name and download the latest version bpf tool from our repo
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ecli"><a class="header" href="#ecli">ecli</a></h1>
<p>bpf è¿è¡Œæ—¶éœ€è¦æœ‰Linuxå†…æ ¸ç›¸å…³æ”¯æŒï¼Œdocker ä¸­çš„å†…æ ¸å…±äº«çš„å®¿ä¸»æœºçš„å†…æ ¸ï¼Œå› æ­¤ä½¿ç”¨dockerè¿è¡Œbpfç¨‹åºæ—¶éœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸ºå®¹å™¨èµ‹äºˆæƒé™å’Œç›¸å…³å†…æ ¸æ”¯æŒã€‚</p>
<p>æ­¤å¤„å‚è€ƒhttps://github.com/iovisor/bpftrace/blob/master/INSTALL.md#kernel-headers-install</p>
<pre><code class="language-shell">$ docker run -ti -v /usr/src:/usr/src:ro \
       -v /lib/modules/:/lib/modules:ro \
       -v /sys/kernel/debug/:/sys/kernel/debug:rw \
       -v /home/admin/my:/root/my \ //æŒ‚è½½æœ¬æœºç›®å½•åˆ°å®¹å™¨çš„/root/myè·¯å¾„ä¸‹
       --net=host --pid=host --privileged \
       ecli:1.0.1
</code></pre>
<h2 id="dockerfile-ubuntu"><a class="header" href="#dockerfile-ubuntu">dockerfile ubuntu</a></h2>
<p>dockerfileçš„åŸºç¡€é•œåƒæ˜¯Ubuntuï¼Œå›½å†…ä½¿ç”¨æ—¶å› ä¸ºæœ‰å¢™çš„å­˜åœ¨ï¼Œæ‰€ä»¥éœ€è¦å¯¹Linuxè¿›è¡Œæ¢æºã€‚sources.listå¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
</code></pre>
<p>dockerfileä¸­çš„å…·ä½“å†…å®¹å¦‚ä¸‹</p>
<pre><code class="language-shell">FROM ubuntu:latest

ENV UBUNTU_SOURCE /etc/apt

COPY ./ /root

WORKDIR /root

ADD sources.list $UBUNTU_SOURCE/

RUN apt-get update &amp;&amp; \
    apt-get -y install gcc libelf-dev

#CMD ./ecli run /root/my/package.json
CMD [&quot;/bin/bash&quot;]

</code></pre>
<p>ubuntu.dockerfileæ„å»ºæ—¶ï¼ŒåŒä¸€çº§ç›®å½•ä¸‹çš„æ–‡ä»¶å¦‚ä¸‹</p>
<p><img src="img/image-20220905232754264.png" alt="image-20220905232754264" /></p>
<p>ecliå¯æ‰§è¡Œæ–‡ä»¶  sources.list Dockerfileè¿™ä¸‰ä¸ªæ–‡ä»¶ç¼ºä¸€ä¸å¯ï¼Œotheræ–‡ä»¶å¯å¿½ç•¥ã€‚dockerå®¹å™¨ä¸­wgetæ— æ³•è¿æ¥å¤–éƒ¨ç½‘ç»œï¼Œå› æ­¤éœ€è¦åœ¨dockeræ„å»ºæ—¶å°†ecliæ”¾å…¥é•œåƒä¸­ã€‚ä½¿ç”¨é•œåƒæ—¶åªè¦æŒ‚è½½çš„æœ¬æœºç›®å½•ä¸­æœ‰package.jsonæ–‡ä»¶å³å¯ã€‚</p>
<h2 id="docker-alpine"><a class="header" href="#docker-alpine">docker alpine</a></h2>
<pre><code class="language-shell">FROM alpine:latest

COPY ./ /root

WORKDIR /root

RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories &amp;&amp; \
    apk update &amp;&amp; \
    apk install gcc libelf gcompat

#CMD ./ecli run /root/my/package.json
</code></pre>
<p>alpine.dockerfileæ„å»ºé•œåƒæ—¶ï¼ŒåŒä¸€çº§ç›®å½•ä¸‹å¿…é¡»æœ‰ecliå¯æ‰§è¡Œæ–‡ä»¶ã€‚
ç›®å‰alpine.dockerfileä»å­˜åœ¨ä»¥ä¸‹é—®é¢˜</p>
<p><img src="img/image-20220907195237651.png" alt="image-20220907195237651" /></p>
<h3 id="docker-build"><a class="header" href="#docker-build">docker build</a></h3>
<p>dockerfileæ„å»ºæ—¶ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤</p>
<pre><code class="language-shell">sudo docker build -t ecli:1.0.1 .
</code></pre>
<h3 id="å‚è€ƒæ–‡æ¡£"><a class="header" href="#å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</a></h3>
<p>bpftrace å®˜æ–¹è¯´æ˜ï¼ˆå¦‚ä½•è®©bpfç¨‹åºåœ¨dockerä¸­è¿è¡Œï¼‰</p>
<p>https://github.com/iovisor/bpftrace/blob/master/INSTALL.md#kernel-headers-install</p>
<p>å¦‚ä½•åœ¨macä¸­è¿è¡Œå¸¦æœ‰bpfè¿è¡Œç¯å¢ƒçš„docker</p>
<p>https://petermalmgren.com/docker-mac-bpf-perf/</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eunomia-bpf-ç”¨æˆ·æ‰‹å†Œ-è®©-ebpf-ç¨‹åºçš„å¼€å‘å’Œéƒ¨ç½²å°½å¯èƒ½ç®€å•"><a class="header" href="#eunomia-bpf-ç”¨æˆ·æ‰‹å†Œ-è®©-ebpf-ç¨‹åºçš„å¼€å‘å’Œéƒ¨ç½²å°½å¯èƒ½ç®€å•">eunomia-bpf ç”¨æˆ·æ‰‹å†Œ: è®© eBPF ç¨‹åºçš„å¼€å‘å’Œéƒ¨ç½²å°½å¯èƒ½ç®€å•</a></h1>
<!-- TOC -->
<ul>
<li><a href="mannual.html#eunomia-bpf-%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C-%E8%AE%A9-ebpf-%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E9%83%A8%E7%BD%B2%E5%B0%BD%E5%8F%AF%E8%83%BD%E7%AE%80%E5%8D%95">eunomia-bpf ç”¨æˆ·æ‰‹å†Œ: è®© eBPF ç¨‹åºçš„å¼€å‘å’Œéƒ¨ç½²å°½å¯èƒ½ç®€å•</a>
<ul>
<li><a href="mannual.html#%E4%BB%8E-c-%E8%AF%AD%E8%A8%80-%E7%9A%84-hello-world-%E5%BC%80%E5%A7%8B">ä» <em>C è¯­è¨€</em> çš„ Hello World å¼€å§‹</a></li>
<li><a href="mannual.html#eunomia-bpf-%E7%9A%84-hello-world">eunomia-bpf çš„ Hello World</a></li>
<li><a href="mannual.html#%E6%B7%BB%E5%8A%A0-map-%E8%AE%B0%E5%BD%95%E6%95%B0%E6%8D%AE">æ·»åŠ  map è®°å½•æ•°æ®</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-ring-buffer-%E5%BE%80%E7%94%A8%E6%88%B7%E6%80%81%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE">ä½¿ç”¨ ring buffer å¾€ç”¨æˆ·æ€å‘é€æ•°æ®</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-perf-event-array-%E5%BE%80%E7%94%A8%E6%88%B7%E6%80%81%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE">ä½¿ç”¨ perf event array å¾€ç”¨æˆ·æ€å‘é€æ•°æ®</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-github-template-%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E7%BC%96%E8%AF%91">ä½¿ç”¨ github-template å®ç°è¿œç¨‹ç¼–è¯‘</a></li>
<li><a href="mannual.html#%E9%80%9A%E8%BF%87-api-%E8%BF%9B%E8%A1%8C%E7%83%AD%E6%8F%92%E6%8B%94%E5%92%8C%E5%88%86%E5%8F%91">é€šè¿‡ API è¿›è¡Œçƒ­æ’æ‹”å’Œåˆ†å‘</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-prometheus-%E6%88%96-opentelemetry-%E8%BF%9B%E8%A1%8C%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86">ä½¿ç”¨ Prometheus æˆ– OpenTelemetry è¿›è¡Œå¯è§‚æµ‹æ€§æ•°æ®æ”¶é›†</a>
<ul>
<li><a href="mannual.html#example">example</a></li>
</ul>
</li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-wasm-%E6%A8%A1%E5%9D%97%E5%88%86%E5%8F%91%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD-ebpf-%E7%A8%8B%E5%BA%8F">ä½¿ç”¨ Wasm æ¨¡å—åˆ†å‘ã€åŠ¨æ€åŠ è½½ eBPF ç¨‹åº</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-wasm-%E5%BC%80%E5%8F%91%E5%92%8C%E6%89%93%E5%8C%85-ebpf-%E7%A8%8B%E5%BA%8F">ä½¿ç”¨ Wasm å¼€å‘å’Œæ‰“åŒ… eBPF ç¨‹åº</a>
<ul>
<li><a href="mannual.html#bootstrap">bootstrap</a></li>
<li><a href="mannual.html#%E7%BC%96%E5%86%99%E5%86%85%E6%A0%B8%E6%80%81%E7%9A%84-ebpf-%E7%A8%8B%E5%BA%8F">ç¼–å†™å†…æ ¸æ€çš„ eBPF ç¨‹åº</a></li>
<li><a href="mannual.html#%E6%9E%84%E5%BB%BA%E7%94%A8%E6%88%B7%E6%80%81%E7%9A%84-wasm-%E4%BB%A3%E7%A0%81%E5%B9%B6%E8%8E%B7%E5%8F%96%E5%86%85%E6%A0%B8%E6%80%81%E6%95%B0%E6%8D%AE">æ„å»ºç”¨æˆ·æ€çš„ Wasm ä»£ç ï¼Œå¹¶è·å–å†…æ ¸æ€æ•°æ®</a></li>
<li><a href="mannual.html#bootstrap-1">bootstrap</a></li>
<li><a href="mannual.html#%E7%BC%96%E5%86%99%E5%86%85%E6%A0%B8%E6%80%81%E7%9A%84-ebpf-%E7%A8%8B%E5%BA%8F-1">ç¼–å†™å†…æ ¸æ€çš„ eBPF ç¨‹åº</a></li>
<li><a href="mannual.html#%E6%9E%84%E5%BB%BA%E7%94%A8%E6%88%B7%E6%80%81%E7%9A%84-wasm-%E4%BB%A3%E7%A0%81%E5%B9%B6%E8%8E%B7%E5%8F%96%E5%86%85%E6%A0%B8%E6%80%81%E6%95%B0%E6%8D%AE-1">æ„å»ºç”¨æˆ·æ€çš„ Wasm ä»£ç ï¼Œå¹¶è·å–å†…æ ¸æ€æ•°æ®</a></li>
<li><a href="mannual.html#%E4%BB%8E%E7%94%A8%E6%88%B7%E6%80%81%E7%A8%8B%E5%BA%8F%E4%B8%AD%E8%AE%BF%E9%97%AE%E5%92%8C%E6%9B%B4%E6%96%B0-ebpf-%E7%A8%8B%E5%BA%8F%E7%9A%84-map-%E6%95%B0%E6%8D%AE">ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–° eBPF ç¨‹åºçš„ map æ•°æ®</a></li>
<li><a href="mannual.html#%E4%BB%8E%E7%94%A8%E6%88%B7%E6%80%81%E7%A8%8B%E5%BA%8F%E4%B8%AD%E8%AE%BF%E9%97%AE%E5%92%8C%E6%9B%B4%E6%96%B0-ebpf-%E7%A8%8B%E5%BA%8F%E7%9A%84-map-%E6%95%B0%E6%8D%AE-1">ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–° eBPF ç¨‹åºçš„ map æ•°æ®</a></li>
<li><a href="mannual.html#%E6%9B%B4%E5%A4%9A%E7%9A%84%E4%BE%8B%E5%AD%90socket-filter-%E5%92%8C-lsm">æ›´å¤šçš„ä¾‹å­ï¼šsocket filter å’Œ lsm</a></li>
</ul>
</li>
<li><a href="mannual.html#%E6%BC%94%E7%A4%BA%E8%A7%86%E9%A2%91">æ¼”ç¤ºè§†é¢‘</a></li>
<li><a href="mannual.html#%E5%8E%9F%E7%90%86">åŸç†</a></li>
<li><a href="mannual.html#%E4%B8%BA%E6%88%91%E4%BB%AC%E7%9A%84%E9%A1%B9%E7%9B%AE%E8%B4%A1%E7%8C%AE%E4%BB%A3%E7%A0%81">ä¸ºæˆ‘ä»¬çš„é¡¹ç›®è´¡çŒ®ä»£ç </a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p>ä¼ ç»Ÿæ¥è¯´ï¼Œ eBPF çš„å¼€å‘æ–¹å¼ä¸»è¦æœ‰ BCCã€libbpf ç­‰æ–¹å¼ã€‚è¦å®Œæˆä¸€ä¸ª BPF äºŒè¿›åˆ¶ç¨‹åºçš„å¼€å‘ï¼Œéœ€è¦æ­å»ºå¼€å‘ç¼–è¯‘ç¯å¢ƒï¼Œè¦å…³æ³¨ç›®æ ‡ç³»ç»Ÿçš„å†…æ ¸ç‰ˆæœ¬æƒ…å†µï¼Œéœ€è¦æŒæ¡ä» BPF å†…æ ¸æ€åˆ°ç”¨æˆ·æ€ç¨‹åºçš„ç¼–å†™ï¼Œä»¥åŠå¦‚ä½•åŠ è½½ã€ç»‘å®šè‡³å¯¹åº”çš„ HOOK ç‚¹ç­‰å¾…äº‹ä»¶è§¦å‘ï¼Œæœ€åå†å¯¹è¾“å‡ºçš„æ—¥å¿—åŠæ•°æ®è¿›è¡Œå¤„ç†ã€‚</p>
<p>æˆ‘ä»¬å¸Œæœ›æœ‰è¿™æ ·ä¸€ç§ eBPF çš„ç¼–è¯‘å’Œè¿è¡Œå·¥å…·é“¾ï¼Œå°±åƒå…¶ä»–å¾ˆå¤šè¯­è¨€ä¸€æ ·ï¼š</p>
<ul>
<li>
<p>å¤§å¤šæ•°ç”¨æˆ·åªéœ€è¦å…³æ³¨ <code>bpf.c</code> ç¨‹åºæœ¬èº«çš„ç¼–å†™ï¼Œä¸éœ€è¦å†™ä»»ä½•å…¶ä»–çš„ä»€ä¹ˆ Python, Clang ä¹‹ç±»çš„ç”¨æˆ·æ€è¾…åŠ©ä»£ç æ¡†æ¶ï¼›
è¿™æ ·æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°åˆ†å‘ã€é‡ç”¨ eBPF ç¨‹åºæœ¬èº«ï¼Œè€Œä¸éœ€è¦å’ŒæŸç§æˆ–å‡ ç§è¯­è¨€çš„ç”Ÿæ€ç»‘å®šï¼›</p>
</li>
<li>
<p>æœ€å¤§ç¨‹åº¦ä¸Šå’Œä¸»æµçš„ libbpf æ¡†æ¶å®ç°å…¼å®¹ï¼ŒåŸå…ˆä½¿ç”¨ libbpf æ¡†æ¶ç¼–å†™çš„ä»£ç å‡ ä¹ä¸éœ€è¦æ”¹åŠ¨å³å¯ç§»æ¤ï¼›eunomia-bpf ç¼–å†™çš„ eBPF ç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨ libbpf æ¡†æ¶æ¥ç›´æ¥ç¼–è¯‘è¿è¡Œï¼›</p>
</li>
<li>
<p>æœ¬åœ°åªéœ€è¦ä¸‹è½½ä¸€ä¸ªå¾ˆå°çš„äºŒè¿›åˆ¶è¿è¡Œæ—¶ï¼Œæ²¡æœ‰ä»»ä½•çš„ Clang LLVM ä¹‹ç±»çš„å¤§å‹ä¾èµ–ï¼Œå¯ä»¥æ”¯æŒçƒ­æ’æ‹”ã€çƒ­æ›´æ–°ï¼›
ä¹Ÿå¯ä»¥ä½œä¸º Lua è™šæ‹Ÿæœºé‚£æ ·çš„å°æ¨¡å—ç›´æ¥ç¼–è¯‘åµŒå…¥å…¶ä»–çš„å¤§å‹è½¯ä»¶ä¸­ï¼Œæä¾› eBPF ç¨‹åºæœ¬èº«çš„æœåŠ¡ï¼›è¿è¡Œå’Œå¯åŠ¨æ—¶èµ„æºå ç”¨ç‡éƒ½å¾ˆä½ï¼›</p>
</li>
<li>
<p>è®© eBPF ç¨‹åºçš„åˆ†å‘å’Œä½¿ç”¨åƒç½‘é¡µå’Œ Web æœåŠ¡ä¸€æ ·è‡ªç„¶ï¼ˆMake eBPF as a serviceï¼‰ï¼š
æ”¯æŒåœ¨é›†ç¾¤ç¯å¢ƒä¸­ç›´æ¥é€šè¿‡ä¸€æ¬¡è¯·æ±‚è¿›è¡Œåˆ†å‘å’Œçƒ­æ›´æ–°ï¼Œä»…éœ€æ•°å kB çš„ payloadï¼Œ
&lt;100ms çš„æ›´æ–°æ—¶é—´ï¼Œå’Œå°‘é‡çš„ CPU å†…å­˜å ç”¨å³å¯å®Œæˆ eBPF ç¨‹åºçš„åˆ†å‘ã€éƒ¨ç½²å’Œæ›´æ–°ï¼›
ä¸éœ€è¦æ‰§è¡Œé¢å¤–çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå°±èƒ½å¾—åˆ° CO-RE çš„è¿è¡Œæ•ˆç‡ï¼›</p>
</li>
</ul>
<h2 id="ä»-c-è¯­è¨€-çš„-hello-world-å¼€å§‹"><a class="header" href="#ä»-c-è¯­è¨€-çš„-hello-world-å¼€å§‹">ä» <em>C è¯­è¨€</em> çš„ Hello World å¼€å§‹</a></h2>
<p>è¿˜è®°å¾—æ‚¨ç¬¬ä¸€æ¬¡å†™ <em>C è¯­è¨€</em> çš„ <strong>Hello World ç¨‹åº</strong> å—ï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª <code>.c</code> æ–‡ä»¶ï¼Œå®ƒåŒ…å«ä¸€ä¸ª <code>main</code> å‡½æ•°ï¼š</p>
<pre><code class="language-c">int main(void)
{
    printf(&quot;Hello, World!\n&quot;);
    return 0;
}
</code></pre>
<p>æˆ‘ä»¬å«å®ƒ <code>hello.c</code>ï¼Œæ¥ä¸‹æ¥å°±åªéœ€è¦è¿™å‡ ä¸ªæ­¥éª¤å°±å¥½ï¼š</p>
<pre><code class="language-bash"># if you are using Ubuntu without a c compiler
sudo apt insalll build-essentials
# compile the program
gcc -o hello hello.c
# run the program
./hello
</code></pre>
<p>åªéœ€è¦å†™ä¸€ä¸ª c æ–‡ä»¶ï¼Œæ‰§è¡Œä¸¤è¡Œå‘½ä»¤å°±å¯ä»¥è¿è¡Œï¼›å¤§å¤šæ•°æƒ…å†µä¸‹ä½ ä¹Ÿå¯ä»¥æŠŠç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ç›´æ¥ç§»åŠ¨åˆ°å…¶ä»–åŒæ ·æ¶æ„çš„æœºå™¨æˆ–ä¸åŒç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿä¸Šï¼Œç„¶åè¿è¡Œå®ƒï¼Œä¹Ÿä¼šå¾—åˆ°ä¸€æ ·çš„ç»“æœ:</p>
<pre><code class="language-plaintext">Hello World!
</code></pre>
<h2 id="eunomia-bpf-çš„-hello-world"><a class="header" href="#eunomia-bpf-çš„-hello-world">eunomia-bpf çš„ Hello World</a></h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª <code>bpf.c</code> æ–‡ä»¶ï¼Œå®ƒå°±æ˜¯æ­£å¸¸çš„ã€åˆæ³•çš„ C è¯­è¨€ä»£ç ï¼Œå’Œ libbpf æ‰€ä½¿ç”¨çš„å®Œå…¨ç›¸åŒï¼š</p>
<pre><code class="language-c">#include &lt;linux/bpf.h&gt;
#include &lt;bpf/bpf_helpers.h&gt;
#include &lt;bpf/bpf_tracing.h&gt;

typedef int pid_t;

char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

SEC(&quot;tp/syscalls/sys_enter_write&quot;)
int handle_tp(void *ctx)
{
 pid_t pid = bpf_get_current_pid_tgid() &gt;&gt; 32;
 bpf_printk(&quot;BPF triggered from PID %d.\n&quot;, pid);
 return 0;
}
</code></pre>
<p>å‡è®¾å®ƒå« <code>hello.bpf.c</code>ï¼Œæ–°å»ºä¸€ä¸ª <code>/path/to/repo</code> çš„æ–‡ä»¶å¤¹å¹¶ä¸”æŠŠå®ƒæ”¾è¿›å»ï¼Œæ¥ä¸‹æ¥çš„æ­¥éª¤ï¼š</p>
<pre><code class="language-console"># ä¸‹è½½å®‰è£… ecli äºŒè¿›åˆ¶
wget https://aka.pw/bpf-ecli -O /usr/local/ecli &amp;&amp; chmod +x /usr/local/ecli
# ä½¿ç”¨å®¹å™¨è¿›è¡Œç¼–è¯‘ï¼Œç”Ÿæˆä¸€ä¸ª package.json æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯å·²ç»ç¼–è¯‘å¥½çš„ä»£ç å’Œä¸€äº›è¾…åŠ©ä¿¡æ¯
docker run -it -v /path/to/repo:/src yunwei37/ebpm:latest
# è¿è¡Œ eBPF ç¨‹åºï¼ˆroot shellï¼‰
sudo ecli run package.json
</code></pre>
<blockquote>
<p>ä½¿ç”¨ docker çš„æ—¶å€™éœ€è¦æŠŠåŒ…å« .bpf.c æ–‡ä»¶çš„ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ /src ç›®å½•ä¸‹ï¼Œç›®å½•ä¸­åªæœ‰ä¸€ä¸ª .bpf.c æ–‡ä»¶ï¼›</p>
</blockquote>
<p>å®ƒä¼šè¿½è¸ªæ‰€æœ‰è¿›è¡Œ write ç³»ç»Ÿè°ƒç”¨çš„è¿›ç¨‹çš„ pidï¼š</p>
<pre><code class="language-console">$ sudo cat /sys/kernel/debug/tracing/trace_pipe
cat-42755   [003] d...1 48755.529860: bpf_trace_printk: BPF triggered from PID 42755.
             cat-42755   [003] d...1 48755.529874: bpf_trace_printk: BPF triggered from PID 42755.
</code></pre>
<p>æˆ‘ä»¬ç¼–è¯‘å¥½çš„ eBPF ä»£ç åŒæ ·å¯ä»¥é€‚é…å¤šç§å†…æ ¸ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥æŠŠ package.json å¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªæœºå™¨ä¸Šï¼Œç„¶åä¸éœ€è¦é‡æ–°ç¼–è¯‘å°±å¯ä»¥ç›´æ¥è¿è¡Œï¼ˆCO-REï¼šCompile Once Run Every Whereï¼‰ï¼›ä¹Ÿå¯ä»¥é€šè¿‡ç½‘ç»œä¼ è¾“å’Œåˆ†å‘ package.jsonï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå‹ç¼©åçš„ç‰ˆæœ¬åªæœ‰å‡  kb åˆ°å‡ å kbã€‚</p>
<h2 id="æ·»åŠ -map-è®°å½•æ•°æ®"><a class="header" href="#æ·»åŠ -map-è®°å½•æ•°æ®">æ·»åŠ  map è®°å½•æ•°æ®</a></h2>
<p>å‚è€ƒï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/bootstrap">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/bootstrap</a></p>
<pre><code class="language-c">
struct {
 __uint(type, BPF_MAP_TYPE_HASH);
 __uint(max_entries, 8192);
 __type(key, pid_t);
 __type(value, u64);
} exec_start SEC(&quot;.maps&quot;);

</code></pre>
<p>æ·»åŠ  map çš„åŠŸèƒ½å’Œ libbpf æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œåªéœ€è¦åœ¨ .bpf.c ä¸­å®šä¹‰å³å¯ã€‚</p>
<h2 id="ä½¿ç”¨-ring-buffer-å¾€ç”¨æˆ·æ€å‘é€æ•°æ®"><a class="header" href="#ä½¿ç”¨-ring-buffer-å¾€ç”¨æˆ·æ€å‘é€æ•°æ®">ä½¿ç”¨ ring buffer å¾€ç”¨æˆ·æ€å‘é€æ•°æ®</a></h2>
<p>å‚è€ƒï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/bootstrap">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/bootstrap</a></p>
<p>åªéœ€è¦å®šä¹‰ä¸€ä¸ªå¤´æ–‡ä»¶ï¼ŒåŒ…å«ä½ æƒ³è¦å‘é€ç»™ç”¨æˆ·æ€çš„æ•°æ®æ ¼å¼ï¼Œä»¥ <code>.h</code> ä½œä¸ºåç¼€åï¼š</p>
<pre><code class="language-c">/* SPDX-License-Identifier: (LGPL-2.1 OR BSD-2-Clause) */
/* Copyright (c) 2020 Facebook */
#ifndef __BOOTSTRAP_H
#define __BOOTSTRAP_H

#define TASK_COMM_LEN 16
#define MAX_FILENAME_LEN 127

struct event {
 int pid;
 int ppid;
 unsigned exit_code;
 unsigned long long duration_ns;
 char comm[TASK_COMM_LEN];
 char filename[MAX_FILENAME_LEN];
 unsigned char exit_event;
};

#endif /* __BOOTSTRAP_H */
</code></pre>
<p>åœ¨ä»£ç ä¸­å®šä¹‰ç¯å½¢ç¼“å†²åŒºä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒï¼š</p>
<pre><code class="language-c">struct {
 __uint(type, BPF_MAP_TYPE_RINGBUF);
 __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
    ......
 e-&gt;exit_event = false;
 e-&gt;pid = pid;
 e-&gt;ppid = BPF_CORE_READ(task, real_parent, tgid);
 bpf_get_current_comm(&amp;e-&gt;comm, sizeof(e-&gt;comm));
 /* successfully submit it to user-space for post-processing */
 bpf_ringbuf_submit(e, 0);
 return 0;
}
</code></pre>
<p>eunomia-bpf ä¼šè‡ªåŠ¨å»æºä»£ç ä¸­æ‰¾åˆ°å¯¹åº”çš„ ring buffer mapï¼Œå¹¶ä¸”æŠŠ ring buffer å’Œç±»å‹ä¿¡æ¯è®°å½•åœ¨ç¼–è¯‘å¥½çš„ä¿¡æ¯ä¸­ï¼Œå¹¶åœ¨è¿è¡Œçš„æ—¶å€™è‡ªåŠ¨å®Œæˆå¯¹äº ring buffer çš„åŠ è½½ã€å¯¼å‡ºäº‹ä»¶ç­‰å·¥ä½œã€‚æ‰€æœ‰çš„ eBPF ä»£ç å’ŒåŸç”Ÿçš„ libbpf ç¨‹åºæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä½¿ç”¨ eunomia-bpf å¼€å‘çš„ä»£ç ä¹Ÿå¯ä»¥åœ¨ libbpf ä¸­æ— éœ€ä»»ä½•æ”¹åŠ¨å³å¯ç¼–è¯‘è¿è¡Œã€‚</p>
<h2 id="ä½¿ç”¨-perf-event-array-å¾€ç”¨æˆ·æ€å‘é€æ•°æ®"><a class="header" href="#ä½¿ç”¨-perf-event-array-å¾€ç”¨æˆ·æ€å‘é€æ•°æ®">ä½¿ç”¨ perf event array å¾€ç”¨æˆ·æ€å‘é€æ•°æ®</a></h2>
<p>ä½¿ç”¨ perf event çš„åŸç†å’Œä½¿ç”¨ ring buffer éå¸¸ç±»ä¼¼ï¼Œä½¿ç”¨æˆ‘ä»¬çš„æ¡†æ¶æ—¶ï¼Œä¹Ÿåªéœ€è¦åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰å¥½æ‰€éœ€å¯¼å‡ºçš„äº‹ä»¶ï¼Œç„¶åå®šä¹‰ä¸€ä¸‹ perf event mapï¼š</p>
<pre><code class="language-c">struct {
 __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);
 __uint(key_size, sizeof(u32));
 __uint(value_size, sizeof(u32));
} events SEC(&quot;.maps&quot;);
</code></pre>
<p>å¯ä»¥å‚è€ƒï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop</a> å®ƒæ˜¯ç›´æ¥ä» libbpf-tools ä¸­ç§»æ¤çš„å®ç°ï¼›</p>
<h2 id="ä½¿ç”¨-github-template-å®ç°è¿œç¨‹ç¼–è¯‘"><a class="header" href="#ä½¿ç”¨-github-template-å®ç°è¿œç¨‹ç¼–è¯‘">ä½¿ç”¨ github-template å®ç°è¿œç¨‹ç¼–è¯‘</a></h2>
<p>ç”±äº eunomia-bpf çš„ç¼–è¯‘å’Œè¿è¡Œé˜¶æ®µå®Œå…¨åˆ†ç¦»ï¼Œå¯ä»¥å®ç°åœ¨ github ç½‘é¡µä¸Šç¼–è¾‘ä¹‹åï¼Œé€šè¿‡ github actions æ¥å®Œæˆç¼–è¯‘ï¼Œä¹‹ååœ¨æœ¬åœ°ä¸€è¡Œå‘½ä»¤å³å¯å¯åŠ¨ï¼š</p>
<ol>
<li>å°†æ­¤ <a href="https://github.com/eunomia-bpf/ebpm-template">github.com/eunomia-bpf/ebpm-template</a> ç”¨ä½œ github æ¨¡æ¿ï¼šè¯·å‚é˜… <a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/creating-a-repository-from-a-template">creating-a-repository-from-a-template</a></li>
<li>ä¿®æ”¹ bootstrap.bpf.cï¼Œ commit å¹¶ç­‰å¾…å·¥ä½œæµåœæ­¢</li>
<li>æˆ‘ä»¬é…ç½®äº† github pages æ¥å®Œæˆç¼–è¯‘å¥½çš„ json çš„å¯¼å‡ºï¼Œä¹‹åå°±å¯ä»¥å®ç° ecli ä½¿ç”¨è¿œç¨‹ url ä¸€è¡Œå‘½ä»¤å³å¯è¿è¡Œï¼š</li>
</ol>
<pre><code class="language-console">sudo ./ecli run https://eunomia-bpf.github.io/ebpm-template/package.json
</code></pre>
<h2 id="é€šè¿‡-api-è¿›è¡Œçƒ­æ’æ‹”å’Œåˆ†å‘"><a class="header" href="#é€šè¿‡-api-è¿›è¡Œçƒ­æ’æ‹”å’Œåˆ†å‘">é€šè¿‡ API è¿›è¡Œçƒ­æ’æ‹”å’Œåˆ†å‘</a></h2>
<p>ç”±äº eunomia-cc ç¼–è¯‘å‡ºæ¥çš„ ebpf ç¨‹åºä»£ç å’Œé™„åŠ ä¿¡æ¯å¾ˆå°ï¼ˆçº¦æ•°å kbï¼‰ï¼Œä¸”ä¸éœ€è¦åŒæ—¶ä¼ é€’ä»»ä½•çš„é¢å¤–ä¾èµ–ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°é€šè¿‡ç½‘ç»œ API ç›´æ¥è¿›è¡Œåˆ†å‘ï¼Œä¹Ÿå¯ä»¥åœ¨å¾ˆçŸ­çš„æ—¶é—´ï¼ˆå¤§çº¦ 100msï¼‰å†…å®ç°çƒ­æ’æ‹”å’Œçƒ­æ›´æ–°ã€‚æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç®€å•çš„ client å’Œ serverï¼Œè¯·å‚è€ƒ;</p>
<p><a href="ecli-dockerfile-usage.html">ecli-dockerfile-usage.md</a></p>
<p>ä¹‹å‰ä¹Ÿæœ‰ä¸€ç¯‡æ¯”èµ›é¡¹ç›®çš„å¯è¡Œæ€§éªŒè¯çš„æ–‡ç« ï¼š</p>
<p><a href="https://zhuanlan.zhihu.com/p/555362934">https://zhuanlan.zhihu.com/p/555362934</a></p>
<h2 id="ä½¿ç”¨-prometheus-æˆ–-opentelemetry-è¿›è¡Œå¯è§‚æµ‹æ€§æ•°æ®æ”¶é›†"><a class="header" href="#ä½¿ç”¨-prometheus-æˆ–-opentelemetry-è¿›è¡Œå¯è§‚æµ‹æ€§æ•°æ®æ”¶é›†">ä½¿ç”¨ Prometheus æˆ– OpenTelemetry è¿›è¡Œå¯è§‚æµ‹æ€§æ•°æ®æ”¶é›†</a></h2>
<p>åŸºäº async Rust çš„ Prometheus æˆ– OpenTelemetry è‡ªå®šä¹‰å¯è§‚æµ‹æ€§æ•°æ®æ”¶é›†å™¨: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/eunomia-sdks/eunomia-otel">eunomia-exporter</a></p>
<p>å¯ä»¥è‡ªè¡Œç¼–è¯‘æˆ–é€šè¿‡ <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases/">release</a> ä¸‹è½½</p>
<h3 id="example"><a class="header" href="#example">example</a></h3>
<p>è¿™æ˜¯ä¸€ä¸ª <code>opensnoop</code> ç¨‹åºï¼Œè¿½è¸ªæ‰€æœ‰çš„æ‰“å¼€æ–‡ä»¶ï¼Œæºä»£ç æ¥è‡ª <a href="https://github.com/iovisor/bcc/blob/master/libbpf-tools/opensnoop.bpf.c">bcc/libbpf-tools</a>, æˆ‘ä»¬ä¿®æ”¹è¿‡åçš„æºä»£ç åœ¨è¿™é‡Œ: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop">examples/bpftools/opensnoop</a></p>
<p>åœ¨ç¼–è¯‘ä¹‹åï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„é…ç½®æ–‡ä»¶:</p>
<pre><code class="language-yml">programs:
  - name: opensnoop
    metrics:
      counters:
        - name: eunomia_file_open_counter
          description: test
          labels:
            - name: pid
            - name: comm
            - name: filename
              from: fname
    compiled_ebpf_filename: examples/bpftools/opensnoop/package.json
</code></pre>
<p>ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ <code>config.yaml</code> å’Œé¢„ç¼–è¯‘çš„ eBPF æ•°æ® <code>package.json</code> å¯åŠ¨ Prometheus å¯¼å‡ºå™¨ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æŒ‡æ ‡ï¼š</p>
<p><img src="https://oss.openanolis.cn/sig/stxfomyiiwdwkdrqwlnn" alt="prometheus" /></p>
<p>æ‚¨å¯ä»¥åœ¨ä»»ä½•å†…æ ¸ç‰ˆæœ¬ä¸Šéƒ¨ç½²å¯¼å‡ºå™¨ï¼Œè€Œæ— éœ€ä¾èµ– <code>LLVM/Clang</code>ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/eunomia-sdks/eunomia-otel">eunomia-exporter</a>ã€‚</p>
<h2 id="ä½¿ç”¨-wasm-æ¨¡å—åˆ†å‘åŠ¨æ€åŠ è½½-ebpf-ç¨‹åº"><a class="header" href="#ä½¿ç”¨-wasm-æ¨¡å—åˆ†å‘åŠ¨æ€åŠ è½½-ebpf-ç¨‹åº">ä½¿ç”¨ Wasm æ¨¡å—åˆ†å‘ã€åŠ¨æ€åŠ è½½ eBPF ç¨‹åº</a></h2>
<p>å€ŸåŠ© Wasm-bpf ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Wasm å°† eBPF ç¨‹åºç¼–å†™ä¸ºè·¨å¹³å°çš„æ¨¡å—ï¼ŒåŒæ—¶ä½¿ç”¨ C/C++ æˆ– Rust æ¥ç¼–å†™ Wasm ç¨‹åºã€‚é€šè¿‡åœ¨ WebAssembly ä¸­ä½¿ç”¨ eBPF ç¨‹åºï¼Œæˆ‘ä»¬ä¸ä»…èƒ½è®© Wasm åº”ç”¨äº«å—åˆ° eBPF çš„é«˜æ€§èƒ½å’Œå¯¹ç³»ç»Ÿæ¥å£çš„è®¿é—®èƒ½åŠ›ï¼Œè¿˜å¯ä»¥è®© eBPF ç¨‹åºä½¿ç”¨åˆ° Wasm çš„æ²™ç®±ã€çµæ´»æ€§ã€è·¨å¹³å°æ€§ã€å’ŒåŠ¨æ€åŠ è½½ï¼Œå¹¶ä¸”ä½¿ç”¨ Wasm çš„ OCI é•œåƒæ¥æ–¹ä¾¿ã€å¿«æ·åœ°åˆ†å‘å’Œç®¡ç† eBPF ç¨‹åºã€‚ç»“åˆè¿™ä¸¤ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬å°†ä¼šç»™ eBPF å’Œ Wasm ç”Ÿæ€æ¥ä¸€ä¸ªå…¨æ–°çš„å¼€å‘ä½“éªŒï¼</p>
<p>Wasm-bpf æ˜¯ä¸€ä¸ªæ–°çš„å¼€æºé¡¹ç›®ï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a>ã€‚å®ƒå®šä¹‰äº†ä¸€å¥— eBPF ç›¸å…³ç³»ç»Ÿæ¥å£çš„æŠ½è±¡ï¼Œå¹¶æä¾›äº†ä¸€å¥—å¯¹åº”çš„å¼€å‘å·¥å…·é“¾ã€åº“ä»¥åŠé€šç”¨çš„ Wasm + eBPF è¿è¡Œæ—¶å®ä¾‹ã€‚å®ƒå¯ä»¥æä¾›å’Œ libbpf-bootstrap ç›¸ä¼¼çš„å¼€å‘ä½“éªŒï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ skeleton å¤´æ–‡ä»¶ï¼Œä»¥åŠç”¨äºåœ¨ Wasm å’Œ eBPF ä¹‹é—´æ— åºåˆ—åŒ–é€šä¿¡çš„æ•°æ®ç»“æ„å®šä¹‰ã€‚ä½ å¯ä»¥éå¸¸å®¹æ˜“åœ°ä½¿ç”¨ä»»ä½•è¯­è¨€ï¼Œåœ¨ä»»ä½•å¹³å°ä¸Šå»ºç«‹ä½ è‡ªå·±çš„ Wasm-eBPF è¿è¡Œæ—¶ï¼Œä½¿ç”¨ç›¸åŒçš„å·¥å…·é“¾æ¥æ„å»ºåº”ç”¨ã€‚æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œè¯·å‚è€ƒæˆ‘ä»¬çš„ä¸Šä¸€ç¯‡åšå®¢ï¼š<a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">Wasm-bpf: æ¶èµ· Webassembly å’Œ eBPF å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢</a>ã€‚</p>
<p>åŸºäº Wasmï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šç§è¯­è¨€æ„å»º eBPF åº”ç”¨ï¼Œå¹¶ä»¥ç»Ÿä¸€ã€è½»é‡çº§çš„æ–¹å¼ç®¡ç†å’Œå‘å¸ƒã€‚ä»¥æˆ‘ä»¬æ„å»ºçš„ç¤ºä¾‹åº”ç”¨ bootstrap.wasm ä¸ºä¾‹ï¼Œå¤§å°ä»…ä¸º ~90Kï¼Œå¾ˆå®¹æ˜“é€šè¿‡ç½‘ç»œåˆ†å‘ï¼Œå¹¶å¯ä»¥åœ¨ä¸åˆ° 100ms çš„æ—¶é—´å†…åœ¨å¦ä¸€å°æœºå™¨ä¸ŠåŠ¨æ€éƒ¨ç½²ã€åŠ è½½å’Œè¿è¡Œï¼Œå¹¶ä¸”ä¿ç•™è½»é‡çº§å®¹å™¨çš„éš”ç¦»ç‰¹æ€§ã€‚è¿è¡Œæ—¶ä¸éœ€è¦å†…æ ¸å¤´æ–‡ä»¶ã€LLVMã€clang ç­‰ä¾èµ–ï¼Œä¹Ÿä¸éœ€è¦åšä»»ä½•æ¶ˆè€—èµ„æºçš„é‡é‡çº§çš„ç¼–è¯‘å·¥ä½œã€‚</p>
<p>æœ¬æ–‡å°†ä»¥ C/C++ è¯­è¨€ä¸ºä¾‹ï¼Œè®¨è®º C/C++ ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm æ¨¡å—ã€‚ä½¿ç”¨ Rust è¯­è¨€ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm æ¨¡å—çš„å…·ä½“ç¤ºä¾‹ï¼Œå°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æè¿°ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä»“åº“ä¸­æä¾›äº†å‡ ä¸ªç¤ºä¾‹ç¨‹åºï¼Œåˆ†åˆ«å¯¹åº”äºå¯è§‚æµ‹ã€ç½‘ç»œã€å®‰å…¨ç­‰å¤šç§åœºæ™¯ã€‚</p>
<h2 id="ä½¿ç”¨-wasm-å¼€å‘å’Œæ‰“åŒ…-ebpf-ç¨‹åº"><a class="header" href="#ä½¿ç”¨-wasm-å¼€å‘å’Œæ‰“åŒ…-ebpf-ç¨‹åº">ä½¿ç”¨ Wasm å¼€å‘å’Œæ‰“åŒ… eBPF ç¨‹åº</a></h2>
<p>libbpf æ˜¯ä¸€ä¸ª C/C++ çš„ eBPF ç”¨æˆ·æ€åŠ è½½å’Œæ§åˆ¶åº“ï¼Œéšç€å†…æ ¸ä¸€èµ·åˆ†å‘ï¼Œå‡ ä¹å·²ç»æˆä¸º eBPF ç”¨æˆ·æ€äº‹å®ä¸Šçš„ API æ ‡å‡†ï¼Œlibbpf ä¹Ÿæ”¯æŒ CO-RE(Compile Once â€“ Run Everywhere) çš„è§£å†³æ–¹æ¡ˆï¼Œå³é¢„ç¼–è¯‘çš„ bpf ä»£ç å¯ä»¥åœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸Šæ­£å¸¸å·¥ä½œï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªç‰¹å®šå†…æ ¸é‡æ–°ç¼–è¯‘ã€‚æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½çš„ä¿æŒä¸ libbpf çš„ç”¨æˆ·æ€ API ä»¥åŠè¡Œä¸ºä¸€è‡´ï¼Œå°½å¯èƒ½å‡å°‘åº”ç”¨è¿ç§»åˆ° Wasm ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰çš„æˆæœ¬ã€‚</p>
<p>libbpf-bootstrap ä¸ºç”ŸæˆåŸºäº libbpf çš„ bpf ç¨‹åºæä¾›äº†æ¨¡æ¿,å¼€å‘è€…å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨è¯¥æ¨¡æ¿ç”Ÿæˆè‡ªå®šä¹‰çš„ bpf ç¨‹åºã€‚ä¸€èˆ¬è¯´æ¥ï¼Œåœ¨é Wasm æ²™ç®±çš„ç”¨æˆ·æ€ç©ºé—´ï¼Œä½¿ç”¨ libbpf-bootstrap è„šæ‰‹æ¶ï¼Œå¯ä»¥å¿«é€Ÿã€è½»æ¾åœ°ä½¿ç”¨ C/C++æ„å»º BPF åº”ç”¨ç¨‹åºã€‚</p>
<p>ç¼–è¯‘ã€æ„å»ºå’Œè¿è¡Œ eBPF ç¨‹åºï¼ˆæ— è®ºæ˜¯é‡‡ç”¨ä»€ä¹ˆè¯­è¨€ï¼‰ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>ç¼–å†™å†…æ ¸æ€ eBPF ç¨‹åºçš„ä»£ç ï¼Œä¸€èˆ¬ä½¿ç”¨ C/C++ æˆ– Rust è¯­è¨€</li>
<li>ä½¿ç”¨ clang ç¼–è¯‘å™¨æˆ–è€…ç›¸å…³å·¥å…·é“¾ç¼–è¯‘ eBPF ç¨‹åºï¼ˆè¦å®ç°è·¨å†…æ ¸ç‰ˆæœ¬ç§»æ¤çš„è¯ï¼Œéœ€è¦åŒ…å« BTF ä¿¡æ¯ï¼‰ã€‚</li>
<li>åœ¨ç”¨æˆ·æ€çš„å¼€å‘ç¨‹åºä¸­ï¼Œç¼–å†™å¯¹åº”çš„åŠ è½½ã€æ§åˆ¶ã€æŒ‚è½½ã€æ•°æ®å¤„ç†é€»è¾‘ï¼›</li>
<li>åœ¨å®é™…è¿è¡Œçš„é˜¶æ®µï¼Œä»ç”¨æˆ·æ€å°† eBPF ç¨‹åºåŠ è½½è¿›å…¥å†…æ ¸ï¼Œå¹¶å®é™…æ‰§è¡Œã€‚</li>
</ul>
<h3 id="bootstrap"><a class="header" href="#bootstrap">bootstrap</a></h3>
<p><code>bootstrap</code>æ˜¯ä¸€ä¸ªç®€å•ï¼ˆä½†å®ç”¨ï¼‰çš„BPFåº”ç”¨ç¨‹åºçš„ä¾‹å­ã€‚å®ƒè·Ÿè¸ªè¿›ç¨‹çš„å¯åŠ¨ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯ <code>exec()</code> ç³»åˆ—çš„ç³»ç»Ÿè°ƒç”¨ï¼‰å’Œé€€å‡ºï¼Œå¹¶å‘é€å…³äºæ–‡ä»¶åã€PID å’Œ çˆ¶ PID çš„æ•°æ®ï¼Œä»¥åŠé€€å‡ºçŠ¶æ€å’Œè¿›ç¨‹çš„æŒç»­æ—¶é—´ã€‚ç”¨<code>-d &lt;min-duration-ms&gt;</code> ä½ å¯ä»¥æŒ‡å®šè¦è®°å½•çš„è¿›ç¨‹çš„æœ€å°æŒç»­æ—¶é—´ã€‚</p>
<p><code>bootstrap</code> æ˜¯åœ¨ <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a> ä¸­ï¼Œæ ¹æ® BCC è½¯ä»¶åŒ…ä¸­çš„<a href="https://github.com/iovisor/bcc/tree/master/libbpf-tools">libbpf-tools</a>çš„ç±»ä¼¼æ€æƒ³åˆ›å»ºçš„ï¼Œä½†å®ƒè¢«è®¾è®¡æˆæ›´ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”æœ‰æ›´ç®€å•çš„ Makefile ä»¥ç®€åŒ–ç”¨æˆ·çš„ç‰¹æ®Šéœ€æ±‚ã€‚å®ƒæ¼”ç¤ºäº†å…¸å‹çš„BPFç‰¹æ€§ï¼ŒåŒ…å«ä½¿ç”¨å¤šä¸ª BPF ç¨‹åºæ®µè¿›è¡Œåˆä½œï¼Œä½¿ç”¨ BPF map æ¥ç»´æŠ¤çŠ¶æ€ï¼Œä½¿ç”¨ BPF ring buffer æ¥å‘é€æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä»¥åŠä½¿ç”¨å…¨å±€å˜é‡æ¥å‚æ•°åŒ–åº”ç”¨ç¨‹åºè¡Œä¸ºã€‚</p>
<p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬ä½¿ç”¨ Wasm ç¼–è¯‘è¿è¡Œ <code>bootstrap</code> çš„ä¸€ä¸ªè¾“å‡ºç¤ºä¾‹ï¼š</p>
<pre><code class="language-console">$ sudo sudo ./wasm-bpf bootstrap.wasm -h
BPF bootstrap demo application.

It traces process start and exits and shows associated
information (filename, process duration, PID and PPID, etc).

USAGE: ./bootstrap [-d &lt;min-duration-ms&gt;] -v
$ sudo ./wasm-bpf bootstrap.wasm
TIME     EVENT COMM             PID     PPID    FILENAME/EXIT CODE
18:57:58 EXEC  sed              74911   74910   /usr/bin/sed
18:57:58 EXIT  sed              74911   74910   [0] (2ms)
18:57:58 EXIT  cat              74912   74910   [0] (0ms)
18:57:58 EXEC  cat              74913   74910   /usr/bin/cat
18:57:59 EXIT  cat              74913   74910   [0] (0ms)
18:57:59 EXEC  cat              74914   74910   /usr/bin/cat
18:57:59 EXIT  cat              74914   74910   [0] (0ms)
18:57:59 EXEC  cat              74915   74910   /usr/bin/cat
18:57:59 EXIT  cat              74915   74910   [0] (1ms)
18:57:59 EXEC  sleep            74916   74910   /usr/bin/sleep
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥æä¾›ä¸ libbpf-bootstrap å¼€å‘ç›¸ä¼¼çš„å¼€å‘ä½“éªŒã€‚åªéœ€è¿è¡Œ make å³å¯æ„å»º wasm äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<pre><code class="language-console">git clone https://github.com/eunomia-bpf/wasm-bpf --recursive
cd examples/bootstrap
make
</code></pre>
<h3 id="ç¼–å†™å†…æ ¸æ€çš„-ebpf-ç¨‹åº"><a class="header" href="#ç¼–å†™å†…æ ¸æ€çš„-ebpf-ç¨‹åº">ç¼–å†™å†…æ ¸æ€çš„ eBPF ç¨‹åº</a></h3>
<p>è¦æ„å»ºä¸€ä¸ªå®Œæ•´çš„ eBPF ç¨‹åºï¼Œé¦–å…ˆè¦ç¼–å†™å†…æ ¸æ€çš„ bpf ä»£ç ã€‚é€šå¸¸ä½¿ç”¨ C è¯­è¨€ç¼–å†™ï¼Œå¹¶ä½¿ç”¨ clang å®Œæˆç¼–è¯‘ï¼š</p>
<pre><code class="language-c">char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 8192);
    __type(key, pid_t);
    __type(value, u64);
} exec_start SEC(&quot;.maps&quot;);

struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

const volatile unsigned long long min_duration_ns = 0;
const volatile int *name_ptr;

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
    struct task_struct *task;
    unsigned fname_off;
    struct event *e;
    pid_t pid;
    u64 ts;
....
</code></pre>
<p>å—ç¯‡å¹…æ‰€é™ï¼Œè¿™é‡Œæ²¡æœ‰è´´å‡ºå®Œæ•´çš„ä»£ç ã€‚å†…æ ¸æ€ä»£ç çš„ç¼–å†™æ–¹å¼å’Œå…¶ä»–åŸºäº libbpf çš„ç¨‹åºå®Œå…¨ç›¸åŒï¼Œä¸€èˆ¬æ¥è¯´ä¼šåŒ…å«ä¸€äº›å…¨å±€å˜é‡ï¼Œé€šè¿‡ <code>SEC</code> å£°æ˜æŒ‚è½½ç‚¹çš„ eBPF å‡½æ•°ï¼Œä»¥åŠç”¨äºä¿å­˜çŠ¶æ€ï¼Œæˆ–è€…åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´ç›¸äº’é€šä¿¡çš„ map å¯¹è±¡ï¼ˆæˆ‘ä»¬è¿˜åœ¨è¿›è¡Œå¦å¤–ä¸€é¡¹å·¥ä½œï¼š<a href="https://github.com/iovisor/bcc/issues/4404">bcc to libbpf converter</a>ï¼Œç­‰å®ƒå®Œæˆåå°±å¯ä»¥ä»¥è¿™ç§æ–¹å¼ç¼–è¯‘ BCC é£æ ¼çš„ eBPF å†…æ ¸æ€ç¨‹åºï¼‰ã€‚åœ¨ç¼–å†™å®Œ eBPF ç¨‹åºä¹‹åï¼Œè¿è¡Œ <code>make</code> ä¼šåœ¨ <code>Makefile</code> è°ƒç”¨ clang å’Œ llvm-strip æ„å»ºBPFç¨‹åºï¼Œä»¥å‰¥ç¦»è°ƒè¯•ä¿¡æ¯ï¼š</p>
<pre><code class="language-shell">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I../../third_party/vmlinux/x86/ -idirafter /usr/local/include -idirafter /usr/include -c bootstrap.bpf.c -o bootstrap.bpf.o
llvm-strip -g bootstrap.bpf.o # strip useless DWARF info
</code></pre>
<p>ä¹‹åï¼Œæˆ‘ä»¬ä¼šæä¾›ä¸€ä¸ªä¸ºäº† Wasm ä¸“é—¨å®ç°çš„ bpftoolï¼Œç”¨äºä» BPF ç¨‹åºç”ŸæˆCå¤´æ–‡ä»¶ï¼š</p>
<pre><code class="language-shell">../../third_party/bpftool/src/bpftool gen skeleton -j bootstrap.bpf.o &gt; bootstrap.skel.h
</code></pre>
<p>ç”±äº eBPF æœ¬èº«çš„æ‰€æœ‰ C å†…å­˜å¸ƒå±€æ˜¯å’Œå½“å‰æ‰€åœ¨æœºå™¨çš„æŒ‡ä»¤é›†ä¸€æ ·çš„ï¼Œä½†æ˜¯ wasm æ˜¯æœ‰ä¸€å¥—ç¡®å®šçš„å†…å­˜å¸ƒå±€ï¼ˆæ¯”å¦‚å½“å‰æ‰€åœ¨æœºå™¨æ˜¯ 64 ä½çš„ï¼ŒWasm è™šæ‹Ÿæœºé‡Œé¢æ˜¯ 32 ä½çš„ï¼ŒC struct layout ã€æŒ‡é’ˆå®½åº¦ã€å¤§å°ç«¯ç­‰ç­‰éƒ½å¯èƒ½ä¸ä¸€æ ·ï¼‰ï¼Œä¸ºäº†ç¡®ä¿ eBPF ç¨‹åºèƒ½æ­£ç¡®å’Œ Wasm ä¹‹é—´è¿›è¡Œç›¸äº’é€šä¿¡ï¼Œæˆ‘ä»¬éœ€è¦å®šåˆ¶ä¸€ä¸ªä¸“é—¨çš„ bpftool ç­‰å·¥å…·ï¼Œå®ç°æ­£ç¡®ç”Ÿæˆå¯ä»¥åœ¨ Wasm ä¸­å·¥ä½œçš„ç”¨æˆ·æ€å¼€å‘æ¡†æ¶ã€‚</p>
<p>skel åŒ…å«ä¸€ä¸ª BPF ç¨‹åºçš„skeletonï¼Œç”¨äºæ“ä½œ BPF å¯¹è±¡ï¼Œå¹¶æ§åˆ¶ BPF ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-c">    struct bootstrap_bpf {
        struct bpf_object_skeleton *skeleton;
        struct bpf_object *obj;
        struct {
            struct bpf_map *exec_start;
            struct bpf_map *rb;
            struct bpf_map *rodata;
        } maps;
        struct {
            struct bpf_program *handle_exec;
            struct bpf_program *handle_exit;
        } progs;
        struct bootstrap_bpf__rodata {
            unsigned long long min_duration_ns;
        } *rodata;
        struct bootstrap_bpf__bss {
            uint64_t /* pointer */ name_ptr;
        } *bss;
    };
</code></pre>
<p>æˆ‘ä»¬ä¼šå°†æ‰€æœ‰æŒ‡é’ˆéƒ½å°†æ ¹æ® eBPF ç¨‹åºç›®æ ‡æ‰€åœ¨çš„æŒ‡ä»¤é›†çš„æŒ‡é’ˆå¤§å°è½¬æ¢ä¸ºæ•´æ•°ï¼Œä¾‹å¦‚ï¼Œ<code>name_ptr</code>ã€‚æ­¤å¤–ï¼Œå¡«å……å­—èŠ‚å°†æ˜ç¡®æ·»åŠ åˆ°ç»“æ„ä½“ä¸­ä»¥ç¡®ä¿ç»“æ„ä½“å¸ƒå±€ä¸ç›®æ ‡ç«¯ç›¸åŒï¼Œä¾‹å¦‚ä½¿ç”¨ <code>char __pad0[4];</code>ã€‚æˆ‘ä»¬è¿˜ä¼šä½¿ç”¨ <code>static_assert</code> æ¥ç¡®ä¿ç»“æ„ä½“çš„å†…å­˜é•¿åº¦å’ŒåŸå…ˆ BTF ä¿¡æ¯ä¸­çš„ç±»å‹é•¿åº¦ç›¸åŒã€‚</p>
<h3 id="æ„å»ºç”¨æˆ·æ€çš„-wasm-ä»£ç å¹¶è·å–å†…æ ¸æ€æ•°æ®"><a class="header" href="#æ„å»ºç”¨æˆ·æ€çš„-wasm-ä»£ç å¹¶è·å–å†…æ ¸æ€æ•°æ®">æ„å»ºç”¨æˆ·æ€çš„ Wasm ä»£ç ï¼Œå¹¶è·å–å†…æ ¸æ€æ•°æ®</a></h3>
<p>libbpf æ˜¯ä¸€ä¸ª C/C++ çš„ eBPF ç”¨æˆ·æ€åŠ è½½å’Œæ§åˆ¶åº“ï¼Œéšç€å†…æ ¸ä¸€èµ·åˆ†å‘ï¼Œå‡ ä¹å·²ç»æˆä¸º eBPF ç”¨æˆ·æ€äº‹å®ä¸Šçš„ API æ ‡å‡†ï¼Œlibbpf ä¹Ÿæ”¯æŒ CO-RE(Compile Once â€“ Run Everywhere) çš„è§£å†³æ–¹æ¡ˆï¼Œå³é¢„ç¼–è¯‘çš„ bpf ä»£ç å¯ä»¥åœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸Šæ­£å¸¸å·¥ä½œï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªç‰¹å®šå†…æ ¸é‡æ–°ç¼–è¯‘ã€‚æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½çš„ä¿æŒä¸ libbpf çš„ç”¨æˆ·æ€ API ä»¥åŠè¡Œä¸ºä¸€è‡´ï¼Œå°½å¯èƒ½å‡å°‘åº”ç”¨è¿ç§»åˆ° Wasm ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰çš„æˆæœ¬ã€‚</p>
<p>libbpf-bootstrap ä¸ºç”ŸæˆåŸºäº libbpf çš„ bpf ç¨‹åºæä¾›äº†æ¨¡æ¿,å¼€å‘è€…å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨è¯¥æ¨¡æ¿ç”Ÿæˆè‡ªå®šä¹‰çš„ bpf ç¨‹åºã€‚ä¸€èˆ¬è¯´æ¥ï¼Œåœ¨é Wasm æ²™ç®±çš„ç”¨æˆ·æ€ç©ºé—´ï¼Œä½¿ç”¨ libbpf-bootstrap è„šæ‰‹æ¶ï¼Œå¯ä»¥å¿«é€Ÿã€è½»æ¾åœ°ä½¿ç”¨ C/C++æ„å»º BPF åº”ç”¨ç¨‹åºã€‚</p>
<p>ç¼–è¯‘ã€æ„å»ºå’Œè¿è¡Œ eBPF ç¨‹åºï¼ˆæ— è®ºæ˜¯é‡‡ç”¨ä»€ä¹ˆè¯­è¨€ï¼‰ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>ç¼–å†™å†…æ ¸æ€ eBPF ç¨‹åºçš„ä»£ç ï¼Œä¸€èˆ¬ä½¿ç”¨ C/C++ æˆ– Rust è¯­è¨€</li>
<li>ä½¿ç”¨ clang ç¼–è¯‘å™¨æˆ–è€…ç›¸å…³å·¥å…·é“¾ç¼–è¯‘ eBPF ç¨‹åºï¼ˆè¦å®ç°è·¨å†…æ ¸ç‰ˆæœ¬ç§»æ¤çš„è¯ï¼Œéœ€è¦åŒ…å« BTF ä¿¡æ¯ï¼‰ã€‚</li>
<li>åœ¨ç”¨æˆ·æ€çš„å¼€å‘ç¨‹åºä¸­ï¼Œç¼–å†™å¯¹åº”çš„åŠ è½½ã€æ§åˆ¶ã€æŒ‚è½½ã€æ•°æ®å¤„ç†é€»è¾‘ï¼›</li>
<li>åœ¨å®é™…è¿è¡Œçš„é˜¶æ®µï¼Œä»ç”¨æˆ·æ€å°† eBPF ç¨‹åºåŠ è½½è¿›å…¥å†…æ ¸ï¼Œå¹¶å®é™…æ‰§è¡Œã€‚</li>
</ul>
<h3 id="bootstrap-1"><a class="header" href="#bootstrap-1">bootstrap</a></h3>
<p><code>bootstrap</code>æ˜¯ä¸€ä¸ªç®€å•ï¼ˆä½†å®ç”¨ï¼‰çš„BPFåº”ç”¨ç¨‹åºçš„ä¾‹å­ã€‚å®ƒè·Ÿè¸ªè¿›ç¨‹çš„å¯åŠ¨ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯ <code>exec()</code> ç³»åˆ—çš„ç³»ç»Ÿè°ƒç”¨ï¼‰å’Œé€€å‡ºï¼Œå¹¶å‘é€å…³äºæ–‡ä»¶åã€PID å’Œ çˆ¶ PID çš„æ•°æ®ï¼Œä»¥åŠé€€å‡ºçŠ¶æ€å’Œè¿›ç¨‹çš„æŒç»­æ—¶é—´ã€‚ç”¨<code>-d &lt;min-duration-ms&gt;</code> ä½ å¯ä»¥æŒ‡å®šè¦è®°å½•çš„è¿›ç¨‹çš„æœ€å°æŒç»­æ—¶é—´ã€‚</p>
<p><code>bootstrap</code> æ˜¯åœ¨ <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a> ä¸­ï¼Œæ ¹æ® BCC è½¯ä»¶åŒ…ä¸­çš„<a href="https://github.com/iovisor/bcc/tree/master/libbpf-tools">libbpf-tools</a>çš„ç±»ä¼¼æ€æƒ³åˆ›å»ºçš„ï¼Œä½†å®ƒè¢«è®¾è®¡æˆæ›´ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”æœ‰æ›´ç®€å•çš„ Makefile ä»¥ç®€åŒ–ç”¨æˆ·çš„ç‰¹æ®Šéœ€æ±‚ã€‚å®ƒæ¼”ç¤ºäº†å…¸å‹çš„BPFç‰¹æ€§ï¼ŒåŒ…å«ä½¿ç”¨å¤šä¸ª BPF ç¨‹åºæ®µè¿›è¡Œåˆä½œï¼Œä½¿ç”¨ BPF map æ¥ç»´æŠ¤çŠ¶æ€ï¼Œä½¿ç”¨ BPF ring buffer æ¥å‘é€æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä»¥åŠä½¿ç”¨å…¨å±€å˜é‡æ¥å‚æ•°åŒ–åº”ç”¨ç¨‹åºè¡Œä¸ºã€‚</p>
<p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬ä½¿ç”¨ Wasm ç¼–è¯‘è¿è¡Œ <code>bootstrap</code> çš„ä¸€ä¸ªè¾“å‡ºç¤ºä¾‹ï¼š</p>
<pre><code class="language-console">$ sudo sudo ./wasm-bpf bootstrap.wasm -h
BPF bootstrap demo application.

It traces process start and exits and shows associated
information (filename, process duration, PID and PPID, etc).

USAGE: ./bootstrap [-d &lt;min-duration-ms&gt;] -v
$ sudo ./wasm-bpf bootstrap.wasm
TIME     EVENT COMM             PID     PPID    FILENAME/EXIT CODE
18:57:58 EXEC  sed              74911   74910   /usr/bin/sed
18:57:58 EXIT  sed              74911   74910   [0] (2ms)
18:57:58 EXIT  cat              74912   74910   [0] (0ms)
18:57:58 EXEC  cat              74913   74910   /usr/bin/cat
18:57:59 EXIT  cat              74913   74910   [0] (0ms)
18:57:59 EXEC  cat              74914   74910   /usr/bin/cat
18:57:59 EXIT  cat              74914   74910   [0] (0ms)
18:57:59 EXEC  cat              74915   74910   /usr/bin/cat
18:57:59 EXIT  cat              74915   74910   [0] (1ms)
18:57:59 EXEC  sleep            74916   74910   /usr/bin/sleep
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥æä¾›ä¸ libbpf-bootstrap å¼€å‘ç›¸ä¼¼çš„å¼€å‘ä½“éªŒã€‚åªéœ€è¿è¡Œ make å³å¯æ„å»º wasm äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<pre><code class="language-console">git clone https://github.com/eunomia-bpf/wasm-bpf --recursive
cd examples/bootstrap
make
</code></pre>
<h3 id="ç¼–å†™å†…æ ¸æ€çš„-ebpf-ç¨‹åº-1"><a class="header" href="#ç¼–å†™å†…æ ¸æ€çš„-ebpf-ç¨‹åº-1">ç¼–å†™å†…æ ¸æ€çš„ eBPF ç¨‹åº</a></h3>
<p>è¦æ„å»ºä¸€ä¸ªå®Œæ•´çš„ eBPF ç¨‹åºï¼Œé¦–å…ˆè¦ç¼–å†™å†…æ ¸æ€çš„ bpf ä»£ç ã€‚é€šå¸¸ä½¿ç”¨ C è¯­è¨€ç¼–å†™ï¼Œå¹¶ä½¿ç”¨ clang å®Œæˆç¼–è¯‘ï¼š</p>
<pre><code class="language-c">char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 8192);
    __type(key, pid_t);
    __type(value, u64);
} exec_start SEC(&quot;.maps&quot;);

struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

const volatile unsigned long long min_duration_ns = 0;
const volatile int *name_ptr;

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
    struct task_struct *task;
    unsigned fname_off;
    struct event *e;
    pid_t pid;
    u64 ts;
....
</code></pre>
<p>å—ç¯‡å¹…æ‰€é™ï¼Œè¿™é‡Œæ²¡æœ‰è´´å‡ºå®Œæ•´çš„ä»£ç ã€‚å†…æ ¸æ€ä»£ç çš„ç¼–å†™æ–¹å¼å’Œå…¶ä»–åŸºäº libbpf çš„ç¨‹åºå®Œå…¨ç›¸åŒï¼Œä¸€èˆ¬æ¥è¯´ä¼šåŒ…å«ä¸€äº›å…¨å±€å˜é‡ï¼Œé€šè¿‡ <code>SEC</code> å£°æ˜æŒ‚è½½ç‚¹çš„ eBPF å‡½æ•°ï¼Œä»¥åŠç”¨äºä¿å­˜çŠ¶æ€ï¼Œæˆ–è€…åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´ç›¸äº’é€šä¿¡çš„ map å¯¹è±¡ï¼ˆæˆ‘ä»¬è¿˜åœ¨è¿›è¡Œå¦å¤–ä¸€é¡¹å·¥ä½œï¼š<a href="https://github.com/iovisor/bcc/issues/4404">bcc to libbpf converter</a>ï¼Œç­‰å®ƒå®Œæˆåå°±å¯ä»¥ä»¥è¿™ç§æ–¹å¼ç¼–è¯‘ BCC é£æ ¼çš„ eBPF å†…æ ¸æ€ç¨‹åºï¼‰ã€‚åœ¨ç¼–å†™å®Œ eBPF ç¨‹åºä¹‹åï¼Œè¿è¡Œ <code>make</code> ä¼šåœ¨ <code>Makefile</code> è°ƒç”¨ clang å’Œ llvm-strip æ„å»ºBPFç¨‹åºï¼Œä»¥å‰¥ç¦»è°ƒè¯•ä¿¡æ¯ï¼š</p>
<pre><code class="language-shell">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I../../third_party/vmlinux/x86/ -idirafter /usr/local/include -idirafter /usr/include -c bootstrap.bpf.c -o bootstrap.bpf.o
llvm-strip -g bootstrap.bpf.o # strip useless DWARF info
</code></pre>
<p>ä¹‹åï¼Œæˆ‘ä»¬ä¼šæä¾›ä¸€ä¸ªä¸ºäº† Wasm ä¸“é—¨å®ç°çš„ bpftoolï¼Œç”¨äºä» BPF ç¨‹åºç”ŸæˆCå¤´æ–‡ä»¶ï¼š</p>
<pre><code class="language-shell">../../third_party/bpftool/src/bpftool gen skeleton -j bootstrap.bpf.o &gt; bootstrap.skel.h
</code></pre>
<p>ç”±äº eBPF æœ¬èº«çš„æ‰€æœ‰ C å†…å­˜å¸ƒå±€æ˜¯å’Œå½“å‰æ‰€åœ¨æœºå™¨çš„æŒ‡ä»¤é›†ä¸€æ ·çš„ï¼Œä½†æ˜¯ wasm æ˜¯æœ‰ä¸€å¥—ç¡®å®šçš„å†…å­˜å¸ƒå±€ï¼ˆæ¯”å¦‚å½“å‰æ‰€åœ¨æœºå™¨æ˜¯ 64 ä½çš„ï¼ŒWasm è™šæ‹Ÿæœºé‡Œé¢æ˜¯ 32 ä½çš„ï¼ŒC struct layout ã€æŒ‡é’ˆå®½åº¦ã€å¤§å°ç«¯ç­‰ç­‰éƒ½å¯èƒ½ä¸ä¸€æ ·ï¼‰ï¼Œä¸ºäº†ç¡®ä¿ eBPF ç¨‹åºèƒ½æ­£ç¡®å’Œ Wasm ä¹‹é—´è¿›è¡Œç›¸äº’é€šä¿¡ï¼Œæˆ‘ä»¬éœ€è¦å®šåˆ¶ä¸€ä¸ªä¸“é—¨çš„ bpftool ç­‰å·¥å…·ï¼Œå®ç°æ­£ç¡®ç”Ÿæˆå¯ä»¥åœ¨ Wasm ä¸­å·¥ä½œçš„ç”¨æˆ·æ€å¼€å‘æ¡†æ¶ã€‚</p>
<p>skel åŒ…å«ä¸€ä¸ª BPF ç¨‹åºçš„skeletonï¼Œç”¨äºæ“ä½œ BPF å¯¹è±¡ï¼Œå¹¶æ§åˆ¶ BPF ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-c">    struct bootstrap_bpf {
        struct bpf_object_skeleton *skeleton;
        struct bpf_object *obj;
        struct {
            struct bpf_map *exec_start;
            struct bpf_map *rb;
            struct bpf_map *rodata;
        } maps;
        struct {
            struct bpf_program *handle_exec;
            struct bpf_program *handle_exit;
        } progs;
        struct bootstrap_bpf__rodata {
            unsigned long long min_duration_ns;
        } *rodata;
        struct bootstrap_bpf__bss {
            uint64_t /* pointer */ name_ptr;
        } *bss;
    };
</code></pre>
<p>æˆ‘ä»¬ä¼šå°†æ‰€æœ‰æŒ‡é’ˆéƒ½å°†æ ¹æ® eBPF ç¨‹åºç›®æ ‡æ‰€åœ¨çš„æŒ‡ä»¤é›†çš„æŒ‡é’ˆå¤§å°è½¬æ¢ä¸ºæ•´æ•°ï¼Œä¾‹å¦‚ï¼Œ<code>name_ptr</code>ã€‚æ­¤å¤–ï¼Œå¡«å……å­—èŠ‚å°†æ˜ç¡®æ·»åŠ åˆ°ç»“æ„ä½“ä¸­ä»¥ç¡®ä¿ç»“æ„ä½“å¸ƒå±€ä¸ç›®æ ‡ç«¯ç›¸åŒï¼Œä¾‹å¦‚ä½¿ç”¨ <code>char __pad0[4];</code>ã€‚æˆ‘ä»¬è¿˜ä¼šä½¿ç”¨ <code>static_assert</code> æ¥ç¡®ä¿ç»“æ„ä½“çš„å†…å­˜é•¿åº¦å’ŒåŸå…ˆ BTF ä¿¡æ¯ä¸­çš„ç±»å‹é•¿åº¦ç›¸åŒã€‚</p>
<h3 id="æ„å»ºç”¨æˆ·æ€çš„-wasm-ä»£ç å¹¶è·å–å†…æ ¸æ€æ•°æ®-1"><a class="header" href="#æ„å»ºç”¨æˆ·æ€çš„-wasm-ä»£ç å¹¶è·å–å†…æ ¸æ€æ•°æ®-1">æ„å»ºç”¨æˆ·æ€çš„ Wasm ä»£ç ï¼Œå¹¶è·å–å†…æ ¸æ€æ•°æ®</a></h3>
<p>æˆ‘ä»¬é»˜è®¤ä½¿ç”¨ wasi-sdk ä» C/C++ ä»£ç æ„å»º wasm äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ emcc å·¥å…·é“¾æ¥æ„å»º wasm äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå‘½ä»¤åº”è¯¥æ˜¯ç›¸ä¼¼çš„ã€‚æ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… wasi-sdkï¼š</p>
<pre><code class="language-sh">wget https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-17/wasi-sdk-17.0-linux.tar.gz
tar -zxf wasi-sdk-17.0-linux.tar.gz
sudo mkdir -p /opt/wasi-sdk/ &amp;&amp; sudo mv wasi-sdk-17.0/* /opt/wasi-sdk/
</code></pre>
<p>ç„¶åè¿è¡Œ <code>make</code> ä¼šåœ¨ <code>Makefile</code> ä¸­ä½¿ç”¨ wasi-clang ç¼–è¯‘ C ä»£ç ï¼Œç”Ÿæˆ Wasm å­—èŠ‚ç ï¼š</p>
<pre><code class="language-sh">/opt/wasi-sdk/bin/clang -O2 --sysroot=/opt/wasi-sdk/share/wasi-sysroot -Wl,--allow-undefined -o bootstrap.wasm bootstrap.c
</code></pre>
<p>ç”±äºå®¿ä¸»æœºï¼ˆæˆ– eBPF ç«¯ï¼‰çš„ C ç»“æ„å¸ƒå±€å¯èƒ½ä¸ç›®æ ‡ï¼ˆWasm ç«¯ï¼‰çš„ç»“æ„å¸ƒå±€ä¸åŒï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨ ecc å’Œæˆ‘ä»¬çš„ wasm-bpftool ç”Ÿæˆç”¨æˆ·ç©ºé—´ä»£ç çš„ C å¤´æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">ecc bootstrap.h --header-only
../../third_party/bpftool/src/bpftool btf dump file bootstrap.bpf.o format c -j &gt; bootstrap.wasm.h
</code></pre>
<p>ä¾‹å¦‚ï¼ŒåŸå…ˆå†…æ ¸æ€çš„å¤´æ–‡ä»¶ä¸­ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">struct event {
    int pid;
    int ppid;
    unsigned exit_code;
    unsigned long long duration_ns;
    char comm[TASK_COMM_LEN];
    char filename[MAX_FILENAME_LEN];
    char exit_event;
};
</code></pre>
<p>æˆ‘ä»¬çš„å·¥å…·ä¼šå°†å…¶è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-c">struct event {
    int pid;
    int ppid;
    unsigned int exit_code;
    char __pad0[4];
    unsigned long long duration_ns;
    char comm[16];
    char filename[127];
    char exit_event;
} __attribute__((packed));
static_assert(sizeof(struct event) == 168, &quot;Size of event is not 168&quot;);
</code></pre>
<p>**æ³¨æ„ï¼šæ­¤è¿‡ç¨‹å’Œå·¥å…·å¹¶ä¸æ€»æ˜¯å¿…éœ€çš„ï¼Œå¯¹äºç®€å•çš„åº”ç”¨ï¼Œä½ å¯ä»¥æ‰‹åŠ¨å®Œæˆã€‚**å¯¹äºå†…æ ¸æ€å’Œ Wasm åº”ç”¨éƒ½ä½¿ç”¨ C/C++ è¯­è¨€çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥æ‰‹åŠ¨ç¼–å†™æ‰€æœ‰äº‹ä»¶ç»“æ„ä½“å®šä¹‰ï¼Œä½¿ç”¨ <code>__attribute__((packed))</code> é¿å…å¡«å……å­—èŠ‚ï¼Œå¹¶åœ¨ä¸»æœºå’Œ wasm ç«¯ä¹‹é—´è½¬æ¢æ‰€æœ‰æŒ‡é’ˆä¸ºæ­£ç¡®çš„æ•´æ•°ã€‚æ‰€æœ‰ç±»å‹å¿…é¡»åœ¨ wasm ä¸­å®šä¹‰ä¸ä¸»æœºç«¯ç›¸åŒçš„å¤§å°å’Œå¸ƒå±€ã€‚</p>
<p>å¯¹äºå¤æ‚çš„ç¨‹åºï¼Œæ‰‹åŠ¨ç¡®è®¤å†…å­˜å¸ƒå±€çš„æ­£ç¡®æ˜¯åˆ†å›°éš¾ï¼Œå› æ­¤æˆ‘ä»¬åˆ›å»ºäº† wasm ç‰¹å®šçš„ <code>bpftool</code>ï¼Œç”¨äºä» <code>BTF</code> ä¿¡æ¯ä¸­ç”ŸæˆåŒ…å«æ‰€æœ‰ç±»å‹å®šä¹‰å’Œæ­£ç¡®ç»“æ„ä½“å¸ƒå±€çš„ C å¤´æ–‡ä»¶ï¼Œä»¥ä¾¿ç”¨æˆ·ç©ºé—´ä»£ç ä½¿ç”¨ã€‚å¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ–¹æ¡ˆï¼Œä¸€æ¬¡æ€§å°† eBPF ç¨‹åºä¸­æ‰€æœ‰çš„ç»“æ„ä½“å®šä¹‰è½¬æ¢ä¸º Wasm ç«¯çš„å†…å­˜å¸ƒå±€ï¼Œå¹¶ç¡®ä¿å¤§å°ç«¯ä¸€è‡´ï¼Œå³å¯æ­£ç¡®è®¿é—®ã€‚</p>
<p>å¯¹äº Wasm ä¸­ä¸æ˜¯ç”± C è¯­è¨€è¿›è¡Œå¼€å‘çš„æƒ…å†µä¸‹ï¼Œå€ŸåŠ© Wasm çš„ç»„ä»¶æ¨¡å‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†è¿™äº› BTF ä¿¡æ¯ç»“æ„ä½“å®šä¹‰ä½œä¸º wit ç±»å‹å£°æ˜è¾“å‡ºï¼Œç„¶ååœ¨ç”¨æˆ·ç©ºé—´ä»£ç ä¸­ä½¿ç”¨ wit-bindgen å·¥å…·ä¸€æ¬¡æ€§ç”Ÿæˆå¤šç§è¯­è¨€ï¼ˆå¦‚ C/C++/Rust/Goï¼‰çš„ç±»å‹å®šä¹‰ã€‚è¿™éƒ¨åˆ†ä¼šåœ¨å…³äºå¦‚ä½•ä½¿ç”¨ Rust åœ¨ Wasm ä¸­ç¼–å†™ eBPF ç¨‹åºçš„éƒ¨åˆ†è¯¦ç»†æè¿°ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°†è¿™äº›æ­¥éª¤å’Œå·¥å…·é“¾ç»§ç»­å®Œå–„ï¼Œä»¥æ”¹è¿› Wasm-bpf ç¨‹åºçš„ç¼–ç¨‹ä½“éªŒã€‚</p>
<p>æˆ‘ä»¬ä¸º wasm ç¨‹åºæä¾›äº†ä¸€ä¸ªä»…åŒ…å«å¤´æ–‡ä»¶çš„ libbpf API åº“ï¼Œæ‚¨å¯ä»¥åœ¨ libbpf-wasm.hï¼ˆwasm-include/libbpf-wasm.hï¼‰ä¸­æ‰¾åˆ°å®ƒï¼Œå®ƒåŒ…å«äº†ä¸€éƒ¨åˆ† libbpf å¸¸ç”¨çš„ç”¨æˆ·æ€ API å’Œç±»å‹å®šä¹‰ã€‚Wasm ç¨‹åºå¯ä»¥ä½¿ç”¨ libbpf API æ“ä½œ BPF å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-c">/* Load and verify BPF application */
skel = bootstrap_bpf__open();
/* Parameterize BPF code with minimum duration parameter */
skel-&gt;rodata-&gt;min_duration_ns = env.min_duration_ms * 1000000ULL;
/* Load &amp; verify BPF programs */
err = bootstrap_bpf__load(skel);
/* Attach tracepoints */
err = bootstrap_bpf__attach(skel);
</code></pre>
<p>rodata éƒ¨åˆ†ç”¨äºå­˜å‚¨ BPF ç¨‹åºä¸­çš„å¸¸é‡ï¼Œè¿™äº›å€¼å°†åœ¨ bpftool gen skeleton çš„æ—¶å€™ç”±ä»£ç ç”Ÿæˆæ˜ å°„åˆ° object ä¸­æ­£ç¡®çš„åç§»é‡,ç„¶ååœ¨ open ä¹‹åé€šè¿‡å†…å­˜æ˜ å°„ä¿®æ”¹å¯¹åº”çš„å€¼ï¼Œå› æ­¤ä¸éœ€è¦åœ¨ Wasm ä¸­ç¼–è¯‘ libelf åº“ï¼Œè¿è¡Œæ—¶ä»å¯åŠ¨æ€åŠ è½½å’Œæ“ä½œ BPF å¯¹è±¡ã€‚</p>
<p>Wasm ç«¯çš„ C ä»£ç ä¸æœ¬åœ° libbpf ä»£ç ç•¥æœ‰ä¸åŒï¼Œä½†å®ƒå¯ä»¥ä» eBPF ç«¯æä¾›å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œä»ç¯å½¢ç¼“å†²åŒºæˆ– perf ç¼“å†²åŒºè½®è¯¢ï¼Œä» Wasm ç«¯å’Œ eBPF ç«¯è®¿é—®æ˜ å°„ï¼ŒåŠ è½½ã€é™„åŠ å’Œåˆ†ç¦» BPF ç¨‹åºç­‰ã€‚å®ƒå¯ä»¥æ”¯æŒå¤§é‡çš„ eBPF ç¨‹åºç±»å‹å’Œæ˜ å°„ï¼Œæ¶µç›–ä»è·Ÿè¸ªã€ç½‘ç»œã€å®‰å…¨ç­‰æ–¹é¢çš„å¤§å¤šæ•° eBPF ç¨‹åºçš„ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>ç”±äº Wasm ç«¯ç¼ºå°‘ä¸€äº›åŠŸèƒ½ï¼Œä¾‹å¦‚ signal handler è¿˜ä¸æ”¯æŒï¼ˆ2023å¹´2æœˆï¼‰ï¼ŒåŸå§‹çš„Cä»£ç æœ‰å¯èƒ½æ— æ³•ç›´æ¥ç¼–è¯‘ä¸º wasmï¼Œæ‚¨éœ€è¦ç¨å¾®ä¿®æ”¹ä»£ç ä»¥ä½¿å…¶å·¥ä½œã€‚æˆ‘ä»¬å°†å°½æœ€å¤§åŠªåŠ›ä½¿ wasm ç«¯çš„ libbpf API ä¸é€šå¸¸åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ libbpf APIå°½å¯èƒ½ç›¸ä¼¼ï¼Œä»¥ä¾¿ç”¨æˆ·ç©ºé—´ä»£ç å¯ä»¥åœ¨æœªæ¥ç›´æ¥ç¼–è¯‘ä¸º wasmã€‚æˆ‘ä»¬è¿˜å°†å°½å¿«æä¾›æ›´å¤šè¯­è¨€ç»‘å®šï¼ˆGoç­‰ï¼‰çš„ wasm ä¾§ eBPF ç¨‹åºå¼€å‘åº“ã€‚</p>
<p>å¯ä»¥åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­ä½¿ç”¨ polling API è·å–å†…æ ¸æ€ä¸Šä¼ çš„æ•°æ®ã€‚å®ƒå°†æ˜¯ ring buffer å’Œ perf buffer çš„ä¸€ä¸ªå°è£…ï¼Œç”¨æˆ·ç©ºé—´ä»£ç å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ API ä»ç¯å½¢ç¼“å†²åŒºæˆ–æ€§èƒ½ç¼“å†²åŒºä¸­è½®è¯¢äº‹ä»¶ï¼Œå…·ä½“å–å†³äºBPFç¨‹åºä¸­æŒ‡å®šçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œç¯å½¢ç¼“å†²åŒºè½®è¯¢å®šä¹‰ä¸º<code>BPF_MAP_TYPE_RINGBUF</code>ï¼š</p>
<pre><code class="language-c">struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);
</code></pre>
<p>ä½ å¯ä»¥åœ¨ç”¨æˆ·æ€ä½¿ç”¨ä»¥ä¸‹ä»£ç ä» ring buffer ä¸­è½®è¯¢äº‹ä»¶ï¼š</p>
<pre><code class="language-c">rb = bpf_buffer__open(skel-&gt;maps.rb, handle_event, NULL);
/* Process events */
printf(&quot;%-8s %-5s %-16s %-7s %-7s %s\n&quot;, &quot;TIME&quot;, &quot;EVENT&quot;, &quot;COMM&quot;, &quot;PID&quot;,
       &quot;PPID&quot;, &quot;FILENAME/EXIT CODE&quot;);
while (!exiting) {
    // poll buffer
    err = bpf_buffer__poll(rb, 100 /* timeout, ms */);
</code></pre>
<p>ring buffer polling ä¸éœ€è¦åºåˆ—åŒ–å¼€é”€ã€‚bpf_buffer__poll API å°†è°ƒç”¨ handle_event å›è°ƒå‡½æ•°æ¥å¤„ç†ç¯å½¢ç¼“å†²åŒºä¸­çš„äº‹ä»¶æ•°æ®ï¼š</p>
<pre><code class="language-c">
static int
handle_event(void *ctx, void *data, size_t data_sz)
{
    const struct event *e = data;
    ...
    if (e-&gt;exit_event) {
        printf(&quot;%-8s %-5s %-16s %-7d %-7d [%u]&quot;, ts, &quot;EXIT&quot;, e-&gt;comm, e-&gt;pid,
               e-&gt;ppid, e-&gt;exit_code);
        if (e-&gt;duration_ns)
            printf(&quot; (%llums)&quot;, e-&gt;duration_ns / 1000000);
        printf(&quot;\n&quot;);
    }
    ...
    return 0;
}
</code></pre>
<p>è¿è¡Œæ—¶åŸºäº libbpf CO-REï¼ˆCompile Once, Run Everywhereï¼‰APIï¼Œç”¨äºå°† bpf å¯¹è±¡åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œå› æ­¤ wasm-bpf ç¨‹åºä¸å—å®ƒç¼–è¯‘çš„å†…æ ¸ç‰ˆæœ¬çš„å½±å“ï¼Œå¯ä»¥åœ¨ä»»ä½•æ”¯æŒ BPF CO-RE çš„å†…æ ¸ç‰ˆæœ¬ä¸Šè¿è¡Œã€‚</p>
<h3 id="ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–°-ebpf-ç¨‹åºçš„-map-æ•°æ®"><a class="header" href="#ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–°-ebpf-ç¨‹åºçš„-map-æ•°æ®">ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–° eBPF ç¨‹åºçš„ map æ•°æ®</a></h3>
<p>runqlat æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼Œè¿™ä¸ªç¨‹åºé€šè¿‡ç›´æ–¹å›¾å±•ç¤ºè°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ—å»¶è¿Ÿï¼Œç»™æˆ‘ä»¬å±•ç°äº†ä»»åŠ¡ç­‰äº†å¤šä¹…æ‰èƒ½è¿è¡Œã€‚</p>
<pre><code class="language-console">$ sudo ./wasm-bpf runqlat.wasm -h
Summarize run queue (scheduler) latency as a histogram.

USAGE: runqlat [--help] [interval] [count]

EXAMPLES:
    runqlat         # summarize run queue latency as a histogram
    runqlat 1 10    # print 1 second summaries, 10 times
$ sudo ./wasm-bpf runqlat.wasm 1

Tracing run queue latency... Hit Ctrl-C to end.

     usecs               : count    distribution
         0 -&gt; 1          : 72       |*****************************           |
         2 -&gt; 3          : 93       |*************************************   |
         4 -&gt; 7          : 98       |****************************************|
         8 -&gt; 15         : 96       |*************************************** |
        16 -&gt; 31         : 38       |***************                         |
        32 -&gt; 63         : 4        |*                                       |
        64 -&gt; 127        : 5        |**                                      |
       128 -&gt; 255        : 6        |**                                      |
       256 -&gt; 511        : 0        |                                        |
       512 -&gt; 1023       : 0        |                                        |
      1024 -&gt; 2047       : 0        |                                        |
      2048 -&gt; 4095       : 1        |                                        |
</code></pre>
<p>runqlat ä¸­ä½¿ç”¨ <code>map</code> API æ¥ä»ç”¨æˆ·æ€è®¿é—®å†…æ ¸é‡Œçš„ <code>map</code> å¹¶ç›´æ¥è¯»å–æ•°æ®ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-c">    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_lookup_elem(fd, &amp;next_key, &amp;hist);
        ...
        lookup_key = next_key;
    }
    lookup_key = -2;
    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_delete_elem(fd, &amp;next_key);
        ...
        lookup_key = next_key;
    }
</code></pre>
<p>è¿è¡Œæ—¶ wasm ä»£ç å°†ä¼šä½¿ç”¨å…±äº«å†…å­˜æ¥è®¿é—®å†…æ ¸ mapï¼Œå†…æ ¸æ€å¯ä»¥ç›´æ¥æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€ Wasm è™šæ‹Ÿæœºçš„å †æ ˆä¸­ï¼Œè€Œä¸éœ€è¦é¢å¯¹ç”¨æˆ·æ€ä¸»æœºä¾§ç¨‹åºå’Œ Wasm è¿è¡Œæ—¶ä¹‹é—´çš„é¢å¤–æ‹·è´å¼€é”€ã€‚åŒæ ·ï¼Œå¯¹äº Wasm è™šæ‹Ÿæœºå’Œå†…æ ¸æ€ä¹‹é—´å…±äº«çš„ç±»å‹å®šä¹‰ï¼Œéœ€è¦ç»è¿‡ä»”ç»†æ£€æŸ¥ä»¥ç¡®ä¿å®ƒä»¬åœ¨ Wasm å’Œå†…æ ¸æ€ä¸­çš„ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ <code>bpf_map_update_elem</code> åœ¨ç”¨æˆ·æ€ç¨‹åºå†…æ›´æ–°å†…æ ¸çš„ eBPF mapï¼Œæ¯”å¦‚:</p>
<pre><code class="language-c">        cg_map_fd = bpf_map__fd(obj-&gt;maps.cgroup_map);
        cgfd = open(env.cgroupspath, O_RDONLY);
        if (cgfd &lt; 0) {
            ...
        }
        if (bpf_map_update_elem(cg_map_fd, &amp;idx, &amp;cgfd, BPF_ANY)) {
            ...
        }
</code></pre>
<p>å› æ­¤å†…æ ¸çš„ eBPF ç¨‹åºå¯ä»¥ä» Wasm ä¾§çš„ç¨‹åºè·å–é…ç½®ï¼Œæˆ–è€…åœ¨è¿è¡Œçš„æ—¶å€™æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<h3 id="ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–°-ebpf-ç¨‹åºçš„-map-æ•°æ®-1"><a class="header" href="#ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–°-ebpf-ç¨‹åºçš„-map-æ•°æ®-1">ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–° eBPF ç¨‹åºçš„ map æ•°æ®</a></h3>
<p>runqlat æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼Œè¿™ä¸ªç¨‹åºé€šè¿‡ç›´æ–¹å›¾å±•ç¤ºè°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ—å»¶è¿Ÿï¼Œç»™æˆ‘ä»¬å±•ç°äº†ä»»åŠ¡ç­‰äº†å¤šä¹…æ‰èƒ½è¿è¡Œã€‚</p>
<pre><code class="language-console">$ sudo ./wasm-bpf runqlat.wasm -h
Summarize run queue (scheduler) latency as a histogram.

USAGE: runqlat [--help] [interval] [count]

EXAMPLES:
    runqlat         # summarize run queue latency as a histogram
    runqlat 1 10    # print 1 second summaries, 10 times
$ sudo ./wasm-bpf runqlat.wasm 1

Tracing run queue latency... Hit Ctrl-C to end.

     usecs               : count    distribution
         0 -&gt; 1          : 72       |*****************************           |
         2 -&gt; 3          : 93       |*************************************   |
         4 -&gt; 7          : 98       |****************************************|
         8 -&gt; 15         : 96       |*************************************** |
        16 -&gt; 31         : 38       |***************                         |
        32 -&gt; 63         : 4        |*                                       |
        64 -&gt; 127        : 5        |**                                      |
       128 -&gt; 255        : 6        |**                                      |
       256 -&gt; 511        : 0        |                                        |
       512 -&gt; 1023       : 0        |                                        |
      1024 -&gt; 2047       : 0        |                                        |
      2048 -&gt; 4095       : 1        |                                        |
</code></pre>
<p>runqlat ä¸­ä½¿ç”¨ <code>map</code> API æ¥ä»ç”¨æˆ·æ€è®¿é—®å†…æ ¸é‡Œçš„ <code>map</code> å¹¶ç›´æ¥è¯»å–æ•°æ®ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-c">    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_lookup_elem(fd, &amp;next_key, &amp;hist);
        ...
        lookup_key = next_key;
    }
    lookup_key = -2;
    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_delete_elem(fd, &amp;next_key);
        ...
        lookup_key = next_key;
    }
</code></pre>
<p>è¿è¡Œæ—¶ wasm ä»£ç å°†ä¼šä½¿ç”¨å…±äº«å†…å­˜æ¥è®¿é—®å†…æ ¸ mapï¼Œå†…æ ¸æ€å¯ä»¥ç›´æ¥æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€ Wasm è™šæ‹Ÿæœºçš„å †æ ˆä¸­ï¼Œè€Œä¸éœ€è¦é¢å¯¹ç”¨æˆ·æ€ä¸»æœºä¾§ç¨‹åºå’Œ Wasm è¿è¡Œæ—¶ä¹‹é—´çš„é¢å¤–æ‹·è´å¼€é”€ã€‚åŒæ ·ï¼Œå¯¹äº Wasm è™šæ‹Ÿæœºå’Œå†…æ ¸æ€ä¹‹é—´å…±äº«çš„ç±»å‹å®šä¹‰ï¼Œéœ€è¦ç»è¿‡ä»”ç»†æ£€æŸ¥ä»¥ç¡®ä¿å®ƒä»¬åœ¨ Wasm å’Œå†…æ ¸æ€ä¸­çš„ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ <code>bpf_map_update_elem</code> åœ¨ç”¨æˆ·æ€ç¨‹åºå†…æ›´æ–°å†…æ ¸çš„ eBPF mapï¼Œæ¯”å¦‚:</p>
<pre><code class="language-c">        cg_map_fd = bpf_map__fd(obj-&gt;maps.cgroup_map);
        cgfd = open(env.cgroupspath, O_RDONLY);
        if (cgfd &lt; 0) {
            ...
        }
        if (bpf_map_update_elem(cg_map_fd, &amp;idx, &amp;cgfd, BPF_ANY)) {
            ...
        }
</code></pre>
<p>å› æ­¤å†…æ ¸çš„ eBPF ç¨‹åºå¯ä»¥ä» Wasm ä¾§çš„ç¨‹åºè·å–é…ç½®ï¼Œæˆ–è€…åœ¨è¿è¡Œçš„æ—¶å€™æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<h3 id="æ›´å¤šçš„ä¾‹å­socket-filter-å’Œ-lsm"><a class="header" href="#æ›´å¤šçš„ä¾‹å­socket-filter-å’Œ-lsm">æ›´å¤šçš„ä¾‹å­ï¼šsocket filter å’Œ lsm</a></h3>
<p>åœ¨ä»“åº“ä¸­ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†æ›´å¤šçš„ç¤ºä¾‹ï¼Œä¾‹å¦‚ä½¿ç”¨ socket filter ç›‘æ§å’Œè¿‡æ»¤æ•°æ®åŒ…ï¼š</p>
<pre><code class="language-c">SEC(&quot;socket&quot;)
int socket_handler(struct __sk_buff *skb)
{
    struct so_event *e;
    __u8 verlen;
    __u16 proto;
    __u32 nhoff = ETH_HLEN;

    bpf_skb_load_bytes(skb, 12, &amp;proto, 2);
    ...

    bpf_skb_load_bytes(skb, nhoff + 0, &amp;verlen, 1);
    bpf_skb_load_bytes(skb, nhoff + ((verlen &amp; 0xF) &lt;&lt; 2), &amp;(e-&gt;ports), 4);
    e-&gt;pkt_type = skb-&gt;pkt_type;
    e-&gt;ifindex = skb-&gt;ifindex;
    bpf_ringbuf_submit(e, 0);

    return skb-&gt;len;
}
</code></pre>
<p>Linux Security Modulesï¼ˆLSMï¼‰æ˜¯ä¸€ä¸ªåŸºäºé’©å­çš„æ¡†æ¶ï¼Œç”¨äºåœ¨Linuxå†…æ ¸ä¸­å®ç°å®‰å…¨ç­–ç•¥å’Œå¼ºåˆ¶è®¿é—®æ§åˆ¶ã€‚ç›´åˆ°ç°åœ¨ï¼Œèƒ½å¤Ÿå®ç°å®æ–½å®‰å…¨ç­–ç•¥ç›®æ ‡çš„æ–¹å¼åªæœ‰ä¸¤ç§é€‰æ‹©ï¼Œé…ç½®ç°æœ‰çš„LSMæ¨¡å—ï¼ˆå¦‚AppArmorã€SELinuxï¼‰ï¼Œæˆ–ç¼–å†™è‡ªå®šä¹‰å†…æ ¸æ¨¡å—ã€‚</p>
<p>Linux Kernel 5.7 å¼•å…¥äº†ç¬¬ä¸‰ç§æ–¹å¼ï¼šLSM eBPFã€‚LSM BPF å…è®¸å¼€å‘äººå‘˜ç¼–å†™è‡ªå®šä¹‰ç­–ç•¥ï¼Œè€Œæ— éœ€é…ç½®æˆ–åŠ è½½å†…æ ¸æ¨¡å—ã€‚LSM BPF ç¨‹åºåœ¨åŠ è½½æ—¶è¢«éªŒè¯ï¼Œç„¶ååœ¨è°ƒç”¨è·¯å¾„ä¸­ï¼Œåˆ°è¾¾LSMé’©å­æ—¶è¢«æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Wasm è½»é‡çº§å®¹å™¨ä¸­ï¼Œä½¿ç”¨ lsm é™åˆ¶æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼š</p>
<pre><code class="language-c">// all lsm the hook point refer https://www.kernel.org/doc/html/v5.2/security/LSM.html
SEC(&quot;lsm/path_rmdir&quot;)
int path_rmdir(const struct path *dir, struct dentry *dentry) {
  char comm[16];
  bpf_get_current_comm(comm, sizeof(comm));
  unsigned char dir_name[] = &quot;can_not_rm&quot;;
  unsigned char d_iname[32];
  bpf_probe_read_kernel(&amp;d_iname[0], sizeof(d_iname),
                        &amp;(dir-&gt;dentry-&gt;d_iname[0]));

  bpf_printk(&quot;comm %s try to rmdir %s&quot;, comm, d_iname);
  for (int i = 0;i&lt;sizeof(dir_name);i++){
    if (d_iname[i]!=dir_name[i]){
        return 0;
    }
  }
  return -1;
}
</code></pre>
<h2 id="æ¼”ç¤ºè§†é¢‘"><a class="header" href="#æ¼”ç¤ºè§†é¢‘">æ¼”ç¤ºè§†é¢‘</a></h2>
<p>æˆ‘ä»¬ä¹Ÿæœ‰ä¸€ä¸ªåœ¨ B ç«™ä¸Šçš„æ¼”ç¤ºè§†é¢‘ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä» bcc/libbpf-tools ä¸­ç§»æ¤ä¸€ä¸ª eBPF å·¥å…·ç¨‹åºåˆ° eunomia-bpf ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨ Wasm æˆ– JSON æ–‡ä»¶æ¥åˆ†å‘ã€åŠ è½½ eBPF ç¨‹åºï¼š<a href="https://www.bilibili.com/video/BV1JN4y1A76k">https://www.bilibili.com/video/BV1JN4y1A76k</a></p>
<p><code>ecli</code> æ˜¯åŸºäºæˆ‘ä»¬åº•å±‚çš„ eunomia-bpf åº“å’Œè¿è¡Œæ—¶å®ç°çš„ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ã€‚æˆ‘ä»¬çš„é¡¹ç›®æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="img/eunomia-arch.png" alt="arch" /></p>
<p><code>ecli</code> å·¥å…·åŸºäº <code>ewasm</code> åº“å®ç°ï¼Œ<code>ewasm</code> åº“åŒ…å«ä¸€ä¸ª WAMR(wasm-micro-runtime) è¿è¡Œæ—¶ï¼Œä»¥åŠåŸºäº libbpf åº“æ„å»ºçš„ eBPF åŠ¨æ€è£…è½½æ¨¡å—ã€‚å¤§è‡´æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨ <code>Wasm</code> è¿è¡Œæ—¶å’Œç”¨æˆ·æ€çš„ <code>libbpf</code> ä¸­é—´å¤šåŠ äº†ä¸€å±‚æŠ½è±¡å±‚ï¼ˆ<code>eunomia-bpf</code> åº“ï¼‰ï¼Œä½¿å¾—ä¸€æ¬¡ç¼–è¯‘ã€åˆ°å¤„è¿è¡Œçš„ eBPF ä»£ç å¯ä»¥ä» JSON å¯¹è±¡ä¸­åŠ¨æ€åŠ è½½ã€‚JSON å¯¹è±¡ä¼šåœ¨ç¼–è¯‘æ—¶è¢«åŒ…å«åœ¨ Wasm æ¨¡å—ä¸­ï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è§£æ JSON å¯¹è±¡æ¥è·å– eBPF ç¨‹åºçš„ä¿¡æ¯ï¼Œç„¶ååŠ¨æ€åŠ è½½ eBPF ç¨‹åºã€‚</p>
<p>ä½¿ç”¨ Wasm æˆ– JSON ç¼–è¯‘åˆ†å‘ eBPF ç¨‹åºçš„æµç¨‹å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><img src="img/eunomia-bpf-flow.png" alt="flow" /></p>
<p>å¤§è‡´æ¥è¯´ï¼Œæ•´ä¸ª eBPF ç¨‹åºçš„ç¼–å†™å’ŒåŠ è½½åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>ç”¨ eunomia-cc å·¥å…·é“¾å°†å†…æ ¸çš„ eBPF ä»£ç éª¨æ¶å’Œå­—èŠ‚ç ç¼–è¯‘ä¸º JSON æ ¼å¼</li>
<li>åœ¨ç”¨æˆ·æ€å¼€å‘çš„é«˜çº§è¯­è¨€ï¼ˆä¾‹å¦‚ C è¯­è¨€ï¼‰ä¸­åµŒå…¥ JSON æ•°æ®ï¼Œå¹¶æä¾›ä¸€äº› API ç”¨äºæ“ä½œ JSON å½¢æ€çš„ eBPF ç¨‹åºéª¨æ¶</li>
<li>å°†ç”¨æˆ·æ€ç¨‹åºå’Œ JSON æ•°æ®ä¸€èµ·ç¼–è¯‘ä¸º Wasm å­—èŠ‚ç å¹¶æ‰“åŒ…ä¸º Wasm æ¨¡å—ï¼Œç„¶ååœ¨ç›®æ ‡æœºå™¨ä¸ŠåŠ è½½å¹¶è¿è¡Œ Wasm ç¨‹åº</li>
<li>ä» Wasm æ¨¡å—ä¸­åŠ è½½å†…åµŒçš„ JSON æ•°æ®ï¼Œç”¨ eunomia-bpf åº“åŠ¨æ€è£…è½½å’Œé…ç½® eBPF ç¨‹åºéª¨æ¶ã€‚</li>
</ol>
<p>æˆ‘ä»¬éœ€è¦å®Œæˆçš„ä»…ä»…æ˜¯å°‘é‡çš„ native API å’Œ Wasm è¿è¡Œæ—¶çš„ç»‘å®šï¼Œå¹¶ä¸”åœ¨ Wasm ä»£ç ä¸­å¤„ç† JSON æ•°æ®ã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªå•ä¸€çš„ <code>Wasm</code> æ¨¡å—ä¸­æ‹¥æœ‰å¤šä¸ª <code>eBPF</code> ç¨‹åºã€‚å¦‚æœä¸ä½¿ç”¨æˆ‘ä»¬æä¾›çš„ Wasm è¿è¡Œæ—¶ï¼Œæˆ–è€…æƒ³è¦ä½¿ç”¨å…¶ä»–è¯­è¨€è¿›è¡Œç”¨æˆ·æ€çš„ eBPF è¾…åŠ©ä»£ç çš„å¼€å‘ï¼Œåœ¨æˆ‘ä»¬æä¾›çš„ <code>eunomia-bpf</code> åº“åŸºç¡€ä¸Šå®Œæˆä¸€äº› WebaAssembly çš„ç»‘å®šå³å¯ã€‚</p>
<p>å¦å¤–ï¼Œå¯¹äº eunomia-bpf åº“è€Œè¨€ï¼Œä¸éœ€è¦ Wasm æ¨¡å—å’Œè¿è¡Œæ—¶åŒæ ·å¯ä»¥å¯åŠ¨å’ŒåŠ¨æ€åŠ è½½ eBPF ç¨‹åºï¼Œä¸è¿‡æ­¤æ—¶åŠ¨æ€åŠ è½½è¿è¡Œçš„å°±åªæ˜¯å†…æ ¸æ€çš„ eBPF ç¨‹åºå­—èŠ‚ç ã€‚ä½ å¯ä»¥æ‰‹åŠ¨æˆ–ä½¿ç”¨ä»»æ„è¯­è¨€ä¿®æ”¹ JSON å¯¹è±¡æ¥æ§åˆ¶ eBPF ç¨‹åºçš„åŠ è½½å’Œå‚æ•°ï¼Œå¹¶ä¸”é€šè¿‡ eunomia-bpf è‡ªåŠ¨è·å–å†…æ ¸æ€ä¸ŠæŠ¥çš„è¿”å›æ•°æ®ã€‚å¯¹äºåˆå­¦è€…è€Œè¨€ï¼Œè¿™å¯èƒ½æ¯”ä½¿ç”¨ WebAssembly æ›´åŠ ç®€å•æ–¹ä¾¿ï¼šåªéœ€è¦ç¼–å†™å†…æ ¸æ€çš„ eBPF ç¨‹åºï¼Œç„¶åä½¿ç”¨ eunomia-cc å·¥å…·é“¾å°†å…¶ç¼–è¯‘ä¸º JSON æ ¼å¼ï¼Œæœ€åä½¿ç”¨ eunomia-bpf åº“åŠ è½½å’Œè¿è¡Œå³å¯ã€‚å®Œå…¨ä¸ç”¨è€ƒè™‘ä»»ä½•ç”¨æˆ·æ€çš„è¾…åŠ©ç¨‹åºï¼ŒåŒ…æ‹¬ Wasm åœ¨å†…ã€‚å…·ä½“å¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ä½¿ç”¨æ‰‹å†Œ[7]æˆ–ç¤ºä¾‹ä»£ç [8]ã€‚</p>
<h2 id="åŸç†"><a class="header" href="#åŸç†">åŸç†</a></h2>
<p><code>ecli</code> æ˜¯åŸºäºæˆ‘ä»¬åº•å±‚çš„ eunomia-bpf åº“å’Œè¿è¡Œæ—¶å®ç°çš„ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ã€‚æˆ‘ä»¬çš„é¡¹ç›®æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="img/eunomia-arch.png" alt="arch" /></p>
<p><code>ecli</code> å·¥å…·åŸºäº <code>ewasm</code> åº“å®ç°ï¼Œ<code>ewasm</code> åº“åŒ…å«ä¸€ä¸ª WAMR(wasm-micro-runtime) è¿è¡Œæ—¶ï¼Œä»¥åŠåŸºäº libbpf åº“æ„å»ºçš„ eBPF åŠ¨æ€è£…è½½æ¨¡å—ã€‚å¤§è‡´æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨ <code>Wasm</code> è¿è¡Œæ—¶å’Œç”¨æˆ·æ€çš„ <code>libbpf</code> ä¸­é—´å¤šåŠ äº†ä¸€å±‚æŠ½è±¡å±‚ï¼ˆ<code>eunomia-bpf</code> åº“ï¼‰ï¼Œä½¿å¾—ä¸€æ¬¡ç¼–è¯‘ã€åˆ°å¤„è¿è¡Œçš„ eBPF ä»£ç å¯ä»¥ä» JSON å¯¹è±¡ä¸­åŠ¨æ€åŠ è½½ã€‚JSON å¯¹è±¡ä¼šåœ¨ç¼–è¯‘æ—¶è¢«åŒ…å«åœ¨ Wasm æ¨¡å—ä¸­ï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è§£æ JSON å¯¹è±¡æ¥è·å– eBPF ç¨‹åºçš„ä¿¡æ¯ï¼Œç„¶ååŠ¨æ€åŠ è½½ eBPF ç¨‹åºã€‚</p>
<p>ä½¿ç”¨ Wasm æˆ– JSON ç¼–è¯‘åˆ†å‘ eBPF ç¨‹åºçš„æµç¨‹å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="language-mermaid">graph TD
  b3--&gt;package
  b4--&gt;a3
  package--&gt;a1
  package(å¯é€šè¿‡ç½‘ç»œæˆ–å…¶ä»–ä»»æ„æ–¹å¼è¿›è¡Œåˆ†å‘: CO-RE)

  subgraph è¿è¡Œæ—¶åŠ è½½å™¨åº“
  a3(è¿è¡Œ Wasm æ¨¡å—é…ç½® eBPF ç¨‹åºæˆ–å’Œ eBPF ç¨‹åºäº¤äº’)
  a1(æ ¹æ® JSON é…ç½®ä¿¡æ¯åŠ¨æ€è£…è½½ eBPF ç¨‹åº)
  a2(æ ¹æ®ç±»å‹ä¿¡æ¯å’Œå†…å­˜å¸ƒå±€ä¿¡æ¯å¯¹å†…æ ¸æ€å¯¼å‡ºäº‹ä»¶è¿›è¡ŒåŠ¨æ€å¤„ç†)
  a1--&gt;a2
  a3--&gt;a1
  a2--&gt;a3
  end

  subgraph eBPFç¼–è¯‘å·¥å…·é“¾
  b1(ä½¿ç”¨ Clang ç¼–è¯‘ eBPF ç¨‹åºè·å¾—åŒ…å«é‡å®šä½ä¿¡æ¯çš„ bpf.o)
  b2(æ·»åŠ ä» eBPF æºä»£ç è·å–çš„å†…æ ¸æ€å¯¼å‡ºæ•°æ®çš„å†…å­˜å¸ƒå±€, ç±»å‹ä¿¡æ¯ç­‰)
  b3(æ‰“åŒ…ç”Ÿæˆ JSON æ•°æ®)
  b4(æ‰“åŒ…æˆ Wasm æ¨¡å—è¿›è¡Œåˆ†å‘)
  b5(å¯é€‰çš„ç”¨æˆ·æ€æ•°æ®å¤„ç†ç¨‹åºç¼–è¯‘ä¸º Wasm)
  b2--&gt;b3
  b3--&gt;b5
  b5--&gt;b4
  b1--&gt;b2
  end
</code></pre>
<p>å¤§è‡´æ¥è¯´ï¼Œæ•´ä¸ª eBPF ç¨‹åºçš„ç¼–å†™å’ŒåŠ è½½åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>ç”¨ eunomia-cc å·¥å…·é“¾å°†å†…æ ¸çš„ eBPF ä»£ç éª¨æ¶å’Œå­—èŠ‚ç ç¼–è¯‘ä¸º JSON æ ¼å¼</li>
<li>åœ¨ç”¨æˆ·æ€å¼€å‘çš„é«˜çº§è¯­è¨€ï¼ˆä¾‹å¦‚ C è¯­è¨€ï¼‰ä¸­åµŒå…¥ JSON æ•°æ®ï¼Œå¹¶æä¾›ä¸€äº› API ç”¨äºæ“ä½œ JSON å½¢æ€çš„ eBPF ç¨‹åºéª¨æ¶</li>
<li>å°†ç”¨æˆ·æ€ç¨‹åºå’Œ JSON æ•°æ®ä¸€èµ·ç¼–è¯‘ä¸º Wasm å­—èŠ‚ç å¹¶æ‰“åŒ…ä¸º Wasm æ¨¡å—ï¼Œç„¶ååœ¨ç›®æ ‡æœºå™¨ä¸ŠåŠ è½½å¹¶è¿è¡Œ Wasm ç¨‹åº</li>
<li>ä» Wasm æ¨¡å—ä¸­åŠ è½½å†…åµŒçš„ JSON æ•°æ®ï¼Œç”¨ eunomia-bpf åº“åŠ¨æ€è£…è½½å’Œé…ç½® eBPF ç¨‹åºéª¨æ¶ã€‚</li>
</ol>
<p>æˆ‘ä»¬éœ€è¦å®Œæˆçš„ä»…ä»…æ˜¯å°‘é‡çš„ native API å’Œ Wasm è¿è¡Œæ—¶çš„ç»‘å®šï¼Œå¹¶ä¸”åœ¨ Wasm ä»£ç ä¸­å¤„ç† JSON æ•°æ®ã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªå•ä¸€çš„ <code>Wasm</code> æ¨¡å—ä¸­æ‹¥æœ‰å¤šä¸ª <code>eBPF</code> ç¨‹åºã€‚å¦‚æœä¸ä½¿ç”¨æˆ‘ä»¬æä¾›çš„ Wasm è¿è¡Œæ—¶ï¼Œæˆ–è€…æƒ³è¦ä½¿ç”¨å…¶ä»–è¯­è¨€è¿›è¡Œç”¨æˆ·æ€çš„ eBPF è¾…åŠ©ä»£ç çš„å¼€å‘ï¼Œåœ¨æˆ‘ä»¬æä¾›çš„ <code>eunomia-bpf</code> åº“åŸºç¡€ä¸Šå®Œæˆä¸€äº› WebaAssembly çš„ç»‘å®šå³å¯ã€‚</p>
<p>å¦å¤–ï¼Œå¯¹äº eunomia-bpf åº“è€Œè¨€ï¼Œä¸éœ€è¦ Wasm æ¨¡å—å’Œè¿è¡Œæ—¶åŒæ ·å¯ä»¥å¯åŠ¨å’ŒåŠ¨æ€åŠ è½½ eBPF ç¨‹åºï¼Œä¸è¿‡æ­¤æ—¶åŠ¨æ€åŠ è½½è¿è¡Œçš„å°±åªæ˜¯å†…æ ¸æ€çš„ eBPF ç¨‹åºå­—èŠ‚ç ã€‚ä½ å¯ä»¥æ‰‹åŠ¨æˆ–ä½¿ç”¨ä»»æ„è¯­è¨€ä¿®æ”¹ JSON å¯¹è±¡æ¥æ§åˆ¶ eBPF ç¨‹åºçš„åŠ è½½å’Œå‚æ•°ï¼Œå¹¶ä¸”é€šè¿‡ eunomia-bpf è‡ªåŠ¨è·å–å†…æ ¸æ€ä¸ŠæŠ¥çš„è¿”å›æ•°æ®ã€‚å¯¹äºåˆå­¦è€…è€Œè¨€ï¼Œè¿™å¯èƒ½æ¯”ä½¿ç”¨ WebAssembly æ›´åŠ ç®€å•æ–¹ä¾¿ï¼šåªéœ€è¦ç¼–å†™å†…æ ¸æ€çš„ eBPF ç¨‹åºï¼Œç„¶åä½¿ç”¨ eunomia-cc å·¥å…·é“¾å°†å…¶ç¼–è¯‘ä¸º JSON æ ¼å¼ï¼Œæœ€åä½¿ç”¨ eunomia-bpf åº“åŠ è½½å’Œè¿è¡Œå³å¯ã€‚å®Œå…¨ä¸ç”¨è€ƒè™‘ä»»ä½•ç”¨æˆ·æ€çš„è¾…åŠ©ç¨‹åºï¼ŒåŒ…æ‹¬ Wasm åœ¨å†…ã€‚å…·ä½“å¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ä½¿ç”¨æ‰‹å†Œ[7]æˆ–ç¤ºä¾‹ä»£ç [8]ã€‚</p>
<h2 id="ä¸ºæˆ‘ä»¬çš„é¡¹ç›®è´¡çŒ®ä»£ç "><a class="header" href="#ä¸ºæˆ‘ä»¬çš„é¡¹ç›®è´¡çŒ®ä»£ç ">ä¸ºæˆ‘ä»¬çš„é¡¹ç›®è´¡çŒ®ä»£ç </a></h2>
<p>æˆ‘ä»¬çš„é¡¹ç›®è¿˜åœ¨æ—©æœŸé˜¶æ®µï¼Œå› æ­¤éå¸¸å¸Œæœ›æœ‰æ‚¨çš„å¸®åŠ©ï¼š</p>
<ul>
<li>è¿è¡Œæ—¶åº“åœ°å€ï¼š <a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>ç¼–è¯‘å™¨åœ°å€ï¼š <a href="https://github.com/eunomia-bpf/eunomia-cc">https://github.com/eunomia-bpf/eunomia-cc</a></li>
<li>æ–‡æ¡£ï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf.github.io">https://github.com/eunomia-bpf/eunomia-bpf.github.io</a></li>
</ul>
<p>eunomia-bpf ä¹Ÿå·²ç»åŠ å…¥äº†é¾™èœ¥ç¤¾åŒºï¼š</p>
<ul>
<li>gitee é•œåƒï¼š<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
</ul>
<p>æ‚¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ·»åŠ æµ‹è¯•æˆ–è€…ç¤ºä¾‹ï¼Œå¯ä»¥å‚è€ƒï¼š</p>
<ul>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools">examples/bpftools</a></li>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/tests">bpftools/tests</a></li>
</ul>
<p>ç”±äºç°åœ¨ API è¿˜ä¸ç¨³å®šï¼Œå¦‚æœæ‚¨åœ¨è¯•ç”¨ä¸­é‡åˆ°ä»»ä½•é—®é¢˜æˆ–è€…ä»»ä½•æµç¨‹/æ–‡æ¡£ä¸å®Œå–„çš„åœ°æ–¹ï¼Œè¯·åœ¨ gitee æˆ– github issue ç•™è¨€ï¼Œ
æˆ‘ä»¬ä¼šå°½å¿«ä¿®å¤ï¼›ä¹Ÿéå¸¸æ¬¢è¿è¿›ä¸€æ­¥çš„ PR æäº¤å’Œè´¡çŒ®ï¼ä¹Ÿéå¸¸å¸Œæœ›æ‚¨èƒ½æå‡ºä¸€äº›å®è´µçš„æ„è§æˆ–è€…å»ºè®®ï¼</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åœ¨çº¿ä½“éªŒç½‘ç«™"><a class="header" href="#åœ¨çº¿ä½“éªŒç½‘ç«™">åœ¨çº¿ä½“éªŒç½‘ç«™</a></h1>
<p>å¯ä½¿ç”¨ bolipi æä¾›çš„åœ¨çº¿ä½“éªŒæœåŠ¡ï¼Œåœ¨çº¿ç¼–è¯‘ï¼Œåœ¨çº¿è¿è¡Œã€åœ¨çº¿è·å–å¯è§†åŒ–ç»“æœï¼š<a href="https://bolipi.com/ebpf/home/online">https://bolipi.com/ebpf/home/online</a></p>
<p><img src="img/online.png" alt="imga" /></p>
<h2 id="é€šè¿‡åœ¨çº¿ç¼–è¯‘è¿è¡Œå¿«é€Ÿä½“éªŒ-ebpf-å’Œå¯è§†åŒ–"><a class="header" href="#é€šè¿‡åœ¨çº¿ç¼–è¯‘è¿è¡Œå¿«é€Ÿä½“éªŒ-ebpf-å’Œå¯è§†åŒ–">é€šè¿‡åœ¨çº¿ç¼–è¯‘è¿è¡Œå¿«é€Ÿä½“éªŒ eBPF å’Œå¯è§†åŒ–</a></h2>
<p>æœ¬åœ¨çº¿ç¼–è¯‘å¹³å°ç”± <code>eunomia-bpf</code> å·¥å…·é“¾æä¾›æ”¯æŒï¼Œè¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒ <a href="https://eunomia-bpf.github.io/">eunomia-bpf.github.io/</a></p>
<h3 id="åœ¨çº¿ç¼–è¯‘"><a class="header" href="#åœ¨çº¿ç¼–è¯‘">åœ¨çº¿ç¼–è¯‘</a></h3>
<p>åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­ç¼–å†™ eBPF çš„å†…æ ¸æ€ç¨‹åºï¼Œåº”å½“éµå¾ª libbpf-tools çš„å†…æ ¸æ€ä»£ç ç¼–å†™çº¦å®šï¼Œå³ï¼š</p>
<ul>
<li><code>ä»£ç ç¼–è¾‘å™¨</code> (*.bpf.c) åŒ…å« BPF C ä»£ç ï¼Œå®ƒè¢«ç¼–è¯‘æˆ package.json</li>
<li><code>å¤´æ–‡ä»¶ç¼–è¾‘å™¨</code> (*.h) å¯ä»¥é€‰æ‹©åŒ…å«é€šè¿‡ perf event æˆ–ç¯å½¢ç¼“å†²åŒºå¯¼å‡ºåˆ°ç”¨æˆ·ç©ºé—´çš„ç±»å‹</li>
</ul>
<p>æˆ‘ä»¬ç›®å‰åªæ”¯æŒä½¿ç”¨åŸºäº libbpf çš„å†…æ ¸æ€ä»£ç ï¼ŒBCC ä»£ç æ”¯æŒç”±äºå­˜åœ¨ä¸€äº›è¯­æ³•ä¸Šçš„å·®å¼‚ï¼Œè¿˜åœ¨å¼€å‘ä¸­ã€‚</p>
<p>ç¼–å†™å®Œæˆä»£ç åï¼Œç‚¹å‡» <code>ç¼–è¯‘</code> æŒ‰é’®å³å¯ç¼–è¯‘æˆ eBPF çš„å†…æ ¸æ€ç¨‹åºï¼Œåœ¨ <code>ç¼–è¯‘è¾“å‡º</code> ä¸­æŸ¥çœ‹ç¼–è¯‘è¾“å‡ºï¼š</p>
<p><img src="img/compile-output.png" alt="imgb" /></p>
<p>æ›´å¤šä¿¡æ¯è¯·å‚è€ƒï¼š<a href="https://eunomia-bpf.github.io/mannual.html">eunomia-bpf.github.io/mannual.html</a></p>
<p>æ›´å¤šä¾‹å­è¯·å‚è€ƒï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools</a></p>
<h3 id="åœ¨çº¿è¿è¡Œ"><a class="header" href="#åœ¨çº¿è¿è¡Œ">åœ¨çº¿è¿è¡Œ</a></h3>
<p>ç‚¹å‡»å³ä¾§çš„ç»¿è‰²è¿è¡ŒæŒ‰é’®è¿è¡Œï¼š</p>
<p><img src="img/run-ebpf.png" alt="imgc" /></p>
<p>ä¹Ÿå¯ä»¥é€šè¿‡ <code>ä¸‹è½½ç¼–è¯‘åçš„æ–‡ä»¶</code> æŸ¥çœ‹ç¼–è¯‘å¥½çš„ç¨‹åºï¼Œå¹¶åœ¨æœ¬åœ°ä½¿ç”¨ <code>ecli</code> ç›´æ¥è¿è¡Œï¼š</p>
<pre><code class="language-console">$ # ä¸‹è½½å®‰è£… ecli äºŒè¿›åˆ¶
$ wget https://aka.pw/bpf-ecli -O ./ecli &amp;&amp; chmod +x ./ecli
$ # è¿è¡Œ eBPF ç¨‹åºï¼ˆroot shellï¼‰
$ sudo ./ecli run package.json
</code></pre>
<h3 id="ä½¿ç”¨-prometheus-åœ¨çº¿è·å–å¯è§†åŒ–ç»“æœ"><a class="header" href="#ä½¿ç”¨-prometheus-åœ¨çº¿è·å–å¯è§†åŒ–ç»“æœ">ä½¿ç”¨ Prometheus åœ¨çº¿è·å–å¯è§†åŒ–ç»“æœ</a></h3>
<p>ç‚¹å‡» <code>è¿è¡Œå¯è§†åŒ–ç»„ä»¶</code> æŒ‰é’®ï¼Œåœ¨å¼¹å‡ºçš„çª—å£ä¸­é…ç½® prometheus metrics ä¿¡æ¯:</p>
<p><img src="img/prometheus-config.png" alt="imgd" /></p>
<p>ç‚¹å‡» <code>ç¡®å®š</code> å³å¯è·³è½¬åˆ° Prometheus ç•Œé¢ï¼Œå¯é€šè¿‡é€‰æ‹© graph æŸ¥çœ‹å¯è§†åŒ–ç»“æœï¼š</p>
<p><img src="img/prometheus-graph.png" alt="imgd" /></p>
<h2 id="å…³äº-eunomia-bpf"><a class="header" href="#å…³äº-eunomia-bpf">å…³äº eunomia-bpf</a></h2>
<p>eunomia-bpf æ˜¯ä¸€å¥—ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶ï¼Œä»¥åŠä¸€äº›é™„åŠ é¡¹ç›®ï¼Œæˆ‘ä»¬å¸Œæœ›åšåˆ°è®© eBPF ç¨‹åºï¼š</p>
<ul>
<li>è®© eBPF ç¨‹åºçš„ç¼–è¯‘å’Œè¿è¡Œè¿‡ç¨‹å¤§å¤§ç®€åŒ–ï¼ŒæŠ›å»ç¹ççš„ç”¨æˆ·æ€æ¨¡æ¿ç¼–å†™ã€ç¹ççš„ BCC å®‰è£…æµç¨‹ï¼Œåªéœ€è¦ç¼–å†™å†…æ ¸æ€ eBPF ç¨‹åºï¼Œç¼–è¯‘åå³å¯åœ¨ä¸åŒæœºå™¨ä¸Šä»»æ„å†…æ ¸ç‰ˆæœ¬ä¸‹è¿è¡Œï¼Œå¹¶ä¸”è½»æ¾è·å–å¯è§†åŒ–ç»“æœã€‚</li>
<li>çœŸæ­£åƒ JavaScript æˆ–è€… Wasm é‚£æ ·æ˜“äºåˆ†å‘å’Œè¿è¡Œï¼Œæˆ–è€…è¯´å†…æ ¸æ€æˆ–å¯è§‚æµ‹æ€§å±‚é¢çš„ FaaSï¼šeBPF å³æœåŠ¡ï¼Œé€šè¿‡ API è¯·æ±‚å¿«é€Ÿåˆ†å‘å’Œè¿è¡Œï¼Œæ— éœ€ç®¡ç†åŸºç¡€è®¾æ–½å’Œç”¨æˆ·æ€åŠ è½½ç¨‹åºï¼›</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="common-problem"><a class="header" href="#common-problem">common problem</a></h1>
<p>if you get a error like <code>/usr/lib/x86_64-linux-gnu/libstdc++.so.6: version GLIBCXX_3.4.29 not found</code> on old version kernels,</p>
<p>try:</p>
<pre><code class="language-console">sudo apt-get upgrade libstdc++6
</code></pre>
<p>see https://stackoverflow.com/questions/65349875/where-can-i-find-glibcxx-3-4-29</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="supporting-external-btf"><a class="header" href="#supporting-external-btf">supporting external BTF</a></h1>
<p>1.ç¡®è®¤å†…æ ¸BTFé€‰é¡¹å·²ç»æ‰“å¼€</p>
<pre><code class="language-conf">CONFIG_DEBUG_INFO=y
CONFIG_DEBUG_INFO_BTF=y
</code></pre>
<p>å¦‚æœå†…æ ¸é€‰é¡¹æœªå¼€å¯ï¼Œå°±éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸</p>
<ol start="2">
<li>ç¡®è®¤å½“å‰å†…æ ¸BTFä¿¡æ¯æ˜¯å¦å¯ç”¨ï¼Œå¦‚ä¸å¯ç”¨éœ€æ·»åŠ å¤–æºBTFä¿¡æ¯</li>
</ol>
<p>è‹¥/sys/kernel/btf/vmlinuxå­˜åœ¨ï¼Œåˆ™BTFå¯ç”¨ï¼Œå¯é€šè¿‡bpftoolç”Ÿæˆvmlinux.h</p>
<pre><code class="language-sh">apt install linux-tools-(uname -r)-generic
apt install linux-tools-generic
bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</code></pre>
<p>è‹¥/sys/kernel/btf/vmlinuxä¸å­˜åœ¨ï¼Œåˆ™BTFä¸å¯ç”¨ï¼Œå¯é€šè¿‡<a href="https://github.com/aquasecurity/btfhub">btfhub</a>æ·»åŠ å¤–æºBTFä¿¡æ¯æˆ–ç”Ÿæˆå½“å‰å†…æ ¸çš„å®šåˆ¶åŒ–BTFä¿¡æ¯</p>
<p>ï¼ˆ1ï¼‰æ·»åŠ å¤–æºBTFä¿¡æ¯</p>
<p>å‚è€ƒ <a href="https://github.com/aquasecurity/btfhub/blob/main/docs/generating-tailored-btfs.md">BTFgen tool to create smaller BTF files</a></p>
<pre><code class="language-sh">$ git clone git@github.com:aquasecurity/btfhub.git
$ git clone git@github.com:aquasecurity/btfhub-archive.git
$ cd btfhub ; ls
//å°†å…‹éš†çš„å½’æ¡£æ–‡ä»¶æ”¾å…¥ btfhub ç›®å½•
$ rsync -avz ../btfhub-archive/ --exclude=.git* --exclude=README.md ./archive/
</code></pre>
<p>æ•´ä¸ªbtfhub-archiveç›®å½•ç›¸å½“åºå¤§ï¼Œå¯ä»¥å•ç‹¬ä¸‹è½½æŸä¸ªBTFå½’æ¡£æ–‡ä»¶æ”¾å…¥btfhub ç›®å½•</p>
<pre><code class="language-sh">$ rsync -avz ../5.11.0-1027-azure.btf.tar.xz --exclude=.git* --exclude=README.md ./archive/
sending incremental file list

sent 77 bytes  received 12 bytes  178.00 bytes/sec
total size is 144,419  speedup is 1,622.69
</code></pre>
<p>ä¹‹åå°±å¯ä»¥æ ¹æ®æŸä¸ªå¯¹åº”çš„eBPF å¯¹è±¡ç”Ÿæˆå®šåˆ¶çš„BTF æ–‡ä»¶</p>
<pre><code class="language-sh">#ç”Ÿæˆå®šåˆ¶çš„ eBPF å¯¹è±¡çš„ BTF æ–‡ä»¶:
$ ./tools/btfgen.sh -a AARCH64 -o $HOME/****.bpf.core.o
</code></pre>
<p>æ£€æŸ¥å®šåˆ¶çš„æ–°ç”Ÿæˆçš„ BTF æ–‡ä»¶åŠå…¶å°ºå¯¸</p>
<pre><code class="language-sh">$ find custom-archive | grep ubuntu | tail -10
$ls -lah custom-archive/ubuntu/20.04/x86_64/5.8.0-1041-azure.btf
</code></pre>
<p>ï¼ˆ2ï¼‰ç”Ÿæˆå½“å‰å†…æ ¸çš„å®šåˆ¶åŒ–BTFä¿¡æ¯</p>
<pre><code class="language-sh">$ sudo ./example-static
$ sudo ./example-c-static
$ sudo EXAMPLE_BTF_FILE=5.8.0-63-generic.btf ./example-static
$ sudo EXAMPLE_BTF_FILE=5.8.0-63-generic.btf ./example-c-static
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="benchmark"><a class="header" href="#benchmark">benchmark</a></h1>
<p>Most of the time, bpf-loader work as a library to load eBPF program. It will not affect eBPF program after the program has been loaded and attached.</p>
<p>TODO: add more benchmark results</p>
<h2 id="benchmark-for-loading-with-exporter"><a class="header" href="#benchmark-for-loading-with-exporter">benchmark for loading with exporter</a></h2>
<p>Take opensnoop from <a href="https://github.com/iovisor/bcc/blob/master/libbpf-tools/opensnoop.bpf.c">bcc/libbpf-tools</a> as an example. starting with BCC, you will need about 0.8s to start the exporter and attach to the probe. With out implement, you only need about <code>50-70ms</code> which is significantly faster.</p>
<pre><code class="language-console">$ ps -aux | grep eunomia
root      171562  0.0  0.0  15176  4576 pts/6    S+   01:08   0:00 sudo ./eunomia-exporter
root      171605  0.1  0.0 350540  7740 pts/6    Sl+  01:08   0:00 ./eunomia-exporter
</code></pre>
<p>The memory usage and CPU usage is also low. see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/eunomia-sdks/eunomia-otel">eunomia-exporter</a> for more details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="videos"><a class="header" href="#videos">videos</a></h1>
<ul>
<li><a href="https://www.bilibili.com/video/BV1DG4y1N76m/">eunomia-bpf: ä¸€ä¸ªå¼€æºçš„ ebpf åŠ¨æ€åŠ è½½è¿è¡Œæ—¶å’Œå¼€å‘å·¥å…·é“¾</a></li>
<li><a href="https://www.bilibili.com/video/BV1dG411g7G7/">eunomia-bpfï¼šeBPFè½»é‡çº§å¼€å‘æ¡†æ¶</a></li>
<li><a href="https://www.bilibili.com/video/BV1vD4y1P78S/">wasm-bpfï¼šeBPF ç¨‹åºçš„ WebAssembly ç¼–è¯‘å·¥å…·é“¾ä¸è¿è¡Œæ—¶</a></li>
<li><a href="https://www.bilibili.com/video/BV1JN4y1A76k/?vd_source=b2fa9e4d67372fcdc983c3c25b42b628">ä½¿ç”¨ WASM å¼€å‘å’Œåˆ†å‘ eBPF åº”ç”¨</a></li>
<li><a href="https://www.bilibili.com/video/BV1u84y1C7pQ/">ã€è¾¾å¦ç§‘æŠ€DatenLordã€‘eunomia-bpf: ç»“åˆ wasm çš„ ebpf è½»é‡çº§å¼€å‘æ¡†æ¶</a></li>
<li><a href="https://www.bilibili.com/video/BV1Hs4y1a7Q8/">eunomia-bpfï¼šè¶…ç®€æ´çš„äº‘ç«¯eBPFéƒ¨ç½²æ–¹å¼</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blog"><a class="header" href="#blog">Blog</a></h1>
<p>Blogs about eunomia-bpf:</p>
<ul>
<li><a href="blog/introduce-to-wasm-bpf-bpf-community.html">Wasm-bpf: æ¶èµ· Webassembly å’Œ eBPF å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢</a></li>
<li><a href="blog/how-to-write-c-in-wasm.html">åœ¨ WebAssembly ä¸­ä½¿ç”¨ C/C++ å’Œ libbpf ç¼–å†™ eBPF ç¨‹åº</a></li>
<li><a href="blog/how-to-write-rust-in-wasm.html">åœ¨ WebAssembly ä¸­ä½¿ç”¨ Rust ç¼–å†™ eBPF ç¨‹åºå¹¶å‘å¸ƒ OCI é•œåƒ</a></li>
<li><a href="blog/GPTtrace.html">ä½¿ç”¨ ChatGPT ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€ç¼–å†™ eBPF ç¨‹åºå’Œè¿½è¸ª Linux ç³»ç»Ÿ</a></li>
<li><a href="blog/ebpf-wasm.html">å½“ Wasm é‡è§ eBPF ï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åº</a></li>
<li><a href="blog/lmp-eunomia.html">å¦‚ä½•åœ¨ Linux æ˜¾å¾®é•œï¼ˆLMPï¼‰é¡¹ç›®ä¸­å¼€å¯ eBPF ä¹‹æ—…</a></li>
<li><a href="blog/0.3.0-release.html">eunomia-bpf 0.3.0 å‘å¸ƒï¼šåªéœ€ç¼–å†™å†…æ ¸æ€ä»£ç ï¼Œè½»æ¾æ„å»ºã€æ‰“åŒ…ã€å‘å¸ƒå®Œæ•´çš„ eBPF åº”ç”¨</a></li>
<li><a href="blog/coolbpf-eunomia.html">eunomia-bpfï¼šå±•æœ› 2023ï¼Œè®© eBPF æ’ä¸Š Wasm çš„ç¿…è†€</a></li>
<li><a href="blog/bpf-news.html">eBPF è¿›é˜¶: å†…æ ¸æ–°ç‰¹æ€§è¿›å±•ä¸€è§ˆ</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wasm-bpf-æ¶èµ·-webassembly-å’Œ-ebpf-å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢"><a class="header" href="#wasm-bpf-æ¶èµ·-webassembly-å’Œ-ebpf-å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢">Wasm-bpf: æ¶èµ· Webassembly å’Œ eBPF å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢</a></h1>
<blockquote>
<p>ä½œè€…ï¼šéƒ‘æ˜±ç¬™ï¼Œé™ˆèŒ‚æ—</p>
</blockquote>
<p>Wasm æœ€åˆæ˜¯ä»¥æµè§ˆå™¨å®‰å…¨æ²™ç›’ä¸ºç›®çš„å¼€å‘çš„ï¼Œå‘å±•åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒWebAssembly å·²ç»æˆä¸ºä¸€ä¸ªç”¨äºäº‘åŸç”Ÿè½¯ä»¶ç»„ä»¶çš„é«˜æ€§èƒ½ã€è·¨å¹³å°å’Œå¤šè¯­è¨€è½¯ä»¶æ²™ç®±ç¯å¢ƒï¼ŒWasm è½»é‡çº§å®¹å™¨ä¹Ÿéå¸¸é€‚åˆä½œä¸ºä¸‹ä¸€ä»£æ— æœåŠ¡å™¨å¹³å°è¿è¡Œæ—¶ã€‚å¦ä¸€ä¸ªä»¤äººå…´å¥‹çš„è¶‹åŠ¿æ˜¯ eBPF çš„å…´èµ·ï¼Œå®ƒä½¿äº‘åŸç”Ÿå¼€å‘äººå‘˜èƒ½å¤Ÿæ„å»ºå®‰å…¨çš„ç½‘ç»œã€æœåŠ¡ç½‘æ ¼å’Œå¤šç§å¯è§‚æµ‹æ€§ç»„ä»¶ï¼Œå¹¶ä¸”å®ƒä¹Ÿåœ¨é€æ­¥æ¸—é€å’Œæ·±å…¥åˆ°å†…æ ¸çš„å„ä¸ªç»„ä»¶ï¼Œæä¾›æ›´å¼ºå¤§çš„å†…æ ¸æ€å¯ç¼–ç¨‹äº¤äº’èƒ½åŠ›ã€‚</p>
<p>Wasm-bpf æ˜¯ä¸€ä¸ªå…¨æ–°çš„å¼€æºé¡¹ç›®[1]ï¼Œå®ƒå®šä¹‰äº†ä¸€å¥— eBPF ç›¸å…³ç³»ç»Ÿæ¥å£çš„æŠ½è±¡ï¼Œå¹¶æä¾›äº†ä¸€å¥—å¯¹åº”çš„å¼€å‘å·¥å…·é“¾ã€åº“ä»¥åŠé€šç”¨çš„ Wasm + eBPF è¿è¡Œæ—¶å¹³å°å®ä¾‹ï¼Œè®©ä»»æ„ Wasm è™šæ‹Ÿæœºæˆ–è€… Wasm è½»é‡çº§å®¹å™¨ä¸­çš„åº”ç”¨ï¼Œæœ‰èƒ½åŠ›å°†ä½¿ç”¨åœºæ™¯ä¸‹æ²‰å’Œæ‹“å±•åˆ°å†…æ ¸æ€ï¼Œè·å–å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„å‡ ä¹æ‰€æœ‰æ•°æ®ï¼Œåœ¨ç½‘ç»œã€å®‰å…¨ç­‰å¤šä¸ªæ–¹é¢å®ç°å¯¹æ•´ä¸ªæ“ä½œç³»ç»Ÿå±‚é¢çš„å¯ç¼–ç¨‹æ§åˆ¶ï¼Œä»è€Œæå¤§çš„æ‹“å±• WebAssembly ç”Ÿæ€åœ¨éæµè§ˆå™¨ç«¯çš„åº”ç”¨åœºæ™¯ã€‚</p>
<h2 id="åŸºäº-ebpf-çš„ç³»ç»Ÿæ¥å£ä¸ºäº‘åŸç”Ÿ-webassembly-å¸¦æ¥æ›´å¤šå¯èƒ½"><a class="header" href="#åŸºäº-ebpf-çš„ç³»ç»Ÿæ¥å£ä¸ºäº‘åŸç”Ÿ-webassembly-å¸¦æ¥æ›´å¤šå¯èƒ½">åŸºäº eBPF çš„ç³»ç»Ÿæ¥å£ï¼Œä¸ºäº‘åŸç”Ÿ WebAssembly å¸¦æ¥æ›´å¤šå¯èƒ½</a></h2>
<h3 id="wasm--wasi"><a class="header" href="#wasm--wasi">Wasm &amp; WASI</a></h3>
<p>ä¹Ÿè®¸ä½ ä¹Ÿå·²ç»çœ‹è¿‡ Solomon Hykes (Dockerçš„åˆ›å§‹äººä¹‹ä¸€)è¿™å¥è¯ï¼š</p>
<blockquote>
<p>å¦‚æœåœ¨2008å¹´å·²ç»æœ‰äº† Wasm + WASIï¼Œæˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦åˆ›å»º Dockerã€‚ Wasm å°±æœ‰è¿™ä¹ˆé‡è¦ã€‚ æœåŠ¡ç«¯çš„ WebAssembly æ˜¯è®¡ç®—çš„æœªæ¥ã€‚</p>
</blockquote>
<p>2022 å¹´ï¼ŒWebAssemblyï¼ˆé€šå¸¸ç¼©å†™ä¸º Wasmï¼‰æˆä¸ºäº†ç„¦ç‚¹ï¼šæ–°çš„ Wasm åˆåˆ›ä¼ä¸šå‡ºç°ï¼Œè€ç‰Œå…¬å¸å®£å¸ƒæ”¯æŒ Wasmï¼ŒBytecode Alliance å‘å¸ƒäº†è®¸å¤š Wasm æ ‡å‡†ï¼ŒCloud Native Computing Foundation ä¸¾åŠäº†ä¸¤æ¬¡ WasmDay æ´»åŠ¨ï¼Œè€Œå…¶ä¸­æœ€å¤§çš„ Wasm ç”¨æˆ·ä¹‹ä¸€ Figma è¢« Adobe ä»¥æƒŠäººçš„ 200 äº¿ç¾å…ƒçš„ä»·æ ¼æ”¶è´­[2]ã€‚</p>
<p>Wasm æ˜¯ä¸€ç§äºŒè¿›åˆ¶æ ¼å¼ã€‚è®¸å¤šä¸åŒçš„è¯­è¨€éƒ½å¯ä»¥ç¼–è¯‘ä¸ºç›¸åŒçš„æ ¼å¼ï¼Œå¹¶ä¸”è¯¥äºŒè¿›åˆ¶æ ¼å¼å¯ä»¥åœ¨å¤§é‡æ“ä½œç³»ç»Ÿå’Œä½“ç³»ç»“æ„ä¸Šè¿è¡Œã€‚Java å’Œ .NET åœ¨è¿™æ–¹é¢ä¹Ÿå¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯ Wasm æœ‰ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼šWasm è¿è¡Œæ—¶ä¸ä¿¡ä»»æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚Wasm åº”ç”¨ç¨‹åºè¢«éš”ç¦»åœ¨æ²™ç›’ä¸­ï¼Œåªèƒ½è®¿é—®ç”¨æˆ·æ˜ç¡®å…è®¸çš„èµ„æºï¼ˆå¦‚æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡ï¼‰ã€‚Wasm è¿˜æœ‰è®¸å¤šå…¶ä»–ç†æƒ³çš„ç‰¹æ€§ï¼ˆä¾‹å¦‚éå¸¸å‡ºè‰²çš„æ€§èƒ½ï¼‰ï¼Œä½†æ­£æ˜¯å®ƒçš„å®‰å…¨æ¨¡å‹ä½¿ Wasm åœ¨å¹¿æ³›çš„ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œä»æµè§ˆå™¨åˆ°è¾¹ç¼˜å’Œ IoTï¼Œç”šè‡³åˆ°äº‘ç«¯[3]ã€‚</p>
<p>å› ä¸ºæ— æ³•ä¾èµ–æµè§ˆå™¨ä¸­ç°æœ‰å¯ç”¨çš„ JavaScript å¼•æ“æ¥å£ï¼Œæ‰€ä»¥ç›®å‰å¤§å¤šæ•°åœ¨æµè§ˆå™¨å¤–è¿è¡Œçš„ Wasm è½»é‡çº§å®¹å™¨éœ€è¦ä½¿ç”¨ WASIï¼ˆWebAssembly ç³»ç»Ÿæ¥å£ï¼‰ã€‚è¿™äº›è¿è¡Œæ—¶å…è®¸ Wasm åº”ç”¨ç¨‹åºä»¥ä¸ POSIX ç±»ä¼¼ï¼ˆä½†ä¸å®Œå…¨ç›¸åŒï¼‰çš„æ–¹å¼ä¸å…¶ host æ“ä½œç³»ç»Ÿäº¤äº’ã€‚</p>
<p>ä½†æ˜¯ï¼Œç›¸å¯¹äºä¼ ç»Ÿçš„å®¹å™¨ä¸­å¯ä»¥ä½¿ç”¨å‡ ä¹æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç›®å‰ WASI æ‰€èƒ½æä¾›çš„ç³»ç»Ÿèµ„æºéå¸¸æœ‰é™ï¼Œç›®å‰ä»…ä»…åœ¨æ–‡ä»¶ç³»ç»Ÿã€socket ç½‘ç»œè¿æ¥ç­‰æ–¹é¢æä¾›äº†ä¸€äº›åŸºæœ¬çš„æ”¯æŒï¼Œå¯¹äºæ“ä½œç³»ç»Ÿåº•å±‚èµ„æºçš„è®¿é—®ã€æ§åˆ¶å’Œç®¡ç†èƒ½åŠ›ä»ç„¶å­˜åœ¨å¤§é‡ç©ºç™½ï¼Œä¾‹å¦‚å¯¹ Wasm æ¨¡å—æˆ–è€…å¤–éƒ¨å…¶ä»–è¿›ç¨‹çš„æ‰§è¡Œèµ„æºé™åˆ¶ä¸è¡Œä¸ºè§‚æµ‹ï¼Œå¯¹ç½‘ç»œåŒ…çš„å¿«é€Ÿè½¬å‘å’Œå¤„ç†ï¼Œç”šè‡³å’Œ wasm æ²™ç®±å¤–çš„å…¶ä»–è¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œè®¿é—®å¤–è®¾ç­‰ï¼Œéƒ½æ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä¹Ÿä½¿å¾—å¤§å¤šæ•°çš„ Wasm è½»é‡çº§å®¹å™¨åœ¨å®é™…åº”ç”¨ä¸­è¿˜æ˜¯ä¸»è¦é›†ä¸­äºçº¯ç²¹çš„è®¡ç®—å¯†é›†å‹åº”ç”¨ï¼Œè€Œåœ¨ç½‘ç»œã€å®‰å…¨ç­‰æ–¹é¢ï¼Œè¿˜æ˜¯éœ€è¦ä¾èµ–äºä¼ ç»Ÿçš„å®¹å™¨æŠ€æœ¯ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¸Œæœ›å»ºç«‹ Wasm-bpf é¡¹ç›®çš„åˆè¡·ï¼šå€ŸåŠ©å½“å‰å†…æ ¸æ€ eBPF æä¾›çš„ç³»ç»Ÿæ¥å£ä»¥åŠå’Œç”¨æˆ·æ€äº¤äº’çš„èƒ½åŠ›ï¼Œæ‹“å±•æ•´ä¸ª WASI çš„ç”Ÿæ€è“å›¾ï¼Œä¸º Wasm åº”ç”¨å¸¦æ¥æ›´å¤šå¯èƒ½çš„ä½¿ç”¨åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿèƒ½åœ¨ç”¨æˆ·æ€å¢å¼º eBPF ç¨‹åºçš„èƒ½åŠ›ã€‚</p>
<p>æˆ–è€…æ¢å¥è¯è¯´ï¼Œç±»ä¼¼äºæµè§ˆå™¨ä¸­è¿è¡Œçš„ Wasm ç¨‹åºï¼Œå¯ä»¥é€šè¿‡ JavaScript å¼•æ“æ¥å£è®¿é—®æµè§ˆå™¨æä¾›çš„å„ç§ç³»ç»Ÿèµ„æºï¼ŒWasm-bpf çš„æ–¹æ¡ˆå°±æ˜¯å€ŸåŠ© eBPF è™šæ‹Ÿæœºæ¥å£è®¿é—®æ“ä½œç³»ç»Ÿçš„å„ç±»èµ„æºï¼›å¾—ç›Šäº eBPF ç›®å‰åœ¨ Linux å†…æ ¸ç”šè‡³ Windows ç­‰å…¶ä»–æ“ä½œç³»ç»Ÿä¸­çš„å¹¿æ³›æ”¯æŒï¼Œä»¥åŠä¸åŒå†…æ ¸ç‰ˆæœ¬å’Œæ¶æ„ä¹‹é—´çš„å¯ç§»æ¤æ€§ï¼Œå’Œå†…æ ¸ BPF éªŒè¯å¼•æ“çš„å¯é æ€§ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¿è¯åº”ç”¨çš„å¯ç§»æ¤æ€§å’Œå®‰å…¨è¾¹ç•Œã€‚</p>
<h3 id="wasm-bpfè¶…è½»é‡çº§-wasm--ebpf-é€šç”¨è¿è¡Œæ—¶å¹³å°"><a class="header" href="#wasm-bpfè¶…è½»é‡çº§-wasm--ebpf-é€šç”¨è¿è¡Œæ—¶å¹³å°">Wasm-bpfï¼šè¶…è½»é‡çº§ Wasm + eBPF é€šç”¨è¿è¡Œæ—¶å¹³å°</a></h3>
<p>Wasm-bpf é¡¹ç›®å·²ç»å®ç°äº†å†…æ ¸æ€ eBPF è™šæ‹Ÿæœºå’Œç”¨æˆ·æ€ä¹‹é—´ç³»ç»Ÿæ¥å£å®Œæ•´çš„æŠ½è±¡æœºåˆ¶ï¼Œå¹¶æä¾›äº†å¯¹åº”çš„å·¥å…·é“¾ä»¥å°† eBPF åº”ç”¨ç¼–è¯‘ä¸º Wasm æ¨¡å—ï¼Œå¸®åŠ©è¿›è¡Œå†…æ ¸æ€ eBPF å’Œç”¨æˆ·æ€ Wasm ä¹‹é—´æ— åºåˆ—åŒ–ï¼Œå…±äº«å†…å­˜çš„é«˜æ•ˆåŒå‘é€šä¿¡ï¼Œå¹¶é€šè¿‡ä»£ç ç”ŸæˆæŠ€æœ¯ï¼Œæä¾›å’Œå…¶ä»–ç”¨æˆ·æ€ eBPF å¼€å‘æ¡†æ¶å‡ ä¹ä¸€è‡´çš„ã€ç®€å•ä¾¿æ·çš„å¼€å‘ä½“éªŒã€‚å€ŸåŠ© Wasm ç»„ä»¶æ¨¡å‹ä¸æ–­å®Œå–„çš„ç”Ÿæ€æ”¯æŒï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸º eBPF ç¤¾åŒºå¸¦æ¥æ›´å¤šç”¨æˆ·æ€å¼€å‘è¯­è¨€ï¼Œä¸åŒè¯­è¨€å®ç°çš„å¯è§‚æµ‹æ€§ã€ç½‘ç»œç­‰ eBPF åº”ç”¨å’Œæ•°æ®å¤„ç†æ’ä»¶ä¹Ÿå¯ä»¥è¢«è½»æ¾é›†æˆã€å¤ç”¨ã€ç»Ÿä¸€ç®¡ç†ã€‚</p>
<p>åœ¨å‡ ä¹å·²ç»æˆä¸º eBPF ç”¨æˆ·æ€äº‹å®ä¸Šçš„ API æ ‡å‡†çš„ libbpf åº“ï¼Œå’Œ WAMR(wasm-micro-runtime) ä¹‹ä¸Šï¼Œåªéœ€è¦ 300+ è¡Œä»£ç å³å¯æ„å»ºå®Œæ•´çš„é€šç”¨ Wasm-eBPF è¿è¡Œç»„ä»¶ï¼Œå¹¶æ”¯æŒå¤§å¤šæ•°çš„ eBPF ä½¿ç”¨åœºæ™¯ -- ä»»ä½•äººç”¨ä»»ä½•ä¸»æµ Wasm è¿è¡Œæ—¶ï¼Œæˆ–è€…ä»»ä½• eBPF ç”¨æˆ·æ€åº“ï¼Œä»¥åŠä»»ä½•ç¼–ç¨‹è¯­è¨€ï¼Œéƒ½å¯ä»¥è½»æ¾æ·»åŠ å¯¹åº”çš„è™šæ‹Ÿæœºæ”¯æŒï¼Œå¹¶å¤ç”¨æˆ‘ä»¬çš„å·¥å…·é“¾è½»æ¾å®ç° Wasm-eBPF ç¨‹åºçš„ç¼–å†™å’Œå¼€å‘ã€‚</p>
<p>ä¹‹å‰åœ¨ eunomia-bpf é¡¹ç›®ä¸­ï¼Œå·²ç»æœ‰ä¸€äº›å°† eBPF å’Œ Wasm ç»“åˆçš„æ¢ç´¢[4]ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä¸ºäº† Wasm åŸç”Ÿåº”ç”¨å’Œè½»é‡çº§å®¹å™¨çš„åœºæ™¯è®¾è®¡çš„ï¼Œä¸ç¬¦åˆ Wasm-eBPF çš„é€šç”¨ç¼–ç¨‹æ¨¡å‹ï¼Œåªæ˜¯å°† Wasm ä½œä¸ºæ•°æ®å¤„ç†æ’ä»¶ï¼Œæ€§èƒ½ä¹Ÿè¾ƒä¸ºä½ä¸‹ã€‚å› æ­¤æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¼€æºä»“åº“ï¼Œè®© Wasm-bpf é¡¹ç›®ä¸“æ³¨äºåˆ©ç”¨ eBPF å¢å¼ºå’Œæ‰©å±• WebAssembly ä½¿ç”¨åœºæ™¯ï¼Œå¹¶è¿›ä¸€æ­¥å®Œå–„å¯¹åº”çš„å·¥å…·é“¾å’Œå¼€å‘åº“æ”¯æŒï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a> ã€‚åè¿‡æ¥ï¼Œä¸€ä¸ªé€šç”¨çš„ Wasm-eBPF å¼€å‘æ¡†æ¶ï¼Œå€ŸåŠ© Wasm ç›¸å…³çš„ç”Ÿæ€ä¹Ÿå¯ä»¥ä¸º eBPF ç›¸å…³ç¤¾åŒºåœ¨ç”¨æˆ·æ€çš„è¿›ä¸€æ­¥æ·±å…¥æ‹“å±•ï¼Œæä¾›æ›´å¤šçš„å¯èƒ½æ€§ã€‚</p>
<h2 id="ebpfå®‰å…¨å’Œæœ‰æ•ˆåœ°æ‰©å±•å†…æ ¸"><a class="header" href="#ebpfå®‰å…¨å’Œæœ‰æ•ˆåœ°æ‰©å±•å†…æ ¸">eBPFï¼šå®‰å…¨å’Œæœ‰æ•ˆåœ°æ‰©å±•å†…æ ¸</a></h2>
<p>eBPF æ˜¯ä¸€é¡¹é©å‘½æ€§çš„æŠ€æœ¯ï¼Œèµ·æºäº Linux å†…æ ¸ï¼Œå¯ä»¥åœ¨æ“ä½œç³»ç»Ÿçš„å†…æ ¸ä¸­è¿è¡Œæ²™ç›’ç¨‹åºã€‚å®ƒè¢«ç”¨æ¥å®‰å…¨å’Œæœ‰æ•ˆåœ°æ‰©å±•å†…æ ¸çš„åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦æ”¹å˜å†…æ ¸çš„æºä»£ç æˆ–åŠ è½½å†…æ ¸æ¨¡å—ã€‚eBPF é€šè¿‡å…è®¸åœ¨æ“ä½œç³»ç»Ÿå†…è¿è¡Œæ²™ç›’ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¯ä»¥åœ¨è¿è¡Œæ—¶ï¼Œå¯ç¼–ç¨‹åœ°å‘æ“ä½œç³»ç»ŸåŠ¨æ€æ·»åŠ é¢å¤–çš„åŠŸèƒ½ã€‚ç„¶åï¼Œæ“ä½œç³»ç»Ÿä¿è¯å®‰å…¨å’Œæ‰§è¡Œæ•ˆç‡ï¼Œå°±åƒåœ¨å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰ç¼–è¯‘å™¨å’ŒéªŒè¯å¼•æ“çš„å¸®åŠ©ä¸‹è¿›è¡Œæœ¬åœ°ç¼–è¯‘ä¸€æ ·ã€‚eBPF ç¨‹åºåœ¨å†…æ ¸ç‰ˆæœ¬ä¹‹é—´æ˜¯å¯ç§»æ¤çš„ï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨æ›´æ–°ï¼Œä»è€Œé¿å…äº†å·¥ä½œè´Ÿè½½ä¸­æ–­å’ŒèŠ‚ç‚¹é‡å¯ã€‚</p>
<p>ä»Šå¤©ï¼ŒeBPFè¢«å¹¿æ³›ç”¨äºå„ç±»åœºæ™¯ï¼šåœ¨ç°ä»£æ•°æ®ä¸­å¿ƒå’Œäº‘åŸç”Ÿç¯å¢ƒä¸­ï¼Œå¯ä»¥æä¾›é«˜æ€§èƒ½çš„ç½‘ç»œåŒ…å¤„ç†å’Œè´Ÿè½½å‡è¡¡ï¼›ä»¥éå¸¸ä½çš„èµ„æºå¼€é”€ï¼Œåšåˆ°å¯¹å¤šç§ç»†ç²’åº¦æŒ‡æ ‡çš„å¯è§‚æµ‹æ€§ï¼Œå¸®åŠ©åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜è·Ÿè¸ªåº”ç”¨ç¨‹åºï¼Œä¸ºæ€§èƒ½æ•…éšœæ’é™¤æä¾›æ´å¯ŸåŠ›ï¼›ä¿éšœåº”ç”¨ç¨‹åºå’Œå®¹å™¨è¿è¡Œæ—¶çš„å®‰å…¨æ‰§è¡Œï¼Œç­‰ç­‰ã€‚å¯èƒ½æ€§æ˜¯æ— ç©·çš„ï¼Œè€Œ eBPF åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­æ‰€é‡Šæ”¾çš„åˆ›æ–°æ‰åˆšåˆšå¼€å§‹[3]ã€‚</p>
<h3 id="ebpf-çš„æœªæ¥å†…æ ¸çš„-javascript-å¯ç¼–ç¨‹æ¥å£"><a class="header" href="#ebpf-çš„æœªæ¥å†…æ ¸çš„-javascript-å¯ç¼–ç¨‹æ¥å£">eBPF çš„æœªæ¥ï¼šå†…æ ¸çš„ JavaScript å¯ç¼–ç¨‹æ¥å£</a></h3>
<p>å¯¹äºæµè§ˆå™¨è€Œè¨€ï¼ŒJavaScript çš„å¼•å…¥å¸¦æ¥çš„å¯ç¼–ç¨‹æ€§å¼€å¯äº†ä¸€åœºå·¨å¤§çš„é©å‘½ï¼Œä½¿æµè§ˆå™¨å‘å±•æˆä¸ºå‡ ä¹ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿã€‚ç°åœ¨è®©æˆ‘ä»¬å›åˆ° eBPFï¼šä¸ºäº†ç†è§£ eBPF å¯¹ Linux å†…æ ¸çš„å¯ç¼–ç¨‹æ€§å½±å“ï¼Œå¯¹ Linux å†…æ ¸çš„ç»“æ„ä»¥åŠå®ƒå¦‚ä½•ä¸åº”ç”¨ç¨‹åºå’Œç¡¬ä»¶è¿›è¡Œäº¤äº’æœ‰ä¸€ä¸ªé«˜å±‚æ¬¡çš„ç†è§£æ˜¯æœ‰å¸®åŠ©çš„[4]ã€‚</p>
<div align="center">
<img src=https://ebpf.io/static/kernel_arch-c0be6286222dcd0e6e45250d2d9a87fd.png width=60% />
</div>
<p>Linux å†…æ ¸çš„ä¸»è¦ç›®çš„æ˜¯æŠ½è±¡å‡ºç¡¬ä»¶æˆ–è™šæ‹Ÿç¡¬ä»¶ï¼Œå¹¶æä¾›ä¸€ä¸ªä¸€è‡´çš„APIï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œå…è®¸åº”ç”¨ç¨‹åºè¿è¡Œå’Œå…±äº«èµ„æºã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬ç»´æŠ¤äº†ä¸€ç³»åˆ—å­ç³»ç»Ÿå’Œå±‚ï¼Œä»¥åˆ†é…è¿™äº›è´£ä»»[5]ã€‚æ¯ä¸ªå­ç³»ç»Ÿé€šå¸¸å…è®¸æŸç§ç¨‹åº¦çš„é…ç½®ï¼Œä»¥è€ƒè™‘åˆ°ç”¨æˆ·çš„ä¸åŒéœ€æ±‚ã€‚å¦‚æœä¸èƒ½é…ç½®æ‰€éœ€çš„è¡Œä¸ºï¼Œå°±éœ€è¦æ”¹å˜å†…æ ¸ï¼Œä»å†å²ä¸Šçœ‹ï¼Œæ”¹å˜å†…æ ¸çš„è¡Œä¸ºï¼Œæˆ–è€…è®©ç”¨æˆ·ç¼–å†™çš„ç¨‹åºèƒ½å¤Ÿåœ¨å†…æ ¸ä¸­è¿è¡Œï¼Œå°±æœ‰ä¸¤ç§é€‰æ‹©:</p>
<div class="table-wrapper"><table><thead><tr><th>æœ¬åœ°æ”¯æŒå†…æ ¸æ¨¡å—</th><th>å†™ä¸€ä¸ªå†…æ ¸æ¨¡å—</th></tr></thead><tbody>
<tr><td>æ”¹å˜å†…æ ¸æºä»£ç ï¼Œå¹¶è¯´æœLinuxå†…æ ¸ç¤¾åŒºç›¸ä¿¡è¿™ç§æ”¹å˜æ˜¯å¿…è¦çš„ã€‚ç­‰å¾…å‡ å¹´ï¼Œè®©æ–°çš„å†…æ ¸ç‰ˆæœ¬æˆä¸ºä¸€ç§å•†å“ã€‚</td><td>å®šæœŸä¿®å¤å®ƒï¼Œå› ä¸ºæ¯ä¸ªå†…æ ¸ç‰ˆæœ¬éƒ½å¯èƒ½ç ´åå®ƒã€‚ç”±äºç¼ºä¹å®‰å…¨è¾¹ç•Œï¼Œå†’ç€ç ´åä½ çš„Linuxå†…æ ¸çš„é£é™©</td></tr>
</tbody></table>
</div>
<p>å®é™…ä¸Šï¼Œä¸¤ç§æ–¹æ¡ˆéƒ½ä¸å¸¸ç”¨ï¼Œå‰è€…æˆæœ¬å¤ªé«˜ï¼Œåè€…åˆ™å‡ ä¹æ²¡æœ‰å¯ç§»æ¤æ€§ã€‚</p>
<p>æœ‰äº† eBPFï¼Œå°±æœ‰äº†ä¸€ä¸ªæ–°çš„é€‰æ‹©ï¼Œå¯ä»¥é‡æ–°ç¼–ç¨‹ Linux å†…æ ¸çš„è¡Œä¸ºï¼Œè€Œä¸éœ€è¦æ”¹å˜å†…æ ¸çš„æºä»£ç æˆ–åŠ è½½å†…æ ¸æ¨¡å—ï¼ŒåŒæ—¶ä¿è¯åœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¹‹é—´ä¸€å®šç¨‹åº¦ä¸Šçš„è¡Œä¸ºä¸€è‡´æ€§å’Œå…¼å®¹æ€§ã€ä»¥åŠå®‰å…¨æ€§[6]ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼ŒeBPF ç¨‹åºä¹Ÿéœ€è¦æœ‰ä¸€å¥—å¯¹åº”çš„ APIï¼Œå…è®¸ç”¨æˆ·å®šä¹‰çš„åº”ç”¨ç¨‹åºè¿è¡Œå’Œå…±äº«èµ„æº --- æ¢å¥è¯è¯´ï¼ŒæŸç§æ„ä¹‰ä¸Šè®² eBPF è™šæ‹Ÿæœºä¹Ÿæä¾›äº†ä¸€å¥—ç±»ä¼¼äºç³»ç»Ÿè°ƒç”¨çš„æœºåˆ¶ï¼Œå€ŸåŠ© eBPF å’Œç”¨æˆ·æ€é€šä¿¡çš„æœºåˆ¶ï¼ŒWasm è™šæ‹Ÿæœºå’Œç”¨æˆ·æ€åº”ç”¨ä¹Ÿå¯ä»¥è·å¾—è¿™å¥—â€œç³»ç»Ÿè°ƒç”¨â€çš„å®Œæ•´ä½¿ç”¨æƒï¼Œä¸€æ–¹é¢èƒ½å¯ç¼–ç¨‹åœ°æ‰©å±•ä¼ ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨çš„èƒ½åŠ›ï¼Œå¦ä¸€æ–¹é¢èƒ½åœ¨ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰è®¸å¤šå±‚æ¬¡å®ç°æ›´é«˜æ•ˆçš„å¯ç¼–ç¨‹ IO å¤„ç†ã€‚</p>
<p><img src="blog/new-os-model.jpg" alt="new-os" /></p>
<p>æ­£å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“ä»Šçš„ Linux å†…æ ¸æ­£åœ¨å‘ä¸€ä¸ªæ–°çš„å†…æ ¸æ¨¡å‹æ¼”åŒ–ï¼šç”¨æˆ·å®šä¹‰çš„åº”ç”¨ç¨‹åºå¯ä»¥åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€åŒæ—¶æ‰§è¡Œï¼Œç”¨æˆ·æ€é€šè¿‡ä¼ ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨è®¿é—®ç³»ç»Ÿèµ„æºï¼Œå†…æ ¸æ€åˆ™é€šè¿‡ BPF Helper Calls å’Œç³»ç»Ÿçš„å„ä¸ªéƒ¨åˆ†å®Œæˆäº¤äº’ã€‚æˆªæ­¢ 2023 å¹´åˆï¼Œå†…æ ¸ä¸­çš„ eBPF è™šæ‹Ÿæœºä¸­å·²ç»æœ‰ 220 å¤šä¸ªHelper ç³»ç»Ÿæ¥å£ï¼Œæ¶µç›–äº†éå¸¸å¤šçš„åº”ç”¨åœºæ™¯ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒBPF Helper Call å’Œç³»ç»Ÿè°ƒç”¨äºŒè€…å¹¶ä¸æ˜¯ç«äº‰å…³ç³»ï¼Œå®ƒä»¬çš„ç¼–ç¨‹æ¨¡å‹å’Œæœ‰æ€§èƒ½ä¼˜åŠ¿çš„åœºæ™¯å®Œå…¨ä¸åŒï¼Œä¹Ÿä¸ä¼šå®Œå…¨æ›¿ä»£å¯¹æ–¹ã€‚å¯¹ Wasm å’Œ Wasi ç›¸å…³ç”Ÿæ€æ¥è¯´ï¼Œæƒ…å†µä¹Ÿç±»ä¼¼ï¼Œä¸“é—¨è®¾è®¡çš„ wasi æ¥å£éœ€è¦ç»å†ä¸€ä¸ªæ¼«é•¿çš„æ ‡å‡†åŒ–è¿‡ç¨‹ï¼Œä½†å¯èƒ½åœ¨ç‰¹å®šåœºæ™¯èƒ½ä¸ºç”¨æˆ·æ€åº”ç”¨è·å–æ›´ä½³çš„æ€§èƒ½å’Œå¯ç§»æ¤æ€§ä¿è¯ï¼Œè€Œ eBPF åœ¨ä¿è¯æ²™ç®±æœ¬è´¨å’Œå¯ç§»æ¤æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªå¿«é€Ÿçµæ´»çš„æ‰©å±•ç³»ç»Ÿæ¥å£çš„æ–¹æ¡ˆã€‚</p>
<p>ç›®å‰çš„ eBPF ä»ç„¶å¤„äºæ—©æœŸé˜¶æ®µï¼Œä½†æ˜¯å€ŸåŠ©å½“å‰ eBPF æä¾›çš„å†…æ ¸æ¥å£å’Œç”¨æˆ·æ€äº¤äº’çš„èƒ½åŠ›ï¼Œç»ç”± Wasm-bpf çš„ç³»ç»Ÿæ¥å£è½¬æ¢ï¼ŒWasm è™šæ‹Ÿæœºä¸­çš„åº”ç”¨å·²ç»å‡ ä¹æœ‰èƒ½åŠ›è·å–å†…æ ¸ä»¥åŠç”¨æˆ·æ€ä»»æ„ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„æ•°æ®å’Œè¿”å›å€¼ï¼ˆkprobeï¼Œuprobe...ï¼‰ï¼›ä»¥å¾ˆä½çš„ä»£ä»·æ”¶é›†å’Œç†è§£æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶è·å–æ‰€æœ‰ç½‘ç»œæ“ä½œçš„æ•°æ®åŒ…å’Œå¥—æ¥å­—çº§åˆ«çš„æ•°æ®ï¼ˆtracepointï¼Œsocket...ï¼‰ï¼›åœ¨ç½‘ç»œåŒ…å¤„ç†è§£å†³æ–¹æ¡ˆä¸­æ·»åŠ é¢å¤–çš„åè®®åˆ†æå™¨ï¼Œå¹¶è½»æ¾åœ°ç¼–ç¨‹ä»»ä½•è½¬å‘é€»è¾‘ï¼ˆXDPï¼ŒTC...ï¼‰ï¼Œä»¥æ»¡è¶³ä¸æ–­å˜åŒ–çš„éœ€æ±‚ï¼Œè€Œæ— éœ€ç¦»å¼€Linuxå†…æ ¸çš„æ•°æ®åŒ…å¤„ç†ç¯å¢ƒã€‚</p>
<p>ä¸ä»…å¦‚æ­¤ï¼ŒeBPF è¿˜æœ‰èƒ½åŠ›å¾€ç”¨æˆ·ç©ºé—´ä»»æ„è¿›ç¨‹çš„ä»»æ„åœ°å€å†™å…¥æ•°æ®ï¼ˆbpf_probe_write_user[7]ï¼‰ï¼Œæœ‰é™åº¦åœ°ä¿®æ”¹å†…æ ¸å‡½æ•°çš„è¿”å›å€¼ï¼ˆbpf_override_return[8]ï¼‰ï¼Œç”šè‡³åœ¨å†…æ ¸æ€ç›´æ¥æ‰§è¡ŒæŸäº›ç³»ç»Ÿè°ƒç”¨[9]ï¼›æ‰€å¹¸çš„æ˜¯ï¼ŒeBPF åœ¨åŠ è½½è¿›å†…æ ¸ä¹‹å‰å¯¹å­—èŠ‚ç ä¼šè¿›è¡Œä¸¥æ ¼çš„å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿æ²¡æœ‰å†…å­˜è¶Šç•Œç­‰æ“ä½œï¼ŒåŒæ—¶ï¼Œè®¸å¤šå¯èƒ½ä¼šæ‰©å¤§æ”»å‡»é¢ã€å¸¦æ¥å®‰å…¨é£é™©çš„åŠŸèƒ½éƒ½æ˜¯éœ€è¦åœ¨ç¼–è¯‘å†…æ ¸æ—¶æ˜ç¡®é€‰æ‹©å¯ç”¨æ‰èƒ½ä½¿ç”¨çš„ï¼›åœ¨ Wasm è™šæ‹Ÿæœºå°†å­—èŠ‚ç åŠ è½½è¿›å†…æ ¸ä¹‹å‰ï¼Œä¹Ÿå¯ä»¥æ˜ç¡®é€‰æ‹©å¯ç”¨æˆ–è€…ç¦ç”¨æŸäº› eBPF åŠŸèƒ½ï¼Œä»¥ç¡®ä¿æ²™ç®±çš„å®‰å…¨æ€§ã€‚</p>
<p>æ‰€æœ‰çš„è¿™äº›åœºæ™¯éƒ½ä¸éœ€è¦ç¦»å¼€ Wasm è½»é‡çº§å®¹å™¨ï¼šä¸åƒä¼ ç»Ÿçš„ä½¿ç”¨ Wasm ä½œä¸ºæ•°æ®å¤„ç†æˆ–è€…æ§åˆ¶æ’ä»¶çš„åº”ç”¨ä¸­ï¼Œè¿™äº›æ­¥éª¤ç”± Wasm è™šæ‹Ÿæœºå¤–çš„é€»è¾‘å®ç°ï¼Œç°åœ¨å¯ä»¥åœ¨ Wasm è½»é‡çº§å®¹å™¨ä¸­å®ç°å¯¹ eBPF ä»¥åŠ eBPF èƒ½è®¿é—®çš„å‡ ä¹æ‰€æœ‰ç³»ç»Ÿèµ„æºï¼Œå®Œæ•´çš„æ§åˆ¶å’Œäº¤äº’ï¼Œç”šè‡³å®æ—¶ç”Ÿæˆ eBPF ä»£ç æ”¹å˜å†…æ ¸çš„è¡Œä¸ºé€»è¾‘ï¼Œå®ç°æ•´ä¸ªç³»ç»Ÿä»ç”¨æˆ·æ€æ‰©å±•åˆ°å†…æ ¸æ€çš„å¯ç¼–ç¨‹æ€§ã€‚</p>
<h2 id="wasm-å¯¹-ebpf-çš„ç”¨æˆ·æ€å¢å¼ºç»„ä»¶æ¨¡å‹"><a class="header" href="#wasm-å¯¹-ebpf-çš„ç”¨æˆ·æ€å¢å¼ºç»„ä»¶æ¨¡å‹">Wasm å¯¹ eBPF çš„ç”¨æˆ·æ€å¢å¼ºï¼šç»„ä»¶æ¨¡å‹</a></h2>
<p>æ ‡å‡†å¾ˆå°‘æ˜¯ä¸€ä¸ªç”Ÿæ€ç³»ç»Ÿä¸­æœ€ä»¤äººå…´å¥‹çš„éƒ¨åˆ†ã€‚è€Œä¸”ï¼Œéšç€ â€œç»„ä»¶æ¨¡å‹â€ è¿™æ ·çš„åå­—ï¼Œæ¿€èµ·å…´å¥‹æ„Ÿç¡®å®æ˜¯ä¸€é¡¹è‰°å·¨çš„ä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œåœ¨è¿™ä¸ªä¹å‘³çš„åå­—èƒŒåæ˜¯ Wasm ä¸ºè½¯ä»¶ä¸–ç•Œå¸¦æ¥çš„æœ€é‡è¦çš„åˆ›æ–°ã€‚</p>
<p>ç»„ä»¶æ¨¡å‹æè¿°äº† Wasm äºŒè¿›åˆ¶æ–‡ä»¶ä¹‹é—´å¦‚ä½•äº¤äº’çš„æ–¹å¼ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œä¸¤ä¸ªç»„ä»¶å¯ä»¥å‘Šè¯‰å¯¹æ–¹å®ƒä»¬æä¾›çš„æœåŠ¡ä»¥åŠéœ€è¦å±¥è¡Œçš„æœŸæœ›ã€‚ç„¶åï¼ŒWasm æ¨¡å—å¯ä»¥åˆ©ç”¨å½¼æ­¤çš„èƒ½åŠ›ã€‚è¿™ä¸ºè½¯ä»¶å¼€å‘äººå‘˜æä¾›äº†ä¸€ç§æ–°çš„å»ºç«‹åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚å¼€å‘äººå‘˜å¯ä»¥å£°æ˜åº”ç”¨ç¨‹åºæ‰€éœ€çš„ç»„ä»¶ï¼ˆæˆ–è€…æ›´æŠ½è±¡åœ°è¯´ï¼Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„åŠŸèƒ½ï¼‰ï¼Œç„¶å Wasm è¿è¡Œæ—¶å¯ä»¥ä»£è¡¨ç”¨æˆ·ç»„è£…æ­£ç¡®çš„ç»„ä»¶é›†åˆã€‚ç»„ä»¶æ¨¡å‹æ­£åœ¨è¿…é€Ÿæˆç†Ÿï¼Œå·²ç»å‡ºç°äº†å‚è€ƒå®ç°ã€‚2023 å¹´å°†æ˜¯ç»„ä»¶æ¨¡å‹å¼€å§‹é‡æ–°å®šä¹‰æˆ‘ä»¬å¦‚ä½•ç¼–å†™è½¯ä»¶çš„ä¸€å¹´[10]ã€‚</p>
<p>å€ŸåŠ© Wasm çš„ç›¸å…³ç”Ÿæ€ï¼Œå°¤å…¶æ˜¯åŸºäº Wasm çš„è½»é‡çº§å®¹å™¨æŠ€æœ¯ã€ç»„ä»¶æ¨¡å‹ï¼Œæˆ‘ä»¬åŒæ ·ä¹Ÿå¯ä»¥ç»™ eBPF çš„åº”ç”¨èµ‹äºˆå¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li><code>å¯ç§»æ¤</code>ï¼šè®© eBPF å·¥å…·å’Œåº”ç”¨å®Œå…¨å¹³å°æ— å…³ã€å¯ç§»æ¤ï¼Œä¸éœ€è¦è¿›è¡Œé‡æ–°ç¼–è¯‘å³å¯ä»¥è·¨å¹³å°åˆ†å‘ï¼›</li>
<li><code>éš”ç¦»æ€§</code>ï¼šå€ŸåŠ© Wasm çš„å¯é æ€§å’Œéš”ç¦»æ€§ï¼Œè®© eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œã€ä»¥åŠç”¨æˆ·æ€çš„æ•°æ®å¤„ç†æµç¨‹æ›´åŠ å®‰å…¨å¯é ï¼›äº‹å®ä¸Šä¸€ä¸ª eBPF åº”ç”¨çš„ç”¨æˆ·æ€æ§åˆ¶ä»£ç ã€æ•°æ®å¤„ç†ä»£ç çš„éƒ¨åˆ†é€šå¸¸è¿œè¿œå¤šäºå†…æ ¸æ€ï¼›</li>
<li><code>åŒ…ç®¡ç†</code>ï¼šå€ŸåŠ© Wasm çš„ç”Ÿæ€å’Œå·¥å…·é“¾ï¼Œå®Œæˆ eBPF ç¨‹åºæˆ–å·¥å…·çš„åˆ†å‘ã€ç®¡ç†ã€åŠ è½½ç­‰å·¥ä½œï¼Œç›®å‰ eBPF ç¨‹åºæˆ–å·¥å…·ç”Ÿæ€ä¹Ÿç¼ºä¹ä¸€ä¸ªé€šç”¨çš„åŒ…ç®¡ç†æˆ–æ’ä»¶ç®¡ç†ç³»ç»Ÿï¼›</li>
<li><code>è·¨è¯­è¨€</code>ï¼šç›®å‰ eBPF ç¨‹åºç”±å¤šç§ç”¨æˆ·æ€è¯­è¨€å¼€å‘ï¼ˆå¦‚ Go\Rust\C\C++\Python ç­‰ï¼‰ï¼Œè¶…è¿‡ 30 ç§ç¼–ç¨‹è¯­è¨€å¯ä»¥è¢«ç¼–è¯‘æˆ WebAssembly æ¨¡å—ï¼Œå¯ä»¥å…è®¸å„ç§èƒŒæ™¯çš„å¼€å‘äººå‘˜ï¼ˆCã€Goã€Rustã€Javaã€TypeScript ç­‰ï¼‰ç”¨ä»–ä»¬é€‰æ‹©çš„è¯­è¨€ç¼–å†™ eBPF çš„ç”¨æˆ·æ€ç¨‹åºï¼Œè€Œä¸éœ€è¦å­¦ä¹ æ–°çš„è¯­è¨€ï¼Œç”šè‡³æˆ‘ä»¬å¯ä»¥å°† Wasm åŠ¨æ€ç¿»è¯‘ä¸º eBPF ç¨‹åºï¼ŒåŠ è½½è¿›å…¥å†…æ ¸ï¼Œæˆ–è€…åœ¨ Wasm è½»é‡çº§å®¹å™¨ä¸­ç›´æ¥ç”Ÿæˆ eBPF å­—èŠ‚ç ï¼›</li>
<li><code>æ•æ·æ€§</code>ï¼šå¯¹äºå¤§å‹çš„ eBPF åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨ Wasm ä½œä¸ºæ’ä»¶æ‰©å±•å¹³å°ï¼šæ‰©å±•ç¨‹åºå¯ä»¥åœ¨è¿è¡Œæ—¶ç›´æ¥ä»æ§åˆ¶å¹³é¢äº¤ä»˜å’Œé‡æ–°åŠ è½½ã€‚è¿™ä¸ä»…æ„å‘³ç€æ¯ä¸ªäººéƒ½å¯ä»¥ä½¿ç”¨å®˜æ–¹å’Œæœªç»ä¿®æ”¹çš„åº”ç”¨ç¨‹åºæ¥åŠ è½½è‡ªå®šä¹‰æ‰©å±•ï¼Œè€Œä¸”ä»»ä½• eBPF ç¨‹åºçš„é”™è¯¯ä¿®å¤å’Œ/æˆ–æ›´æ–°éƒ½å¯ä»¥åœ¨è¿è¡Œæ—¶æ¨é€å’Œ/æˆ–æµ‹è¯•ï¼Œè€Œä¸éœ€è¦æ›´æ–°å’Œ/æˆ–é‡æ–°éƒ¨ç½²ä¸€ä¸ªæ–°çš„äºŒè¿›åˆ¶ï¼›å¯¹äºå¯è§‚æµ‹æ€§åº”ç”¨æ¥è¯´ï¼Œéœ€è¦æ›´æ–°æ•°æ®å¤„ç†æ’ä»¶ï¼Œä¹Ÿæ— éœ€ç»å†é‡æ–°ç¼–è¯‘éƒ¨ç½²æ•´ä¸ªåº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ï¼›</li>
<li><code>è½»é‡çº§</code>ï¼šWebAssembly å¾®æœåŠ¡æ¶ˆè€— 1% çš„èµ„æºï¼Œä¸ Linux å®¹å™¨åº”ç”¨ç›¸æ¯”ï¼Œå†·å¯åŠ¨çš„æ—¶é—´æ˜¯ 1%ï¼›å¯¹äºå¤§é‡çš„å°å‹ eBPF ç¨‹åºéœ€è¦å¿«é€Ÿéƒ¨ç½²å’Œåœæ­¢çš„åœºæ™¯ï¼ŒWasm çš„è½»é‡çº§ç‰¹æ€§å¯ä»¥å¤§å¤§é™ä½ç³»ç»Ÿçš„èµ„æºå¼€é”€ã€‚</li>
</ul>
<p>æˆ‘ä»¬å·²ç»åœ¨ LMP é¡¹ç›®çš„ eBPF Hub ä¸­ï¼Œæœ‰ä¸€äº›åˆ›å»ºç¬¦åˆ OCI æ ‡å‡†çš„ Wasm-eBPF åº”ç”¨ç¨‹åºï¼Œå¹¶åˆ©ç”¨ ORAS ç®€åŒ–æ‰©å±• eBPF åº”ç”¨å¼€å‘ï¼Œåˆ†å‘ã€åŠ è½½ã€è¿è¡Œèƒ½åŠ›çš„å°è¯•[11]ï¼Œä»¥åŠåŸºäº Wasm åŒæ—¶ä½¿ç”¨å¤šç§ä¸åŒè¯­è¨€å¼€å‘ eBPF çš„ç”¨æˆ·æ€æ•°æ®å¤„ç†æ’ä»¶çš„å®è·µï¼ŒåŸºäºæœ€æ–°çš„ Wasm-bpf æ¡†æ¶ï¼Œæœ‰æ›´å¤šçš„æ¢ç´¢æ€§å·¥ä½œå¯ä»¥ç»§ç»­å±•å¼€ã€‚</p>
<h2 id="ç”¨æˆ·ç©ºé—´å’Œ-ebpf-ç¨‹åºçš„äº¤äº’æµç¨‹"><a class="header" href="#ç”¨æˆ·ç©ºé—´å’Œ-ebpf-ç¨‹åºçš„äº¤äº’æµç¨‹">ç”¨æˆ·ç©ºé—´å’Œ eBPF ç¨‹åºçš„äº¤äº’æµç¨‹</a></h2>
<p>eBPF ç¨‹åºæ˜¯ä»¥å‡½æ•°ä¸ºå•ä½çš„ã€äº‹ä»¶é©±åŠ¨çš„ï¼Œå½“å†…æ ¸æˆ–ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºé€šè¿‡æŸä¸ª hook ç‚¹æ—¶å°±ä¼šè¿è¡Œç‰¹å®šçš„ eBPF ç¨‹åºã€‚è¦ä½¿ç”¨ä¸€ä¸ª eBPF ç¨‹åºï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨ clang/LLVM å·¥å…·é“¾å°†å¯¹åº”çš„æºä»£ç ç¼–è¯‘ä¸º bpf å­—èŠ‚ç ï¼Œå…¶ä¸­åŒ…å«å¯¹åº”çš„æ•°æ®ç»“æ„å®šä¹‰ã€maps å’Œ progs å®šä¹‰ï¼Œprogs å³ç¨‹åºæ®µï¼Œmaps å¯ä»¥ç”¨æ¥å­˜å‚¨æ•°æ®æˆ–è€…å’Œç”¨æˆ·ç©ºé—´å®ç°åŒå‘é€šä¿¡ã€‚ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ç”¨æˆ·æ€çš„å¼€å‘æ¡†æ¶å’ŒåŠ è½½æ¡†æ¶ï¼Œå®ç°å®Œæ•´çš„ eBPF åº”ç”¨ã€‚</p>
<h3 id="é€šå¸¸çš„ç”¨æˆ·æ€-ebpf-å¼€å‘æ¡†æ¶"><a class="header" href="#é€šå¸¸çš„ç”¨æˆ·æ€-ebpf-å¼€å‘æ¡†æ¶">é€šå¸¸çš„ç”¨æˆ·æ€ eBPF å¼€å‘æ¡†æ¶</a></h3>
<p>å¯¹äºä¸€ä¸ªå®Œæ•´çš„ eBPF åº”ç”¨ï¼Œé€šå¸¸éœ€è¦åŒ…å«ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¸¤éƒ¨åˆ†ï¼š</p>
<ul>
<li>ç”¨æˆ·æ€ç¨‹åºéœ€è¦é€šè¿‡ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨è·Ÿå†…æ ¸è¿›è¡Œäº¤äº’ï¼ˆä¸»è¦æ˜¯ bpf ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œåˆ›å»ºå¯¹åº”çš„ map ä»¥åœ¨å†…æ ¸æ€ä¿å­˜æ•°æ®æˆ–å’Œç”¨æˆ·æ€é€šä¿¡ï¼Œæ ¹æ®é…ç½®åŠ¨æ€é€‰æ‹©åŠ è½½ä¸åŒçš„ç¨‹åºæ®µï¼ŒåŠ¨æ€ä¿®æ”¹å­—èŠ‚ç æˆ–é…ç½® eBPF ç¨‹åºçš„å‚æ•°ï¼Œå°†å¯¹åº”çš„å­—èŠ‚ç ä¿¡æ¯åŠ è½½è¿›å†…æ ¸ï¼Œé€šè¿‡éªŒè¯å™¨ç¡®ä¿å®‰å…¨æ€§ï¼Œå¹¶é€šè¿‡ maps å’Œå†…æ ¸ä¹‹é—´å®ç°åŒå‘é€šä¿¡ï¼Œé€šè¿‡ ring buffer / perf buffer ä¹‹ç±»çš„æœºåˆ¶ä»å†…æ ¸æ€å‘ç”¨æˆ·æ€ä¼ é€’æ•°æ®ï¼ˆæˆ–è€…åä¹‹ï¼‰ã€‚</li>
<li>å†…æ ¸æ€ä¸»è¦è´Ÿè´£å…·ä½“çš„è®¡ç®—é€»è¾‘ä¸æ•°æ®æ”¶é›†ã€‚</li>
</ul>
<div align="center">
<img src=https://ebpf.io/static/libbpf-ee03b2f4d79b197554fa00671e67129d.png width=60% />
</div>
<h3 id="åœ¨ç”¨æˆ·æ€-wasm-ebpf-ç³»ç»Ÿæ¥å£ä¹‹ä¸Šå®šä¹‰çš„å…¨æ–°-ebpf-å¼€å‘æ¡†æ¶"><a class="header" href="#åœ¨ç”¨æˆ·æ€-wasm-ebpf-ç³»ç»Ÿæ¥å£ä¹‹ä¸Šå®šä¹‰çš„å…¨æ–°-ebpf-å¼€å‘æ¡†æ¶">åœ¨ç”¨æˆ·æ€ Wasm-eBPF ç³»ç»Ÿæ¥å£ä¹‹ä¸Šå®šä¹‰çš„å…¨æ–° eBPF å¼€å‘æ¡†æ¶</a></h3>
<p>è¿™ä¸ªé¡¹ç›®æœ¬è´¨ä¸Šå¯ä»¥è¯´æ˜¯å¸Œæœ›æŠŠ Wasm æ²™ç®±å½“åšåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šå»ºç«‹çš„å¦ä¸€ä¸ªç”¨æˆ·æ€è¿è¡Œç©ºé—´ï¼Œè®© Wasm åº”ç”¨åœ¨æ²™ç®±ä¸­å®ç°å’Œé€šå¸¸ç”¨æˆ·æ€ä¸­è¿è¡Œçš„ eBPF åº”ç”¨ä¸€æ ·çš„ç¼–ç¨‹æ¨¡å‹å’Œæ‰§è¡Œé€»è¾‘ã€‚Wasm-bpf ä¼šéœ€è¦ä¸€ä¸ªåœ¨ hostï¼ˆæ²™ç®±å¤–éƒ¨ï¼‰æ„å»ºçš„è¿è¡Œæ—¶æ‰©å±•ï¼Œä»¥åŠä¸€äº›åœ¨æ²™ç®±å†…éƒ¨è¢«ç¼–è¯‘ä¸º Wasm å­—èŠ‚ç çš„è¿è¡Œæ—¶åº“æ¥æä¾›å®Œæ•´çš„æ”¯æŒã€‚</p>
<p><img src="blog/wasm-bpf-no-bcc.png" alt="wasm" /></p>
<p>è¦å®ç°å®Œå¤‡çš„å¼€å‘æ¨¡å‹ï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p>
<ul>
<li>ä¸€ä¸ª Wasm æ¨¡å—å¯ä»¥å¯¹åº”å¤šä¸ª eBPF ç¨‹åºï¼›</li>
<li>ä¸€ä¸ª eBPF ç¨‹åºå®ä¾‹ä¹Ÿå¯ä»¥è¢«å¤šä¸ª Wasm æ¨¡å—æ‰€å…±ç”¨ï¼›</li>
<li>å¯ä»¥å°† eBPF ç¨‹åºä» Wasm æ²™ç®±ä¸­åŠ¨æ€åŠ è½½è¿›å†…æ ¸ã€é€‰æ‹©æ‰€éœ€çš„æŒ‚è½½ç‚¹æŒ‚è½½ã€å¸è½½ï¼Œæ§åˆ¶å¤šä¸ª eBPF å­—èŠ‚ç å¯¹è±¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶æ”¯æŒå¤§å¤šæ•°çš„ eBPF ç¨‹åºç±»å‹ï¼›</li>
<li>å¯ä»¥é€šè¿‡å¤šç§ç±»å‹çš„ Maps å’Œå†…æ ¸åŒå‘é€šä¿¡ï¼Œæ”¯æŒå¤§å¤šæ•°çš„ Maps ç±»å‹ï¼›</li>
<li>é€šè¿‡ ring buffer å’Œ perf event polling ä»å†…æ ¸æ€å‘ç”¨æˆ·æ€é«˜æ•ˆå‘é€ä¿¡æ¯ï¼ˆå¯¹äº ring buffer æ¥è¯´ï¼Œä¹Ÿå¯ä»¥åä¹‹ï¼‰ï¼›</li>
<li>å‡ ä¹å¯ä»¥é€‚é…äºæ‰€æœ‰çš„ä½¿ç”¨ eBPF ç¨‹åºçš„åº”ç”¨åœºæ™¯ï¼Œå¹¶å¯ä»¥éšç€å†…æ ¸åŠŸèƒ½çš„æ·»åŠ ä¸æ–­æ¼”åŒ–å’Œæ‰©å±•ï¼ŒåŒæ—¶ä¸éœ€è¦å˜åŠ¨ Wasm è™šæ‹Ÿæœºçš„ç³»ç»Ÿæ¥å£ã€‚</li>
</ul>
<p>è¿™å°±æ˜¯ç›®å‰ Wasm-bpf é¡¹ç›®æ‰€åšçš„å·¥ä½œã€‚æˆ‘ä»¬ä¹Ÿæå‡ºäº†ä¸€ä¸ªæ–°çš„ WASI çš„ Proposal: WASI-eBPF[12].</p>
<p>åœ¨ Wasm-bpf é¡¹ç›®ä¸­ï¼Œæ‰€æœ‰ Wasm å’Œ eBPF è™šæ‹Ÿæœºä¹‹é—´çš„é€šä¿¡éƒ½æ— éœ€ç»è¿‡åºåˆ—åŒ–ã€ååºåˆ—åŒ–æœºåˆ¶ï¼Œé€šè¿‡å·¥å…·é“¾ä¸­ä»£ç ç”ŸæˆæŠ€æœ¯å’Œ BTFï¼ˆBPF ç±»å‹æ ¼å¼[13]ï¼‰ä¿¡æ¯çš„æ”¯æŒï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åœ¨ eBPF å’Œ Wasm ä¹‹é—´å¯èƒ½ä¸åŒçš„ç»“æ„ä½“å†…å­˜å¸ƒå±€ã€ä¸åŒçš„å¤§å°ç«¯æœºåˆ¶ã€ä¸åŒçš„æŒ‡é’ˆå®½åº¦ä¹‹é—´çš„æ­£ç¡®é€šä¿¡ï¼Œåœ¨è¿è¡Œæ—¶å‡ ä¹ä¸ä¼šå¼•å…¥ä»»ä½•é¢å¤–çš„å¼€é”€ï¼›é€šè¿‡ eBPF Maps é€šä¿¡çš„æ—¶å€™æ•°æ®å¯ä»¥ç›´æ¥ç”±å†…æ ¸æ€å¤åˆ¶åˆ° Wasm è™šæ‹Ÿæœºçš„å†…å­˜ä¸­ï¼Œé¿å…å¤šæ¬¡æ‹·è´å¸¦æ¥çš„é¢å¤–æŸè€—ã€‚åŒæ—¶ï¼Œé€šè¿‡è‡ªåŠ¨ç”Ÿæˆ skeleton ï¼ˆbpf ä»£ç æ¡†æ¶ï¼‰å’Œç±»å‹å®šä¹‰çš„æ–¹å¼ï¼Œç”¨æˆ·æ€ç¨‹åºçš„ eBPF-Wasm å¼€å‘ä½“éªŒä¹Ÿå¾—åˆ°äº†éå¸¸å¤§çš„æ”¹å–„ã€‚</p>
<p>å¾—ç›Šäº libbpf æä¾›çš„ CO-REï¼ˆCompile-Once, Run Everywhereï¼‰æŠ€æœ¯ï¼Œåœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¹‹é—´ç§»æ¤ eBPF å­—èŠ‚ç å¯¹è±¡ï¼Œä¹Ÿä¸éœ€è¦å¼•å…¥é¢å¤–çš„é‡æ–°ç¼–è¯‘æµç¨‹ï¼Œè¿è¡Œæ—¶ä¹Ÿæ²¡æœ‰ä»»ä½•çš„ LLVM/Clang ä¾èµ–[14]ã€‚</p>
<p>é€šå¸¸ï¼Œä¸€ä¸ªç¼–è¯‘å¥½çš„ eBPF-Wasm æ¨¡å—åªæœ‰å¤§çº¦ 90Kbï¼Œåœ¨ä¸åˆ° 100ms å†…å³å¯ä»¥å®ŒæˆåŠ¨æ€åŠ è½½è¿›å†…æ ¸å¹¶æ‰§è¡Œçš„è¿‡ç¨‹ã€‚æˆ‘ä»¬ä¹Ÿåœ¨ä»“åº“ä¸­æä¾›äº†å‡ ä¸ªä¾‹å­ï¼Œåˆ†åˆ«å¯¹åº”äºå¯è§‚æµ‹ã€ç½‘ç»œã€å®‰å…¨ç­‰å¤šç§åœºæ™¯ï¼Œä½¿ç”¨ C/C++ è¯­è¨€æˆ– Rust è¯­è¨€ç¼–å†™ã€‚</p>
<p>æ„Ÿè°¢åå—ç†å·¥å¤§å­¦èµ–æ™“é“®å‰¯æ•™æˆã€è¥¿å®‰é‚®ç”µå¤§å­¦é™ˆè‰å›æ•™æˆå›¢é˜Ÿå’Œè¾¾å¦ç§‘æŠ€ç‹ç’ã€æ–½ç»§æˆè€å¸ˆå¯¹ Wasm å’Œ eBPF ç›¸ç»“åˆçš„æŒ‡å¯¼ä¸å¸®åŠ©ï¼Œåœ¨æ¥ä¸‹æ¥çš„å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ä¼šå’Œå‚åŠ  2023 å¼€æºæ¯•è®¾ä¹‹æ—…çš„åŒå­¦ä»¬ä¸€åŒé’ˆå¯¹ä¸€äº› Wasm-bpf å…·ä½“çš„åº”ç”¨åœºæ™¯ï¼Œè¿›è¡Œæ›´æ·±å…¥çš„ç ”ç©¶ä¸æ¢è®¨ï¼Œå¹¶åœ¨ä¸‹ä¸€ç¯‡ blog ä¸­ç»™å‡ºæ›´è¯¦ç»†çš„åŸç†è§£æä¸æ€§èƒ½åˆ†æï¼Œä»¥åŠå¯¹åº”çš„ä¸€äº›ä»£ç ç¤ºä¾‹ã€‚</p>
<p>Wasm-bpf ç¼–è¯‘å·¥å…·é“¾ä¸è¿è¡Œæ—¶æ¨¡å—ç­‰ç›®å‰ç”±é¾™èœ¥ç¤¾åŒº eBPF æŠ€æœ¯æ¢ç´¢ SIG[15] ä¸­å­µåŒ–çš„ eunomia-bpf å¼€æºç¤¾åŒº[16]å¼€å‘ä¸ç»´æŠ¤ï¼Œæ„Ÿè°¢ä¸­ç§‘é™¢è½¯ä»¶æ‰€ PLCT å®éªŒå®¤å¯¹ç¤¾åŒºçš„å¤§åŠ›æ”¯æŒå’Œèµ„åŠ©ï¼Œæ„Ÿè°¢ç¤¾åŒºåŒä¼´ä»¬çš„è´¡çŒ®ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåœ¨å¯¹åº”çš„ eBPF å’Œ Wasm ç›¸å…³çš„å·¥å…·é“¾å’Œè¿è¡Œæ—¶æ–¹é¢ï¼Œè¿›è¡Œæ›´å¤šçš„å®Œå–„å’Œæ¢ç´¢ï¼Œå¹¶ç§¯æå‘ä¸Šæ¸¸ç¤¾åŒºåé¦ˆå’Œè´¡çŒ®ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="header" href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li>[1] wasm-bpf Github å¼€æºåœ°å€ï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></li>
<li>[2] WebAssemblyï¼šæ— éœ€å®¹å™¨çš„ Dockerï¼š<a href="https://zhuanlan.zhihu.com/p/595257541">https://zhuanlan.zhihu.com/p/595257541</a></li>
<li>[3] äº‘åŸç”Ÿé¡¹ç›®å¯æ‰©å±•æ€§çš„åˆ©å™¨ WebAssembly ç®€ä»‹ <a href="https://mp.weixin.qq.com/s/fap0bl6GFGi8zN5BFLpkCw">https://mp.weixin.qq.com/s/fap0bl6GFGi8zN5BFLpkCw</a></li>
<li>[4] å½“ Wasm é‡è§ eBPF ï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åºï¼š<a href="https://zhuanlan.zhihu.com/p/573941739">https://zhuanlan.zhihu.com/p/573941739</a></li>
<li>[5] <a href="https://ebpf.io/">https://ebpf.io/</a></li>
<li>[6] ä»€ä¹ˆæ˜¯ eBPFï¼š<a href="https://ebpf.io/what-is-ebpf">https://ebpf.io/what-is-ebpf</a></li>
<li>[7] Offensive BPF: Understanding and using bpf_probe_write_user <a href="https://embracethered.com/blog/posts/2021/offensive-bpf-libbpf-bpf_probe_write_user/">https://embracethered.com/blog/posts/2021/offensive-bpf-libbpf-bpf_probe_write_user/</a></li>
<li>[8] äº‘åŸç”Ÿå®‰å…¨æ”»é˜²ï½œä½¿ç”¨eBPFé€ƒé€¸å®¹å™¨æŠ€æœ¯åˆ†æä¸å®è·µï¼š<a href="https://security.tencent.com/index.php/blog/msg/206">https://security.tencent.com/index.php/blog/msg/206</a></li>
<li>[9] kernel-versions.md: <a href="https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md">https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md</a></li>
<li>[10] 2023 å¹´ WebAssembly æŠ€æœ¯äº”å¤§è¶‹åŠ¿é¢„æµ‹ï¼š<a href="https://zhuanlan.zhihu.com/p/597705400">https://zhuanlan.zhihu.com/p/597705400</a></li>
<li>[11] LMP eBPF-Hub: <a href="https://github.com/linuxkerneltravel/lmp">https://github.com/linuxkerneltravel/lmp</a></li>
<li>[12] WASI-eBPF: <a href="https://github.com/WebAssembly/WASI/issues/513">https://github.com/WebAssembly/WASI/issues/513</a></li>
<li>[13] BPF BTF è¯¦è§£ï¼š<a href="https://www.ebpf.top/post/kernel_btf/">https://www.ebpf.top/post/kernel_btf/</a></li>
<li>[14] BPF å¯ç§»æ¤æ€§å’Œ CO-REï¼ˆä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œï¼‰ï¼š<a href="https://cloud.tencent.com/developer/article/1802154">https://cloud.tencent.com/developer/article/1802154</a></li>
<li>[15] é¾™èœ¥ç¤¾åŒº eBPF æŠ€æœ¯æ¢ç´¢ SIG <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>[16] eunomia-bpf é¡¹ç›®ï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>[17] eunomia-bpf é¡¹ç›®é¾™èœ¥ Gitee é•œåƒï¼š<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åœ¨-webassembly-ä¸­ä½¿ç”¨-cc-å’Œ-libbpf-ç¼–å†™-ebpf-ç¨‹åº"><a class="header" href="#åœ¨-webassembly-ä¸­ä½¿ç”¨-cc-å’Œ-libbpf-ç¼–å†™-ebpf-ç¨‹åº">åœ¨ WebAssembly ä¸­ä½¿ç”¨ C/C++ å’Œ libbpf ç¼–å†™ eBPF ç¨‹åº</a></h1>
<blockquote>
<p>ä½œè€…ï¼šäºæ¡ï¼Œéƒ‘æ˜±ç¬™</p>
</blockquote>
<p>eBPFï¼ˆextended Berkeley Packet Filterï¼‰æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„å†…æ ¸è™šæ‹Ÿæœºï¼Œå¯ä»¥è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ä¸­ï¼Œç”¨æ¥æ”¶é›†ç³»ç»Ÿå’Œç½‘ç»œä¿¡æ¯ã€‚éšç€è®¡ç®—æœºæŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼ŒeBPF çš„åŠŸèƒ½æ—¥ç›Šå¼ºå¤§ï¼Œè¿›è€Œè¢«ç”¨æ¥æ„å»ºå„ç§æ•ˆç‡é«˜æ•ˆçš„åœ¨çº¿è¯Šæ–­å’Œè·Ÿè¸ªç³»ç»Ÿï¼Œä»¥åŠå®‰å…¨çš„ç½‘ç»œå’ŒæœåŠ¡ç½‘æ ¼ã€‚</p>
<p>WebAssemblyï¼ˆWasmï¼‰æœ€åˆæ˜¯ä»¥æµè§ˆå™¨å®‰å…¨æ²™ç›’ä¸ºç›®çš„å¼€å‘çš„ï¼Œå‘å±•åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒWebAssembly å·²ç»æˆä¸ºä¸€ä¸ªç”¨äºäº‘åŸç”Ÿè½¯ä»¶ç»„ä»¶çš„é«˜æ€§èƒ½ã€è·¨å¹³å°å’Œå¤šè¯­è¨€è½¯ä»¶æ²™ç®±ç¯å¢ƒï¼ŒWasm è½»é‡çº§å®¹å™¨ä¹Ÿéå¸¸é€‚åˆä½œä¸ºä¸‹ä¸€ä»£æ— æœåŠ¡å™¨å¹³å°è¿è¡Œæ—¶ï¼Œæˆ–åœ¨è¾¹ç¼˜è®¡ç®—ç­‰èµ„æºå—é™çš„åœºæ™¯é«˜æ•ˆæ‰§è¡Œã€‚</p>
<p>ç°åœ¨ï¼Œå€ŸåŠ© Wasm-bpf ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Wasm å°† eBPF ç¨‹åºç¼–å†™ä¸ºè·¨å¹³å°çš„æ¨¡å—ï¼ŒåŒæ—¶ä½¿ç”¨ C/C++ æˆ– Rust æ¥ç¼–å†™ Wasm ç¨‹åºã€‚é€šè¿‡åœ¨ WebAssembly ä¸­ä½¿ç”¨ eBPF ç¨‹åºï¼Œæˆ‘ä»¬ä¸ä»…èƒ½è®© Wasm åº”ç”¨äº«å—åˆ° eBPF çš„é«˜æ€§èƒ½å’Œå¯¹ç³»ç»Ÿæ¥å£çš„è®¿é—®èƒ½åŠ›ï¼Œè¿˜å¯ä»¥è®© eBPF ç¨‹åºä½¿ç”¨åˆ° Wasm çš„æ²™ç®±ã€çµæ´»æ€§ã€è·¨å¹³å°æ€§ã€å’ŒåŠ¨æ€åŠ è½½ï¼Œå¹¶ä¸”ä½¿ç”¨ Wasm çš„ OCI é•œåƒæ¥æ–¹ä¾¿ã€å¿«æ·åœ°åˆ†å‘å’Œç®¡ç† eBPF ç¨‹åºã€‚ç»“åˆè¿™ä¸¤ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬å°†ä¼šç»™ eBPF å’Œ Wasm ç”Ÿæ€æ¥ä¸€ä¸ªå…¨æ–°çš„å¼€å‘ä½“éªŒï¼</p>
<h2 id="ä½¿ç”¨-wasm-bpf-å·¥å…·é“¾åœ¨-wasm-ä¸­ç¼–å†™åŠ¨æ€åŠ è½½åˆ†å‘è¿è¡Œ-ebpf-ç¨‹åº"><a class="header" href="#ä½¿ç”¨-wasm-bpf-å·¥å…·é“¾åœ¨-wasm-ä¸­ç¼–å†™åŠ¨æ€åŠ è½½åˆ†å‘è¿è¡Œ-ebpf-ç¨‹åº">ä½¿ç”¨ Wasm-bpf å·¥å…·é“¾åœ¨ Wasm ä¸­ç¼–å†™ã€åŠ¨æ€åŠ è½½ã€åˆ†å‘è¿è¡Œ eBPF ç¨‹åº</a></h2>
<p>Wasm-bpf æ˜¯ä¸€ä¸ªå…¨æ–°çš„å¼€æºé¡¹ç›®ï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a>ã€‚å®ƒå®šä¹‰äº†ä¸€å¥— eBPF ç›¸å…³ç³»ç»Ÿæ¥å£çš„æŠ½è±¡ï¼Œå¹¶æä¾›äº†ä¸€å¥—å¯¹åº”çš„å¼€å‘å·¥å…·é“¾ã€åº“ä»¥åŠé€šç”¨çš„ Wasm + eBPF è¿è¡Œæ—¶å®ä¾‹ã€‚å®ƒå¯ä»¥æä¾›å’Œ libbpf-bootstrap ç›¸ä¼¼çš„å¼€å‘ä½“éªŒï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ skeleton å¤´æ–‡ä»¶ï¼Œä»¥åŠç”¨äºåœ¨ Wasm å’Œ eBPF ä¹‹é—´æ— åºåˆ—åŒ–é€šä¿¡çš„æ•°æ®ç»“æ„å®šä¹‰ã€‚ä½ å¯ä»¥éå¸¸å®¹æ˜“åœ°ä½¿ç”¨ä»»ä½•è¯­è¨€ï¼Œåœ¨ä»»ä½•å¹³å°ä¸Šå»ºç«‹ä½ è‡ªå·±çš„ Wasm-eBPF è¿è¡Œæ—¶ï¼Œä½¿ç”¨ç›¸åŒçš„å·¥å…·é“¾æ¥æ„å»ºåº”ç”¨ã€‚æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œè¯·å‚è€ƒæˆ‘ä»¬çš„ä¸Šä¸€ç¯‡åšå®¢ï¼š<a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">Wasm-bpf: æ¶èµ· Webassembly å’Œ eBPF å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢</a>ã€‚</p>
<p>åŸºäº Wasmï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šç§è¯­è¨€æ„å»º eBPF åº”ç”¨ï¼Œå¹¶ä»¥ç»Ÿä¸€ã€è½»é‡çº§çš„æ–¹å¼ç®¡ç†å’Œå‘å¸ƒã€‚ä»¥æˆ‘ä»¬æ„å»ºçš„ç¤ºä¾‹åº”ç”¨ bootstrap.wasm ä¸ºä¾‹ï¼Œå¤§å°ä»…ä¸º ~90Kï¼Œå¾ˆå®¹æ˜“é€šè¿‡ç½‘ç»œåˆ†å‘ï¼Œå¹¶å¯ä»¥åœ¨ä¸åˆ° 100ms çš„æ—¶é—´å†…åœ¨å¦ä¸€å°æœºå™¨ä¸ŠåŠ¨æ€éƒ¨ç½²ã€åŠ è½½å’Œè¿è¡Œï¼Œå¹¶ä¸”ä¿ç•™è½»é‡çº§å®¹å™¨çš„éš”ç¦»ç‰¹æ€§ã€‚è¿è¡Œæ—¶ä¸éœ€è¦å†…æ ¸å¤´æ–‡ä»¶ã€LLVMã€clang ç­‰ä¾èµ–ï¼Œä¹Ÿä¸éœ€è¦åšä»»ä½•æ¶ˆè€—èµ„æºçš„é‡é‡çº§çš„ç¼–è¯‘å·¥ä½œã€‚</p>
<p>æœ¬æ–‡å°†ä»¥ C/C++ è¯­è¨€ä¸ºä¾‹ï¼Œè®¨è®º C/C++ ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm æ¨¡å—ã€‚ä½¿ç”¨ Rust è¯­è¨€ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm æ¨¡å—çš„å…·ä½“ç¤ºä¾‹ï¼Œå°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æè¿°ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä»“åº“ä¸­æä¾›äº†å‡ ä¸ªç¤ºä¾‹ç¨‹åºï¼Œåˆ†åˆ«å¯¹åº”äºå¯è§‚æµ‹ã€ç½‘ç»œã€å®‰å…¨ç­‰å¤šç§åœºæ™¯ã€‚</p>
<h2 id="ä½¿ç”¨-cc-ç¼–å†™-ebpf-ç¨‹åºå¹¶ç¼–è¯‘ä¸º-wasm"><a class="header" href="#ä½¿ç”¨-cc-ç¼–å†™-ebpf-ç¨‹åºå¹¶ç¼–è¯‘ä¸º-wasm">ä½¿ç”¨ C/C++ ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm</a></h2>
<p>libbpf æ˜¯ä¸€ä¸ª C/C++ çš„ eBPF ç”¨æˆ·æ€åŠ è½½å’Œæ§åˆ¶åº“ï¼Œéšç€å†…æ ¸ä¸€èµ·åˆ†å‘ï¼Œå‡ ä¹å·²ç»æˆä¸º eBPF ç”¨æˆ·æ€äº‹å®ä¸Šçš„ API æ ‡å‡†ï¼Œlibbpf ä¹Ÿæ”¯æŒ CO-RE(Compile Once â€“ Run Everywhere) çš„è§£å†³æ–¹æ¡ˆï¼Œå³é¢„ç¼–è¯‘çš„ bpf ä»£ç å¯ä»¥åœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸Šæ­£å¸¸å·¥ä½œï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªç‰¹å®šå†…æ ¸é‡æ–°ç¼–è¯‘ã€‚æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½çš„ä¿æŒä¸ libbpf çš„ç”¨æˆ·æ€ API ä»¥åŠè¡Œä¸ºä¸€è‡´ï¼Œå°½å¯èƒ½å‡å°‘åº”ç”¨è¿ç§»åˆ° Wasm ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰çš„æˆæœ¬ã€‚</p>
<p>libbpf-bootstrap ä¸ºç”ŸæˆåŸºäº libbpf çš„ bpf ç¨‹åºæä¾›äº†æ¨¡æ¿,å¼€å‘è€…å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨è¯¥æ¨¡æ¿ç”Ÿæˆè‡ªå®šä¹‰çš„ bpf ç¨‹åºã€‚ä¸€èˆ¬è¯´æ¥ï¼Œåœ¨é Wasm æ²™ç®±çš„ç”¨æˆ·æ€ç©ºé—´ï¼Œä½¿ç”¨ libbpf-bootstrap è„šæ‰‹æ¶ï¼Œå¯ä»¥å¿«é€Ÿã€è½»æ¾åœ°ä½¿ç”¨ C/C++æ„å»º BPF åº”ç”¨ç¨‹åºã€‚</p>
<p>ç¼–è¯‘ã€æ„å»ºå’Œè¿è¡Œ eBPF ç¨‹åºï¼ˆæ— è®ºæ˜¯é‡‡ç”¨ä»€ä¹ˆè¯­è¨€ï¼‰ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>ç¼–å†™å†…æ ¸æ€ eBPF ç¨‹åºçš„ä»£ç ï¼Œä¸€èˆ¬ä½¿ç”¨ C/C++ æˆ– Rust è¯­è¨€</li>
<li>ä½¿ç”¨ clang ç¼–è¯‘å™¨æˆ–è€…ç›¸å…³å·¥å…·é“¾ç¼–è¯‘ eBPF ç¨‹åºï¼ˆè¦å®ç°è·¨å†…æ ¸ç‰ˆæœ¬ç§»æ¤çš„è¯ï¼Œéœ€è¦åŒ…å« BTF ä¿¡æ¯ï¼‰ã€‚</li>
<li>åœ¨ç”¨æˆ·æ€çš„å¼€å‘ç¨‹åºä¸­ï¼Œç¼–å†™å¯¹åº”çš„åŠ è½½ã€æ§åˆ¶ã€æŒ‚è½½ã€æ•°æ®å¤„ç†é€»è¾‘ï¼›</li>
<li>åœ¨å®é™…è¿è¡Œçš„é˜¶æ®µï¼Œä»ç”¨æˆ·æ€å°† eBPF ç¨‹åºåŠ è½½è¿›å…¥å†…æ ¸ï¼Œå¹¶å®é™…æ‰§è¡Œã€‚</li>
</ul>
<h3 id="bootstrap-2"><a class="header" href="#bootstrap-2">bootstrap</a></h3>
<p><code>bootstrap</code>æ˜¯ä¸€ä¸ªç®€å•ï¼ˆä½†å®ç”¨ï¼‰çš„BPFåº”ç”¨ç¨‹åºçš„ä¾‹å­ã€‚å®ƒè·Ÿè¸ªè¿›ç¨‹çš„å¯åŠ¨ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯ <code>exec()</code> ç³»åˆ—çš„ç³»ç»Ÿè°ƒç”¨ï¼‰å’Œé€€å‡ºï¼Œå¹¶å‘é€å…³äºæ–‡ä»¶åã€PID å’Œ çˆ¶ PID çš„æ•°æ®ï¼Œä»¥åŠé€€å‡ºçŠ¶æ€å’Œè¿›ç¨‹çš„æŒç»­æ—¶é—´ã€‚ç”¨<code>-d &lt;min-duration-ms&gt;</code> ä½ å¯ä»¥æŒ‡å®šè¦è®°å½•çš„è¿›ç¨‹çš„æœ€å°æŒç»­æ—¶é—´ã€‚</p>
<p><code>bootstrap</code> æ˜¯åœ¨ <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a> ä¸­ï¼Œæ ¹æ® BCC è½¯ä»¶åŒ…ä¸­çš„<a href="https://github.com/iovisor/bcc/tree/master/libbpf-tools">libbpf-tools</a>çš„ç±»ä¼¼æ€æƒ³åˆ›å»ºçš„ï¼Œä½†å®ƒè¢«è®¾è®¡æˆæ›´ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”æœ‰æ›´ç®€å•çš„ Makefile ä»¥ç®€åŒ–ç”¨æˆ·çš„ç‰¹æ®Šéœ€æ±‚ã€‚å®ƒæ¼”ç¤ºäº†å…¸å‹çš„BPFç‰¹æ€§ï¼ŒåŒ…å«ä½¿ç”¨å¤šä¸ª BPF ç¨‹åºæ®µè¿›è¡Œåˆä½œï¼Œä½¿ç”¨ BPF map æ¥ç»´æŠ¤çŠ¶æ€ï¼Œä½¿ç”¨ BPF ring buffer æ¥å‘é€æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä»¥åŠä½¿ç”¨å…¨å±€å˜é‡æ¥å‚æ•°åŒ–åº”ç”¨ç¨‹åºè¡Œä¸ºã€‚</p>
<p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬ä½¿ç”¨ Wasm ç¼–è¯‘è¿è¡Œ <code>bootstrap</code> çš„ä¸€ä¸ªè¾“å‡ºç¤ºä¾‹ï¼š</p>
<pre><code class="language-console">$ sudo sudo ./wasm-bpf bootstrap.wasm -h
BPF bootstrap demo application.

It traces process start and exits and shows associated
information (filename, process duration, PID and PPID, etc).

USAGE: ./bootstrap [-d &lt;min-duration-ms&gt;] -v
$ sudo ./wasm-bpf bootstrap.wasm
TIME     EVENT COMM             PID     PPID    FILENAME/EXIT CODE
18:57:58 EXEC  sed              74911   74910   /usr/bin/sed
18:57:58 EXIT  sed              74911   74910   [0] (2ms)
18:57:58 EXIT  cat              74912   74910   [0] (0ms)
18:57:58 EXEC  cat              74913   74910   /usr/bin/cat
18:57:59 EXIT  cat              74913   74910   [0] (0ms)
18:57:59 EXEC  cat              74914   74910   /usr/bin/cat
18:57:59 EXIT  cat              74914   74910   [0] (0ms)
18:57:59 EXEC  cat              74915   74910   /usr/bin/cat
18:57:59 EXIT  cat              74915   74910   [0] (1ms)
18:57:59 EXEC  sleep            74916   74910   /usr/bin/sleep
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥æä¾›ä¸ libbpf-bootstrap å¼€å‘ç›¸ä¼¼çš„å¼€å‘ä½“éªŒã€‚åªéœ€è¿è¡Œ make å³å¯æ„å»º wasm äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<pre><code class="language-console">git clone https://github.com/eunomia-bpf/wasm-bpf --recursive
cd examples/bootstrap
make
</code></pre>
<h3 id="ç¼–å†™å†…æ ¸æ€çš„-ebpf-ç¨‹åº-2"><a class="header" href="#ç¼–å†™å†…æ ¸æ€çš„-ebpf-ç¨‹åº-2">ç¼–å†™å†…æ ¸æ€çš„ eBPF ç¨‹åº</a></h3>
<p>è¦æ„å»ºä¸€ä¸ªå®Œæ•´çš„ eBPF ç¨‹åºï¼Œé¦–å…ˆè¦ç¼–å†™å†…æ ¸æ€çš„ bpf ä»£ç ã€‚é€šå¸¸ä½¿ç”¨ C è¯­è¨€ç¼–å†™ï¼Œå¹¶ä½¿ç”¨ clang å®Œæˆç¼–è¯‘ï¼š</p>
<pre><code class="language-c">char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 8192);
    __type(key, pid_t);
    __type(value, u64);
} exec_start SEC(&quot;.maps&quot;);

struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

const volatile unsigned long long min_duration_ns = 0;
const volatile int *name_ptr;

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
    struct task_struct *task;
    unsigned fname_off;
    struct event *e;
    pid_t pid;
    u64 ts;
....
</code></pre>
<p>å—ç¯‡å¹…æ‰€é™ï¼Œè¿™é‡Œæ²¡æœ‰è´´å‡ºå®Œæ•´çš„ä»£ç ã€‚å†…æ ¸æ€ä»£ç çš„ç¼–å†™æ–¹å¼å’Œå…¶ä»–åŸºäº libbpf çš„ç¨‹åºå®Œå…¨ç›¸åŒï¼Œä¸€èˆ¬æ¥è¯´ä¼šåŒ…å«ä¸€äº›å…¨å±€å˜é‡ï¼Œé€šè¿‡ <code>SEC</code> å£°æ˜æŒ‚è½½ç‚¹çš„ eBPF å‡½æ•°ï¼Œä»¥åŠç”¨äºä¿å­˜çŠ¶æ€ï¼Œæˆ–è€…åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´ç›¸äº’é€šä¿¡çš„ map å¯¹è±¡ï¼ˆæˆ‘ä»¬è¿˜åœ¨è¿›è¡Œå¦å¤–ä¸€é¡¹å·¥ä½œï¼š<a href="https://github.com/iovisor/bcc/issues/4404">bcc to libbpf converter</a>ï¼Œç­‰å®ƒå®Œæˆåå°±å¯ä»¥ä»¥è¿™ç§æ–¹å¼ç¼–è¯‘ BCC é£æ ¼çš„ eBPF å†…æ ¸æ€ç¨‹åºï¼‰ã€‚åœ¨ç¼–å†™å®Œ eBPF ç¨‹åºä¹‹åï¼Œè¿è¡Œ <code>make</code> ä¼šåœ¨ <code>Makefile</code> è°ƒç”¨ clang å’Œ llvm-strip æ„å»ºBPFç¨‹åºï¼Œä»¥å‰¥ç¦»è°ƒè¯•ä¿¡æ¯ï¼š</p>
<pre><code class="language-shell">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I../../third_party/vmlinux/x86/ -idirafter /usr/local/include -idirafter /usr/include -c bootstrap.bpf.c -o bootstrap.bpf.o
llvm-strip -g bootstrap.bpf.o # strip useless DWARF info
</code></pre>
<p>ä¹‹åï¼Œæˆ‘ä»¬ä¼šæä¾›ä¸€ä¸ªä¸ºäº† Wasm ä¸“é—¨å®ç°çš„ bpftoolï¼Œç”¨äºä» BPF ç¨‹åºç”ŸæˆCå¤´æ–‡ä»¶ï¼š</p>
<pre><code class="language-shell">../../third_party/bpftool/src/bpftool gen skeleton -j bootstrap.bpf.o &gt; bootstrap.skel.h
</code></pre>
<p>ç”±äº eBPF æœ¬èº«çš„æ‰€æœ‰ C å†…å­˜å¸ƒå±€æ˜¯å’Œå½“å‰æ‰€åœ¨æœºå™¨çš„æŒ‡ä»¤é›†ä¸€æ ·çš„ï¼Œä½†æ˜¯ wasm æ˜¯æœ‰ä¸€å¥—ç¡®å®šçš„å†…å­˜å¸ƒå±€ï¼ˆæ¯”å¦‚å½“å‰æ‰€åœ¨æœºå™¨æ˜¯ 64 ä½çš„ï¼ŒWasm è™šæ‹Ÿæœºé‡Œé¢æ˜¯ 32 ä½çš„ï¼ŒC struct layout ã€æŒ‡é’ˆå®½åº¦ã€å¤§å°ç«¯ç­‰ç­‰éƒ½å¯èƒ½ä¸ä¸€æ ·ï¼‰ï¼Œä¸ºäº†ç¡®ä¿ eBPF ç¨‹åºèƒ½æ­£ç¡®å’Œ Wasm ä¹‹é—´è¿›è¡Œç›¸äº’é€šä¿¡ï¼Œæˆ‘ä»¬éœ€è¦å®šåˆ¶ä¸€ä¸ªä¸“é—¨çš„ bpftool ç­‰å·¥å…·ï¼Œå®ç°æ­£ç¡®ç”Ÿæˆå¯ä»¥åœ¨ Wasm ä¸­å·¥ä½œçš„ç”¨æˆ·æ€å¼€å‘æ¡†æ¶ã€‚</p>
<p>skel åŒ…å«ä¸€ä¸ª BPF ç¨‹åºçš„skeletonï¼Œç”¨äºæ“ä½œ BPF å¯¹è±¡ï¼Œå¹¶æ§åˆ¶ BPF ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-c">    struct bootstrap_bpf {
        struct bpf_object_skeleton *skeleton;
        struct bpf_object *obj;
        struct {
            struct bpf_map *exec_start;
            struct bpf_map *rb;
            struct bpf_map *rodata;
        } maps;
        struct {
            struct bpf_program *handle_exec;
            struct bpf_program *handle_exit;
        } progs;
        struct bootstrap_bpf__rodata {
            unsigned long long min_duration_ns;
        } *rodata;
        struct bootstrap_bpf__bss {
            uint64_t /* pointer */ name_ptr;
        } *bss;
    };
</code></pre>
<p>æˆ‘ä»¬ä¼šå°†æ‰€æœ‰æŒ‡é’ˆéƒ½å°†æ ¹æ® eBPF ç¨‹åºç›®æ ‡æ‰€åœ¨çš„æŒ‡ä»¤é›†çš„æŒ‡é’ˆå¤§å°è½¬æ¢ä¸ºæ•´æ•°ï¼Œä¾‹å¦‚ï¼Œ<code>name_ptr</code>ã€‚æ­¤å¤–ï¼Œå¡«å……å­—èŠ‚å°†æ˜ç¡®æ·»åŠ åˆ°ç»“æ„ä½“ä¸­ä»¥ç¡®ä¿ç»“æ„ä½“å¸ƒå±€ä¸ç›®æ ‡ç«¯ç›¸åŒï¼Œä¾‹å¦‚ä½¿ç”¨ <code>char __pad0[4];</code>ã€‚æˆ‘ä»¬è¿˜ä¼šä½¿ç”¨ <code>static_assert</code> æ¥ç¡®ä¿ç»“æ„ä½“çš„å†…å­˜é•¿åº¦å’ŒåŸå…ˆ BTF ä¿¡æ¯ä¸­çš„ç±»å‹é•¿åº¦ç›¸åŒã€‚</p>
<h3 id="æ„å»ºç”¨æˆ·æ€çš„-wasm-ä»£ç å¹¶è·å–å†…æ ¸æ€æ•°æ®-2"><a class="header" href="#æ„å»ºç”¨æˆ·æ€çš„-wasm-ä»£ç å¹¶è·å–å†…æ ¸æ€æ•°æ®-2">æ„å»ºç”¨æˆ·æ€çš„ Wasm ä»£ç ï¼Œå¹¶è·å–å†…æ ¸æ€æ•°æ®</a></h3>
<p>æˆ‘ä»¬é»˜è®¤ä½¿ç”¨ wasi-sdk ä» C/C++ ä»£ç æ„å»º wasm äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ emcc å·¥å…·é“¾æ¥æ„å»º wasm äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå‘½ä»¤åº”è¯¥æ˜¯ç›¸ä¼¼çš„ã€‚æ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… wasi-sdkï¼š</p>
<pre><code class="language-sh">wget https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-17/wasi-sdk-17.0-linux.tar.gz
tar -zxf wasi-sdk-17.0-linux.tar.gz
sudo mkdir -p /opt/wasi-sdk/ &amp;&amp; sudo mv wasi-sdk-17.0/* /opt/wasi-sdk/
</code></pre>
<p>ç„¶åè¿è¡Œ <code>make</code> ä¼šåœ¨ <code>Makefile</code> ä¸­ä½¿ç”¨ wasi-clang ç¼–è¯‘ C ä»£ç ï¼Œç”Ÿæˆ Wasm å­—èŠ‚ç ï¼š</p>
<pre><code class="language-sh">/opt/wasi-sdk/bin/clang -O2 --sysroot=/opt/wasi-sdk/share/wasi-sysroot -Wl,--allow-undefined -o bootstrap.wasm bootstrap.c
</code></pre>
<p>ç”±äºå®¿ä¸»æœºï¼ˆæˆ– eBPF ç«¯ï¼‰çš„ C ç»“æ„å¸ƒå±€å¯èƒ½ä¸ç›®æ ‡ï¼ˆWasm ç«¯ï¼‰çš„ç»“æ„å¸ƒå±€ä¸åŒï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨ ecc å’Œæˆ‘ä»¬çš„ wasm-bpftool ç”Ÿæˆç”¨æˆ·ç©ºé—´ä»£ç çš„ C å¤´æ–‡ä»¶ï¼š</p>
<pre><code class="language-sh">ecc bootstrap.h --header-only
../../third_party/bpftool/src/bpftool btf dump file bootstrap.bpf.o format c -j &gt; bootstrap.wasm.h
</code></pre>
<p>ä¾‹å¦‚ï¼ŒåŸå…ˆå†…æ ¸æ€çš„å¤´æ–‡ä»¶ä¸­ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">struct event {
    int pid;
    int ppid;
    unsigned exit_code;
    unsigned long long duration_ns;
    char comm[TASK_COMM_LEN];
    char filename[MAX_FILENAME_LEN];
    char exit_event;
};
</code></pre>
<p>æˆ‘ä»¬çš„å·¥å…·ä¼šå°†å…¶è½¬æ¢ä¸ºï¼š</p>
<pre><code class="language-c">struct event {
    int pid;
    int ppid;
    unsigned int exit_code;
    char __pad0[4];
    unsigned long long duration_ns;
    char comm[16];
    char filename[127];
    char exit_event;
} __attribute__((packed));
static_assert(sizeof(struct event) == 168, &quot;Size of event is not 168&quot;);
</code></pre>
<p>**æ³¨æ„ï¼šæ­¤è¿‡ç¨‹å’Œå·¥å…·å¹¶ä¸æ€»æ˜¯å¿…éœ€çš„ï¼Œå¯¹äºç®€å•çš„åº”ç”¨ï¼Œä½ å¯ä»¥æ‰‹åŠ¨å®Œæˆã€‚**å¯¹äºå†…æ ¸æ€å’Œ Wasm åº”ç”¨éƒ½ä½¿ç”¨ C/C++ è¯­è¨€çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥æ‰‹åŠ¨ç¼–å†™æ‰€æœ‰äº‹ä»¶ç»“æ„ä½“å®šä¹‰ï¼Œä½¿ç”¨ <code>__attribute__((packed))</code> é¿å…å¡«å……å­—èŠ‚ï¼Œå¹¶åœ¨ä¸»æœºå’Œ wasm ç«¯ä¹‹é—´è½¬æ¢æ‰€æœ‰æŒ‡é’ˆä¸ºæ­£ç¡®çš„æ•´æ•°ã€‚æ‰€æœ‰ç±»å‹å¿…é¡»åœ¨ wasm ä¸­å®šä¹‰ä¸ä¸»æœºç«¯ç›¸åŒçš„å¤§å°å’Œå¸ƒå±€ã€‚</p>
<p>å¯¹äºå¤æ‚çš„ç¨‹åºï¼Œæ‰‹åŠ¨ç¡®è®¤å†…å­˜å¸ƒå±€çš„æ­£ç¡®æ˜¯åˆ†å›°éš¾ï¼Œå› æ­¤æˆ‘ä»¬åˆ›å»ºäº† wasm ç‰¹å®šçš„ <code>bpftool</code>ï¼Œç”¨äºä» <code>BTF</code> ä¿¡æ¯ä¸­ç”ŸæˆåŒ…å«æ‰€æœ‰ç±»å‹å®šä¹‰å’Œæ­£ç¡®ç»“æ„ä½“å¸ƒå±€çš„ C å¤´æ–‡ä»¶ï¼Œä»¥ä¾¿ç”¨æˆ·ç©ºé—´ä»£ç ä½¿ç”¨ã€‚å¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ–¹æ¡ˆï¼Œä¸€æ¬¡æ€§å°† eBPF ç¨‹åºä¸­æ‰€æœ‰çš„ç»“æ„ä½“å®šä¹‰è½¬æ¢ä¸º Wasm ç«¯çš„å†…å­˜å¸ƒå±€ï¼Œå¹¶ç¡®ä¿å¤§å°ç«¯ä¸€è‡´ï¼Œå³å¯æ­£ç¡®è®¿é—®ã€‚</p>
<p>å¯¹äº Wasm ä¸­ä¸æ˜¯ç”± C è¯­è¨€è¿›è¡Œå¼€å‘çš„æƒ…å†µä¸‹ï¼Œå€ŸåŠ© Wasm çš„ç»„ä»¶æ¨¡å‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†è¿™äº› BTF ä¿¡æ¯ç»“æ„ä½“å®šä¹‰ä½œä¸º wit ç±»å‹å£°æ˜è¾“å‡ºï¼Œç„¶ååœ¨ç”¨æˆ·ç©ºé—´ä»£ç ä¸­ä½¿ç”¨ wit-bindgen å·¥å…·ä¸€æ¬¡æ€§ç”Ÿæˆå¤šç§è¯­è¨€ï¼ˆå¦‚ C/C++/Rust/Goï¼‰çš„ç±»å‹å®šä¹‰ã€‚è¿™éƒ¨åˆ†ä¼šåœ¨å…³äºå¦‚ä½•ä½¿ç”¨ Rust åœ¨ Wasm ä¸­ç¼–å†™ eBPF ç¨‹åºçš„éƒ¨åˆ†è¯¦ç»†æè¿°ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°†è¿™äº›æ­¥éª¤å’Œå·¥å…·é“¾ç»§ç»­å®Œå–„ï¼Œä»¥æ”¹è¿› Wasm-bpf ç¨‹åºçš„ç¼–ç¨‹ä½“éªŒã€‚</p>
<p>æˆ‘ä»¬ä¸º wasm ç¨‹åºæä¾›äº†ä¸€ä¸ªä»…åŒ…å«å¤´æ–‡ä»¶çš„ libbpf API åº“ï¼Œæ‚¨å¯ä»¥åœ¨ libbpf-wasm.hï¼ˆwasm-include/libbpf-wasm.hï¼‰ä¸­æ‰¾åˆ°å®ƒï¼Œå®ƒåŒ…å«äº†ä¸€éƒ¨åˆ† libbpf å¸¸ç”¨çš„ç”¨æˆ·æ€ API å’Œç±»å‹å®šä¹‰ã€‚Wasm ç¨‹åºå¯ä»¥ä½¿ç”¨ libbpf API æ“ä½œ BPF å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-c">/* Load and verify BPF application */
skel = bootstrap_bpf__open();
/* Parameterize BPF code with minimum duration parameter */
skel-&gt;rodata-&gt;min_duration_ns = env.min_duration_ms * 1000000ULL;
/* Load &amp; verify BPF programs */
err = bootstrap_bpf__load(skel);
/* Attach tracepoints */
err = bootstrap_bpf__attach(skel);
</code></pre>
<p>rodata éƒ¨åˆ†ç”¨äºå­˜å‚¨ BPF ç¨‹åºä¸­çš„å¸¸é‡ï¼Œè¿™äº›å€¼å°†åœ¨ bpftool gen skeleton çš„æ—¶å€™ç”±ä»£ç ç”Ÿæˆæ˜ å°„åˆ° object ä¸­æ­£ç¡®çš„åç§»é‡,ç„¶ååœ¨ open ä¹‹åé€šè¿‡å†…å­˜æ˜ å°„ä¿®æ”¹å¯¹åº”çš„å€¼ï¼Œå› æ­¤ä¸éœ€è¦åœ¨ Wasm ä¸­ç¼–è¯‘ libelf åº“ï¼Œè¿è¡Œæ—¶ä»å¯åŠ¨æ€åŠ è½½å’Œæ“ä½œ BPF å¯¹è±¡ã€‚</p>
<p>Wasm ç«¯çš„ C ä»£ç ä¸æœ¬åœ° libbpf ä»£ç ç•¥æœ‰ä¸åŒï¼Œä½†å®ƒå¯ä»¥ä» eBPF ç«¯æä¾›å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œä»ç¯å½¢ç¼“å†²åŒºæˆ– perf ç¼“å†²åŒºè½®è¯¢ï¼Œä» Wasm ç«¯å’Œ eBPF ç«¯è®¿é—®æ˜ å°„ï¼ŒåŠ è½½ã€é™„åŠ å’Œåˆ†ç¦» BPF ç¨‹åºç­‰ã€‚å®ƒå¯ä»¥æ”¯æŒå¤§é‡çš„ eBPF ç¨‹åºç±»å‹å’Œæ˜ å°„ï¼Œæ¶µç›–ä»è·Ÿè¸ªã€ç½‘ç»œã€å®‰å…¨ç­‰æ–¹é¢çš„å¤§å¤šæ•° eBPF ç¨‹åºçš„ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>ç”±äº Wasm ç«¯ç¼ºå°‘ä¸€äº›åŠŸèƒ½ï¼Œä¾‹å¦‚ signal handler è¿˜ä¸æ”¯æŒï¼ˆ2023å¹´2æœˆï¼‰ï¼ŒåŸå§‹çš„Cä»£ç æœ‰å¯èƒ½æ— æ³•ç›´æ¥ç¼–è¯‘ä¸º wasmï¼Œæ‚¨éœ€è¦ç¨å¾®ä¿®æ”¹ä»£ç ä»¥ä½¿å…¶å·¥ä½œã€‚æˆ‘ä»¬å°†å°½æœ€å¤§åŠªåŠ›ä½¿ wasm ç«¯çš„ libbpf API ä¸é€šå¸¸åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ libbpf APIå°½å¯èƒ½ç›¸ä¼¼ï¼Œä»¥ä¾¿ç”¨æˆ·ç©ºé—´ä»£ç å¯ä»¥åœ¨æœªæ¥ç›´æ¥ç¼–è¯‘ä¸º wasmã€‚æˆ‘ä»¬è¿˜å°†å°½å¿«æä¾›æ›´å¤šè¯­è¨€ç»‘å®šï¼ˆGoç­‰ï¼‰çš„ wasm ä¾§ eBPF ç¨‹åºå¼€å‘åº“ã€‚</p>
<p>å¯ä»¥åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­ä½¿ç”¨ polling API è·å–å†…æ ¸æ€ä¸Šä¼ çš„æ•°æ®ã€‚å®ƒå°†æ˜¯ ring buffer å’Œ perf buffer çš„ä¸€ä¸ªå°è£…ï¼Œç”¨æˆ·ç©ºé—´ä»£ç å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ API ä»ç¯å½¢ç¼“å†²åŒºæˆ–æ€§èƒ½ç¼“å†²åŒºä¸­è½®è¯¢äº‹ä»¶ï¼Œå…·ä½“å–å†³äºBPFç¨‹åºä¸­æŒ‡å®šçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œç¯å½¢ç¼“å†²åŒºè½®è¯¢å®šä¹‰ä¸º<code>BPF_MAP_TYPE_RINGBUF</code>ï¼š</p>
<pre><code class="language-c">struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);
</code></pre>
<p>ä½ å¯ä»¥åœ¨ç”¨æˆ·æ€ä½¿ç”¨ä»¥ä¸‹ä»£ç ä» ring buffer ä¸­è½®è¯¢äº‹ä»¶ï¼š</p>
<pre><code class="language-c">rb = bpf_buffer__open(skel-&gt;maps.rb, handle_event, NULL);
/* Process events */
printf(&quot;%-8s %-5s %-16s %-7s %-7s %s\n&quot;, &quot;TIME&quot;, &quot;EVENT&quot;, &quot;COMM&quot;, &quot;PID&quot;,
       &quot;PPID&quot;, &quot;FILENAME/EXIT CODE&quot;);
while (!exiting) {
    // poll buffer
    err = bpf_buffer__poll(rb, 100 /* timeout, ms */);
</code></pre>
<p>ring buffer polling ä¸éœ€è¦åºåˆ—åŒ–å¼€é”€ã€‚bpf_buffer__poll API å°†è°ƒç”¨ handle_event å›è°ƒå‡½æ•°æ¥å¤„ç†ç¯å½¢ç¼“å†²åŒºä¸­çš„äº‹ä»¶æ•°æ®ï¼š</p>
<pre><code class="language-c">
static int
handle_event(void *ctx, void *data, size_t data_sz)
{
    const struct event *e = data;
    ...
    if (e-&gt;exit_event) {
        printf(&quot;%-8s %-5s %-16s %-7d %-7d [%u]&quot;, ts, &quot;EXIT&quot;, e-&gt;comm, e-&gt;pid,
               e-&gt;ppid, e-&gt;exit_code);
        if (e-&gt;duration_ns)
            printf(&quot; (%llums)&quot;, e-&gt;duration_ns / 1000000);
        printf(&quot;\n&quot;);
    }
    ...
    return 0;
}
</code></pre>
<p>è¿è¡Œæ—¶åŸºäº libbpf CO-REï¼ˆCompile Once, Run Everywhereï¼‰APIï¼Œç”¨äºå°† bpf å¯¹è±¡åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œå› æ­¤ wasm-bpf ç¨‹åºä¸å—å®ƒç¼–è¯‘çš„å†…æ ¸ç‰ˆæœ¬çš„å½±å“ï¼Œå¯ä»¥åœ¨ä»»ä½•æ”¯æŒ BPF CO-RE çš„å†…æ ¸ç‰ˆæœ¬ä¸Šè¿è¡Œã€‚</p>
<h3 id="ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–°-ebpf-ç¨‹åºçš„-map-æ•°æ®-2"><a class="header" href="#ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–°-ebpf-ç¨‹åºçš„-map-æ•°æ®-2">ä»ç”¨æˆ·æ€ç¨‹åºä¸­è®¿é—®å’Œæ›´æ–° eBPF ç¨‹åºçš„ map æ•°æ®</a></h3>
<p>runqlat æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼Œè¿™ä¸ªç¨‹åºé€šè¿‡ç›´æ–¹å›¾å±•ç¤ºè°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ—å»¶è¿Ÿï¼Œç»™æˆ‘ä»¬å±•ç°äº†ä»»åŠ¡ç­‰äº†å¤šä¹…æ‰èƒ½è¿è¡Œã€‚</p>
<pre><code class="language-console">$ sudo ./wasm-bpf runqlat.wasm -h
Summarize run queue (scheduler) latency as a histogram.

USAGE: runqlat [--help] [interval] [count]

EXAMPLES:
    runqlat         # summarize run queue latency as a histogram
    runqlat 1 10    # print 1 second summaries, 10 times
$ sudo ./wasm-bpf runqlat.wasm 1

Tracing run queue latency... Hit Ctrl-C to end.

     usecs               : count    distribution
         0 -&gt; 1          : 72       |*****************************           |
         2 -&gt; 3          : 93       |*************************************   |
         4 -&gt; 7          : 98       |****************************************|
         8 -&gt; 15         : 96       |*************************************** |
        16 -&gt; 31         : 38       |***************                         |
        32 -&gt; 63         : 4        |*                                       |
        64 -&gt; 127        : 5        |**                                      |
       128 -&gt; 255        : 6        |**                                      |
       256 -&gt; 511        : 0        |                                        |
       512 -&gt; 1023       : 0        |                                        |
      1024 -&gt; 2047       : 0        |                                        |
      2048 -&gt; 4095       : 1        |                                        |
</code></pre>
<p>runqlat ä¸­ä½¿ç”¨ <code>map</code> API æ¥ä»ç”¨æˆ·æ€è®¿é—®å†…æ ¸é‡Œçš„ <code>map</code> å¹¶ç›´æ¥è¯»å–æ•°æ®ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-c">    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_lookup_elem(fd, &amp;next_key, &amp;hist);
        ...
        lookup_key = next_key;
    }
    lookup_key = -2;
    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_delete_elem(fd, &amp;next_key);
        ...
        lookup_key = next_key;
    }
</code></pre>
<p>è¿è¡Œæ—¶ wasm ä»£ç å°†ä¼šä½¿ç”¨å…±äº«å†…å­˜æ¥è®¿é—®å†…æ ¸ mapï¼Œå†…æ ¸æ€å¯ä»¥ç›´æ¥æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€ Wasm è™šæ‹Ÿæœºçš„å †æ ˆä¸­ï¼Œè€Œä¸éœ€è¦é¢å¯¹ç”¨æˆ·æ€ä¸»æœºä¾§ç¨‹åºå’Œ Wasm è¿è¡Œæ—¶ä¹‹é—´çš„é¢å¤–æ‹·è´å¼€é”€ã€‚åŒæ ·ï¼Œå¯¹äº Wasm è™šæ‹Ÿæœºå’Œå†…æ ¸æ€ä¹‹é—´å…±äº«çš„ç±»å‹å®šä¹‰ï¼Œéœ€è¦ç»è¿‡ä»”ç»†æ£€æŸ¥ä»¥ç¡®ä¿å®ƒä»¬åœ¨ Wasm å’Œå†…æ ¸æ€ä¸­çš„ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ <code>bpf_map_update_elem</code> åœ¨ç”¨æˆ·æ€ç¨‹åºå†…æ›´æ–°å†…æ ¸çš„ eBPF mapï¼Œæ¯”å¦‚:</p>
<pre><code class="language-c">        cg_map_fd = bpf_map__fd(obj-&gt;maps.cgroup_map);
        cgfd = open(env.cgroupspath, O_RDONLY);
        if (cgfd &lt; 0) {
            ...
        }
        if (bpf_map_update_elem(cg_map_fd, &amp;idx, &amp;cgfd, BPF_ANY)) {
            ...
        }
</code></pre>
<p>å› æ­¤å†…æ ¸çš„ eBPF ç¨‹åºå¯ä»¥ä» Wasm ä¾§çš„ç¨‹åºè·å–é…ç½®ï¼Œæˆ–è€…åœ¨è¿è¡Œçš„æ—¶å€™æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<h3 id="æ›´å¤šçš„ä¾‹å­socket-filter-å’Œ-lsm-1"><a class="header" href="#æ›´å¤šçš„ä¾‹å­socket-filter-å’Œ-lsm-1">æ›´å¤šçš„ä¾‹å­ï¼šsocket filter å’Œ lsm</a></h3>
<p>åœ¨ä»“åº“ä¸­ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†æ›´å¤šçš„ç¤ºä¾‹ï¼Œä¾‹å¦‚ä½¿ç”¨ socket filter ç›‘æ§å’Œè¿‡æ»¤æ•°æ®åŒ…ï¼š</p>
<pre><code class="language-c">SEC(&quot;socket&quot;)
int socket_handler(struct __sk_buff *skb)
{
    struct so_event *e;
    __u8 verlen;
    __u16 proto;
    __u32 nhoff = ETH_HLEN;

    bpf_skb_load_bytes(skb, 12, &amp;proto, 2);
    ...

    bpf_skb_load_bytes(skb, nhoff + 0, &amp;verlen, 1);
    bpf_skb_load_bytes(skb, nhoff + ((verlen &amp; 0xF) &lt;&lt; 2), &amp;(e-&gt;ports), 4);
    e-&gt;pkt_type = skb-&gt;pkt_type;
    e-&gt;ifindex = skb-&gt;ifindex;
    bpf_ringbuf_submit(e, 0);

    return skb-&gt;len;
}
</code></pre>
<p>Linux Security Modulesï¼ˆLSMï¼‰æ˜¯ä¸€ä¸ªåŸºäºé’©å­çš„æ¡†æ¶ï¼Œç”¨äºåœ¨Linuxå†…æ ¸ä¸­å®ç°å®‰å…¨ç­–ç•¥å’Œå¼ºåˆ¶è®¿é—®æ§åˆ¶ã€‚ç›´åˆ°ç°åœ¨ï¼Œèƒ½å¤Ÿå®ç°å®æ–½å®‰å…¨ç­–ç•¥ç›®æ ‡çš„æ–¹å¼åªæœ‰ä¸¤ç§é€‰æ‹©ï¼Œé…ç½®ç°æœ‰çš„LSMæ¨¡å—ï¼ˆå¦‚AppArmorã€SELinuxï¼‰ï¼Œæˆ–ç¼–å†™è‡ªå®šä¹‰å†…æ ¸æ¨¡å—ã€‚</p>
<p>Linux Kernel 5.7 å¼•å…¥äº†ç¬¬ä¸‰ç§æ–¹å¼ï¼šLSM eBPFã€‚LSM BPF å…è®¸å¼€å‘äººå‘˜ç¼–å†™è‡ªå®šä¹‰ç­–ç•¥ï¼Œè€Œæ— éœ€é…ç½®æˆ–åŠ è½½å†…æ ¸æ¨¡å—ã€‚LSM BPF ç¨‹åºåœ¨åŠ è½½æ—¶è¢«éªŒè¯ï¼Œç„¶ååœ¨è°ƒç”¨è·¯å¾„ä¸­ï¼Œåˆ°è¾¾LSMé’©å­æ—¶è¢«æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Wasm è½»é‡çº§å®¹å™¨ä¸­ï¼Œä½¿ç”¨ lsm é™åˆ¶æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼š</p>
<pre><code class="language-c">// all lsm the hook point refer https://www.kernel.org/doc/html/v5.2/security/LSM.html
SEC(&quot;lsm/path_rmdir&quot;)
int path_rmdir(const struct path *dir, struct dentry *dentry) {
  char comm[16];
  bpf_get_current_comm(comm, sizeof(comm));
  unsigned char dir_name[] = &quot;can_not_rm&quot;;
  unsigned char d_iname[32];
  bpf_probe_read_kernel(&amp;d_iname[0], sizeof(d_iname),
                        &amp;(dir-&gt;dentry-&gt;d_iname[0]));

  bpf_printk(&quot;comm %s try to rmdir %s&quot;, comm, d_iname);
  for (int i = 0;i&lt;sizeof(dir_name);i++){
    if (d_iname[i]!=dir_name[i]){
        return 0;
    }
  }
  return -1;
}
</code></pre>
<h2 id="æ€»ç»“"><a class="header" href="#æ€»ç»“">æ€»ç»“</a></h2>
<p>æœ¬ä»¥ C/C++ è¯­è¨€ä¸ºä¾‹ï¼Œè®¨è®ºäº†å¦‚ä½•ä½¿ç”¨ C/C++ ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm æ¨¡å—ã€‚æ›´å®Œæ•´çš„ä»£ç ï¼Œè¯·å‚è€ƒæˆ‘ä»¬çš„ Github ä»“åº“ï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a>.</p>
<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šè®¨è®ºä½¿ç”¨ Rust ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm æ¨¡å—ï¼Œå¹¶ä½¿ç”¨ OCI é•œåƒå‘å¸ƒã€éƒ¨ç½²ã€ç®¡ç† eBPF ç¨‹åºï¼Œè·å¾—ç±»ä¼¼ Docker çš„ä½“éªŒã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¹Ÿä¼šç»§ç»­å®Œå–„åœ¨ Wasm ä¸­ä½¿ç”¨å¤šç§è¯­è¨€å¼€å‘å’Œè¿è¡Œ eBPF ç¨‹åºçš„ä½“éªŒï¼Œæä¾›æ›´å®Œå–„çš„ç¤ºä¾‹å’Œç”¨æˆ·æ€å¼€å‘åº“/å·¥å…·é“¾ï¼Œä»¥åŠæ›´å…·ä½“çš„åº”ç”¨åœºæ™¯ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™-1"><a class="header" href="#å‚è€ƒèµ„æ–™-1">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li>wasm-bpf Github å¼€æºåœ°å€ï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></li>
<li>ä»€ä¹ˆæ˜¯ eBPFï¼š<a href="https://ebpf.io/what-is-ebpf">https://ebpf.io/what-is-ebpf</a></li>
<li>WASI-eBPF: <a href="https://github.com/WebAssembly/WASI/issues/513">https://github.com/WebAssembly/WASI/issues/513</a></li>
<li>é¾™èœ¥ç¤¾åŒº eBPF æŠ€æœ¯æ¢ç´¢ SIG <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>eunomia-bpf é¡¹ç›®ï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>eunomia-bpf é¡¹ç›®é¾™èœ¥ Gitee é•œåƒï¼š<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
<li>Wasm-bpf: æ¶èµ· Webassembly å’Œ eBPF å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢ï¼š<a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew</a></li>
<li>å½“ WASM é‡è§ eBPF ï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åºï¼š<a href="https://zhuanlan.zhihu.com/p/573941739">https://zhuanlan.zhihu.com/p/573941739</a></li>
<li>æ•™ä½ ä½¿ç”¨eBPF LSMçƒ­ä¿®å¤Linuxå†…æ ¸æ¼æ´ï¼š<a href="https://www.bilibili.com/read/cv19597563">https://www.bilibili.com/read/cv19597563</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åœ¨-webassembly-ä¸­ä½¿ç”¨-rust-ç¼–å†™-ebpf-ç¨‹åºå¹¶å‘å¸ƒ-oci-é•œåƒ"><a class="header" href="#åœ¨-webassembly-ä¸­ä½¿ç”¨-rust-ç¼–å†™-ebpf-ç¨‹åºå¹¶å‘å¸ƒ-oci-é•œåƒ">åœ¨ WebAssembly ä¸­ä½¿ç”¨ Rust ç¼–å†™ eBPF ç¨‹åºå¹¶å‘å¸ƒ OCI é•œåƒ</a></h1>
<blockquote>
<p>ä½œè€…ï¼šäºæ¡ï¼Œéƒ‘æ˜±ç¬™</p>
</blockquote>
<p>eBPFï¼ˆextended Berkeley Packet Filterï¼‰æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„å†…æ ¸è™šæ‹Ÿæœºï¼Œå¯ä»¥è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ä¸­ï¼Œä»¥æ”¶é›†ç³»ç»Ÿå’Œç½‘ç»œä¿¡æ¯ã€‚éšç€è®¡ç®—æœºæŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼ŒeBPF çš„åŠŸèƒ½æ—¥ç›Šå¼ºå¤§ï¼Œå¹¶ä¸”å·²ç»æˆä¸ºå„ç§æ•ˆç‡é«˜æ•ˆçš„åœ¨çº¿è¯Šæ–­å’Œè·Ÿè¸ªç³»ç»Ÿï¼Œä»¥åŠæ„å»ºå®‰å…¨çš„ç½‘ç»œã€æœåŠ¡ç½‘æ ¼çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p>
<p>WebAssemblyï¼ˆWasmï¼‰æœ€åˆæ˜¯ä»¥æµè§ˆå™¨å®‰å…¨æ²™ç›’ä¸ºç›®çš„å¼€å‘çš„ï¼Œå‘å±•åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒWebAssembly å·²ç»æˆä¸ºä¸€ä¸ªç”¨äºäº‘åŸç”Ÿè½¯ä»¶ç»„ä»¶çš„é«˜æ€§èƒ½ã€è·¨å¹³å°å’Œå¤šè¯­è¨€è½¯ä»¶æ²™ç®±ç¯å¢ƒï¼ŒWasm è½»é‡çº§å®¹å™¨ä¹Ÿéå¸¸é€‚åˆä½œä¸ºä¸‹ä¸€ä»£æ— æœåŠ¡å™¨å¹³å°è¿è¡Œæ—¶ï¼Œæˆ–åœ¨è¾¹ç¼˜è®¡ç®—ç­‰èµ„æºå—é™çš„åœºæ™¯é«˜æ•ˆæ‰§è¡Œã€‚</p>
<p>ç°åœ¨ï¼Œå€ŸåŠ© Wasm-bpf ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Wasm å°† eBPF ç¨‹åºç¼–å†™ä¸ºè·¨å¹³å°çš„æ¨¡å—ï¼Œä½¿ç”¨ C/C++ å’Œ Rust ç¼–å†™ç¨‹åºã€‚é€šè¿‡åœ¨ WebAssembly ä¸­ä½¿ç”¨ eBPF ç¨‹åºï¼Œæˆ‘ä»¬ä¸ä»…è®© Wasm åº”ç”¨è·å¾— eBPF çš„é«˜æ€§èƒ½ã€å¯¹ç³»ç»Ÿæ¥å£çš„è®¿é—®èƒ½åŠ›ï¼Œè¿˜å¯ä»¥è®© eBPF ç¨‹åºäº«å—åˆ° Wasm çš„æ²™ç®±ã€çµæ´»æ€§ã€è·¨å¹³å°æ€§ã€å’ŒåŠ¨æ€åŠ è½½çš„èƒ½åŠ›ï¼Œå¹¶ä¸”ä½¿ç”¨ Wasm çš„ OCI é•œåƒæ¥æ–¹ä¾¿ã€å¿«æ·åœ°åˆ†å‘å’Œç®¡ç† eBPF ç¨‹åºã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ç±»ä¼¼ docker ä¸€æ ·ï¼Œä»äº‘ç«¯ä¸€è¡Œå‘½ä»¤è·å– Wasm è½»é‡çº§å®¹å™¨é•œåƒï¼Œå¹¶è¿è¡Œä»»æ„ eBPF ç¨‹åºã€‚é€šè¿‡ç»“åˆè¿™ä¸¤ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬å°†ä¼šç»™ eBPF å’Œ Wasm ç”Ÿæ€æ¥ä¸€ä¸ªå…¨æ–°çš„å¼€å‘ä½“éªŒï¼</p>
<h2 id="ä½¿ç”¨-wasm-bpf-å·¥å…·é“¾åœ¨-wasm-ä¸­ç¼–å†™åŠ¨æ€åŠ è½½åˆ†å‘è¿è¡Œ-ebpf-ç¨‹åº-1"><a class="header" href="#ä½¿ç”¨-wasm-bpf-å·¥å…·é“¾åœ¨-wasm-ä¸­ç¼–å†™åŠ¨æ€åŠ è½½åˆ†å‘è¿è¡Œ-ebpf-ç¨‹åº-1">ä½¿ç”¨ Wasm-bpf å·¥å…·é“¾åœ¨ Wasm ä¸­ç¼–å†™ã€åŠ¨æ€åŠ è½½ã€åˆ†å‘è¿è¡Œ eBPF ç¨‹åº</a></h2>
<p>åœ¨å‰ä¸¤ç¯‡çŸ­æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»äº† Wasm-bpf çš„è®¾è®¡æ€è·¯ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ C/C++ åœ¨ Wasm ä¸­ç¼–å†™ eBPF ç¨‹åº:</p>
<ul>
<li>Wasm-bpf: æ¶èµ· Webassembly å’Œ eBPF å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢: <a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew</a></li>
<li>åœ¨ WebAssembly ä¸­ä½¿ç”¨ C/C++ å’Œ libbpf ç¼–å†™ eBPF ç¨‹åº: <a href="https://zhuanlan.zhihu.com/p/605542090">https://zhuanlan.zhihu.com/p/605542090</a></li>
</ul>
<p>åŸºäº Wasmï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šç§è¯­è¨€æ„å»º eBPF åº”ç”¨ï¼Œå¹¶ä»¥ç»Ÿä¸€ã€è½»é‡çº§çš„æ–¹å¼ç®¡ç†å’Œå‘å¸ƒã€‚ä»¥æˆ‘ä»¬æ„å»ºçš„ç¤ºä¾‹åº”ç”¨ bootstrap.wasm ä¸ºä¾‹ï¼Œä½¿ç”¨ C/C++ æ„å»ºçš„é•œåƒå¤§å°æœ€å°ä»…ä¸º ~90Kï¼Œå¾ˆå®¹æ˜“é€šè¿‡ç½‘ç»œåˆ†å‘ï¼Œå¹¶å¯ä»¥åœ¨ä¸åˆ° 100ms çš„æ—¶é—´å†…åœ¨å¦ä¸€å°æœºå™¨ä¸ŠåŠ¨æ€éƒ¨ç½²ã€åŠ è½½å’Œè¿è¡Œï¼Œå¹¶ä¸”ä¿ç•™è½»é‡çº§å®¹å™¨çš„éš”ç¦»ç‰¹æ€§ã€‚è¿è¡Œæ—¶ä¸éœ€è¦å†…æ ¸ç‰¹å®šç‰ˆæœ¬å¤´æ–‡ä»¶ã€LLVMã€clang ç­‰ä¾èµ–ï¼Œä¹Ÿä¸éœ€è¦åšä»»ä½•æ¶ˆè€—èµ„æºçš„é‡é‡çº§çš„ç¼–è¯‘å·¥ä½œã€‚å¯¹äº Rust è€Œè¨€ï¼Œç¼–è¯‘äº§ç‰©ä¼šç¨å¤§ä¸€ç‚¹ï¼Œå¤§çº¦åœ¨ 2M å·¦å³ã€‚</p>
<p>æœ¬æ–‡å°†ä»¥ Rust è¯­è¨€ä¸ºä¾‹ï¼Œè®¨è®ºï¼š</p>
<ul>
<li>ä½¿ç”¨ Rust ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm æ¨¡å—</li>
<li>ä½¿ç”¨ OCI é•œåƒå‘å¸ƒã€éƒ¨ç½²ã€ç®¡ç† eBPF ç¨‹åºï¼Œè·å¾—ç±»ä¼¼ Docker çš„ä½“éªŒ</li>
</ul>
<p>æˆ‘ä»¬åœ¨ä»“åº“ä¸­æä¾›äº†å‡ ä¸ªç¤ºä¾‹ç¨‹åºï¼Œåˆ†åˆ«å¯¹åº”äºå¯è§‚æµ‹ã€ç½‘ç»œã€å®‰å…¨ç­‰å¤šç§åœºæ™¯ã€‚</p>
<h2 id="ç¼–å†™-ebpf-ç¨‹åºå¹¶ç¼–è¯‘ä¸º-wasm-çš„å¤§è‡´æµç¨‹"><a class="header" href="#ç¼–å†™-ebpf-ç¨‹åºå¹¶ç¼–è¯‘ä¸º-wasm-çš„å¤§è‡´æµç¨‹">ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm çš„å¤§è‡´æµç¨‹</a></h2>
<p>ä¸€èˆ¬è¯´æ¥ï¼Œåœ¨é Wasm æ²™ç®±çš„ç”¨æˆ·æ€ç©ºé—´ï¼Œä½¿ç”¨ libbpf-bootstrap è„šæ‰‹æ¶ï¼Œå¯ä»¥å¿«é€Ÿã€è½»æ¾åœ°ä½¿ç”¨ C/C++æ„å»º BPF åº”ç”¨ç¨‹åºã€‚ç¼–è¯‘ã€æ„å»ºå’Œè¿è¡Œ eBPF ç¨‹åºï¼ˆæ— è®ºæ˜¯é‡‡ç”¨ä»€ä¹ˆè¯­è¨€ï¼‰ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>ç¼–å†™å†…æ ¸æ€ eBPF ç¨‹åºçš„ä»£ç ï¼Œä¸€èˆ¬ä½¿ç”¨ C/C++ æˆ– Rust è¯­è¨€</li>
<li>ä½¿ç”¨ clang ç¼–è¯‘å™¨æˆ–è€…ç›¸å…³å·¥å…·é“¾ç¼–è¯‘ eBPF ç¨‹åºï¼ˆè¦å®ç°è·¨å†…æ ¸ç‰ˆæœ¬ç§»æ¤çš„è¯ï¼Œéœ€è¦åŒ…å« BTF ä¿¡æ¯ï¼‰ã€‚</li>
<li>åœ¨ç”¨æˆ·æ€çš„å¼€å‘ç¨‹åºä¸­ï¼Œç¼–å†™å¯¹åº”çš„åŠ è½½ã€æ§åˆ¶ã€æŒ‚è½½ã€æ•°æ®å¤„ç†é€»è¾‘ï¼›</li>
<li>åœ¨å®é™…è¿è¡Œçš„é˜¶æ®µï¼Œä»ç”¨æˆ·æ€å°† eBPF ç¨‹åºåŠ è½½è¿›å…¥å†…æ ¸ï¼Œå¹¶å®é™…æ‰§è¡Œã€‚</li>
</ul>
<h2 id="ä½¿ç”¨-rust-ç¼–å†™-ebpf-ç¨‹åºå¹¶ç¼–è¯‘ä¸º-wasm"><a class="header" href="#ä½¿ç”¨-rust-ç¼–å†™-ebpf-ç¨‹åºå¹¶ç¼–è¯‘ä¸º-wasm">ä½¿ç”¨ Rust ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm</a></h2>
<p>Rust å¯èƒ½æ˜¯ WebAssembly ç”Ÿæ€ç³»ç»Ÿä¸­æ”¯æŒæœ€å¥½çš„è¯­è¨€ã€‚Rust ä¸ä»…æ”¯æŒå‡ ä¸ª WebAssembly ç¼–è¯‘ç›®æ ‡ï¼Œè€Œä¸” wasmtimeã€Spinã€Wagi å’Œå…¶ä»–è®¸å¤š WebAssembly å·¥å…·éƒ½æ˜¯ç”¨ Rust ç¼–å†™çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿæä¾›äº† Rust çš„å¼€å‘ç¤ºä¾‹ï¼š</p>
<ul>
<li>Wasm å’Œ WASI çš„ Rust ç”Ÿæ€ç³»ç»Ÿéå¸¸æ£’</li>
<li>è®¸å¤š Wasm å·¥å…·éƒ½æ˜¯ç”¨ Rust ç¼–å†™çš„ï¼Œè¿™æ„å‘³ç€æœ‰å¤§é‡çš„ä»£ç å¯ä»¥å¤ç”¨ã€‚</li>
<li>Spin é€šå¸¸åœ¨å¯¹å…¶ä»–è¯­è¨€çš„æ”¯æŒä¹‹å‰å°±æœ‰Rustçš„åŠŸèƒ½æ”¯æŒ</li>
<li>Wasmtime æ˜¯ç”¨ Rustç¼–å†™çš„ï¼Œé€šå¸¸åœ¨å…¶ä»–è¿è¡Œæ—¶ä¹‹å‰å°±æœ‰æœ€å…ˆè¿›çš„åŠŸèƒ½ã€‚</li>
<li>å¯ä»¥åœ¨ WebAssembly ä¸­ä½¿ç”¨è®¸å¤šç°æˆçš„ Rust åº“ã€‚</li>
<li>ç”±äº Cargo çš„çµæ´»æ„å»ºç³»ç»Ÿï¼Œä¸€äº› Crates ç”šè‡³æœ‰ç‰¹æ®Šçš„åŠŸèƒ½æ ‡å¿—æ¥å¯ç”¨Wasmçš„åŠŸèƒ½ï¼ˆä¾‹å¦‚Chronoï¼‰ã€‚</li>
<li>ç”±äº Rust çš„å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œä¸åŒç±»è¯­è¨€ç›¸æ¯”ï¼ŒRust çš„äºŒè¿›åˆ¶å¤§å°å¾ˆå°ã€‚</li>
</ul>
<p>æˆ‘ä»¬åŒæ ·æä¾›äº†ä¸€ä¸ª Rust çš„ eBPF SDKï¼Œå¯ä»¥ä½¿ç”¨ Rust ç¼–å†™ eBPF çš„ç”¨æˆ·æ€ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasmã€‚å€ŸåŠ© aya-rs æä¾›çš„ç›¸å…³å·¥å…·é“¾æ”¯æŒï¼Œå†…æ ¸æ€çš„ eBPF ç¨‹åºä¹Ÿå¯ä»¥ç”¨ Rust è¿›è¡Œç¼–å†™ï¼Œä¸è¿‡åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜æ˜¯å¤ç”¨ä¹‹å‰ä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„å†…æ ¸æ€ç¨‹åºã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ rust æä¾›çš„ wasi å·¥å…·é“¾ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼š</p>
<pre><code class="language-sh">rustup target add wasm32-wasi
cargo new rust-helloworld
</code></pre>
<p>ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ <code>Makefile</code> è¿è¡Œ make å®Œæˆæ•´ä¸ªç¼–è¯‘æµç¨‹ï¼Œå¹¶ç”Ÿæˆ <code>bootstrap.bpf.o</code> eBPF å­—èŠ‚ç æ–‡ä»¶ã€‚</p>
<h3 id="ä½¿ç”¨-wit-bindgen-ç”Ÿæˆç±»å‹ä¿¡æ¯ç”¨äºå†…æ ¸æ€å’Œ-wasm-æ¨¡å—ä¹‹é—´é€šä¿¡"><a class="header" href="#ä½¿ç”¨-wit-bindgen-ç”Ÿæˆç±»å‹ä¿¡æ¯ç”¨äºå†…æ ¸æ€å’Œ-wasm-æ¨¡å—ä¹‹é—´é€šä¿¡">ä½¿ç”¨ wit-bindgen ç”Ÿæˆç±»å‹ä¿¡æ¯ï¼Œç”¨äºå†…æ ¸æ€å’Œ Wasm æ¨¡å—ä¹‹é—´é€šä¿¡</a></h3>
<p>wit-bindgen é¡¹ç›®æ˜¯ä¸€å¥—ç€çœ¼äº WebAssemblyï¼Œå¹¶ä½¿ç”¨ç»„ä»¶æ¨¡å‹çš„è¯­è¨€çš„ç»‘å®šç”Ÿæˆå™¨ã€‚ç»‘å®šæ˜¯ç”¨ *.wit æ–‡ä»¶æè¿°çš„ï¼Œæ–‡ä»¶ä¸­æè¿°äº† Wasm æ¨¡å—å¯¼å…¥ã€å¯¼å‡ºçš„å‡½æ•°å’Œæ¥å£ã€‚æˆ‘ä»¬å¯ä»¥ wit-bindgen å®ƒæ¥ç”Ÿæˆå¤šç§è¯­è¨€çš„ç±»å‹å®šä¹‰ï¼Œä»¥ä¾¿åœ¨å†…æ ¸æ€çš„ eBPF å’Œç”¨æˆ·æ€çš„ Wasm æ¨¡å—ä¹‹é—´ä¼ é€’æ•°æ®ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨ <code>Cargo.toml</code> é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ <code>wasm-bpf-binding</code> å’Œ <code>wit-bindgen-guest-rust</code> ä¾èµ–ï¼š</p>
<pre><code class="language-toml">wasm-bpf-binding = { path = &quot;wasm-bpf-binding&quot; }
</code></pre>
<p>è¿™ä¸ªåŒ…æä¾›äº† wasm-bpf ç”±è¿è¡Œæ—¶æä¾›ç»™ Wasm æ¨¡å—ï¼Œç”¨äºåŠ è½½å’Œæ§åˆ¶ eBPF ç¨‹åºçš„å‡½æ•°çš„ç»‘å®šã€‚</p>
<ul>
<li><code>wasm-bpf-binding</code> åœ¨ wasm-bpf ä»“åº“ä¸­æœ‰æä¾›ã€‚</li>
</ul>
<pre><code class="language-toml">[dependencies]
wit-bindgen-guest-rust = { git = &quot;https://github.com/bytecodealliance/wit-bindgen&quot;, version = &quot;0.3.0&quot; }

[patch.crates-io]
wit-component = {git = &quot;https://github.com/bytecodealliance/wasm-tools&quot;, version = &quot;0.5.0&quot;, rev = &quot;9640d187a73a516c42b532cf2a10ba5403df5946&quot;}
wit-parser = {git = &quot;https://github.com/bytecodealliance/wasm-tools&quot;, version = &quot;0.5.0&quot;, rev = &quot;9640d187a73a516c42b532cf2a10ba5403df5946&quot;}
</code></pre>
<p>è¿™ä¸ªåŒ…æ”¯æŒç”¨ wit æ–‡ä»¶ä¸º rust å®¢æˆ·ç¨‹åºç”Ÿæˆç»‘å®šã€‚ä½¿ç”¨è¿™ä¸ªåŒ…çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦å†æ‰‹åŠ¨è¿è¡Œ wit-bindgenã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>btf2wit</code> å·¥å…·ï¼Œä» BTF ä¿¡æ¯ç”Ÿæˆ wit æ–‡ä»¶ã€‚å¯ä»¥ä½¿ç”¨ <code>cargo install btf2wit</code> å®‰è£…æˆ‘ä»¬æä¾›çš„ btf2wit å·¥å…·ï¼Œå¹¶ç¼–è¯‘ç”Ÿæˆ wit ä¿¡æ¯ï¼š</p>
<pre><code class="language-console">cd btf
clang -target bpf -g event-def.c -c -o event.def.o
btf2wit event.def.o -o event-def.wit
cp *.wit ../wit/
</code></pre>
<ul>
<li>å…¶ä¸­ <code>event-def.c</code> æ˜¯åŒ…å«äº†æˆ‘ä»¬éœ€è¦çš„ç»“æ„ä½“ä¿¡æ¯çš„çš„ C ç¨‹åºæ–‡ä»¶ã€‚åªæœ‰åœ¨å¯¼å‡ºç¬¦å·ä¸­ç”¨åˆ°çš„ç»“æ„ä½“æ‰ä¼šè¢«è®°å½•åœ¨ BTF ä¸­ã€‚</li>
</ul>
<p>å¯¹äº C ç»“æ„ä½“ç”Ÿæˆçš„ wit ä¿¡æ¯ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="language-wit">default world host {
    record event {
         pid: s32,
        ppid: s32,
        exit-code: u32,
        --pad0: list&lt;s8&gt;,
        duration-ns: u64,
        comm: list&lt;s8&gt;,
        filename: list&lt;s8&gt;,
        exit-event: s8,
    }
}
</code></pre>
<p><code>wit-bindgen-guest-rust</code> ä¼šä¸º wit æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ç±»å‹ä¿¡æ¯ï¼Œè‡ªåŠ¨ç”Ÿæˆ rust çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[repr(C, packed)]
#[derive(Debug, Copy, Clone)]
struct Event {
    pid: i32,
    ppid: i32,
    exit_code: u32,
    __pad0: [u8; 4],
    duration_ns: u64,
    comm: [u8; 16],
    filename: [u8; 127],
    exit_event: u8,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="ç¼–å†™ç”¨æˆ·æ€åŠ è½½å’Œå¤„ç†ä»£ç "><a class="header" href="#ç¼–å†™ç”¨æˆ·æ€åŠ è½½å’Œå¤„ç†ä»£ç ">ç¼–å†™ç”¨æˆ·æ€åŠ è½½å’Œå¤„ç†ä»£ç </a></h3>
<p>ä¸ºäº†åœ¨ WASI ä¸Šè¿è¡Œï¼Œéœ€è¦ä¸º main.rs æ·»åŠ  <code>#![no_main]</code> å±æ€§ï¼Œå¹¶ä¸” main å‡½æ•°éœ€è¦é‡‡ç”¨ç±»ä¼¼å¦‚ä¸‹çš„å½¢æ€ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[export_name = &quot;__main_argc_argv&quot;]
fn exam_main(_env_json: u32, _str_len: i32) -&gt; i32 {

    return 0;
}
<span class="boring">}</span></code></pre></pre>
<p>ç”¨æˆ·æ€åŠ è½½å’ŒæŒ‚è½½ä»£ç ï¼Œå’Œ C/C++ ä¸­ç±»ä¼¼ï¼š</p>
<pre><code class="language-rust ignore">    let obj_ptr =
        binding::wasm_load_bpf_object(bpf_object.as_ptr() as u32, bpf_object.len() as i32);
    if obj_ptr == 0 {
        println!(&quot;Failed to load bpf object&quot;);
        return 1;
    }
    let attach_result = binding::wasm_attach_bpf_program(
        obj_ptr,
        &quot;handle_exec\0&quot;.as_ptr() as u32,
        &quot;\0&quot;.as_ptr() as u32,
    );
    ..</code></pre>
<p>polling ring bufferï¼š</p>
<pre><code class="language-rust ignore">    let map_fd = binding::wasm_bpf_map_fd_by_name(obj_ptr, &quot;rb\0&quot;.as_ptr() as u32);
    if map_fd &lt; 0 {
        println!(&quot;Failed to get map fd: {}&quot;, map_fd);
        return 1;
    }
    // binding::wasm
    let buffer = [0u8; 256];
    loop {
        // polling the buffer
        binding::wasm_bpf_buffer_poll(
            obj_ptr,
            map_fd,
            handle_event as i32,
            0,
            buffer.as_ptr() as u32,
            buffer.len() as i32,
            100,
        );
    }</code></pre>
<p>ä½¿ç”¨ handler æ¥æ”¶è¿”å›å€¼ï¼š</p>
<pre><code class="language-rust ignore">
extern &quot;C&quot; fn handle_event(_ctx: u32, data: u32, _data_sz: u32) {
    let event_slice = unsafe { slice::from_raw_parts(data as *const Event, 1) };
    let event = &amp;event_slice[0];
    let pid = event.pid;
    let ppid = event.ppid;
    let exit_code = event.exit_code;
    if event.exit_event == 1 {
        print!(
            &quot;{:&lt;8} {:&lt;5} {:&lt;16} {:&lt;7} {:&lt;7} [{}]&quot;,
            &quot;TIME&quot;,
            &quot;EXIT&quot;,
            unsafe { CStr::from_ptr(event.comm.as_ptr() as *const i8) }
                .to_str()
                .unwrap(),
            pid,
            ppid,
            exit_code
        );
        ..
}</code></pre>
<p>æ¥ä¸‹æ¥å³å¯ä½¿ç”¨ cargo ç¼–è¯‘è¿è¡Œï¼š</p>
<pre><code class="language-console">$ cargo build --target wasi32-wasm
$ sudo wasm-bpf ./target/wasm32-wasi/debug/rust-helloworld.wasm
TIME     EXEC  sh               180245  33666   /bin/sh
TIME     EXEC  which            180246  180245  /usr/bin/which
TIME     EXIT  which            180246  180245  [0] (1ms)
TIME     EXIT  sh               180245  33666   [0] (3ms)
TIME     EXEC  sh               180247  33666   /bin/sh
TIME     EXEC  ps               180248  180247  /usr/bin/ps
TIME     EXIT  ps               180248  180247  [0] (23ms)
TIME     EXIT  sh               180247  33666   [0] (25ms)
TIME     EXEC  sh               180249  33666   /bin/sh
TIME     EXEC  cpuUsage.sh      180250  180249  /root/.vscode-server-insiders/bin/a7d49b0f35f50e460835a55d20a00a735d1665a3/out/vs/base/node/cpuUsage.sh
</code></pre>
<h2 id="ä½¿ç”¨-oci-é•œåƒå‘å¸ƒå’Œç®¡ç†-ebpf-ç¨‹åº"><a class="header" href="#ä½¿ç”¨-oci-é•œåƒå‘å¸ƒå’Œç®¡ç†-ebpf-ç¨‹åº">ä½¿ç”¨ OCI é•œåƒå‘å¸ƒå’Œç®¡ç† eBPF ç¨‹åº</a></h2>
<p>å¼€æ”¾å®¹å™¨åè®® (OCI) æ˜¯ä¸€ä¸ªè½»é‡çº§ï¼Œå¼€æ”¾çš„æ²»ç†ç»“æ„ï¼Œä¸ºå®¹å™¨æŠ€æœ¯å®šä¹‰äº†è§„èŒƒå’Œæ ‡å‡†ã€‚åœ¨ Linux åŸºé‡‘ä¼šçš„æ”¯æŒä¸‹æˆç«‹ï¼Œç”±å„å¤§è½¯ä»¶ä¼ä¸šæ„æˆï¼Œè‡´åŠ›äºå›´ç»•å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶åˆ›å»ºå¼€æ”¾çš„è¡Œä¸šæ ‡å‡†ã€‚å…¶ä¸­åŒ…æ‹¬äº†ä½¿ç”¨ Container Registries è¿›è¡Œå·¥ä½œçš„ APIï¼Œæ­£å¼åç§°ä¸º OCI åˆ†å‘è§„èŒƒ (åˆåâ€œdistribution-specâ€)ã€‚</p>
<p>Docker ä¹Ÿå®£å¸ƒæ¨å‡ºä¸ WebAssembly é›†æˆ (Docker+Wasm) çš„é¦–ä¸ªæŠ€æœ¯é¢„è§ˆç‰ˆï¼Œå¹¶è¡¨ç¤ºå…¬å¸å·²åŠ å…¥å­—èŠ‚ç è”ç›Ÿ (Bytecode Alliance)ï¼Œæˆä¸ºæŠ•ç¥¨æˆå‘˜ã€‚Docker+Wasm è®©å¼€å‘è€…èƒ½å¤Ÿæ›´å®¹æ˜“åœ°å¿«é€Ÿæ„å»ºé¢å‘ Wasm è¿è¡Œæ—¶çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>å€ŸåŠ©äº Wasm çš„ç›¸å…³ç”Ÿæ€ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°å‘å¸ƒã€ä¸‹è½½å’Œç®¡ç† eBPF ç¨‹åºï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨ <code>wasm-to-oci</code> å·¥å…·ï¼Œå¯ä»¥å°† Wasm ç¨‹åºæ‰“åŒ…ä¸º OCI é•œåƒï¼Œè·å–ç±»ä¼¼ docker çš„ä½“éªŒï¼š</p>
<pre><code class="language-console">wasm-to-oci push testdata/hello.wasm &lt;oci-registry&gt;.azurecr.io/wasm-to-oci:v1
wasm-to-oci pull &lt;oci-registry&gt;.azurecr.io/wasm-to-oci:v1 --out test.wasm
</code></pre>
<p>æˆ‘ä»¬ä¹Ÿå°†å…¶é›†æˆåˆ°äº† eunomia-bpf çš„ ecli å·¥å…·ä¸­ï¼Œå¯ä»¥ä¸€è¡Œå‘½ä»¤ä»äº‘ç«¯çš„ Github Packages ä¸­ä¸‹è½½å¹¶è¿è¡Œ eBPF ç¨‹åºï¼Œæˆ–é€šè¿‡ Github Packages å‘å¸ƒï¼š</p>
<pre><code class="language-bash"># push to Github Packages
ecli push https://ghcr.io/eunomia-bpf/sigsnoop:latest
# pull from Github Packages
ecli pull https://ghcr.io/eunomia-bpf/sigsnoop:latest
# run eBPF program
ecli run https://ghcr.io/eunomia-bpf/sigsnoop:latest
</code></pre>
<p>æˆ‘ä»¬å·²ç»åœ¨ LMP é¡¹ç›®çš„ eBPF Hub ä¸­ï¼Œæœ‰ä¸€äº›åˆ›å»ºç¬¦åˆ OCI æ ‡å‡†çš„ Wasm-eBPF åº”ç”¨ç¨‹åºï¼Œå¹¶åˆ©ç”¨ ORAS ç®€åŒ–æ‰©å±• eBPF åº”ç”¨å¼€å‘ï¼Œåˆ†å‘ã€åŠ è½½ã€è¿è¡Œèƒ½åŠ›çš„å°è¯•[11]ï¼Œä»¥åŠåŸºäº Wasm åŒæ—¶ä½¿ç”¨å¤šç§ä¸åŒè¯­è¨€å¼€å‘ eBPF çš„ç”¨æˆ·æ€æ•°æ®å¤„ç†æ’ä»¶çš„å®è·µã€‚åŸºäºæœ€æ–°çš„ Wasm-bpf æ¡†æ¶ï¼Œæœ‰æ›´å¤šçš„æ¢ç´¢æ€§å·¥ä½œå¯ä»¥ç»§ç»­å±•å¼€ï¼Œæˆ‘ä»¬å¸Œæœ›å°è¯•æ„å»ºä¸€ä¸ªå®Œæ•´çš„é’ˆå¯¹ eBPF å’Œ Wasm ç¨‹åºçš„åŒ…ç®¡ç†ç³»ç»Ÿï¼Œä»¥åŠæ›´å¤šçš„å¯ä»¥æ¢ç´¢çš„åº”ç”¨åœºæ™¯ã€‚</p>
<h2 id="æ€»ç»“-1"><a class="header" href="#æ€»ç»“-1">æ€»ç»“</a></h2>
<p>æœ¬æ–‡ä»¥ Rust è¯­è¨€ä¸ºä¾‹ï¼Œè®¨è®ºäº†ä½¿ç”¨ Rust ç¼–å†™ eBPF ç¨‹åºå¹¶ç¼–è¯‘ä¸º Wasm æ¨¡å—ä»¥åŠä½¿ç”¨ OCI é•œåƒå‘å¸ƒã€éƒ¨ç½²ã€ç®¡ç† eBPF ç¨‹åºï¼Œè·å¾—ç±»ä¼¼ Docker çš„ä½“éªŒã€‚æ›´å®Œæ•´çš„ä»£ç ï¼Œè¯·å‚è€ƒæˆ‘ä»¬çš„ Github ä»“åº“ï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a>.</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šç»§ç»­å®Œå–„åœ¨ Wasm ä¸­ä½¿ç”¨å¤šç§è¯­è¨€å¼€å‘å’Œè¿è¡Œ eBPF ç¨‹åºçš„ä½“éªŒï¼Œæä¾›æ›´å®Œå–„çš„ç¤ºä¾‹å’Œç”¨æˆ·æ€å¼€å‘åº“/å·¥å…·é“¾ï¼Œä»¥åŠæ›´å…·ä½“çš„åº”ç”¨åœºæ™¯ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™-2"><a class="header" href="#å‚è€ƒèµ„æ–™-2">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li>wasm-bpf Github å¼€æºåœ°å€ï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></li>
<li>ä»€ä¹ˆæ˜¯ eBPFï¼š<a href="https://ebpf.io/what-is-ebpf">https://ebpf.io/what-is-ebpf</a></li>
<li>WASI-eBPF: <a href="https://github.com/WebAssembly/WASI/issues/513">https://github.com/WebAssembly/WASI/issues/513</a></li>
<li>é¾™èœ¥ç¤¾åŒº eBPF æŠ€æœ¯æ¢ç´¢ SIG <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>eunomia-bpf é¡¹ç›®ï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>eunomia-bpf é¡¹ç›®é¾™èœ¥ Gitee é•œåƒï¼š<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
<li>Wasm-bpf: æ¶èµ· Webassembly å’Œ eBPF å†…æ ¸å¯ç¼–ç¨‹çš„æ¡¥æ¢ï¼š<a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew</a></li>
<li>å½“ Wasm é‡è§ eBPF ï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åºï¼š<a href="https://zhuanlan.zhihu.com/p/573941739">https://zhuanlan.zhihu.com/p/573941739</a></li>
<li>Docker+WasmæŠ€æœ¯é¢„è§ˆï¼š<a href="https://zhuanlan.zhihu.com/p/583614628">https://zhuanlan.zhihu.com/p/583614628</a></li>
<li>LMP eBPF-Hub: <a href="https://github.com/linuxkerneltravel/lmp">https://github.com/linuxkerneltravel/lmp</a></li>
<li>wasm-to-oci: <a href="https://github.com/engineerd/wasm-to-oci">https://github.com/engineerd/wasm-to-oci</a></li>
<li>btf2wit: <a href="https://github.com/eunomia-bpf/btf2wit">https://github.com/eunomia-bpf/btf2wit</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä½¿ç”¨-chatgpt-é€šè¿‡è‡ªç„¶è¯­è¨€ç¼–å†™-ebpf-ç¨‹åºå’Œè¿½è¸ª-linux-ç³»ç»Ÿ"><a class="header" href="#ä½¿ç”¨-chatgpt-é€šè¿‡è‡ªç„¶è¯­è¨€ç¼–å†™-ebpf-ç¨‹åºå’Œè¿½è¸ª-linux-ç³»ç»Ÿ">ä½¿ç”¨ ChatGPT ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€ç¼–å†™ eBPF ç¨‹åºå’Œè¿½è¸ª Linux ç³»ç»Ÿ</a></h1>
<p>eBPF æ˜¯ä¸€é¡¹é©å‘½æ€§çš„æŠ€æœ¯ï¼Œèµ·æºäº Linux å†…æ ¸ï¼Œå¯ä»¥åœ¨æ“ä½œç³»ç»Ÿçš„å†…æ ¸ä¸­è¿è¡Œæ²™ç›’ç¨‹åºã€‚å®ƒè¢«ç”¨æ¥å®‰å…¨å’Œæœ‰æ•ˆåœ°æ‰©å±•å†…æ ¸çš„åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦æ”¹å˜å†…æ ¸çš„æºä»£ç æˆ–åŠ è½½å†…æ ¸æ¨¡å—ã€‚ä»Šå¤©ï¼ŒeBPFè¢«å¹¿æ³›ç”¨äºå„ç±»åœºæ™¯ï¼šåœ¨ç°ä»£æ•°æ®ä¸­å¿ƒå’Œäº‘åŸç”Ÿç¯å¢ƒä¸­ï¼Œå¯ä»¥æä¾›é«˜æ€§èƒ½çš„ç½‘ç»œåŒ…å¤„ç†å’Œè´Ÿè½½å‡è¡¡ï¼›ä»¥éå¸¸ä½çš„èµ„æºå¼€é”€ï¼Œåšåˆ°å¯¹å¤šç§ç»†ç²’åº¦æŒ‡æ ‡çš„å¯è§‚æµ‹æ€§ï¼Œå¸®åŠ©åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜è·Ÿè¸ªåº”ç”¨ç¨‹åºï¼Œä¸ºæ€§èƒ½æ•…éšœæ’é™¤æä¾›æ´å¯ŸåŠ›ï¼›ä¿éšœåº”ç”¨ç¨‹åºå’Œå®¹å™¨è¿è¡Œæ—¶çš„å®‰å…¨æ‰§è¡Œï¼Œç­‰ç­‰ã€‚eBPF å·²ç»æˆä¸ºäº†ä¸€ä¸ªè¶Šæ¥è¶Šå—æ¬¢è¿çš„æŠ€æœ¯ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ é«˜æ•ˆåœ°å¯¹å†…æ ¸å’Œç”¨æˆ·æ€çš„å‡ ä¹æ‰€æœ‰åº”ç”¨è¿›è¡Œè¿½è¸ªå’Œåˆ†æã€‚</p>
<p>ä½†æ˜¯ï¼ŒeBPF çš„å¼€å‘ï¼Œæˆ–è€…è¿½è¸ªå†…æ ¸äº§ç”Ÿçš„å„ç±»äº‹ä»¶ï¼Œéœ€è¦ä¸€å®šçš„ä¸“ä¸šçŸ¥è¯†ï¼Œå¯¹äºä¸€äº›ä¸ç†Ÿæ‚‰è¯¥æŠ€æœ¯çš„å¼€å‘äººå‘˜æ¥è¯´ï¼Œå¯èƒ½ä¼šæœ‰ä¸€å®šçš„å›°éš¾ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬çš„ demo å·¥å…· GPTtrace æ‰€å¸¦æ¥çš„ä¸€äº›æ–°çš„æ€è·¯ï¼Œä¹Ÿè®¸å°±å¯ä»¥å¸®åŠ©ä½ è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒä½¿ç”¨ ChatGPT ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€ç¼–å†™ eBPF ç¨‹åºå’Œè¿½è¸ª Linux å†…æ ¸ï¼š<a href="https://github.com/eunomia-bpf/GPTtrace">https://github.com/eunomia-bpf/GPTtrace</a></p>
<p>å¦‚æœä½ æ˜¯ä¸€åå¼€å‘äººå‘˜ï¼Œæƒ³è¦æ›´åŠ é«˜æ•ˆåœ°è¿›è¡Œè¿½è¸ªå’Œåˆ†æï¼Œé‚£ä¹ˆç±»ä¼¼çš„æ–¹æ¡ˆç»å¯¹å€¼å¾—å°è¯•ï¼šè¿™ç§ ChatGPT å’Œ eBPF æŠ€æœ¯çš„ç»“åˆå°†åœ¨æœªæ¥çš„è½¯ä»¶å¼€å‘ã€è°ƒè¯•ã€ä»¥åŠå¯è§‚æµ‹æ€§åœºæ™¯ä¸­å‘æŒ¥æ›´åŠ é‡è¦çš„ä½œç”¨ï¼ŒåŒæ—¶å®ƒå¯èƒ½ä¹Ÿä¼šå¸¦æ¥ä¸€ç§å…¨æ–°çš„ã€äº¤äº’å¼åœ°å­¦ä¹ èŒƒå¼ã€‚</p>
<h2 id="æˆ‘ä»¬åšäº†å“ªäº›å°è¯•"><a class="header" href="#æˆ‘ä»¬åšäº†å“ªäº›å°è¯•">æˆ‘ä»¬åšäº†å“ªäº›å°è¯•ï¼Ÿ</a></h2>
<p>GPTtrace ä½¿ç”¨ ChatGPT æŠ€æœ¯ï¼Œå…è®¸å¼€å‘äººå‘˜é€šè¿‡è‡ªç„¶è¯­è¨€ç¼–å†™ eBPF ç¨‹åºå’Œè¿½è¸ª Linux å†…æ ¸ï¼Œæ— éœ€äº‹å…ˆäº†è§£è¯¥æŠ€æœ¯çš„ä¸“ä¸šçŸ¥è¯†ã€‚å®ƒä½¿å¾—å¼€å‘äººå‘˜å¯ä»¥æ›´å¿«ã€æ›´å‡†ç¡®åœ°å®šä½å’Œè§£å†³è½¯ä»¶ä¸­çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œæ ¹æ®è¿›ç¨‹åç§°ç»Ÿè®¡ Page Faults æ¬¡æ•°ï¼š</p>
<p><img src="blog/result.gif" alt="result" /></p>
<p>æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªè§†é¢‘æ¼”ç¤ºä¸è®²è§£ï¼Œå¯ä»¥åœ¨è¿™é‡Œè§‚çœ‹ï¼š<a href="https://www.bilibili.com/video/BV1oM411J7gp/"><a href="https://www.bilibili.com/video/BV1oM411J7gp/">https://www.bilibili.com/video/BV1oM411J7gp/</a></a></p>
<h2 id="æˆ‘ä»¬æ˜¯æ€æ ·åšåˆ°çš„"><a class="header" href="#æˆ‘ä»¬æ˜¯æ€æ ·åšåˆ°çš„">æˆ‘ä»¬æ˜¯æ€æ ·åšåˆ°çš„ï¼Ÿ</a></h2>
<p>æˆ‘ä»¬ç›®å‰çš„æ€è·¯æ˜¯é€šè¿‡é¢„è®­ç»ƒ eBPF ç¨‹åºï¼Œè®© ChatGPT å­¦ä¼šå¦‚ä½•ç¼–å†™å„ç§ eBPF ç¨‹åºæˆ– bpftrace çš„ DSLã€‚å¤§æ¦‚åˆ†ä¸ºè¿™å‡ æ­¥ï¼š</p>
<ol>
<li>é¢„è®­ç»ƒ ebpf ç¨‹åºï¼Œåˆ©ç”¨ä¸€äº› ebpf çš„å¼€å‘èµ„æ–™ï¼Œå…ˆå’Œ ChatGPT å¯¹è¯å¤šæ¬¡ï¼Œè®© ChatGPT é€šè¿‡å¯¹è¯ä¸Šä¸‹æ–‡å¦‚ä½•å†™å„ç§ eBPF ç¨‹åºæˆ–è€… bpftrace çš„ DSLï¼ˆå…¶å®æˆ‘ä»¬åœ¨åäºŒæœˆä»½å°±åšè¿‡ä¸€äº›ç±»ä¼¼çš„å®è·µï¼Œäº§å‡ºäº†ä¸€ä»½æ•™ç¨‹æ–‡æ¡£ï¼Œä½†æ²¡æœ‰æŠŠå®ƒå˜æˆä¸€ä»½å·¥å…·ï¼š<a href="https://github.com/eunomia-bpf/bpf-developer-tutorial">https://github.com/eunomia-bpf/bpf-developer-tutorial</a>ï¼‰ï¼›</li>
<li>è°ƒç”¨ ChatGPT apiï¼Œå¹¶æŠŠè¿”å›çš„ç»“æœè§£æä¹‹åä½œä¸ºå‘½ä»¤è¾“å…¥ shell æ‰§è¡Œï¼Œæˆ–è€…å°† eBPF ç¨‹åºå†™åˆ°æ–‡ä»¶é‡Œé¢ç¼–è¯‘è¿è¡Œ</li>
<li>å¦‚æœç¼–è¯‘å’ŒåŠ è½½æŠ¥é”™ï¼ŒæŠŠå¯¹åº”çš„æŠ¥é”™ä¿¡æ¯è¿”å›ç»™ ChatGPTï¼Œè®©å®ƒå†ç”Ÿæˆä¸€ä¸ªæ–°çš„ eBPF ç¨‹åºæˆ–è€…å‘½ä»¤</li>
</ol>
<p>æˆ‘ä»¬ä½¿ç”¨äº† ChatGPT çš„ Python APIï¼ŒèŠ±äº†ä¸€ä¸ªä¸‹åˆç®€å•å®ç°äº†è¿™ä¸ªå°ç©å…·ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ä¸­æ–‡æˆ–è€…è‹±æ–‡ç­‰å¤šç§è¯­è¨€è¾“å…¥ä»»æ„è‡ªç„¶è¯­è¨€çš„æè¿°ï¼Œä¾‹å¦‚ â€œè¿½è¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶â€ &quot;Show per-second syscall rates&quot; ç­‰ç­‰ï¼Œæ­£ç¡®ç‡ä¸æ˜¯ 100%ï¼Œä¸è¿‡åæ¬¡é‡Œé¢å¤§æ¦‚å·²ç»å¯ä»¥æœ‰ä¸ƒå…«æ¬¡å¯ä»¥æ­£ç¡®è¿›è¡Œè¿½è¸ªäº†ï¼Œé‡åˆ°æŠ¥é”™è¿˜ä¼šè‡ªè¡Œè¿›è¡Œä¿®æ­£å’Œè°ƒæ•´ã€‚</p>
<h2 id="è¿›ä¸€æ­¥çš„ä¼˜åŒ–"><a class="header" href="#è¿›ä¸€æ­¥çš„ä¼˜åŒ–">è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Ÿ</a></h2>
<p>è¿™ä¸ªç©å…·é¡¹ç›®æœ¬èº«åªæ˜¯æƒ³å±•ç¤ºä¸€ä¸‹å¯èƒ½æ€§ï¼Œå¾ˆå¿«åº”è¯¥ä¼šæœ‰æ›´å¥½çš„ç±»ä¼¼ ChatGPT è¿™æ ·çš„çš„ apiï¼Œå’Œæ›´é€šç”¨çš„è®­ç»ƒ/æ‰§è¡Œæ¡†æ¶å‡ºæ¥çš„ï¼Œå¸Œæœ›å®ƒèƒ½èµ·åˆ°æŠ›ç –å¼•ç‰çš„æ•ˆæœã€‚ç›®å‰çœ‹èµ·æ¥è¿˜æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–çš„ç©ºé—´:</p>
<ol>
<li>èƒ½è”ç½‘æœç´¢ä¹‹åï¼Œè®©è¿™ä¸ªå·¥å…·å»è·å– bcc/bpftrace ä»“åº“é‡Œé¢çš„ç¤ºä¾‹ç¨‹åºå­¦ä¹ ï¼Œæ•ˆæœåº”è¯¥è¿˜ä¼šå¥½å¾ˆå¤š;</li>
<li>æˆ–è€…è®©è¿™ä¸ªåº”ç”¨è‡ªå·±èƒ½è”ç½‘æœç´¢ Stack Overflow ä¹‹ç±»çš„ç»“æœï¼ŒæŸ¥è¯¢å¦‚ä½•ç¼–å†™ eBPF ç¨‹åºï¼Œç±»ä¼¼æ–° Bing çš„æœç´¢æ–¹å¼ï¼›</li>
<li>æä¾›æ›´å¤šé«˜è´¨é‡çš„æ–‡æ¡£å’Œæ•™ç¨‹ï¼Œçœ‹èµ·æ¥è¾“å‡ºçš„å‡†ç¡®åº¦å’Œæ•™ç¨‹ã€ä»£ç ç¤ºä¾‹çš„è´¨é‡å¯†åˆ‡ç›¸å…³ï¼›</li>
<li>å…¶å®è¿˜å¯ä»¥å¤šæ¬¡è°ƒç”¨å…¶ä»–å·¥å…·æ‰§è¡Œå‘½ä»¤è¿”å›ç»“æœï¼Œæ¯”å¦‚è¯´ ChatGPT è¾“å‡ºå‘½ä»¤ï¼Œç”¨ bpftrace æŸ¥è¯¢ä¸€ä¸‹å½“å‰å†…æ ¸ç‰ˆæœ¬å’Œæ”¯æŒçš„ tracepointï¼Œç„¶åè¿”å›è¾“å‡ºï¼ˆè¿™ä¹Ÿæ˜¯ä¸€æ¬¡å¯¹è¯ï¼‰ï¼Œå†ç»™å‡ºç¨‹åºï¼Œæ•ˆæœåº”è¯¥è¿˜è¦å¥½ä¸å°‘</li>
</ol>
<p>çŸ­æœŸæ¥çœ‹ï¼Œæˆ‘ä»¬å¸Œæœ›å°è¯•åŸºäºè¿™ä¸ªå·¥å…·æ„å»ºä¸€ä¸ªäº¤äº’å¼çš„ã€å¸¦æœ‰æç¤ºçš„å†…æ ¸è¿½è¸ªå·¥å…·å’Œå­¦ä¹  eBPF ç¨‹åºçš„æ•™ç¨‹ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨ç¼–å†™ eBPF ç¨‹åºæ—¶æ›´å¿«åœ°äº†è§£è¯­æ³•å’Œè°ƒè¯•é”™è¯¯ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®ç”¨æˆ·çš„åé¦ˆè°ƒæ•´æç¤ºå’Œå»ºè®®çš„è´¨é‡ï¼›ä»¥åŠæä¾›ä¸€ä¸ªç»“æ„åŒ–çš„å­¦ä¹  eBPF ç¨‹åºçš„æ•™ç¨‹ï¼Œä»åŸºç¡€çš„è¯­æ³•å’Œ API å¼€å§‹ï¼Œç»“åˆé€šè¿‡ç”¨æˆ·æœ€ç»ˆæƒ³ç¼–å†™çš„ eBPF ç¨‹åºçš„éœ€æ±‚ï¼Œé€æ­¥å‘ç”¨æˆ·ä»‹ç»å¸¸ç”¨çš„ eBPF åº”ç”¨åœºæ™¯å’Œç¼–å†™æŠ€å·§ã€‚</p>
<p>æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œå®ƒç”šè‡³å¯ä»¥ä¸ä»…ä»…æ˜¯ä¸€ç§è¯­è¨€æ¨¡å‹ï¼Œå€ŸåŠ©ç®€å•çš„å¯¹è¯çš„äº¤äº’æ¨¡å¼ï¼Œä»¥åŠèƒ½æ“æ§å„ç±»å·¥å…·ã€è®¿é—®ç½‘ç»œçš„æ‰‹æ®µï¼Œå®ƒä¹Ÿè®¸å¯ä»¥èµ·åˆ°ä¸€ä¸ªå·¨å¤§çš„ã€å‰æ— å¤äººçš„çŸ¥è¯†åº“çš„ä½œç”¨ï¼šè¿æ¥å„è¡Œå„ä¸šï¼Œæ ¹æ®è‡ªç„¶è¯­è¨€è¾“å…¥è€Œéå…³é”®è¯ï¼Œç»™å‡ºç»¼åˆæ¦‚æ‹¬çš„ã€æ— æ³•è¢«æœç´¢å¼•æ“ç®€å•è·å–åˆ°çš„æ€è€ƒå’Œç­”æ¡ˆã€‚</p>
<p>åœ¨å½“ä»Šä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“åœ°è·å¾—å„ç§æµ·é‡çš„ä¿¡æ¯ï¼Œä½†è¿™ä¹Ÿå¸¦æ¥äº†å¦ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¿¡æ¯çš„åˆ†æ•£å’Œç¢ç‰‡åŒ–ï¼Œå¾ˆéš¾å°†è¿™äº›ä¿¡æ¯æ•´åˆèµ·æ¥ï¼Œå½¢æˆæœ‰ä»·å€¼çš„çŸ¥è¯†ã€‚è€Œ ChatGPT å¯ä»¥é€šè¿‡è‡ªç„¶è¯­è¨€äº¤äº’çš„æ–¹å¼ï¼Œå°†å„ç§ä¿¡æ¯å’ŒçŸ¥è¯†æ•´åˆèµ·æ¥ï¼Œä¹ƒè‡³ä¸»åŠ¨å»è·å–çŸ¥è¯†å’Œæ¥æ”¶åé¦ˆï¼ˆå°±åƒæˆ‘ä»¬åœ¨ GPTtrace ä¸­åšçš„ä¸€æ ·ï¼‰ï¼Œå½¢æˆä¸€ä¸ªå·¨å¤§çš„çŸ¥è¯†åº“ï¼Œä¸ºäººä»¬æä¾›ç»¼åˆçš„æ€è€ƒå’Œç­”æ¡ˆã€‚</p>
<p>è¿™ç§æ–¹å¼å¯ä»¥è¿æ¥å„è¡Œå„ä¸šï¼Œä¸å—ç‰¹å®šé¢†åŸŸæˆ–è¡Œä¸šçš„é™åˆ¶ï¼Œæ ¹æ®è‡ªç„¶è¯­è¨€è¾“å…¥è€Œéå…³é”®è¯ï¼Œç»™å‡ºæ›´åŠ å‡†ç¡®ã€ç»¼åˆçš„æ¦‚æ‹¬ã€‚æ­¤å¤–ï¼Œç”±äº ChatGPT å¯ä»¥æ“æ§å„ç±»å·¥å…·å’Œè®¿é—®ç½‘ç»œï¼Œå®ƒå¯ä»¥æ›´åŠ æ·±å…¥åœ°äº†è§£å„ç§çŸ¥è¯†å’Œä¿¡æ¯ï¼Œå¹¶ä¸ºç”¨æˆ·æä¾›æ›´åŠ å…¨é¢å’Œæ·±å…¥çš„è§£ç­”ã€‚</p>
<p>è¿™ç§é©å‘½æ€§çš„å˜åŒ–å¯èƒ½å·²ç»ç«™åœ¨äººç±»æ–‡æ˜å˜é©çš„å‰å¤œï¼Œæˆ‘ä»¬è·å–çŸ¥è¯†å’Œæ€è€ƒçš„æ–¹å¼å°†è¢«é¢ è¦†ï¼Œç±»ä¼¼çš„å¤§æ¨¡å‹çš„å‡ºç°å°†æˆä¸ºè¿™ä¸ªå˜é©çš„é‡è¦æ¨æ‰‹ã€‚</p>
<h2 id="æœªæ¥åœ¨ä½•æ–¹"><a class="header" href="#æœªæ¥åœ¨ä½•æ–¹">æœªæ¥åœ¨ä½•æ–¹ï¼Ÿ</a></h2>
<p>å…¶å®è¿™ä¸ªæ¨¡å‹æœ¬èº«çš„æ•ˆæœï¼Œå¹¶ä¸ç®—æƒŠè‰³ï¼Œç”šè‡³å¯ä»¥è¯´è¿˜æœ‰éå¸¸å¤šçš„æˆé•¿ç©ºé—´ã€‚å¯¹äºæˆ‘è¿™æ ·çš„é AI ä¸“ä¸šç ”ç©¶äººå‘˜ï¼ˆAIå·¥å…·å’Œæ¨¡å‹çš„æ¶ˆè´¹è€…ï¼‰æ¥è¯´ï¼Œå’Œä¼ ç»Ÿçš„è®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ–¹å¼æ¯”èµ·æ¥ï¼š</p>
<ul>
<li>è®­ç»ƒæ¨¡å‹ä¸éœ€è¦æ•´ç†æ•°æ®é›†å’Œæ¸…æ´—æ•°æ®é›†ï¼Œä»…ä»…éœ€è¦å‡ ç¯‡é«˜è´¨é‡çš„æ–‡æ¡£å’Œæ•™ç¨‹ï¼Œæ•°é‡éå¸¸å°‘ï¼Œä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿°å³å¯ï¼›æå¤§åœ°å‡å°‘äº†éä¸“ä¸šäººå£«çš„å‡†å¤‡å·¥ä½œï¼›</li>
<li>åªéœ€è¦å¯¹è¯ä¸Šä¸‹æ–‡å³å¯ç›´è§‚å’Œæ–¹ä¾¿åœ°è¿›è¡Œè®­ç»ƒï¼Œä»»ä½•äººéƒ½å¯ä»¥è½»æ¾ç†è§£ï¼ˆæˆ–è€…å°è¯•ç±»æ¯”ï¼‰AI æ˜¯æ€ä¹ˆè¿›è¡Œå­¦ä¹ çš„ï¼›</li>
<li>å¯ä»¥é€‚åº”éå¸¸å¤šç§ä¸åŒé¢†åŸŸçš„ä»»åŠ¡ï¼Œåªè¦ä»»ä½•ä»»åŠ¡èƒ½è¢«è½¬æ¢æˆä¸€æ®µæ–‡æœ¬æˆ–æŒ‡ä»¤ï¼›</li>
</ul>
<p>æ­£å¦‚å“ˆå°”æ»¨å·¥ä¸šå¤§å­¦è½¦ä¸‡ç¿”å…ˆç”Ÿåœ¨é’æºWorkshopä¸­æåŠçš„ï¼ŒChatGPT æ—¶ä»£ï¼ŒNLPer çš„å±ä¸æœºä¸­æ‰€è¯´çš„é‚£æ ·ï¼š</p>
<blockquote>
<p>ChatGPTæ—¶ä»£ï¼Œä¸ºäº†åº”å¯¹å½“å‰çš„æŒ‘æˆ˜ï¼Œè‡ªç„¶è¯­è¨€é¢†åŸŸçš„ç ”ç©¶è€…å¯ä»¥å€Ÿé‰´ä¿¡æ¯æ£€ç´¢ç ”ç©¶è€…çš„ç»éªŒã€‚é¦–å…ˆï¼Œå­¦æœ¯ç•Œå¯èƒ½ä¸å†è¿›è¡Œç³»ç»Ÿçº§åˆ«çš„ç ”ç©¶ï¼Œä¸»è¦é›†ä¸­åœ¨ç›¸å¯¹è¾¹ç¼˜çš„ç ”ç©¶æ–¹å‘ä¸Šï¼›å…¶æ¬¡ï¼Œä½¿ç”¨å·¥ä¸šç•Œå·¨å¤´æä¾›çš„æ•°æ®è¿›è¡Œå®éªŒï¼Œå¹¶ä¸ä¸€å®šèƒ½å¾—å‡ºå¯é çš„ç»“è®ºï¼Œç”±äºå­˜åœ¨éšç§é—®é¢˜ï¼Œæ•°æ®çš„çœŸå®æ€§å­˜ç–‘ï¼›é€šè¿‡è°ƒç”¨å…¬å¸æä¾›çš„ API è¿›è¡Œç ”ç©¶ï¼Œä¸€æ—¦æ¨¡å‹è¢«è°ƒæ•´ï¼Œå…¶ç»“è®ºæœ‰å¯èƒ½ä¹Ÿä¼šæ”¹å˜ã€‚</p>
</blockquote>
<p>å½“ä½¿ç”¨ AI è§£å†³ç‰¹å®šé—®é¢˜çš„é—¨æ§›å˜å¾—è¶³å¤Ÿçš„ä½å»‰ï¼Œåè€Œæ˜¯ AI æ›´è¿›ä¸€æ­¥æ™®åŠã€æ›´è¿›ä¸€æ­¥è§£å†³æ›´å¤šç»†åˆ†åœºæ™¯ä¸‹çš„é—®é¢˜çš„å·¨å¤§æœºä¼šã€‚å¦ä¸€æ–¹é¢å¯èƒ½æ˜¯æ”¯æ’‘ AI çš„åŸºç¡€è®¾æ–½ï¼šå½“ç”Ÿæˆçš„å†…å®¹ï¼ˆä¾‹å¦‚ä»£ç ï¼Œæ–‡æœ¬ï¼Œç®—æ³•ï¼ŒéŸ³é¢‘è§†é¢‘ï¼‰çš„æˆæœ¬å˜å¾—æ›´å»‰ä»·ï¼Œä¹Ÿè®¸å¯ç¼–ç¨‹ã€ä½ä»£ç çš„å¹³å°ä¹Ÿä¼šå˜å¾—ç›¸å¯¹åŸå…ˆå·¨å¤§çš„å•ä½“åº”ç”¨æ¥è¯´ï¼Œå˜å¾—æ›´åŠ å…·æœ‰å¯æ‰©å±•æ€§å’Œå¯å¤ç”¨æ€§ã€‚ä¾‹å¦‚ï¼Œä»ä¸€æ®µæè¿°æˆ–äº¤äº’å¼åœ°å¯¹è¯ä¸­ç›´æ¥ç”Ÿæˆä¸€ä¸ª FaaS çš„æ¥å£å‘å¸ƒï¼Œç›´æ¥ç”Ÿæˆä¸€ä¸ªç½‘é¡µå‰ç«¯å¹¶éƒ¨ç½²ï¼Œæˆ–ä½¿ç”¨ ChatGPT ç”Ÿæˆçš„ä»£ç ç›´æ¥ä½œä¸ºå¯è§‚æµ‹çš„é‡‡é›†å’Œæ•°æ®å¤„ç†ç¨‹åºï¼Œéƒ¨ç½²åˆ°å¤§å‹çš„å¯è§‚æµ‹æ€§å¹³å°ä¸­ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨ä¹Ÿåœ¨æ¢ç´¢ä¸€äº› eBPF å’Œ Wasm ç»“åˆçš„ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶ï¼Œå¸Œæœ›å®ç°ä»å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„å¯ç¼–ç¨‹æ‰©å±•æ•ˆæœï¼š<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></p>
<h2 id="ä¸€äº›å‚è€ƒé“¾æ¥"><a class="header" href="#ä¸€äº›å‚è€ƒé“¾æ¥">ä¸€äº›å‚è€ƒé“¾æ¥</a></h2>
<ul>
<li>ChatGPTï¼š<a href="https://chat.openai.com/chat">https://chat.openai.com/chat</a></li>
<li>GPTtraceï¼š<a href="https://github.com/eunomia-bpf/GPTtrace">https://github.com/eunomia-bpf/GPTtrace</a></li>
<li>ChatGPT Python API: <a href="https://github.com/mmabrouk/chatgpt-wrapper">https://github.com/mmabrouk/chatgpt-wrapper</a></li>
<li>åŸºäº CO-RE (ä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„è¿è¡Œï¼‰ libbpf çš„ eBPF å¼€å‘è€…æ•™ç¨‹ï¼šé€šè¿‡ 20 ä¸ªå°å·¥å…·ä¸€æ­¥æ­¥å­¦ä¹  eBPFï¼ˆå°è¯•æ•™ä¼š ChatGPT ç¼–å†™ eBPF ç¨‹åºï¼‰ï¼š<a href="https://github.com/eunomia-bpf/bpf-developer-tutorial">https://github.com/eunomia-bpf/bpf-developer-tutorial</a></li>
<li>ChatGPTç±»å·¥å…·å¦‚ä½•å®ç°ã€Œé™ç»´æ‰“å‡»ã€| èŠå¤©æœºå™¨äººé—­é—¨ç ”è®¨è§‚ç‚¹æ€»ç»“ï¼š<a href="https://mp.weixin.qq.com/s/fB9rguy26ej-alm7l_i8iQ">https://mp.weixin.qq.com/s/fB9rguy26ej-alm7l_i8iQ</a></li>
<li>eunomia-bpf å¼€æºç¤¾åŒºï¼š<a href="https://github.com/eunomia-bpf">https://github.com/eunomia-bpf</a></li>
</ul>
<blockquote>
<p>æ³¨ï¼šæœ¬æ–‡ä½¿ç”¨ ChatGPT è¿›è¡Œè¾…åŠ©å†™ä½œå®Œæˆã€‚</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><p>#!<a href="https://zhuanlan.zhihu.com/p/573941739">https://zhuanlan.zhihu.com/p/573941739</a></p>
<h1 id="å½“-wasm-é‡è§-ebpf-ä½¿ç”¨-webassembly-ç¼–å†™åˆ†å‘åŠ è½½è¿è¡Œ-ebpf-ç¨‹åº"><a class="header" href="#å½“-wasm-é‡è§-ebpf-ä½¿ç”¨-webassembly-ç¼–å†™åˆ†å‘åŠ è½½è¿è¡Œ-ebpf-ç¨‹åº">å½“ Wasm é‡è§ eBPF ï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åº</a></h1>
<p>å½“ä»Šäº‘åŸç”Ÿä¸–ç•Œä¸­ä¸¤ä¸ªæœ€çƒ­é—¨çš„è½»é‡çº§ä»£ç æ‰§è¡Œæ²™ç®±/è™šæ‹Ÿæœºæ˜¯ eBPF å’Œ WebAssemblyã€‚å®ƒä»¬éƒ½è¿è¡Œä» Cã€C++ å’Œ Rust ç­‰è¯­è¨€ç¼–è¯‘çš„é«˜æ€§èƒ½å­—èŠ‚ç ç¨‹åºï¼Œå¹¶ä¸”éƒ½æ˜¯è·¨å¹³å°ã€å¯ç§»æ¤çš„ã€‚äºŒè€…æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼š eBPF åœ¨ Linux å†…æ ¸ä¸­è¿è¡Œï¼Œè€Œ WebAssembly åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œã€‚æˆ‘ä»¬å¸Œæœ›èƒ½åšä¸€äº›å°†äºŒè€…ç›¸äº’èåˆçš„å°è¯•ï¼šä½¿ç”¨ Wasm æ¥ç¼–å†™é€šç”¨çš„ eBPF ç¨‹åºï¼Œç„¶åå¯ä»¥å°†å…¶åˆ†å‘åˆ°ä»»æ„ä¸åŒç‰ˆæœ¬ã€ä¸åŒæ¶æ„çš„ Linux å†…æ ¸ä¸­ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘å³å¯è¿è¡Œã€‚</p>
<h2 id="webassembly-vs-ebpf"><a class="header" href="#webassembly-vs-ebpf">WebAssembly vs. eBPF</a></h2>
<p>WebAssembly(ç¼©å†™ Wasm)æ˜¯åŸºäºå †æ ˆè™šæ‹Ÿæœºçš„äºŒè¿›åˆ¶æŒ‡ä»¤æ ¼å¼ã€‚Wasm æ˜¯ä¸ºäº†ä¸€ä¸ªå¯ç§»æ¤çš„ç›®æ ‡è€Œè®¾è®¡çš„ï¼Œå¯ä½œä¸º C/C+/RUST ç­‰é«˜çº§è¯­è¨€çš„ç¼–è¯‘ç›®æ ‡ï¼Œä½¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨ Web ä¸Šéƒ¨ç½²ã€‚Wasm çš„è¿è¡Œæ—¶æœ‰å¤šç§å®ç°ï¼ŒåŒ…æ‹¬æµè§ˆå™¨å’Œç‹¬ç«‹çš„ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç”¨äºè§†é¢‘å’ŒéŸ³é¢‘ç¼–è§£ç å™¨ã€å›¾å½¢å’Œ 3Dã€å¤šåª’ä½“å’Œæ¸¸æˆã€å¯†ç è®¡ç®—æˆ–ä¾¿æºå¼è¯­è¨€å®ç°ç­‰åº”ç”¨ã€‚</p>
<p>å°½ç®¡ Wasm æ˜¯ä¸ºäº†æé«˜ç½‘é¡µä¸­æ€§èƒ½æ•æ„Ÿæ¨¡å—è¡¨ç°è€Œæå‡ºçš„å­—èŠ‚ç æ ‡å‡†, ä½†æ˜¯ Wasm å´ä¸ä»…èƒ½ç”¨åœ¨æµè§ˆå™¨(broswer)ä¸­, ä¹Ÿå¯ä»¥ç”¨åœ¨å…¶ä»–ç¯å¢ƒä¸­ã€‚Wasm å·²ç»å‘å±•æˆä¸ºä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½ã€è·¨å¹³å°å’Œå¤šè¯­ç§çš„è½¯ä»¶æ²™ç›’ç¯å¢ƒï¼Œè¢«è¿ç”¨äºäº‘åŸç”Ÿè½¯ä»¶ç»„ä»¶ã€‚ä¸ Linux å®¹å™¨ç›¸æ¯”ï¼ŒWebAssembly çš„å¯åŠ¨é€Ÿåº¦å¯ä»¥æé«˜ 100 å€ï¼Œå†…å­˜å’Œç£ç›˜å ç”¨ç©ºé—´è¦å°å¾—å¤šï¼Œå¹¶ä¸”å…·æœ‰æ›´å¥½å®šä¹‰çš„å®‰å…¨æ²™ç®±ã€‚ç„¶è€Œï¼Œæƒè¡¡æ˜¯ WebAssembly éœ€è¦è‡ªå·±çš„è¯­è¨€ SDK å’Œç¼–è¯‘å™¨å·¥å…·é“¾ï¼Œä½¿å…¶æˆä¸ºæ¯” Linux å®¹å™¨æ›´å—é™åˆ¶çš„å¼€å‘ç¯å¢ƒã€‚WebAssembly è¶Šæ¥è¶Šå¤šåœ°ç”¨äºéš¾ä»¥éƒ¨ç½² Linux å®¹å™¨æˆ–åº”ç”¨ç¨‹åºæ€§èƒ½è‡³å…³é‡è¦çš„è¾¹ç¼˜è®¡ç®—åœºæ™¯ã€‚</p>
<p>Wasm çš„ç¼–è¯‘å’Œéƒ¨ç½²æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="blog/../img/wasm-compile.png" alt="wasm-compile-deploy" /></p>
<p>é€šå¸¸å¯ä»¥å°† C/C+/RUST ç­‰é«˜çº§è¯­è¨€ç¼–è¯‘ä¸º Wasm å­—èŠ‚ç ï¼Œåœ¨ Wasm è™šæ‹Ÿæœºä¸­è¿›è¡ŒåŠ è½½è¿è¡Œã€‚Wasm è™šæ‹Ÿæœºä¼šé€šè¿‡è§£é‡Šæ‰§è¡Œæˆ– JIT çš„æ–¹å¼ï¼Œå°† Wasm å­—èŠ‚ç ç¿»è¯‘ä¸ºå¯¹åº”å¹³å°ï¼ˆ x86/arm ç­‰ï¼‰çš„æœºå™¨ç è¿è¡Œã€‚</p>
<p>eBPF æºäº BPFï¼Œæœ¬è´¨ä¸Šæ˜¯å¤„äºå†…æ ¸ä¸­çš„ä¸€ä¸ªé«˜æ•ˆä¸çµæ´»çš„è™šæ‹Ÿæœºç»„ä»¶ï¼Œä»¥ä¸€ç§å®‰å…¨çš„æ–¹å¼åœ¨è®¸å¤šå†…æ ¸ hook ç‚¹æ‰§è¡Œå­—èŠ‚ç ã€‚BPF æœ€åˆçš„ç›®çš„æ˜¯ç”¨äºé«˜æ•ˆç½‘ç»œæŠ¥æ–‡è¿‡æ»¤ï¼Œç»è¿‡é‡æ–°è®¾è®¡ï¼ŒeBPF ä¸å†å±€é™äºç½‘ç»œåè®®æ ˆï¼Œå·²ç»æˆä¸ºå†…æ ¸é¡¶çº§çš„å­ç³»ç»Ÿï¼Œæ¼”è¿›ä¸ºä¸€ä¸ªé€šç”¨æ‰§è¡Œå¼•æ“ã€‚å¼€å‘è€…å¯åŸºäº eBPF å¼€å‘æ€§èƒ½åˆ†æå·¥å…·ã€è½¯ä»¶å®šä¹‰ç½‘ç»œã€å®‰å…¨ç­‰è¯¸å¤šåœºæ™¯ã€‚eBPF æœ‰ä¸€äº›ç¼–ç¨‹é™åˆ¶ï¼Œéœ€è¦ç»è¿‡éªŒè¯å™¨ç¡®ä¿å…¶åœ¨å†…æ ¸åº”ç”¨åœºæ™¯ä¸­æ˜¯å®‰å…¨çš„ï¼ˆä¾‹å¦‚ï¼Œæ²¡æœ‰æ— é™å¾ªç¯ã€å†…å­˜è¶Šç•Œç­‰ï¼‰ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€ eBPF çš„ç¼–ç¨‹æ¨¡å‹ä¸æ˜¯å›¾çµå®Œå¤‡çš„ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒWebAssembly æ˜¯ä¸€ç§å›¾çµå®Œå¤‡çš„è¯­è¨€ï¼Œå…·æœ‰èƒ½å¤Ÿæ‰“ç ´æ²™ç›’å’Œè®¿é—®åŸç”Ÿ OS åº“çš„æ‰©å±• WASI (WebAssembly System Interface, Wasm ç³»ç»Ÿæ¥å£) ï¼ŒåŒæ—¶ Wasm è¿è¡Œæ—¶å¯ä»¥å®‰å…¨åœ°éš”ç¦»å¹¶ä»¥æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç ã€‚äºŒè€…çš„é¢†åŸŸä¸»ä½“ä¸Šæœ‰ä¸å°‘å·®å¼‚ï¼Œä½†ä¹Ÿæœ‰ä¸å°‘ç›¸äº’é‡å çš„åœ°æ–¹ã€‚</p>
<p>æœ‰ä¸€äº›åœ¨ Linux å†…æ ¸ä¸­è¿è¡Œ WebAssembly çš„å°è¯•ï¼Œç„¶è€ŒåŸºæœ¬ä¸Šä¸å¤ªæˆåŠŸã€‚ eBPF æ˜¯è¿™ä¸ªåº”ç”¨åœºæ™¯ä¸‹æ›´å¥½çš„é€‰æ‹©ã€‚ä½†æ˜¯ WebAssembly ç¨‹åºå¯ä»¥å¤„ç†è®¸å¤šç±»å†…æ ¸çš„ä»»åŠ¡ï¼Œå¯ä»¥è¢« AOT ç¼–è¯‘æˆåŸç”Ÿåº”ç”¨ç¨‹åºã€‚æ¥è‡ª CNCF çš„ WasmEdge Runtime æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŸºäº LLVM çš„äº‘åŸç”Ÿ WebAssembly ç¼–è¯‘å™¨ã€‚åŸç”Ÿåº”ç”¨ç¨‹åºå°†æ‰€æœ‰æ²™ç®±æ£€æŸ¥åˆå¹¶åˆ°åŸç”Ÿåº“ä¸­ï¼Œè¿™å…è®¸ WebAssembly ç¨‹åºè¡¨ç°å¾—åƒä¸€ä¸ªç‹¬ç«‹çš„ unikernel â€œåº“æ“ä½œç³»ç»Ÿâ€ã€‚æ­¤å¤–ï¼Œè¿™ç§ AOT ç¼–è¯‘çš„æ²™ç›’ WebAssembly åº”ç”¨ç¨‹åºå¯ä»¥åœ¨å¾®å†…æ ¸æ“ä½œç³»ç»Ÿï¼ˆå¦‚ seL4ï¼‰ä¸Šè¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥æ¥ç®¡è®¸å¤šâ€œå†…æ ¸çº§â€ä»»åŠ¡[1]ã€‚</p>
<p>è™½ç„¶ WebAssembly å¯ä»¥ä¸‹é™åˆ°å†…æ ¸çº§åˆ«ï¼Œä½† eBPF ä¹Ÿå¯ä»¥ä¸Šå‡åˆ°åº”ç”¨ç¨‹åºçº§åˆ«ã€‚åœ¨ sidecar ä»£ç†ä¸­ï¼ŒEnvoy Proxy å¼€åˆ›äº†ä½¿ç”¨ Wasm ä½œä¸ºæ‰©å±•æœºåˆ¶å¯¹æ•°æ®å¹³é¢è¿›è¡Œç¼–ç¨‹çš„æ–¹æ³•ã€‚å¼€å‘äººå‘˜å¯ä»¥ç”¨ Cã€C++ã€Rustã€AssemblyScriptã€Swift å’Œ TinyGo ç­‰è¯­è¨€ç¼–å†™ç‰¹å®šåº”ç”¨çš„ä»£ç†é€»è¾‘ï¼Œå¹¶å°†è¯¥æ¨¡å—ç¼–è¯‘åˆ° Wasm ä¸­ã€‚é€šè¿‡ proxy-Wasm æ ‡å‡†ï¼Œä»£ç†å¯ä»¥åœ¨ Wasmtime å’Œ WasmEdge ç­‰é«˜æ€§èƒ½è¿è¡Œæœºåˆ¶ä¸­æ‰§è¡Œé‚£äº› Wasm æ’ä»¶[2]ã€‚</p>
<p>å°½ç®¡ç›®å‰æœ‰ä¸å°‘åº”ç”¨ç¨‹åºåŒæ—¶ä½¿ç”¨äº†äºŒè€…ï¼Œä½†å¤§å¤šæ•°æ—¶å€™è¿™ä¸¤ä¸ªè™šæ‹Ÿæœºæ˜¯ç›¸äº’ç‹¬ç«‹å¹¶ä¸”æ²¡æœ‰äº¤é›†çš„ï¼šä¾‹å¦‚åœ¨å¯è§‚æµ‹æ€§åº”ç”¨ä¸­ï¼Œé€šè¿‡ eBPF æ¢é’ˆè·å–æ•°æ®ï¼Œè·å–æ•°æ®ä¹‹ååœ¨ç”¨æˆ·æ€å¼•å…¥ Wasm æ’ä»¶æ¨¡å—ï¼Œè¿›è¡Œå¯é…ç½®çš„æ•°æ®å¤„ç†ã€‚Wasm æ¨¡å—å’Œ eBPF ç¨‹åºçš„åˆ†å‘ã€è¿è¡Œã€åŠ è½½ã€æ§åˆ¶ç›¸äº’ç‹¬ç«‹ï¼Œä»…ä»…å­˜åœ¨æ•°æ®æµçš„å…³è”ã€‚</p>
<h2 id="æˆ‘ä»¬çš„ä¸€æ¬¡å°è¯•"><a class="header" href="#æˆ‘ä»¬çš„ä¸€æ¬¡å°è¯•">æˆ‘ä»¬çš„ä¸€æ¬¡å°è¯•</a></h2>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªå®Œæ•´çš„ eBPF åº”ç”¨ç¨‹åºåˆ†ä¸ºç”¨æˆ·ç©ºé—´ç¨‹åºå’Œå†…æ ¸ç¨‹åºä¸¤éƒ¨åˆ†ï¼š</p>
<ul>
<li>ç”¨æˆ·ç©ºé—´ç¨‹åºè´Ÿè´£åŠ è½½ BPF å­—èŠ‚ç è‡³å†…æ ¸ï¼Œæˆ–è´Ÿè´£è¯»å–å†…æ ¸å›ä¼ çš„ç»Ÿè®¡ä¿¡æ¯æˆ–è€…äº‹ä»¶è¯¦æƒ…ï¼Œè¿›è¡Œç›¸å…³çš„æ•°æ®å¤„ç†å’Œæ§åˆ¶ï¼›</li>
<li>å†…æ ¸ä¸­çš„ BPF å­—èŠ‚ç è´Ÿè´£åœ¨å†…æ ¸ä¸­æ‰§è¡Œç‰¹å®šäº‹ä»¶ï¼Œå¦‚éœ€è¦ä¹Ÿä¼šå°†æ‰§è¡Œçš„ç»“æœé€šè¿‡ maps æˆ–è€… perf-event äº‹ä»¶å‘é€è‡³ç”¨æˆ·ç©ºé—´</li>
</ul>
<p>ç”¨æˆ·æ€ç¨‹åºå¯ä»¥åœ¨åŠ è½½ eBPF ç¨‹åºå‰æ§åˆ¶ä¸€äº› eBPF ç¨‹åºçš„å‚æ•°å’Œå˜é‡ï¼Œä»¥åŠæŒ‚è½½ç‚¹ï¼›ä¹Ÿå¯ä»¥é€šè¿‡ map ç­‰ç­‰æ–¹å¼è¿›è¡Œç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„åŒå‘é€šä¿¡ã€‚é€šå¸¸æ¥è¯´ç”¨æˆ·æ€çš„ eBPF ç¨‹åºå¯ä»¥åŸºäº <code>libbpf</code> åº“è¿›è¡Œå¼€å‘ï¼Œæ¥æ§åˆ¶å†…æ ¸æ€ eBPF ç¨‹åºçš„è£…è½½å’Œè¿è¡Œã€‚é‚£ä¹ˆï¼Œå¦‚æœå°†ç”¨æˆ·æ€çš„æ‰€æœ‰æ§åˆ¶å’Œæ•°æ®å¤„ç†é€»è¾‘å…¨éƒ¨ç§»åˆ° Wasm è™šæ‹Ÿæœºä¸­ï¼Œé€šè¿‡ Wasm module æ‰“åŒ…å’Œåˆ†å‘ eBPF å­—èŠ‚ç ï¼ŒåŒæ—¶åœ¨ Wasm è™šæ‹Ÿæœºå†…éƒ¨æ§åˆ¶æ•´ä¸ª eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œï¼Œä¹Ÿè®¸æˆ‘ä»¬å°±å¯ä»¥å°†äºŒè€…çš„ä¼˜åŠ¿ç»“åˆèµ·æ¥ï¼Œè®©ä»»æ„ eBPF ç¨‹åºèƒ½æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li><code>å¯ç§»æ¤</code>ï¼šè®© eBPF å·¥å…·å’Œåº”ç”¨å®Œå…¨å¹³å°æ— å…³ã€å¯ç§»æ¤ï¼Œä¸éœ€è¦è¿›è¡Œé‡æ–°ç¼–è¯‘å³å¯ä»¥è·¨å¹³å°åˆ†å‘ï¼›</li>
<li><code>éš”ç¦»æ€§</code>ï¼šå€ŸåŠ© Wasm çš„å¯é æ€§å’Œéš”ç¦»æ€§ï¼Œè®© eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œã€ä»¥åŠç”¨æˆ·æ€çš„æ•°æ®å¤„ç†æµç¨‹æ›´åŠ å®‰å…¨å¯é ï¼›äº‹å®ä¸Šä¸€ä¸ª eBPF åº”ç”¨çš„ç”¨æˆ·æ€æ§åˆ¶ä»£ç é€šå¸¸è¿œè¿œå¤šäºå†…æ ¸æ€ï¼›</li>
<li><code>åŒ…ç®¡ç†</code>ï¼šå€ŸåŠ© Wasm çš„ç”Ÿæ€å’Œå·¥å…·é“¾ï¼Œå®Œæˆ eBPF ç¨‹åºæˆ–å·¥å…·çš„åˆ†å‘ã€ç®¡ç†ã€åŠ è½½ç­‰å·¥ä½œï¼Œç›®å‰ eBPF ç¨‹åºæˆ–å·¥å…·ç”Ÿæ€å¯èƒ½ç¼ºä¹ä¸€ä¸ªé€šç”¨çš„åŒ…ç®¡ç†æˆ–æ’ä»¶ç®¡ç†ç³»ç»Ÿï¼›</li>
<li><code>è·¨è¯­è¨€</code>ï¼šç›®å‰ eBPF ç¨‹åºç”±å¤šç§ç”¨æˆ·æ€è¯­è¨€å¼€å‘ï¼ˆå¦‚ Go\Rust\C\C++\Python ç­‰ï¼‰ï¼Œè¶…è¿‡ 30 ç§ç¼–ç¨‹è¯­è¨€å¯ä»¥è¢«ç¼–è¯‘æˆ WebAssembly æ¨¡å—ï¼Œå…è®¸å„ç§èƒŒæ™¯çš„å¼€å‘äººå‘˜ï¼ˆCã€Goã€Rustã€Javaã€TypeScript ç­‰ï¼‰ç”¨ä»–ä»¬é€‰æ‹©çš„è¯­è¨€ç¼–å†™ eBPF çš„ç”¨æˆ·æ€ç¨‹åºï¼Œè€Œä¸éœ€è¦å­¦ä¹ æ–°çš„è¯­è¨€ï¼›</li>
<li><code>æ•æ·æ€§</code>ï¼šå¯¹äºå¤§å‹çš„ eBPF åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨ Wasm ä½œä¸ºæ’ä»¶æ‰©å±•å¹³å°ï¼šæ‰©å±•ç¨‹åºå¯ä»¥åœ¨è¿è¡Œæ—¶ç›´æ¥ä»æ§åˆ¶å¹³é¢äº¤ä»˜å’Œé‡æ–°åŠ è½½ã€‚è¿™ä¸ä»…æ„å‘³ç€æ¯ä¸ªäººéƒ½å¯ä»¥ä½¿ç”¨å®˜æ–¹å’Œæœªç»ä¿®æ”¹çš„åº”ç”¨ç¨‹åºæ¥åŠ è½½è‡ªå®šä¹‰æ‰©å±•ï¼Œè€Œä¸”ä»»ä½• eBPF ç¨‹åºçš„é”™è¯¯ä¿®å¤å’Œ/æˆ–æ›´æ–°éƒ½å¯ä»¥åœ¨è¿è¡Œæ—¶æ¨é€å’Œ/æˆ–æµ‹è¯•ï¼Œè€Œä¸éœ€è¦æ›´æ–°å’Œ/æˆ–é‡æ–°éƒ¨ç½²ä¸€ä¸ªæ–°çš„äºŒè¿›åˆ¶ï¼›</li>
<li><code>è½»é‡çº§</code>ï¼šWebAssembly å¾®æœåŠ¡æ¶ˆè€— 1% çš„èµ„æºï¼Œä¸ Linux å®¹å™¨åº”ç”¨ç›¸æ¯”ï¼Œå†·å¯åŠ¨çš„æ—¶é—´æ˜¯ 1%ï¼šæˆ‘ä»¬ä¹Ÿè®¸å¯ä»¥å€Ÿæ­¤å®ç° eBPF as a serviceï¼Œè®© eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œå˜å¾—æ›´åŠ è½»é‡çº§ã€å¿«é€Ÿã€ç®€ä¾¿æ˜“è¡Œï¼›</li>
</ul>
<p>eunomia-bpf æ˜¯ <code>eBPF æŠ€æœ¯æ¢ç´¢ SIG</code> [3] [5] ä¸­å‘èµ·å¹¶å­µåŒ–çš„é¡¹ç›®ï¼Œç›®å‰ä¹Ÿå·²ç»åœ¨ <a href="https://github.com/eunomia-bpf/eunomia-bpf">github</a> [4] ä¸Šå¼€æºã€‚eunomia-bpf æ˜¯ä¸€ä¸ª eBPF ç¨‹åºçš„è½»é‡çº§å¼€å‘åŠ è½½æ¡†æ¶ï¼ŒåŒ…å«äº†ä¸€ä¸ªç”¨æˆ·æ€åŠ¨æ€åŠ è½½æ¡†æ¶/è¿è¡Œæ—¶åº“ï¼Œä»¥åŠä¸€ä¸ªç®€å•çš„ç¼–è¯‘ Wasm å’Œ eBPF å­—èŠ‚ç çš„å·¥å…·é“¾å®¹å™¨ã€‚äº‹å®ä¸Šï¼Œåœ¨ Wasm æ¨¡å—ä¸­ç¼–å†™ eBPF ä»£ç å’Œé€šå¸¸ç†Ÿæ‚‰çš„ä½¿ç”¨ libbpf æ¡†æ¶æˆ– Coolbpf å¼€å‘ eBPF ç¨‹åºçš„æ–¹å¼æ˜¯åŸºæœ¬ä¸€æ ·çš„ï¼ŒWasm çš„å¤æ‚æ€§ä¼šè¢«éšè—åœ¨ eunomia-bpf çš„ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶åº“ä¸­ï¼Œå¼€å‘è€…å¯ä»¥ä¸“æ³¨äº eBPF ç¨‹åºçš„å¼€å‘å’Œè°ƒè¯•ï¼Œä¸éœ€è¦äº†è§£ Wasm çš„èƒŒæ™¯çŸ¥è¯†ï¼Œä¹Ÿä¸éœ€è¦æ‹…å¿ƒ Wasm çš„ç¼–è¯‘ç¯å¢ƒé…ç½®ã€‚</p>
<h3 id="ä½¿ç”¨-wasm-æ¨¡å—åˆ†å‘åŠ¨æ€åŠ è½½-ebpf-ç¨‹åº-1"><a class="header" href="#ä½¿ç”¨-wasm-æ¨¡å—åˆ†å‘åŠ¨æ€åŠ è½½-ebpf-ç¨‹åº-1">ä½¿ç”¨ Wasm æ¨¡å—åˆ†å‘ã€åŠ¨æ€åŠ è½½ eBPF ç¨‹åº</a></h3>
<p>eunomia-bpf åº“åŒ…å«ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆecliï¼‰ï¼ŒåŒ…å«äº†ä¸€ä¸ªå°å‹çš„ Wasm è¿è¡Œæ—¶æ¨¡å—å’Œ eBPF åŠ¨æ€è£…è½½çš„åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½ä¸‹æ¥åè¿›è¡Œä½¿ç”¨ï¼š</p>
<pre><code class="language-console"># download the release from https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecli
$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
$ sudo ./ecli run https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/app.wasm
2022-10-11 14:05:50 URL:https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/app.wasm [70076/70076] -&gt; &quot;/tmp/ebpm/app.wasm&quot; [1]
running and waiting for the ebpf events from perf event...
{&quot;pid&quot;:1709490,&quot;tpid&quot;:1709077,&quot;sig&quot;:0,&quot;ret&quot;:0,&quot;comm&quot;:&quot;node&quot;,&quot;sig_name&quot;:&quot;N/A&quot;}
{&quot;pid&quot;:1712603,&quot;tpid&quot;:1717412,&quot;sig&quot;:2,&quot;ret&quot;:0,&quot;comm&quot;:&quot;kworker/u4:3&quot;,&quot;sig_name&quot;:&quot;SIGINT&quot;}
{&quot;pid&quot;:1712603,&quot;tpid&quot;:1717411,&quot;sig&quot;:2,&quot;ret&quot;:0,&quot;comm&quot;:&quot;kworker/u4:3&quot;,&quot;sig_name&quot;:&quot;SIGINT&quot;}
{&quot;pid&quot;:0,&quot;tpid&quot;:847,&quot;sig&quot;:14,&quot;ret&quot;:0,&quot;comm&quot;:&quot;swapper/1&quot;,&quot;sig_name&quot;:&quot;SIGALRM&quot;}
{&quot;pid&quot;:1709490,&quot;tpid&quot;:1709077,&quot;sig&quot;:0,&quot;ret&quot;:0,&quot;comm&quot;:&quot;node&quot;,&quot;sig_name&quot;:&quot;N/A&quot;}
{&quot;pid&quot;:1709139,&quot;tpid&quot;:1709077,&quot;sig&quot;:0,&quot;ret&quot;:0,&quot;comm&quot;:&quot;node&quot;,&quot;sig_name&quot;:&quot;N/A&quot;}
{&quot;pid&quot;:1717420,&quot;tpid&quot;:1717419,&quot;sig&quot;:17,&quot;ret&quot;:0,&quot;comm&quot;:&quot;cat&quot;,&quot;sig_name&quot;:&quot;SIGCHLD&quot;}
</code></pre>
<p>ecli ä¼šè‡ªåŠ¨ä»ç½‘é¡µä¸Šä¸‹è½½å¹¶åŠ è½½ sigsnoop/app.wasm è¿™ä¸ª wasm æ¨¡å—ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ª eBPF ç¨‹åºï¼Œç”¨äºè·Ÿè¸ªå†…æ ¸ä¸­è¿›ç¨‹çš„ä¿¡å·å‘é€å’Œæ¥æ”¶ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç®€å•çš„ JSON æ ¼å¼çš„è¾“å‡ºï¼ŒåŒ…å«äº†è¿›ç¨‹çš„ PIDã€ä¿¡å·çš„ç±»å‹ã€å‘é€è€…å’Œæ¥æ”¶è€…ï¼Œä»¥åŠä¿¡å·åç§°ç­‰ä¿¡æ¯ã€‚å®ƒä¹Ÿå¯ä»¥é™„å¸¦ä¸€äº›å‘½ä»¤è¡Œå‚æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-console">$ wget https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/app.wasm
2022-10-11 14:08:07 (40.5 MB/s) - â€˜app.wasm.1â€™ saved [70076/70076]

$ sudo ./ecli run app.wasm -h
Usage: sigsnoop [-h] [-x] [-k] [-n] [-p PID] [-s SIGNAL]
Trace standard and real-time signals.


    -h, --help  show this help message and exit
    -x, --failed  failed signals only
    -k, --killed  kill only
    -p, --pid=&lt;int&gt;  target pid
    -s, --signal=&lt;int&gt;  target signal

$ sudo ./ecli run app.wasm -p 1641
running and waiting for the ebpf events from perf event...
{&quot;pid&quot;:1641,&quot;tpid&quot;:14900,&quot;sig&quot;:23,&quot;ret&quot;:0,&quot;comm&quot;:&quot;YDLive&quot;,&quot;sig_name&quot;:&quot;SIGURG&quot;}
{&quot;pid&quot;:1641,&quot;tpid&quot;:14900,&quot;sig&quot;:23,&quot;ret&quot;:0,&quot;comm&quot;:&quot;YDLive&quot;,&quot;sig_name&quot;:&quot;SIGURG&quot;}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ -p æ§åˆ¶å®ƒè¿½è¸ªå“ªä¸ªè¿›ç¨‹ï¼Œåœ¨å†…æ ¸æ€ eBPF ç¨‹åºä¸­è¿›è¡Œä¸€äº›è¿‡æ»¤å’Œå¤„ç†ã€‚åŒæ ·ä¹Ÿå¯ä»¥ä½¿ç”¨ ecli æ¥åŠ¨æ€åŠ è½½ä½¿ç”¨å…¶ä»–çš„å·¥å…·ï¼Œä¾‹å¦‚ opensnoopï¼š</p>
<pre><code class="language-console">$ sudo ./ecli run https://eunomia-bpf.github.io/eunomia-bpf/opensnoop/app.wasm
2022-10-11 14:11:56 URL:https://eunomia-bpf.github.io/eunomia-bpf/opensnoop/app.wasm [61274/61274] -&gt; &quot;/tmp/ebpm/app.wasm&quot; [1]
running and waiting for the ebpf events from perf event...
{&quot;ts&quot;:0,&quot;pid&quot;:2344,&quot;uid&quot;:0,&quot;ret&quot;:26,&quot;flags&quot;:0,&quot;comm&quot;:&quot;YDService&quot;,&quot;fname&quot;:&quot;/proc/1718823/cmdline&quot;}
{&quot;ts&quot;:0,&quot;pid&quot;:2344,&quot;uid&quot;:0,&quot;ret&quot;:26,&quot;flags&quot;:0,&quot;comm&quot;:&quot;YDService&quot;,&quot;fname&quot;:&quot;/proc/1718824/cmdline&quot;}
{&quot;ts&quot;:0,&quot;pid&quot;:2344,&quot;uid&quot;:0,&quot;ret&quot;:26,&quot;flags&quot;:0,&quot;comm&quot;:&quot;YDService&quot;,&quot;fname&quot;:&quot;/proc/self/stat&quot;}
</code></pre>
<p>opensnoop ä¼šè¿½è¸ªè¿›ç¨‹çš„ open() è°ƒç”¨ï¼Œå³å†…æ ¸ä¸­æ‰€æœ‰çš„æ‰“å¼€æ–‡ä»¶æ“ä½œï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿›ç¨‹çš„ PIDã€UIDã€è¿”å›å€¼ã€è°ƒç”¨æ ‡å¿—ã€è¿›ç¨‹åå’Œæ–‡ä»¶åç­‰ä¿¡æ¯ã€‚å†…æ ¸æ€çš„ eBPF ç¨‹åºä¼šè¢«åŒ…å«åœ¨ Wasm æ¨¡å—ä¸­è¿›è¡Œåˆ†å‘ï¼Œåœ¨åŠ è½½çš„æ—¶å€™é€šè¿‡ BTF ä¿¡æ¯å’Œ libbpf è¿›è¡Œé‡å®šä½æ“ä½œï¼Œä»¥é€‚åº”ä¸åŒçš„å†…æ ¸ç‰ˆæœ¬ã€‚åŒæ—¶ï¼Œç”±äºç”¨æˆ·æ€çš„ç›¸å…³å¤„ç†ä»£ç å®Œå…¨ç”± Wasm ç¼–å†™ï¼Œå†…æ ¸æ€ç”± eBPF æŒ‡ä»¤ç¼–å†™ï¼Œå› æ­¤ä¸å—å…·ä½“æŒ‡ä»¤é›†ï¼ˆx86ã€ARM ç­‰ï¼‰çš„é™åˆ¶ï¼Œå¯ä»¥åœ¨ä¸åŒçš„å¹³å°ä¸Šè¿è¡Œã€‚</p>
<h3 id="ä½¿ç”¨-wasm-å¼€å‘å’Œæ‰“åŒ…-ebpf-ç¨‹åº-1"><a class="header" href="#ä½¿ç”¨-wasm-å¼€å‘å’Œæ‰“åŒ…-ebpf-ç¨‹åº-1">ä½¿ç”¨ Wasm å¼€å‘å’Œæ‰“åŒ… eBPF ç¨‹åº</a></h3>
<p>åŒæ ·ï¼Œä»¥ä¸Šæ–‡æ‰€è¿°çš„ sigsnoop ä¸ºä¾‹ï¼Œè¦è·Ÿè¸ªè¿›ç¨‹çš„ä¿¡å·å‘é€å’Œæ¥æ”¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨ sigsnoop.bpf.c ä¸­ç¼–å†™å†…æ ¸æ€çš„ eBPF ä»£ç ï¼š</p>
<pre><code class="language-c">#include &lt;vmlinux.h&gt;
#include &lt;bpf/bpf_helpers.h&gt;
#include &quot;sigsnoop.h&quot;

const volatile pid_t filtered_pid = 0;
.....

struct {
 __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);
 __uint(key_size, sizeof(__u32));
 __uint(value_size, sizeof(__u32));
} events SEC(&quot;.maps&quot;);

SEC(&quot;tracepoint/signal/signal_generate&quot;)
int sig_trace(struct trace_event_raw_signal_generate *ctx)
{
 struct event event = {};
 pid_t tpid = ctx-&gt;pid;
 int ret = ctx-&gt;errno;
 int sig = ctx-&gt;sig;
 __u64 pid_tgid;
 __u32 pid;

 ...
 pid_tgid = bpf_get_current_pid_tgid();
 pid = pid_tgid &gt;&gt; 32;
 if (filtered_pid &amp;&amp; pid != filtered_pid)
  return 0;

 event.pid = pid;
 event.tpid = tpid;
 event.sig = sig;
 event.ret = ret;
 bpf_get_current_comm(event.comm, sizeof(event.comm));
 bpf_perf_event_output(ctx, &amp;events, BPF_F_CURRENT_CPU, &amp;event, sizeof(event));
 return 0;
}

char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>tracepoint/signal/signal_generate</code> è¿™ä¸ª tracepoint æ¥åœ¨å†…æ ¸ä¸­è¿½è¸ªä¿¡å·çš„äº§ç”Ÿäº‹ä»¶ã€‚å†…æ ¸æ€ä»£ç é€šè¿‡ BPF_MAP_TYPE_PERF_EVENT_ARRAY å¾€ç”¨æˆ·æ€å¯¼å‡ºä¿¡æ¯ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦åœ¨ sigsnoop.h å¤´æ–‡ä»¶ï¼Œä¸­å®šä¹‰ä¸€ä¸ªå¯¼å‡ºä¿¡æ¯çš„ç»“æ„ä½“ï¼š</p>
<pre><code class="language-c">#ifndef __SIGSNOOP_H
#define __SIGSNOOP_H

#define TASK_COMM_LEN 16

struct event {
 unsigned int pid;
 unsigned int tpid;
 int sig;
 int ret;
 char comm[TASK_COMM_LEN];
};

#endif /* __SIGSNOOP_H */
</code></pre>
<p>å¯ä»¥ç›´æ¥ä½¿ç”¨ eunomia-bpf çš„ç¼–è¯‘å·¥å…·é“¾å°†å…¶ç¼–è¯‘ä¸º JSON æ ¼å¼ï¼Œç”Ÿæˆä¸€ä¸ª package.json æ–‡ä»¶ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥ä½¿ç”¨ ecli åŠ è½½è¿è¡Œï¼š</p>
<pre><code class="language-console">$ docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest
make
  BPF      .output/client.bpf.o
  GEN-SKEL .output/client.skel.h
  CC       .output/client.o
  CC       .output/cJSON.o
  CC       .output/create_skel_json.o
  BINARY   client
  DUMP_LLVM_MEMORY_LAYOUT
  DUMP_EBPF_PROGRAM
  FIX_TYPE_INFO_IN_EBPF
  GENERATE_PACKAGE_JSON

$ sudo ./ecli run package.json
running and waiting for the ebpf events from perf event...
time pid tpid sig ret comm
14:39:39 1723835 1723834 17 0 dirname
14:39:39 1723836 1723834 17 0 chmod
14:39:39 1723838 1723837 17 0 ps
14:39:39 1723839 1723837 17 0 grep
14:39:39 1723840 1723837 17 0 grep
14:39:39 1723841 1723837 17 0 wc
</code></pre>
<p>æˆ‘ä»¬æ‰€æœ‰çš„ç¼–è¯‘å·¥å…·é“¾éƒ½å·²ç»æ‰“åŒ…æˆäº† docker é•œåƒçš„å½¢å¼å¹¶å‘å¸ƒåˆ°äº† docker hub ä¸Šï¼Œå¯ä»¥ç›´æ¥å¼€ç®±å³ç”¨ã€‚æ­¤æ—¶åŠ¨æ€åŠ è½½è¿è¡Œçš„åªæœ‰å†…æ ¸æ€çš„ eBPF ä»£ç å’Œä¸€äº›è¾…åŠ©ä¿¡æ¯ï¼Œå¸®åŠ© eunomia-bpf åº“è‡ªåŠ¨è·å–å†…æ ¸æ€å¾€ç”¨æˆ·æ€ä¸ŠæŠ¥çš„äº‹ä»¶ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨ç”¨æˆ·æ€è¿›è¡Œä¸€äº›å‚æ•°é…ç½®å’Œè°ƒæ•´ï¼Œä»¥åŠæ•°æ®å¤„ç†æµç¨‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·æ€ç¼–å†™ä»£ç ï¼Œå°†å†…æ ¸æ€çš„ eBPF ä»£ç å’Œç”¨æˆ·æ€çš„ä»£ç æ‰“åŒ…æˆä¸€ä¸ªå®Œæ•´çš„ eBPF ç¨‹åºã€‚</p>
<p>å¯ä»¥ç›´æ¥ä¸€è¡Œå‘½ä»¤ï¼Œç”Ÿæˆ eBPF ç¨‹åºçš„ç”¨æˆ·æ€ WebAssembly å¼€å‘æ¡†æ¶ï¼š</p>
<pre><code class="language-console">$ docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest gen-wasm-skel
make
  GENERATE_PACKAGE_JSON
  GEN-Wasm-SKEL
$ ls
app.c eunomia-include ewasm-skel.h package.json README.md  sigsnoop.bpf.c  sigsnoop.h
</code></pre>
<p>æˆ‘ä»¬æä¾›çš„æ˜¯ C è¯­è¨€ç‰ˆæœ¬çš„ Wasm å¼€å‘æ¡†æ¶ï¼Œå®ƒåŒ…å«å¦‚ä¸‹è¿™äº›æ–‡ä»¶ï¼š</p>
<ul>
<li>ewasm-skel.hï¼šç”¨æˆ·æ€ WebAssembly å¼€å‘æ¡†æ¶çš„å¤´æ–‡ä»¶ï¼ŒåŒ…å«äº†é¢„ç¼–è¯‘çš„ eBPF ç¨‹åºå­—èŠ‚ç ï¼Œå’Œ eBPF ç¨‹åºæ¡†æ¶è¾…åŠ©ä¿¡æ¯ï¼Œç”¨æ¥åŠ¨æ€åŠ è½½ï¼›</li>
<li>eunomia-includeï¼šä¸€äº› header-only çš„åº“å‡½æ•°å’Œè¾…åŠ©æ–‡ä»¶ï¼Œç”¨æ¥è¾…åŠ©å¼€å‘ï¼›</li>
<li>app.cï¼šç”¨æˆ·æ€ WebAssembly ç¨‹åºçš„ä¸»è¦ä»£ç ï¼ŒåŒ…å«äº† eBPF ç¨‹åºçš„ä¸»è¦é€»è¾‘ï¼Œä»¥åŠ eBPF ç¨‹åºçš„æ•°æ®å¤„ç†æµç¨‹ã€‚</li>
</ul>
<p>ä»¥ sigsnoop ä¸ºä¾‹ï¼Œç”¨æˆ·æ€åŒ…å«ä¸€äº›å‘½ä»¤è¡Œè§£æã€é…ç½® eBPF ç¨‹åºå’Œæ•°æ®å¤„ç†çš„ä»£ç ï¼Œä¼šå°†æ ¹æ® signal number å°†ä¿¡å·äº‹ä»¶çš„è‹±æ–‡åç§°æ·»åŠ åˆ°äº‹ä»¶ä¸­ï¼š</p>
<pre><code class="language-c">....
int main(int argc, const char** argv)
{
  struct argparse_option options[] = {
        OPT_HELP(),
        OPT_BOOLEAN('x', &quot;failed&quot;, &amp;failed_only, &quot;failed signals only&quot;, NULL, 0, 0),
        OPT_BOOLEAN('k', &quot;killed&quot;, &amp;kill_only, &quot;kill only&quot;, NULL, 0, 0),
        OPT_INTEGER('p', &quot;pid&quot;, &amp;target_pid, &quot;target pid&quot;, NULL, 0, 0),
  OPT_INTEGER('s', &quot;signal&quot;, &amp;target_signal, &quot;target signal&quot;, NULL, 0, 0),
        OPT_END(),
    };

  struct argparse argparse;
  argparse_init(&amp;argparse, options, usages, 0);
  argparse_describe(&amp;argparse, &quot;Trace standard and real-time signals.\n&quot;, &quot;&quot;);
  argc = argparse_parse(&amp;argparse, argc, argv);

  cJSON *program = cJSON_Parse(program_data);
  program = set_bpf_program_global_var(program, &quot;filtered_pid&quot;, cJSON_CreateNumber(target_pid));
  program = set_bpf_program_global_var(program, &quot;target_signal&quot;, cJSON_CreateNumber(target_signal));
  program = set_bpf_program_global_var(program, &quot;failed_only&quot;, cJSON_CreateBool(failed_only));
  return start_bpf_program(cJSON_PrintUnformatted(program));
}

int process_event(int ctx, char *e, int str_len)
{
 cJSON *json = cJSON_Parse(e);
 int sig = cJSON_GetObjectItem(json, &quot;sig&quot;)-&gt;valueint;
 const char *name = sig_name[sig];
 cJSON_AddItemToObject(json, &quot;sig_name&quot;, cJSON_CreateString(name));
 char *out = cJSON_PrintUnformatted(json);
 printf(&quot;%s\n&quot;, out);
 return 0;
}
</code></pre>
<p>æœ€åä½¿ç”¨å®¹å™¨é•œåƒå³å¯ä¸€è¡Œå‘½ä»¤å®Œæˆ WebAssembly/eBPF ç¨‹åºçš„ç¼–è¯‘å’Œæ‰“åŒ…ï¼Œä½¿ç”¨ ecli å³å¯ä¸€é”®è¿è¡Œï¼š</p>
<pre><code class="language-console">$ docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest build-wasm
make
  GENERATE_PACKAGE_JSON
  BUILD-Wasm
build app.wasm success
$ sudo ./ecli run app.wasm -h
Usage: sigsnoop [-h] [-x] [-k] [-n] [-p PID] [-s SIGNAL]
</code></pre>
<p>ç”±äºæˆ‘ä»¬åŸºäºä¸€æ¬¡ç¼–è¯‘ã€åˆ°å¤„è¿è¡Œçš„ libbpf æ¡†æ¶å®ŒæˆåŠ è½½å’Œå¯åŠ¨ eBPF ç¨‹åºçš„æ“ä½œï¼Œå› æ­¤ç¼–è¯‘å’Œè¿è¡Œä¸¤ä¸ªæ­¥éª¤æ˜¯å®Œå…¨åˆ†ç¦»çš„ï¼Œå¯ä»¥é€šè¿‡ç½‘ç»œæˆ–ä»»æ„æ–¹å¼ç›´æ¥è¿›è¡Œ eBPF ç¨‹åºçš„åˆ†å‘å’Œéƒ¨ç½²ï¼Œä¸ä¾èµ–äºç‰¹å®šå†…æ ¸ç‰ˆæœ¬ã€‚å€ŸåŠ© WebAssembly çš„è½»é‡çº§ç‰¹æ€§ï¼ŒeBPF ç¨‹åºçš„å¯åŠ¨é€Ÿåº¦ä¹Ÿæ¯”é€šå¸¸çš„ä½¿ç”¨é•œåƒå½¢å¼åˆ†å‘çš„ libbpf ç¨‹åºå¿«ä¸Šä¸å°‘ï¼Œé€šå¸¸åªéœ€ä¸åˆ° 100 ms çš„æ—¶é—´å³å¯å®Œæˆï¼Œæ¯”èµ·ä½¿ç”¨ BCC éƒ¨ç½²å¯åŠ¨æ—¶ï¼Œä½¿ç”¨ LLVMã€Clang ç¼–è¯‘è¿è¡Œæ¶ˆè€—çš„æ—¶é—´å’Œå¤§é‡èµ„æºï¼Œæ›´æ˜¯æœ‰äº†è´¨çš„é£è·ƒã€‚</p>
<p>ä¸Šé¢æåŠçš„ç¤ºä¾‹ç¨‹åºçš„å®Œæ•´ä»£ç ï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œ[6]ã€‚</p>
<h3 id="æ¼”ç¤ºè§†é¢‘-1"><a class="header" href="#æ¼”ç¤ºè§†é¢‘-1">æ¼”ç¤ºè§†é¢‘</a></h3>
<p>æˆ‘ä»¬ä¹Ÿæœ‰ä¸€ä¸ªåœ¨ B ç«™ä¸Šçš„æ¼”ç¤ºè§†é¢‘ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä» bcc/libbpf-tools ä¸­ç§»æ¤ä¸€ä¸ª eBPF å·¥å…·ç¨‹åºåˆ° eunomia-bpf ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨ Wasm æˆ– JSON æ–‡ä»¶æ¥åˆ†å‘ã€åŠ è½½ eBPF ç¨‹åºï¼š<a href="https://www.bilibili.com/video/BV1JN4y1A76k">https://www.bilibili.com/video/BV1JN4y1A76k</a></p>
<h2 id="æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°çš„"><a class="header" href="#æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°çš„">æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°çš„</a></h2>
<p><code>ecli</code> æ˜¯åŸºäºæˆ‘ä»¬åº•å±‚çš„ eunomia-bpf åº“å’Œè¿è¡Œæ—¶å®ç°çš„ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ã€‚æˆ‘ä»¬çš„é¡¹ç›®æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="blog/../img/eunomia-arch.png" alt="arch" /></p>
<p><code>ecli</code> å·¥å…·åŸºäº <code>ewasm</code> åº“å®ç°ï¼Œ<code>ewasm</code> åº“åŒ…å«ä¸€ä¸ª WAMR(wasm-micro-runtime) è¿è¡Œæ—¶ï¼Œä»¥åŠåŸºäº libbpf åº“æ„å»ºçš„ eBPF åŠ¨æ€è£…è½½æ¨¡å—ã€‚å¤§è‡´æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨ <code>Wasm</code> è¿è¡Œæ—¶å’Œç”¨æˆ·æ€çš„ <code>libbpf</code> ä¸­é—´å¤šåŠ äº†ä¸€å±‚æŠ½è±¡å±‚ï¼ˆ<code>eunomia-bpf</code> åº“ï¼‰ï¼Œä½¿å¾—ä¸€æ¬¡ç¼–è¯‘ã€åˆ°å¤„è¿è¡Œçš„ eBPF ä»£ç å¯ä»¥ä» JSON å¯¹è±¡ä¸­åŠ¨æ€åŠ è½½ã€‚JSON å¯¹è±¡ä¼šåœ¨ç¼–è¯‘æ—¶è¢«åŒ…å«åœ¨ Wasm æ¨¡å—ä¸­ï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è§£æ JSON å¯¹è±¡æ¥è·å– eBPF ç¨‹åºçš„ä¿¡æ¯ï¼Œç„¶ååŠ¨æ€åŠ è½½ eBPF ç¨‹åºã€‚</p>
<p>ä½¿ç”¨ Wasm æˆ– JSON ç¼–è¯‘åˆ†å‘ eBPF ç¨‹åºçš„æµç¨‹å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><img src="blog/../img/eunomia-bpf-flow.png" alt="flow" /></p>
<p>å¤§è‡´æ¥è¯´ï¼Œæ•´ä¸ª eBPF ç¨‹åºçš„ç¼–å†™å’ŒåŠ è½½åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>ç”¨ eunomia-cc å·¥å…·é“¾å°†å†…æ ¸çš„ eBPF ä»£ç éª¨æ¶å’Œå­—èŠ‚ç ç¼–è¯‘ä¸º JSON æ ¼å¼</li>
<li>åœ¨ç”¨æˆ·æ€å¼€å‘çš„é«˜çº§è¯­è¨€ï¼ˆä¾‹å¦‚ C è¯­è¨€ï¼‰ä¸­åµŒå…¥ JSON æ•°æ®ï¼Œå¹¶æä¾›ä¸€äº› API ç”¨äºæ“ä½œ JSON å½¢æ€çš„ eBPF ç¨‹åºéª¨æ¶</li>
<li>å°†ç”¨æˆ·æ€ç¨‹åºå’Œ JSON æ•°æ®ä¸€èµ·ç¼–è¯‘ä¸º Wasm å­—èŠ‚ç å¹¶æ‰“åŒ…ä¸º Wasm æ¨¡å—ï¼Œç„¶ååœ¨ç›®æ ‡æœºå™¨ä¸ŠåŠ è½½å¹¶è¿è¡Œ Wasm ç¨‹åº</li>
<li>ä» Wasm æ¨¡å—ä¸­åŠ è½½å†…åµŒçš„ JSON æ•°æ®ï¼Œç”¨ eunomia-bpf åº“åŠ¨æ€è£…è½½å’Œé…ç½® eBPF ç¨‹åºéª¨æ¶ã€‚</li>
</ol>
<p>æˆ‘ä»¬éœ€è¦å®Œæˆçš„ä»…ä»…æ˜¯å°‘é‡çš„ native API å’Œ Wasm è¿è¡Œæ—¶çš„ç»‘å®šï¼Œå¹¶ä¸”åœ¨ Wasm ä»£ç ä¸­å¤„ç† JSON æ•°æ®ã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªå•ä¸€çš„ <code>Wasm</code> æ¨¡å—ä¸­æ‹¥æœ‰å¤šä¸ª <code>eBPF</code> ç¨‹åºã€‚å¦‚æœä¸ä½¿ç”¨æˆ‘ä»¬æä¾›çš„ Wasm è¿è¡Œæ—¶ï¼Œæˆ–è€…æƒ³è¦ä½¿ç”¨å…¶ä»–è¯­è¨€è¿›è¡Œç”¨æˆ·æ€çš„ eBPF è¾…åŠ©ä»£ç çš„å¼€å‘ï¼Œåœ¨æˆ‘ä»¬æä¾›çš„ <code>eunomia-bpf</code> åº“åŸºç¡€ä¸Šå®Œæˆä¸€äº› WebaAssembly çš„ç»‘å®šå³å¯ã€‚</p>
<p>å¦å¤–ï¼Œå¯¹äº eunomia-bpf åº“è€Œè¨€ï¼Œä¸éœ€è¦ Wasm æ¨¡å—å’Œè¿è¡Œæ—¶åŒæ ·å¯ä»¥å¯åŠ¨å’ŒåŠ¨æ€åŠ è½½ eBPF ç¨‹åºï¼Œä¸è¿‡æ­¤æ—¶åŠ¨æ€åŠ è½½è¿è¡Œçš„å°±åªæ˜¯å†…æ ¸æ€çš„ eBPF ç¨‹åºå­—èŠ‚ç ã€‚ä½ å¯ä»¥æ‰‹åŠ¨æˆ–ä½¿ç”¨ä»»æ„è¯­è¨€ä¿®æ”¹ JSON å¯¹è±¡æ¥æ§åˆ¶ eBPF ç¨‹åºçš„åŠ è½½å’Œå‚æ•°ï¼Œå¹¶ä¸”é€šè¿‡ eunomia-bpf è‡ªåŠ¨è·å–å†…æ ¸æ€ä¸ŠæŠ¥çš„è¿”å›æ•°æ®ã€‚å¯¹äºåˆå­¦è€…è€Œè¨€ï¼Œè¿™å¯èƒ½æ¯”ä½¿ç”¨ WebAssembly æ›´åŠ ç®€å•æ–¹ä¾¿ï¼šåªéœ€è¦ç¼–å†™å†…æ ¸æ€çš„ eBPF ç¨‹åºï¼Œç„¶åä½¿ç”¨ eunomia-cc å·¥å…·é“¾å°†å…¶ç¼–è¯‘ä¸º JSON æ ¼å¼ï¼Œæœ€åä½¿ç”¨ eunomia-bpf åº“åŠ è½½å’Œè¿è¡Œå³å¯ã€‚å®Œå…¨ä¸ç”¨è€ƒè™‘ä»»ä½•ç”¨æˆ·æ€çš„è¾…åŠ©ç¨‹åºï¼ŒåŒ…æ‹¬ Wasm åœ¨å†…ã€‚å…·ä½“å¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ä½¿ç”¨æ‰‹å†Œ[7]æˆ–ç¤ºä¾‹ä»£ç [8]ã€‚</p>
<h2 id="æœªæ¥çš„æ–¹å‘"><a class="header" href="#æœªæ¥çš„æ–¹å‘">æœªæ¥çš„æ–¹å‘</a></h2>
<p>ç›®å‰ eunomia-bpf çš„å·¥å…·é“¾çš„å®ç°è¿˜è¿œè¿œè°ˆä¸ä¸Šå®Œå–„ï¼Œåªæ˜¯æœ‰ä¸€ä¸ªå¯è¡Œæ€§éªŒè¯çš„ç‰ˆæœ¬ã€‚å¯¹äºä¸€ä¸ªå¼€å‘å·¥å…·é“¾æ¥è¯´ï¼Œå…·ä½“çš„ API æ ‡å‡†å’Œç›¸å…³çš„ç”Ÿæ€æ˜¯éå¸¸é‡è¦çš„ï¼Œæˆ‘ä»¬å¸Œæœ›å¦‚æœæœ‰æœºä¼šçš„è¯ï¼Œä¹Ÿè®¸å¯ä»¥å’Œ SIG ç¤¾åŒºçš„å…¶ä»–æˆå‘˜ä¸€èµ·è®¨è®ºå¹¶å½¢æˆä¸€ä¸ªå…·ä½“çš„ API æ ‡å‡†ï¼Œèƒ½å¤ŸåŸºäº eBPF å’Œ Wasm ç­‰æŠ€æœ¯ï¼Œå…±åŒæä¾›ä¸€ä¸ªé€šç”¨çš„ã€è·¨å¹³å°å’Œå†…æ ¸ç‰ˆæœ¬çš„æ’ä»¶ç”Ÿæ€ï¼Œä¸ºå„è‡ªçš„åº”ç”¨å¢åŠ  eBPF å’Œ Wasm çš„è¶…èƒ½åŠ›ã€‚</p>
<p>ç›®å‰ eunomia-bpf è·¨å†…æ ¸ç‰ˆæœ¬çš„åŠ¨æ€åŠ è½½ç‰¹æ€§è¿˜ä¾èµ–äºå†…æ ¸çš„ BTF ä¿¡æ¯ï¼ŒSIG ç¤¾åŒºçš„ Coolbpf é¡¹ç›®[9]æœ¬èº«èƒ½æä¾› BTF çš„è‡ªåŠ¨ç”Ÿæˆã€ä½ç‰ˆæœ¬å†…æ ¸çš„é€‚é…åŠŸèƒ½ï¼Œæœªæ¥ä½ç‰ˆæœ¬å†…æ ¸çš„æ”¯æŒä¼šåŸºäº Coolbpf çš„ç°æœ‰çš„éƒ¨åˆ†å®Œæˆã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šç»™ Coolbpf çš„ API å®ç°ã€è¿œç¨‹ç¼–è¯‘åç«¯æä¾›ç±»ä¼¼äº eunomia-bpf çš„å†…æ ¸æ€ç¼–è¯‘å’Œè¿è¡Œå®Œå…¨åˆ†ç¦»çš„åŠŸèƒ½ï¼Œè®©ä½¿ç”¨ Coolbpf API å¼€å‘ eBPF çš„ç¨‹åºï¼Œåœ¨è¿œç¨‹ç¼–è¯‘ä¸€æ¬¡è¿‡åå¯ä»¥åœ¨ä»»æ„å†…æ ¸ç‰ˆæœ¬å’Œæ¶æ„ä¸Šç›´æ¥ä½¿ç”¨ï¼Œåœ¨éƒ¨ç½²æ—¶æ— éœ€å†æ¬¡è¿æ¥è¿œç¨‹æœåŠ¡å™¨ï¼›ä¹Ÿå¯ä»¥å°†ç¼–è¯‘å®Œæˆçš„ eBPF ç¨‹åºä½œä¸º Goã€Pythonã€Rust ç­‰è¯­è¨€çš„å¼€å‘åŒ…ç›´æ¥ä½¿ç”¨ï¼Œè®©å¼€å‘è€…èƒ½è½»æ¾è·å¾— eBPF ç¨‹åºä¸ŠæŠ¥çš„ä¿¡æ¯ï¼Œè€Œå®Œå…¨ä¸éœ€è¦å†æ¬¡è¿›è¡Œä»»ä½• eBPF ç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹ã€‚</p>
<p>SIG ç¤¾åŒºå­µåŒ–äºé«˜æ ¡çš„ Linux Microscope (LMP) é¡¹ç›®[10]ä¸­ï¼Œä¹Ÿå·²ç»æœ‰ä¸€äº›åŸºäº eunomia-bpf æä¾›é€šç”¨çš„ã€è§„èŒƒåŒ–ã€å¯ä»¥éšæ—¶ä¸‹è½½è¿è¡Œçš„ eBPF ç¨‹åºæˆ–å·¥å…·åº“çš„è®¡åˆ’ï¼Œç›®å‰è¿˜åœ¨ç»§ç»­å®Œå–„çš„é˜¶æ®µã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™-3"><a class="header" href="#å‚è€ƒèµ„æ–™-3">å‚è€ƒèµ„æ–™</a></h2>
<ol>
<li>eBPF å’Œ WebAssemblyï¼šå“ªç§ VM ä¼šåˆ¶éœ¸äº‘åŸç”Ÿæ—¶ä»£? <a href="https://juejin.cn/post/7043721713602789407">https://juejin.cn/post/7043721713602789407</a></li>
<li>eBPF å’Œ Wasmï¼šæ¢ç´¢æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢çš„æœªæ¥: <a href="https://cloudnative.to/blog/ebpf-wasm-service-mesh/">https://cloudnative.to/blog/ebpf-wasm-service-mesh/</a></li>
<li>eBPF æŠ€æœ¯æ¢ç´¢ SIG ä¸»é¡µï¼š <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>eunomia-bpf Github ä»“åº“ï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>eunomia-bpf é¾™èœ¥ç¤¾åŒºé•œåƒä»“åº“ï¼š<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
<li>sigsnoop ç¤ºä¾‹ä»£ç ï¼š<a href="https://gitee.com/anolis/eunomia/tree/master/examples/bpftools/sigsnoop">https://gitee.com/anolis/eunomia/tree/master/examples/bpftools/sigsnoop</a></li>
<li>eunomia-bpf ç”¨æˆ·æ‰‹å†Œï¼š<a href="https://openanolis.cn/sig/ebpfresearch/doc/646023027267993641">https://openanolis.cn/sig/ebpfresearch/doc/646023027267993641</a></li>
<li>æ›´å¤šç¤ºä¾‹ä»£ç ï¼š<a href="https://gitee.com/anolis/eunomia/tree/master/examples/bpftools/sigsnoop">https://gitee.com/anolis/eunomia/tree/master/examples/bpftools/sigsnoop</a></li>
<li>Coolbpf é¡¹ç›®ä»‹ç»ï¼š<a href="https://openanolis.cn/sig/ebpfresearch/doc/633529753894377555">https://openanolis.cn/sig/ebpfresearch/doc/633529753894377555</a></li>
<li>LMP é¡¹ç›®ä»‹ç»ï¼š<a href="https://openanolis.cn/sig/ebpfresearch/doc/633661297090877527">https://openanolis.cn/sig/ebpfresearch/doc/633661297090877527</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><p>#! https://zhuanlan.zhihu.com/p/589784489</p>
<h1 id="å¦‚ä½•åœ¨-linux-æ˜¾å¾®é•œlmpé¡¹ç›®ä¸­å¼€å¯-ebpf-ä¹‹æ—…"><a class="header" href="#å¦‚ä½•åœ¨-linux-æ˜¾å¾®é•œlmpé¡¹ç›®ä¸­å¼€å¯-ebpf-ä¹‹æ—…">å¦‚ä½•åœ¨ Linux æ˜¾å¾®é•œï¼ˆLMPï¼‰é¡¹ç›®ä¸­å¼€å¯ eBPF ä¹‹æ—…ï¼Ÿ</a></h1>
<p>eBPF ä¸º Linux å†…æ ¸æä¾›äº†å¯æ‰©å±•æ€§ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿå¯¹ Linux å†…æ ¸è¿›è¡Œç¼–ç¨‹ï¼Œä»¥ä¾¿æ ¹æ®ä»–ä»¬çš„ä¸šåŠ¡éœ€æ±‚å¿«é€Ÿæ„å»ºæ™ºèƒ½çš„æˆ–ä¸°å¯Œçš„åŠŸèƒ½ã€‚</p>
<p>æˆ‘ä»¬çš„ <a href="https://github.com/linuxkerneltravel/lmp">LMP(Linux Microscope) é¡¹ç›®</a> æ˜¯ä¸ºäº†å……åˆ†æŒ–æ˜ ebpf çš„å¯èƒ½æ€§è€Œå»ºç«‹çš„ï¼Œé¡¹ç›®ä»¥æ„å»º eBPF å­¦ä¹ ç¤¾åŒºã€æˆä¸º eBPF å·¥å…·é›†æ•£åœ°ã€å­µåŒ– eBPF æƒ³æ³•å’Œé¡¹ç›®ä¸ºç›®æ ‡ï¼Œæ­£åœ¨å¤§åŠ›å»ºè®¾ä¸­ã€‚ä¹‹å‰æˆ‘ä»¬åœ¨ LMP å…¶ä¸­çš„ eBPF Supermarket ä¸­åŒ…å«äº†å¤§é‡ç”±ä¸ªäººå¼€å‘è€…ç¼–å†™çš„ eBPF å·¥å…·ï¼Œè¦†ç›–äº†ç½‘ç»œã€æ€§èƒ½åˆ†æã€å®‰å…¨ç­‰å¤šç§åŠŸèƒ½ï¼Œæˆ‘ä»¬æ­£åœ¨å°è¯•æŠŠå…¶ä¸­çš„ä¸€äº›ç¨‹åºè¿ç§»åˆ° eBPF Hubï¼Œä¸€äº›è§„èŒƒåŒ–çš„ eBPF ç¨‹åºåº“ï¼Œå¯ä»¥éšæ—¶ä¸‹è½½è¿è¡Œï¼Œæˆ–åµŒå…¥å¤§å‹åº”ç”¨ç¨‹åºä¸­ä½œä¸ºæ’ä»¶ä½¿ç”¨ã€‚</p>
<p>æˆ‘ä»¬å°è¯•åœ¨ eBPF Hub ä¸­ï¼ŒåŸºäº eunomia-bpf å¼€å‘æ¡†æ¶åˆ›å»ºç¬¦åˆ OCI æ ‡å‡†çš„ Wasm å’Œ eBPF ç¨‹åºï¼Œå¹¶åˆ©ç”¨ ORAS ç®€åŒ–æ‰©å±• LMP çš„ eBPF åˆ†å‘ã€åŠ è½½ã€è¿è¡Œèƒ½åŠ›ã€‚</p>
<h2 id="å¿«é€Ÿä½¿ç”¨"><a class="header" href="#å¿«é€Ÿä½¿ç”¨">å¿«é€Ÿä½¿ç”¨</a></h2>
<p>å¦‚æœæ‚¨æƒ³å¿«é€Ÿå¼€å§‹ eBPFï¼Œå¯ä»¥ä½¿ç”¨æˆ‘ä»¬å¼€å‘çš„è½»é‡çº§æ¡†æ¶ä¹‹ä¸Šçš„å‘½ä»¤è¡Œç¨‹åº lmp-cliã€‚å½“ä½¿ç”¨è„šæœ¬å®‰è£…å¥½æˆ‘ä»¬çš„æ¡†æ¶ä¹‹åï¼Œæ‚¨åªéœ€è¦ä¸€æ¡å‘½ä»¤ï¼Œæ— éœ€ä»»ä½•ç¼–è¯‘ï¼Œå³å¯ä½“ä¼šåˆ° eBPF çš„å¼ºå¤§ä¹‹å¤„ï¼š</p>
<pre><code class="language-console">$ lmp run sigsnoop
download with curl: https://linuxkerneltravel.github.io/lmp/sigsnoop/package.json
running and waiting for the eBPF events from perf event...
time pid tpid sig ret comm
00:21:41 109955 112863 28 0 gnome-terminal-
00:21:41 109955 112862 28 0 gnome-terminal-
...
</code></pre>
<p>å¦‚æœæ‚¨ä½¿ç”¨è¿‡ bcc ç­‰ eBPF å¼€å‘å·¥å…·ï¼Œæ‚¨ä¸€å®šä¼šæƒŠå–œäº LMP çš„ä¾¿æ·æ€§ã€‚LMP ä¸­åŒ…å«äº†å„ç§å„æ ·çš„ eBPF ç¨‹åºï¼Œè¿™ç§ä¾¿æ·çš„è¿è¡Œï¼Œç¦»ä¸å¼€æˆ‘ä»¬åŸºäºçš„åº•å±‚æ¡†æ¶ eunomia-bpfï¼Œå®ƒå®Œå…¨å®ç°äº†â€œä¸€æ¬¡ç¼–è¯‘ï¼Œå¤„å¤„è¿è¡Œâ€çš„ eBPF è·¨å¹³å°ç›®æ ‡ã€‚åœ¨ eunomia-bpf æ¡†æ¶ä¸‹ï¼ŒLMP å¼€å‘çš„ eBPF åº”ç”¨ä¸ä»…å¯ä»¥é€‚é…ä»»æ„æ¶æ„å’Œä¸åŒå†…æ ¸ç‰ˆæœ¬ï¼Œè€Œä¸”è¿˜å…·æœ‰è½»é‡çº§ã€è‰¯å¥½çš„éš”ç¦»æ€§ç­‰ä¼˜ç‚¹ï¼Œå¯ä»¥ä½œä¸ºæ’ä»¶åˆ°åµŒå…¥å¤§å‹åº”ç”¨ä¹‹ä¸­ã€‚</p>
<h2 id="eunomia-bpfç»“åˆ-ebpf-å’Œ-wasm-çš„è½»é‡çº§å¼€å‘æ¡†æ¶"><a class="header" href="#eunomia-bpfç»“åˆ-ebpf-å’Œ-wasm-çš„è½»é‡çº§å¼€å‘æ¡†æ¶">eunomia-bpfï¼šç»“åˆ eBPF å’Œ Wasm çš„è½»é‡çº§å¼€å‘æ¡†æ¶</a></h2>
<p>ä½œä¸ºä¸€ä¸ª eBPF ç¨‹åºçš„è½»é‡çº§å¼€å‘åŠ è½½æ¡†æ¶ï¼Œeunomia-bpf åŸºäº Wasm è¿è¡Œæ—¶å’Œ BTF æŠ€æœ¯ï¼ŒåŒ…å«äº†ä¸€ä¸ªç”¨æˆ·æ€åŠ¨æ€åŠ è½½æ¡†æ¶/è¿è¡Œæ—¶åº“ï¼Œä»¥åŠä¸€ä¸ªç®€å•çš„ç¼–è¯‘ Wasm å’Œ eBPF å­—èŠ‚ç çš„å·¥å…·é“¾å®¹å™¨ã€‚</p>
<p>Wasm æ˜¯ä¸ºäº†ä¸€ä¸ªå¯ç§»æ¤çš„ç›®æ ‡è€Œè®¾è®¡çš„ï¼Œå¯ä½œä¸º C/C+/RUST ç­‰é«˜çº§è¯­è¨€çš„ç¼–è¯‘ç›®æ ‡ï¼Œä½¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨ Web ä¸Šéƒ¨ç½²ã€‚ç›®å‰å·²ç»å‘å±•æˆä¸ºä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½ã€è·¨å¹³å°å’Œå¤šè¯­ç§çš„è½¯ä»¶æ²™ç›’ç¯å¢ƒï¼Œè¢«è¿ç”¨äºäº‘åŸç”Ÿè½¯ä»¶ç»„ä»¶ã€‚ eunomia-bpf å°† eBPF ç”¨æˆ·æ€çš„æ‰€æœ‰æ§åˆ¶å’Œæ•°æ®å¤„ç†é€»è¾‘å…¨éƒ¨ç§»åˆ° Wasm è™šæ‹Ÿæœºä¸­ï¼Œé€šè¿‡ Wasm module æ‰“åŒ…å’Œåˆ†å‘ eBPF å­—èŠ‚ç ï¼ŒåŒæ—¶åœ¨ Wasm è™šæ‹Ÿæœºå†…éƒ¨æ§åˆ¶æ•´ä¸ª eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œï¼Œå°†äºŒè€…çš„ä¼˜åŠ¿ç»“åˆäº†èµ·æ¥ã€‚</p>
<p>åœ¨ Wasm æ¨¡å—ä¸­ç¼–å†™ eBPF ä»£ç å’Œé€šå¸¸ç†Ÿæ‚‰çš„ä½¿ç”¨ libbpf æ¡†æ¶æˆ– Coolbpf å¼€å‘ eBPF ç¨‹åºçš„æ–¹å¼æ˜¯åŸºæœ¬ä¸€æ ·çš„ï¼ŒWasm çš„å¤æ‚æ€§ä¼šè¢«éšè—åœ¨ eunomia-bpf çš„ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶åº“ä¸­ï¼Œå¼€å‘è€…å¯ä»¥ä¸“æ³¨äº eBPF ç¨‹åºçš„å¼€å‘å’Œè°ƒè¯•ï¼Œä¸éœ€è¦äº†è§£ Wasm çš„èƒŒæ™¯çŸ¥è¯†ï¼Œä¹Ÿä¸éœ€è¦æ‹…å¿ƒ Wasm çš„ç¼–è¯‘ç¯å¢ƒé…ç½®ã€‚</p>
<p>å¤§è‡´æ¥è¯´ï¼Œeunomia-bpf åœ¨ Wasm è¿è¡Œæ—¶å’Œç”¨æˆ·æ€çš„ libbpf ä¸­é—´å¤šåŠ äº†ä¸€å±‚æŠ½è±¡å±‚ï¼Œä½¿å¾—ä¸€æ¬¡ç¼–è¯‘ã€åˆ°å¤„è¿è¡Œçš„ eBPF ä»£ç å¯ä»¥ä» JSON å¯¹è±¡ä¸­åŠ¨æ€åŠ è½½ã€‚JSON å¯¹è±¡ä¼šåœ¨ç¼–è¯‘æ—¶è¢«åŒ…å«åœ¨ Wasm æ¨¡å—ä¸­ï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è§£æ JSON å¯¹è±¡æ¥è·å– eBPF ç¨‹åºçš„ä¿¡æ¯ï¼Œç„¶ååŠ¨æ€åŠ è½½ eBPF ç¨‹åºã€‚é€šè¿‡ Wasm module æ‰“åŒ…å’Œåˆ†å‘ eBPF å­—èŠ‚ç ï¼ŒåŒæ—¶åœ¨ Wasm è™šæ‹Ÿæœºå†…éƒ¨æ§åˆ¶æ•´ä¸ª eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œï¼Œeunomia-bpf å°±å¯ä»¥å°†äºŒè€…çš„ä¼˜åŠ¿ç»“åˆèµ·æ¥ï¼Œè®©ä»»æ„ eBPF ç¨‹åºèƒ½æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>å¯ç§»æ¤ï¼šè®© eBPF å·¥å…·å’Œåº”ç”¨ä¸éœ€è¦è¿›è¡Œé‡æ–°ç¼–è¯‘å³å¯ä»¥è·¨å¹³å°åˆ†å‘ï¼Œçœå»äº†å¤æ‚çš„äº¤å‰ç¼–è¯‘æµç¨‹ï¼›</li>
<li>éš”ç¦»æ€§ï¼šè®© eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œã€ä»¥åŠç”¨æˆ·æ€çš„æ•°æ®å¤„ç†æµç¨‹æ›´åŠ å®‰å…¨å¯é ã€‚</li>
<li>åŒ…ç®¡ç†ï¼šå®Œæˆ eBPF ç¨‹åºæˆ–å·¥å…·çš„åˆ†å‘ã€ç®¡ç†ã€åŠ è½½ç­‰å·¥ä½œã€‚</li>
<li>æ•æ·æ€§ï¼šä½¿æ¯ä¸ªäººéƒ½å¯ä»¥ä½¿ç”¨å®˜æ–¹å’Œæœªç»ä¿®æ”¹çš„åº”ç”¨ç¨‹åºæ¥åŠ è½½è‡ªå®šä¹‰æ‰©å±•ï¼Œä»»ä½• eBPF ç¨‹åºçš„é”™è¯¯ä¿®å¤å’Œ/æˆ–æ›´æ–°éƒ½å¯ä»¥åœ¨è¿è¡Œæ—¶æ¨é€å’Œ/æˆ–æµ‹è¯•ï¼Œè€Œä¸éœ€è¦æ›´æ–°å’Œ/æˆ–é‡æ–°éƒ¨ç½²ä¸€ä¸ªæ–°çš„äºŒè¿›åˆ¶ã€‚</li>
<li>è½»é‡çº§ï¼šä¸ Linux å®¹å™¨åº”ç”¨ç›¸æ¯”ï¼ŒWasm å¾®æœåŠ¡å†·å¯åŠ¨çš„æ—¶é—´æ˜¯ 1%ï¼Œå¯ä»¥å®ç° eBPF as a serviceï¼Œè®© eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œå˜å¾—æ›´åŠ è½»é‡çº§ã€å¿«é€Ÿã€ç®€ä¾¿æ˜“è¡Œã€‚</li>
</ul>
<p>æˆ‘ä»¬å·²ç»æµ‹è¯•äº†åœ¨ x86ã€ARM ç­‰ä¸åŒæ¶æ„ä¸åŒå†…æ ¸ç‰ˆæœ¬çš„ Linux ç³»ç»Ÿä¸Šï¼Œeunomia-bpf æ¡†æ¶éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªé¢„ç¼–è¯‘ eBPF ç¨‹åºäºŒè¿›åˆ¶ï¼Œä»äº‘ç«¯ä¸€è¡Œå‘½ä»¤è·å–åˆ°æœ¬åœ°ä¹‹åè¿è¡Œã€‚ä¹‹å eunomia-bpf è¿˜ä¼šæ·»åŠ  RISC-V ç­‰æ›´å¤šæ¶æ„çš„æ”¯æŒã€‚</p>
<h2 id="ä½¿ç”¨-lmp-cli-æ„å»ºä¸€ä¸ª-ebpf-é¡¹ç›®"><a class="header" href="#ä½¿ç”¨-lmp-cli-æ„å»ºä¸€ä¸ª-ebpf-é¡¹ç›®">ä½¿ç”¨ lmp-cli æ„å»ºä¸€ä¸ª eBPF é¡¹ç›®</a></h2>
<p>å¦‚æœæ‚¨æ˜¯ä¸€ä¸ª eBPF å·¥å…·çš„ä½¿ç”¨è€…ï¼Œæ‚¨å¯ä»¥æ— éœ€ä»»ä½•ç¼–è¯‘æµç¨‹ï¼Œä¹Ÿä¸éœ€è¦äº†è§£ä»»ä½• eBPF å’Œ Wasm çš„ç›¸å…³çŸ¥è¯†ï¼Œä½¿ç”¨ <code>lmp run &lt;name&gt;</code> å°±å¯ä»¥ç›´æ¥è¿è¡Œ LMP ä»“åº“çš„å°ç¨‹åºï¼Œå…¶ä¸­ä¼šè°ƒç”¨<code>lmp pull &lt;name&gt;</code>å‘½ä»¤ä»äº‘ç«¯ä»åº“ä¸­ä¸‹è½½å¯¹åº”çš„å°ç¨‹åºã€‚</p>
<p>å¦‚æœæ‚¨æ˜¯ä¸€ä¸ª eBPF ç¨‹åºçš„å¼€å‘è€…ï¼Œè®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºã€ç¼–è¯‘å¹¶è¿è¡Œä¸€ä¸ªç®€å•çš„ç¨‹åºã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨åŸºç®€å•å‘½ä»¤è¡Œå·¥å…· lmp-cliï¼Œæ¦‚è¿°å¦‚ä½•ä»å››ä¸ªæ­¥éª¤å¼€å§‹æ„å»ºã€‚</p>
<h3 id="1-å‡†å¤‡ä½ çš„ç¯å¢ƒ"><a class="header" href="#1-å‡†å¤‡ä½ çš„ç¯å¢ƒ"><strong>1. å‡†å¤‡ä½ çš„ç¯å¢ƒ</strong></a></h3>
<p>eBPF æœ¬èº«æ˜¯ä¸€ç§ Linux å†…æ ¸æŠ€æœ¯ï¼Œå› æ­¤ä»»ä½•å®é™…çš„ BPF ç¨‹åºéƒ½å¿…é¡»åœ¨ Linux å†…æ ¸ä¸­è¿è¡Œã€‚æˆ‘å»ºè®®æ‚¨ä»å†…æ ¸ 5.4 æˆ–æ›´æ–°çš„ç‰ˆæœ¬å¼€å§‹ã€‚ä» SSH ç»ˆç«¯ï¼Œæ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶ç¡®è®¤æ‚¨å·²ç»å¯ç”¨äº† CONFIG_DEBUG_INFO_BTFï¼š</p>
<pre><code class="language-bash">uname -r
cat /boot/config-$(uname -r) | grep CONFIG_DEBUG_INFO_BTF
</code></pre>
<p>ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š</p>
<pre><code class="language-console">$ uname -r
5.15.0-48-generic

$ cat /boot/config-$(uname -r) | grep CONFIG_DEBUG_INFO_BTF
CONFIG_DEBUG_INFO_BTF=y
CONFIG_DEBUG_INFO_BTF_MODULES=y
</code></pre>
<p>å®‰è£…å‘½ä»¤è¡Œå·¥å…· lmp-cliï¼š</p>
<pre><code class="language-bash">curl https://github.com/GorilaMond/lmp_cli/releases/download/lmp/install.sh | sh
</code></pre>
<h3 id="2-åˆ›å»ºé¡¹ç›®çš„å†…æ ¸éƒ¨åˆ†"><a class="header" href="#2-åˆ›å»ºé¡¹ç›®çš„å†…æ ¸éƒ¨åˆ†"><strong>2. åˆ›å»º</strong>é¡¹ç›®çš„å†…æ ¸éƒ¨åˆ†</a></h3>
<p>ä½¿ç”¨<code>lmp init</code>åˆ›å»ºä¸€ä¸ªé¡¹ç›®æ¨¡æ¿ï¼Œæ¥åˆå§‹åŒ–ä½ çš„å†…æ ¸ç¨‹åºï¼Œå¿«é€Ÿåœ°æŠ•å…¥åˆ°ä»£ç çš„ç¼–å†™ä¸­ï¼š</p>
<pre><code class="language-bash">lmp init hello
</code></pre>
<p>æˆåŠŸåˆ›å»ºé¡¹ç›®åï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹ç±»ä¼¼çš„è¾“å‡ºï¼š</p>
<pre><code class="language-console">$ lmp init hello
Cloning into 'ebpm-template'...
</code></pre>
<p>å®ƒå®é™…ä¸Šåˆ›å»ºäº†ä¸€ä¸ªé¡¹ç›®åå¯¹åº”çš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æœ‰è¿™äº›æ–‡ä»¶ï¼š</p>
<pre><code class="language-console">$ cd hello/
$ ll
...
-rw-rw-r--  1 a a 2910 10æœˆ 17 23:18 bootstrap.bpf.c
-rw-rw-r--  1 a a  392 10æœˆ 17 23:18 bootstrap.h
-rw-rw-r--  1 a a  221 10æœˆ 17 23:18 config.json
drwxrwxr-x  8 a a 4096 10æœˆ 17 23:18 .git/
drwxrwxr-x  3 a a 4096 10æœˆ 17 23:18 .github/
-rw-rw-r--  1 a a   21 10æœˆ 17 23:18 .gitignore
-rw-rw-r--  1 a a 2400 10æœˆ 17 23:18 README.md
</code></pre>
<p>å†…æ ¸ç¨‹åºæ¨¡æ¿ bootstrap.bpf.c ä¸­é»˜è®¤çš„è·Ÿè¸ªç‚¹ä¸º <code>tp/sched/sched_process_exec</code>å’Œ<code>tp/sched/sched_process_exit</code>ï¼Œç”¨æ¥è·Ÿè¸ªæ–°ç¨‹åºçš„æ‰§è¡Œå’Œé€€å‡ºï¼Œè¿™é‡Œä¸åšä¿®æ”¹ã€‚</p>
<p>æ„å»ºå†…æ ¸é¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ä¿å­˜æ‚¨çš„æ›´æ”¹ï¼Œä½¿ç”¨ <code>sudo lmp build</code> æ„å»ºå†…æ ¸ç¨‹åºï¼Œè¿™ä¼šåˆ›å»ºä¸€ä¸ªåä¸º package.json çš„å¯¹è±¡æ–‡ä»¶ã€‚</p>
<pre><code class="language-console">$ sudo lmp build
make
  ...
  BINARY   client
  DUMP_LLVM_MEMORY_LAYOUT
  DUMP_EBPF_PROGRAM
  FIX_TYPE_INFO_IN_EBPF
  GENERATE_PACKAGE_JSON
</code></pre>
<h3 id="3-è¿è¡Œå†…æ ¸ç¨‹åº"><a class="header" href="#3-è¿è¡Œå†…æ ¸ç¨‹åº"><strong>3. è¿è¡Œ</strong>å†…æ ¸ç¨‹åº</a></h3>
<p>å¯ä»¥ä½¿ç”¨<code>lmp run package.json</code>è¿è¡Œå†…æ ¸ç¨‹åºï¼Œæ²¡æœ‰ç”¨æˆ·ç«¯ç¨‹åºå¯¹æ•°æ®çš„å¤„ç†çš„æƒ…å†µä¸‹ï¼Œè¯¥æ¡†æ¶ä¸‹å†…æ ¸ç¨‹åºå°†ä¼šè¾“å‡ºæ‰€æœ‰è¢« output çš„æ•°æ®ï¼š</p>
<pre><code class="language-console">$ sudo lmp run ./package.json
running and waiting for the ebpf events from ring buffer...
time pid ppid exit_code duration_ns comm filename exit_event
</code></pre>
<p>ä¸€å¼€å§‹æ‚¨ä¸ä¼šçœ‹åˆ°ä»»ä½•æ•°æ®ï¼Œåªæœ‰å½“å†…æ ¸çš„è·Ÿè¸ªç‚¹è¢«è§¦å‘æ—¶ï¼Œè¿™é‡Œæ˜¯æ–°çš„è¿›ç¨‹è¢«åˆ›å»ºæˆ–é€€å‡ºæ—¶ï¼Œæ‰ä¼šè¾“å‡ºæ•°æ®ã€‚è¿™é‡Œæ–°å»ºäº†ä¸€ä¸ªè™šæ‹Ÿç»ˆç«¯ï¼Œè¾“å‡ºäº†å¦‚ä¸‹æ•°æ®ï¼š</p>
<pre><code class="language-console">23:31:31 111788 109955 0 0 bash /bin/bash 0
23:31:31 111790 111788 0 0 lesspipe /usr/bin/lesspipe 0
...
</code></pre>
<h3 id="4-æ·»åŠ ç”¨æˆ·æ€ç¨‹åº"><a class="header" href="#4-æ·»åŠ ç”¨æˆ·æ€ç¨‹åº"><strong>4. æ·»åŠ </strong>ç”¨æˆ·æ€ç¨‹åº</a></h3>
<p>æˆ‘ä»¬æä¾›çš„æ˜¯ demo æ˜¯ C è¯­è¨€ç‰ˆæœ¬çš„ Wasm å¼€å‘æ¡†æ¶ï¼Œåœ¨æ„å»ºå¥½çš„å†…æ ¸é¡¹ç›®æ–‡ä»¶å¤¹å†…ï¼Œä½¿ç”¨ <code>sudo lmp gen-wasm-skel</code> ç”Ÿæˆä¸€ä¸ª Wasm ç”¨æˆ·æ€é¡¹ç›®æ¨¡æ¿ï¼Œapp.cã€eunomia-includeã€ewasm-skel.h è¿™äº›æ–‡ä»¶ä¼šè¢«ç”Ÿæˆã€‚ewasm-skel.h æ˜¯è¢«æ‰“åŒ…ä¸ºå¤´æ–‡ä»¶çš„å†…æ ¸ç¨‹åºï¼Œapp.c æ˜¯ç”¨æˆ·æ€ç¨‹åºçš„æ¨¡æ¿æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹å®ƒæ¥è¿›è¡Œè‡ªå®šä¹‰çš„æ•°æ®å¤„ç†ï¼Œè¿™é‡Œä¸åšä¿®æ”¹ã€‚</p>
<pre><code class="language-console">$ sudo lmp gen-wasm-skel
make
  BPF      .output/client.bpf.o
...
</code></pre>
<p>ä½¿ç”¨<code>sudo lmp build-wasm</code>æ„å»ºç”¨æˆ·æ€ç¨‹åºï¼Œç”Ÿæˆ app.wasm æ–‡ä»¶</p>
<pre><code class="language-console">$ sudo lmp build-wasm
make
  BPF      .output/client.bpf.o
...
</code></pre>
<p>ä½¿ç”¨<code>lmp run app.wasm</code>è¿è¡Œç”¨æˆ·æ€ç¨‹åºï¼Œjson æ ¼å¼çš„è¾“å‡ºä¸ºé€šç”¨çš„æ•°æ®å¤„ç†åšå¥½äº†å‡†å¤‡ï¼š</p>
<pre><code class="language-console">$ lmp run app.wasm
running and waiting for the ebpf events from ring buffer...
{&quot;pid&quot;:112665,&quot;ppid&quot;:109955,&quot;exit_code&quot;:0,&quot;duration_ns&quot;:0,&quot;comm&quot;:&quot;bash&quot;,&quot;filename&quot;:&quot;/bin/bash&quot;,&quot;exit_event&quot;:0}
{&quot;pid&quot;:112667,&quot;ppid&quot;:112665,&quot;exit_code&quot;:0,&quot;duration_ns&quot;:0,&quot;comm&quot;:&quot;lesspipe&quot;,&quot;filename&quot;:&quot;/usr/bin/lesspipe&quot;,&quot;exit_event&quot;:0}
{&quot;pid&quot;:112668,&quot;ppid&quot;:112667,&quot;exit_code&quot;:0,&quot;duration_ns&quot;:0,&quot;comm&quot;:&quot;basename&quot;,&quot;filename&quot;:&quot;/usr/bin/basename&quot;,&quot;exit_event&quot;:0}
...
</code></pre>
<h2 id="å¦ä¸€ä¸ªä¾‹å­ä½¿ç”¨-ebpf-æ‰“å°è¿›ç¨‹å†…å­˜ä½¿ç”¨çŠ¶å†µ"><a class="header" href="#å¦ä¸€ä¸ªä¾‹å­ä½¿ç”¨-ebpf-æ‰“å°è¿›ç¨‹å†…å­˜ä½¿ç”¨çŠ¶å†µ">å¦ä¸€ä¸ªä¾‹å­ï¼šä½¿ç”¨ eBPF æ‰“å°è¿›ç¨‹å†…å­˜ä½¿ç”¨çŠ¶å†µ</a></h2>
<p>å¯ä»¥å°† bootstrap.bpf.c é‡å‘½åä¸º procstat.bpf.cï¼Œå°† bootstrap.h é‡å‘½åä¸º procstat.hï¼Œç„¶åç¼–è¯‘è¿è¡Œã€‚å¯¹åº”çš„æºä»£ç å¦‚ä¸‹ï¼š</p>
<p>procstat.bpf.c</p>
<pre><code class="language-c">#include &quot;vmlinux.h&quot;
#include &lt;bpf/bpf_helpers.h&gt;
#include &lt;bpf/bpf_tracing.h&gt;
#include &lt;bpf/bpf_core_read.h&gt;
#include &quot;procstat.h&quot;

char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

struct {
 __uint(type, BPF_MAP_TYPE_RINGBUF);
 __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);


SEC(&quot;kprobe/finish_task_switch&quot;)
int BPF_KPROBE(finish_task_switch, struct task_struct *prev)
{
 struct event *e;
 struct mm_rss_stat rss = {};
 struct mm_struct *mms;
 long long *t;

 e = bpf_ringbuf_reserve(&amp;rb, sizeof(*e), 0);
 if (!e)
  return 0;

 e-&gt;pid = BPF_CORE_READ(prev, pid);
 e-&gt;vsize = BPF_CORE_READ(prev, mm, total_vm);
 e-&gt;Vdata = BPF_CORE_READ(prev, mm, data_vm);
 e-&gt;Vstk = BPF_CORE_READ(prev, mm, stack_vm);
 e-&gt;nvcsw = BPF_CORE_READ(prev, nvcsw);
 e-&gt;nivcsw = BPF_CORE_READ(prev, nivcsw);

 rss = BPF_CORE_READ(prev, mm, rss_stat);
 t = (long long *)(rss.count);
 e-&gt;rssfile = *t;
 e-&gt;rssanon = *(t + 1);
 e-&gt;vswap = *(t + 2);
 e-&gt;rssshmem = *(t + 3);
 e-&gt;size = *t + *(t + 1) + *(t + 3);

 bpf_ringbuf_submit(e, 0);
 return 0;
}
</code></pre>
<p>proc.h</p>
<pre><code class="language-c">#ifndef __BOOTSTRAP_H
#define __BOOTSTRAP_H

#define TASK_COMM_LEN 16
#define MAX_FILENAME_LEN 127

struct event {
/*è¿›ç¨‹å†…å­˜çŠ¶æ€æŠ¥å‘Š*/
    pid_t pid;
    long nvcsw;
    long nivcsw;
    long vsize;              //è™šæ‹Ÿå†…å­˜
    long size;               //ç‰©ç†å†…å­˜
    long long rssanon;       //åŒ¿åé¡µé¢
    long long rssfile;       //æ–‡ä»¶é¡µé¢
    long long rssshmem;      //å…±äº«é¡µé¢
    long long vswap;         //äº¤æ¢é¡µé¢
    long long Hpages;        //hugetlbPages
    long Vdata;              //Private data segments
    long Vstk;               //User stack
    long long VPTE;
};
#endif /* __BOOTSTRAP_H */
</code></pre>
<p>å…·ä½“çš„ä¸ŠæŠ¥äº‹ä»¶ä¿¡æ¯åœ¨ event ç»“æ„ä½“ä¸­å®šä¹‰ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody>
<tr><td>vsize</td><td>è¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜</td></tr>
<tr><td>size</td><td>è¿›ç¨‹ä½¿ç”¨çš„æœ€å¤§ç‰©ç†å†…å­˜</td></tr>
<tr><td>rssanon</td><td>è¿›ç¨‹ä½¿ç”¨çš„åŒ¿åé¡µé¢</td></tr>
<tr><td>rssfile</td><td>è¿›ç¨‹ä½¿ç”¨çš„æ–‡ä»¶æ˜ å°„é¡µé¢</td></tr>
<tr><td>rssshmem</td><td>è¿›ç¨‹ä½¿ç”¨çš„å…±äº«å†…å­˜é¡µé¢</td></tr>
<tr><td>vswap</td><td>è¿›ç¨‹ä½¿ç”¨çš„äº¤æ¢åˆ†åŒºå¤§å°</td></tr>
<tr><td>vdata</td><td>è¿›ç¨‹ä½¿ç”¨çš„ç§æœ‰æ•°æ®æ®µå¤§å°</td></tr>
<tr><td>vpte</td><td>è¿›ç¨‹é¡µè¡¨å¤§å°</td></tr>
<tr><td>vstk</td><td>è¿›ç¨‹ç”¨æˆ·æ ˆå¤§å°</td></tr>
</tbody></table>
</div>
<p>æŒ‚è½½ç‚¹ä¸æŒ‚è½½åŸå› åˆ†æï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œè·å–è¿›ç¨‹çº§åˆ«å†…å­˜ä½¿ç”¨ä¿¡æ¯éœ€è¦è·å–åˆ°è¿›ç¨‹çš„ task_struct ç»“æ„ä½“ï¼Œå…¶ä¸­åœ¨ mm_struct æˆå‘˜ä¸­å­˜åœ¨ä¸€ä¸ªä¿å­˜è¿›ç¨‹å½“å‰å†…å­˜ä½¿ç”¨çŠ¶æ€çš„æ•°ç»„ç»“æ„ï¼Œå› æ­¤æœ‰å…³è¿›ç¨‹çš„å¤§éƒ¨åˆ†å†…å­˜ä½¿ç”¨ä¿¡æ¯éƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªæ•°ç»„è·å¾—ã€‚</li>
<li>å…¶æ¬¡ï¼Œéœ€è¦æ³¨æ„å‡½æ•°çš„æ’å…¥ç‚¹ï¼Œæ’å…¥ç‚¹çš„é€‰å–å…³ç³»åˆ°æ•°æ®å‡†ç¡®æ€§æ˜¯å¦å¾—åˆ°ä¿è¯ï¼Œè€Œåœ¨è¿›ç¨‹çš„å†…å­˜ç”³è¯·ï¼Œé‡Šæ”¾ï¼Œè§„æ•´ç­‰ä»£ç è·¯å¾„ä¸Šéƒ½å­˜åœ¨é¡µé¢çŠ¶æ€æ”¹å˜ï¼Œä½†æ˜¯æ•°é‡ä¿¡æ¯è¿˜æ²¡æœ‰æ›´æ–°çš„ç›¸å…³ç»“æ„ä¸­çš„æƒ…å†µï¼Œå¦‚æœæ’å…¥ç‚¹è¿™ä¸¤è€…ä¸­é—´ï¼Œæ•°æ®å°±ä¼šå’Œå®é™…æƒ…å†µå­˜åœ¨å·®å¼‚ï¼Œæ‰€æœ‰åœ¨ç¡®ä¿å¯ä»¥è·å–åˆ°è¿›ç¨‹ PCB çš„å‰æä¸‹ï¼Œé€‰æ‹©åœ¨è¿›ç¨‹è°ƒåº¦ä»£ç è·¯å¾„ä¸Šè€ƒè™‘ã€‚è€Œ finish_task_switch å‡½æ•°æ˜¯æ–°ä¸€ä¸ªè¿›ç¨‹ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„å‡½æ•°ï¼Œåšçš„äº‹å´æ˜¯ç»™ä¸Šä¸€ä¸ªè¢«è°ƒåº¦å‡ºå»çš„è¿›ç¨‹åšæ”¶å°¾å·¥ä½œï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ PCBï¼Œä»è¿™å—è·å¾—ä¸Šä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ä¿¡æ¯å°±å¯ä»¥ç¡®ä¿åœ¨å®ƒæ²¡æœ‰å†æ¬¡è¢«è°ƒåº¦ä¸Š CPU æ‰§è¡Œçš„è¿™æ®µæ—¶é—´å†…çš„å†…å­˜æ•°æ®ç¨³å®šæ€§ã€‚</li>
<li>å› æ­¤æœ€åé€‰æ‹©å°†ç¨‹åºæŒ‚è½½åˆ° finish_task_switch å‡½æ•°ä¸Šã€‚æ•°æ®æ¥æºæœ‰ä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ mm_struc ç»“æ„æœ¬èº«å­˜åœ¨çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨ mm_rss_stat ç»“æ„ä¸­ã€‚</li>
</ul>
<p>ä¹Ÿå¯ä»¥åœ¨ bolipi çš„å¹³å°ä¸­åœ¨çº¿ç¼–è¯‘ï¼Œåœ¨çº¿ä½“éªŒè¿è¡Œ eBPF ç¨‹åºï¼š<a href="https://bolipi.com/ebpf/home/online">https://bolipi.com/ebpf/home/online</a></p>
<p>å®Œæ•´çš„ä»£ç ã€æ–‡æ¡£å’Œè¿è¡Œç»“æœå¯ä»¥åœ¨ LMP ä¸­ eBPF_Supermarket å¤„æ‰¾åˆ°ï¼š<a href="https://github.com/linuxkerneltravel/lmp/tree/develop/eBPF_Supermarket/Memory_Subsystem/memstat/procstat">eBPF_Supermarket/Memory_Subsystem/memstat/procstat</a></p>
<h2 id="ç›¸å…³èƒŒæ™¯"><a class="header" href="#ç›¸å…³èƒŒæ™¯">ç›¸å…³èƒŒæ™¯</a></h2>
<p>LMP é¡¹ç›®çš„æˆç«‹åˆè¡·æ˜¯ï¼š</p>
<ul>
<li>é¢å‘ eBPF åˆå­¦è€…å’Œçˆ±å¥½è€…ï¼Œæä¾› eBPF å­¦ä¹ èµ„æ–™ã€ç¨‹åº/é¡¹ç›®æ¡ˆä¾‹ï¼Œæ„å»º eBPF å­¦ä¹ ç¤¾åŒº</li>
<li>æˆä¸º eBPF å·¥å…·é›†æ•£åœ°ï¼Œæˆ‘ä»¬ç›¸ä¿¡æ¯ä¸€ä½ eBPF åˆå­¦è€…å’Œçˆ±å¥½è€…éƒ½æœ‰æ— é™çš„åˆ›é€ åŠ›</li>
<li>å­µåŒ– eBPF æƒ³æ³•ã€ç›¸å…³å·¥å…·ã€é¡¹ç›®</li>
</ul>
<p>LMP ç›®å‰åˆ†ä¸ºå››ä¸ªå­é¡¹ç›®ï¼š</p>
<ul>
<li>eBPF_Supermarket ä¸­åŒ…å«äº†å¤§é‡ç”±ä¸ªäººå¼€å‘è€…ç¼–å†™çš„ eBPF å·¥å…·ï¼Œè¦†ç›–äº†ç½‘ç»œã€æ€§èƒ½åˆ†æã€å®‰å…¨ç­‰å¤šç§åŠŸèƒ½ï¼›</li>
<li>eBPF_Hub æ˜¯è§„èŒƒåŒ–çš„ eBPF ç¨‹åºåº“ï¼Œå¯ä»¥éšæ—¶ä¸‹è½½è¿è¡Œï¼›</li>
<li>eBPF_Visualization æ˜¯ä¸º eBPF ç¨‹åºç®¡ç†è€Œå¼€å‘çš„ web ç®¡ç†ç³»ç»Ÿï¼Œèšç„¦ eBPF æ•°æ®å¯è§†åŒ–å’Œå†…æ ¸å¯è§†åŒ–ï¼›</li>
<li>eBPF_Documentation ä¸ºç¤¾åŒºæ”¶é›†ã€æ¢³ç†å’ŒåŸåˆ›çš„ eBPF ç›¸å…³èµ„æ–™å’Œæ–‡æ¡£ã€‚</li>
</ul>
<p>å½“å‰ LMP é¡¹ç›®ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚å¯¹äº eBPF å·¥å…·çš„å¼€å‘è€…ï¼Œå­˜åœ¨éå¸¸å¤šè€Œä¸”å¤æ‚çš„ç”¨æˆ·æ€å¯è§†åŒ–ã€å±•ç¤ºæ–¹æ¡ˆï¼Œæœ‰è®¸å¤šå¥—ç³»ç»Ÿæä¾›å¯è§†åŒ–çš„å®ç°å¹¶ä¸”æœ‰å¤šç§è¯­è¨€æ··åˆï¼Œç¼ºä¹å±•ç¤ºæ ‡å‡†ã€ä¹Ÿéš¾ä»¥è¿›è¡Œå¯è§†åŒ–çš„æ•´åˆç­‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›å°è¯•å€ŸåŠ© eunomia-bpf æä¾›çš„ç¬¦åˆ OCI æ ‡å‡†çš„ Wasm å’Œ eBPF ç¨‹åºï¼Œæä¾›æ ‡å‡†åŒ–ã€é«˜å¯æ‰©å±•æ€§çš„åŸºäº eBPF çš„å¯è§†åŒ–ã€æ•°æ®å±•ç¤ºã€åˆ†æå¹³å°ï¼Œåˆ©ç”¨ ORAS ç®€åŒ–æ‰©å±• eBPF çš„åˆ†å‘ã€åŠ è½½ã€è¿è¡Œèƒ½åŠ›ï¼Œä¸º eBPF å·¥å…·çš„å¼€å‘è€…å’Œä½¿ç”¨è€…æä¾›æ›´åŠ ç®€å•ã€é«˜æ•ˆçš„ä½“éªŒã€‚</p>
<h3 id="webassembly"><a class="header" href="#webassembly">WebAssembly</a></h3>
<p>WebAssembly æ˜¯ä¸€ç§æ–°çš„ç¼–ç æ–¹å¼ï¼Œå¯ä»¥åœ¨ç°ä»£çš„ç½‘ç»œæµè§ˆå™¨ä¸­è¿è¡Œ ï¼ å®ƒæ˜¯ä¸€ç§ä½çº§çš„ç±»æ±‡ç¼–è¯­è¨€ï¼Œå…·æœ‰ç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¯ä»¥æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½è¿è¡Œï¼Œå¹¶ä¸ºè¯¸å¦‚ c\c++ ç­‰è¯­è¨€æä¾›ä¸€ä¸ªç¼–è¯‘ç›®æ ‡ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨ Web ä¸Šè¿è¡Œã€‚å®ƒä¹Ÿè¢«è®¾è®¡ä¸ºå¯ä»¥ä¸ JavaScript å…±å­˜ï¼Œå…è®¸ä¸¤è€…ä¸€èµ·å·¥ä½œã€‚è€Œä¸”ï¼Œæ›´æ£’çš„æ˜¯ï¼Œè¿™æ˜¯é€šè¿‡ W3C WebAssembly Community Group å¼€å‘çš„ä¸€é¡¹ç½‘ç»œæ ‡å‡†ï¼Œå¹¶å¾—åˆ°äº†æ¥è‡ªå„å¤§ä¸»è¦æµè§ˆå™¨å‚å•†çš„ç§¯æå‚ä¸ã€‚</p>
<p>å°½ç®¡ WebAssembly æ˜¯ä¸ºè¿è¡Œåœ¨ Web ä¸Šè®¾è®¡çš„ï¼Œå®ƒä¹Ÿå¯ä»¥åœ¨å…¶å®ƒçš„ç¯å¢ƒä¸­è‰¯å¥½åœ°è¿è¡Œã€‚åŒ…æ‹¬ä»ç”¨ä½œæµ‹è¯•çš„æœ€å°åŒ– shell ï¼Œåˆ°å®Œå…¨çš„åº”ç”¨ç¯å¢ƒ â€”â€” ä¾‹å¦‚ï¼šåœ¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡å™¨ã€ç‰©è”ç½‘ï¼ˆIoTï¼‰è®¾å¤‡æˆ–è€…æ˜¯ç§»åŠ¨/æ¡Œé¢åº”ç”¨ç¨‹åºã€‚ç”šè‡³ï¼Œè¿è¡ŒåµŒå…¥åœ¨è¾ƒå¤§ç¨‹åºé‡Œçš„ WebAssembly ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚é€šå¸¸ï¼Œé€šè¿‡ç»´æŒä¸éœ€è¦ Web API çš„é Web è·¯å¾„ï¼ŒWebAssembly èƒ½å¤Ÿåœ¨è®¸å¤šå¹³å°ä¸Šç”¨ä½œä¾¿æºå¼çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œä¸ºç§»æ¤æ€§ã€å·¥å…·å’Œè¯­è¨€æ— å…³æ€§å¸¦æ¥å·¨å¤§çš„å¥½å¤„ã€‚ï¼ˆå› ä¸ºå®ƒæ”¯æŒ c\c++ çº§è¯­ä¹‰ï¼‰</p>
<p>Wasm çš„ç¼–è¯‘å’Œéƒ¨ç½²æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/xHicTWic3y1Dtt9CBh8SCA6QQdW7jTrAibKoxAVrXfe0slwf8iav97kbxe2bRVXclfias4hlTDI4fNBQ2RXvFBe9BEA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="xxx" />â€‹
<em>wasm-compile-deploy</em></p>
<h3 id="ociopen-container-initiative"><a class="header" href="#ociopen-container-initiative">OCI(Open Container Initiative)</a></h3>
<p>å¼€æ”¾å®¹å™¨åè®®(OCI)æ˜¯ä¸€ä¸ªè½»é‡çº§ï¼Œå¼€æ”¾çš„æ²»ç†ç»“æ„ï¼Œä¸ºå®¹å™¨æŠ€æœ¯å®šä¹‰äº†è§„èŒƒå’Œæ ‡å‡†ã€‚åœ¨ Linux åŸºé‡‘ä¼šçš„æ”¯æŒä¸‹æˆç«‹ï¼Œç”±å„å¤§è½¯ä»¶ä¼ä¸šæ„æˆï¼Œè‡´åŠ›äºå›´ç»•å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶åˆ›å»ºå¼€æ”¾çš„è¡Œä¸šæ ‡å‡†ã€‚å…¶ä¸­åŒ…æ‹¬äº†ä½¿ç”¨ Container Registries è¿›è¡Œå·¥ä½œçš„ APIï¼Œæ­£å¼åç§°ä¸º OCI åˆ†å‘è§„èŒƒ(åˆåâ€œdistribution-specâ€)ã€‚è¿™ä¸ªå‘å¸ƒè§„èŒƒæ˜¯åŸºäº Docker å…¬å¸æœ€åˆå‘å¸ƒçš„å¼€æºæ³¨å†ŒæœåŠ¡å™¨ç¼–å†™çš„ï¼Œå®ƒå­˜åœ¨äº GitHub çš„<a href="https://github.com/distribution/distribution">distribution/distribution</a>ï¼ˆç°åœ¨æ˜¯<a href="https://www.cncf.io/">CNCF</a>é¡¹ç›®ï¼‰ä¸Šã€‚</p>
<p>OCI ç›®å‰æå‡ºçš„è§„èŒƒæœ‰å¦‚ä¸‹è¿™äº›ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>åç§°</th><th>ç‰ˆæœ¬</th></tr></thead><tbody>
<tr><td><a href="https://github.com/opencontainers/runtime-spec">Runtime Specification</a></td><td>v1.0.2</td></tr>
<tr><td><a href="https://github.com/opencontainers/image-spec">Image Format</a></td><td>v1.0.2</td></tr>
<tr><td><a href="https://github.com/opencontainers/distribution-spec">Distribution Specification</a></td><td>v1.0.1</td></tr>
</tbody></table>
</div>
<p>å…¶ä¸­ runtime å’Œ image çš„è§„èŒƒéƒ½å·²ç»æ­£å¼å‘å¸ƒï¼Œè€Œ distribution çš„è¿˜åœ¨å·¥ä½œä¹‹ä¸­ã€‚runtime è§„èŒƒä¸­ä»‹ç»äº†å¦‚ä½•è¿è¡Œè§£å‹ç¼©åˆ°ç£ç›˜ä¸Šçš„ <a href="https://github.com/opencontainers/runtime-spec/blob/master/bundle.md"><code>Filesystem Bundle</code></a>ã€‚åœ¨ OCI æ ‡å‡†ä¸‹ï¼Œè¿è¡Œä¸€ä¸ªå®¹å™¨çš„è¿‡ç¨‹å°±æ˜¯ä¸‹è½½ä¸€ä¸ª OCI çš„é•œåƒï¼Œå°†å…¶è§£å‹åˆ°æŸä¸ª <code>Filesystem Bundle</code> ä¸­ï¼Œç„¶åæŸä¸ª OCI Runtime å°±ä¼šè¿è¡Œè¿™ä¸ª Bundleã€‚</p>
<p>ä¼´éšç€ image spec ä¸ distribution spec çš„æ¼”åŒ–ï¼Œäººä»¬å¼€å§‹é€æ­¥è®¤è¯†åˆ°é™¤äº† Container Images ä¹‹å¤–ï¼ŒRegistries è¿˜èƒ½å¤Ÿç”¨æ¥åˆ†å‘ Kubernetes Deployment Files, Helm Charts, docker-compose, <a href="https://cnab.io/">CNAB</a> ç­‰äº§ç‰©ã€‚å®ƒä»¬å¯ä»¥å…±ç”¨åŒä¸€å¥— APIï¼ŒåŒä¸€å¥—å­˜å‚¨ï¼Œå°† Registries ä½œä¸ºä¸€ä¸ªäº‘å­˜å‚¨ç³»ç»Ÿã€‚è¿™å°±ä¸ºå¸¦æ¥äº† OCI Artifacts çš„æ¦‚å¿µï¼Œç”¨æˆ·èƒ½å¤ŸæŠŠæ‰€æœ‰çš„äº§ç‰©éƒ½å­˜å‚¨åœ¨ OCI å…¼å®¹çš„ Registiry å½“ä¸­å¹¶è¿›è¡Œåˆ†å‘ã€‚ä¸ºæ­¤ï¼ŒMicrosoft å°† <a href="https://github.com/deislabs/oras">oras</a> ä½œä¸ºä¸€ä¸ª client ç«¯å®ç°æèµ ç»™äº†ç¤¾åŒºï¼ŒåŒ…æ‹¬ Harbor åœ¨å†…çš„å¤šä¸ªé¡¹ç›®éƒ½åœ¨ç§¯æçš„å‚ä¸ã€‚</p>
<h3 id="orasoci-registry-as-storage"><a class="header" href="#orasoci-registry-as-storage">ORAS(OCI Registry As Storage)</a></h3>
<p>Registries æ­£åœ¨é€æ¸æ¼”å˜ä¸ºé€šç”¨çš„ç»„ä»¶å­˜å‚¨åº“ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼ŒORAS é¡¹ç›®æä¾›äº†ä¸€ç§å°† OCI Artifacts ä» OCI Registries æäº¤å’Œæ‹‰å–çš„æ–¹æ³•ã€‚æ­£åœ¨å¯»æ±‚é€šç”¨ Registries å®¢æˆ·ç«¯çš„ç”¨æˆ·å¯ä»¥ä»<a href="https://oras.land/CLI/">ORAS CLI</a>ä¸­å¾—åˆ°å¸®åŠ©ï¼Œè€Œå¼€å‘äººå‘˜å¯ä»¥åœ¨<a href="https://oras.land/client_libraries/">ORAS å®¢æˆ·ç«¯çš„å¼€å‘åº“</a>ä¹‹ä¸Šæ„å»ºè‡ªå·±çš„å®¢æˆ·ç«¯ã€‚</p>
<p>ORAS çš„å·¥ä½œåŸç†ä¸æ‚¨å¯èƒ½å·²ç»ç†Ÿæ‚‰çš„å·¥å…·(å¦‚ docker)ç±»ä¼¼ã€‚å®ƒå…è®¸æ‚¨å‘ OCI Registries æ¨é€(ä¸Šä¼ )å’Œæå–(ä¸‹è½½)å†…å®¹ï¼Œå¹¶å¤„ç†ç™»å½•(èº«ä»½éªŒè¯)å’Œä»¤ç‰Œæµ(æˆæƒ)ã€‚ORAS çš„ä¸åŒä¹‹å¤„åœ¨äºå°†ç„¦ç‚¹ä»å®¹å™¨æ˜ åƒè½¬ç§»åˆ°å…¶ä»–ç±»å‹çš„ç»„ä»¶ä¸Šã€‚</p>
<p>å› æ­¤ï¼Œé¼“åŠ±æ–°çš„ OCI Artifacts çš„ä½œè€…å®šä¹‰ä»–ä»¬è‡ªå·±çš„ç»„ä»¶åª’ä½“ç±»å‹ï¼Œä»¥ä½¿å¾—ä»–ä»¬çš„ç”¨æˆ·çŸ¥é“å¦‚ä½•å¯¹å…¶è¿›è¡Œæ“ä½œã€‚</p>
<p>å¦‚æœæ‚¨å¸Œæœ›ç«‹å³å¼€å§‹å‘å¸ƒ OCI Artifactsï¼Œè¯·æŸ¥çœ‹<a href="https://oras.land/CLI/">ORAS CLI</a>ã€‚å¸Œæœ›æä¾›ç»™è‡ªå·±ç”¨æˆ·ä½“éªŒçš„å¼€å‘äººå‘˜åº”è¯¥ä½¿ç”¨ä¸€ä¸ª ORAS å®¢æˆ·ç«¯å¼€å‘åº“ã€‚</p>
<h2 id="æœªæ¥çš„å‘å±•æ–¹å‘"><a class="header" href="#æœªæ¥çš„å‘å±•æ–¹å‘">æœªæ¥çš„å‘å±•æ–¹å‘</a></h2>
<p>æœªæ¥ LMP ä¼šä¸“æ³¨äºæ›´å¤šçš„åŸºäº eBPF çš„åº”ç”¨å·¥å…·å’Œå®è·µçš„å¼€å‘ï¼š</p>
<ol>
<li>è¿›ä¸€æ­¥å®Œå–„ ORAS å’Œ OCI é•œåƒç›¸å…³çš„æ”¯æŒï¼›</li>
<li>é‡æ„å¹¶è¿ç§»ç°æœ‰çš„ eBPF å·¥å…·ï¼Œæä¾›å®Œæ•´çš„ã€å¼€ç®±å³ç”¨çš„åˆ†æå·¥å…·ç»„ä»¶ï¼Œä¾‹å¦‚æ€§èƒ½å·¥ç¨‹ç­‰æ–¹é¢ï¼›</li>
<li>æ¢ç´¢å’Œå­µåŒ–æ›´å¤šçš„ eBPF æƒ³æ³•ã€ç›¸å…³å·¥å…·ã€é¡¹ç›®ï¼›</li>
</ol>
<p>æˆ‘ä»¬æ‰€åŸºäºçš„ eunomia-bpf é¡¹ç›®ä¹Ÿä¼šç»§ç»­å®Œå–„ï¼Œä¸“æ³¨äºæä¾›ä¸€ä¸ªåº•å±‚çš„ eBPF å¼€å‘å¹³å°å’Œè¿è¡Œæ—¶åŸºç¡€è®¾æ–½ï¼ŒåŠ›æ±‚å¸¦æ¥æ›´å¥½çš„å¼€å‘å’Œç§»æ¤ä½“éªŒï¼š</p>
<ol>
<li>æµ‹è¯•æ›´å¤šå¹³å°å’Œå†…æ ¸ç‰ˆæœ¬çš„æ”¯æŒï¼Œç›®å‰å·²ç»åœ¨ <code>ARM64</code> å’Œ <code>x86_64</code> ä¸ŠæˆåŠŸç§»æ¤å¹¶è¿è¡Œï¼Œæ¥ä¸‹æ¥ä¼šå¯¹ä½å†…æ ¸ç‰ˆæœ¬ã€Androidã€RISC-V ç­‰å¹³å°ï¼Œä»¥åŠåµŒå…¥å¼ã€è¾¹ç¼˜è®¡ç®—ç›¸å…³çš„è®¾å¤‡è¿›è¡Œæ›´è¿›ä¸€æ­¥çš„æµ‹è¯•ï¼›ä¹Ÿè®¸åœ¨æœªæ¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æä¾› Windows ä¸Šçš„ eBPF ç¨‹åºæ”¯æŒå’Œç±»ä¼¼çš„å¼€å‘ä½“éªŒï¼›</li>
<li>æä¾›æ ‡å‡†åŒ–ã€ç¨³å®šçš„ JSON å’Œ Wasm æ¥å£åè®®è§„èŒƒä»¥åŠ OCI é•œåƒè§„èŒƒï¼Œä¸å’Œä»»ä½•çš„ä¾›åº”å•†æˆ–äº‘æœåŠ¡ç»‘å®šã€‚å¦‚æœä¸ä½¿ç”¨ eunomia-bpf ç›¸å…³çš„åº•å±‚è¿è¡Œæ—¶ï¼Œæˆ–ä½¿ç”¨è‡ªå®šä¹‰çš„ Wasm è¿è¡Œæ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ ‡å‡†åŒ–çš„æ¥å£æ¥ä½¿ç”¨ LMP ä¸­å·²ç»æœ‰çš„å¤§é‡ eBPF ç¨‹åºç”Ÿæ€ã€‚</li>
<li>æä¾›æ›´å‹å¥½çš„ç”¨æˆ·æ€å¼€å‘æ¥å£ï¼Œä»¥åŠæ›´å¤šçš„ç”¨æˆ·æ€å¼€å‘è¯­è¨€ SDKï¼Œä¾‹å¦‚ Goã€Rustã€Python ç­‰ï¼›</li>
<li>è¿›è¡Œæ›´å¤šå…³äº Wasm å’Œ eBPF ç»“åˆçš„æ¢ç´¢ï¼›</li>
</ol>
<h2 id="å‚è€ƒèµ„æ–™--æ¨èé˜…è¯»"><a class="header" href="#å‚è€ƒèµ„æ–™--æ¨èé˜…è¯»">å‚è€ƒèµ„æ–™ &amp; æ¨èé˜…è¯»</a></h2>
<ul>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf">eunomia-bpf: ä¸€ä¸ª eBPF ç¨‹åºåŠ¨æ€åŠ è½½æ¡†æ¶</a></li>
<li><a href="https://github.com/linuxkerneltravel/lmp">LMP project: Linux æ˜¾å¾®é•œ</a></li>
<li><a href="https://oras.land/">OCI Registry As Storage (oras.land)</a></li>
<li><a href="https://mp.weixin.qq.com/s/ryT7OqWngCjcCkfeSKjutA">å½“ Wasm é‡è§ eBPFï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åº | é¾™èœ¥æŠ€æœ¯ (qq.com)</a></li>
<li><a href="https://xuanwo.io/2019/08/06/oci-intro/">å¼€æ”¾å®¹å™¨æ ‡å‡†(OCI) å†…éƒ¨åˆ†äº« (xuanwo.io)</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly">WebAssembly | MDN (mozilla.org)</a></li>
<li><a href="http://webassembly.org.cn/docs/non-web/">éç½‘ç»œåµŒå…¥ - WebAssembly ä¸­æ–‡ç½‘|Wasm ä¸­æ–‡æ–‡æ¡£</a></li>
<li><a href="https://bolipi.com/ebpf/home/online">eBPF åœ¨çº¿å­¦ä¹ å¹³å°ï¼šbolipi.com/ebpf/home/online</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>#! https://zhuanlan.zhihu.com/p/589784295</p>
<h1 id="eunomia-bpf-030-å‘å¸ƒåªéœ€ç¼–å†™å†…æ ¸æ€ä»£ç è½»æ¾æ„å»ºæ‰“åŒ…å‘å¸ƒå®Œæ•´çš„-ebpf-åº”ç”¨"><a class="header" href="#eunomia-bpf-030-å‘å¸ƒåªéœ€ç¼–å†™å†…æ ¸æ€ä»£ç è½»æ¾æ„å»ºæ‰“åŒ…å‘å¸ƒå®Œæ•´çš„-ebpf-åº”ç”¨">eunomia-bpf 0.3.0 å‘å¸ƒï¼šåªéœ€ç¼–å†™å†…æ ¸æ€ä»£ç ï¼Œè½»æ¾æ„å»ºã€æ‰“åŒ…ã€å‘å¸ƒå®Œæ•´çš„ eBPF åº”ç”¨</a></h1>
<h2 id="eunomia-bpf-ç®€ä»‹"><a class="header" href="#eunomia-bpf-ç®€ä»‹">eunomia-bpf ç®€ä»‹</a></h2>
<p>eBPF æºäº BPFï¼Œæœ¬è´¨ä¸Šæ˜¯å¤„äºå†…æ ¸ä¸­çš„ä¸€ä¸ªé«˜æ•ˆä¸çµæ´»çš„è™šæ‹Ÿæœºç»„ä»¶ï¼Œä»¥ä¸€ç§å®‰å…¨çš„æ–¹å¼åœ¨è®¸å¤šå†…æ ¸ hook ç‚¹æ‰§è¡Œå­—èŠ‚ç ï¼Œå¼€å‘è€…å¯åŸºäº eBPF å¼€å‘æ€§èƒ½åˆ†æå·¥å…·ã€è½¯ä»¶å®šä¹‰ç½‘ç»œã€å®‰å…¨ç­‰è¯¸å¤šåœºæ™¯ã€‚ä½†æ˜¯ï¼Œç›®å‰å¯¹äºå¼€å‘å’Œä½¿ç”¨ eBPF åº”ç”¨è€Œè¨€è¿˜å¯èƒ½å­˜åœ¨ä¸€äº›ä¸å¤Ÿæ–¹ä¾¿çš„åœ°æ–¹ï¼š</p>
<ul>
<li>æ­å»ºå’Œå¼€å‘ eBPF ç¨‹åºæ˜¯ä¸€ä¸ªé—¨æ§›æ¯”è¾ƒé«˜ã€æ¯”è¾ƒå¤æ‚çš„å·¥ä½œï¼Œå¿…é¡»åŒæ—¶å…³æ³¨å†…æ ¸æ€å’Œç”¨æˆ·æ€ä¸¤ä¸ªæ–¹é¢çš„äº¤äº’å’Œä¿¡æ¯å¤„ç†ï¼Œæœ‰æ—¶è¿˜è¦é…ç½®ç¯å¢ƒå’Œç¼–å†™å¯¹åº”çš„æ„å»ºè„šæœ¬ï¼›</li>
<li>ç›®å‰ä¸åŒç”¨æˆ·æ€è¯­è¨€å¦‚ Cã€Goã€Rust ç­‰ç¼–å†™çš„å·¥å…·éš¾ä»¥å…¼å®¹ã€éš¾ä»¥ç»Ÿä¸€ç®¡ç†ï¼Œå¤šç§å¼€å‘ç”Ÿæ€éš¾ä»¥æ•´åˆï¼šå¦‚ä½•è·¨æ¶æ„ã€è·¨è¯­è¨€å’Œå†…æ ¸ç‰ˆæœ¬ï¼Œä½¿ç”¨æ ‡å‡†åŒ–çš„æ–¹å¼æ–¹ä¾¿åˆå¿«æ·çš„æ‰“åŒ…ã€åˆ†å‘ã€å‘å¸ƒäºŒè¿›åˆ¶ eBPF ç¨‹åºï¼ŒåŒæ—¶è¿˜éœ€è¦èƒ½å¾ˆæ–¹ä¾¿åœ°åŠ¨æ€è°ƒæ•´ eBPF ç¨‹åºçš„æŒ‚è½½ç‚¹ã€å‚æ•°ç­‰ç­‰ï¼Ÿ</li>
<li>å¦‚ä½•æ›´æ–¹ä¾¿åœ°ä½¿ç”¨ eBPF çš„å·¥å…·ï¼šæœ‰æ²¡æœ‰å¯èƒ½ä»äº‘ç«¯ä¸€è¡Œå‘½ä»¤æ‹‰ä¸‹æ¥å°±ä½¿ç”¨ï¼Œç±»ä¼¼ docker é‚£æ ·ï¼Ÿæˆ–è€…æŠŠ eBPF ç¨‹åºä½œä¸ºæœåŠ¡è¿è¡Œï¼Œé€šè¿‡ HTTP è¯·æ±‚å’Œ URL å³å¯çƒ­æ›´æ–°ã€åŠ¨æ€æ’æ‹”è¿è¡Œä»»æ„ä¸€ä¸ª eBPF ç¨‹åºï¼Ÿ</li>
</ul>
<p><a href="https://github.com/eunomia-bpf/eunomia-bpf">eunomia-bpf</a> æ˜¯ä¸€ä¸ªå¼€æºçš„ eBPF åŠ¨æ€åŠ è½½è¿è¡Œæ—¶å’Œå¼€å‘å·¥å…·é“¾ï¼Œæ˜¯ä¸ºäº†ç®€åŒ– eBPF ç¨‹åºçš„å¼€å‘ã€æ„å»ºã€åˆ†å‘ã€è¿è¡Œè€Œè®¾è®¡çš„ï¼ŒåŸºäº libbpf çš„ CO-RE è½»é‡çº§å¼€å‘æ¡†æ¶ã€‚</p>
<p>ä½¿ç”¨ eunomia-bpf ï¼Œå¯ä»¥ï¼š</p>
<ul>
<li>åœ¨ç¼–å†™ eBPF ç¨‹åºæˆ–å·¥å…·æ—¶åªç¼–å†™å†…æ ¸æ€ä»£ç ï¼Œè‡ªåŠ¨è·å–å†…æ ¸æ€å¯¼å‡ºä¿¡æ¯ï¼›</li>
<li>ä½¿ç”¨ Wasm è¿›è¡Œç”¨æˆ·æ€äº¤äº’ç¨‹åºçš„å¼€å‘ï¼Œåœ¨ Wasm è™šæ‹Ÿæœºå†…éƒ¨æ§åˆ¶æ•´ä¸ª eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œï¼Œä»¥åŠå¤„ç†ç›¸å…³æ•°æ®ï¼›</li>
<li>eunomia-bpf å¯ä»¥å°†é¢„ç¼–è¯‘çš„ eBPF ç¨‹åºæ‰“åŒ…ä¸ºé€šç”¨çš„ JSON æˆ– Wasm æ¨¡å—ï¼Œè·¨æ¶æ„å’Œå†…æ ¸ç‰ˆæœ¬è¿›è¡Œåˆ†å‘ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘å³å¯åŠ¨æ€åŠ è½½è¿è¡Œã€‚</li>
</ul>
<p>eunomia-bpf ç”±ä¸€ä¸ªç¼–è¯‘å·¥å…·é“¾å’Œä¸€ä¸ªè¿è¡Œæ—¶åº“ç»„æˆ, å¯¹æ¯”ä¼ ç»Ÿçš„ BCCã€åŸç”Ÿ libbpf ç­‰æ¡†æ¶ï¼Œå¤§å¹…ç®€åŒ–äº† eBPF ç¨‹åºçš„å¼€å‘æµç¨‹ï¼Œåœ¨å¤§å¤šæ•°æ—¶å€™åªéœ€ç¼–å†™å†…æ ¸æ€ä»£ç ï¼Œå³å¯è½»æ¾æ„å»ºã€æ‰“åŒ…ã€å‘å¸ƒå®Œæ•´çš„ eBPF åº”ç”¨ï¼ŒåŒæ—¶å†…æ ¸æ€ eBPF ä»£ç ä¿è¯å’Œä¸»æµçš„ libbpf, libbpfgo, libbpf-rs ç­‰å¼€å‘æ¡†æ¶çš„ 100% å…¼å®¹æ€§ã€‚éœ€è¦ç¼–å†™ç”¨æˆ·æ€ä»£ç çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å€ŸåŠ© Webassembly(Wasm) å®ç°é€šè¿‡å¤šç§è¯­è¨€è¿›è¡Œç”¨æˆ·æ€å¼€å‘ã€‚å’Œ bpftrace ç­‰è„šæœ¬å·¥å…·ç›¸æ¯”, eunomia-bpf ä¿ç•™äº†ç±»ä¼¼çš„ä¾¿æ·æ€§, åŒæ—¶ä¸ä»…å±€é™äº trace æ–¹é¢, å¯ä»¥ç”¨äºæ›´å¤šçš„åœºæ™¯, å¦‚ç½‘ç»œã€å®‰å…¨ç­‰ç­‰ã€‚</p>
<blockquote>
<ul>
<li>eunomia-bpf é¡¹ç›® Github åœ°å€: <a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>gitee é•œåƒ: <a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
</ul>
</blockquote>
<p>æˆ‘ä»¬å‘å¸ƒäº†æœ€æ–°çš„ 0.3 ç‰ˆæœ¬, å¯¹äºæ•´ä½“çš„å¼€å‘å’Œä½¿ç”¨æµç¨‹è¿›è¡Œäº†ä¼˜åŒ–ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒäº†æ›´å¤šçš„ eBPF ç¨‹åºå’Œ maps ç±»å‹ã€‚</p>
<h2 id="è¿è¡Œæ—¶ä¼˜åŒ–å¢å¼ºåŠŸèƒ½æ€§-å¢åŠ å¤šç§ç¨‹åºç±»å‹"><a class="header" href="#è¿è¡Œæ—¶ä¼˜åŒ–å¢å¼ºåŠŸèƒ½æ€§-å¢åŠ å¤šç§ç¨‹åºç±»å‹">è¿è¡Œæ—¶ä¼˜åŒ–ï¼šå¢å¼ºåŠŸèƒ½æ€§, å¢åŠ å¤šç§ç¨‹åºç±»å‹</a></h2>
<ol>
<li>
<p>åªéœ€ç¼–å†™å†…æ ¸æ€ä»£ç , å³å¯è·å¾—å¯¹åº”çš„è¾“å‡ºä¿¡æ¯, ä»¥å¯è¯»ã€è§„æ•´çš„æ–¹å¼æ‰“å°åˆ°æ ‡å‡†è¾“å‡º. ä»¥ä¸€ä¸ªç®€å•çš„ eBPF ç¨‹åº, è·Ÿè¸ªæ‰€æœ‰ open ç±»å‹ç³»ç»Ÿè°ƒç”¨çš„ opensnoop ä¸ºä¾‹:</p>
<p>å¤´æ–‡ä»¶ opensnoop.h</p>
<pre><code class="language-c">#ifndef __OPENSNOOP_H
#define __OPENSNOOP_H

#define TASK_COMM_LEN 16
#define NAME_MAX 255
#define INVALID_UID ((uid_t)-1)

// used for export event
struct event {
  /* user terminology for pid: */
  unsigned long long ts;
  int pid;
  int uid;
  int ret;
  int flags;
  char comm[TASK_COMM_LEN];
  char fname[NAME_MAX];
};

#endif /* __OPENSNOOP_H */
</code></pre>
<p>å†…æ ¸æ€ä»£ç  opensnoop.bpf.c</p>
<pre><code class="language-c">#include &lt;vmlinux.h&gt;
#include &lt;bpf/bpf_helpers.h&gt;
#include &quot;opensnoop.h&quot;

struct args_t {
  const char *fname;
  int flags;
};

/// Process ID to trace
const volatile int pid_target = 0;
/// Thread ID to trace
const volatile int tgid_target = 0;
/// @description User ID to trace
const volatile int uid_target = 0;
/// @cmdarg {&quot;default&quot;: false, &quot;short&quot;: &quot;f&quot;, &quot;long&quot;: &quot;failed&quot;}
const volatile bool targ_failed = false;

struct {
  __uint(type, BPF_MAP_TYPE_HASH);
  __uint(max_entries, 10240);
  __type(key, u32);
  __type(value, struct args_t);
} start SEC(&quot;.maps&quot;);

struct {
  __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);
  __uint(key_size, sizeof(u32));
  __uint(value_size, sizeof(u32));
} events SEC(&quot;.maps&quot;);

static __always_inline bool valid_uid(uid_t uid) {
  return uid != INVALID_UID;
}

static __always_inline
bool trace_allowed(u32 tgid, u32 pid)
{
  u32 uid;

  /* filters */
  if (tgid_target &amp;&amp; tgid_target != tgid)
    return false;
  if (pid_target &amp;&amp; pid_target != pid)
    return false;
  if (valid_uid(uid_target)) {
    uid = (u32)bpf_get_current_uid_gid();
    if (uid_target != uid) {
      return false;
    }
  }
  return true;
}

SEC(&quot;tracepoint/syscalls/sys_enter_open&quot;)
int tracepoint__syscalls__sys_enter_open(struct trace_event_raw_sys_enter* ctx)
{
  u64 id = bpf_get_current_pid_tgid();
  /* use kernel terminology here for tgid/pid: */
  u32 tgid = id &gt;&gt; 32;
  u32 pid = id;

  /* store arg info for later lookup */
  if (trace_allowed(tgid, pid)) {
    struct args_t args = {};
    args.fname = (const char *)ctx-&gt;args[0];
    args.flags = (int)ctx-&gt;args[1];
    bpf_map_update_elem(&amp;start, &amp;pid, &amp;args, 0);
  }
  return 0;
}

SEC(&quot;tracepoint/syscalls/sys_enter_openat&quot;)
int tracepoint__syscalls__sys_enter_openat(struct trace_event_raw_sys_enter* ctx)
{
  u64 id = bpf_get_current_pid_tgid();
  /* use kernel terminology here for tgid/pid: */
  u32 tgid = id &gt;&gt; 32;
  u32 pid = id;

  /* store arg info for later lookup */
  if (trace_allowed(tgid, pid)) {
    struct args_t args = {};
    args.fname = (const char *)ctx-&gt;args[1];
    args.flags = (int)ctx-&gt;args[2];
    bpf_map_update_elem(&amp;start, &amp;pid, &amp;args, 0);
  }
  return 0;
}

static __always_inline
int trace_exit(struct trace_event_raw_sys_exit* ctx)
{
  struct event event = {};
  struct args_t *ap;
  int ret;
  u32 pid = bpf_get_current_pid_tgid();

  ap = bpf_map_lookup_elem(&amp;start, &amp;pid);
  if (!ap)
    return 0; /* missed entry */
  ret = ctx-&gt;ret;
  if (targ_failed &amp;&amp; ret &gt;= 0)
    goto cleanup; /* want failed only */

  /* event data */
  event.pid = bpf_get_current_pid_tgid() &gt;&gt; 32;
  event.uid = bpf_get_current_uid_gid();
  bpf_get_current_comm(&amp;event.comm, sizeof(event.comm));
  bpf_probe_read_user_str(&amp;event.fname, sizeof(event.fname), ap-&gt;fname);
  event.flags = ap-&gt;flags;
  event.ret = ret;

  /* emit event */
  bpf_perf_event_output(ctx, &amp;events, BPF_F_CURRENT_CPU,
            &amp;event, sizeof(event));

cleanup:
  bpf_map_delete_elem(&amp;start, &amp;pid);
  return 0;
}

SEC(&quot;tracepoint/syscalls/sys_exit_open&quot;)
int tracepoint__syscalls__sys_exit_open(struct trace_event_raw_sys_exit* ctx)
{
  return trace_exit(ctx);
}

SEC(&quot;tracepoint/syscalls/sys_exit_openat&quot;)
int tracepoint__syscalls__sys_exit_openat(struct trace_event_raw_sys_exit* ctx)
{
  return trace_exit(ctx);
}

/// Trace open family syscalls.
char LICENSE[] SEC(&quot;license&quot;) = &quot;GPL&quot;;
</code></pre>
<p>ç¼–è¯‘è¿è¡Œ:</p>
<pre><code class="language-console">$ ecc opensnoop.bpf.c opensnoop.h
Compiling bpf object...
Generating export types...
Packing ebpf object and config into package.json...
$ sudo ecli examples/bpftools/opensnoop/package.json
TIME     TS      PID     UID     RET     FLAGS   COMM    FNAME
20:31:50  0      1       0       51      524288  systemd /proc/614/cgroup
20:31:50  0      33182   0       25      524288  ecli    /etc/localtime
20:31:53  0      754     0       6       0       irqbalance /proc/interrupts
20:31:53  0      754     0       6       0       irqbalance /proc/stat
20:32:03  0      754     0       6       0       irqbalance /proc/interrupts
20:32:03  0      754     0       6       0       irqbalance /proc/stat
20:32:03  0      632     0       7       524288  vmtoolsd /etc/mtab
20:32:03  0      632     0       9       0       vmtoolsd /proc/devices

$ sudo ecli examples/bpftools/opensnoop/package.json --pid_target 754
TIME     TS      PID     UID     RET     FLAGS   COMM    FNAME
20:34:13  0      754     0       6       0       irqbalance /proc/interrupts
20:34:13  0      754     0       6       0       irqbalance /proc/stat
20:34:23  0      754     0       6       0       irqbalance /proc/interrupts
20:34:23  0      754     0       6       0       irqbalance /proc/stat
</code></pre>
<p>æˆ–ä½¿ç”¨ docker ç¼–è¯‘:</p>
<pre><code class="language-shell">docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest
</code></pre>
<p>ç¼–è¯‘å‘å¸ƒå, ä¹Ÿå¯ä»¥è½»æ¾ä»äº‘ç«¯ä¸€è¡Œå‘½ä»¤å¯åŠ¨ä»»æ„ eBPF ç¨‹åº, ä¾‹å¦‚:</p>
<pre><code class="language-bash">wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli     # download the release from https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecli
sudo ./ecli https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/package.json # simply run a pre-compiled ebpf code from a url
sudo ./ecli sigsnoop:latest # run with a name and download the latest version bpf tool from our repo
</code></pre>
<p>å®Œæ•´ä»£ç åœ¨è¿™é‡Œ: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop</a></p>
</li>
<li>
<p>æ”¯æŒæ ¹æ®ä»£ç ä¸­çš„æ³¨é‡Šä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆç”¨æˆ·æ€å‘½ä»¤è¡Œå‚æ•°ã€‚</p>
<p>æ¯”å¦‚éœ€è¦å®ç°ä¸€ä¸ª ebpf ç¨‹åºé‡Œé¢çš„ pid è¿‡æ»¤å™¨ï¼Œåªéœ€è¦ç¼–å†™å†…æ ¸æ€ä»£ç ï¼Œåœ¨ eBPF ä¸­å£°æ˜å…¨å±€å˜é‡ï¼Œå³å¯è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤è¡Œå‚æ•°ï¼š</p>
<pre><code class="language-c">/// Process ID to trace
const volatile pid_t pid_target = 0;
/// Thread ID to trace
const volatile pid_t tgid_target = 0;
/// @description User ID to trace
const volatile uid_t uid_target = 0;
/// @cmdarg {&quot;default&quot;: false, &quot;short&quot;: &quot;f&quot;, &quot;long&quot;: &quot;failed&quot;}
/// @description target pid to trace
const volatile bool targ_failed = false;
</code></pre>
<p>æˆ‘ä»¬ä¼šå°†æ³¨é‡Šæ–‡æ¡£çš„æè¿°ä¿¡æ¯æå–ï¼Œæ”¾åœ¨é…ç½®æ–‡ä»¶é‡Œé¢ï¼Œå¹¶ä¸”å˜æˆ eBPF åº”ç”¨çš„å‘½ä»¤è¡Œå‚æ•°. ä½¿ç”¨æ–¹å¼ä»¥è·Ÿè¸ªæ‰€æœ‰ open ç³»ç»Ÿè°ƒç”¨çš„ opensnoop ä¸ºä¾‹ï¼š</p>
<pre><code class="language-console">$ sudo ecli  examples/bpftools/opensnoop/package.json -h
Usage: opensnoop_bpf [--help] [--version] [--verbose] [--pid_target VAR] [--tgid_target VAR] [--uid_target VAR] [--failed]

Trace open family syscalls.

Optional arguments:
  -h, --help    shows help message and exits
  -v, --version prints version information and exits
  --verbose     prints libbpf debug information
  --pid_target  Process ID to trace
  --tgid_target Thread ID to trace

$ sudo ecli examples/bpftools/opensnoop/package.json --pid_target 754
TIME     TS      PID     UID     RET     FLAGS   COMM    FNAME
20:34:13  0      754     0       6       0       irqbalance /proc/interrupts
20:34:13  0      754     0       6       0       irqbalance /proc/stat
20:34:23  0      754     0       6       0       irqbalance /proc/interrupts
20:34:23  0      754     0       6       0       irqbalance /proc/stat
</code></pre>
</li>
<li>
<p>æ”¯æŒè‡ªåŠ¨é‡‡é›†å’Œç»¼åˆé ring buffer å’Œ perf event çš„ mapï¼Œæ¯”å¦‚ hash mapï¼Œæ‰“å°å‡ºä¿¡æ¯æˆ–ç”Ÿæˆç›´æ–¹å›¾ã€‚</p>
<p>ä¹‹å‰ä½¿ç”¨ ring buffer å’Œ perf event çš„åœºæ™¯ä¼šç¨å¾®å—é™ï¼Œå› æ­¤éœ€è¦æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥è‡ªåŠ¨ä» maps é‡Œé¢é‡‡é›†æ•°æ®ï¼Œåœ¨æºä»£ç é‡Œé¢æ·»åŠ æ³¨é‡Šå³å¯ï¼š</p>
<pre><code class="language-c">/// @sample {&quot;interval&quot;: 1000, &quot;type&quot; : &quot;log2_hist&quot;}
struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, MAX_ENTRIES);
    __type(key, u32);
    __type(value, struct hist);
} hists SEC(&quot;.maps&quot;);
</code></pre>
<p>å°±ä¼šæ¯éš”ä¸€ç§’å»é‡‡é›†ä¸€æ¬¡ counters é‡Œé¢çš„å†…å®¹ï¼ˆprint_mapï¼‰ï¼Œä»¥ runqlat ä¸ºä¾‹ï¼š</p>
<pre><code class="language-console">$ sudo ecli examples/bpftools/runqlat/package.json -h
Usage: runqlat_bpf [--help] [--version] [--verbose] [--filter_cg] [--targ_per_process] [--targ_per_thread] [--targ_per_pidns] [--targ_ms] [--targ_tgid VAR]

Summarize run queue (scheduler) latency as a histogram.

Optional arguments:
  -h, --help            shows help message and exits
  -v, --version         prints version information and exits
  --verbose             prints libbpf debug information
  --filter_cg           set value of bool variable filter_cg
  --targ_per_process    set value of bool variable targ_per_process
  --targ_per_thread     set value of bool variable targ_per_thread
  --targ_per_pidns      set value of bool variable targ_per_pidns
  --targ_ms             set value of bool variable targ_ms
  --targ_tgid           set value of pid_t variable targ_tgid

Built with eunomia-bpf framework.
See https://github.com/eunomia-bpf/eunomia-bpf for more information.

$ sudo ecli examples/bpftools/runqlat/package.json
key =  4294967295
comm = rcu_preempt

    (unit)              : count    distribution
        0 -&gt; 1          : 9        |****                                    |
        2 -&gt; 3          : 6        |**                                      |
        4 -&gt; 7          : 12       |*****                                   |
        8 -&gt; 15         : 28       |*************                           |
       16 -&gt; 31         : 40       |*******************                     |
       32 -&gt; 63         : 83       |****************************************|
       64 -&gt; 127        : 57       |***************************             |
      128 -&gt; 255        : 19       |*********                               |
      256 -&gt; 511        : 11       |*****                                   |
      512 -&gt; 1023       : 2        |                                        |
     1024 -&gt; 2047       : 2        |                                        |
     2048 -&gt; 4095       : 0        |                                        |
     4096 -&gt; 8191       : 0        |                                        |
     8192 -&gt; 16383      : 0        |                                        |
    16384 -&gt; 32767      : 1        |                                        |

$ sudo ecli examples/bpftools/runqlat/package.json --targ_per_process
key =  3189
comm = cpptools

    (unit)              : count    distribution
        0 -&gt; 1          : 0        |                                        |
        2 -&gt; 3          : 0        |                                        |
        4 -&gt; 7          : 0        |                                        |
        8 -&gt; 15         : 1        |***                                     |
       16 -&gt; 31         : 2        |*******                                 |
       32 -&gt; 63         : 11       |****************************************|
       64 -&gt; 127        : 8        |*****************************           |
      128 -&gt; 255        : 3        |**********                              |
</code></pre>
<p>å®Œæ•´ä»£ç åœ¨è¿™é‡Œ: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/runqlat">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/runqlat</a></p>
</li>
<li>
<p>æ·»åŠ å¯¹ uprobe, tc ç­‰å¤šç§ç±»å‹ map çš„æ”¯æŒ, å…è®¸ç”¨æ ‡è®°å®ç°æ·»åŠ é¢å¤– attach ä¿¡æ¯, ä¾‹å¦‚:</p>
<pre><code class="language-c">
/// @tchook {&quot;ifindex&quot;:1, &quot;attach_point&quot;:&quot;BPF_TC_INGRESS&quot;}
/// @tcopts {&quot;handle&quot;:1,  &quot;priority&quot;:1}
SEC(&quot;tc&quot;)
int tc_ingress(struct __sk_buff *ctx)
{
    void *data_end = (void *)(__u64)ctx-&gt;data_end;
    void *data = (void *)(__u64)ctx-&gt;data;
    struct ethhdr *l2;
    struct iphdr *l3;

    if (ctx-&gt;protocol != bpf_htons(ETH_P_IP))
        return TC_ACT_OK;

    l2 = data;
    if ((void *)(l2 + 1) &gt; data_end)
        return TC_ACT_OK;

    l3 = (struct iphdr *)(l2 + 1);
    if ((void *)(l3 + 1) &gt; data_end)
        return TC_ACT_OK;

    bpf_printk(&quot;Got IP packet: tot_len: %d, ttl: %d&quot;, bpf_ntohs(l3-&gt;tot_len), l3-&gt;ttl);
    return TC_ACT_OK;
}
</code></pre>
</li>
</ol>
<h2 id="ç¼–è¯‘æ–¹é¢ç¼–è¯‘ä½“éªŒä¼˜åŒ–æ ¼å¼æ”¹è¿›"><a class="header" href="#ç¼–è¯‘æ–¹é¢ç¼–è¯‘ä½“éªŒä¼˜åŒ–æ ¼å¼æ”¹è¿›">ç¼–è¯‘æ–¹é¢ï¼šç¼–è¯‘ä½“éªŒä¼˜åŒ–ã€æ ¼å¼æ”¹è¿›</a></h2>
<ol>
<li>å®Œå…¨é‡æ„äº†ç¼–è¯‘å·¥å…·é“¾å’Œé…ç½®æ–‡ä»¶æ ¼å¼ï¼Œå›å½’æœ¬è´¨çš„é…ç½®æ–‡ä»¶ + ebpf å­—èŠ‚ç  .o çš„å½¢å¼ï¼Œä¸å¼ºåˆ¶æ‰“åŒ…æˆ JSON æ ¼å¼ï¼Œå¯¹åˆ†å‘ä½¿ç”¨å’Œäººç±»ç¼–è¾‘é…ç½®æ–‡ä»¶æ›´å‹å¥½ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ›´å¥½åœ°å’Œ libbpf ç›¸å…³å·¥å…·é“¾å…¼å®¹;</li>
<li>æ”¯æŒ JSON å’Œ YAML ä¸¤ç§å½¢å¼çš„é…ç½®æ–‡ä»¶ï¼ˆxxx.skel.yaml å’Œ xxx.skel.jsonï¼‰ï¼Œæˆ–æ‰“åŒ…æˆ package.json å’Œ package.yaml è¿›è¡Œåˆ†å‘;</li>
<li>å°½å¯èƒ½ä½¿ç”¨ BTF ä¿¡æ¯è¡¨è¾¾ç¬¦å·ç±»å‹ï¼Œå¹¶ä¸”æŠŠ BTF ä¿¡æ¯éšè—åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œè®©é…ç½®æ–‡ä»¶æ›´å¯è¯»å’Œå¯ç¼–è¾‘ï¼ŒåŒæ—¶å¤ç”¨ libbpf æä¾›çš„ BTF å¤„ç†æœºåˆ¶ï¼Œå®Œå–„å¯¹äºç±»å‹çš„å¤„ç†ï¼›</li>
<li>æ”¯æŒæ›´å¤šçš„æ•°æ®å¯¼å‡ºç±»å‹ï¼šenumã€structã€bool ç­‰ç­‰</li>
<li>ç¼–è¯‘éƒ¨åˆ†å¯ä»¥ä¸ä¾èµ–äº docker è¿è¡Œï¼Œå¯ä»¥å®‰è£…äºŒè¿›åˆ¶å’Œå¤´æ–‡ä»¶åˆ° ~/.eunomiaï¼ˆå¯¹åµŒå…¥å¼æˆ–è€…å›½å†…ç½‘ç»œæ›´å‹å¥½ï¼Œæ›´æ–¹ä¾¿ä½¿ç”¨ï¼‰ï¼ŒåŸæœ¬ docker çš„ä½¿ç”¨æ–¹å¼è¿˜æ˜¯å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼›</li>
<li>æ–‡ä»¶åæ²¡æœ‰ç‰¹å®šé™åˆ¶ï¼Œä¸éœ€è¦ä¸€å®šæ˜¯ xxx.bpf.h å’Œ xxx.bpf.cï¼Œå¯ä»¥é€šè¿‡ ecc æŒ‡å®šå½“å‰ç›®å½•ä¸‹éœ€è¦ç¼–è¯‘çš„æ–‡ä»¶;</li>
<li>æŠŠ example ä¸­æ—§çš„ xxx.bpf.h å¤´æ–‡ä»¶ä¿®æ”¹ä¸º xxx.hï¼Œå’Œ libbpf-tools å’Œ libbpf-boostrap ä¿æŒä¸€è‡´ï¼Œç¡®ä¿ 0 ä»£ç ä¿®æ”¹å³å¯å¤ç”¨ libbpf ç›¸å…³ä»£ç ç”Ÿæ€ï¼›</li>
<li>å¤§å¹…åº¦ä¼˜åŒ–ç¼–è¯‘é€Ÿåº¦å’Œå‡å°‘ç¼–è¯‘ä¾èµ–ï¼Œä½¿ç”¨ Rust é‡æ„äº†ç¼–è¯‘å·¥å…·é“¾ï¼Œæ›¿æ¢åŸå…ˆçš„ python è„šæœ¬;</li>
</ol>
<p>åœ¨é…ç½®æ–‡ä»¶ä¸­, å¯ä»¥ç›´æ¥ä¿®æ”¹ progs/attach æ§åˆ¶æŒ‚è½½ç‚¹ï¼Œvariables/value æ§åˆ¶å…¨å±€å˜é‡ï¼Œmaps/data æ§åˆ¶åœ¨åŠ è½½ ebpf ç¨‹åºæ—¶å¾€ map é‡Œé¢æ”¾ä»€ä¹ˆæ•°æ®ï¼Œexport_types/members æ§åˆ¶å¾€ç”¨æˆ·æ€ä¼ è¾“ä»€ä¹ˆæ•°æ®æ ¼å¼ï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘ eBPF ç¨‹åºã€‚é…ç½®æ–‡ä»¶å’Œ bpf.o äºŒè¿›åˆ¶æ˜¯é…å¥—çš„ï¼Œåº”è¯¥æ­é…ä½¿ç”¨ï¼Œæˆ–è€…æ‰“åŒ…æˆä¸€ä¸ª package.json/yaml åˆ†å‘ã€‚æ‰“åŒ…çš„æ—¶å€™ä¼šè¿›è¡Œå‹ç¼©ï¼Œä¸€èˆ¬æ¥è¯´å‹ç¼©åçš„é…ç½®æ–‡ä»¶å’ŒäºŒè¿›åˆ¶åˆèµ·æ¥çš„å¤§å°åœ¨æ•°å kb ã€‚</p>
<p>é…ç½®æ–‡ä»¶ä¸¾ä¾‹:</p>
<pre><code class="language-yaml">bpf_skel:
  data_sections:
  - name: .rodata
    variables:
    - name: min_duration_ns
      type: unsigned long long
      value: 100
  maps:
  - ident: exec_start
    name: exec_start
    data:
      - key: 123
        value: 456
  - ident: rb
    name: rb
  - ident: rodata
    mmaped: true
    name: client_b.rodata
  obj_name: client_bpf
  progs:
  - attach: tp/sched/sched_process_exec
    link: true
    name: handle_exec
export_types:
- members:
  - name: pid
    type: int
  - name: ppid
    type: int
  - name: comm
    type: char[16]
  - name: filename
    type: char[127]
  - name: exit_event
    type: bool
  name: event
  type_id: 613
</code></pre>
<h2 id="ä¸‹è½½å®‰è£…-eunomia-bpf"><a class="header" href="#ä¸‹è½½å®‰è£…-eunomia-bpf">ä¸‹è½½å®‰è£… eunomia-bpf</a></h2>
<ul>
<li>
<p>Install the <code>ecli</code> tool for running eBPF program from the cloud:</p>
<pre><code class="language-console">$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
$ ./ecli -h
Usage: ecli [--help] [--version] [--json] [--no-cache] url-and-args
....
</code></pre>
</li>
<li>
<p>Install the compiler-toolchain for compiling eBPF kernel code to a <code>config</code> file or <code>Wasm</code> module:</p>
<pre><code class="language-console">$ wget https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecc &amp;&amp; chmod +x ./ecc
$ ./ecc -h
eunomia-bpf compiler
Usage: ecc [OPTIONS] &lt;SOURCE_PATH&gt; [EXPORT_EVENT_HEADER]
....
....
</code></pre>
<p>or use the docker image for compile:</p>
<pre><code class="language-bash">docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest # compile with docker. `pwd` should contains *.bpf.c files and *.h files.
</code></pre>
</li>
</ul>
<h2 id="ä¸‹ä¸€æ­¥å‘å±•çš„è®¡åˆ’"><a class="header" href="#ä¸‹ä¸€æ­¥å‘å±•çš„è®¡åˆ’">ä¸‹ä¸€æ­¥å‘å±•çš„è®¡åˆ’</a></h2>
<ol>
<li>å’Œæ›´å¤šçš„ç¤¾åŒºä¼™ä¼´åˆä½œ, å¹¶é€æ­¥å½¢æˆæ ‡å‡†åŒ–çš„, ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ– Wasm äºŒè¿›åˆ¶è¿›è¡Œæ‰“åŒ…åˆ†å‘, ä¸€æ¬¡ç¼–è¯‘, åˆ°å¤„è¿è¡Œçš„ eBPF ç¨‹åºæ ¼å¼;</li>
<li>å’Œ LMP ç¤¾åŒºä¸€èµ·, å®Œå–„åŸºäº ORAS, OCI å’Œ Wasm çš„ eBPF ç¨‹åºåˆ†å‘å’Œè¿è¡Œæ—¶æ ‡å‡†, è®©ä»»æ„ eBPF åº”ç”¨å‡å¯ä»äº‘ç«¯ä¸€è¡Œå‘½ä»¤æ‹‰ä¸‹æ¥ç›´æ¥è¿è¡Œ, æˆ–è½»æ¾åµŒå…¥å…¶ä»–åº”ç”¨ä¸­ä½¿ç”¨, æ— éœ€å…³æ³¨æ¶æ„, å†…æ ¸ç‰ˆæœ¬ç­‰ç»†èŠ‚;</li>
<li>å°è¯•å’Œ Coolbpf ç¤¾åŒºä¸€åŒå®Œå–„è¿œç¨‹ç¼–è¯‘, ä½ç‰ˆæœ¬æ”¯æŒçš„ç‰¹æ€§, ä»¥åŠæ”¯æŒ RPC çš„ libbpf åº“;</li>
<li>å®Œå–„ç”¨æˆ·æ€ Wasm å’Œ eBPF ç¨‹åºä¹‹é—´çš„äº’æ“ä½œæ€§, æ¢ç´¢ WASI çš„ç›¸å…³æ‰©å±•;</li>
</ol>
<h2 id="å‚è€ƒèµ„æ–™-4"><a class="header" href="#å‚è€ƒèµ„æ–™-4">å‚è€ƒèµ„æ–™</a></h2>
<ol>
<li><a href="https://eunomia-bpf.github.io/blog/ebpf-wasm.html">å½“ Wasm é‡è§ eBPF ï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åº</a></li>
<li><a href="https://eunomia-bpf.github.io/blog/lmp-eunomia.html">å¦‚ä½•åœ¨ Linux æ˜¾å¾®é•œï¼ˆLMPï¼‰é¡¹ç›®ä¸­å¼€å¯ eBPF ä¹‹æ—…ï¼Ÿ</a></li>
<li><a href="https://openanolis.cn/sig/ebpfresearch/doc/640013458629853191">é¾™èœ¥ç¤¾åŒº eunomia-bpf é¡¹ç›®ä¸»é¡µ</a></li>
<li><a href="https://eunomia-bpf.github.io/">eunomia-bpf é¡¹ç›®æ–‡æ¡£</a></li>
<li><a href="https://github.com/linuxkerneltravel/lmp">LMP é¡¹ç›®</a></li>
</ol>
<h2 id="æˆ‘ä»¬çš„å¾®ä¿¡ç¾¤"><a class="header" href="#æˆ‘ä»¬çš„å¾®ä¿¡ç¾¤">æˆ‘ä»¬çš„å¾®ä¿¡ç¾¤</a></h2>
<div style="break-before: page; page-break-before: always;"></div><p>#! https://zhuanlan.zhihu.com/p/600638396</p>
<h1 id="eunomia-bpfå±•æœ›-2023è®©-ebpf-æ’ä¸Š-wasm-çš„ç¿…è†€"><a class="header" href="#eunomia-bpfå±•æœ›-2023è®©-ebpf-æ’ä¸Š-wasm-çš„ç¿…è†€">eunomia-bpfï¼šå±•æœ› 2023ï¼Œè®© eBPF æ’ä¸Š Wasm çš„ç¿…è†€</a></h1>
<p>å›æœ›è¿‡å»çš„ 2022 å¹´ï¼Œæœ‰ä¸¤é¡¹æŠ€æœ¯å¤‡å—ç©ç›®ï¼šeBPF å’Œ WebAssemblyã€‚</p>
<h2 id="ebpf-å…¨æ–°çš„å¯èƒ½æ€§"><a class="header" href="#ebpf-å…¨æ–°çš„å¯èƒ½æ€§">eBPF: å…¨æ–°çš„å¯èƒ½æ€§</a></h2>
<p>eBPF æ˜¯ä¸€é¡¹é©å‘½æ€§çš„æŠ€æœ¯ï¼Œèµ·æºäºLinuxå†…æ ¸ï¼Œå¯ä»¥åœ¨æ“ä½œç³»ç»Ÿçš„å†…æ ¸ä¸­è¿è¡Œæ²™ç›’ç¨‹åºã€‚å®ƒè¢«ç”¨æ¥å®‰å…¨å’Œæœ‰æ•ˆåœ°æ‰©å±•å†…æ ¸çš„åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦æ”¹å˜å†…æ ¸çš„æºä»£ç æˆ–åŠ è½½å†…æ ¸æ¨¡å—ã€‚</p>
<p>è¿‡å»ä¸€å¹´ä¸­ï¼Œå¯è§‚æµ‹æŠ€æœ¯å¾—åˆ°äº†æå¤§å…³æ³¨ï¼Œä¹Ÿè¢« Gartner åˆ—ä¸º 2023 å¹´åå¤§æˆ˜ç•¥æŠ€æœ¯è¶‹åŠ¿ä¹‹ä¸€ã€‚eBPF æœ¬èº«æ˜¯å¯¹ä¼ ç»Ÿè§‚æµ‹èƒ½åŠ›ä¸€ä¸ªéå¸¸å¥½çš„è¡¥å……ï¼Œåœ¨å¯¹å†…æ ¸æ— ä¾µå…¥çš„å‰æä¸‹ï¼Œå®ƒé€šè¿‡åŠ¨æ€åœ°å‘å†…æ ¸ä¸­æ’å…¥ä¸€æ®µè‡ªå·±çš„ä»£ç ï¼Œå®ç°å®šä¹‰ç›‘æ§åŠè·Ÿè¸ªç­‰å¤šç§å¤šæ ·çš„èƒ½åŠ›ã€‚åŒæ—¶ï¼Œ eBPF ä¹Ÿä¿ƒè¿›äº†ç½‘ç»œï¼Œå®‰å…¨æ€§ï¼Œåº”ç”¨ç¨‹åºé…ç½®è·Ÿè¸ªå’Œæ€§èƒ½æ•…éšœæ’é™¤ç­‰ç­‰é¢†åŸŸçš„æ–°ä¸€ä»£å·¥å…·çš„å¼€å‘ï¼Œè¿™äº›å·¥å…·ä¸å†ä¾èµ–ç°æœ‰çš„å†…æ ¸åŠŸèƒ½ï¼Œè€Œæ˜¯åœ¨ä¸å½±å“æ‰§è¡Œæ•ˆç‡æˆ–å®‰å…¨æ€§çš„æƒ…å†µä¸‹ä¸»åŠ¨é‡æ–°è¿è¡Œã€‚</p>
<p>å¦‚ä»Šï¼Œ eBPF è¢«å¹¿æ³›åº”ç”¨åœ¨äº‘åŸç”Ÿã€å¯è§‚æµ‹ã€æ€§èƒ½è°ƒä¼˜ã€å®‰å…¨ã€ç¡¬ä»¶åŠ é€Ÿç­‰é¢†åŸŸï¼Œå¹¶ä¸”å…¶åº”ç”¨åœºæ™¯è¿˜åœ¨å¿«é€Ÿæ‰©å±•ï¼Œå„ç§åœºæ™¯åŸºäº eBPF æŠ€æœ¯çš„åˆ›æ–°é¡¹ç›®å‘ˆç°äº•å–·ç°è±¡ï¼Œå¯¹äºæ“ä½œç³»ç»Ÿç¤¾åŒºè€Œè¨€ï¼ŒeBPF æŠ€æœ¯å¸¦æ¥äº†ä¸€ä¸ªå…¨æ–°çš„å¯èƒ½æ€§ä»¥åŠå¹¿é˜”çš„å¤©åœ°ï¼Œ eBPF çš„æ—¶ä»£å·²ç„¶æ¥ä¸´ã€‚</p>
<p>è¿‡å»çš„ eBPF summit 2022 ä¸­ï¼Œã€ŠThe future of eBPF in the Linux Kernelã€‹å±•æœ›äº† eBPF ç›¸å…³æŠ€æœ¯çš„å‘å±•æ–¹å‘ï¼Œå…·ä½“çš„æ¼”è¿›æ–¹å‘å¯èƒ½åŒ…å«å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>æ›´å®Œå¤‡çš„ç¼–ç¨‹è¯­ä¹‰æ”¯æŒï¼šå½“å‰ eBPF çš„ç¼–ç¨‹èƒ½åŠ›å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼ˆæ¯”å¦‚ä¸æ”¯æŒå˜é‡è¾¹ç•Œçš„å¾ªç¯ï¼ŒæŒ‡ä»¤æ•°é‡å—é™ç­‰ï¼‰ï¼Œæœªæ¥å¸Œæœ›èƒ½è¿›ä¸€æ­¥æä¾›å›¾çµå®Œå¤‡çš„ç¼–ç¨‹èƒ½åŠ›ï¼Œå¢å¼º eBPF çš„å¾ªç¯ã€å†…å­˜åˆ†é…ç­‰å¤šç§è¯­è¨€ç‰¹æ€§ã€‚</li>
<li>æ›´å¼ºçš„å®‰å…¨æ€§ï¼šæ”¯æŒç±»å‹å®‰å…¨ï¼Œå¢å¼ºè¿è¡Œæ—¶ Verifierï¼Œå¸Œæœ› BPF ä¹Ÿèƒ½æä¾›åª²ç¾ Rust çš„å®‰å…¨ç¼–ç¨‹èƒ½åŠ›ï¼Œä»¥åŠå°è¯•æœ‰æ²¡æœ‰å¯èƒ½ç»“åˆ Rust å’Œ BPF çš„ç‰¹æ€§ï¼Œæä¾›æ›´è¿›ä¸€æ­¥çš„ã€åŒæ—¶ä¿è¯å¯ç§»æ¤å’Œå®‰å…¨æ€§çš„å†…æ ¸åŠŸèƒ½ã€‚</li>
<li>æ›´å¹¿æ³›çš„ç§»æ¤èƒ½åŠ›ï¼šå¢å¼º CO-REï¼ŒåŠ å¼º Helper æ¥å£å¯ç§»æ¤èƒ½åŠ›ï¼Œå®ç°è·¨ä½“ç³»ã€å¹³å°çš„ç§»æ¤èƒ½åŠ›ã€‚</li>
<li>æ›´å¼ºçš„å†…æ ¸å¯ç¼–ç¨‹èƒ½åŠ›ï¼šæ”¯æŒè®¿é—®/ä¿®æ”¹å†…æ ¸ä»»æ„å‚æ•°ã€è¿”å›å€¼ï¼Œå®ç°æ›´å¼ºçš„å†…æ ¸ç¼–ç¨‹èƒ½åŠ›ï¼Œç”šè‡³ä½¿ç”¨ BPF æ¥å¸®åŠ©æ„å»ºå’Œå¢å¼ºå†…æ ¸æœ¬èº«çš„å®‰å…¨æ€§ã€‚</li>
</ul>
<h2 id="wasm-å¼•é¢†ä¸‹ä¸€ä»£è®¡ç®—èŒƒå¼"><a class="header" href="#wasm-å¼•é¢†ä¸‹ä¸€ä»£è®¡ç®—èŒƒå¼">Wasm: å¼•é¢†ä¸‹ä¸€ä»£è®¡ç®—èŒƒå¼</a></h2>
<p>ç›¸å¯¹äº eBPF ä¸»è¦å…³æ³¨äºå†…æ ¸æ€æˆ–è€…å’Œå†…æ ¸ç›¸å…³çš„åº”ç”¨ï¼Œç”¨æˆ·æ€çš„ WebAssembly ä¹Ÿæˆä¸ºäº† 2022 å¹´æ–°çš„ç„¦ç‚¹ã€‚</p>
<p>WebAssemblyï¼ˆç®€ç§° Wasmï¼‰æ˜¯ä¸€ä¸ªè‡ªè¯ç”Ÿä¹‹æ—¥èµ·å°±å……æ»¡æ½œåŠ›çš„æŠ€æœ¯ï¼Œä¸€å¼€å§‹ä¸ºäº†ä¸€ä¸ªå¯ç§»æ¤çš„ç›®æ ‡è€Œè®¾è®¡çš„ä¸€ç§ç±»ä¼¼æ±‡ç¼–å­—èŠ‚ç çš„æŒ‡ä»¤æ ¼å¼æ ‡å‡†ï¼Œå¯ç”¨äºç¼–è¯‘C/C+/RUSTç­‰é«˜çº§è¯­è¨€ï¼Œä½¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨æµè§ˆå™¨ä¸Šéƒ¨ç½²ï¼›æ—¶è‡³ä»Šæ—¥ï¼ŒWebAssembly æ­£åœ¨æ²¿ç€å…¶åå­—ä¸­ Web å’Œ Assembly ä¸¤ä¸ªé¢†åŸŸä¹‹å¤–çš„æ–¹å‘å‘å±•ï¼Œä½¿ç”¨ä¸ Wasm å…¼å®¹çš„è¿è¡Œæ—¶ï¼ŒWasm æ–‡ä»¶å¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯æ‰§è¡Œï¼Œä» &quot;JavaScript æ€æ‰‹&quot; åˆ° &quot;äº‘è®¡ç®—çš„ä¸‹ä¸€ä¸ªå‰æ²¿æ–¹å‘&quot; å‡ ä¹è¦†ç›–äº†å…¨éƒ¨æ–°å…´é¢†åŸŸï¼ŒåŒæ—¶åœ¨ä»äº‘è®¡ç®—ã€serverless å‘è¾¹ç¼˜è®¡ç®—æ¸—é€ï¼ŒWasm å·²ç»è¿œè¿œè¶…å‡ºäº†èµ·ä½œä¸ºç¬¬å››ç§ Web æ ‡å‡†è¯­è¨€çš„è§’è‰²ã€‚ç”šè‡³é‡æ–°å®šä¹‰äº†åº”ç”¨è½¯ä»¶çš„å¼€å‘æ¨¡å¼ï¼Œæ­£é€æ¸æ¥è¿‘å…¶ â€œä¸€æ¬¡ç¼–å†™ï¼Œéšå¤„è¿è¡Œâ€ çš„æ„¿æ™¯ã€‚</p>
<p>Wasm æœ‰å‡ ä¸ªå…³é”®çš„è®¾è®¡ç›®æ ‡ä½¿å…¶å‡ºç”Ÿå¼€å§‹å°±è‡ªå¸¦ä»¤äººäº®çœ¼çš„å…³æ³¨ï¼š</p>
<ul>
<li>å¯ç§»æ¤ï¼šWasm è¢«è®¾è®¡ä¸ºé’ˆå¯¹ä½çº§è™šæ‹Ÿæœºæ¶æ„ï¼Œå…¶æŒ‡ä»¤ç”±ç‰©ç†æœºå•ç‹¬ç¿»è¯‘æˆæœºå™¨ä»£ç ã€‚è¿™æ„å‘³ç€ Wasm äºŒè¿›åˆ¶æ–‡ä»¶æœ€ç»ˆå¯ä»¥åœ¨å„ç§æ“ä½œç³»ç»Ÿå’ŒèŠ¯ç‰‡æ¶æ„ä¸Šè¿è¡Œ â€”â€” æ— è®ºæ˜¯åœ¨è¿è¡Œ X86 ç¬”è®°æœ¬ç”µè„‘çš„æµè§ˆå™¨ä¸­ï¼Œè¿˜æ˜¯åœ¨å†…éƒ¨æˆ–äº‘ç«¯çš„æœåŠ¡å™¨ä¸Šï¼Œåœ¨ç§»åŠ¨è®¾å¤‡ã€ç‰©è”ç½‘è®¾å¤‡ä¸Šç­‰ç­‰ã€‚</li>
<li>å¤šè¯­è¨€ï¼šå› ä¸º Wasm æ˜¯ä¸€ä¸ªç¼–è¯‘ç›®æ ‡ï¼Œç”¨äºç¼–ç¨‹æ¨¡å—çš„å…·ä½“è¯­è¨€å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯æ˜¯å¦æœ‰æ”¯æŒå°†è¯¥è¯­è¨€ç¼–è¯‘åˆ° Wasmã€‚å¼€å‘äººå‘˜å¯ä»¥çµæ´»åœ°ä½¿ç”¨å¤šç§è¯­è¨€ï¼ˆå¦‚ Cã€C++ã€Rustã€å‡¹è¯­è¨€ç­‰ï¼‰æ¥æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶äº«å— Wasm å¸¦æ¥çš„çº¢åˆ©ã€‚</li>
<li>è½»é‡å’Œé«˜æ•ˆï¼šä½œä¸ºä¸€ä¸ªä½çº§åˆ«çš„äºŒè¿›åˆ¶æŒ‡ä»¤æ ¼å¼ï¼Œåªéœ€è¦è¾ƒå°‘çš„æ“ä½œæ¥å°† Wasm ç¿»è¯‘æˆä¼˜åŒ–çš„æœºå™¨ä»£ç ã€‚</li>
<li>å®‰å…¨ï¼šWasm ç›®æ ‡ä¹‹ä¸€æ˜¯å®‰å…¨ï¼Œå®ƒåœ¨ä¸€ä¸ªæ²™ç›’ç¯å¢ƒä¸­æ‰§è¡Œï¼Œå¯¹ä¸»æœºè¿è¡Œæ—¶æ²¡æœ‰åˆå§‹å¯è§æ€§ã€‚è¿™æ„å‘³ç€å¯¹ç³»ç»Ÿèµ„æºï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿï¼Œç¡¬ä»¶ç­‰ï¼‰çš„è®¿é—®æ˜¯å—é™åˆ¶çš„ï¼Œé™¤éæ˜ç¡®å¯¼å…¥äº†å¯¹åº”çš„å‡½æ•°ä»¥æ”¯æŒã€‚å› æ­¤ Wasm æå¤§é™åˆ¶äº†æ”»å‡»é¢ï¼Œå®ç°äº†å¤šç§Ÿæˆ·ç¯å¢ƒä¸­ä¸å—ä¿¡ä»»çš„ä»£ç å®‰å…¨å—é™åœ°æ‰§è¡Œã€‚</li>
</ul>
<p>è¿‡å»çš„ 2022 å¹´ Wasm å–å¾—äº†ä¸å°‘æ¿€åŠ¨äººå¿ƒçš„æˆå°±ï¼Œè®¸å¤šæ–°çš„ Wasm åˆåˆ›å…¬å¸æ¶Œç°ï¼Œè€ç‰Œäº‘æœåŠ¡å•†å’Œå…¬å¸å®£å¸ƒæ”¯æŒ Wasmï¼Œå­—èŠ‚ç è”ç›Ÿæ¨å‡ºäº†è®¸å¤šæ–°çš„ Wasm æ ‡å‡†ï¼ŒCNCFä¸»åŠäº†ä¸¤æ¬¡ WasmDay æ´»åŠ¨ï¼Œè€Œ Wasm æœ€å¤§çš„ç”¨æˆ·ä¹‹ä¸€ Figma è¢« Adobe ä»¥æƒŠäººçš„ 200 äº¿ç¾å…ƒæ”¶è´­ã€‚å¯¹äº WebAssembly è€Œè¨€ï¼Œ2023 å¹´å¾ˆæœ‰å¯èƒ½ä¹Ÿä¼šæ˜¯çˆ†å‘çš„ä¸€å¹´ï¼š</p>
<ul>
<li>ç»„ä»¶æ¨¡å‹æè¿°äº†WasmäºŒè¿›åˆ¶æ–‡ä»¶ç›¸äº’äº¤äº’çš„æ–¹å¼ï¼Œæ­£åœ¨è¿…é€Ÿæˆç†Ÿï¼Œå·²ç»å‡ºç°äº†å‚è€ƒå®ç°ã€‚å¼€å‘äººå‘˜å¯ä»¥å£°æ˜ä»–ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦å“ªäº›ç»„ä»¶ï¼Œæˆ–è€…æ›´æŠ½è±¡åœ°è¯´ï¼Œä»–ä»¬çš„åº”ç”¨éœ€è¦å“ªäº›åŠŸèƒ½ï¼ˆè€Œä¸æ˜¯ç”¨ä»–ä»¬é¦–é€‰çš„æºè¯­è¨€æŸ¥æ‰¾åº“ï¼‰ï¼Œç„¶åWasmè¿è¡Œæ—¶å¯ä»¥ä»£è¡¨ç”¨æˆ·ç»„è£…æ­£ç¡®çš„ç»„ä»¶é›†ã€‚2023 å¹´å°†æ˜¯ç»„ä»¶æ¨¡å‹å¼€å§‹é‡æ–°å®šä¹‰æˆ‘ä»¬å¦‚ä½•ç¼–å†™è½¯ä»¶çš„ä¸€å¹´ã€‚</li>
<li>Wasmæ”¹å˜äº†æ— æœåŠ¡å™¨ç¯å¢ƒçš„æ½œåŠ›ã€‚ç”±äºå‡ ä¹å³æ—¶çš„å¯åŠ¨æ—¶é—´ã€è¾ƒå°çš„äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°ä»¥åŠå¹³å°å’Œæ¶æ„ä¸­ç«‹æ€§ï¼ŒWasmäºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥ç”¨è¿è¡Œå½“ä»Šæ— æœåŠ¡å™¨åŸºç¡€è®¾æ–½æ‰€éœ€çš„ä¸€å°éƒ¨åˆ†èµ„æºæ¥æ‰§è¡Œã€‚</li>
<li>2022å¹´åº•ï¼ŒOCI Registryå·¥ä½œç»„å®£å¸ƒäº†ä¸€ç§å­˜å‚¨å®¹å™¨é•œåƒä»¥å¤–çš„å…¶ä»–å†…å®¹çš„å®˜æ–¹æ–¹å¼ã€‚è¿™å¯èƒ½åŒ…æ‹¬Helmå›¾è¡¨ã€ç…§ç‰‡æˆ–Wasmåº”ç”¨ç¨‹åºã€‚è¿™ä¸ªæ–°åŠŸèƒ½è¢«ç§°ä¸ºâ€œå·¥ä»¶å­˜å‚¨â€ã€‚</li>
<li>æ‰€æœ‰å¤§å‹ç¼–ç¨‹è¯­è¨€éƒ½å°†å¾—åˆ°Wasmæ”¯æŒï¼šWasm GCææ¡ˆå¾ˆå¯èƒ½åœ¨ 2023 å¹´åˆå°±èƒ½å¯ç”¨å¹¶å¾—åˆ°æ”¯æŒï¼Œå› æ­¤ Kotlin å’Œ Dart å°†å¾ˆå¿«å‘å¸ƒWasmç¼–è¯‘å™¨ï¼ŒJava ä¹Ÿå¾ˆå¯èƒ½å°†æˆä¸ºæœ€æµè¡Œçš„ Wasm å¼€å‘è¯­è¨€ã€‚</li>
</ul>
<h2 id="coolbpf--eunomia-bpf--eunomia-lcc"><a class="header" href="#coolbpf--eunomia-bpf--eunomia-lcc">Coolbpf + eunomia-bpf = eunomia-lcc</a></h2>
<p>åœ¨è¿‡å»çš„ä¸€å¹´ä¸­ï¼Œé˜¿é‡Œäº‘é¾™èœ¥ç¤¾åŒºç³»ç»Ÿè¿ç»´SIGï¼ˆSpecial Interest Groupï¼‰ æ­£å¼å¼€æºäº† Coolbpf é¡¹ç›®ã€‚Coolbpf ä»¥ CO-REï¼ˆCompile Once-Run Everywhereï¼‰ä¸ºåŸºç¡€å®ç°ï¼Œä¿ç•™äº†èµ„æºå ç”¨ä½ã€å¯ç§»æ¤æ€§å¼ºç­‰ä¼˜ç‚¹ï¼Œèåˆäº†BCCåŠ¨æ€ç¼–è¯‘ç‰¹æ€§ï¼Œé€šè¿‡è¿œç¨‹æœåŠ¡èƒ½åŠ›ï¼Œæå¤§ç®€åŒ–å¼€å‘ç¼–è¯‘å’Œè¿è¡Œæ•ˆç‡ï¼Œé€‚åˆåœ¨ç”Ÿäº§ç¯å¢ƒæ‰¹é‡éƒ¨ç½²åº”ç”¨ã€‚Coolbpf è¿˜æ”¯æŒåœ¨æ²¡æœ‰ eBPF ç‰¹æ€§çš„ä½å†…æ ¸ç‰ˆæœ¬ä¸Šï¼Œé€šè¿‡æä¾›çš„ eBPF é©±åŠ¨ï¼Œå¸®åŠ©å®ƒå®‰å…¨çš„åœ¨ä½ç‰ˆæœ¬ä¸Šè¿è¡Œï¼Œä»å†…æ ¸æ€å’Œæ‰¹é‡éƒ¨ç½²ä¸¤ä¸ªè§’åº¦å……åˆ†å¢å¼ºäº† eBPF ç¨‹åº&quot;ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€ çš„èƒ½åŠ›ã€‚</p>
<p>eunomia-bpf ä¹Ÿæ˜¯ä¸€ä¸ªç»“åˆ Wasm çš„é€šç”¨ã€è½»é‡çº§ã€å¤šè¯­è¨€çš„ä¸‹ä¸€ä»£ eBPF å¼€å‘æ¡†æ¶/ç»„ä»¶åº“ï¼Œ2022 å¹´ä¸‹åŠå¹´åœ¨é¾™èœ¥ç¤¾åŒº <code>eBPF æŠ€æœ¯æ¢ç´¢ SIG</code> [3] [5] å‘èµ·å¹¶å­µåŒ–ã€‚eunomia-bpf åŒ…å«ä¸€ä¸ªè¿è¡Œæ—¶å’Œç¼–è¯‘å·¥å…·é“¾ï¼Œä¸»è¦å…³æ³¨äºæ”¹è¿› eBPF ç¨‹åºç”¨æˆ·æ€çš„å¼€å‘å’Œä½¿ç”¨ä½“éªŒï¼Œä¸»è¦æœ‰ä¸‰ä¸ªç‰¹æ€§ï¼š</p>
<ol>
<li>åªéœ€ç¼–å†™å†…æ ¸æ€ä»£ç å³å¯è¿è¡Œ eBPF ç¨‹åºï¼Œå†…æ ¸æ€å‰ç«¯å®Œå…¨å…¼å®¹ bccã€åŸç”Ÿ libbpf ç­‰å¤šç§è¯­æ³•ï¼Œå¯ä»¥é™ä½ eBPF å¼€å‘çš„å­¦ä¹ æˆæœ¬ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼›</li>
<li>ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶å®Œå…¨åˆ†ç¦»ï¼Œä¿è¯ä¸åŒç‰ˆæœ¬ç¼–è¯‘å·¥å…·é“¾å’Œè¿è¡Œæ—¶ä¹‹é—´çš„å…¼å®¹æ€§ï¼Œä»¥ CO-REï¼ˆä¸€æ¬¡ç¼–è¯‘ã€åˆ°å¤„è¿è¡Œï¼‰çš„æ–¹å¼åŠ è½½ï¼Œé™ä½éƒ¨ç½²å’Œä½¿ç”¨çš„èµ„æºæ¶ˆè€—ï¼›è¿˜å¯ä»¥è®© BCC/bpftrace ç±»å‹çš„ä»£ç ä¹Ÿæ”¯æŒ AOT ç¼–è¯‘ï¼Œåœ¨åŠ è½½çš„çš„æ—¶å€™ä¸ä¾èµ– llvm ç­‰åº“ï¼ŒåŒæ—¶ä¿ç•™ bpftrace ç±»ä¼¼è„šæœ¬ä¸€æ ·çš„ç®€å•ä½¿ç”¨æ–¹å¼ï¼›</li>
<li>ç”¨æˆ·æ€ä¹Ÿæ”¯æŒå¤šç§è¯­è¨€ï¼Œä¾‹å¦‚ C++/C/Rust ç­‰ï¼Œå¯ä»¥ä½¿ç”¨å¤šç§è¯­è¨€åœ¨ Wasm ä¸­å¼€å‘ eBPF çš„ç”¨æˆ·æ€ç¨‹åºï¼Œå¹¶ä¸”ä»¥ Wasm æ¨¡å—ï¼Œæˆ–è€… JSON/YAML é…ç½®æ–‡ä»¶çš„æ–¹å¼åˆ†å‘å’ŒåŠ¨æ€åŠ è½½ eBPF ç¨‹åºï¼ŒåŒæ—¶ä»¥ Wasm OCI é•œåƒçš„å½¢å¼å­˜å‚¨å’Œç®¡ç†ä»»æ„åŒ…å«ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ eBPF åº”ç”¨ã€‚</li>
</ol>
<p>eunomia-bpf å¸Œæœ›æˆä¸ºä¸€ä¸ªä»¥ç±»åº“æˆ–è€…æ¾æ•£ç»„åˆçš„æ¡†æ¶çš„æ–¹å¼æä¾›ï¼Œåœ¨ç¼–è¯‘æ„å»ºå’Œåˆ†å‘è¿è¡Œ eBPF ç¨‹åºæ–¹é¢åšæ›´å¤šçš„æ¢ç´¢å·¥ä½œï¼Œè®©å…¶ä»–å…¬å¸å’Œä¸ªäººï¼Œæƒ³è¦åŸºäºè‡ªå·±çš„å†…æ ¸æ€ ebpf åŸºç¡€è®¾æ–½ï¼Œæ­å»ºä¸€ä¸ªç±»ä¼¼çš„ç”¨æˆ·æ€å¼€å‘è¿è¡Œç¯å¢ƒï¼Œæˆ–è€…å®Œæ•´çš„å¼€å‘å¹³å°ã€æ’ä»¶è¿è¡Œæ—¶ï¼Œå˜å¾—æ›´å®¹æ˜“å¾ˆå¤šã€‚</p>
<p>åœ¨ 2022 å¹´åº•ï¼Œæˆ‘ä»¬å°è¯•å°† Coolbpf å’Œ eunomia-bpf ç»“åˆèµ·æ¥ï¼Œå€ŸåŠ© Coolbpf æä¾›çš„ä½å†…æ ¸ç‰ˆæœ¬æ”¯æŒçš„å†…æ ¸æ€åŸºç¡€è®¾æ–½ï¼Œä»¥åŠæ‰¹é‡éƒ¨ç½²åº”ç”¨çš„èƒ½åŠ›ï¼Œä»¥åŠ eunomia-bpf æä¾›çš„ç»“åˆ Wasm çš„ç”¨æˆ·æ€å¼€å‘ã€åˆ†å‘ç‰¹æ€§ï¼Œåœ¨ Coolbpf çš„å¤§æ¡†æ¶ä¸‹åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ eBPF ç”¨æˆ·æ€å¼€å‘åº“ï¼š<a href="https://gitee.com/anolis/coolbpf/pulls/17">eunomia-lcc</a>ï¼Œå¸Œæœ›è®© Coolbpf ä¹Ÿèƒ½ï¼š</p>
<ul>
<li>åœ¨ç¼–å†™ eBPF ç¨‹åºæˆ–å·¥å…·æ—¶åªç¼–å†™å†…æ ¸æ€ä»£ç ï¼Œå°±èƒ½è‡ªåŠ¨è·å–å†…æ ¸æ€å¯¼å‡ºä¿¡æ¯ï¼Œè‡ªåŠ¨ç”Ÿæˆå‘½ä»¤è¡Œå‚æ•°ã€ç›´æ–¹å›¾è¾“å‡ºç­‰ï¼›</li>
<li>ä½¿ç”¨ Wasm è¿›è¡Œç”¨æˆ·æ€äº¤äº’ç¨‹åºçš„å¼€å‘ï¼Œåœ¨ Wasm è™šæ‹Ÿæœºå†…éƒ¨æ§åˆ¶æ•´ä¸ª eBPF ç¨‹åºçš„åŠ è½½å’Œæ‰§è¡Œï¼Œä»¥åŠå¤„ç† eBPF ä¸ŠæŠ¥çš„æ•°æ®ï¼›</li>
<li>å¯ä»¥å°†é¢„ç¼–è¯‘çš„ eBPF ç¨‹åºæ‰“åŒ…ä¸ºé€šç”¨çš„ JSON æˆ– Wasm æ¨¡å—ï¼Œè·¨æ¶æ„å’Œå†…æ ¸ç‰ˆæœ¬è¿›è¡Œåˆ†å‘ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘å³å¯åŠ¨æ€åŠ è½½è¿è¡Œã€‚</li>
</ul>
<p>åŒæ—¶è¿˜èƒ½ä¿ç•™ Coolbpf çš„ä½ç‰ˆæœ¬å…¼å®¹ã€BTF è‡ªåŠ¨è·å–ã€è¿œç¨‹ç¼–è¯‘ç­‰ç‰¹æ€§ï¼Œè®© eBPF ç¨‹åºçš„å¼€å‘æ›´åŠ ç®€ä¾¿æ˜“è¡Œã€‚</p>
<p>å±•æœ›æœªæ¥ï¼Œeunomia-bpf çš„å›¢é˜Ÿåœ¨ 2023 å¹´ä¹Ÿå¸Œæœ›å°è¯•æ¢ç´¢ã€æ”¹è¿›ã€å®Œå–„ eBPF ç¨‹åºå¼€å‘ã€ç¼–è¯‘ã€æ‰“åŒ…ã€å‘å¸ƒã€å®‰è£…ã€å‡çº§ç­‰çš„æµç¨‹å’Œå·¥å…·ã€SDKï¼Œå¹¶ç§¯æå‘ä¸Šæ¸¸ç¤¾åŒºåé¦ˆï¼Œè¿›ä¸€æ­¥å¢å¼º eBPF çš„ç¼–ç¨‹ä½“éªŒå’Œè¯­è¨€èƒ½åŠ›ï¼›ä»¥åŠæ›´è¿›ä¸€æ­¥åœ°å’Œ WebAssembly ç›¸ç»“åˆï¼Œåœ¨å¯è§‚æµ‹æ€§ã€serverlessã€å¯ç¼–ç¨‹å†…æ ¸ç­‰è¯¸å¤šæ–¹é¢åšæ›´å¤šçš„æ¢ç´¢å’Œå®è·µï¼Œæœç€å›¾çµå®Œå¤‡å’Œæ›´å®Œå–„çš„è¯­è¨€æ”¯æŒè¿ˆè¿›ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™-5"><a class="header" href="#å‚è€ƒèµ„æ–™-5">å‚è€ƒèµ„æ–™</a></h2>
<ol>
<li>Wasm å°†å¼•é¢†ä¸‹ä¸€ä»£è®¡ç®—èŒƒå¼ [è¯‘]ï¼š<a href="https://www.oschina.net/news/214580">https://www.oschina.net/news/214580</a></li>
<li>WebAssemblyï¼š2023å¹´çš„5ä¸ªé¢„æµ‹: <a href="https://www.sohu.com/a/626985661_121119003">https://www.sohu.com/a/626985661_121119003</a></li>
<li>eBPF æŠ€æœ¯æ¢ç´¢ SIG ä¸»é¡µï¼š <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>Coolbpf é¡¹ç›®å¼€æºä»“åº“: <a href="https://gitee.com/anolis/coolbpf">https://gitee.com/anolis/coolbpf</a></li>
<li>eunomia-bpf é¾™èœ¥ç¤¾åŒºé•œåƒä»“åº“ï¼š<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
<li>eunomia-bpf Github ä»“åº“ï¼š<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>å½“ Wasm é‡è§ eBPFï¼šä½¿ç”¨ WebAssembly ç¼–å†™ã€åˆ†å‘ã€åŠ è½½è¿è¡Œ eBPF ç¨‹åº | é¾™èœ¥æŠ€æœ¯: <a href="https://developer.aliyun.com/article/1050439">https://developer.aliyun.com/article/1050439</a></li>
<li>2023ï¼Œå¯è§‚æµ‹æ€§éœ€æ±‚å°†è¿æ¥â€œçˆ†å‘ä¹‹å¹´â€ï¼Ÿ<a href="https://36kr.com/p/dp2063589382737542">https://36kr.com/p/dp2063589382737542</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ebpf-è¿›é˜¶-å†…æ ¸æ–°ç‰¹æ€§è¿›å±•ä¸€è§ˆ"><a class="header" href="#ebpf-è¿›é˜¶-å†…æ ¸æ–°ç‰¹æ€§è¿›å±•ä¸€è§ˆ">eBPF è¿›é˜¶: å†…æ ¸æ–°ç‰¹æ€§è¿›å±•ä¸€è§ˆ</a></h1>
<p>Linux å†…æ ¸åœ¨ 2022 å¹´ä¸»è¦å‘å¸ƒäº† 5.16-5.19 ä»¥åŠ 6.0 å’Œ 6.1 è¿™å‡ ä¸ªç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½ä¸º eBPF å¼•å…¥äº†å¤§é‡çš„æ–°ç‰¹æ€§ã€‚æœ¬æ–‡å°†å¯¹è¿™äº›æ–°ç‰¹æ€§è¿›è¡Œä¸€ç‚¹ç®€è¦çš„ä»‹ç»ï¼Œæ›´è¯¦ç»†çš„èµ„æ–™è¯·å‚è€ƒå¯¹åº”çš„é“¾æ¥ä¿¡æ¯ã€‚æ€»ä½“è€Œè¨€ï¼ŒeBPF åœ¨å†…æ ¸ä¸­ä¾ç„¶æ˜¯æœ€æ´»è·ƒçš„æ¨¡å—ä¹‹ä¸€ï¼Œå®ƒçš„åŠŸèƒ½ç‰¹æ€§ä¹Ÿè¿˜åœ¨é«˜é€Ÿå‘å±•ä¸­ã€‚æŸç§æ„ä¹‰ä¸Šè¯´ï¼ŒeBPF æ­£æœç€ä¸€ä¸ªå®Œå¤‡çš„å†…æ ¸æ€å¯ç¼–ç¨‹æ¥å£å¿«é€Ÿè¿›åŒ–ã€‚</p>
<!-- TOC -->
<ul>
<li><a href="blog/bpf-news.html#ebpf-%E8%BF%9B%E9%98%B6-%E5%86%85%E6%A0%B8%E6%96%B0%E7%89%B9%E6%80%A7%E8%BF%9B%E5%B1%95%E4%B8%80%E8%A7%88">eBPF è¿›é˜¶: å†…æ ¸æ–°ç‰¹æ€§è¿›å±•ä¸€è§ˆ</a>
<ul>
<li><a href="blog/bpf-news.html#bpf-kfuncs">BPF kfuncs</a></li>
<li><a href="blog/bpf-news.html#bloom-filter-map516">Bloom Filter Mapï¼š5.16</a></li>
<li><a href="blog/bpf-news.html#compile-once--run-everywherelinux-517">Compile Once â€“ Run Everywhereï¼šLinux 5.17</a></li>
<li><a href="blog/bpf-news.html#bpf_loop-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0517">bpf_loop() è¾…åŠ©å‡½æ•°ï¼š5.17</a></li>
<li><a href="blog/bpf-news.html#bpf_link_type_kprobe_multi518">BPF_LINK_TYPE_KPROBE_MULTIï¼š5.18</a></li>
<li><a href="blog/bpf-news.html#%E5%8A%A8%E6%80%81%E6%8C%87%E9%92%88%E5%92%8C%E7%B1%BB%E5%9E%8B%E6%8C%87%E9%92%88519">åŠ¨æ€æŒ‡é’ˆå’Œç±»å‹æŒ‡é’ˆï¼š5.19</a></li>
<li><a href="blog/bpf-news.html#usdt519">USDTï¼š5.19</a></li>
<li><a href="blog/bpf-news.html#bpf-panic61">bpf panicï¼š6.1</a></li>
<li><a href="blog/bpf-news.html#bpf-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8%E9%93%BE%E8%A1%A861">BPF å†…å­˜åˆ†é…å™¨ã€é“¾è¡¨ï¼š6.1</a></li>
<li><a href="blog/bpf-news.html#user-ring-buffer-61">user ring buffer 6.1</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="bpf-kfuncs"><a class="header" href="#bpf-kfuncs">BPF kfuncs</a></h2>
<p>BPFå­ç³»ç»Ÿæš´éœ²äº†å†…æ ¸å†…éƒ¨ç®—æ³•å’Œæ•°æ®ç»“æ„çš„è®¸å¤šæ–¹é¢ï¼›è¿™è‡ªç„¶å¯¼è‡´äº†å¯¹åœ¨å†…æ ¸å˜åŒ–æ—¶ä¿æŒæ¥å£ç¨³å®šæ€§çš„å…³æ³¨ã€‚é•¿æœŸä»¥æ¥ï¼ŒBPFå¯¹ç”¨æˆ·ç©ºé—´ä¸æä¾›æ¥å£ç¨³å®šæ€§ä¿è¯çš„ç«‹åœºä¼¼ä¹ä¸€ç›´æœ‰ç‚¹é—®é¢˜ï¼›è¿‡å»ï¼Œå†…æ ¸å¼€å‘è€…å‘ç°ä»–ä»¬ä¸å¾—ä¸ç»´æŠ¤é‚£äº›ä¸æ‰“ç®—ç¨³å®šçš„æ¥å£ã€‚ç°åœ¨BPFç¤¾åŒºå¼€å§‹è€ƒè™‘è‡³å°‘ä¸ºå®ƒçš„ä¸€äº›æ¥å£æä¾›æ˜ç¡®çš„ç¨³å®šæ€§æ‰¿è¯ºå¯èƒ½æ„å‘³ç€ä»€ä¹ˆã€‚</p>
<p>BPFå…è®¸ç”±ç”¨æˆ·ç©ºé—´åŠ è½½çš„ç¨‹åºè¢«é™„åŠ åˆ°å¤§é‡é’©å­ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œå¹¶åœ¨å†…æ ¸ä¸­è¿è¡Œ--åœ¨å­ç³»ç»Ÿçš„éªŒè¯å™¨å¾—å‡ºè¿™äº›ç¨‹åºä¸ä¼šæŸå®³ç³»ç»Ÿçš„ç»“è®ºä¹‹åã€‚ä¸€ä¸ªç¨‹åºå°†è·å¾—ç”±å®ƒæ‰€è¿æ¥çš„é’©å­æä¾›ç»™å®ƒçš„å†…æ ¸æ•°æ®ç»“æ„çš„è®¿é—®æƒã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºå¯ä»¥ç›´æ¥ä¿®æ”¹è¿™äº›æ•°æ®ï¼Œä»è€Œç›´æ¥å½±å“å†…æ ¸çš„è¿è¡Œï¼›åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œå†…æ ¸å°†å¯¹BPFç¨‹åºè¿”å›çš„å€¼é‡‡å–è¡ŒåŠ¨ï¼Œä¾‹å¦‚ï¼Œå…è®¸æˆ–ä¸å…è®¸æŸé¡¹æ“ä½œã€‚</p>
<p>è¿˜æœ‰ä¸¤ç§æœºåˆ¶ï¼Œå†…æ ¸å¯ä»¥é€šè¿‡å®ƒä»¬ä½¿BPFç¨‹åºè·å¾—é¢å¤–çš„åŠŸèƒ½ã€‚å¸®åŠ©å‡½æ•°ï¼ˆæˆ– &quot;helpers&quot;ï¼‰æ˜¯ä¸ºæä¾›ç»™BPFç¨‹åºè€Œç¼–å†™çš„ç‰¹æ®Šå‡½æ•°ï¼›å®ƒä»¬ä»æ‰©å±•BPFæ—¶ä»£å¼€å§‹å°±å­˜åœ¨äº†ã€‚è¢«ç§°ä¸ºkfuncsçš„æœºåˆ¶æ¯”è¾ƒæ–°ï¼›å®ƒå…è®¸ä»»ä½•å†…æ ¸å‡½æ•°è¢«æä¾›ç»™BPFï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›é™åˆ¶ã€‚Kfuncsæ›´ç®€å•ã€æ›´çµæ´»ï¼›å¦‚æœå®ƒä»¬é¦–å…ˆè¢«å®ç°ï¼Œé‚£ä¹ˆä¼¼ä¹ä¸å¤ªå¯èƒ½æœ‰äººä¼šåœ¨åæ¥æ·»åŠ å¸®åŠ©å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œkfuncsæœ‰ä¸€ä¸ªé‡è¦çš„é™åˆ¶ï¼Œå³å®ƒä»¬åªèƒ½è¢«JITç¼–è¯‘çš„BPFä»£ç è®¿é—®ï¼Œæ‰€ä»¥å®ƒä»¬åœ¨ç¼ºä¹JITæ”¯æŒçš„æ¶æ„ä¸Šæ˜¯ä¸å¯ç”¨çš„ï¼ˆè¿™ä¸ªåˆ—è¡¨ç›®å‰åŒ…æ‹¬32ä½Armå’ŒRISC-Vï¼Œå°½ç®¡å¢åŠ è¿™ä¸¤ç§æ”¯æŒçš„è¡¥ä¸æ­£åœ¨å¼€å‘ä¸­ï¼‰. æ¯ä¸ªkfuncéƒ½ä¸ºBPFç¨‹åºæä¾›äº†ä¸€äº›æœ‰ç”¨çš„åŠŸèƒ½ï¼Œä½†å‡ ä¹æ¯ä¸ªkfuncéƒ½æš´éœ²äº†å†…æ ¸å†…éƒ¨å·¥ä½œæ–¹å¼çš„æŸäº›æ–¹é¢ã€‚</p>
<ul>
<li>Reconsidering BPF ABI stability: <a href="https://mp.weixin.qq.com/s/wYDSXuwVgmGw-wmFgBNJcA">https://mp.weixin.qq.com/s/wYDSXuwVgmGw-wmFgBNJcA</a></li>
<li>Documentation/bpf: Add a description of &quot;stable kfuncs&quot; <a href="https://www.spinics.net/lists/kernel/msg4676660.html">https://www.spinics.net/lists/kernel/msg4676660.html</a></li>
</ul>
<h2 id="bloom-filter-map516"><a class="header" href="#bloom-filter-map516">Bloom Filter Mapï¼š5.16</a></h2>
<p>å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§èŠ‚çœç©ºé—´çš„æ¦‚ç‡æ•°æ®ç»“æ„ï¼Œç”¨äºå¿«é€Ÿæµ‹è¯•ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºä¸€ä¸ªé›†åˆä¸­ã€‚åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå‡é˜³æ€§æ˜¯å¯èƒ½çš„ï¼Œè€Œå‡é˜´æ€§åˆ™ä¸å¯èƒ½ã€‚</p>
<p>è¿™ä¸ªè¡¥ä¸é›†åŒ…æ‹¬å¸ƒéš†è¿‡æ»¤å™¨ä¸­å¯é…ç½®æ•°é‡çš„å“ˆå¸Œå€¼å’Œæ¡ç›®çš„åŸºå‡†æµ‹è¯•ã€‚è¿™äº›åŸºå‡†å¤§è‡´è¡¨æ˜ï¼Œå¹³å‡è€Œè¨€ï¼Œä½¿ç”¨3ä¸ªå“ˆå¸Œå‡½æ•°æ˜¯æœ€ç†æƒ³çš„é€‰æ‹©ä¹‹ä¸€ã€‚å½“æ¯”è¾ƒhashmapæŸ¥æ‰¾ä¸­ä½¿ç”¨3ä¸ªå“ˆå¸Œå€¼çš„bloom filterå’Œä¸ä½¿ç”¨bloom filterçš„hashmapæŸ¥æ‰¾æ—¶ï¼Œä½¿ç”¨bloom filterçš„æŸ¥æ‰¾å¯¹äº5ä¸‡ä¸ªæ¡ç›®å¤§çº¦å¿«15%ï¼Œå¯¹äº10ä¸‡ä¸ªæ¡ç›®å¿«25%ï¼Œå¯¹äº5ä¸‡ä¸ªæ¡ç›®å¿«180%ï¼Œå¯¹äº1ç™¾ä¸‡ä¸ªæ¡ç›®å¿«200%ã€‚</p>
<ul>
<li>BPF: Implement bloom filter map <a href="https://lwn.net/Articles/868024/">https://lwn.net/Articles/868024/</a></li>
</ul>
<h2 id="compile-once--run-everywherelinux-517"><a class="header" href="#compile-once--run-everywherelinux-517">Compile Once â€“ Run Everywhereï¼šLinux 5.17</a></h2>
<p>Linux 5.17 ä¸º eBPF æ·»åŠ äº†ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œï¼ˆCompile Once â€“ Run Everywhereï¼Œç®€ç§° CO-REï¼‰ï¼Œå¤§å¤§ç®€åŒ–äº† eBPF ç¨‹åºå¤„ç†å¤šç‰ˆæœ¬å†…æ ¸å…¼å®¹æ—¶çš„å¤æ‚æ€§ä»¥åŠå¾ªç¯é€»è¾‘çš„å¤„ç†ã€‚</p>
<p>eBPF çš„ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œï¼ˆç®€ç§° CO-REï¼‰é¡¹ç›®å€ŸåŠ©äº† BPF ç±»å‹æ ¼å¼ï¼ˆBPF Type Format, ç®€ç§° BTFï¼‰æä¾›çš„è°ƒè¯•ä¿¡æ¯ï¼Œå†é€šè¿‡ä¸‹é¢çš„å››ä¸ªæ­¥éª¤ï¼Œä½¿å¾— eBPF ç¨‹åºå¯ä»¥é€‚é…ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ï¼š</p>
<ul>
<li>ç¬¬ä¸€ï¼Œåœ¨ bpftool å·¥å…·ä¸­æä¾›äº†ä» BTF ç”Ÿæˆå¤´æ–‡ä»¶çš„å·¥å…·ï¼Œä»è€Œæ‘†è„±äº†å¯¹å†…æ ¸å¤´æ–‡ä»¶çš„ä¾èµ–ã€‚</li>
<li>ç¬¬äºŒï¼Œé€šè¿‡å¯¹ BPF ä»£ç ä¸­çš„è®¿é—®åç§»é‡è¿›è¡Œé‡å†™ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„åç§»é‡ä¸åŒçš„é—®é¢˜ã€‚</li>
<li>ç¬¬ä¸‰ï¼Œåœ¨ libbpf ä¸­é¢„å®šä¹‰ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„çš„ä¿®æ”¹ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ä¸­æ•°æ®ç»“æ„ä¸å…¼å®¹çš„é—®é¢˜ã€‚</li>
<li>ç¬¬å››ï¼Œåœ¨ libbpf ä¸­æä¾›ä¸€ç³»åˆ—çš„å†…æ ¸ç‰¹æ€§æ¢æµ‹åº“å‡½æ•°ï¼Œè§£å†³äº† eBPF ç¨‹åºåœ¨ä¸åŒå†…æ ¸å†…ç‰ˆæœ¬ä¸­éœ€è¦æ‰§è¡Œä¸åŒè¡Œä¸ºçš„é—®é¢˜ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥ç”¨ bpf_core_type_exists() å’Œbpf_core_field_exists() åˆ†åˆ«æ£€æŸ¥å†…æ ¸æ•°æ®ç±»å‹å’Œæˆå‘˜å˜é‡æ˜¯å¦å­˜åœ¨ï¼Œä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼ extern int LINUX_KERNEL_VERSION __kconfig çš„æ–¹å¼æŸ¥è¯¢å†…æ ¸çš„é…ç½®é€‰é¡¹ã€‚</li>
</ul>
<p>é‡‡ç”¨è¿™äº›æ–¹æ³•ä¹‹åï¼ŒCO-RE å°±ä½¿å¾— eBPF ç¨‹åºå¯ä»¥åœ¨å¼€å‘ç¯å¢ƒç¼–è¯‘å®Œæˆä¹‹åï¼Œåˆ†å‘åˆ°ä¸åŒç‰ˆæœ¬å†…æ ¸çš„æœºå™¨ä¸­è¿è¡Œï¼Œå¹¶ä¸”ä¹Ÿä¸å†éœ€è¦ç›®æ ‡æœºå™¨å®‰è£…å„ç§å¼€å‘å·¥å…·å’Œå†…æ ¸å¤´æ–‡ä»¶ã€‚æ‰€ä»¥ï¼ŒLinux å†…æ ¸ç¤¾åŒºæ›´æ¨èæ‰€æœ‰å¼€å‘è€…ä½¿ç”¨ CO-RE å’Œ libbpf æ¥æ„å»º eBPF ç¨‹åºã€‚å®é™…ä¸Šï¼Œå¦‚æœä½ çœ‹è¿‡ BCC çš„æºä»£ç ï¼Œä½ ä¼šå‘ç° BCC å·²ç»æŠŠå¾ˆå¤šå·¥å…·éƒ½è¿ç§»åˆ°äº† CO-REã€‚</p>
<ul>
<li>eBPFå¤šå†…æ ¸ç‰ˆæœ¬å…¼å®¹è¯¦è§£ï¼š <a href="https://time.geekbang.org/column/article/534577">https://time.geekbang.org/column/article/534577</a></li>
<li>BPF CO-RE reference guideï¼š<a href="https://nakryiko.com/posts/bpf-core-reference-guide/">https://nakryiko.com/posts/bpf-core-reference-guide/</a></li>
</ul>
<h2 id="bpf_loop-è¾…åŠ©å‡½æ•°517"><a class="header" href="#bpf_loop-è¾…åŠ©å‡½æ•°517">bpf_loop() è¾…åŠ©å‡½æ•°ï¼š5.17</a></h2>
<p>æ‰©å±•çš„BPFè™šæ‹Ÿæœºçš„ä¸»è¦ç‰¹å¾ä¹‹ä¸€æ˜¯å†…ç½®äºå†…æ ¸çš„éªŒè¯å™¨ï¼Œå®ƒç¡®ä¿æ‰€æœ‰BPFç¨‹åºéƒ½èƒ½å®‰å…¨è¿è¡Œã€‚ä¸è¿‡ï¼ŒBPFå¼€å‘è€…å¸¸å¸¸è®¤ä¸ºéªŒè¯å™¨æœ‰ç‚¹å–œå¿§å‚åŠï¼›è™½ç„¶å®ƒèƒ½åœ¨å¾ˆå¤šé—®é¢˜å‘ç”Ÿä¹‹å‰æŠ“ä½å®ƒä»¬ï¼Œä½†å®ƒä¹Ÿå¾ˆéš¾è®©äººæ»¡æ„ã€‚å°†å…¶ä¸ä¸€ä¸ªå–„æ„ä½†å—è§„åˆ™çº¦æŸä¸”æŒ‘å‰”çš„å®˜åƒšæœºæ„ç›¸æå¹¶è®ºå¹¶ä¸æ˜¯å®Œå…¨é”™çš„ã€‚Joanne Koongæå‡ºçš„ bpf_loop() å»ºè®®æ˜¯ä¸ºäº†è®©ä¸€ç§ç±»å‹çš„å¾ªç¯ç»“æ„æ›´å®¹æ˜“å–æ‚¦BPFçš„å®˜åƒšä»¬ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™å°±æ˜¯Koongçš„è¡¥ä¸çš„ç›®çš„ã€‚å®ƒå¢åŠ äº†ä¸€ä¸ªæ–°çš„è¾…åŠ©å‡½æ•°ï¼Œå¯ä»¥ä»BPFä»£ç ä¸­è°ƒç”¨ã€‚</p>
<pre><code class="language-c">    long bpf_loop(u32 iterations, long (*loop_fn)(u32 index, void *ctx),
          void *ctx, u64 flags);
</code></pre>
<p>å¯¹ bpf_loop() çš„è°ƒç”¨å°†å¯¼è‡´å¯¹ loop_fn() çš„è¿­ä»£è°ƒç”¨ï¼Œè¿­ä»£æ•°å’Œä¼ å…¥çš„ ctx ä½œä¸ºå‚æ•°ã€‚flags å€¼ç›®å‰æœªä½¿ç”¨ï¼Œå¿…é¡»ä¸ºé›¶ã€‚loop_fn() é€šå¸¸å°†è¿”å›0ï¼›è¿”å›å€¼ä¸º1å°†ç«‹å³ç»“æŸè¿­ä»£ã€‚ä¸å…è®¸æœ‰å…¶ä»–çš„è¿”å›å€¼ã€‚</p>
<p>ä¸åƒ bpf_for_each_map_elem() å—é™äº bpf map å¤§å°ï¼Œbpf_loop() çš„å¾ªç¯æ¬¡æ•°é«˜è¾¾ 1&lt;&lt;23 = 8388608ï¼ˆè¶…è¿‡ 8 ç™¾ä¸‡ï¼‰æ¬¡ï¼›å¤§å¤§åœ°æ‰©å±•äº† bpf_loop() çš„åº”ç”¨åœºæ™¯ã€‚ä¸è¿‡ï¼Œbpf_loop() å¹¶æ²¡æœ‰å—é™äº BPF æŒ‡ä»¤æ•°ï¼ˆ1 ç™¾ä¸‡æ¡ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºå¾ªç¯å‘ç”Ÿåœ¨ bpf_loop() å¸®åŠ©å‡½æ•°å†…éƒ¨ã€‚</p>
<ul>
<li>A different approach to BPF loopsï¼š<a href="https://lwn.net/Articles/877062/">https://lwn.net/Articles/877062/</a></li>
<li>eBPF Talk: å®æˆ˜ç»éªŒä¹‹ loopï¼š<a href="https://mp.weixin.qq.com/s/neOVsMNVWFbwpTSek-_YsA">https://mp.weixin.qq.com/s/neOVsMNVWFbwpTSek-_YsA</a></li>
</ul>
<h2 id="bpf_link_type_kprobe_multi518"><a class="header" href="#bpf_link_type_kprobe_multi518">BPF_LINK_TYPE_KPROBE_MULTIï¼š5.18</a></h2>
<p>è¿™ä¸ªè¡¥ä¸é›†å¢åŠ äº†æ–°çš„é“¾æ¥ç±»å‹BPF_TRACE_KPROBE_MULTIï¼Œå®ƒé€šè¿‡Masamiåˆ¶ä½œçš„fprobe API [1]æ¥è¿æ¥kprobeç¨‹åºã€‚fprobe APIå…è®¸ä¸€æ¬¡åœ¨å¤šä¸ªå‡½æ•°ä¸Šé™„åŠ æ¢é’ˆï¼Œé€Ÿåº¦éå¸¸å¿«ï¼Œå› ä¸ºå®ƒå·¥ä½œåœ¨ftraceä¹‹ä¸Šã€‚å¦ä¸€æ–¹é¢ï¼Œå®ƒå°†æ¢æµ‹ç‚¹é™åˆ¶åœ¨å‡½æ•°å…¥å£æˆ–è¿”å›ã€‚</p>
<ul>
<li>bpf: Add kprobe multi linkï¼š<a href="https://lwn.net/Articles/885811/">https://lwn.net/Articles/885811/</a></li>
</ul>
<h2 id="åŠ¨æ€æŒ‡é’ˆå’Œç±»å‹æŒ‡é’ˆ519"><a class="header" href="#åŠ¨æ€æŒ‡é’ˆå’Œç±»å‹æŒ‡é’ˆ519">åŠ¨æ€æŒ‡é’ˆå’Œç±»å‹æŒ‡é’ˆï¼š5.19</a></h2>
<p>BPFç¨‹åºä¸­çš„æ‰€æœ‰å†…å­˜è®¿é—®éƒ½ä½¿ç”¨éªŒè¯å™¨è¿›è¡Œå®‰å…¨æ€§é™æ€æ£€æŸ¥ï¼ŒéªŒè¯å™¨åœ¨å…è®¸ç¨‹åºè¿è¡Œä¹‹å‰å¯¹å…¶è¿›è¡Œå…¨é¢åˆ†æã€‚è™½ç„¶è¿™å…è®¸ BPF ç¨‹åºåœ¨å†…æ ¸ç©ºé—´ä¸­å®‰å…¨è¿è¡Œï¼Œä½†å®ƒé™åˆ¶äº†è¯¥ç¨‹åºå¦‚ä½•ä½¿ç”¨æŒ‡é’ˆã€‚ç›´åˆ°æœ€è¿‘ï¼Œä¸€ä¸ªè¿™æ ·çš„é™åˆ¶æ˜¯åœ¨ BPF ç¨‹åºä¸­è¢«æŒ‡é’ˆå¼•ç”¨çš„å†…å­˜åŒºåŸŸçš„å¤§å°å¿…é¡»åœ¨åŠ è½½ BPF ç¨‹åºæ—¶é™æ€çŸ¥é“ã€‚Joanne Koong æœ€è¿‘è®¾ç½®çš„ä¸€ä¸ªè¡¥ä¸é›†å¢å¼ºäº† BPFï¼Œä»¥æ”¯æŒä½¿ç”¨æŒ‡å‘åŠ¨æ€å¤§å°çš„å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆåŠ è½½ç¨‹åºã€‚</p>
<p>Koong çš„è¡¥ä¸é›†å¢åŠ äº†å¯¹è®¿é—® BPF ç¨‹åºä¸­åŠ¨æ€å¤§å°çš„å†…å­˜åŒºåŸŸçš„æ”¯æŒï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªåä¸º dynptrs çš„æ–°ç‰¹æ€§ã€‚dynptrs èƒŒåçš„ä¸»è¦æ€æƒ³æ˜¯å°†æŒ‡å‘åŠ¨æ€å¤§å°çš„æ•°æ®åŒºåŸŸçš„æŒ‡é’ˆä¸éªŒè¯å™¨å’Œä¸€äº› BPF è¾…åŠ©å‡½æ•°ä½¿ç”¨çš„å…ƒæ•°æ®ç›¸å…³è”ï¼Œä»¥ç¡®ä¿å¯¹è¯¥åŒºåŸŸçš„è®¿é—®æ˜¯æœ‰æ•ˆçš„ã€‚Koong çš„è¡¥ä¸é›†åœ¨ä¸€ä¸ªæ–°å®šä¹‰çš„ç±»å‹ä¸­åˆ›å»ºäº†è¿™ç§å…³è”ï¼Œç§°ä¸ºstruct bpf_dynptrã€‚è¿™ç§ç»“æ„å¯¹ BPF ç¨‹åºæ˜¯ä¸é€æ˜çš„ã€‚</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/rz4pd41Y-Cet5YVSAKmCRw">https://mp.weixin.qq.com/s/rz4pd41Y-Cet5YVSAKmCRw</a></li>
</ul>
<h2 id="usdt519"><a class="header" href="#usdt519">USDTï¼š5.19</a></h2>
<p>é™æ€è·Ÿè¸ªç‚¹ï¼ˆtracepointï¼‰ï¼Œåœ¨ç”¨æˆ·ç©ºé—´ä¹Ÿè¢«ç§°ä¸º USDTï¼ˆç”¨æˆ·é™æ€å®šä¹‰çš„è·Ÿè¸ªï¼‰æ¢é’ˆï¼ˆåº”ç”¨ç¨‹åºä¸­æ„Ÿå…´è¶£çš„ç‰¹å®šä½ç½®ï¼‰ï¼Œè·Ÿè¸ªå™¨å¯ä»¥åœ¨æ­¤å¤„æŒ‚è½½æ£€æŸ¥ä»£ç æ‰§è¡Œå’Œæ•°æ®ã€‚å®ƒä»¬ç”±å¼€å‘äººå‘˜åœ¨æºä»£ç ä¸­æ˜ç¡®å®šä¹‰ï¼Œé€šå¸¸åœ¨ç¼–è¯‘æ—¶ç”¨ â€œâ€“enable-traceâ€ ç­‰æ ‡å¿—å¯ç”¨ã€‚é™æ€è·Ÿè¸ªç‚¹çš„ä¼˜åŠ¿åœ¨äºå®ƒä»¬ä¸ä¼šç»å¸¸å˜åŒ–ï¼šå¼€å‘äººå‘˜é€šå¸¸ä¼šä¿æŒç¨³å®šçš„é™æ€è·Ÿè¸ª ABIï¼Œæ‰€ä»¥è·Ÿè¸ªå·¥å…·åœ¨ä¸åŒçš„åº”ç”¨ç¨‹åºç‰ˆæœ¬ä¹‹é—´å·¥ä½œï¼Œè¿™å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚å½“å‡çº§ PostgreSQL å®‰è£…å¹¶é‡åˆ°æ€§èƒ½é™ä½æ—¶ã€‚</p>
<ul>
<li>eBPF æ¦‚è¿°ï¼šç¬¬ 5 éƒ¨åˆ†ï¼šè·Ÿè¸ªç”¨æˆ·è¿›ç¨‹ï¼š<a href="https://www.ebpf.top/post/ebpf-overview-part-5/">https://www.ebpf.top/post/ebpf-overview-part-5/</a></li>
<li>Using user-space tracepoints with BPFï¼š<a href="https://lwn.net/Articles/753601/">https://lwn.net/Articles/753601/</a></li>
</ul>
<h2 id="bpf-panic61"><a class="header" href="#bpf-panic61">bpf panicï¼š6.1</a></h2>
<p>BPFå­ç³»ç»Ÿçš„å…³é”®å–ç‚¹ä¹‹ä¸€æ˜¯åŠ è½½BPFç¨‹åºæ˜¯å®‰å…¨çš„ï¼šBPFéªŒè¯å™¨åœ¨å…è®¸åŠ è½½ä¹‹å‰ç¡®ä¿è¯¥ç¨‹åºä¸ä¼šä¼¤å®³å†…æ ¸ã€‚éšç€æ›´å¤šçš„åŠŸèƒ½è¢«æä¾›ç»™BPFç¨‹åºï¼Œè¿™ç§ä¿è¯ä¹Ÿè®¸ä¼šå¤±å»ä¸€äº›åŠ›é‡ï¼Œä½†å³ä¾¿å¦‚æ­¤ï¼Œçœ‹åˆ° Artem Savkov çš„è¿™ä¸ªæè®®åŠ å…¥äº†ä¸€ä¸ªæ˜ç¡®è®¾è®¡ä¸ºä½¿ç³»ç»Ÿå´©æºƒçš„BPFåŠ©æ‰‹ï¼Œå¯èƒ½ä¼šè®©äººæœ‰ç‚¹åƒæƒŠã€‚å¦‚æœè¿™ä¸ªè¡¥ä¸é›†ä»¥ç±»ä¼¼äºç›®å‰çš„å½¢å¼è¢«åˆå¹¶ï¼Œå®ƒå°†æ˜¯ä¸€ä¸ªæ–°æ—¶ä»£çš„é¢„å…†ï¼Œå³è‡³å°‘åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒBPFç¨‹åºè¢«å…è®¸å…¬å¼€åœ°è¿›è¡Œç ´åã€‚</p>
<p>æ­£å¦‚ Savkov æ‰€æŒ‡å‡ºçš„ï¼ŒBPF çš„ä¸»è¦ç”¨ä¾‹ä¹‹ä¸€æ˜¯å†…æ ¸è°ƒè¯•ï¼Œè¿™é¡¹ä»»åŠ¡ä¹Ÿç»å¸¸å› ä¸ºå­˜åœ¨ä¸€ä¸ªé€‚æ—¶çš„å´©æºƒè½¬å‚¨è€Œå¾—åˆ°å¸®åŠ©ã€‚é€šè¿‡ä½¿å†…æ ¸çš„panic() å‡½æ•°å¯¹BPFç¨‹åºå¯ç”¨ï¼ŒSavkovè¯•å›¾å°†è¿™ä¸¤è€…ç»“åˆèµ·æ¥ï¼Œå…è®¸BPFç¨‹åºåœ¨æ£€æµ‹åˆ°è¡¨æ˜å¼€å‘äººå‘˜æ­£åœ¨å¯»æ‰¾çš„é—®é¢˜çš„æ¡ä»¶æ—¶å¯¼è‡´å´©æºƒï¼Œå¹¶åˆ›å»ºå´©æºƒè½¬å‚¨ã€‚Savkovä¼¼ä¹ä¸æ˜¯å”¯ä¸€æƒ³è¦è¿™ç§èƒ½åŠ›çš„äººï¼›Jiri OlsaæŒ‡å‡ºï¼Œä»–ä¹Ÿæ”¶åˆ°äº†å…³äºè¿™ç§åŠŸèƒ½çš„è¯·æ±‚ã€‚</p>
<ul>
<li>The BPF panic function: <a href="https://lwn.net/Articles/901284/">https://lwn.net/Articles/901284/</a></li>
</ul>
<h2 id="bpf-å†…å­˜åˆ†é…å™¨é“¾è¡¨61"><a class="header" href="#bpf-å†…å­˜åˆ†é…å™¨é“¾è¡¨61">BPF å†…å­˜åˆ†é…å™¨ã€é“¾è¡¨ï¼š6.1</a></h2>
<p>æœ¬ç³»åˆ—ä»‹ç»äº†ç”¨æˆ·å®šä¹‰çš„BPFå¯¹è±¡åœ¨ç¨‹åºä¸­çš„ BTF ç±»å‹ã€‚è¿™å…è®¸BPFç¨‹åºåˆ†é…ä»–ä»¬è‡ªå·±çš„å¯¹è±¡ï¼Œå»ºç«‹ä»–ä»¬çš„è‡ªå·±çš„å¯¹è±¡å±‚æ¬¡ï¼Œå¹¶ä½¿ç”¨ç”±BPF è¿è¡Œæ—¶æä¾›çš„åŸºæœ¬æ„ä»¶æ¥çµæ´»åœ°å»ºç«‹è‡ªå·±çš„æ•°æ®ç»“æ„ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬ä»‹ç»äº†å¯¹å•ä¸€æ‰€æœ‰æƒBPFé“¾è¡¨çš„æ”¯æŒã€‚å®ƒå¯ä»¥æ”¾åœ¨BPFæ˜ å°„æˆ–åˆ†é…çš„å¯¹è±¡ä¸­ï¼Œå¹¶æŠŠè¿™äº›è¢«åˆ†é…çš„å¯¹è±¡ä½œä¸ºå…ƒç´ ã€‚å®ƒä½œä¸ºä¸€ä¸ªä¾µå…¥æ€§çš„é›†åˆå·¥ä½œã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†åœ¨å°†æ¥ä½¿åˆ†é…çš„å¯¹è±¡æˆä¸ºå¤šä¸ªæ•°æ®ç»“æ„çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>è¿™ä¸ªè¡¥ä¸å’Œæœªæ¥è¡¥ä¸çš„æœ€ç»ˆç›®æ ‡æ˜¯å…è®¸äººä»¬åœ¨ BPF C ä¸­åšä¸€äº›æœ‰é™çš„å†…æ ¸å¼ç¼–ç¨‹ï¼Œå¹¶å…è®¸ç¨‹åºå‘˜çµæ´»åœ°ä»åŸºæœ¬çš„æ„å»ºå—ä¸­çµæ´»åœ°æ„å»ºè‡ªå·±çš„å¤æ‚æ•°æ®ç»“æ„ã€‚</p>
<p>å…³é”®çš„åŒºåˆ«åœ¨äºï¼Œè¿™ç§ç¨‹åºæ˜¯ç»è¿‡éªŒè¯çš„ï¼Œæ˜¯å®‰å…¨çš„ï¼Œä¿å­˜ç³»ç»Ÿçš„è¿è¡Œæ—¶å®Œæ•´æ€§ï¼Œå¹¶è¢«è¯æ˜æ˜¯æ²¡æœ‰é”™è¯¯çš„</p>
<p>å…·ä½“çš„åŠŸèƒ½åŒ…å«</p>
<ul>
<li>åˆ†é…å¯¹è±¡</li>
<li>bpf_obj_new, bpf_obj_drop æ¥åˆ†é…å’Œé‡Šæ”¾å¯¹è±¡</li>
<li>å•ä¸€æ‰€æœ‰æƒçš„BPFé“¾è¡¨
<ul>
<li>åœ¨ BPF maps ä¸­æ”¯æŒå®ƒä»¬</li>
<li>åœ¨åˆ†é…çš„å¯¹è±¡ä¸­æ”¯æŒå®ƒä»¬</li>
</ul>
</li>
<li>å…¨å±€è‡ªæ—‹é”ã€‚</li>
<li>åœ¨è¢«åˆ†é…å¯¹è±¡ä¸­çš„è‡ªæ—‹é”ã€‚</li>
</ul>
<p>å‚è€ƒï¼š<a href="https://lwn.net/Articles/914833/">https://lwn.net/Articles/914833/</a></p>
<h2 id="user-ring-buffer-61"><a class="header" href="#user-ring-buffer-61">user ring buffer 6.1</a></h2>
<p>è¿™ä¸ªè¡¥ä¸é›†å®šä¹‰äº†ä¸€ä¸ªæ–°çš„æ˜ å°„ç±»å‹ï¼ŒBPF_MAP_TYPE_USER_RINGBUFï¼Œå®ƒåœ¨ä¸€ä¸ªç¯å½¢ç¼“å†²å™¨ä¸Šæä¾›äº†å•ç”¨æˆ·ç©ºé—´ç”Ÿäº§è€…/å•å†…æ ¸æ¶ˆè´¹è€…çš„è¯­ä¹‰ã€‚  é™¤äº†æ–°çš„æ˜ å°„ç±»å‹å¤–ï¼Œè¿˜å¢åŠ äº†ä¸€ä¸ªåä¸ºbpf_user_ringbuf_drain()çš„è¾…åŠ©å‡½æ•°ï¼Œå®ƒå…è®¸BPFç¨‹åºæŒ‡å®šä¸€ä¸ªå…·æœ‰å¦‚ä¸‹ç­¾åçš„å›è°ƒï¼Œæ ·æœ¬ç”±è¾…åŠ©å‡½æ•°å‘å¸ƒåˆ°è¯¥å›è°ƒã€‚</p>
<pre><code class="language-c">voidï¼ˆstruct bpf_dynptr *dynptr, void *contextï¼‰ã€‚
</code></pre>
<p>ç„¶åç¨‹åºå¯ä»¥ä½¿ç”¨bpf_dynptr_read()æˆ–bpf_dynptr_data()è¾…åŠ©å‡½æ•°æ¥å®‰å…¨åœ°ä»dynpträ¸­è¯»å–æ ·æœ¬ã€‚ç›®å‰æ²¡æœ‰å¯ç”¨çš„è¾…åŠ©å‡½æ•°æ¥ç¡®å®šæ ·æœ¬çš„å¤§å°ï¼Œä½†æ˜¯å¦‚æœéœ€è¦çš„è¯ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ·»åŠ ä¸€ä¸ªã€‚</p>
<p>libbpf ä¹Ÿæ·»åŠ äº†ä¸€äº›å¯¹åº”çš„ API:</p>
<pre><code class="language-c">struct ring_buffer_user *
ring_buffer_user__new(int map_fd,
                      const struct ring_buffer_user_opts *opts);
void ring_buffer_user__free(struct ring_buffer_user *rb);
void *ring_buffer_user__reserve(struct ring_buffer_user *rb,
        uint32_t size);
void *ring_buffer_user__poll(struct ring_buffer_user *rb, uint32_t size,
           int timeout_ms);
void ring_buffer_user__discard(struct ring_buffer_user *rb, void *sample);
void ring_buffer_user__submit(struct ring_buffer_user *rb, void *sample);
</code></pre>
<ul>
<li>bpf: Add user-space-publisher ring buffer map typeï¼š <a href="https://lwn.net/Articles/907056/">https://lwn.net/Articles/907056/</a></li>
</ul>
<blockquote>
<ul>
<li>æœ¬æ–‡ç”± eunomia-bpf å›¢é˜Ÿå®Œæˆï¼Œæˆ‘ä»¬æ­£åœ¨æ¢ç´¢ eBPF å’Œ WebAssembly ç›¸äº’ç»“åˆçš„å·¥å…·é“¾å’Œè¿è¡Œæ—¶: <a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></li>
<li>ä»¥åŠåœ¨ Wasm å’Œ eBPF ä¹‹ä¸Šï¼Œå°è¯•æ„å»ºä¸€äº›æœ‰è¶£çš„åº”ç”¨åœºæ™¯ï¼š</li>
</ul>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
