<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Eunomia-bpf Documents</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="introduction/index.html"><strong aria-hidden="true">1.</strong> Introduction</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="introduction/introduction.html"><strong aria-hidden="true">1.1.</strong> Detail introduction</a></li><li class="chapter-item "><a href="wasm-bpf.html"><strong aria-hidden="true">1.2.</strong> Wasm-bpf subproject</a></li></ol></li><li class="chapter-item "><li class="part-title">User Manual</li><li class="chapter-item "><a href="quickstart.html"><strong aria-hidden="true">2.</strong> Quick Start</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="installation/index.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item "><a href="installation/build.html"><strong aria-hidden="true">2.2.</strong> Build</a></li><li class="chapter-item "><a href="installation/build-android-arm.html"><strong aria-hidden="true">2.3.</strong> Build on Android or ARM</a></li></ol></li><li class="chapter-item "><a href="ecc/index.html"><strong aria-hidden="true">3.</strong> ecc</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ecc/usage.html"><strong aria-hidden="true">3.1.</strong> usage</a></li><li class="chapter-item "><a href="ecc/docker-usage.html"><strong aria-hidden="true">3.2.</strong> docker</a></li><li class="chapter-item "><a href="ecc/github-template.html"><strong aria-hidden="true">3.3.</strong> template</a></li><li class="chapter-item "><a href="ecc/config-lua-depreciate.html"><strong aria-hidden="true">3.4.</strong> lua</a></li></ol></li><li class="chapter-item "><a href="ecli/index.html"><strong aria-hidden="true">4.</strong> ecli</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ecli/docker.html"><strong aria-hidden="true">4.1.</strong> docker</a></li></ol></li><li class="chapter-item "><a href="bpf-loader/index.html"><strong aria-hidden="true">5.</strong> bpf-loader</a></li><li class="chapter-item "><a href="ecli-dockerfile-usage.html"><strong aria-hidden="true">6.</strong> Docker manual</a></li><li class="chapter-item "><a href="mannual.html"><strong aria-hidden="true">7.</strong> Manual (Chinese)</a></li><li class="chapter-item "><a href="online.html"><strong aria-hidden="true">8.</strong> Online Demo</a></li><li class="chapter-item "><a href="common_problems.html"><strong aria-hidden="true">9.</strong> Common problems</a></li><li class="chapter-item "><a href="supporting-external-BTF.html"><strong aria-hidden="true">10.</strong> External BTF support</a></li><li class="chapter-item "><a href="benchmark.html"><strong aria-hidden="true">11.</strong> Benchmark</a></li><li class="chapter-item affix "><li class="part-title">Videos</li><li class="chapter-item "><a href="video.html"><strong aria-hidden="true">12.</strong> Public talk video</a></li><li class="chapter-item affix "><li class="part-title">Blogs</li><li class="chapter-item "><a href="blog/index.html"><strong aria-hidden="true">13.</strong> Blogs (Chinese)</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="blog/introduce-to-wasm-bpf-bpf-community.html"><strong aria-hidden="true">13.1.</strong> Wasm-bpf: Êû∂Ëµ∑ Webassembly Âíå eBPF ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢Å</a></li><li class="chapter-item "><a href="blog/how-to-write-c-in-wasm.html"><strong aria-hidden="true">13.2.</strong> Âú® WebAssembly ‰∏≠‰ΩøÁî® C/C++ Âíå libbpf ÁºñÂÜô eBPF Á®ãÂ∫è</a></li><li class="chapter-item "><a href="blog/how-to-write-rust-in-wasm.html"><strong aria-hidden="true">13.3.</strong> Âú® WebAssembly ‰∏≠‰ΩøÁî® Rust ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÂèëÂ∏É OCI ÈïúÂÉè</a></li><li class="chapter-item "><a href="blog/GPTtrace.html"><strong aria-hidden="true">13.4.</strong> ‰ΩøÁî® ChatGPT ÔºåÈÄöËøáËá™ÁÑ∂ËØ≠Ë®ÄÁºñÂÜô eBPF Á®ãÂ∫èÂíåËøΩË∏™ Linux Á≥ªÁªü</a></li><li class="chapter-item "><a href="blog/ebpf-wasm.html"><strong aria-hidden="true">13.5.</strong> ÂΩì Wasm ÈÅáËßÅ eBPF Ôºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫è</a></li><li class="chapter-item "><a href="blog/lmp-eunomia.html"><strong aria-hidden="true">13.6.</strong> Â¶Ç‰ΩïÂú® Linux ÊòæÂæÆÈïúÔºàLMPÔºâÈ°πÁõÆ‰∏≠ÂºÄÂêØ eBPF ‰πãÊóÖ</a></li><li class="chapter-item "><a href="blog/0.3.0-release.html"><strong aria-hidden="true">13.7.</strong> eunomia-bpf 0.3.0 ÂèëÂ∏ÉÔºöÂè™ÈúÄÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÔºåËΩªÊùæÊûÑÂª∫„ÄÅÊâìÂåÖ„ÄÅÂèëÂ∏ÉÂÆåÊï¥ÁöÑ eBPF Â∫îÁî®</a></li><li class="chapter-item "><a href="blog/coolbpf-eunomia.html"><strong aria-hidden="true">13.8.</strong> eunomia-bpfÔºöÂ±ïÊúõ 2023ÔºåËÆ© eBPF Êèí‰∏ä Wasm ÁöÑÁøÖËÜÄ</a></li><li class="chapter-item "><a href="blog/bpf-news.html"><strong aria-hidden="true">13.9.</strong> eBPF ËøõÈò∂: ÂÜÖÊ†∏Êñ∞ÁâπÊÄßËøõÂ±ï‰∏ÄËßà</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Eunomia-bpf Documents</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/eunomia-bpf/eunomia-bpf" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="introduction/../img/logo.png" alt="logo" /></p>
<h1 id="eunomia-bpf-simplify-and-enhance-ebpf-with-co-re1-and-webassembly2"><a class="header" href="#eunomia-bpf-simplify-and-enhance-ebpf-with-co-re1-and-webassembly2">eunomia-bpf: simplify and enhance eBPF with CO-RE<sup class="footnote-reference"><a href="#1">1</a></sup> and WebAssembly<sup class="footnote-reference"><a href="#2">2</a></sup></a></h1>
<p><a href="https://github.com/eunomia-bpf/eunomia-bpf/actions"><img src="https://github.com/eunomia-bpf/eunomia-bpf/workflows/Ubuntu/badge.svg" alt="Actions Status" /></a>
<a href="https://github.com/eunomia-bpf/eunomia-bpf/releases"><img src="https://img.shields.io/github/v/release/eunomia-bpf/eunomia-bpf" alt="GitHub release (latest by date)" /></a>
<a href="https://codecov.io/gh/eunomia-bpf/eunomia-bpf"><img src="https://codecov.io/gh/eunomia-bpf/eunomia-bpf/branch/master/graph/badge.svg?token=YTR1M16I70" alt="codecov" /></a>
<a href="https://deepsource.io/gh/eunomia-bpf/eunomia-bpf/?ref=repository-badge"><img src="https://deepsource.io/gh/eunomia-bpf/eunomia-bpf.svg/?label=active+issues&amp;show_trend=true&amp;token=rcSI3J1-gpwLIgZWtKZC-N6C" alt="DeepSource" /></a>
<a href="https://www.codefactor.io/repository/github/eunomia-bpf/eunomia-bpf"><img src="https://www.codefactor.io/repository/github/eunomia-bpf/eunomia-bpf/badge" alt="CodeFactor" /></a></p>
<p><strong>A compiler and runtime framework to help you build and distribute eBPF program easier.</strong></p>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p><code>eunomia-bpf</code> is a dynamic loading library/runtime and a compile toolchain framework, aim at helping you build and distribute eBPF programs easier.</p>
<p>With eunnomia-bpf, you can:</p>
<ul>
<li>A library to simplify <code>writing</code> eBPF programs:
<ul>
<li>simplify building CO-RE<sup class="footnote-reference"><a href="#1">1</a></sup> <code>libbpf</code> eBPF applications: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/introduction.md#simplify-building-co-re-libbpf-ebpf-applications">write eBPF kernel code only</a> and automatically exposing your data with <code>perf event</code> or <code>ring buffer</code> from kernel.</li>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/introduction.md#automatically-sample-the-data-and-print-hists-in-userspace">Automatically sample the data</a> from hash maps and print <code>hists</code> in userspace.</li>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/introduction.md#automatically-generate-and-config-command-line-arguments">Automatically generate</a> and config <code>command line arguments</code> for eBPF programs.</li>
<li>You can writing the kernel part in both <code>BCC</code> and <code>libbpf</code> styles.</li>
</ul>
</li>
<li>Build eBPF programs with <code>Wasm</code><sup class="footnote-reference"><a href="#2">2</a></sup>: see <a href="https://github.com/eunomia-bpf/wasm-bpf"><code>Wasm-bpf</code></a> project
<ul>
<li>Runtime, libraries and toolchains to <a href="https://github.com/eunomia-bpf/wasm-bpf">write eBPF with Wasm</a> in C/C++, Rust, Go...covering the use cases from <code>tracing</code>, <code>networking</code>, <code>security</code>.</li>
</ul>
</li>
<li>simplify <code>distributing</code> eBPF programs:
<ul>
<li>A <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/ecli">tool</a> for push, pull and run pre-compiled eBPF programs as <code>OCI</code> images in Wasm module</li>
<li>Run eBPF programs from <code>cloud</code> or <code>URL</code> within <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/introduction.md#dynamic-load-and-run-co-re-ebpf-kernel-code-from-the-cloud-with-url-or-oci-image"><code>1</code> line of bash</a> without recompiling, kernel version and architecture independent.</li>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/bpf-loader">Dynamically load</a> eBPF programs with <code>JSON</code> config file or <code>Wasm</code> module.</li>
</ul>
</li>
</ul>
<p>For more information, see <a href="introduction/introduction.html">next</a>.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>CO-RE: <a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">Compile Once ‚Äì Run Everywhere</a>
<sup class="footnote-reference"><a href="#2">2</a></sup>: WebAssembly or Wasm: https://webassembly.org/</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-1"><a class="header" href="#introduction-1">introduction</a></h1>
<p><code>eunomia-bpf</code> is a dynamic loading library/runtime and a compile toolchain framework, aim at helping you build and distribute eBPF programs easier.</p>
<h3 id="simplify-building-co-re-libbpf-ebpf-applications"><a class="header" href="#simplify-building-co-re-libbpf-ebpf-applications">Simplify building CO-RE libbpf eBPF applications</a></h3>
<p>Just Write libbpf eBPF kernel code only, auto config the userspace part!</p>
<h4 id="automatically-exposing-your-data-from-kernel"><a class="header" href="#automatically-exposing-your-data-from-kernel">Automatically exposing your data from kernel</a></h4>
<ul>
<li>
<p>Get data automatically from <code>perf event</code> or <code>ring buffer</code> to userspace:</p>
<pre><code class="language-c">struct {
  __uint(type, BPF_MAP_TYPE_RINGBUF);
  __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
  ....
  e = bpf_ringbuf_reserve(&amp;rb, sizeof(*e), 0);
  ....
  bpf_ringbuf_submit(e, 0);
  return 0;
}
</code></pre>
<p>Compile and Run the program:</p>
<pre><code class="language-console">$ ecc bootstrap.bpf.c bootstrap.h
Compiling bpf object...
Generating export types...
Packing ebpf object and config into package.json...
$ sudo ./ecli examples/bpftools/bootstrap/package.json
TIME     PID     PPID    EXIT_CODE  DURATION_NS  COMM    FILENAME  EXIT_EVENT  
22:01:04  46310  2915    0          0            sh      /bin/sh   0
22:01:04  46311  46310   0          0            which   /usr/bin/which 0
22:01:04  46311  46310   0          2823776      which             1
22:01:04  46310  2915    0          6288891      sh                1
22:01:04  46312  2915    0          0            sh      /bin/sh   0
22:01:04  46313  46312   0          0            ps      /usr/bin/ps 0
</code></pre>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/examples/bpftools/bootstrap">bootstrap</a> for example. This is exactly the same as <a href="https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/bootstrap.bpf.c">bootstrap.bpf.c</a> in <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a> project, but only kernel code is needed.</p>
</li>
</ul>
<h4 id="automatically-sample-the-data-and-print-hists-in-userspace"><a class="header" href="#automatically-sample-the-data-and-print-hists-in-userspace">Automatically sample the data and print <code>hists</code> in userspace</a></h4>
<ul>
<li>
<p>Sample the data from hash maps and print them in human readable format with comments:</p>
<pre><code class="language-c">/// @sample {&quot;interval&quot;: 1000, &quot;type&quot; : &quot;log2_hist&quot;}
struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, MAX_ENTRIES);
    __type(key, u32);
    __type(value, struct hist);
} hists SEC(&quot;.maps&quot;);
</code></pre>
<p>and Get <code>hist</code> data from <code>hists</code> map and print them in human readable format:</p>
<pre><code class="language-bash">$ sudo ecli  examples/bpftools/runqlat/package.json --targ_per_process
key = 8326
comm = containerd

      usec              : count    distribution
        0 -&gt; 1          : 0        |                                        |
        2 -&gt; 3          : 0        |                                        |
        4 -&gt; 7          : 0        |                                        |
        8 -&gt; 15         : 0        |                                        |
       16 -&gt; 31         : 2        |*************                           |
       32 -&gt; 63         : 2        |*************                           |
       64 -&gt; 127        : 6        |****************************************|
      128 -&gt; 255        : 0        |                                        |
      256 -&gt; 511        : 2        |*************                           |
</code></pre>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/examples/bpftools/runqlat/runqlat.bpf.c">examples/bpftools/mdflush.bpf.c</a> for example.</p>
</li>
</ul>
<h4 id="automatically-generate-and-config-command-line-arguments"><a class="header" href="#automatically-generate-and-config-command-line-arguments">Automatically generate and config command line arguments</a></h4>
<ul>
<li>
<p>Automatically generate and config command line arguments for your eBPF program from the comments in your kernel code:</p>
<pre><code class="language-c">/// Process ID to trace
const volatile pid_t pid_target = 0;
/// Thread ID to trace
const volatile pid_t tgid_target = 0;
/// @description User ID to trace
const volatile uid_t uid_target = 0;
/// @cmdarg {&quot;default&quot;: false, &quot;short&quot;: &quot;f&quot;, &quot;long&quot;: &quot;failed&quot;}
/// @description target pid to trace
const volatile bool targ_failed = false;
</code></pre>
<p>and Get:</p>
<pre><code class="language-console">$ sudo ecli  examples/bpftools/opensnoop/package.json -h
Usage: opensnoop_bpf [--help] [--version] [--verbose] [--pid_target VAR] [--tgid_target VAR] [--uid_target VAR] [--failed]

Trace open family syscalls.

Optional arguments:
  -h, --help    shows help message and exits 
  -v, --version prints version information and exits 
  --verbose     prints libbpf debug information 
  --pid_target  Process ID to trace 
  --tgid_target Thread ID to trace
</code></pre>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/examples/bpftools/opensnoop/opensnoop.bpf.c">examples/bpftools/opensnoop/opensnoop.bpf.c</a> for example.</p>
</li>
<li>
<p><code>100%</code> compatible with <code>libbpf</code>, <a href="https://github.com/libbpf/libbpf-bootstrap/tree/master/examples/c">libbpf-bootstrap</a> and <code>libbpf-rs</code>, etc: you can compile <a href="https://github.com/iovisor/bcc/blob/master/libbpf-tools">libbpf-tools</a> kernel code with <code>eunomia-bpf</code> and run them without many modification!</p>
</li>
<li>
<p>Not limited to tracing: support <code>tracepoints</code>, <code>kprobe</code>, <code>uprobe</code>, <code>lsm</code>, <code>xdp</code>, <code>tc</code> etc...</p>
</li>
</ul>
<h3 id="compile-and-pack-co-re-ebpf-kernel-code-to-a-config-file"><a class="header" href="#compile-and-pack-co-re-ebpf-kernel-code-to-a-config-file">Compile and pack CO-RE eBPF kernel code to a config file</a></h3>
<ul>
<li>
<p>Compile and pack CO-RE eBPF kernel code to a <code>JSON</code> or <code>YAML</code> config file:</p>
<pre><code class="language-console">$ ecc cmd/test/opensnoop.bpf.c opensnoop.h
Compiling bpf object...
Generating export types...
Packing ebpf object and config into package.json...
$ docker run -it -v `pwd`/:/src/ ghcr.io/eunomia-bpf/ecc-`uname -m`:latest # build with docker for x86_64 and aarch64
Packing ebpf object and config into package.json...
</code></pre>
<p>You can modify the config file and config the eBPF program behavior to your need.</p>
</li>
</ul>
<h3 id="dynamic-load-and-run-co-re-ebpf-kernel-code-from-the-cloud-with-url-or-oci-image"><a class="header" href="#dynamic-load-and-run-co-re-ebpf-kernel-code-from-the-cloud-with-url-or-oci-image">Dynamic load and run CO-RE eBPF kernel code from the cloud with URL or OCI image</a></h3>
<ul>
<li>
<p>you can dynamically load it on different kernel version without recompile, and without clang/llvm dependency:</p>
<pre><code class="language-console">$ sudo ecli opensnoop.json
TIME     PID     TPID    SIG     RET     COMM    
22:58:28  77121  3168    0       0       cpptools-srv
22:58:29  69044  3168    0       0       cpptools-srv
22:58:29  3014   2906    0       0       code
22:58:29  6952   4061    0       0       node
22:58:29  4061   3937    0       0       node
22:58:29  75263  3168    0       0       cpptools-srv
22:58:29  2906   2488    0       0       code
22:58:29  69149  3168    0       0       cpptools-srv
22:58:29  73541  3168    0       0       cpptools-srv
22:58:29  73468  3168    0       0       cpptools-srv
22:58:29  2906   2488    0       0       code
22:58:29  69094  3168    0       0       cpptools-srv
</code></pre>
</li>
<li>
<p>Get pre-compiled eBPF programs running from the cloud to the kernel in <code>1</code> line of bash, kernel version and architecture independent:</p>
<pre><code class="language-bash"># download the release from https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecli
$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
$ sudo ./ecli https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/package.json # simply run a pre-compiled ebpf code from a url
$ sudo ./ecli sigsnoop:latest # run with a name and download the latest version bpf tool from our repo
</code></pre>
</li>
<li>
<p>very small and simple! The library itself <code>&lt;1MB</code> and no <code>LLVM/Clang</code> dependence, can be embedded easily in you project</p>
</li>
<li>
<p>as fast as <code>&lt;100ms</code> and little resource need to dynamically load and run eBPF program</p>
</li>
</ul>
<p>Base on <code>eunomia-bpf</code>, we have an eBPF pacakge manager in <a href="https://github.com/linuxkerneltravel/lmp">LMP</a> project, with OCI images and <a href="https://github.com/oras-project/oras">ORAS</a> for distribution.</p>
<h3 id="wasm-bpf-write-user-space-code-for-your-ebpf-program-in-webassembly"><a class="header" href="#wasm-bpf-write-user-space-code-for-your-ebpf-program-in-webassembly"><a href="https://github.com/eunomia-bpf/wasm-bpf">wasm-bpf</a>: Write user space code for your eBPF program in WebAssembly</a></h3>
<p>see <a href="https://github.com/eunomia-bpf/wasm-bpf">wasm-bpf</a> project:</p>
<p>A WebAssembly eBPF library, toolchain and runtime powered by <a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">CO-RE</a>(Compile Once ‚Äì Run Everywhere) <a href="https://github.com/libbpf/libbpf">libbpf</a> and <a href="https://github.com/bytecodealliance/wasm-micro-runtime">WAMR</a>.</p>
<ul>
<li><strong><code>General purpose</code></strong>: provide most abilities from eBPF to Wasm, <code>polling</code> from the ring buffer or perf buffer, bidirectional communications between <code>kernel</code> eBPF and <code>userspace</code> Wasm using <code>maps</code>, dynamically <code>loading</code>, <code>attaching</code> or <code>detaching</code>, etc. Supports a large number of eBPF program types and map types, covering the use cases from <code>tracing</code>, <code>networking</code>, <code>security</code>.</li>
<li><strong><code>High performance</code></strong>: No <code>serialization</code> overhead for complex data types, using <code>shared memory</code> to avoid copy overhead between host and Wasm.</li>
<li><strong><code>Easy to use</code></strong>: provide a similar developing experience as the <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a>, <code>auto generate</code> the Wasm-eBPF skeleton headers and type definitions for bindings.</li>
<li><strong><code>Ultralightweight</code></strong>: the sample runtime has only <code>300+</code> lines of code, binary only <code>1.5 MB</code> in size. Compiled Wasm module would be only <code>~90K</code>. With the same toolchain, you can easily build your own Wasm-eBPF runtime in any languages and platforms!</li>
</ul>
<h2 id="project-architecture"><a class="header" href="#project-architecture">Project Architecture</a></h2>
<p>we have a loader library, a compile toolchain, and some additional tools like cli and a custom metrics exporter.</p>
<p><img src="introduction/../img/eunomia-arch.png" alt="eunomia-arch.png" /></p>
<h3 id="an-bpf-loader-library"><a class="header" href="#an-bpf-loader-library">An bpf-loader library</a></h3>
<p>A wrapper of main functions of libbpf, provide the ability to dynamically load eBPF code to the kernel and run it with a simple JSON and a few API.</p>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/bpf-loader">bpf-loader</a> for details.</p>
<p>A <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/ecli">simple cli interface</a> is provided for bpf-loader library, which you can use it to start any eBPF program from a url in a command. You can download it from <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases/">release</a>.</p>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples">examples</a> for more examples.</p>
<h3 id="a-library-to-load-and-operate-ebpf-program-from-a-wasm-module"><a class="header" href="#a-library-to-load-and-operate-ebpf-program-from-a-wasm-module">A library to load and operate eBPF program from a WASM module</a></h3>
<p>Use the <code>eunomia-bpf</code> library to load <code>eBPF</code> program from a <code>WASM</code> module, you can write a WASM module to operate the eBPF program or process the data in user space <code>WASM</code> runtime. The idea is simple:</p>
<ol>
<li>compile the kernel eBPF code skeleton to the <code>JSON</code> format with <code>eunomia-cc</code> toolchain</li>
<li>embed the <code>JSON</code> data in the <code>WASM</code> module, and provide some API for operating the eBPF program skeleton</li>
<li>load the <code>JSON</code> data from the <code>WASM</code> module and run the eBPF program skeleton with <code>eunomia-bpf</code> library</li>
</ol>
<p>You can have multiple <code>eBPF</code> program in a single <code>WASM</code> module.</p>
<p>See <a href="https://github.com/eunomia-bpf/wasm-bpf">wasm-runtime</a> for details. In fact, <code>wasm-bpf</code> library only exports a few functions from <code>bpf-loader</code> library to the <code>VM</code>, so you can replace the <code>WASM</code> runtime with your own easily.</p>
<p>For example, you can run an eBPF program with a WASM module for an URL:</p>
<pre><code class="language-bash">sudo ./ecli run https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/app.wasm
</code></pre>
<p>You can also generate a WASM program template for eBPF or build WASM module with <code>compiler</code> container:</p>
<pre><code class="language-shell"># for x86_64 and aarch64
docker run -it -v `pwd`/:/src/ ghcr.io/eunomia-bpf/ecc-`uname -m`:latest gen-wasm-skel # generate WASM app template for eBPF
docker run -it -v `pwd`/:/src/ ghcr.io/eunomia-bpf/ecc-`uname -m`:latest build-wasm    # Build WASM module
</code></pre>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/sigsnoop">sigsnoop example</a> for more detail.</p>
<h3 id="a-compile-toolchain-to-help-you-generate-pre-compiled-ebpf-data"><a class="header" href="#a-compile-toolchain-to-help-you-generate-pre-compiled-ebpf-data">A compile toolchain to help you generate pre compiled eBPF data</a></h3>
<p>The toolchain can be used as a docker to generate pre-compiled eBPF data in one command:</p>
<p>see the compile toolchains <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/compiler">compiler</a> for details.</p>
<p>you can also simply use the <a href="https://github.com/eunomia-bpf/ebpm-template">ebpm-template</a> repo as a template in github, just push to it and github action can help you compile CO-RE ebpf code!</p>
<h3 id="other-related-projects"><a class="header" href="#other-related-projects">other related projects</a></h3>
<ul>
<li>
<p>LMP eBPF Hub: <a href="https://github.com/linuxkerneltravel/lmp">github.com/linuxkerneltravel/lmp</a></p>
<blockquote>
<p>a package manager for eBPF based on wasm modules</p>
</blockquote>
</li>
<li>
<p>bolipi online compiler &amp; runner: <a href="https://bolipi.com/ebpf/home/online">https://bolipi.com/ebpf/home/online</a></p>
<blockquote>
<p>an online compiler and runner for eBPF program newbies</p>
</blockquote>
</li>
<li>
<p>An Observability tool</p>
<blockquote>
<p>An prometheus and OpenTelemetry exporter for custom eBPF metrics, written in async rust: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/eunomia-sdks/eunomia-otel">eunomia-exporter</a>. You can compile it or download from <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases/">release</a></p>
</blockquote>
</li>
</ul>
<h2 id="build-the-project"><a class="header" href="#build-the-project">build the project</a></h2>
<p>see <a href="introduction/../installation/build.html">build</a> for details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="-wasm-bpf-wasm-library-and-toolchain-for-ebpf"><a class="header" href="#-wasm-bpf-wasm-library-and-toolchain-for-ebpf">üì¶ Wasm-bpf: Wasm library and toolchain for eBPF</a></h1>
<p><a href="https://github.com/eunomia-bpf/wasm-bpf/actions"><img src="https://github.com/eunomia-bpf/wasm-bpf/workflows/Ubuntu/badge.svg" alt="Actions Status" /></a>
<a href="https://www.codefactor.io/repository/github/eunomia-bpf/wasm-bpf"><img src="https://www.codefactor.io/repository/github/eunomia-bpf/wasm-bpf/badge" alt="CodeFactor" /></a>
<a href="https://deepsource.io/gh/eunomia-bpf/wasm-bpf/?ref=repository-badge"><img src="https://deepsource.io/gh/eunomia-bpf/wasm-bpf.svg/?label=active+issues&amp;show_trend=true&amp;token=rcSI3J1-gpwLIgZWtKZC-N6C" alt="DeepSource" /></a></p>
<p><a href="https://github.com/eunomia-bpf/wasm-bpf/tree/main/README_zh.md">‰∏≠ÊñáÊñáÊ°£</a> <a href="https://gitee.com/eunomia-bpf/wasm-bpf">Gitee</a> <a href="https://github.com/eunomia-bpf/wasm-bpf">Github</a></p>
<p><code>Wasm-bpf</code> is a WebAssembly eBPF library, toolchain and runtime powered by <a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">CO-RE</a>(Compile Once ‚Äì Run Everywhere) <a href="https://github.com/libbpf/libbpf">libbpf</a>. It can help you build almost every eBPF programs or usecases to <code>Wasm</code> with nearly zero modification, and run them cross platforms with Wasm sandbox.</p>
<h2 id="introduction-2"><a class="header" href="#introduction-2">Introduction</a></h2>
<p><code>WebAssembly</code> (Wasm) is a portable binary format for executable code. The code is executed at a nearly-native speed in a memory-safe (for host) sandbox, with clearly defined resource constraints, and APIs for communicating with the embedding host environment (eg. proxy).The <code>wasm-bpf</code> project combines Wasm and eBPF technologies to enhance the performance and programmability of eBPF applications.</p>
<p>With <code>wasm-bpf</code>, users can dynamically load and securely execute user-defined or community-contributed Wasm-eBPF codes as <code>plug-ins</code> in their software products, such as observability platforms or service proxy. This enables efficient and scalable data collection, while also allowing for advanced processing and analysis of that data.</p>
<p>It also enables developers to write eBPF programs in familiar languages like <code>C/C++</code>, <code>Rust</code>, <code>Go</code>, and more than 30 other programming languages, and deploy them easily across different Linux distributions. Additionally, cloud providers can leverage wasm-bpf to offer a <code>secure</code> and <code>high-performance</code> environment for their customers to develop and deploy eBPF applications in their cloud environments.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li><strong><code>General purpose</code></strong>: provide most abilities from eBPF to Wasm, <code>polling</code> from the ring buffer or perf buffer, bidirectional communications between <code>kernel</code> eBPF and <code>userspace</code> Wasm using <code>maps</code>, dynamically <code>loading</code>, <code>attaching</code> or <code>detaching</code>, etc. Supports a large number of eBPF program types and map types.</li>
<li><strong><code>High performance</code></strong>: No <code>serialization</code> overhead for complex data types, using <code>shared memory</code> to avoid copy overhead between host and Wasm.</li>
<li><strong><code>Easy to use</code></strong>: provide a similar developing experience as the <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a>, <code>auto generate</code> the Wasm-eBPF skeleton headers and type definitions for bindings. Write your eBPF programs in <code>C/C++</code>, <code>Rust</code>, <code>Go</code> and compile to Wasm.</li>
<li><strong><code>Ultralightweight</code></strong>: the miminal runtime has only <code>1.5 MB</code> in binary size. Compiled Wasm module would be only <code>~90K</code>. With the same toolchain, you can easily build your own Wasm-eBPF runtime in any languages and platforms!</li>
</ul>
<p>See the <a href="https://github.com/eunomia-bpf/wasm-bpf/tree/main/examples">examples</a> directory for examples of eBPF programs written in C, Rust, Go and compiled to Wasm, covering the use cases from <code>tracing</code>, <code>networking</code> to <code>security</code>.</p>
<p>For tools to distribute Wasm-eBPF programs in <a href="https://opencontainers.org/"><code>OCI</code></a> images, please refer to <a href="https://github.com/eunomia-bpf/eunomia-bpf">eunomia-bpf</a> repo.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<ul>
<li>Github TemplateÔºö<a href="https://github.com/eunomia-bpf/ebpm-template">eunomia-bpf/ebpm-template</a></li>
<li>example bpf programs: <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/examples/bpftools">examples/bpftools</a></li>
<li>tutorial: <a href="https://github.com/eunomia-bpf/bpf-developer-tutorial">eunomia-bpf/bpf-developer-tutorial</a></li>
</ul>
<p>You can get pre-compiled eBPF programs running from the cloud to the kernel in <code>1</code> line of bash:</p>
<pre><code class="language-bash">    # download the release from https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecli
    $ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
    $ sudo ./ecli https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/package.json # simply run a pre-compiled ebpf code from a url
    $ sudo ./ecli sigsnoop:latest # run with a name and download the latest version bpf tool from our repo
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install"><a class="header" href="#install">Install</a></h1>
<ul>
<li>
<p>Install the <code>ecli</code> tool for running eBPF program from the cloud:</p>
<pre><code class="language-console">$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
$ ./ecli -h
Usage: ecli [--help] [--version] [--json] [--no-cache] url-and-args
....
</code></pre>
</li>
<li>
<p>Install the <code>ecc</code> compiler-toolchain for compiling eBPF kernel code to a <code>config</code> file or <code>Wasm</code> module(<code>clang</code>, <code>llvm</code>, and <code>libclang</code> should be installed for compiling):</p>
<pre><code class="language-console">$ wget https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecc &amp;&amp; chmod +x ./ecc
$ ./ecc -h
eunomia-bpf compiler
Usage: ecc [OPTIONS] &lt;SOURCE_PATH&gt; [EXPORT_EVENT_HEADER]
....
</code></pre>
<p>or use the docker image for compile:</p>
<pre><code class="language-bash"># for x86_64 and aarch64
docker run -it -v `pwd`/:/src/ ghcr.io/eunomia-bpf/ecc-`uname -m`:latest # compile with docker. `pwd` should contains *.bpf.c files and *.h files.
</code></pre>
</li>
<li>
<p>build the compiler, runtime library and tools:</p>
<p>see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/documents/build.md">build</a> for building details.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build"><a class="header" href="#build">build</a></h1>
<p>If you want to run the cli, in most cases, you don't need to build your own.</p>
<h1 id="building"><a class="header" href="#building">Building</a></h1>
<p>libbpf-bootstrap supports multiple build systems that do the same thing.
This serves as a cross reference for folks coming from different backgrounds.</p>
<h2 id="install-dependencies"><a class="header" href="#install-dependencies">Install Dependencies</a></h2>
<p>You will need <code>clang</code>, <code>libelf</code> and <code>zlib</code> to build the examples, package names may vary across distros.</p>
<p>On Ubuntu/Debian, you need:</p>
<pre><code class="language-shell">$ apt install clang libelf1 libelf-dev zlib1g-dev
</code></pre>
<p>On CentOS/Fedora, you need:</p>
<pre><code class="language-shell">$ dnf install clang elfutils-libelf elfutils-libelf-devel zlib-devel
</code></pre>
<p>install rust toolchain</p>
<pre><code class="language-shell">curl https://sh.rustup.rs -sSf | sh -s
</code></pre>
<h2 id="build-bpf-loader"><a class="header" href="#build-bpf-loader">build bpf-loader</a></h2>
<p>bpf-loader is our core library written in C++17. It has no other dependencies except libbpf.</p>
<pre><code class="language-shell">$ git submodule update --init --recursive --remote       # check out libbpf
$ make bpf-loader                              # build ebpf-loader
</code></pre>
<p>The recommended compiler is gcc9 or later.</p>
<h2 id="build-ecli"><a class="header" href="#build-ecli">build ecli:</a></h2>
<p>After compile the bpf-loader, you can build the cli tool in C++:</p>
<pre><code class="language-shell">$ make ecli
</code></pre>
<p>reference: https://github.com/libbpf/libbpf-bootstrap</p>
<h2 id="build-wasm-lib"><a class="header" href="#build-wasm-lib">build wasm lib</a></h2>
<pre><code class="language-shell">$ make wasm-runtime
</code></pre>
<p>Please install WASI SDK, download the <a href="https://github.com/CraneStation/wasi-sdk/releases">wasi-sdk</a> release and extract the archive to default path /opt/wasi-sdk if you want to compile c code to wasm.</p>
<h2 id="build-compiler"><a class="header" href="#build-compiler">build compiler</a></h2>
<pre><code class="language-shell">$ make ecc
</code></pre>
<h2 id="more-details"><a class="header" href="#more-details">more details</a></h2>
<ul>
<li>You can check the Makefile at project root for more details: <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/compiler/Makefile">Makefile</a></li>
<li>You may want to refer to our CI for more build info: <a href="https://github.com/eunomia-bpf/eunomia-bpf/blob/master/.github/workflows/ecc.yml">ecc.yml</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-on--android"><a class="header" href="#build-on--android">Build on  Android</a></h1>
<p>Android‰∏äbuildÈúÄË¶ÅÂÖàInstalling Debian on Android in Termux </p>
<p>Âú®Android‰∏äÊûÑÂª∫Êó∂ÔºåÈúÄË¶ÅÂÖàInstalling Debian on Android in Termux </p>
<ol>
<li>install termux</li>
</ol>
<p>https://github.com/termux/termux-app/releases/tag/v0.118.0</p>
<ol start="2">
<li>install proot-distro</li>
</ol>
<p>select debian distro</p>
<pre><code class="language-sh">pkg install proot-distro
proot-distro install debian
proot-distro login debian
</code></pre>
<ol start="3">
<li>install packages</li>
</ol>
<p>remember <code>proot-distro login debian</code> first</p>
<pre><code class="language-sh">apk update
apt install clang cmake libelf1 libelf-dev zlib1g-dev
</code></pre>
<p>‰πãÂêéÁöÑÊ≠•È™§ÂíåÂú®ARM‰∏äbuild‰∏äÁõ∏Âêå</p>
<h1 id="build-on--arm"><a class="header" href="#build-on--arm">Build on  ARM</a></h1>
<ol>
<li>ÂêåÊ≠• eunomia-bpf Âà∞Êú¨Âú∞</li>
</ol>
<pre><code class="language-sh">git clone https://github.com/eunomia-bpf/eunomia-bpf.git
cd eunomia-bpf
git submodule update --init --recursive --remote
</code></pre>
<p>2.ÈÖçÁΩÆÁéØÂ¢ÉÂèòÈáè</p>
<pre><code class="language-sh">export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
</code></pre>
<p>3.ÂÆâË£Ö‰æùËµñ</p>
<pre><code class="language-sh">apt update
apt install clang cmake libelf1 libelf-dev zlib1g-dev
</code></pre>
<p>4.‰øÆÊîπwasm-runtime/CMakeLists.txt<code>‰∏≠ÁöÑ</code>WAMR_BUILD_TARGETÔºàmay not required)</p>
<p>change <code>set (WAMR_BUILD_TARGET &quot;X86_64&quot;)</code> to <code>set (WAMR_BUILD_TARGET &quot;AARCH64&quot;)</code></p>
<p>5.ÁºñËØë</p>
<pre><code class="language-sh">make bpf-loader
make ecli
</code></pre>
<p>6.Ê£ÄÊü•ËæìÂá∫</p>
<pre><code class="language-sh">root@localhost:~/eunomia-bpf# file ecli/build/bin/Release/ecli
ecli: ELF 64-bit LSB pie executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=eab42b79be75951e3a573aa7c61136239d35c868, for GNU/Linux 3.7.0, with debug_info, not stripped
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eunomia-cc-compile-ebpf-programs-and-package"><a class="header" href="#eunomia-cc-compile-ebpf-programs-and-package">eunomia-cc: compile ebpf programs and package</a></h1>
<p>An CO-RE compile set to help you focus on writing a single eBPF program in the kernel.
Nothing more TODO!</p>
<ul>
<li>note this is not a template for new eunomia-bpf projects,
You may find the <a href="https://github.com/eunomia-bpf/ebpm-template">eunomia-bpf-template</a> there.</li>
</ul>
<p>For runtime, please see: <a href="https://github.com/eunomia-bpf/eunomia-bpf">github.com/eunomia-bpf/eunomia-bpf</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="usage"><a class="header" href="#usage">Usage</a></h3>
<pre><code class="language-sh">ecc [OPTIONS] &lt;SOURCE_PATH&gt; [EXPORT_EVENT_HEADER]
</code></pre>
<p>Compiles and generates a bpf object from the provided SOURCE_PATH path for the specified eBPF program.</p>
<h3 id="example"><a class="header" href="#example">example</a></h3>
<h4 id="packagejson-only"><a class="header" href="#packagejson-only">package.json only</a></h4>
<pre><code class="language-sh">ecc foo.bpf.c
</code></pre>
<h4 id="source-file-and-a-header-file"><a class="header" href="#source-file-and-a-header-file">Source file and a header file</a></h4>
<pre><code class="language-sh">ecc foo.bpf.c bar.h
</code></pre>
<h4 id="generate-custom-btfhub-archive-and-package-into-tar"><a class="header" href="#generate-custom-btfhub-archive-and-package-into-tar">Generate custom btfhub-archive and package into tar</a></h4>
<pre><code class="language-sh">ecc -b client.bpf.c event.h
</code></pre>
<p>This command will compile client.bpf.c and event.h into client.bpf.o,
and package them as json, export a tar containing a custom btf file.</p>
<p>output in <code>OUTPUT_PATH</code>:</p>
<pre><code class="language-sh">package.json
client.tar #include custom btf files
</code></pre>
<h3 id="btfhub-support"><a class="header" href="#btfhub-support">btfhub Support</a></h3>
<p><a href="https://github.com/aquasecurity/btfhub">BTF</a> is the things that make eBPF portable.</p>
<p><code>btfhub</code> provide BTF information for Linux distributions released kernels
that don't have embedded BTF information.</p>
<p>By using btfhub to package ebpf programs as tar file,
ecc makes it possible to run ebpf programs on older kernels that do not have btf support.</p>
<p><a href="https://github.com/aquasecurity/btfhub/blob/main/docs/supported-distros.md">A list</a>
of existing distributions and their current status on eBPF and BTF support.</p>
<h3 id="arguments-and-options"><a class="header" href="#arguments-and-options">Arguments and options</a></h3>
<h4 id="arguments"><a class="header" href="#arguments">Arguments</a></h4>
<ul>
<li>
<p><code>SOURCE_PATH</code>: path of the bpf.c file to compile</p>
</li>
<li>
<p><code>EXPORT_EVENT_HEADER</code>: path of the bpf.h header for defining event struct</p>
</li>
</ul>
<h4 id="options"><a class="header" href="#options">Options</a></h4>
<ul>
<li>
<p>-o, --output-path <code>OUTPUT_PATH</code>: path of output bpf object</p>
</li>
<li>
<p>-w, --workspace-path <code>WORKSPACE_PATH</code>: specify custom workspace path </p>
</li>
<li>
<p>-a, --additional-cflags <code>ADDITIONAL_CFLAGS</code>: additional cflags for clang</p>
<ul>
<li>example <code>-a=&quot;-fstack-protector&quot;</code>,
this avoids runtime errors on some distributions that have clang stack protection enabled by default.</li>
</ul>
</li>
<li>
<p>-c, --clang-bin <code>CLANG_BIN</code>: path of clang binary (default: clang)</p>
</li>
<li>
<p>-l, --llvm-strip-bin <code>LLVM_STRIP_BIN</code>: path of llvm-strip binary (default: llvm-strip)</p>
</li>
<li>
<p>-s, --subskeleton: do not pack bpf object in config file</p>
</li>
<li>
<p>-v, --verbose: print the command execution</p>
</li>
<li>
<p>-y, --yaml: output config skel file in yaml</p>
</li>
<li>
<p>--header-only: generate a bpf object for struct definition in header file only</p>
</li>
<li>
<p>--wasm-header: generate wasm include header</p>
</li>
<li>
<p>-b, --btfgen: fetch custom btfhub archive file and package into tar</p>
<ul>
<li>If <code>BTFHUB_ARCHIVE</code> does not exist, it will clone
<a href="https://github.com/aquasecurity/btfhub-archive">btfhub</a> to <code>BTFHUB_ARCHIVE</code>.</li>
<li>This option will take a lot of time, if you don't want to package or generate all custom btf files,
you can keep only the required btf files in <code>BTFHUB_ARCHIVE</code>.</li>
<li>Don't worry, even the tar containing all the btfhub archives is only <code>5-10MB</code> in size.</li>
</ul>
</li>
<li>
<p>--btfhub-archive <code>BTFHUB_ARCHIVE</code>: directory to save btfhub archive file (default:<code>$HOME/.eunomia/btfhub-archive</code>)</p>
</li>
<li>
<p>-h, --help: prints help documentation.</p>
</li>
<li>
<p>-V, --version: prints version information.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="docker-usage"><a class="header" href="#docker-usage">docker usage</a></h2>
<p>The only file you will need to write is:</p>
<pre><code class="language-shell">your_program.bpf.c
your_program.h  # optional, if you want to use ring buffer to export events
</code></pre>
<p>after that, simply run this:</p>
<pre><code class="language-shell">$ docker run -it -v /path/to/repo/:/src ghcr.io/eunomia-bpf/ecc-`uname -m`:latest # use absolute path
</code></pre>
<p>you will get a <code>package.json</code> in your root dir. Just run:</p>
<pre><code class="language-shell">$ sudo ./ecli run package.json
</code></pre>
<p>to start it you can download <code>ecli</code> tool from <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases">eunomia-bpf/releases</a>, we have pre-build binaries for linux x86. Small and No dependencies, besides glibc and glibcxx. Or just run this:</p>
<pre><code class="language-shell">$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ecli
</code></pre>
<p>The eBPF compiled code can run on different kernel versions(CO-RE).
see: <a href="https://github.com/eunomia-bpf/eunomia-bpf">github.com/eunomia-bpf/eunomia-bpf</a> for details.</p>
<h2 id="container-image"><a class="header" href="#container-image">container image</a></h2>
<p>simply run:</p>
<pre><code class="language-shell">$ docker run -it -v /path/to/repo:/src ghcr.io/eunomia-bpf/ecc-`uname -m`
</code></pre>
<p>Or you can do that without a container, which is listed below:</p>
<h2 id="github-actions"><a class="header" href="#github-actions">Github actions</a></h2>
<p>Use this as a github action, to compile online: see <a href="https://github.com/eunomia-bpf/ebpm-template">eunomia-bpf/ebpm-template)</a>. Only three steps</p>
<ol>
<li>use this repo as a github template: see <a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/creating-a-repository-from-a-template">creating-a-repository-from-a-template</a></li>
<li>modify the <code>bootstrap.bpf.c</code>, commit it and wait for the workflow to stop</li>
<li>Run the <code>ecli</code> with remote url:</li>
</ol>
<pre><code class="language-shell">$ sudo ./ecli run https://eunomia-bpf.github.io/ebpm-template/package.json
</code></pre>
<h2 id="notifications"><a class="header" href="#notifications">Notifications</a></h2>
<ol>
<li>
<p>We use the same c ebpf code as libbpf, so most libbpf ebpf c code can run without any modification.</p>
</li>
<li>
<p>Supported ebpf program types: <code>kprobe</code>, <code>tracepoint</code>, <code>fentry</code>, we will add more types in the future.</p>
</li>
<li>
<p>If you want to use ring buffer to export events, you need to add <code>your_program.h</code> to your repo, and
define the export data type in it, the export data type should be a C <code>struct</code>, for example:</p>
<pre><code class="language-c">struct process_event {
    int pid;
    int ppid;
    unsigned exit_code;
    unsigned long long duration_ns;
    char comm[TASK_COMM_LEN];
    char filename[MAX_FILENAME_LEN];
    int exit_event;
};
</code></pre>
<p>The name and field types are not limited, but we will prefer use standard C types. If multiple struct
exists in the header, we will use the first one. The feature is only enabled if we found a <code>BPF_MAP_TYPE_RINGBUF</code>
map exists in the ebpf program.</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="github-action-Ê®°Êùø"><a class="header" href="#github-action-Ê®°Êùø">Github Action Ê®°Êùø</a></h1>
<p>ebpm-templateÔºö‰ΩøÁî® Github Action ËøõË°åËøúÁ®ãÁºñËØëÔºåÊú¨Âú∞‰∏ÄÈîÆËøêË°åÔºõ</p>
<p>ËØ∑ÂèÇËÄÉÔºöhttps://github.com/eunomia-bpf/ebpm-template</p>
<h1 id="a-template-for-eunomia-bpf-programs"><a class="header" href="#a-template-for-eunomia-bpf-programs">A template for eunomia-bpf programs</a></h1>
<p>This is a template for eunomia-bpf eBPF programs. You can use t as a template, compile it online with <code>Github Actions</code> or offline.</p>
<h3 id="compile-and-run-the-ebpf-code-as-simple-as-possible"><a class="header" href="#compile-and-run-the-ebpf-code-as-simple-as-possible">Compile and run the eBPF code as simple as possible!</a></h3>
<p>Download the pre-compiled <code>ecli</code> binary from here: <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases">eunomia-bpf/eunomia-bpf</a></p>
<p>To install, just download and use the <code>ecli</code> binary from here: <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases">eunomia-bpf/eunomia-bpf</a>:</p>
<pre><code class="language-console">wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ecli
</code></pre>
<h2 id="use-this-repo-as-a-github-action-to-compile-online"><a class="header" href="#use-this-repo-as-a-github-action-to-compile-online">use this repo as a github action to compile online</a></h2>
<ol>
<li>use this repo as a github template: see <a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/creating-a-repository-from-a-template">creating-a-repository-from-a-template</a></li>
<li>modify the <code>bootstrap.bpf.c</code>, commit it and wait for the workflow to stop</li>
<li>Run the <code>ecli</code> with remote url:</li>
</ol>
<pre><code class="language-console">$ sudo ./ecli run https://eunomia-bpf.github.io/ebpm-template/package.json
</code></pre>
<h2 id="quick-start-1"><a class="header" href="#quick-start-1">quick start</a></h2>
<p>just write some code in the <code>bootstrap.bpf.c</code>, after that, simply run this:</p>
<pre><code class="language-shell">$ docker run -it -v /path/to/repo:/src yunwei37/ebpm:latest # use absolute path
</code></pre>
<p>you will get a <code>package.json</code> in your root dir. Just run:</p>
<pre><code class="language-shell">$ sudo ./ecli run package.json
</code></pre>
<p>The ebpf compiled code can run on different kernel versions(CO-RE). You can just copied the json to another machine.
see: <a href="https://github.com/eunomia-bpf/eunomia-bpf">github.com/eunomia-bpf/eunomia-bpf</a> for the runtime, and <a href="https://github.com/eunomia-bpf/eunomia-cc">eunomia-bpf/eunomia-cc</a> for our compiler tool chains.</p>
<h2 id="the-code-here"><a class="header" href="#the-code-here">The code here</a></h2>
<p>This is an example of ebpf code, we copied the bootstrap.bpf.c from <a href="https://github.com/libbpf/libbpf-bootstrap/tree/master/examples/c">libbpf-bootstrap</a>, without any modification. You can read their <code>README</code> for details: https://github.com/libbpf/libbpf-bootstrap</p>
<h2 id="more-examples"><a class="header" href="#more-examples">more examples</a></h2>
<p>for more examples, please see: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools">eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lua-condig"><a class="header" href="#lua-condig">lua condig</a></h1>
<p>Á±ª‰ºº‰∫é xmake Âíå <a href="https://github.com/iovisor/bcc/tree/master/examples/lua">https://github.com/iovisor/bcc/tree/master/examples/lua</a> ÁöÑËÆæËÆ°ÔºåÊàë‰ª¨ÊâìÁÆó‰ΩøÁî® lua Êù•Â∏ÆÂä©ËøõË°åÁî®Êà∑ÊÄÅ‰∏Ä‰∫õÂèØÈÄâ‰ø°ÊÅØÁöÑÈÖçÁΩÆÔºå‰æãÂ¶ÇÔºö</p>
<ul>
<li>Â∞ÜÂ§ö‰∏™ eBPF Á®ãÂ∫èÊâìÂåÖÊàê‰∏Ä‰∏™ packageÔºõ</li>
<li>‰øÆÊîπÂÜÖÊ†∏ÊÄÅ‰∏äÊä•ÁöÑ‰ø°ÊÅØÔºõ</li>
<li>ÊéßÂà∂ eBPF Á®ãÂ∫èÁöÑËøêË°åÔºõ</li>
</ul>
<p>‰æãÂ¶ÇÔºö</p>
<pre><code class="language-lua">target(&quot;ebpf_program1&quot;) -- basic
    add_files(&quot;src/opensnoop.bpf.c&quot;)

target(&quot;ebpf_program1&quot;)
    set_kind(&quot;uprobe&quot;)
    attach_to(&quot;handler_entry_uprobe&quot;, &quot;lua_pcall&quot;) -- attach to lua_pcall in uprobe
    on_event(function (event)
        sort(event)
        os.print(&quot;uprobe event: &quot;, event)
        stop(&quot;ebpf_program1&quot;)
    end)
    add_files(&quot;src/uprobe.bpf.c&quot;)

entry(function (arg)   -- replace the default entry with
    if arg == &quot;uprobe&quot; then
        run(&quot;ebpf_program1&quot;)
        sleep(1000)
        run(&quot;ebpf_program2&quot;)
    else
        run(&quot;ebpf_program1&quot;)
    end
end)
</code></pre>
<p>Âú® lua Áî®Êà∑ÊÄÅÈÖçÁΩÆ‰∏≠ÁºñÂÜôÁöÑ‰ø°ÊÅØÂ∫îÂ∞ΩÂèØËÉΩÁÆÄÂçï„ÄÇ</p>
<blockquote>
<p>ËøôÈÉ®ÂàÜËøòÊú™ÂÆåÊàêÔºåÁõÆÂâçÊ≠£Âú®Âä†Á¥ßËµ∂Â∑•</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ecli-run-ebpf-programs-as-json-or-tar"><a class="header" href="#ecli-run-ebpf-programs-as-json-or-tar">ecli: run ebpf programs as json or tar</a></h1>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<pre><code class="language-sh">ecli &lt;COMMAND&gt;
</code></pre>
<h3 id="example-1"><a class="header" href="#example-1">example</a></h3>
<pre><code class="language-sh">ecli run client.tar #
# or
ecli run package.json
</code></pre>
<p>The ecc packaged tar contains custom btf files and <code>package.json</code>,
which can be run on older kernels.
For details, see <a href="ecli/../ecc/usage.html#options">ecc-btfgen</a></p>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<ul>
<li>run - Run the ebpf program as tar or json.</li>
<li>push - Push a container to an OCI registry.</li>
<li>pull - Pull a container from an OCI registry.</li>
<li>login - Login to an OCI registry.</li>
<li>logout - Logout from an OCI registry. </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ecli-docker"><a class="header" href="#ecli-docker">ecli docker</a></h1>
<p>bpf ËøêË°åÊó∂ÈúÄË¶ÅÊúâLinuxÂÜÖÊ†∏Áõ∏ÂÖ≥ÊîØÊåÅÔºådocker ‰∏≠ÁöÑÂÜÖÊ†∏ÂÖ±‰∫´ÁöÑÂÆø‰∏ªÊú∫ÁöÑÂÜÖÊ†∏ÔºåÂõ†Ê≠§‰ΩøÁî®dockerËøêË°åbpfÁ®ãÂ∫èÊó∂ÈúÄË¶Å‰ΩøÁî®‰ª•‰∏ãÂëΩ‰ª§‰∏∫ÂÆπÂô®Ëµã‰∫àÊùÉÈôêÂíåÁõ∏ÂÖ≥ÂÜÖÊ†∏ÊîØÊåÅ„ÄÇ</p>
<p>Ê≠§Â§ÑÂèÇËÄÉhttps://github.com/iovisor/bpftrace/blob/master/INSTALL.md#kernel-headers-install</p>
<pre><code class="language-shell">$ docker run -ti -v /usr/src:/usr/src:ro \
       -v /lib/modules/:/lib/modules:ro \
       -v /sys/kernel/debug/:/sys/kernel/debug:rw \
       -v /home/admin/my:/root/my \ //ÊåÇËΩΩÊú¨Êú∫ÁõÆÂΩïÂà∞ÂÆπÂô®ÁöÑ/root/myË∑ØÂæÑ‰∏ã
       --net=host --pid=host --privileged \
       ecli:1.0.1
</code></pre>
<h2 id="dockerfile-ubuntu"><a class="header" href="#dockerfile-ubuntu">dockerfile ubuntu</a></h2>
<p>dockerfileÁöÑÂü∫Á°ÄÈïúÂÉèÊòØUbuntuÔºåÂõΩÂÜÖ‰ΩøÁî®Êó∂Âõ†‰∏∫ÊúâÂ¢ôÁöÑÂ≠òÂú®ÔºåÊâÄ‰ª•ÈúÄË¶ÅÂØπLinuxËøõË°åÊç¢Ê∫ê„ÄÇsources.listÂ¶Ç‰∏ãÔºö</p>
<pre><code class="language-shell">deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
</code></pre>
<p>dockerfile‰∏≠ÁöÑÂÖ∑‰ΩìÂÜÖÂÆπÂ¶Ç‰∏ã</p>
<pre><code class="language-shell">FROM ubuntu:latest

ENV UBUNTU_SOURCE /etc/apt

COPY ./ /root

WORKDIR /root

ADD sources.list $UBUNTU_SOURCE/

RUN apt-get update &amp;&amp; \
    apt-get -y install gcc libelf-dev

#CMD ./ecli run /root/my/package.json
CMD [&quot;/bin/bash&quot;]

</code></pre>
<p>ubuntu.dockerfileÊûÑÂª∫Êó∂ÔºåÂêå‰∏ÄÁ∫ßÁõÆÂΩï‰∏ãÁöÑÊñá‰ª∂Â¶Ç‰∏ã</p>
<p><img src="ecli/../img/image-20220905232754264.png" alt="image-20220905232754264" /></p>
<p>ecliÂèØÊâßË°åÊñá‰ª∂  sources.list DockerfileËøô‰∏â‰∏™Êñá‰ª∂Áº∫‰∏Ä‰∏çÂèØÔºåotherÊñá‰ª∂ÂèØÂøΩÁï•„ÄÇdockerÂÆπÂô®‰∏≠wgetÊó†Ê≥ïËøûÊé•Â§ñÈÉ®ÁΩëÁªúÔºåÂõ†Ê≠§ÈúÄË¶ÅÂú®dockerÊûÑÂª∫Êó∂Â∞ÜecliÊîæÂÖ•ÈïúÂÉè‰∏≠„ÄÇ‰ΩøÁî®ÈïúÂÉèÊó∂Âè™Ë¶ÅÊåÇËΩΩÁöÑÊú¨Êú∫ÁõÆÂΩï‰∏≠Êúâpackage.jsonÊñá‰ª∂Âç≥ÂèØ„ÄÇ</p>
<h2 id="docker-alpine"><a class="header" href="#docker-alpine">docker alpine</a></h2>
<pre><code class="language-shell">FROM alpine:latest

COPY ./ /root

WORKDIR /root

RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories &amp;&amp; \
    apk update &amp;&amp; \
    apk install gcc libelf gcompat

#CMD ./ecli run /root/my/package.json
</code></pre>
<p>alpine.dockerfileÊûÑÂª∫ÈïúÂÉèÊó∂ÔºåÂêå‰∏ÄÁ∫ßÁõÆÂΩï‰∏ãÂøÖÈ°ªÊúâecliÂèØÊâßË°åÊñá‰ª∂„ÄÇ
ÁõÆÂâçalpine.dockerfile‰ªçÂ≠òÂú®‰ª•‰∏ãÈóÆÈ¢ò</p>
<h3 id="docker-build"><a class="header" href="#docker-build">docker build</a></h3>
<p>dockerfileÊûÑÂª∫Êó∂‰ΩøÁî®Â¶Ç‰∏ãÂëΩ‰ª§</p>
<pre><code class="language-shell">sudo docker build -t ecli:1.0.1 .
</code></pre>
<h3 id="ÂèÇËÄÉÊñáÊ°£"><a class="header" href="#ÂèÇËÄÉÊñáÊ°£">ÂèÇËÄÉÊñáÊ°£</a></h3>
<p>bpftrace ÂÆòÊñπËØ¥ÊòéÔºàÂ¶Ç‰ΩïËÆ©bpfÁ®ãÂ∫èÂú®docker‰∏≠ËøêË°åÔºâ</p>
<p>https://github.com/iovisor/bpftrace/blob/master/INSTALL.md#kernel-headers-install</p>
<p>Â¶Ç‰ΩïÂú®mac‰∏≠ËøêË°åÂ∏¶ÊúâbpfËøêË°åÁéØÂ¢ÉÁöÑdocker</p>
<p>https://petermalmgren.com/docker-mac-bpf-perf/</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bpf-loader-a-dynamic-loading-library-for-ebpf-program"><a class="header" href="#bpf-loader-a-dynamic-loading-library-for-ebpf-program">bpf-loader: A Dynamic Loading Library for eBPF program</a></h1>
<p>A wrapper of main functions of libbpf, some helper functions for user development.</p>
<ul>
<li>provide the ability to load ebpf code to the kernel and run it with a simple JSON.</li>
<li>Use some additional data to help load and config the eBPF bytecode dynamically.</li>
<li>multiple language bindings. We have <code>Rust/C/C++</code> now and will add more in the future.</li>
</ul>
<h2 id="usage-with-cmake"><a class="header" href="#usage-with-cmake">usage with cmake</a></h2>
<p>cmake for example:</p>
<pre><code class="language-cmake">set(EUNOMIA_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../bpf-loader)
set(EUNOMIA_BINARY_DIR ${CMAKE_CURRENT_BINARY_DIR}/eunomia)
include_directories(${EUNOMIA_DIR}/include)
add_subdirectory(${EUNOMIA_DIR} ${CMAKE_CURRENT_BINARY_DIR}/eunomia)
add_dependencies(${PROJECT_NAME}_LIB eunomia_LIB)
add_dependencies(eunomia_LIB libbpf-build)
add_dependencies(${PROJECT_NAME} eunomia_LIB)
target_link_libraries(${PROJECT_NAME} PRIVATE eunomia_LIB)
</code></pre>
<p>see the example in <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/simple-runner">simple-runner</a> for more details.</p>
<h2 id="cli-tool"><a class="header" href="#cli-tool">cli tool</a></h2>
<p>a simple cli interface for bpf-loader library, which you can use it to start any eBPF program from a url in a command.</p>
<p>see <a href="bpf-loader/../ecli/index.html">ecli</a> for details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ecli"><a class="header" href="#ecli">ecli</a></h1>
<p>bpf ËøêË°åÊó∂ÈúÄË¶ÅÊúâLinuxÂÜÖÊ†∏Áõ∏ÂÖ≥ÊîØÊåÅÔºådocker ‰∏≠ÁöÑÂÜÖÊ†∏ÂÖ±‰∫´ÁöÑÂÆø‰∏ªÊú∫ÁöÑÂÜÖÊ†∏ÔºåÂõ†Ê≠§‰ΩøÁî®dockerËøêË°åbpfÁ®ãÂ∫èÊó∂ÈúÄË¶Å‰ΩøÁî®‰ª•‰∏ãÂëΩ‰ª§‰∏∫ÂÆπÂô®Ëµã‰∫àÊùÉÈôêÂíåÁõ∏ÂÖ≥ÂÜÖÊ†∏ÊîØÊåÅ„ÄÇ</p>
<p>Ê≠§Â§ÑÂèÇËÄÉhttps://github.com/iovisor/bpftrace/blob/master/INSTALL.md#kernel-headers-install</p>
<pre><code class="language-shell">$ docker run -ti -v /usr/src:/usr/src:ro \
       -v /lib/modules/:/lib/modules:ro \
       -v /sys/kernel/debug/:/sys/kernel/debug:rw \
       -v /home/admin/my:/root/my \ //ÊåÇËΩΩÊú¨Êú∫ÁõÆÂΩïÂà∞ÂÆπÂô®ÁöÑ/root/myË∑ØÂæÑ‰∏ã
       --net=host --pid=host --privileged \
       ecli:1.0.1
</code></pre>
<h2 id="dockerfile-ubuntu-1"><a class="header" href="#dockerfile-ubuntu-1">dockerfile ubuntu</a></h2>
<p>dockerfileÁöÑÂü∫Á°ÄÈïúÂÉèÊòØUbuntuÔºåÂõΩÂÜÖ‰ΩøÁî®Êó∂Âõ†‰∏∫ÊúâÂ¢ôÁöÑÂ≠òÂú®ÔºåÊâÄ‰ª•ÈúÄË¶ÅÂØπLinuxËøõË°åÊç¢Ê∫ê„ÄÇsources.listÂ¶Ç‰∏ãÔºö</p>
<pre><code class="language-shell">deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
#deb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
</code></pre>
<p>dockerfile‰∏≠ÁöÑÂÖ∑‰ΩìÂÜÖÂÆπÂ¶Ç‰∏ã</p>
<pre><code class="language-shell">FROM ubuntu:latest

ENV UBUNTU_SOURCE /etc/apt

COPY ./ /root

WORKDIR /root

ADD sources.list $UBUNTU_SOURCE/

RUN apt-get update &amp;&amp; \
    apt-get -y install gcc libelf-dev

#CMD ./ecli run /root/my/package.json
CMD [&quot;/bin/bash&quot;]

</code></pre>
<p>ubuntu.dockerfileÊûÑÂª∫Êó∂ÔºåÂêå‰∏ÄÁ∫ßÁõÆÂΩï‰∏ãÁöÑÊñá‰ª∂Â¶Ç‰∏ã</p>
<p><img src="img/image-20220905232754264.png" alt="image-20220905232754264" /></p>
<p>ecliÂèØÊâßË°åÊñá‰ª∂  sources.list DockerfileËøô‰∏â‰∏™Êñá‰ª∂Áº∫‰∏Ä‰∏çÂèØÔºåotherÊñá‰ª∂ÂèØÂøΩÁï•„ÄÇdockerÂÆπÂô®‰∏≠wgetÊó†Ê≥ïËøûÊé•Â§ñÈÉ®ÁΩëÁªúÔºåÂõ†Ê≠§ÈúÄË¶ÅÂú®dockerÊûÑÂª∫Êó∂Â∞ÜecliÊîæÂÖ•ÈïúÂÉè‰∏≠„ÄÇ‰ΩøÁî®ÈïúÂÉèÊó∂Âè™Ë¶ÅÊåÇËΩΩÁöÑÊú¨Êú∫ÁõÆÂΩï‰∏≠Êúâpackage.jsonÊñá‰ª∂Âç≥ÂèØ„ÄÇ</p>
<h2 id="docker-alpine-1"><a class="header" href="#docker-alpine-1">docker alpine</a></h2>
<pre><code class="language-shell">FROM alpine:latest

COPY ./ /root

WORKDIR /root

RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories &amp;&amp; \
    apk update &amp;&amp; \
    apk install gcc libelf gcompat

#CMD ./ecli run /root/my/package.json
</code></pre>
<p>alpine.dockerfileÊûÑÂª∫ÈïúÂÉèÊó∂ÔºåÂêå‰∏ÄÁ∫ßÁõÆÂΩï‰∏ãÂøÖÈ°ªÊúâecliÂèØÊâßË°åÊñá‰ª∂„ÄÇ
ÁõÆÂâçalpine.dockerfile‰ªçÂ≠òÂú®‰ª•‰∏ãÈóÆÈ¢ò</p>
<p><img src="img/image-20220907195237651.png" alt="image-20220907195237651" /></p>
<h3 id="docker-build-1"><a class="header" href="#docker-build-1">docker build</a></h3>
<p>dockerfileÊûÑÂª∫Êó∂‰ΩøÁî®Â¶Ç‰∏ãÂëΩ‰ª§</p>
<pre><code class="language-shell">sudo docker build -t ecli:1.0.1 .
</code></pre>
<h3 id="ÂèÇËÄÉÊñáÊ°£-1"><a class="header" href="#ÂèÇËÄÉÊñáÊ°£-1">ÂèÇËÄÉÊñáÊ°£</a></h3>
<p>bpftrace ÂÆòÊñπËØ¥ÊòéÔºàÂ¶Ç‰ΩïËÆ©bpfÁ®ãÂ∫èÂú®docker‰∏≠ËøêË°åÔºâ</p>
<p>https://github.com/iovisor/bpftrace/blob/master/INSTALL.md#kernel-headers-install</p>
<p>Â¶Ç‰ΩïÂú®mac‰∏≠ËøêË°åÂ∏¶ÊúâbpfËøêË°åÁéØÂ¢ÉÁöÑdocker</p>
<p>https://petermalmgren.com/docker-mac-bpf-perf/</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eunomia-bpf-Áî®Êà∑ÊâãÂÜå-ËÆ©-ebpf-Á®ãÂ∫èÁöÑÂºÄÂèëÂíåÈÉ®ÁΩ≤Â∞ΩÂèØËÉΩÁÆÄÂçï"><a class="header" href="#eunomia-bpf-Áî®Êà∑ÊâãÂÜå-ËÆ©-ebpf-Á®ãÂ∫èÁöÑÂºÄÂèëÂíåÈÉ®ÁΩ≤Â∞ΩÂèØËÉΩÁÆÄÂçï">eunomia-bpf Áî®Êà∑ÊâãÂÜå: ËÆ© eBPF Á®ãÂ∫èÁöÑÂºÄÂèëÂíåÈÉ®ÁΩ≤Â∞ΩÂèØËÉΩÁÆÄÂçï</a></h1>
<!-- TOC -->
<ul>
<li><a href="mannual.html#eunomia-bpf-%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C-%E8%AE%A9-ebpf-%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BC%80%E5%8F%91%E5%92%8C%E9%83%A8%E7%BD%B2%E5%B0%BD%E5%8F%AF%E8%83%BD%E7%AE%80%E5%8D%95">eunomia-bpf Áî®Êà∑ÊâãÂÜå: ËÆ© eBPF Á®ãÂ∫èÁöÑÂºÄÂèëÂíåÈÉ®ÁΩ≤Â∞ΩÂèØËÉΩÁÆÄÂçï</a>
<ul>
<li><a href="mannual.html#%E4%BB%8E-c-%E8%AF%AD%E8%A8%80-%E7%9A%84-hello-world-%E5%BC%80%E5%A7%8B">‰ªé <em>C ËØ≠Ë®Ä</em> ÁöÑ Hello World ÂºÄÂßã</a></li>
<li><a href="mannual.html#eunomia-bpf-%E7%9A%84-hello-world">eunomia-bpf ÁöÑ Hello World</a></li>
<li><a href="mannual.html#%E6%B7%BB%E5%8A%A0-map-%E8%AE%B0%E5%BD%95%E6%95%B0%E6%8D%AE">Ê∑ªÂä† map ËÆ∞ÂΩïÊï∞ÊçÆ</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-ring-buffer-%E5%BE%80%E7%94%A8%E6%88%B7%E6%80%81%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE">‰ΩøÁî® ring buffer ÂæÄÁî®Êà∑ÊÄÅÂèëÈÄÅÊï∞ÊçÆ</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-perf-event-array-%E5%BE%80%E7%94%A8%E6%88%B7%E6%80%81%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE">‰ΩøÁî® perf event array ÂæÄÁî®Êà∑ÊÄÅÂèëÈÄÅÊï∞ÊçÆ</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-github-template-%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E7%BC%96%E8%AF%91">‰ΩøÁî® github-template ÂÆûÁé∞ËøúÁ®ãÁºñËØë</a></li>
<li><a href="mannual.html#%E9%80%9A%E8%BF%87-api-%E8%BF%9B%E8%A1%8C%E7%83%AD%E6%8F%92%E6%8B%94%E5%92%8C%E5%88%86%E5%8F%91">ÈÄöËøá API ËøõË°åÁÉ≠ÊèíÊãîÂíåÂàÜÂèë</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-prometheus-%E6%88%96-opentelemetry-%E8%BF%9B%E8%A1%8C%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86">‰ΩøÁî® Prometheus Êàñ OpenTelemetry ËøõË°åÂèØËßÇÊµãÊÄßÊï∞ÊçÆÊî∂ÈõÜ</a>
<ul>
<li><a href="mannual.html#example">example</a></li>
</ul>
</li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-wasm-%E6%A8%A1%E5%9D%97%E5%88%86%E5%8F%91%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD-ebpf-%E7%A8%8B%E5%BA%8F">‰ΩøÁî® Wasm Ê®°ÂùóÂàÜÂèë„ÄÅÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫è</a></li>
<li><a href="mannual.html#%E4%BD%BF%E7%94%A8-wasm-%E5%BC%80%E5%8F%91%E5%92%8C%E6%89%93%E5%8C%85-ebpf-%E7%A8%8B%E5%BA%8F">‰ΩøÁî® Wasm ÂºÄÂèëÂíåÊâìÂåÖ eBPF Á®ãÂ∫è</a>
<ul>
<li><a href="mannual.html#bootstrap">bootstrap</a></li>
<li><a href="mannual.html#%E7%BC%96%E5%86%99%E5%86%85%E6%A0%B8%E6%80%81%E7%9A%84-ebpf-%E7%A8%8B%E5%BA%8F">ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫è</a></li>
<li><a href="mannual.html#%E6%9E%84%E5%BB%BA%E7%94%A8%E6%88%B7%E6%80%81%E7%9A%84-wasm-%E4%BB%A3%E7%A0%81%E5%B9%B6%E8%8E%B7%E5%8F%96%E5%86%85%E6%A0%B8%E6%80%81%E6%95%B0%E6%8D%AE">ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ Wasm ‰ª£Á†ÅÔºåÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ</a></li>
<li><a href="mannual.html#bootstrap-1">bootstrap</a></li>
<li><a href="mannual.html#%E7%BC%96%E5%86%99%E5%86%85%E6%A0%B8%E6%80%81%E7%9A%84-ebpf-%E7%A8%8B%E5%BA%8F-1">ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫è</a></li>
<li><a href="mannual.html#%E6%9E%84%E5%BB%BA%E7%94%A8%E6%88%B7%E6%80%81%E7%9A%84-wasm-%E4%BB%A3%E7%A0%81%E5%B9%B6%E8%8E%B7%E5%8F%96%E5%86%85%E6%A0%B8%E6%80%81%E6%95%B0%E6%8D%AE-1">ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ Wasm ‰ª£Á†ÅÔºåÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ</a></li>
<li><a href="mannual.html#%E4%BB%8E%E7%94%A8%E6%88%B7%E6%80%81%E7%A8%8B%E5%BA%8F%E4%B8%AD%E8%AE%BF%E9%97%AE%E5%92%8C%E6%9B%B4%E6%96%B0-ebpf-%E7%A8%8B%E5%BA%8F%E7%9A%84-map-%E6%95%B0%E6%8D%AE">‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞ eBPF Á®ãÂ∫èÁöÑ map Êï∞ÊçÆ</a></li>
<li><a href="mannual.html#%E4%BB%8E%E7%94%A8%E6%88%B7%E6%80%81%E7%A8%8B%E5%BA%8F%E4%B8%AD%E8%AE%BF%E9%97%AE%E5%92%8C%E6%9B%B4%E6%96%B0-ebpf-%E7%A8%8B%E5%BA%8F%E7%9A%84-map-%E6%95%B0%E6%8D%AE-1">‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞ eBPF Á®ãÂ∫èÁöÑ map Êï∞ÊçÆ</a></li>
<li><a href="mannual.html#%E6%9B%B4%E5%A4%9A%E7%9A%84%E4%BE%8B%E5%AD%90socket-filter-%E5%92%8C-lsm">Êõ¥Â§öÁöÑ‰æãÂ≠êÔºösocket filter Âíå lsm</a></li>
</ul>
</li>
<li><a href="mannual.html#%E6%BC%94%E7%A4%BA%E8%A7%86%E9%A2%91">ÊºîÁ§∫ËßÜÈ¢ë</a></li>
<li><a href="mannual.html#%E5%8E%9F%E7%90%86">ÂéüÁêÜ</a></li>
<li><a href="mannual.html#%E4%B8%BA%E6%88%91%E4%BB%AC%E7%9A%84%E9%A1%B9%E7%9B%AE%E8%B4%A1%E7%8C%AE%E4%BB%A3%E7%A0%81">‰∏∫Êàë‰ª¨ÁöÑÈ°πÁõÆË¥°ÁåÆ‰ª£Á†Å</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p>‰º†ÁªüÊù•ËØ¥Ôºå eBPF ÁöÑÂºÄÂèëÊñπÂºè‰∏ªË¶ÅÊúâ BCC„ÄÅlibbpf Á≠âÊñπÂºè„ÄÇË¶ÅÂÆåÊàê‰∏Ä‰∏™ BPF ‰∫åËøõÂà∂Á®ãÂ∫èÁöÑÂºÄÂèëÔºåÈúÄË¶ÅÊê≠Âª∫ÂºÄÂèëÁºñËØëÁéØÂ¢ÉÔºåË¶ÅÂÖ≥Ê≥®ÁõÆÊ†áÁ≥ªÁªüÁöÑÂÜÖÊ†∏ÁâàÊú¨ÊÉÖÂÜµÔºåÈúÄË¶ÅÊéåÊè°‰ªé BPF ÂÜÖÊ†∏ÊÄÅÂà∞Áî®Êà∑ÊÄÅÁ®ãÂ∫èÁöÑÁºñÂÜôÔºå‰ª•ÂèäÂ¶Ç‰ΩïÂä†ËΩΩ„ÄÅÁªëÂÆöËá≥ÂØπÂ∫îÁöÑ HOOK ÁÇπÁ≠âÂæÖ‰∫ã‰ª∂Ëß¶ÂèëÔºåÊúÄÂêéÂÜçÂØπËæìÂá∫ÁöÑÊó•ÂøóÂèäÊï∞ÊçÆËøõË°åÂ§ÑÁêÜ„ÄÇ</p>
<p>Êàë‰ª¨Â∏åÊúõÊúâËøôÊ†∑‰∏ÄÁßç eBPF ÁöÑÁºñËØëÂíåËøêË°åÂ∑•ÂÖ∑ÈìæÔºåÂ∞±ÂÉèÂÖ∂‰ªñÂæàÂ§öËØ≠Ë®Ä‰∏ÄÊ†∑Ôºö</p>
<ul>
<li>
<p>Â§ßÂ§öÊï∞Áî®Êà∑Âè™ÈúÄË¶ÅÂÖ≥Ê≥® <code>bpf.c</code> Á®ãÂ∫èÊú¨Ë∫´ÁöÑÁºñÂÜôÔºå‰∏çÈúÄË¶ÅÂÜô‰ªª‰ΩïÂÖ∂‰ªñÁöÑ‰ªÄ‰πà Python, Clang ‰πãÁ±ªÁöÑÁî®Êà∑ÊÄÅËæÖÂä©‰ª£Á†ÅÊ°ÜÊû∂Ôºõ
ËøôÊ†∑Êàë‰ª¨ÂèØ‰ª•ÂæàÊñπ‰æøÂú∞ÂàÜÂèë„ÄÅÈáçÁî® eBPF Á®ãÂ∫èÊú¨Ë∫´ÔºåËÄå‰∏çÈúÄË¶ÅÂíåÊüêÁßçÊàñÂá†ÁßçËØ≠Ë®ÄÁöÑÁîüÊÄÅÁªëÂÆöÔºõ</p>
</li>
<li>
<p>ÊúÄÂ§ßÁ®ãÂ∫¶‰∏äÂíå‰∏ªÊµÅÁöÑ libbpf Ê°ÜÊû∂ÂÆûÁé∞ÂÖºÂÆπÔºåÂéüÂÖà‰ΩøÁî® libbpf Ê°ÜÊû∂ÁºñÂÜôÁöÑ‰ª£Á†ÅÂá†‰πé‰∏çÈúÄË¶ÅÊîπÂä®Âç≥ÂèØÁßªÊ§çÔºõeunomia-bpf ÁºñÂÜôÁöÑ eBPF Á®ãÂ∫è‰πüÂèØ‰ª•‰ΩøÁî® libbpf Ê°ÜÊû∂Êù•Áõ¥Êé•ÁºñËØëËøêË°åÔºõ</p>
</li>
<li>
<p>Êú¨Âú∞Âè™ÈúÄË¶Å‰∏ãËΩΩ‰∏Ä‰∏™ÂæàÂ∞èÁöÑ‰∫åËøõÂà∂ËøêË°åÊó∂ÔºåÊ≤°Êúâ‰ªª‰ΩïÁöÑ Clang LLVM ‰πãÁ±ªÁöÑÂ§ßÂûã‰æùËµñÔºåÂèØ‰ª•ÊîØÊåÅÁÉ≠ÊèíÊãî„ÄÅÁÉ≠Êõ¥Êñ∞Ôºõ
‰πüÂèØ‰ª•‰Ωú‰∏∫ Lua ËôöÊãüÊú∫ÈÇ£Ê†∑ÁöÑÂ∞èÊ®°ÂùóÁõ¥Êé•ÁºñËØëÂµåÂÖ•ÂÖ∂‰ªñÁöÑÂ§ßÂûãËΩØ‰ª∂‰∏≠ÔºåÊèê‰æõ eBPF Á®ãÂ∫èÊú¨Ë∫´ÁöÑÊúçÂä°ÔºõËøêË°åÂíåÂêØÂä®Êó∂ËµÑÊ∫êÂç†Áî®ÁéáÈÉΩÂæà‰ΩéÔºõ</p>
</li>
<li>
<p>ËÆ© eBPF Á®ãÂ∫èÁöÑÂàÜÂèëÂíå‰ΩøÁî®ÂÉèÁΩëÈ°µÂíå Web ÊúçÂä°‰∏ÄÊ†∑Ëá™ÁÑ∂ÔºàMake eBPF as a serviceÔºâÔºö
ÊîØÊåÅÂú®ÈõÜÁæ§ÁéØÂ¢É‰∏≠Áõ¥Êé•ÈÄöËøá‰∏ÄÊ¨°ËØ∑Ê±ÇËøõË°åÂàÜÂèëÂíåÁÉ≠Êõ¥Êñ∞Ôºå‰ªÖÈúÄÊï∞ÂçÅ kB ÁöÑ payloadÔºå
&lt;100ms ÁöÑÊõ¥Êñ∞Êó∂Èó¥ÔºåÂíåÂ∞ëÈáèÁöÑ CPU ÂÜÖÂ≠òÂç†Áî®Âç≥ÂèØÂÆåÊàê eBPF Á®ãÂ∫èÁöÑÂàÜÂèë„ÄÅÈÉ®ÁΩ≤ÂíåÊõ¥Êñ∞Ôºõ
‰∏çÈúÄË¶ÅÊâßË°åÈ¢ùÂ§ñÁöÑÁºñËØëËøáÁ®ãÔºåÂ∞±ËÉΩÂæóÂà∞ CO-RE ÁöÑËøêË°åÊïàÁéáÔºõ</p>
</li>
</ul>
<h2 id="‰ªé-c-ËØ≠Ë®Ä-ÁöÑ-hello-world-ÂºÄÂßã"><a class="header" href="#‰ªé-c-ËØ≠Ë®Ä-ÁöÑ-hello-world-ÂºÄÂßã">‰ªé <em>C ËØ≠Ë®Ä</em> ÁöÑ Hello World ÂºÄÂßã</a></h2>
<p>ËøòËÆ∞ÂæóÊÇ®Á¨¨‰∏ÄÊ¨°ÂÜô <em>C ËØ≠Ë®Ä</em> ÁöÑ <strong>Hello World Á®ãÂ∫è</strong> ÂêóÔºüÈ¶ñÂÖàÔºåÊàë‰ª¨ÈúÄË¶Å‰∏Ä‰∏™ <code>.c</code> Êñá‰ª∂ÔºåÂÆÉÂåÖÂê´‰∏Ä‰∏™ <code>main</code> ÂáΩÊï∞Ôºö</p>
<pre><code class="language-c">int main(void)
{
    printf(&quot;Hello, World!\n&quot;);
    return 0;
}
</code></pre>
<p>Êàë‰ª¨Âè´ÂÆÉ <code>hello.c</code>ÔºåÊé•‰∏ãÊù•Â∞±Âè™ÈúÄË¶ÅËøôÂá†‰∏™Ê≠•È™§Â∞±Â•ΩÔºö</p>
<pre><code class="language-bash"># if you are using Ubuntu without a c compiler
sudo apt insalll build-essentials
# compile the program
gcc -o hello hello.c
# run the program
./hello
</code></pre>
<p>Âè™ÈúÄË¶ÅÂÜô‰∏Ä‰∏™ c Êñá‰ª∂ÔºåÊâßË°å‰∏§Ë°åÂëΩ‰ª§Â∞±ÂèØ‰ª•ËøêË°åÔºõÂ§ßÂ§öÊï∞ÊÉÖÂÜµ‰∏ã‰Ω†‰πüÂèØ‰ª•ÊääÁºñËØëÂ•ΩÁöÑÂèØÊâßË°åÊñá‰ª∂Áõ¥Êé•ÁßªÂä®Âà∞ÂÖ∂‰ªñÂêåÊ†∑Êû∂ÊûÑÁöÑÊú∫Âô®Êàñ‰∏çÂêåÁâàÊú¨ÁöÑÊìç‰ΩúÁ≥ªÁªü‰∏äÔºåÁÑ∂ÂêéËøêË°åÂÆÉÔºå‰πü‰ºöÂæóÂà∞‰∏ÄÊ†∑ÁöÑÁªìÊûú:</p>
<pre><code class="language-plaintext">Hello World!
</code></pre>
<h2 id="eunomia-bpf-ÁöÑ-hello-world"><a class="header" href="#eunomia-bpf-ÁöÑ-hello-world">eunomia-bpf ÁöÑ Hello World</a></h2>
<p>È¶ñÂÖàÔºåÊàë‰ª¨ÈúÄË¶Å‰∏Ä‰∏™ <code>bpf.c</code> Êñá‰ª∂ÔºåÂÆÉÂ∞±ÊòØÊ≠£Â∏∏ÁöÑ„ÄÅÂêàÊ≥ïÁöÑ C ËØ≠Ë®Ä‰ª£Á†ÅÔºåÂíå libbpf ÊâÄ‰ΩøÁî®ÁöÑÂÆåÂÖ®Áõ∏ÂêåÔºö</p>
<pre><code class="language-c">#include &lt;linux/bpf.h&gt;
#include &lt;bpf/bpf_helpers.h&gt;
#include &lt;bpf/bpf_tracing.h&gt;

typedef int pid_t;

char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

SEC(&quot;tp/syscalls/sys_enter_write&quot;)
int handle_tp(void *ctx)
{
 pid_t pid = bpf_get_current_pid_tgid() &gt;&gt; 32;
 bpf_printk(&quot;BPF triggered from PID %d.\n&quot;, pid);
 return 0;
}
</code></pre>
<p>ÂÅáËÆæÂÆÉÂè´ <code>hello.bpf.c</code>ÔºåÊñ∞Âª∫‰∏Ä‰∏™ <code>/path/to/repo</code> ÁöÑÊñá‰ª∂Â§πÂπ∂‰∏îÊääÂÆÉÊîæËøõÂéªÔºåÊé•‰∏ãÊù•ÁöÑÊ≠•È™§Ôºö</p>
<pre><code class="language-console"># ‰∏ãËΩΩÂÆâË£Ö ecli ‰∫åËøõÂà∂
wget https://aka.pw/bpf-ecli -O /usr/local/ecli &amp;&amp; chmod +x /usr/local/ecli
# ‰ΩøÁî®ÂÆπÂô®ËøõË°åÁºñËØëÔºåÁîüÊàê‰∏Ä‰∏™ package.json Êñá‰ª∂ÔºåÈáåÈù¢ÊòØÂ∑≤ÁªèÁºñËØëÂ•ΩÁöÑ‰ª£Á†ÅÂíå‰∏Ä‰∫õËæÖÂä©‰ø°ÊÅØ
docker run -it -v /path/to/repo:/src yunwei37/ebpm:latest
# ËøêË°å eBPF Á®ãÂ∫èÔºàroot shellÔºâ
sudo ecli run package.json
</code></pre>
<blockquote>
<p>‰ΩøÁî® docker ÁöÑÊó∂ÂÄôÈúÄË¶ÅÊääÂåÖÂê´ .bpf.c Êñá‰ª∂ÁöÑÁõÆÂΩïÊåÇËΩΩÂà∞ÂÆπÂô®ÁöÑ /src ÁõÆÂΩï‰∏ãÔºåÁõÆÂΩï‰∏≠Âè™Êúâ‰∏Ä‰∏™ .bpf.c Êñá‰ª∂Ôºõ</p>
</blockquote>
<p>ÂÆÉ‰ºöËøΩË∏™ÊâÄÊúâËøõË°å write Á≥ªÁªüË∞ÉÁî®ÁöÑËøõÁ®ãÁöÑ pidÔºö</p>
<pre><code class="language-console">$ sudo cat /sys/kernel/debug/tracing/trace_pipe
cat-42755   [003] d...1 48755.529860: bpf_trace_printk: BPF triggered from PID 42755.
             cat-42755   [003] d...1 48755.529874: bpf_trace_printk: BPF triggered from PID 42755.
</code></pre>
<p>Êàë‰ª¨ÁºñËØëÂ•ΩÁöÑ eBPF ‰ª£Á†ÅÂêåÊ†∑ÂèØ‰ª•ÈÄÇÈÖçÂ§öÁßçÂÜÖÊ†∏ÁâàÊú¨ÔºåÂèØ‰ª•Áõ¥Êé•Êää package.json Â§çÂà∂Âà∞Âè¶Â§ñ‰∏Ä‰∏™Êú∫Âô®‰∏äÔºåÁÑ∂Âêé‰∏çÈúÄË¶ÅÈáçÊñ∞ÁºñËØëÂ∞±ÂèØ‰ª•Áõ¥Êé•ËøêË°åÔºàCO-REÔºöCompile Once Run Every WhereÔºâÔºõ‰πüÂèØ‰ª•ÈÄöËøáÁΩëÁªú‰º†ËæìÂíåÂàÜÂèë package.jsonÔºåÈÄöÂ∏∏ÊÉÖÂÜµ‰∏ãÔºåÂéãÁº©ÂêéÁöÑÁâàÊú¨Âè™ÊúâÂá† kb Âà∞Âá†ÂçÅ kb„ÄÇ</p>
<h2 id="Ê∑ªÂä†-map-ËÆ∞ÂΩïÊï∞ÊçÆ"><a class="header" href="#Ê∑ªÂä†-map-ËÆ∞ÂΩïÊï∞ÊçÆ">Ê∑ªÂä† map ËÆ∞ÂΩïÊï∞ÊçÆ</a></h2>
<p>ÂèÇËÄÉÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/bootstrap">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/bootstrap</a></p>
<pre><code class="language-c">
struct {
 __uint(type, BPF_MAP_TYPE_HASH);
 __uint(max_entries, 8192);
 __type(key, pid_t);
 __type(value, u64);
} exec_start SEC(&quot;.maps&quot;);

</code></pre>
<p>Ê∑ªÂä† map ÁöÑÂäüËÉΩÂíå libbpf Ê≤°Êúâ‰ªª‰ΩïÂå∫Âà´ÔºåÂè™ÈúÄË¶ÅÂú® .bpf.c ‰∏≠ÂÆö‰πâÂç≥ÂèØ„ÄÇ</p>
<h2 id="‰ΩøÁî®-ring-buffer-ÂæÄÁî®Êà∑ÊÄÅÂèëÈÄÅÊï∞ÊçÆ"><a class="header" href="#‰ΩøÁî®-ring-buffer-ÂæÄÁî®Êà∑ÊÄÅÂèëÈÄÅÊï∞ÊçÆ">‰ΩøÁî® ring buffer ÂæÄÁî®Êà∑ÊÄÅÂèëÈÄÅÊï∞ÊçÆ</a></h2>
<p>ÂèÇËÄÉÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/bootstrap">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/bootstrap</a></p>
<p>Âè™ÈúÄË¶ÅÂÆö‰πâ‰∏Ä‰∏™Â§¥Êñá‰ª∂ÔºåÂåÖÂê´‰Ω†ÊÉ≥Ë¶ÅÂèëÈÄÅÁªôÁî®Êà∑ÊÄÅÁöÑÊï∞ÊçÆÊ†ºÂºèÔºå‰ª• <code>.h</code> ‰Ωú‰∏∫ÂêéÁºÄÂêçÔºö</p>
<pre><code class="language-c">/* SPDX-License-Identifier: (LGPL-2.1 OR BSD-2-Clause) */
/* Copyright (c) 2020 Facebook */
#ifndef __BOOTSTRAP_H
#define __BOOTSTRAP_H

#define TASK_COMM_LEN 16
#define MAX_FILENAME_LEN 127

struct event {
 int pid;
 int ppid;
 unsigned exit_code;
 unsigned long long duration_ns;
 char comm[TASK_COMM_LEN];
 char filename[MAX_FILENAME_LEN];
 unsigned char exit_event;
};

#endif /* __BOOTSTRAP_H */
</code></pre>
<p>Âú®‰ª£Á†Å‰∏≠ÂÆö‰πâÁéØÂΩ¢ÁºìÂÜ≤Âå∫‰πãÂêéÔºåÂ∞±ÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®ÂÆÉÔºö</p>
<pre><code class="language-c">struct {
 __uint(type, BPF_MAP_TYPE_RINGBUF);
 __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
    ......
 e-&gt;exit_event = false;
 e-&gt;pid = pid;
 e-&gt;ppid = BPF_CORE_READ(task, real_parent, tgid);
 bpf_get_current_comm(&amp;e-&gt;comm, sizeof(e-&gt;comm));
 /* successfully submit it to user-space for post-processing */
 bpf_ringbuf_submit(e, 0);
 return 0;
}
</code></pre>
<p>eunomia-bpf ‰ºöËá™Âä®ÂéªÊ∫ê‰ª£Á†Å‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑ ring buffer mapÔºåÂπ∂‰∏îÊää ring buffer ÂíåÁ±ªÂûã‰ø°ÊÅØËÆ∞ÂΩïÂú®ÁºñËØëÂ•ΩÁöÑ‰ø°ÊÅØ‰∏≠ÔºåÂπ∂Âú®ËøêË°åÁöÑÊó∂ÂÄôËá™Âä®ÂÆåÊàêÂØπ‰∫é ring buffer ÁöÑÂä†ËΩΩ„ÄÅÂØºÂá∫‰∫ã‰ª∂Á≠âÂ∑•‰Ωú„ÄÇÊâÄÊúâÁöÑ eBPF ‰ª£Á†ÅÂíåÂéüÁîüÁöÑ libbpf Á®ãÂ∫èÊ≤°Êúâ‰ªª‰ΩïÂå∫Âà´Ôºå‰ΩøÁî® eunomia-bpf ÂºÄÂèëÁöÑ‰ª£Á†Å‰πüÂèØ‰ª•Âú® libbpf ‰∏≠Êó†ÈúÄ‰ªª‰ΩïÊîπÂä®Âç≥ÂèØÁºñËØëËøêË°å„ÄÇ</p>
<h2 id="‰ΩøÁî®-perf-event-array-ÂæÄÁî®Êà∑ÊÄÅÂèëÈÄÅÊï∞ÊçÆ"><a class="header" href="#‰ΩøÁî®-perf-event-array-ÂæÄÁî®Êà∑ÊÄÅÂèëÈÄÅÊï∞ÊçÆ">‰ΩøÁî® perf event array ÂæÄÁî®Êà∑ÊÄÅÂèëÈÄÅÊï∞ÊçÆ</a></h2>
<p>‰ΩøÁî® perf event ÁöÑÂéüÁêÜÂíå‰ΩøÁî® ring buffer ÈùûÂ∏∏Á±ª‰ººÔºå‰ΩøÁî®Êàë‰ª¨ÁöÑÊ°ÜÊû∂Êó∂Ôºå‰πüÂè™ÈúÄË¶ÅÂú®Â§¥Êñá‰ª∂‰∏≠ÂÆö‰πâÂ•ΩÊâÄÈúÄÂØºÂá∫ÁöÑ‰∫ã‰ª∂ÔºåÁÑ∂ÂêéÂÆö‰πâ‰∏Ä‰∏ã perf event mapÔºö</p>
<pre><code class="language-c">struct {
 __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);
 __uint(key_size, sizeof(u32));
 __uint(value_size, sizeof(u32));
} events SEC(&quot;.maps&quot;);
</code></pre>
<p>ÂèØ‰ª•ÂèÇËÄÉÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop</a> ÂÆÉÊòØÁõ¥Êé•‰ªé libbpf-tools ‰∏≠ÁßªÊ§çÁöÑÂÆûÁé∞Ôºõ</p>
<h2 id="‰ΩøÁî®-github-template-ÂÆûÁé∞ËøúÁ®ãÁºñËØë"><a class="header" href="#‰ΩøÁî®-github-template-ÂÆûÁé∞ËøúÁ®ãÁºñËØë">‰ΩøÁî® github-template ÂÆûÁé∞ËøúÁ®ãÁºñËØë</a></h2>
<p>Áî±‰∫é eunomia-bpf ÁöÑÁºñËØëÂíåËøêË°åÈò∂ÊÆµÂÆåÂÖ®ÂàÜÁ¶ªÔºåÂèØ‰ª•ÂÆûÁé∞Âú® github ÁΩëÈ°µ‰∏äÁºñËæë‰πãÂêéÔºåÈÄöËøá github actions Êù•ÂÆåÊàêÁºñËØëÔºå‰πãÂêéÂú®Êú¨Âú∞‰∏ÄË°åÂëΩ‰ª§Âç≥ÂèØÂêØÂä®Ôºö</p>
<ol>
<li>Â∞ÜÊ≠§ <a href="https://github.com/eunomia-bpf/ebpm-template">github.com/eunomia-bpf/ebpm-template</a> Áî®‰Ωú github Ê®°ÊùøÔºöËØ∑ÂèÇÈòÖ <a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/creating-a-repository-from-a-template">creating-a-repository-from-a-template</a></li>
<li>‰øÆÊîπ bootstrap.bpf.cÔºå commit Âπ∂Á≠âÂæÖÂ∑•‰ΩúÊµÅÂÅúÊ≠¢</li>
<li>Êàë‰ª¨ÈÖçÁΩÆ‰∫Ü github pages Êù•ÂÆåÊàêÁºñËØëÂ•ΩÁöÑ json ÁöÑÂØºÂá∫Ôºå‰πãÂêéÂ∞±ÂèØ‰ª•ÂÆûÁé∞ ecli ‰ΩøÁî®ËøúÁ®ã url ‰∏ÄË°åÂëΩ‰ª§Âç≥ÂèØËøêË°åÔºö</li>
</ol>
<pre><code class="language-console">sudo ./ecli run https://eunomia-bpf.github.io/ebpm-template/package.json
</code></pre>
<h2 id="ÈÄöËøá-api-ËøõË°åÁÉ≠ÊèíÊãîÂíåÂàÜÂèë"><a class="header" href="#ÈÄöËøá-api-ËøõË°åÁÉ≠ÊèíÊãîÂíåÂàÜÂèë">ÈÄöËøá API ËøõË°åÁÉ≠ÊèíÊãîÂíåÂàÜÂèë</a></h2>
<p>Áî±‰∫é eunomia-cc ÁºñËØëÂá∫Êù•ÁöÑ ebpf Á®ãÂ∫è‰ª£Á†ÅÂíåÈôÑÂä†‰ø°ÊÅØÂæàÂ∞èÔºàÁ∫¶Êï∞ÂçÅ kbÔºâÔºå‰∏î‰∏çÈúÄË¶ÅÂêåÊó∂‰º†ÈÄí‰ªª‰ΩïÁöÑÈ¢ùÂ§ñ‰æùËµñÔºåÂõ†Ê≠§Êàë‰ª¨ÂèØ‰ª•ÈùûÂ∏∏Êñπ‰æøÂú∞ÈÄöËøáÁΩëÁªú API Áõ¥Êé•ËøõË°åÂàÜÂèëÔºå‰πüÂèØ‰ª•Âú®ÂæàÁü≠ÁöÑÊó∂Èó¥ÔºàÂ§ßÁ∫¶ 100msÔºâÂÜÖÂÆûÁé∞ÁÉ≠ÊèíÊãîÂíåÁÉ≠Êõ¥Êñ∞„ÄÇÊàë‰ª¨Êèê‰æõ‰∫Ü‰∏Ä‰∏™ÁÆÄÂçïÁöÑ client Âíå serverÔºåËØ∑ÂèÇËÄÉ;</p>
<p><a href="ecli-dockerfile-usage.html">ecli-dockerfile-usage.md</a></p>
<p>‰πãÂâç‰πüÊúâ‰∏ÄÁØáÊØîËµõÈ°πÁõÆÁöÑÂèØË°åÊÄßÈ™åËØÅÁöÑÊñáÁ´†Ôºö</p>
<p><a href="https://zhuanlan.zhihu.com/p/555362934">https://zhuanlan.zhihu.com/p/555362934</a></p>
<h2 id="‰ΩøÁî®-prometheus-Êàñ-opentelemetry-ËøõË°åÂèØËßÇÊµãÊÄßÊï∞ÊçÆÊî∂ÈõÜ"><a class="header" href="#‰ΩøÁî®-prometheus-Êàñ-opentelemetry-ËøõË°åÂèØËßÇÊµãÊÄßÊï∞ÊçÆÊî∂ÈõÜ">‰ΩøÁî® Prometheus Êàñ OpenTelemetry ËøõË°åÂèØËßÇÊµãÊÄßÊï∞ÊçÆÊî∂ÈõÜ</a></h2>
<p>Âü∫‰∫é async Rust ÁöÑ Prometheus Êàñ OpenTelemetry Ëá™ÂÆö‰πâÂèØËßÇÊµãÊÄßÊï∞ÊçÆÊî∂ÈõÜÂô®: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/eunomia-sdks/eunomia-otel">eunomia-exporter</a></p>
<p>ÂèØ‰ª•Ëá™Ë°åÁºñËØëÊàñÈÄöËøá <a href="https://github.com/eunomia-bpf/eunomia-bpf/releases/">release</a> ‰∏ãËΩΩ</p>
<h3 id="example-2"><a class="header" href="#example-2">example</a></h3>
<p>ËøôÊòØ‰∏Ä‰∏™ <code>opensnoop</code> Á®ãÂ∫èÔºåËøΩË∏™ÊâÄÊúâÁöÑÊâìÂºÄÊñá‰ª∂ÔºåÊ∫ê‰ª£Á†ÅÊù•Ëá™ <a href="https://github.com/iovisor/bcc/blob/master/libbpf-tools/opensnoop.bpf.c">bcc/libbpf-tools</a>, Êàë‰ª¨‰øÆÊîπËøáÂêéÁöÑÊ∫ê‰ª£Á†ÅÂú®ËøôÈáå: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop">examples/bpftools/opensnoop</a></p>
<p>Âú®ÁºñËØë‰πãÂêéÔºåÂèØ‰ª•ÂÆö‰πâ‰∏Ä‰∏™ËøôÊ†∑ÁöÑÈÖçÁΩÆÊñá‰ª∂:</p>
<pre><code class="language-yml">programs:
  - name: opensnoop
    metrics:
      counters:
        - name: eunomia_file_open_counter
          description: test
          labels:
            - name: pid
            - name: comm
            - name: filename
              from: fname
    compiled_ebpf_filename: examples/bpftools/opensnoop/package.json
</code></pre>
<p>ÁÑ∂ÂêéÔºåÊÇ®ÂèØ‰ª•Âú®‰ªª‰ΩïÂú∞Êñπ‰ΩøÁî® <code>config.yaml</code> ÂíåÈ¢ÑÁºñËØëÁöÑ eBPF Êï∞ÊçÆ <code>package.json</code> ÂêØÂä® Prometheus ÂØºÂá∫Âô®ÔºåÊÇ®ÂèØ‰ª•ÁúãÂà∞Â¶Ç‰∏ãÊåáÊ†áÔºö</p>
<p><img src="https://oss.openanolis.cn/sig/stxfomyiiwdwkdrqwlnn" alt="prometheus" /></p>
<p>ÊÇ®ÂèØ‰ª•Âú®‰ªª‰ΩïÂÜÖÊ†∏ÁâàÊú¨‰∏äÈÉ®ÁΩ≤ÂØºÂá∫Âô®ÔºåËÄåÊó†ÈúÄ‰æùËµñ <code>LLVM/Clang</code>„ÄÇ ÊúâÂÖ≥ËØ¶ÁªÜ‰ø°ÊÅØÔºåËØ∑ÂèÇÈòÖ <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/eunomia-sdks/eunomia-otel">eunomia-exporter</a>„ÄÇ</p>
<h2 id="‰ΩøÁî®-wasm-Ê®°ÂùóÂàÜÂèëÂä®ÊÄÅÂä†ËΩΩ-ebpf-Á®ãÂ∫è"><a class="header" href="#‰ΩøÁî®-wasm-Ê®°ÂùóÂàÜÂèëÂä®ÊÄÅÂä†ËΩΩ-ebpf-Á®ãÂ∫è">‰ΩøÁî® Wasm Ê®°ÂùóÂàÜÂèë„ÄÅÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫è</a></h2>
<p>ÂÄüÂä© Wasm-bpf ÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂ÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî® Wasm Â∞Ü eBPF Á®ãÂ∫èÁºñÂÜô‰∏∫Ë∑®Âπ≥Âè∞ÁöÑÊ®°ÂùóÔºåÂêåÊó∂‰ΩøÁî® C/C++ Êàñ Rust Êù•ÁºñÂÜô Wasm Á®ãÂ∫è„ÄÇÈÄöËøáÂú® WebAssembly ‰∏≠‰ΩøÁî® eBPF Á®ãÂ∫èÔºåÊàë‰ª¨‰∏ç‰ªÖËÉΩËÆ© Wasm Â∫îÁî®‰∫´ÂèóÂà∞ eBPF ÁöÑÈ´òÊÄßËÉΩÂíåÂØπÁ≥ªÁªüÊé•Âè£ÁöÑËÆøÈóÆËÉΩÂäõÔºåËøòÂèØ‰ª•ËÆ© eBPF Á®ãÂ∫è‰ΩøÁî®Âà∞ Wasm ÁöÑÊ≤ôÁÆ±„ÄÅÁÅµÊ¥ªÊÄß„ÄÅË∑®Âπ≥Âè∞ÊÄß„ÄÅÂíåÂä®ÊÄÅÂä†ËΩΩÔºåÂπ∂‰∏î‰ΩøÁî® Wasm ÁöÑ OCI ÈïúÂÉèÊù•Êñπ‰æø„ÄÅÂø´Êç∑Âú∞ÂàÜÂèëÂíåÁÆ°ÁêÜ eBPF Á®ãÂ∫è„ÄÇÁªìÂêàËøô‰∏§ÁßçÊäÄÊúØÔºåÊàë‰ª¨Â∞Ü‰ºöÁªô eBPF Âíå Wasm ÁîüÊÄÅÊù•‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑÂºÄÂèë‰ΩìÈ™åÔºÅ</p>
<p>Wasm-bpf ÊòØ‰∏Ä‰∏™Êñ∞ÁöÑÂºÄÊ∫êÈ°πÁõÆÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a>„ÄÇÂÆÉÂÆö‰πâ‰∫Ü‰∏ÄÂ•ó eBPF Áõ∏ÂÖ≥Á≥ªÁªüÊé•Âè£ÁöÑÊäΩË±°ÔºåÂπ∂Êèê‰æõ‰∫Ü‰∏ÄÂ•óÂØπÂ∫îÁöÑÂºÄÂèëÂ∑•ÂÖ∑Èìæ„ÄÅÂ∫ì‰ª•ÂèäÈÄöÁî®ÁöÑ Wasm + eBPF ËøêË°åÊó∂ÂÆû‰æã„ÄÇÂÆÉÂèØ‰ª•Êèê‰æõÂíå libbpf-bootstrap Áõ∏‰ººÁöÑÂºÄÂèë‰ΩìÈ™åÔºåËá™Âä®ÁîüÊàêÂØπÂ∫îÁöÑ skeleton Â§¥Êñá‰ª∂Ôºå‰ª•ÂèäÁî®‰∫éÂú® Wasm Âíå eBPF ‰πãÈó¥Êó†Â∫èÂàóÂåñÈÄö‰ø°ÁöÑÊï∞ÊçÆÁªìÊûÑÂÆö‰πâ„ÄÇ‰Ω†ÂèØ‰ª•ÈùûÂ∏∏ÂÆπÊòìÂú∞‰ΩøÁî®‰ªª‰ΩïËØ≠Ë®ÄÔºåÂú®‰ªª‰ΩïÂπ≥Âè∞‰∏äÂª∫Á´ã‰Ω†Ëá™Â∑±ÁöÑ Wasm-eBPF ËøêË°åÊó∂Ôºå‰ΩøÁî®Áõ∏ÂêåÁöÑÂ∑•ÂÖ∑ÈìæÊù•ÊûÑÂª∫Â∫îÁî®„ÄÇÊõ¥ËØ¶ÁªÜÁöÑ‰ªãÁªçÔºåËØ∑ÂèÇËÄÉÊàë‰ª¨ÁöÑ‰∏ä‰∏ÄÁØáÂçöÂÆ¢Ôºö<a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">Wasm-bpf: Êû∂Ëµ∑ Webassembly Âíå eBPF ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢Å</a>„ÄÇ</p>
<p>Âü∫‰∫é WasmÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî®Â§öÁßçËØ≠Ë®ÄÊûÑÂª∫ eBPF Â∫îÁî®ÔºåÂπ∂‰ª•Áªü‰∏Ä„ÄÅËΩªÈáèÁ∫ßÁöÑÊñπÂºèÁÆ°ÁêÜÂíåÂèëÂ∏É„ÄÇ‰ª•Êàë‰ª¨ÊûÑÂª∫ÁöÑÁ§∫‰æãÂ∫îÁî® bootstrap.wasm ‰∏∫‰æãÔºåÂ§ßÂ∞è‰ªÖ‰∏∫ ~90KÔºåÂæàÂÆπÊòìÈÄöËøáÁΩëÁªúÂàÜÂèëÔºåÂπ∂ÂèØ‰ª•Âú®‰∏çÂà∞ 100ms ÁöÑÊó∂Èó¥ÂÜÖÂú®Âè¶‰∏ÄÂè∞Êú∫Âô®‰∏äÂä®ÊÄÅÈÉ®ÁΩ≤„ÄÅÂä†ËΩΩÂíåËøêË°åÔºåÂπ∂‰∏î‰øùÁïôËΩªÈáèÁ∫ßÂÆπÂô®ÁöÑÈöîÁ¶ªÁâπÊÄß„ÄÇËøêË°åÊó∂‰∏çÈúÄË¶ÅÂÜÖÊ†∏Â§¥Êñá‰ª∂„ÄÅLLVM„ÄÅclang Á≠â‰æùËµñÔºå‰πü‰∏çÈúÄË¶ÅÂÅö‰ªª‰ΩïÊ∂àËÄóËµÑÊ∫êÁöÑÈáçÈáèÁ∫ßÁöÑÁºñËØëÂ∑•‰Ωú„ÄÇ</p>
<p>Êú¨ÊñáÂ∞Ü‰ª• C/C++ ËØ≠Ë®Ä‰∏∫‰æãÔºåËÆ®ËÆ∫ C/C++ ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm Ê®°Âùó„ÄÇ‰ΩøÁî® Rust ËØ≠Ë®ÄÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm Ê®°ÂùóÁöÑÂÖ∑‰ΩìÁ§∫‰æãÔºåÂ∞ÜÂú®‰∏ã‰∏ÄÁØáÊñáÁ´†‰∏≠ÊèèËø∞„ÄÇ</p>
<p>Êàë‰ª¨Âú®‰ªìÂ∫ì‰∏≠Êèê‰æõ‰∫ÜÂá†‰∏™Á§∫‰æãÁ®ãÂ∫èÔºåÂàÜÂà´ÂØπÂ∫î‰∫éÂèØËßÇÊµã„ÄÅÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÂ§öÁßçÂú∫ÊôØ„ÄÇ</p>
<h2 id="‰ΩøÁî®-wasm-ÂºÄÂèëÂíåÊâìÂåÖ-ebpf-Á®ãÂ∫è"><a class="header" href="#‰ΩøÁî®-wasm-ÂºÄÂèëÂíåÊâìÂåÖ-ebpf-Á®ãÂ∫è">‰ΩøÁî® Wasm ÂºÄÂèëÂíåÊâìÂåÖ eBPF Á®ãÂ∫è</a></h2>
<p>libbpf ÊòØ‰∏Ä‰∏™ C/C++ ÁöÑ eBPF Áî®Êà∑ÊÄÅÂä†ËΩΩÂíåÊéßÂà∂Â∫ìÔºåÈöèÁùÄÂÜÖÊ†∏‰∏ÄËµ∑ÂàÜÂèëÔºåÂá†‰πéÂ∑≤ÁªèÊàê‰∏∫ eBPF Áî®Êà∑ÊÄÅ‰∫ãÂÆû‰∏äÁöÑ API Ê†áÂáÜÔºålibbpf ‰πüÊîØÊåÅ CO-RE(Compile Once ‚Äì Run Everywhere) ÁöÑËß£ÂÜ≥ÊñπÊ°àÔºåÂç≥È¢ÑÁºñËØëÁöÑ bpf ‰ª£Á†ÅÂèØ‰ª•Âú®‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨‰∏äÊ≠£Â∏∏Â∑•‰ΩúÔºåËÄåÊó†ÈúÄ‰∏∫ÊØè‰∏™ÁâπÂÆöÂÜÖÊ†∏ÈáçÊñ∞ÁºñËØë„ÄÇÊàë‰ª¨Â∏åÊúõÂ∞ΩÂèØËÉΩÁöÑ‰øùÊåÅ‰∏é libbpf ÁöÑÁî®Êà∑ÊÄÅ API ‰ª•ÂèäË°å‰∏∫‰∏ÄËá¥ÔºåÂ∞ΩÂèØËÉΩÂáèÂ∞ëÂ∫îÁî®ËøÅÁßªÂà∞ Wasm ÔºàÂ¶ÇÊûúÈúÄË¶ÅÁöÑËØùÔºâÁöÑÊàêÊú¨„ÄÇ</p>
<p>libbpf-bootstrap ‰∏∫ÁîüÊàêÂü∫‰∫é libbpf ÁöÑ bpf Á®ãÂ∫èÊèê‰æõ‰∫ÜÊ®°Êùø,ÂºÄÂèëËÄÖÂèØ‰ª•ÂæàÊñπ‰æøÁöÑ‰ΩøÁî®ËØ•Ê®°ÊùøÁîüÊàêËá™ÂÆö‰πâÁöÑ bpf Á®ãÂ∫è„ÄÇ‰∏ÄËà¨ËØ¥Êù•ÔºåÂú®Èùû Wasm Ê≤ôÁÆ±ÁöÑÁî®Êà∑ÊÄÅÁ©∫Èó¥Ôºå‰ΩøÁî® libbpf-bootstrap ËÑöÊâãÊû∂ÔºåÂèØ‰ª•Âø´ÈÄü„ÄÅËΩªÊùæÂú∞‰ΩøÁî® C/C++ÊûÑÂª∫ BPF Â∫îÁî®Á®ãÂ∫è„ÄÇ</p>
<p>ÁºñËØë„ÄÅÊûÑÂª∫ÂíåËøêË°å eBPF Á®ãÂ∫èÔºàÊó†ËÆ∫ÊòØÈááÁî®‰ªÄ‰πàËØ≠Ë®ÄÔºâÔºåÈÄöÂ∏∏ÂåÖÂê´‰ª•‰∏ãÂá†‰∏™Ê≠•È™§Ôºö</p>
<ul>
<li>ÁºñÂÜôÂÜÖÊ†∏ÊÄÅ eBPF Á®ãÂ∫èÁöÑ‰ª£Á†ÅÔºå‰∏ÄËà¨‰ΩøÁî® C/C++ Êàñ Rust ËØ≠Ë®Ä</li>
<li>‰ΩøÁî® clang ÁºñËØëÂô®ÊàñËÄÖÁõ∏ÂÖ≥Â∑•ÂÖ∑ÈìæÁºñËØë eBPF Á®ãÂ∫èÔºàË¶ÅÂÆûÁé∞Ë∑®ÂÜÖÊ†∏ÁâàÊú¨ÁßªÊ§çÁöÑËØùÔºåÈúÄË¶ÅÂåÖÂê´ BTF ‰ø°ÊÅØÔºâ„ÄÇ</li>
<li>Âú®Áî®Êà∑ÊÄÅÁöÑÂºÄÂèëÁ®ãÂ∫è‰∏≠ÔºåÁºñÂÜôÂØπÂ∫îÁöÑÂä†ËΩΩ„ÄÅÊéßÂà∂„ÄÅÊåÇËΩΩ„ÄÅÊï∞ÊçÆÂ§ÑÁêÜÈÄªËæëÔºõ</li>
<li>Âú®ÂÆûÈôÖËøêË°åÁöÑÈò∂ÊÆµÔºå‰ªéÁî®Êà∑ÊÄÅÂ∞Ü eBPF Á®ãÂ∫èÂä†ËΩΩËøõÂÖ•ÂÜÖÊ†∏ÔºåÂπ∂ÂÆûÈôÖÊâßË°å„ÄÇ</li>
</ul>
<h3 id="bootstrap"><a class="header" href="#bootstrap">bootstrap</a></h3>
<p><code>bootstrap</code>ÊòØ‰∏Ä‰∏™ÁÆÄÂçïÔºà‰ΩÜÂÆûÁî®ÔºâÁöÑBPFÂ∫îÁî®Á®ãÂ∫èÁöÑ‰æãÂ≠ê„ÄÇÂÆÉË∑üË∏™ËøõÁ®ãÁöÑÂêØÂä®ÔºàÂáÜÁ°ÆÂú∞ËØ¥ÔºåÊòØ <code>exec()</code> Á≥ªÂàóÁöÑÁ≥ªÁªüË∞ÉÁî®ÔºâÂíåÈÄÄÂá∫ÔºåÂπ∂ÂèëÈÄÅÂÖ≥‰∫éÊñá‰ª∂Âêç„ÄÅPID Âíå Áà∂ PID ÁöÑÊï∞ÊçÆÔºå‰ª•ÂèäÈÄÄÂá∫Áä∂ÊÄÅÂíåËøõÁ®ãÁöÑÊåÅÁª≠Êó∂Èó¥„ÄÇÁî®<code>-d &lt;min-duration-ms&gt;</code> ‰Ω†ÂèØ‰ª•ÊåáÂÆöË¶ÅËÆ∞ÂΩïÁöÑËøõÁ®ãÁöÑÊúÄÂ∞èÊåÅÁª≠Êó∂Èó¥„ÄÇ</p>
<p><code>bootstrap</code> ÊòØÂú® <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a> ‰∏≠ÔºåÊ†πÊçÆ BCC ËΩØ‰ª∂ÂåÖ‰∏≠ÁöÑ<a href="https://github.com/iovisor/bcc/tree/master/libbpf-tools">libbpf-tools</a>ÁöÑÁ±ª‰ººÊÄùÊÉ≥ÂàõÂª∫ÁöÑÔºå‰ΩÜÂÆÉË¢´ËÆæËÆ°ÊàêÊõ¥Áã¨Á´ãÁöÑÔºåÂπ∂‰∏îÊúâÊõ¥ÁÆÄÂçïÁöÑ Makefile ‰ª•ÁÆÄÂåñÁî®Êà∑ÁöÑÁâπÊÆäÈúÄÊ±Ç„ÄÇÂÆÉÊºîÁ§∫‰∫ÜÂÖ∏ÂûãÁöÑBPFÁâπÊÄßÔºåÂåÖÂê´‰ΩøÁî®Â§ö‰∏™ BPF Á®ãÂ∫èÊÆµËøõË°åÂêà‰ΩúÔºå‰ΩøÁî® BPF map Êù•Áª¥Êä§Áä∂ÊÄÅÔºå‰ΩøÁî® BPF ring buffer Êù•ÂèëÈÄÅÊï∞ÊçÆÂà∞Áî®Êà∑Á©∫Èó¥Ôºå‰ª•Âèä‰ΩøÁî®ÂÖ®Â±ÄÂèòÈáèÊù•ÂèÇÊï∞ÂåñÂ∫îÁî®Á®ãÂ∫èË°å‰∏∫„ÄÇ</p>
<p>‰ª•‰∏ãÊòØÊàë‰ª¨‰ΩøÁî® Wasm ÁºñËØëËøêË°å <code>bootstrap</code> ÁöÑ‰∏Ä‰∏™ËæìÂá∫Á§∫‰æãÔºö</p>
<pre><code class="language-console">$ sudo sudo ./wasm-bpf bootstrap.wasm -h
BPF bootstrap demo application.

It traces process start and exits and shows associated
information (filename, process duration, PID and PPID, etc).

USAGE: ./bootstrap [-d &lt;min-duration-ms&gt;] -v
$ sudo ./wasm-bpf bootstrap.wasm
TIME     EVENT COMM             PID     PPID    FILENAME/EXIT CODE
18:57:58 EXEC  sed              74911   74910   /usr/bin/sed
18:57:58 EXIT  sed              74911   74910   [0] (2ms)
18:57:58 EXIT  cat              74912   74910   [0] (0ms)
18:57:58 EXEC  cat              74913   74910   /usr/bin/cat
18:57:59 EXIT  cat              74913   74910   [0] (0ms)
18:57:59 EXEC  cat              74914   74910   /usr/bin/cat
18:57:59 EXIT  cat              74914   74910   [0] (0ms)
18:57:59 EXEC  cat              74915   74910   /usr/bin/cat
18:57:59 EXIT  cat              74915   74910   [0] (1ms)
18:57:59 EXEC  sleep            74916   74910   /usr/bin/sleep
</code></pre>
<p>Êàë‰ª¨ÂèØ‰ª•Êèê‰æõ‰∏é libbpf-bootstrap ÂºÄÂèëÁõ∏‰ººÁöÑÂºÄÂèë‰ΩìÈ™å„ÄÇÂè™ÈúÄËøêË°å make Âç≥ÂèØÊûÑÂª∫ wasm ‰∫åËøõÂà∂Êñá‰ª∂Ôºö</p>
<pre><code class="language-console">git clone https://github.com/eunomia-bpf/wasm-bpf --recursive
cd examples/bootstrap
make
</code></pre>
<h3 id="ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ-ebpf-Á®ãÂ∫è"><a class="header" href="#ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ-ebpf-Á®ãÂ∫è">ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫è</a></h3>
<p>Ë¶ÅÊûÑÂª∫‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ eBPF Á®ãÂ∫èÔºåÈ¶ñÂÖàË¶ÅÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ bpf ‰ª£Á†Å„ÄÇÈÄöÂ∏∏‰ΩøÁî® C ËØ≠Ë®ÄÁºñÂÜôÔºåÂπ∂‰ΩøÁî® clang ÂÆåÊàêÁºñËØëÔºö</p>
<pre><code class="language-c">char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 8192);
    __type(key, pid_t);
    __type(value, u64);
} exec_start SEC(&quot;.maps&quot;);

struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

const volatile unsigned long long min_duration_ns = 0;
const volatile int *name_ptr;

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
    struct task_struct *task;
    unsigned fname_off;
    struct event *e;
    pid_t pid;
    u64 ts;
....
</code></pre>
<p>ÂèóÁØáÂπÖÊâÄÈôêÔºåËøôÈáåÊ≤°ÊúâË¥¥Âá∫ÂÆåÊï¥ÁöÑ‰ª£Á†Å„ÄÇÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÁöÑÁºñÂÜôÊñπÂºèÂíåÂÖ∂‰ªñÂü∫‰∫é libbpf ÁöÑÁ®ãÂ∫èÂÆåÂÖ®Áõ∏ÂêåÔºå‰∏ÄËà¨Êù•ËØ¥‰ºöÂåÖÂê´‰∏Ä‰∫õÂÖ®Â±ÄÂèòÈáèÔºåÈÄöËøá <code>SEC</code> Â£∞ÊòéÊåÇËΩΩÁÇπÁöÑ eBPF ÂáΩÊï∞Ôºå‰ª•ÂèäÁî®‰∫é‰øùÂ≠òÁä∂ÊÄÅÔºåÊàñËÄÖÂú®Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥Áõ∏‰∫íÈÄö‰ø°ÁöÑ map ÂØπË±°ÔºàÊàë‰ª¨ËøòÂú®ËøõË°åÂè¶Â§ñ‰∏ÄÈ°πÂ∑•‰ΩúÔºö<a href="https://github.com/iovisor/bcc/issues/4404">bcc to libbpf converter</a>ÔºåÁ≠âÂÆÉÂÆåÊàêÂêéÂ∞±ÂèØ‰ª•‰ª•ËøôÁßçÊñπÂºèÁºñËØë BCC È£éÊ†ºÁöÑ eBPF ÂÜÖÊ†∏ÊÄÅÁ®ãÂ∫èÔºâ„ÄÇÂú®ÁºñÂÜôÂÆå eBPF Á®ãÂ∫è‰πãÂêéÔºåËøêË°å <code>make</code> ‰ºöÂú® <code>Makefile</code> Ë∞ÉÁî® clang Âíå llvm-strip ÊûÑÂª∫BPFÁ®ãÂ∫èÔºå‰ª•Ââ•Á¶ªË∞ÉËØï‰ø°ÊÅØÔºö</p>
<pre><code class="language-shell">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I../../third_party/vmlinux/x86/ -idirafter /usr/local/include -idirafter /usr/include -c bootstrap.bpf.c -o bootstrap.bpf.o
llvm-strip -g bootstrap.bpf.o # strip useless DWARF info
</code></pre>
<p>‰πãÂêéÔºåÊàë‰ª¨‰ºöÊèê‰æõ‰∏Ä‰∏™‰∏∫‰∫Ü Wasm ‰∏ìÈó®ÂÆûÁé∞ÁöÑ bpftoolÔºåÁî®‰∫é‰ªé BPF Á®ãÂ∫èÁîüÊàêCÂ§¥Êñá‰ª∂Ôºö</p>
<pre><code class="language-shell">../../third_party/bpftool/src/bpftool gen skeleton -j bootstrap.bpf.o &gt; bootstrap.skel.h
</code></pre>
<p>Áî±‰∫é eBPF Êú¨Ë∫´ÁöÑÊâÄÊúâ C ÂÜÖÂ≠òÂ∏ÉÂ±ÄÊòØÂíåÂΩìÂâçÊâÄÂú®Êú∫Âô®ÁöÑÊåá‰ª§ÈõÜ‰∏ÄÊ†∑ÁöÑÔºå‰ΩÜÊòØ wasm ÊòØÊúâ‰∏ÄÂ•óÁ°ÆÂÆöÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÔºàÊØîÂ¶ÇÂΩìÂâçÊâÄÂú®Êú∫Âô®ÊòØ 64 ‰ΩçÁöÑÔºåWasm ËôöÊãüÊú∫ÈáåÈù¢ÊòØ 32 ‰ΩçÁöÑÔºåC struct layout „ÄÅÊåáÈíàÂÆΩÂ∫¶„ÄÅÂ§ßÂ∞èÁ´ØÁ≠âÁ≠âÈÉΩÂèØËÉΩ‰∏ç‰∏ÄÊ†∑ÔºâÔºå‰∏∫‰∫ÜÁ°Æ‰øù eBPF Á®ãÂ∫èËÉΩÊ≠£Á°ÆÂíå Wasm ‰πãÈó¥ËøõË°åÁõ∏‰∫íÈÄö‰ø°ÔºåÊàë‰ª¨ÈúÄË¶ÅÂÆöÂà∂‰∏Ä‰∏™‰∏ìÈó®ÁöÑ bpftool Á≠âÂ∑•ÂÖ∑ÔºåÂÆûÁé∞Ê≠£Á°ÆÁîüÊàêÂèØ‰ª•Âú® Wasm ‰∏≠Â∑•‰ΩúÁöÑÁî®Êà∑ÊÄÅÂºÄÂèëÊ°ÜÊû∂„ÄÇ</p>
<p>skel ÂåÖÂê´‰∏Ä‰∏™ BPF Á®ãÂ∫èÁöÑskeletonÔºåÁî®‰∫éÊìç‰Ωú BPF ÂØπË±°ÔºåÂπ∂ÊéßÂà∂ BPF Á®ãÂ∫èÁöÑÁîüÂëΩÂë®ÊúüÔºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-c">    struct bootstrap_bpf {
        struct bpf_object_skeleton *skeleton;
        struct bpf_object *obj;
        struct {
            struct bpf_map *exec_start;
            struct bpf_map *rb;
            struct bpf_map *rodata;
        } maps;
        struct {
            struct bpf_program *handle_exec;
            struct bpf_program *handle_exit;
        } progs;
        struct bootstrap_bpf__rodata {
            unsigned long long min_duration_ns;
        } *rodata;
        struct bootstrap_bpf__bss {
            uint64_t /* pointer */ name_ptr;
        } *bss;
    };
</code></pre>
<p>Êàë‰ª¨‰ºöÂ∞ÜÊâÄÊúâÊåáÈíàÈÉΩÂ∞ÜÊ†πÊçÆ eBPF Á®ãÂ∫èÁõÆÊ†áÊâÄÂú®ÁöÑÊåá‰ª§ÈõÜÁöÑÊåáÈíàÂ§ßÂ∞èËΩ¨Êç¢‰∏∫Êï¥Êï∞Ôºå‰æãÂ¶ÇÔºå<code>name_ptr</code>„ÄÇÊ≠§Â§ñÔºåÂ°´ÂÖÖÂ≠óËäÇÂ∞ÜÊòéÁ°ÆÊ∑ªÂä†Âà∞ÁªìÊûÑ‰Ωì‰∏≠‰ª•Á°Æ‰øùÁªìÊûÑ‰ΩìÂ∏ÉÂ±Ä‰∏éÁõÆÊ†áÁ´ØÁõ∏ÂêåÔºå‰æãÂ¶Ç‰ΩøÁî® <code>char __pad0[4];</code>„ÄÇÊàë‰ª¨Ëøò‰ºö‰ΩøÁî® <code>static_assert</code> Êù•Á°Æ‰øùÁªìÊûÑ‰ΩìÁöÑÂÜÖÂ≠òÈïøÂ∫¶ÂíåÂéüÂÖà BTF ‰ø°ÊÅØ‰∏≠ÁöÑÁ±ªÂûãÈïøÂ∫¶Áõ∏Âêå„ÄÇ</p>
<h3 id="ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ-wasm-‰ª£Á†ÅÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ"><a class="header" href="#ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ-wasm-‰ª£Á†ÅÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ">ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ Wasm ‰ª£Á†ÅÔºåÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ</a></h3>
<p>libbpf ÊòØ‰∏Ä‰∏™ C/C++ ÁöÑ eBPF Áî®Êà∑ÊÄÅÂä†ËΩΩÂíåÊéßÂà∂Â∫ìÔºåÈöèÁùÄÂÜÖÊ†∏‰∏ÄËµ∑ÂàÜÂèëÔºåÂá†‰πéÂ∑≤ÁªèÊàê‰∏∫ eBPF Áî®Êà∑ÊÄÅ‰∫ãÂÆû‰∏äÁöÑ API Ê†áÂáÜÔºålibbpf ‰πüÊîØÊåÅ CO-RE(Compile Once ‚Äì Run Everywhere) ÁöÑËß£ÂÜ≥ÊñπÊ°àÔºåÂç≥È¢ÑÁºñËØëÁöÑ bpf ‰ª£Á†ÅÂèØ‰ª•Âú®‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨‰∏äÊ≠£Â∏∏Â∑•‰ΩúÔºåËÄåÊó†ÈúÄ‰∏∫ÊØè‰∏™ÁâπÂÆöÂÜÖÊ†∏ÈáçÊñ∞ÁºñËØë„ÄÇÊàë‰ª¨Â∏åÊúõÂ∞ΩÂèØËÉΩÁöÑ‰øùÊåÅ‰∏é libbpf ÁöÑÁî®Êà∑ÊÄÅ API ‰ª•ÂèäË°å‰∏∫‰∏ÄËá¥ÔºåÂ∞ΩÂèØËÉΩÂáèÂ∞ëÂ∫îÁî®ËøÅÁßªÂà∞ Wasm ÔºàÂ¶ÇÊûúÈúÄË¶ÅÁöÑËØùÔºâÁöÑÊàêÊú¨„ÄÇ</p>
<p>libbpf-bootstrap ‰∏∫ÁîüÊàêÂü∫‰∫é libbpf ÁöÑ bpf Á®ãÂ∫èÊèê‰æõ‰∫ÜÊ®°Êùø,ÂºÄÂèëËÄÖÂèØ‰ª•ÂæàÊñπ‰æøÁöÑ‰ΩøÁî®ËØ•Ê®°ÊùøÁîüÊàêËá™ÂÆö‰πâÁöÑ bpf Á®ãÂ∫è„ÄÇ‰∏ÄËà¨ËØ¥Êù•ÔºåÂú®Èùû Wasm Ê≤ôÁÆ±ÁöÑÁî®Êà∑ÊÄÅÁ©∫Èó¥Ôºå‰ΩøÁî® libbpf-bootstrap ËÑöÊâãÊû∂ÔºåÂèØ‰ª•Âø´ÈÄü„ÄÅËΩªÊùæÂú∞‰ΩøÁî® C/C++ÊûÑÂª∫ BPF Â∫îÁî®Á®ãÂ∫è„ÄÇ</p>
<p>ÁºñËØë„ÄÅÊûÑÂª∫ÂíåËøêË°å eBPF Á®ãÂ∫èÔºàÊó†ËÆ∫ÊòØÈááÁî®‰ªÄ‰πàËØ≠Ë®ÄÔºâÔºåÈÄöÂ∏∏ÂåÖÂê´‰ª•‰∏ãÂá†‰∏™Ê≠•È™§Ôºö</p>
<ul>
<li>ÁºñÂÜôÂÜÖÊ†∏ÊÄÅ eBPF Á®ãÂ∫èÁöÑ‰ª£Á†ÅÔºå‰∏ÄËà¨‰ΩøÁî® C/C++ Êàñ Rust ËØ≠Ë®Ä</li>
<li>‰ΩøÁî® clang ÁºñËØëÂô®ÊàñËÄÖÁõ∏ÂÖ≥Â∑•ÂÖ∑ÈìæÁºñËØë eBPF Á®ãÂ∫èÔºàË¶ÅÂÆûÁé∞Ë∑®ÂÜÖÊ†∏ÁâàÊú¨ÁßªÊ§çÁöÑËØùÔºåÈúÄË¶ÅÂåÖÂê´ BTF ‰ø°ÊÅØÔºâ„ÄÇ</li>
<li>Âú®Áî®Êà∑ÊÄÅÁöÑÂºÄÂèëÁ®ãÂ∫è‰∏≠ÔºåÁºñÂÜôÂØπÂ∫îÁöÑÂä†ËΩΩ„ÄÅÊéßÂà∂„ÄÅÊåÇËΩΩ„ÄÅÊï∞ÊçÆÂ§ÑÁêÜÈÄªËæëÔºõ</li>
<li>Âú®ÂÆûÈôÖËøêË°åÁöÑÈò∂ÊÆµÔºå‰ªéÁî®Êà∑ÊÄÅÂ∞Ü eBPF Á®ãÂ∫èÂä†ËΩΩËøõÂÖ•ÂÜÖÊ†∏ÔºåÂπ∂ÂÆûÈôÖÊâßË°å„ÄÇ</li>
</ul>
<h3 id="bootstrap-1"><a class="header" href="#bootstrap-1">bootstrap</a></h3>
<p><code>bootstrap</code>ÊòØ‰∏Ä‰∏™ÁÆÄÂçïÔºà‰ΩÜÂÆûÁî®ÔºâÁöÑBPFÂ∫îÁî®Á®ãÂ∫èÁöÑ‰æãÂ≠ê„ÄÇÂÆÉË∑üË∏™ËøõÁ®ãÁöÑÂêØÂä®ÔºàÂáÜÁ°ÆÂú∞ËØ¥ÔºåÊòØ <code>exec()</code> Á≥ªÂàóÁöÑÁ≥ªÁªüË∞ÉÁî®ÔºâÂíåÈÄÄÂá∫ÔºåÂπ∂ÂèëÈÄÅÂÖ≥‰∫éÊñá‰ª∂Âêç„ÄÅPID Âíå Áà∂ PID ÁöÑÊï∞ÊçÆÔºå‰ª•ÂèäÈÄÄÂá∫Áä∂ÊÄÅÂíåËøõÁ®ãÁöÑÊåÅÁª≠Êó∂Èó¥„ÄÇÁî®<code>-d &lt;min-duration-ms&gt;</code> ‰Ω†ÂèØ‰ª•ÊåáÂÆöË¶ÅËÆ∞ÂΩïÁöÑËøõÁ®ãÁöÑÊúÄÂ∞èÊåÅÁª≠Êó∂Èó¥„ÄÇ</p>
<p><code>bootstrap</code> ÊòØÂú® <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a> ‰∏≠ÔºåÊ†πÊçÆ BCC ËΩØ‰ª∂ÂåÖ‰∏≠ÁöÑ<a href="https://github.com/iovisor/bcc/tree/master/libbpf-tools">libbpf-tools</a>ÁöÑÁ±ª‰ººÊÄùÊÉ≥ÂàõÂª∫ÁöÑÔºå‰ΩÜÂÆÉË¢´ËÆæËÆ°ÊàêÊõ¥Áã¨Á´ãÁöÑÔºåÂπ∂‰∏îÊúâÊõ¥ÁÆÄÂçïÁöÑ Makefile ‰ª•ÁÆÄÂåñÁî®Êà∑ÁöÑÁâπÊÆäÈúÄÊ±Ç„ÄÇÂÆÉÊºîÁ§∫‰∫ÜÂÖ∏ÂûãÁöÑBPFÁâπÊÄßÔºåÂåÖÂê´‰ΩøÁî®Â§ö‰∏™ BPF Á®ãÂ∫èÊÆµËøõË°åÂêà‰ΩúÔºå‰ΩøÁî® BPF map Êù•Áª¥Êä§Áä∂ÊÄÅÔºå‰ΩøÁî® BPF ring buffer Êù•ÂèëÈÄÅÊï∞ÊçÆÂà∞Áî®Êà∑Á©∫Èó¥Ôºå‰ª•Âèä‰ΩøÁî®ÂÖ®Â±ÄÂèòÈáèÊù•ÂèÇÊï∞ÂåñÂ∫îÁî®Á®ãÂ∫èË°å‰∏∫„ÄÇ</p>
<p>‰ª•‰∏ãÊòØÊàë‰ª¨‰ΩøÁî® Wasm ÁºñËØëËøêË°å <code>bootstrap</code> ÁöÑ‰∏Ä‰∏™ËæìÂá∫Á§∫‰æãÔºö</p>
<pre><code class="language-console">$ sudo sudo ./wasm-bpf bootstrap.wasm -h
BPF bootstrap demo application.

It traces process start and exits and shows associated
information (filename, process duration, PID and PPID, etc).

USAGE: ./bootstrap [-d &lt;min-duration-ms&gt;] -v
$ sudo ./wasm-bpf bootstrap.wasm
TIME     EVENT COMM             PID     PPID    FILENAME/EXIT CODE
18:57:58 EXEC  sed              74911   74910   /usr/bin/sed
18:57:58 EXIT  sed              74911   74910   [0] (2ms)
18:57:58 EXIT  cat              74912   74910   [0] (0ms)
18:57:58 EXEC  cat              74913   74910   /usr/bin/cat
18:57:59 EXIT  cat              74913   74910   [0] (0ms)
18:57:59 EXEC  cat              74914   74910   /usr/bin/cat
18:57:59 EXIT  cat              74914   74910   [0] (0ms)
18:57:59 EXEC  cat              74915   74910   /usr/bin/cat
18:57:59 EXIT  cat              74915   74910   [0] (1ms)
18:57:59 EXEC  sleep            74916   74910   /usr/bin/sleep
</code></pre>
<p>Êàë‰ª¨ÂèØ‰ª•Êèê‰æõ‰∏é libbpf-bootstrap ÂºÄÂèëÁõ∏‰ººÁöÑÂºÄÂèë‰ΩìÈ™å„ÄÇÂè™ÈúÄËøêË°å make Âç≥ÂèØÊûÑÂª∫ wasm ‰∫åËøõÂà∂Êñá‰ª∂Ôºö</p>
<pre><code class="language-console">git clone https://github.com/eunomia-bpf/wasm-bpf --recursive
cd examples/bootstrap
make
</code></pre>
<h3 id="ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ-ebpf-Á®ãÂ∫è-1"><a class="header" href="#ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ-ebpf-Á®ãÂ∫è-1">ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫è</a></h3>
<p>Ë¶ÅÊûÑÂª∫‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ eBPF Á®ãÂ∫èÔºåÈ¶ñÂÖàË¶ÅÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ bpf ‰ª£Á†Å„ÄÇÈÄöÂ∏∏‰ΩøÁî® C ËØ≠Ë®ÄÁºñÂÜôÔºåÂπ∂‰ΩøÁî® clang ÂÆåÊàêÁºñËØëÔºö</p>
<pre><code class="language-c">char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 8192);
    __type(key, pid_t);
    __type(value, u64);
} exec_start SEC(&quot;.maps&quot;);

struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

const volatile unsigned long long min_duration_ns = 0;
const volatile int *name_ptr;

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
    struct task_struct *task;
    unsigned fname_off;
    struct event *e;
    pid_t pid;
    u64 ts;
....
</code></pre>
<p>ÂèóÁØáÂπÖÊâÄÈôêÔºåËøôÈáåÊ≤°ÊúâË¥¥Âá∫ÂÆåÊï¥ÁöÑ‰ª£Á†Å„ÄÇÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÁöÑÁºñÂÜôÊñπÂºèÂíåÂÖ∂‰ªñÂü∫‰∫é libbpf ÁöÑÁ®ãÂ∫èÂÆåÂÖ®Áõ∏ÂêåÔºå‰∏ÄËà¨Êù•ËØ¥‰ºöÂåÖÂê´‰∏Ä‰∫õÂÖ®Â±ÄÂèòÈáèÔºåÈÄöËøá <code>SEC</code> Â£∞ÊòéÊåÇËΩΩÁÇπÁöÑ eBPF ÂáΩÊï∞Ôºå‰ª•ÂèäÁî®‰∫é‰øùÂ≠òÁä∂ÊÄÅÔºåÊàñËÄÖÂú®Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥Áõ∏‰∫íÈÄö‰ø°ÁöÑ map ÂØπË±°ÔºàÊàë‰ª¨ËøòÂú®ËøõË°åÂè¶Â§ñ‰∏ÄÈ°πÂ∑•‰ΩúÔºö<a href="https://github.com/iovisor/bcc/issues/4404">bcc to libbpf converter</a>ÔºåÁ≠âÂÆÉÂÆåÊàêÂêéÂ∞±ÂèØ‰ª•‰ª•ËøôÁßçÊñπÂºèÁºñËØë BCC È£éÊ†ºÁöÑ eBPF ÂÜÖÊ†∏ÊÄÅÁ®ãÂ∫èÔºâ„ÄÇÂú®ÁºñÂÜôÂÆå eBPF Á®ãÂ∫è‰πãÂêéÔºåËøêË°å <code>make</code> ‰ºöÂú® <code>Makefile</code> Ë∞ÉÁî® clang Âíå llvm-strip ÊûÑÂª∫BPFÁ®ãÂ∫èÔºå‰ª•Ââ•Á¶ªË∞ÉËØï‰ø°ÊÅØÔºö</p>
<pre><code class="language-shell">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I../../third_party/vmlinux/x86/ -idirafter /usr/local/include -idirafter /usr/include -c bootstrap.bpf.c -o bootstrap.bpf.o
llvm-strip -g bootstrap.bpf.o # strip useless DWARF info
</code></pre>
<p>‰πãÂêéÔºåÊàë‰ª¨‰ºöÊèê‰æõ‰∏Ä‰∏™‰∏∫‰∫Ü Wasm ‰∏ìÈó®ÂÆûÁé∞ÁöÑ bpftoolÔºåÁî®‰∫é‰ªé BPF Á®ãÂ∫èÁîüÊàêCÂ§¥Êñá‰ª∂Ôºö</p>
<pre><code class="language-shell">../../third_party/bpftool/src/bpftool gen skeleton -j bootstrap.bpf.o &gt; bootstrap.skel.h
</code></pre>
<p>Áî±‰∫é eBPF Êú¨Ë∫´ÁöÑÊâÄÊúâ C ÂÜÖÂ≠òÂ∏ÉÂ±ÄÊòØÂíåÂΩìÂâçÊâÄÂú®Êú∫Âô®ÁöÑÊåá‰ª§ÈõÜ‰∏ÄÊ†∑ÁöÑÔºå‰ΩÜÊòØ wasm ÊòØÊúâ‰∏ÄÂ•óÁ°ÆÂÆöÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÔºàÊØîÂ¶ÇÂΩìÂâçÊâÄÂú®Êú∫Âô®ÊòØ 64 ‰ΩçÁöÑÔºåWasm ËôöÊãüÊú∫ÈáåÈù¢ÊòØ 32 ‰ΩçÁöÑÔºåC struct layout „ÄÅÊåáÈíàÂÆΩÂ∫¶„ÄÅÂ§ßÂ∞èÁ´ØÁ≠âÁ≠âÈÉΩÂèØËÉΩ‰∏ç‰∏ÄÊ†∑ÔºâÔºå‰∏∫‰∫ÜÁ°Æ‰øù eBPF Á®ãÂ∫èËÉΩÊ≠£Á°ÆÂíå Wasm ‰πãÈó¥ËøõË°åÁõ∏‰∫íÈÄö‰ø°ÔºåÊàë‰ª¨ÈúÄË¶ÅÂÆöÂà∂‰∏Ä‰∏™‰∏ìÈó®ÁöÑ bpftool Á≠âÂ∑•ÂÖ∑ÔºåÂÆûÁé∞Ê≠£Á°ÆÁîüÊàêÂèØ‰ª•Âú® Wasm ‰∏≠Â∑•‰ΩúÁöÑÁî®Êà∑ÊÄÅÂºÄÂèëÊ°ÜÊû∂„ÄÇ</p>
<p>skel ÂåÖÂê´‰∏Ä‰∏™ BPF Á®ãÂ∫èÁöÑskeletonÔºåÁî®‰∫éÊìç‰Ωú BPF ÂØπË±°ÔºåÂπ∂ÊéßÂà∂ BPF Á®ãÂ∫èÁöÑÁîüÂëΩÂë®ÊúüÔºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-c">    struct bootstrap_bpf {
        struct bpf_object_skeleton *skeleton;
        struct bpf_object *obj;
        struct {
            struct bpf_map *exec_start;
            struct bpf_map *rb;
            struct bpf_map *rodata;
        } maps;
        struct {
            struct bpf_program *handle_exec;
            struct bpf_program *handle_exit;
        } progs;
        struct bootstrap_bpf__rodata {
            unsigned long long min_duration_ns;
        } *rodata;
        struct bootstrap_bpf__bss {
            uint64_t /* pointer */ name_ptr;
        } *bss;
    };
</code></pre>
<p>Êàë‰ª¨‰ºöÂ∞ÜÊâÄÊúâÊåáÈíàÈÉΩÂ∞ÜÊ†πÊçÆ eBPF Á®ãÂ∫èÁõÆÊ†áÊâÄÂú®ÁöÑÊåá‰ª§ÈõÜÁöÑÊåáÈíàÂ§ßÂ∞èËΩ¨Êç¢‰∏∫Êï¥Êï∞Ôºå‰æãÂ¶ÇÔºå<code>name_ptr</code>„ÄÇÊ≠§Â§ñÔºåÂ°´ÂÖÖÂ≠óËäÇÂ∞ÜÊòéÁ°ÆÊ∑ªÂä†Âà∞ÁªìÊûÑ‰Ωì‰∏≠‰ª•Á°Æ‰øùÁªìÊûÑ‰ΩìÂ∏ÉÂ±Ä‰∏éÁõÆÊ†áÁ´ØÁõ∏ÂêåÔºå‰æãÂ¶Ç‰ΩøÁî® <code>char __pad0[4];</code>„ÄÇÊàë‰ª¨Ëøò‰ºö‰ΩøÁî® <code>static_assert</code> Êù•Á°Æ‰øùÁªìÊûÑ‰ΩìÁöÑÂÜÖÂ≠òÈïøÂ∫¶ÂíåÂéüÂÖà BTF ‰ø°ÊÅØ‰∏≠ÁöÑÁ±ªÂûãÈïøÂ∫¶Áõ∏Âêå„ÄÇ</p>
<h3 id="ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ-wasm-‰ª£Á†ÅÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ-1"><a class="header" href="#ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ-wasm-‰ª£Á†ÅÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ-1">ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ Wasm ‰ª£Á†ÅÔºåÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ</a></h3>
<p>Êàë‰ª¨ÈªòËÆ§‰ΩøÁî® wasi-sdk ‰ªé C/C++ ‰ª£Á†ÅÊûÑÂª∫ wasm ‰∫åËøõÂà∂Êñá‰ª∂„ÄÇÊÇ®‰πüÂèØ‰ª•‰ΩøÁî® emcc Â∑•ÂÖ∑ÈìæÊù•ÊûÑÂª∫ wasm ‰∫åËøõÂà∂Êñá‰ª∂ÔºåÂëΩ‰ª§Â∫îËØ•ÊòØÁõ∏‰ººÁöÑ„ÄÇÊÇ®ÂèØ‰ª•ËøêË°å‰ª•‰∏ãÂëΩ‰ª§Êù•ÂÆâË£Ö wasi-sdkÔºö</p>
<pre><code class="language-sh">wget https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-17/wasi-sdk-17.0-linux.tar.gz
tar -zxf wasi-sdk-17.0-linux.tar.gz
sudo mkdir -p /opt/wasi-sdk/ &amp;&amp; sudo mv wasi-sdk-17.0/* /opt/wasi-sdk/
</code></pre>
<p>ÁÑ∂ÂêéËøêË°å <code>make</code> ‰ºöÂú® <code>Makefile</code> ‰∏≠‰ΩøÁî® wasi-clang ÁºñËØë C ‰ª£Á†ÅÔºåÁîüÊàê Wasm Â≠óËäÇÁ†ÅÔºö</p>
<pre><code class="language-sh">/opt/wasi-sdk/bin/clang -O2 --sysroot=/opt/wasi-sdk/share/wasi-sysroot -Wl,--allow-undefined -o bootstrap.wasm bootstrap.c
</code></pre>
<p>Áî±‰∫éÂÆø‰∏ªÊú∫ÔºàÊàñ eBPF Á´ØÔºâÁöÑ C ÁªìÊûÑÂ∏ÉÂ±ÄÂèØËÉΩ‰∏éÁõÆÊ†áÔºàWasm Á´ØÔºâÁöÑÁªìÊûÑÂ∏ÉÂ±Ä‰∏çÂêåÔºåÂõ†Ê≠§ÊÇ®ÂèØ‰ª•‰ΩøÁî® ecc ÂíåÊàë‰ª¨ÁöÑ wasm-bpftool ÁîüÊàêÁî®Êà∑Á©∫Èó¥‰ª£Á†ÅÁöÑ C Â§¥Êñá‰ª∂Ôºö</p>
<pre><code class="language-sh">ecc bootstrap.h --header-only
../../third_party/bpftool/src/bpftool btf dump file bootstrap.bpf.o format c -j &gt; bootstrap.wasm.h
</code></pre>
<p>‰æãÂ¶ÇÔºåÂéüÂÖàÂÜÖÊ†∏ÊÄÅÁöÑÂ§¥Êñá‰ª∂‰∏≠ÁªìÊûÑ‰ΩìÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<pre><code class="language-c">struct event {
    int pid;
    int ppid;
    unsigned exit_code;
    unsigned long long duration_ns;
    char comm[TASK_COMM_LEN];
    char filename[MAX_FILENAME_LEN];
    char exit_event;
};
</code></pre>
<p>Êàë‰ª¨ÁöÑÂ∑•ÂÖ∑‰ºöÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫Ôºö</p>
<pre><code class="language-c">struct event {
    int pid;
    int ppid;
    unsigned int exit_code;
    char __pad0[4];
    unsigned long long duration_ns;
    char comm[16];
    char filename[127];
    char exit_event;
} __attribute__((packed));
static_assert(sizeof(struct event) == 168, &quot;Size of event is not 168&quot;);
</code></pre>
<p>**Ê≥®ÊÑèÔºöÊ≠§ËøáÁ®ãÂíåÂ∑•ÂÖ∑Âπ∂‰∏çÊÄªÊòØÂøÖÈúÄÁöÑÔºåÂØπ‰∫éÁÆÄÂçïÁöÑÂ∫îÁî®Ôºå‰Ω†ÂèØ‰ª•ÊâãÂä®ÂÆåÊàê„ÄÇ**ÂØπ‰∫éÂÜÖÊ†∏ÊÄÅÂíå Wasm Â∫îÁî®ÈÉΩ‰ΩøÁî® C/C++ ËØ≠Ë®ÄÁöÑÊÉÖÂÜµ‰∏ãÔºå‰Ω†ÂèØ‰ª•ÊâãÂä®ÁºñÂÜôÊâÄÊúâ‰∫ã‰ª∂ÁªìÊûÑ‰ΩìÂÆö‰πâÔºå‰ΩøÁî® <code>__attribute__((packed))</code> ÈÅøÂÖçÂ°´ÂÖÖÂ≠óËäÇÔºåÂπ∂Âú®‰∏ªÊú∫Âíå wasm Á´Ø‰πãÈó¥ËΩ¨Êç¢ÊâÄÊúâÊåáÈíà‰∏∫Ê≠£Á°ÆÁöÑÊï¥Êï∞„ÄÇÊâÄÊúâÁ±ªÂûãÂøÖÈ°ªÂú® wasm ‰∏≠ÂÆö‰πâ‰∏é‰∏ªÊú∫Á´ØÁõ∏ÂêåÁöÑÂ§ßÂ∞èÂíåÂ∏ÉÂ±Ä„ÄÇ</p>
<p>ÂØπ‰∫éÂ§çÊùÇÁöÑÁ®ãÂ∫èÔºåÊâãÂä®Á°ÆËÆ§ÂÜÖÂ≠òÂ∏ÉÂ±ÄÁöÑÊ≠£Á°ÆÊòØÂàÜÂõ∞ÈöæÔºåÂõ†Ê≠§Êàë‰ª¨ÂàõÂª∫‰∫Ü wasm ÁâπÂÆöÁöÑ <code>bpftool</code>ÔºåÁî®‰∫é‰ªé <code>BTF</code> ‰ø°ÊÅØ‰∏≠ÁîüÊàêÂåÖÂê´ÊâÄÊúâÁ±ªÂûãÂÆö‰πâÂíåÊ≠£Á°ÆÁªìÊûÑ‰ΩìÂ∏ÉÂ±ÄÁöÑ C Â§¥Êñá‰ª∂Ôºå‰ª•‰æøÁî®Êà∑Á©∫Èó¥‰ª£Á†Å‰ΩøÁî®„ÄÇÂèØ‰ª•ÈÄöËøáÁ±ª‰ººÁöÑÊñπÊ°àÔºå‰∏ÄÊ¨°ÊÄßÂ∞Ü eBPF Á®ãÂ∫è‰∏≠ÊâÄÊúâÁöÑÁªìÊûÑ‰ΩìÂÆö‰πâËΩ¨Êç¢‰∏∫ Wasm Á´ØÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÔºåÂπ∂Á°Æ‰øùÂ§ßÂ∞èÁ´Ø‰∏ÄËá¥ÔºåÂç≥ÂèØÊ≠£Á°ÆËÆøÈóÆ„ÄÇ</p>
<p>ÂØπ‰∫é Wasm ‰∏≠‰∏çÊòØÁî± C ËØ≠Ë®ÄËøõË°åÂºÄÂèëÁöÑÊÉÖÂÜµ‰∏ãÔºåÂÄüÂä© Wasm ÁöÑÁªÑ‰ª∂Ê®°ÂûãÔºåÊàë‰ª¨ËøòÂèØ‰ª•Â∞ÜËøô‰∫õ BTF ‰ø°ÊÅØÁªìÊûÑ‰ΩìÂÆö‰πâ‰Ωú‰∏∫ wit Á±ªÂûãÂ£∞ÊòéËæìÂá∫ÔºåÁÑ∂ÂêéÂú®Áî®Êà∑Á©∫Èó¥‰ª£Á†Å‰∏≠‰ΩøÁî® wit-bindgen Â∑•ÂÖ∑‰∏ÄÊ¨°ÊÄßÁîüÊàêÂ§öÁßçËØ≠Ë®ÄÔºàÂ¶Ç C/C++/Rust/GoÔºâÁöÑÁ±ªÂûãÂÆö‰πâ„ÄÇËøôÈÉ®ÂàÜ‰ºöÂú®ÂÖ≥‰∫éÂ¶Ç‰Ωï‰ΩøÁî® Rust Âú® Wasm ‰∏≠ÁºñÂÜô eBPF Á®ãÂ∫èÁöÑÈÉ®ÂàÜËØ¶ÁªÜÊèèËø∞ÔºåÊàë‰ª¨‰πü‰ºöÂ∞ÜËøô‰∫õÊ≠•È™§ÂíåÂ∑•ÂÖ∑ÈìæÁªßÁª≠ÂÆåÂñÑÔºå‰ª•ÊîπËøõ Wasm-bpf Á®ãÂ∫èÁöÑÁºñÁ®ã‰ΩìÈ™å„ÄÇ</p>
<p>Êàë‰ª¨‰∏∫ wasm Á®ãÂ∫èÊèê‰æõ‰∫Ü‰∏Ä‰∏™‰ªÖÂåÖÂê´Â§¥Êñá‰ª∂ÁöÑ libbpf API Â∫ìÔºåÊÇ®ÂèØ‰ª•Âú® libbpf-wasm.hÔºàwasm-include/libbpf-wasm.hÔºâ‰∏≠ÊâæÂà∞ÂÆÉÔºåÂÆÉÂåÖÂê´‰∫Ü‰∏ÄÈÉ®ÂàÜ libbpf Â∏∏Áî®ÁöÑÁî®Êà∑ÊÄÅ API ÂíåÁ±ªÂûãÂÆö‰πâ„ÄÇWasm Á®ãÂ∫èÂèØ‰ª•‰ΩøÁî® libbpf API Êìç‰Ωú BPF ÂØπË±°Ôºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-c">/* Load and verify BPF application */
skel = bootstrap_bpf__open();
/* Parameterize BPF code with minimum duration parameter */
skel-&gt;rodata-&gt;min_duration_ns = env.min_duration_ms * 1000000ULL;
/* Load &amp; verify BPF programs */
err = bootstrap_bpf__load(skel);
/* Attach tracepoints */
err = bootstrap_bpf__attach(skel);
</code></pre>
<p>rodata ÈÉ®ÂàÜÁî®‰∫éÂ≠òÂÇ® BPF Á®ãÂ∫è‰∏≠ÁöÑÂ∏∏ÈáèÔºåËøô‰∫õÂÄºÂ∞ÜÂú® bpftool gen skeleton ÁöÑÊó∂ÂÄôÁî±‰ª£Á†ÅÁîüÊàêÊò†Â∞ÑÂà∞ object ‰∏≠Ê≠£Á°ÆÁöÑÂÅèÁßªÈáè,ÁÑ∂ÂêéÂú® open ‰πãÂêéÈÄöËøáÂÜÖÂ≠òÊò†Â∞Ñ‰øÆÊîπÂØπÂ∫îÁöÑÂÄºÔºåÂõ†Ê≠§‰∏çÈúÄË¶ÅÂú® Wasm ‰∏≠ÁºñËØë libelf Â∫ìÔºåËøêË°åÊó∂‰ªçÂèØÂä®ÊÄÅÂä†ËΩΩÂíåÊìç‰Ωú BPF ÂØπË±°„ÄÇ</p>
<p>Wasm Á´ØÁöÑ C ‰ª£Á†Å‰∏éÊú¨Âú∞ libbpf ‰ª£Á†ÅÁï•Êúâ‰∏çÂêåÔºå‰ΩÜÂÆÉÂèØ‰ª•‰ªé eBPF Á´ØÊèê‰æõÂ§ßÈÉ®ÂàÜÂäüËÉΩÔºå‰æãÂ¶ÇÔºå‰ªéÁéØÂΩ¢ÁºìÂÜ≤Âå∫Êàñ perf ÁºìÂÜ≤Âå∫ËΩÆËØ¢Ôºå‰ªé Wasm Á´ØÂíå eBPF Á´ØËÆøÈóÆÊò†Â∞ÑÔºåÂä†ËΩΩ„ÄÅÈôÑÂä†ÂíåÂàÜÁ¶ª BPF Á®ãÂ∫èÁ≠â„ÄÇÂÆÉÂèØ‰ª•ÊîØÊåÅÂ§ßÈáèÁöÑ eBPF Á®ãÂ∫èÁ±ªÂûãÂíåÊò†Â∞ÑÔºåÊ∂µÁõñ‰ªéË∑üË∏™„ÄÅÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÊñπÈù¢ÁöÑÂ§ßÂ§öÊï∞ eBPF Á®ãÂ∫èÁöÑ‰ΩøÁî®Âú∫ÊôØ„ÄÇ</p>
<p>Áî±‰∫é Wasm Á´ØÁº∫Â∞ë‰∏Ä‰∫õÂäüËÉΩÔºå‰æãÂ¶Ç signal handler Ëøò‰∏çÊîØÊåÅÔºà2023Âπ¥2ÊúàÔºâÔºåÂéüÂßãÁöÑC‰ª£Á†ÅÊúâÂèØËÉΩÊó†Ê≥ïÁõ¥Êé•ÁºñËØë‰∏∫ wasmÔºåÊÇ®ÈúÄË¶ÅÁ®çÂæÆ‰øÆÊîπ‰ª£Á†Å‰ª•‰ΩøÂÖ∂Â∑•‰Ωú„ÄÇÊàë‰ª¨Â∞ÜÂ∞ΩÊúÄÂ§ßÂä™Âäõ‰Ωø wasm Á´ØÁöÑ libbpf API ‰∏éÈÄöÂ∏∏Âú®Áî®Êà∑Á©∫Èó¥ËøêË°åÁöÑ libbpf APIÂ∞ΩÂèØËÉΩÁõ∏‰ººÔºå‰ª•‰æøÁî®Êà∑Á©∫Èó¥‰ª£Á†ÅÂèØ‰ª•Âú®Êú™Êù•Áõ¥Êé•ÁºñËØë‰∏∫ wasm„ÄÇÊàë‰ª¨ËøòÂ∞ÜÂ∞ΩÂø´Êèê‰æõÊõ¥Â§öËØ≠Ë®ÄÁªëÂÆöÔºàGoÁ≠âÔºâÁöÑ wasm ‰æß eBPF Á®ãÂ∫èÂºÄÂèëÂ∫ì„ÄÇ</p>
<p>ÂèØ‰ª•Âú®Áî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠‰ΩøÁî® polling API Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅ‰∏ä‰º†ÁöÑÊï∞ÊçÆ„ÄÇÂÆÉÂ∞ÜÊòØ ring buffer Âíå perf buffer ÁöÑ‰∏Ä‰∏™Â∞ÅË£ÖÔºåÁî®Êà∑Á©∫Èó¥‰ª£Á†ÅÂèØ‰ª•‰ΩøÁî®Áõ∏ÂêåÁöÑ API ‰ªéÁéØÂΩ¢ÁºìÂÜ≤Âå∫ÊàñÊÄßËÉΩÁºìÂÜ≤Âå∫‰∏≠ËΩÆËØ¢‰∫ã‰ª∂ÔºåÂÖ∑‰ΩìÂèñÂÜ≥‰∫éBPFÁ®ãÂ∫è‰∏≠ÊåáÂÆöÁöÑÁ±ªÂûã„ÄÇ‰æãÂ¶ÇÔºåÁéØÂΩ¢ÁºìÂÜ≤Âå∫ËΩÆËØ¢ÂÆö‰πâ‰∏∫<code>BPF_MAP_TYPE_RINGBUF</code>Ôºö</p>
<pre><code class="language-c">struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);
</code></pre>
<p>‰Ω†ÂèØ‰ª•Âú®Áî®Êà∑ÊÄÅ‰ΩøÁî®‰ª•‰∏ã‰ª£Á†Å‰ªé ring buffer ‰∏≠ËΩÆËØ¢‰∫ã‰ª∂Ôºö</p>
<pre><code class="language-c">rb = bpf_buffer__open(skel-&gt;maps.rb, handle_event, NULL);
/* Process events */
printf(&quot;%-8s %-5s %-16s %-7s %-7s %s\n&quot;, &quot;TIME&quot;, &quot;EVENT&quot;, &quot;COMM&quot;, &quot;PID&quot;,
       &quot;PPID&quot;, &quot;FILENAME/EXIT CODE&quot;);
while (!exiting) {
    // poll buffer
    err = bpf_buffer__poll(rb, 100 /* timeout, ms */);
</code></pre>
<p>ring buffer polling ‰∏çÈúÄË¶ÅÂ∫èÂàóÂåñÂºÄÈîÄ„ÄÇbpf_buffer__poll API Â∞ÜË∞ÉÁî® handle_event ÂõûË∞ÉÂáΩÊï∞Êù•Â§ÑÁêÜÁéØÂΩ¢ÁºìÂÜ≤Âå∫‰∏≠ÁöÑ‰∫ã‰ª∂Êï∞ÊçÆÔºö</p>
<pre><code class="language-c">
static int
handle_event(void *ctx, void *data, size_t data_sz)
{
    const struct event *e = data;
    ...
    if (e-&gt;exit_event) {
        printf(&quot;%-8s %-5s %-16s %-7d %-7d [%u]&quot;, ts, &quot;EXIT&quot;, e-&gt;comm, e-&gt;pid,
               e-&gt;ppid, e-&gt;exit_code);
        if (e-&gt;duration_ns)
            printf(&quot; (%llums)&quot;, e-&gt;duration_ns / 1000000);
        printf(&quot;\n&quot;);
    }
    ...
    return 0;
}
</code></pre>
<p>ËøêË°åÊó∂Âü∫‰∫é libbpf CO-REÔºàCompile Once, Run EverywhereÔºâAPIÔºåÁî®‰∫éÂ∞Ü bpf ÂØπË±°Âä†ËΩΩÂà∞ÂÜÖÊ†∏‰∏≠ÔºåÂõ†Ê≠§ wasm-bpf Á®ãÂ∫è‰∏çÂèóÂÆÉÁºñËØëÁöÑÂÜÖÊ†∏ÁâàÊú¨ÁöÑÂΩ±ÂìçÔºåÂèØ‰ª•Âú®‰ªª‰ΩïÊîØÊåÅ BPF CO-RE ÁöÑÂÜÖÊ†∏ÁâàÊú¨‰∏äËøêË°å„ÄÇ</p>
<h3 id="‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞-ebpf-Á®ãÂ∫èÁöÑ-map-Êï∞ÊçÆ"><a class="header" href="#‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞-ebpf-Á®ãÂ∫èÁöÑ-map-Êï∞ÊçÆ">‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞ eBPF Á®ãÂ∫èÁöÑ map Êï∞ÊçÆ</a></h3>
<p>runqlat ÊòØ‰∏Ä‰∏™Êõ¥Â§çÊùÇÁöÑÁ§∫‰æãÔºåËøô‰∏™Á®ãÂ∫èÈÄöËøáÁõ¥ÊñπÂõæÂ±ïÁ§∫Ë∞ÉÂ∫¶Âô®ËøêË°åÈòüÂàóÂª∂ËøüÔºåÁªôÊàë‰ª¨Â±ïÁé∞‰∫Ü‰ªªÂä°Á≠â‰∫ÜÂ§ö‰πÖÊâçËÉΩËøêË°å„ÄÇ</p>
<pre><code class="language-console">$ sudo ./wasm-bpf runqlat.wasm -h
Summarize run queue (scheduler) latency as a histogram.

USAGE: runqlat [--help] [interval] [count]

EXAMPLES:
    runqlat         # summarize run queue latency as a histogram
    runqlat 1 10    # print 1 second summaries, 10 times
$ sudo ./wasm-bpf runqlat.wasm 1

Tracing run queue latency... Hit Ctrl-C to end.

     usecs               : count    distribution
         0 -&gt; 1          : 72       |*****************************           |
         2 -&gt; 3          : 93       |*************************************   |
         4 -&gt; 7          : 98       |****************************************|
         8 -&gt; 15         : 96       |*************************************** |
        16 -&gt; 31         : 38       |***************                         |
        32 -&gt; 63         : 4        |*                                       |
        64 -&gt; 127        : 5        |**                                      |
       128 -&gt; 255        : 6        |**                                      |
       256 -&gt; 511        : 0        |                                        |
       512 -&gt; 1023       : 0        |                                        |
      1024 -&gt; 2047       : 0        |                                        |
      2048 -&gt; 4095       : 1        |                                        |
</code></pre>
<p>runqlat ‰∏≠‰ΩøÁî® <code>map</code> API Êù•‰ªéÁî®Êà∑ÊÄÅËÆøÈóÆÂÜÖÊ†∏ÈáåÁöÑ <code>map</code> Âπ∂Áõ¥Êé•ËØªÂèñÊï∞ÊçÆÔºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-c">    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_lookup_elem(fd, &amp;next_key, &amp;hist);
        ...
        lookup_key = next_key;
    }
    lookup_key = -2;
    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_delete_elem(fd, &amp;next_key);
        ...
        lookup_key = next_key;
    }
</code></pre>
<p>ËøêË°åÊó∂ wasm ‰ª£Á†ÅÂ∞Ü‰ºö‰ΩøÁî®ÂÖ±‰∫´ÂÜÖÂ≠òÊù•ËÆøÈóÆÂÜÖÊ†∏ mapÔºåÂÜÖÊ†∏ÊÄÅÂèØ‰ª•Áõ¥Êé•ÊääÊï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑ÊÄÅ Wasm ËôöÊãüÊú∫ÁöÑÂ†ÜÊ†à‰∏≠ÔºåËÄå‰∏çÈúÄË¶ÅÈù¢ÂØπÁî®Êà∑ÊÄÅ‰∏ªÊú∫‰æßÁ®ãÂ∫èÂíå Wasm ËøêË°åÊó∂‰πãÈó¥ÁöÑÈ¢ùÂ§ñÊã∑Ë¥ùÂºÄÈîÄ„ÄÇÂêåÊ†∑ÔºåÂØπ‰∫é Wasm ËôöÊãüÊú∫ÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥ÂÖ±‰∫´ÁöÑÁ±ªÂûãÂÆö‰πâÔºåÈúÄË¶ÅÁªèËøá‰ªîÁªÜÊ£ÄÊü•‰ª•Á°Æ‰øùÂÆÉ‰ª¨Âú® Wasm ÂíåÂÜÖÊ†∏ÊÄÅ‰∏≠ÁöÑÁ±ªÂûãÊòØ‰∏ÄËá¥ÁöÑ„ÄÇ</p>
<p>ÂèØ‰ª•‰ΩøÁî® <code>bpf_map_update_elem</code> Âú®Áî®Êà∑ÊÄÅÁ®ãÂ∫èÂÜÖÊõ¥Êñ∞ÂÜÖÊ†∏ÁöÑ eBPF mapÔºåÊØîÂ¶Ç:</p>
<pre><code class="language-c">        cg_map_fd = bpf_map__fd(obj-&gt;maps.cgroup_map);
        cgfd = open(env.cgroupspath, O_RDONLY);
        if (cgfd &lt; 0) {
            ...
        }
        if (bpf_map_update_elem(cg_map_fd, &amp;idx, &amp;cgfd, BPF_ANY)) {
            ...
        }
</code></pre>
<p>Âõ†Ê≠§ÂÜÖÊ†∏ÁöÑ eBPF Á®ãÂ∫èÂèØ‰ª•‰ªé Wasm ‰æßÁöÑÁ®ãÂ∫èËé∑ÂèñÈÖçÁΩÆÔºåÊàñËÄÖÂú®ËøêË°åÁöÑÊó∂ÂÄôÊé•Êî∂Ê∂àÊÅØ„ÄÇ</p>
<h3 id="‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞-ebpf-Á®ãÂ∫èÁöÑ-map-Êï∞ÊçÆ-1"><a class="header" href="#‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞-ebpf-Á®ãÂ∫èÁöÑ-map-Êï∞ÊçÆ-1">‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞ eBPF Á®ãÂ∫èÁöÑ map Êï∞ÊçÆ</a></h3>
<p>runqlat ÊòØ‰∏Ä‰∏™Êõ¥Â§çÊùÇÁöÑÁ§∫‰æãÔºåËøô‰∏™Á®ãÂ∫èÈÄöËøáÁõ¥ÊñπÂõæÂ±ïÁ§∫Ë∞ÉÂ∫¶Âô®ËøêË°åÈòüÂàóÂª∂ËøüÔºåÁªôÊàë‰ª¨Â±ïÁé∞‰∫Ü‰ªªÂä°Á≠â‰∫ÜÂ§ö‰πÖÊâçËÉΩËøêË°å„ÄÇ</p>
<pre><code class="language-console">$ sudo ./wasm-bpf runqlat.wasm -h
Summarize run queue (scheduler) latency as a histogram.

USAGE: runqlat [--help] [interval] [count]

EXAMPLES:
    runqlat         # summarize run queue latency as a histogram
    runqlat 1 10    # print 1 second summaries, 10 times
$ sudo ./wasm-bpf runqlat.wasm 1

Tracing run queue latency... Hit Ctrl-C to end.

     usecs               : count    distribution
         0 -&gt; 1          : 72       |*****************************           |
         2 -&gt; 3          : 93       |*************************************   |
         4 -&gt; 7          : 98       |****************************************|
         8 -&gt; 15         : 96       |*************************************** |
        16 -&gt; 31         : 38       |***************                         |
        32 -&gt; 63         : 4        |*                                       |
        64 -&gt; 127        : 5        |**                                      |
       128 -&gt; 255        : 6        |**                                      |
       256 -&gt; 511        : 0        |                                        |
       512 -&gt; 1023       : 0        |                                        |
      1024 -&gt; 2047       : 0        |                                        |
      2048 -&gt; 4095       : 1        |                                        |
</code></pre>
<p>runqlat ‰∏≠‰ΩøÁî® <code>map</code> API Êù•‰ªéÁî®Êà∑ÊÄÅËÆøÈóÆÂÜÖÊ†∏ÈáåÁöÑ <code>map</code> Âπ∂Áõ¥Êé•ËØªÂèñÊï∞ÊçÆÔºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-c">    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_lookup_elem(fd, &amp;next_key, &amp;hist);
        ...
        lookup_key = next_key;
    }
    lookup_key = -2;
    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_delete_elem(fd, &amp;next_key);
        ...
        lookup_key = next_key;
    }
</code></pre>
<p>ËøêË°åÊó∂ wasm ‰ª£Á†ÅÂ∞Ü‰ºö‰ΩøÁî®ÂÖ±‰∫´ÂÜÖÂ≠òÊù•ËÆøÈóÆÂÜÖÊ†∏ mapÔºåÂÜÖÊ†∏ÊÄÅÂèØ‰ª•Áõ¥Êé•ÊääÊï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑ÊÄÅ Wasm ËôöÊãüÊú∫ÁöÑÂ†ÜÊ†à‰∏≠ÔºåËÄå‰∏çÈúÄË¶ÅÈù¢ÂØπÁî®Êà∑ÊÄÅ‰∏ªÊú∫‰æßÁ®ãÂ∫èÂíå Wasm ËøêË°åÊó∂‰πãÈó¥ÁöÑÈ¢ùÂ§ñÊã∑Ë¥ùÂºÄÈîÄ„ÄÇÂêåÊ†∑ÔºåÂØπ‰∫é Wasm ËôöÊãüÊú∫ÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥ÂÖ±‰∫´ÁöÑÁ±ªÂûãÂÆö‰πâÔºåÈúÄË¶ÅÁªèËøá‰ªîÁªÜÊ£ÄÊü•‰ª•Á°Æ‰øùÂÆÉ‰ª¨Âú® Wasm ÂíåÂÜÖÊ†∏ÊÄÅ‰∏≠ÁöÑÁ±ªÂûãÊòØ‰∏ÄËá¥ÁöÑ„ÄÇ</p>
<p>ÂèØ‰ª•‰ΩøÁî® <code>bpf_map_update_elem</code> Âú®Áî®Êà∑ÊÄÅÁ®ãÂ∫èÂÜÖÊõ¥Êñ∞ÂÜÖÊ†∏ÁöÑ eBPF mapÔºåÊØîÂ¶Ç:</p>
<pre><code class="language-c">        cg_map_fd = bpf_map__fd(obj-&gt;maps.cgroup_map);
        cgfd = open(env.cgroupspath, O_RDONLY);
        if (cgfd &lt; 0) {
            ...
        }
        if (bpf_map_update_elem(cg_map_fd, &amp;idx, &amp;cgfd, BPF_ANY)) {
            ...
        }
</code></pre>
<p>Âõ†Ê≠§ÂÜÖÊ†∏ÁöÑ eBPF Á®ãÂ∫èÂèØ‰ª•‰ªé Wasm ‰æßÁöÑÁ®ãÂ∫èËé∑ÂèñÈÖçÁΩÆÔºåÊàñËÄÖÂú®ËøêË°åÁöÑÊó∂ÂÄôÊé•Êî∂Ê∂àÊÅØ„ÄÇ</p>
<h3 id="Êõ¥Â§öÁöÑ‰æãÂ≠êsocket-filter-Âíå-lsm"><a class="header" href="#Êõ¥Â§öÁöÑ‰æãÂ≠êsocket-filter-Âíå-lsm">Êõ¥Â§öÁöÑ‰æãÂ≠êÔºösocket filter Âíå lsm</a></h3>
<p>Âú®‰ªìÂ∫ì‰∏≠ÔºåÊàë‰ª¨ËøòÊèê‰æõ‰∫ÜÊõ¥Â§öÁöÑÁ§∫‰æãÔºå‰æãÂ¶Ç‰ΩøÁî® socket filter ÁõëÊéßÂíåËøáÊª§Êï∞ÊçÆÂåÖÔºö</p>
<pre><code class="language-c">SEC(&quot;socket&quot;)
int socket_handler(struct __sk_buff *skb)
{
    struct so_event *e;
    __u8 verlen;
    __u16 proto;
    __u32 nhoff = ETH_HLEN;

    bpf_skb_load_bytes(skb, 12, &amp;proto, 2);
    ...

    bpf_skb_load_bytes(skb, nhoff + 0, &amp;verlen, 1);
    bpf_skb_load_bytes(skb, nhoff + ((verlen &amp; 0xF) &lt;&lt; 2), &amp;(e-&gt;ports), 4);
    e-&gt;pkt_type = skb-&gt;pkt_type;
    e-&gt;ifindex = skb-&gt;ifindex;
    bpf_ringbuf_submit(e, 0);

    return skb-&gt;len;
}
</code></pre>
<p>Linux Security ModulesÔºàLSMÔºâÊòØ‰∏Ä‰∏™Âü∫‰∫éÈí©Â≠êÁöÑÊ°ÜÊû∂ÔºåÁî®‰∫éÂú®LinuxÂÜÖÊ†∏‰∏≠ÂÆûÁé∞ÂÆâÂÖ®Á≠ñÁï•ÂíåÂº∫Âà∂ËÆøÈóÆÊéßÂà∂„ÄÇÁõ¥Âà∞Áé∞Âú®ÔºåËÉΩÂ§üÂÆûÁé∞ÂÆûÊñΩÂÆâÂÖ®Á≠ñÁï•ÁõÆÊ†áÁöÑÊñπÂºèÂè™Êúâ‰∏§ÁßçÈÄâÊã©ÔºåÈÖçÁΩÆÁé∞ÊúâÁöÑLSMÊ®°ÂùóÔºàÂ¶ÇAppArmor„ÄÅSELinuxÔºâÔºåÊàñÁºñÂÜôËá™ÂÆö‰πâÂÜÖÊ†∏Ê®°Âùó„ÄÇ</p>
<p>Linux Kernel 5.7 ÂºïÂÖ•‰∫ÜÁ¨¨‰∏âÁßçÊñπÂºèÔºöLSM eBPF„ÄÇLSM BPF ÂÖÅËÆ∏ÂºÄÂèë‰∫∫ÂëòÁºñÂÜôËá™ÂÆö‰πâÁ≠ñÁï•ÔºåËÄåÊó†ÈúÄÈÖçÁΩÆÊàñÂä†ËΩΩÂÜÖÊ†∏Ê®°Âùó„ÄÇLSM BPF Á®ãÂ∫èÂú®Âä†ËΩΩÊó∂Ë¢´È™åËØÅÔºåÁÑ∂ÂêéÂú®Ë∞ÉÁî®Ë∑ØÂæÑ‰∏≠ÔºåÂà∞ËææLSMÈí©Â≠êÊó∂Ë¢´ÊâßË°å„ÄÇ‰æãÂ¶ÇÔºåÊàë‰ª¨ÂèØ‰ª•Âú® Wasm ËΩªÈáèÁ∫ßÂÆπÂô®‰∏≠Ôºå‰ΩøÁî® lsm ÈôêÂà∂Êñá‰ª∂Á≥ªÁªüÊìç‰ΩúÔºö</p>
<pre><code class="language-c">// all lsm the hook point refer https://www.kernel.org/doc/html/v5.2/security/LSM.html
SEC(&quot;lsm/path_rmdir&quot;)
int path_rmdir(const struct path *dir, struct dentry *dentry) {
  char comm[16];
  bpf_get_current_comm(comm, sizeof(comm));
  unsigned char dir_name[] = &quot;can_not_rm&quot;;
  unsigned char d_iname[32];
  bpf_probe_read_kernel(&amp;d_iname[0], sizeof(d_iname),
                        &amp;(dir-&gt;dentry-&gt;d_iname[0]));

  bpf_printk(&quot;comm %s try to rmdir %s&quot;, comm, d_iname);
  for (int i = 0;i&lt;sizeof(dir_name);i++){
    if (d_iname[i]!=dir_name[i]){
        return 0;
    }
  }
  return -1;
}
</code></pre>
<h2 id="ÊºîÁ§∫ËßÜÈ¢ë"><a class="header" href="#ÊºîÁ§∫ËßÜÈ¢ë">ÊºîÁ§∫ËßÜÈ¢ë</a></h2>
<p>Êàë‰ª¨‰πüÊúâ‰∏Ä‰∏™Âú® B Á´ô‰∏äÁöÑÊºîÁ§∫ËßÜÈ¢ëÔºåÊºîÁ§∫‰∫ÜÂ¶Ç‰Ωï‰ªé bcc/libbpf-tools ‰∏≠ÁßªÊ§ç‰∏Ä‰∏™ eBPF Â∑•ÂÖ∑Á®ãÂ∫èÂà∞ eunomia-bpf ‰∏≠ÔºåÂπ∂‰∏î‰ΩøÁî® Wasm Êàñ JSON Êñá‰ª∂Êù•ÂàÜÂèë„ÄÅÂä†ËΩΩ eBPF Á®ãÂ∫èÔºö<a href="https://www.bilibili.com/video/BV1JN4y1A76k">https://www.bilibili.com/video/BV1JN4y1A76k</a></p>
<p><code>ecli</code> ÊòØÂü∫‰∫éÊàë‰ª¨Â∫ïÂ±ÇÁöÑ eunomia-bpf Â∫ìÂíåËøêË°åÊó∂ÂÆûÁé∞ÁöÑ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑„ÄÇÊàë‰ª¨ÁöÑÈ°πÁõÆÊû∂ÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="img/eunomia-arch.png" alt="arch" /></p>
<p><code>ecli</code> Â∑•ÂÖ∑Âü∫‰∫é <code>ewasm</code> Â∫ìÂÆûÁé∞Ôºå<code>ewasm</code> Â∫ìÂåÖÂê´‰∏Ä‰∏™ WAMR(wasm-micro-runtime) ËøêË°åÊó∂Ôºå‰ª•ÂèäÂü∫‰∫é libbpf Â∫ìÊûÑÂª∫ÁöÑ eBPF Âä®ÊÄÅË£ÖËΩΩÊ®°Âùó„ÄÇÂ§ßËá¥Êù•ËØ¥ÔºåÊàë‰ª¨Âú® <code>Wasm</code> ËøêË°åÊó∂ÂíåÁî®Êà∑ÊÄÅÁöÑ <code>libbpf</code> ‰∏≠Èó¥Â§öÂä†‰∫Ü‰∏ÄÂ±ÇÊäΩË±°Â±ÇÔºà<code>eunomia-bpf</code> Â∫ìÔºâÔºå‰ΩøÂæó‰∏ÄÊ¨°ÁºñËØë„ÄÅÂà∞Â§ÑËøêË°åÁöÑ eBPF ‰ª£Á†ÅÂèØ‰ª•‰ªé JSON ÂØπË±°‰∏≠Âä®ÊÄÅÂä†ËΩΩ„ÄÇJSON ÂØπË±°‰ºöÂú®ÁºñËØëÊó∂Ë¢´ÂåÖÂê´Âú® Wasm Ê®°Âùó‰∏≠ÔºåÂõ†Ê≠§Âú®ËøêË°åÊó∂ÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøáËß£Êûê JSON ÂØπË±°Êù•Ëé∑Âèñ eBPF Á®ãÂ∫èÁöÑ‰ø°ÊÅØÔºåÁÑ∂ÂêéÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫è„ÄÇ</p>
<p>‰ΩøÁî® Wasm Êàñ JSON ÁºñËØëÂàÜÂèë eBPF Á®ãÂ∫èÁöÑÊµÅÁ®ãÂõæÂ§ßËá¥Â¶Ç‰∏ãÔºö</p>
<p><img src="img/eunomia-bpf-flow.png" alt="flow" /></p>
<p>Â§ßËá¥Êù•ËØ¥ÔºåÊï¥‰∏™ eBPF Á®ãÂ∫èÁöÑÁºñÂÜôÂíåÂä†ËΩΩÂàÜ‰∏∫‰∏â‰∏™ÈÉ®ÂàÜÔºö</p>
<ol>
<li>Áî® eunomia-cc Â∑•ÂÖ∑ÈìæÂ∞ÜÂÜÖÊ†∏ÁöÑ eBPF ‰ª£Á†ÅÈ™®Êû∂ÂíåÂ≠óËäÇÁ†ÅÁºñËØë‰∏∫ JSON Ê†ºÂºè</li>
<li>Âú®Áî®Êà∑ÊÄÅÂºÄÂèëÁöÑÈ´òÁ∫ßËØ≠Ë®ÄÔºà‰æãÂ¶Ç C ËØ≠Ë®ÄÔºâ‰∏≠ÂµåÂÖ• JSON Êï∞ÊçÆÔºåÂπ∂Êèê‰æõ‰∏Ä‰∫õ API Áî®‰∫éÊìç‰Ωú JSON ÂΩ¢ÊÄÅÁöÑ eBPF Á®ãÂ∫èÈ™®Êû∂</li>
<li>Â∞ÜÁî®Êà∑ÊÄÅÁ®ãÂ∫èÂíå JSON Êï∞ÊçÆ‰∏ÄËµ∑ÁºñËØë‰∏∫ Wasm Â≠óËäÇÁ†ÅÂπ∂ÊâìÂåÖ‰∏∫ Wasm Ê®°ÂùóÔºåÁÑ∂ÂêéÂú®ÁõÆÊ†áÊú∫Âô®‰∏äÂä†ËΩΩÂπ∂ËøêË°å Wasm Á®ãÂ∫è</li>
<li>‰ªé Wasm Ê®°Âùó‰∏≠Âä†ËΩΩÂÜÖÂµåÁöÑ JSON Êï∞ÊçÆÔºåÁî® eunomia-bpf Â∫ìÂä®ÊÄÅË£ÖËΩΩÂíåÈÖçÁΩÆ eBPF Á®ãÂ∫èÈ™®Êû∂„ÄÇ</li>
</ol>
<p>Êàë‰ª¨ÈúÄË¶ÅÂÆåÊàêÁöÑ‰ªÖ‰ªÖÊòØÂ∞ëÈáèÁöÑ native API Âíå Wasm ËøêË°åÊó∂ÁöÑÁªëÂÆöÔºåÂπ∂‰∏îÂú® Wasm ‰ª£Á†Å‰∏≠Â§ÑÁêÜ JSON Êï∞ÊçÆ„ÄÇ‰Ω†ÂèØ‰ª•Âú®‰∏Ä‰∏™Âçï‰∏ÄÁöÑ <code>Wasm</code> Ê®°Âùó‰∏≠Êã•ÊúâÂ§ö‰∏™ <code>eBPF</code> Á®ãÂ∫è„ÄÇÂ¶ÇÊûú‰∏ç‰ΩøÁî®Êàë‰ª¨Êèê‰æõÁöÑ Wasm ËøêË°åÊó∂ÔºåÊàñËÄÖÊÉ≥Ë¶Å‰ΩøÁî®ÂÖ∂‰ªñËØ≠Ë®ÄËøõË°åÁî®Êà∑ÊÄÅÁöÑ eBPF ËæÖÂä©‰ª£Á†ÅÁöÑÂºÄÂèëÔºåÂú®Êàë‰ª¨Êèê‰æõÁöÑ <code>eunomia-bpf</code> Â∫ìÂü∫Á°Ä‰∏äÂÆåÊàê‰∏Ä‰∫õ WebaAssembly ÁöÑÁªëÂÆöÂç≥ÂèØ„ÄÇ</p>
<p>Âè¶Â§ñÔºåÂØπ‰∫é eunomia-bpf Â∫ìËÄåË®ÄÔºå‰∏çÈúÄË¶Å Wasm Ê®°ÂùóÂíåËøêË°åÊó∂ÂêåÊ†∑ÂèØ‰ª•ÂêØÂä®ÂíåÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫èÔºå‰∏çËøáÊ≠§Êó∂Âä®ÊÄÅÂä†ËΩΩËøêË°åÁöÑÂ∞±Âè™ÊòØÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫èÂ≠óËäÇÁ†Å„ÄÇ‰Ω†ÂèØ‰ª•ÊâãÂä®Êàñ‰ΩøÁî®‰ªªÊÑèËØ≠Ë®Ä‰øÆÊîπ JSON ÂØπË±°Êù•ÊéßÂà∂ eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÂèÇÊï∞ÔºåÂπ∂‰∏îÈÄöËøá eunomia-bpf Ëá™Âä®Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅ‰∏äÊä•ÁöÑËøîÂõûÊï∞ÊçÆ„ÄÇÂØπ‰∫éÂàùÂ≠¶ËÄÖËÄåË®ÄÔºåËøôÂèØËÉΩÊØî‰ΩøÁî® WebAssembly Êõ¥Âä†ÁÆÄÂçïÊñπ‰æøÔºöÂè™ÈúÄË¶ÅÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫èÔºåÁÑ∂Âêé‰ΩøÁî® eunomia-cc Â∑•ÂÖ∑ÈìæÂ∞ÜÂÖ∂ÁºñËØë‰∏∫ JSON Ê†ºÂºèÔºåÊúÄÂêé‰ΩøÁî® eunomia-bpf Â∫ìÂä†ËΩΩÂíåËøêË°åÂç≥ÂèØ„ÄÇÂÆåÂÖ®‰∏çÁî®ËÄÉËôë‰ªª‰ΩïÁî®Êà∑ÊÄÅÁöÑËæÖÂä©Á®ãÂ∫èÔºåÂåÖÊã¨ Wasm Âú®ÂÜÖ„ÄÇÂÖ∑‰ΩìÂèØ‰ª•ÂèÇËÄÉÊàë‰ª¨ÁöÑ‰ΩøÁî®ÊâãÂÜå[7]ÊàñÁ§∫‰æã‰ª£Á†Å[8]„ÄÇ</p>
<h2 id="ÂéüÁêÜ"><a class="header" href="#ÂéüÁêÜ">ÂéüÁêÜ</a></h2>
<p><code>ecli</code> ÊòØÂü∫‰∫éÊàë‰ª¨Â∫ïÂ±ÇÁöÑ eunomia-bpf Â∫ìÂíåËøêË°åÊó∂ÂÆûÁé∞ÁöÑ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑„ÄÇÊàë‰ª¨ÁöÑÈ°πÁõÆÊû∂ÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="img/eunomia-arch.png" alt="arch" /></p>
<p><code>ecli</code> Â∑•ÂÖ∑Âü∫‰∫é <code>ewasm</code> Â∫ìÂÆûÁé∞Ôºå<code>ewasm</code> Â∫ìÂåÖÂê´‰∏Ä‰∏™ WAMR(wasm-micro-runtime) ËøêË°åÊó∂Ôºå‰ª•ÂèäÂü∫‰∫é libbpf Â∫ìÊûÑÂª∫ÁöÑ eBPF Âä®ÊÄÅË£ÖËΩΩÊ®°Âùó„ÄÇÂ§ßËá¥Êù•ËØ¥ÔºåÊàë‰ª¨Âú® <code>Wasm</code> ËøêË°åÊó∂ÂíåÁî®Êà∑ÊÄÅÁöÑ <code>libbpf</code> ‰∏≠Èó¥Â§öÂä†‰∫Ü‰∏ÄÂ±ÇÊäΩË±°Â±ÇÔºà<code>eunomia-bpf</code> Â∫ìÔºâÔºå‰ΩøÂæó‰∏ÄÊ¨°ÁºñËØë„ÄÅÂà∞Â§ÑËøêË°åÁöÑ eBPF ‰ª£Á†ÅÂèØ‰ª•‰ªé JSON ÂØπË±°‰∏≠Âä®ÊÄÅÂä†ËΩΩ„ÄÇJSON ÂØπË±°‰ºöÂú®ÁºñËØëÊó∂Ë¢´ÂåÖÂê´Âú® Wasm Ê®°Âùó‰∏≠ÔºåÂõ†Ê≠§Âú®ËøêË°åÊó∂ÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøáËß£Êûê JSON ÂØπË±°Êù•Ëé∑Âèñ eBPF Á®ãÂ∫èÁöÑ‰ø°ÊÅØÔºåÁÑ∂ÂêéÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫è„ÄÇ</p>
<p>‰ΩøÁî® Wasm Êàñ JSON ÁºñËØëÂàÜÂèë eBPF Á®ãÂ∫èÁöÑÊµÅÁ®ãÂõæÂ§ßËá¥Â¶Ç‰∏ãÔºö</p>
<pre><code class="language-mermaid">graph TD
  b3--&gt;package
  b4--&gt;a3
  package--&gt;a1
  package(ÂèØÈÄöËøáÁΩëÁªúÊàñÂÖ∂‰ªñ‰ªªÊÑèÊñπÂºèËøõË°åÂàÜÂèë: CO-RE)

  subgraph ËøêË°åÊó∂Âä†ËΩΩÂô®Â∫ì
  a3(ËøêË°å Wasm Ê®°ÂùóÈÖçÁΩÆ eBPF Á®ãÂ∫èÊàñÂíå eBPF Á®ãÂ∫è‰∫§‰∫í)
  a1(Ê†πÊçÆ JSON ÈÖçÁΩÆ‰ø°ÊÅØÂä®ÊÄÅË£ÖËΩΩ eBPF Á®ãÂ∫è)
  a2(Ê†πÊçÆÁ±ªÂûã‰ø°ÊÅØÂíåÂÜÖÂ≠òÂ∏ÉÂ±Ä‰ø°ÊÅØÂØπÂÜÖÊ†∏ÊÄÅÂØºÂá∫‰∫ã‰ª∂ËøõË°åÂä®ÊÄÅÂ§ÑÁêÜ)
  a1--&gt;a2
  a3--&gt;a1
  a2--&gt;a3
  end

  subgraph eBPFÁºñËØëÂ∑•ÂÖ∑Èìæ
  b1(‰ΩøÁî® Clang ÁºñËØë eBPF Á®ãÂ∫èËé∑ÂæóÂåÖÂê´ÈáçÂÆö‰Ωç‰ø°ÊÅØÁöÑ bpf.o)
  b2(Ê∑ªÂä†‰ªé eBPF Ê∫ê‰ª£Á†ÅËé∑ÂèñÁöÑÂÜÖÊ†∏ÊÄÅÂØºÂá∫Êï∞ÊçÆÁöÑÂÜÖÂ≠òÂ∏ÉÂ±Ä, Á±ªÂûã‰ø°ÊÅØÁ≠â)
  b3(ÊâìÂåÖÁîüÊàê JSON Êï∞ÊçÆ)
  b4(ÊâìÂåÖÊàê Wasm Ê®°ÂùóËøõË°åÂàÜÂèë)
  b5(ÂèØÈÄâÁöÑÁî®Êà∑ÊÄÅÊï∞ÊçÆÂ§ÑÁêÜÁ®ãÂ∫èÁºñËØë‰∏∫ Wasm)
  b2--&gt;b3
  b3--&gt;b5
  b5--&gt;b4
  b1--&gt;b2
  end
</code></pre>
<p>Â§ßËá¥Êù•ËØ¥ÔºåÊï¥‰∏™ eBPF Á®ãÂ∫èÁöÑÁºñÂÜôÂíåÂä†ËΩΩÂàÜ‰∏∫‰∏â‰∏™ÈÉ®ÂàÜÔºö</p>
<ol>
<li>Áî® eunomia-cc Â∑•ÂÖ∑ÈìæÂ∞ÜÂÜÖÊ†∏ÁöÑ eBPF ‰ª£Á†ÅÈ™®Êû∂ÂíåÂ≠óËäÇÁ†ÅÁºñËØë‰∏∫ JSON Ê†ºÂºè</li>
<li>Âú®Áî®Êà∑ÊÄÅÂºÄÂèëÁöÑÈ´òÁ∫ßËØ≠Ë®ÄÔºà‰æãÂ¶Ç C ËØ≠Ë®ÄÔºâ‰∏≠ÂµåÂÖ• JSON Êï∞ÊçÆÔºåÂπ∂Êèê‰æõ‰∏Ä‰∫õ API Áî®‰∫éÊìç‰Ωú JSON ÂΩ¢ÊÄÅÁöÑ eBPF Á®ãÂ∫èÈ™®Êû∂</li>
<li>Â∞ÜÁî®Êà∑ÊÄÅÁ®ãÂ∫èÂíå JSON Êï∞ÊçÆ‰∏ÄËµ∑ÁºñËØë‰∏∫ Wasm Â≠óËäÇÁ†ÅÂπ∂ÊâìÂåÖ‰∏∫ Wasm Ê®°ÂùóÔºåÁÑ∂ÂêéÂú®ÁõÆÊ†áÊú∫Âô®‰∏äÂä†ËΩΩÂπ∂ËøêË°å Wasm Á®ãÂ∫è</li>
<li>‰ªé Wasm Ê®°Âùó‰∏≠Âä†ËΩΩÂÜÖÂµåÁöÑ JSON Êï∞ÊçÆÔºåÁî® eunomia-bpf Â∫ìÂä®ÊÄÅË£ÖËΩΩÂíåÈÖçÁΩÆ eBPF Á®ãÂ∫èÈ™®Êû∂„ÄÇ</li>
</ol>
<p>Êàë‰ª¨ÈúÄË¶ÅÂÆåÊàêÁöÑ‰ªÖ‰ªÖÊòØÂ∞ëÈáèÁöÑ native API Âíå Wasm ËøêË°åÊó∂ÁöÑÁªëÂÆöÔºåÂπ∂‰∏îÂú® Wasm ‰ª£Á†Å‰∏≠Â§ÑÁêÜ JSON Êï∞ÊçÆ„ÄÇ‰Ω†ÂèØ‰ª•Âú®‰∏Ä‰∏™Âçï‰∏ÄÁöÑ <code>Wasm</code> Ê®°Âùó‰∏≠Êã•ÊúâÂ§ö‰∏™ <code>eBPF</code> Á®ãÂ∫è„ÄÇÂ¶ÇÊûú‰∏ç‰ΩøÁî®Êàë‰ª¨Êèê‰æõÁöÑ Wasm ËøêË°åÊó∂ÔºåÊàñËÄÖÊÉ≥Ë¶Å‰ΩøÁî®ÂÖ∂‰ªñËØ≠Ë®ÄËøõË°åÁî®Êà∑ÊÄÅÁöÑ eBPF ËæÖÂä©‰ª£Á†ÅÁöÑÂºÄÂèëÔºåÂú®Êàë‰ª¨Êèê‰æõÁöÑ <code>eunomia-bpf</code> Â∫ìÂü∫Á°Ä‰∏äÂÆåÊàê‰∏Ä‰∫õ WebaAssembly ÁöÑÁªëÂÆöÂç≥ÂèØ„ÄÇ</p>
<p>Âè¶Â§ñÔºåÂØπ‰∫é eunomia-bpf Â∫ìËÄåË®ÄÔºå‰∏çÈúÄË¶Å Wasm Ê®°ÂùóÂíåËøêË°åÊó∂ÂêåÊ†∑ÂèØ‰ª•ÂêØÂä®ÂíåÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫èÔºå‰∏çËøáÊ≠§Êó∂Âä®ÊÄÅÂä†ËΩΩËøêË°åÁöÑÂ∞±Âè™ÊòØÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫èÂ≠óËäÇÁ†Å„ÄÇ‰Ω†ÂèØ‰ª•ÊâãÂä®Êàñ‰ΩøÁî®‰ªªÊÑèËØ≠Ë®Ä‰øÆÊîπ JSON ÂØπË±°Êù•ÊéßÂà∂ eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÂèÇÊï∞ÔºåÂπ∂‰∏îÈÄöËøá eunomia-bpf Ëá™Âä®Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅ‰∏äÊä•ÁöÑËøîÂõûÊï∞ÊçÆ„ÄÇÂØπ‰∫éÂàùÂ≠¶ËÄÖËÄåË®ÄÔºåËøôÂèØËÉΩÊØî‰ΩøÁî® WebAssembly Êõ¥Âä†ÁÆÄÂçïÊñπ‰æøÔºöÂè™ÈúÄË¶ÅÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫èÔºåÁÑ∂Âêé‰ΩøÁî® eunomia-cc Â∑•ÂÖ∑ÈìæÂ∞ÜÂÖ∂ÁºñËØë‰∏∫ JSON Ê†ºÂºèÔºåÊúÄÂêé‰ΩøÁî® eunomia-bpf Â∫ìÂä†ËΩΩÂíåËøêË°åÂç≥ÂèØ„ÄÇÂÆåÂÖ®‰∏çÁî®ËÄÉËôë‰ªª‰ΩïÁî®Êà∑ÊÄÅÁöÑËæÖÂä©Á®ãÂ∫èÔºåÂåÖÊã¨ Wasm Âú®ÂÜÖ„ÄÇÂÖ∑‰ΩìÂèØ‰ª•ÂèÇËÄÉÊàë‰ª¨ÁöÑ‰ΩøÁî®ÊâãÂÜå[7]ÊàñÁ§∫‰æã‰ª£Á†Å[8]„ÄÇ</p>
<h2 id="‰∏∫Êàë‰ª¨ÁöÑÈ°πÁõÆË¥°ÁåÆ‰ª£Á†Å"><a class="header" href="#‰∏∫Êàë‰ª¨ÁöÑÈ°πÁõÆË¥°ÁåÆ‰ª£Á†Å">‰∏∫Êàë‰ª¨ÁöÑÈ°πÁõÆË¥°ÁåÆ‰ª£Á†Å</a></h2>
<p>Êàë‰ª¨ÁöÑÈ°πÁõÆËøòÂú®Êó©ÊúüÈò∂ÊÆµÔºåÂõ†Ê≠§ÈùûÂ∏∏Â∏åÊúõÊúâÊÇ®ÁöÑÂ∏ÆÂä©Ôºö</p>
<ul>
<li>ËøêË°åÊó∂Â∫ìÂú∞ÂùÄÔºö <a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>ÁºñËØëÂô®Âú∞ÂùÄÔºö <a href="https://github.com/eunomia-bpf/eunomia-cc">https://github.com/eunomia-bpf/eunomia-cc</a></li>
<li>ÊñáÊ°£Ôºö<a href="https://github.com/eunomia-bpf/eunomia-bpf.github.io">https://github.com/eunomia-bpf/eunomia-bpf.github.io</a></li>
</ul>
<p>eunomia-bpf ‰πüÂ∑≤ÁªèÂä†ÂÖ•‰∫ÜÈæôËú•Á§æÂå∫Ôºö</p>
<ul>
<li>gitee ÈïúÂÉèÔºö<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
</ul>
<p>ÊÇ®ÂèØ‰ª•Â∏ÆÂä©Êàë‰ª¨Ê∑ªÂä†ÊµãËØïÊàñËÄÖÁ§∫‰æãÔºåÂèØ‰ª•ÂèÇËÄÉÔºö</p>
<ul>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools">examples/bpftools</a></li>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/tests">bpftools/tests</a></li>
</ul>
<p>Áî±‰∫éÁé∞Âú® API Ëøò‰∏çÁ®≥ÂÆöÔºåÂ¶ÇÊûúÊÇ®Âú®ËØïÁî®‰∏≠ÈÅáÂà∞‰ªª‰ΩïÈóÆÈ¢òÊàñËÄÖ‰ªª‰ΩïÊµÅÁ®ã/ÊñáÊ°£‰∏çÂÆåÂñÑÁöÑÂú∞ÊñπÔºåËØ∑Âú® gitee Êàñ github issue ÁïôË®ÄÔºå
Êàë‰ª¨‰ºöÂ∞ΩÂø´‰øÆÂ§çÔºõ‰πüÈùûÂ∏∏Ê¨¢ËøéËøõ‰∏ÄÊ≠•ÁöÑ PR Êèê‰∫§ÂíåË¥°ÁåÆÔºÅ‰πüÈùûÂ∏∏Â∏åÊúõÊÇ®ËÉΩÊèêÂá∫‰∏Ä‰∫õÂÆùË¥µÁöÑÊÑèËßÅÊàñËÄÖÂª∫ËÆÆÔºÅ</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="Âú®Á∫ø‰ΩìÈ™åÁΩëÁ´ô"><a class="header" href="#Âú®Á∫ø‰ΩìÈ™åÁΩëÁ´ô">Âú®Á∫ø‰ΩìÈ™åÁΩëÁ´ô</a></h1>
<p>ÂèØ‰ΩøÁî® bolipi Êèê‰æõÁöÑÂú®Á∫ø‰ΩìÈ™åÊúçÂä°ÔºåÂú®Á∫øÁºñËØëÔºåÂú®Á∫øËøêË°å„ÄÅÂú®Á∫øËé∑ÂèñÂèØËßÜÂåñÁªìÊûúÔºö<a href="https://bolipi.com/ebpf/home/online">https://bolipi.com/ebpf/home/online</a></p>
<p><img src="img/online.png" alt="imga" /></p>
<h2 id="ÈÄöËøáÂú®Á∫øÁºñËØëËøêË°åÂø´ÈÄü‰ΩìÈ™å-ebpf-ÂíåÂèØËßÜÂåñ"><a class="header" href="#ÈÄöËøáÂú®Á∫øÁºñËØëËøêË°åÂø´ÈÄü‰ΩìÈ™å-ebpf-ÂíåÂèØËßÜÂåñ">ÈÄöËøáÂú®Á∫øÁºñËØëËøêË°åÂø´ÈÄü‰ΩìÈ™å eBPF ÂíåÂèØËßÜÂåñ</a></h2>
<p>Êú¨Âú®Á∫øÁºñËØëÂπ≥Âè∞Áî± <code>eunomia-bpf</code> Â∑•ÂÖ∑ÈìæÊèê‰æõÊîØÊåÅÔºåËØ¶ÁªÜÊñáÊ°£ËØ∑ÂèÇËÄÉ <a href="https://eunomia-bpf.github.io/">eunomia-bpf.github.io/</a></p>
<h3 id="Âú®Á∫øÁºñËØë"><a class="header" href="#Âú®Á∫øÁºñËØë">Âú®Á∫øÁºñËØë</a></h3>
<p>Âú®‰ª£Á†ÅÁºñËæëÂô®‰∏≠ÁºñÂÜô eBPF ÁöÑÂÜÖÊ†∏ÊÄÅÁ®ãÂ∫èÔºåÂ∫îÂΩìÈÅµÂæ™ libbpf-tools ÁöÑÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÁºñÂÜôÁ∫¶ÂÆöÔºåÂç≥Ôºö</p>
<ul>
<li><code>‰ª£Á†ÅÁºñËæëÂô®</code> (*.bpf.c) ÂåÖÂê´ BPF C ‰ª£Á†ÅÔºåÂÆÉË¢´ÁºñËØëÊàê package.json</li>
<li><code>Â§¥Êñá‰ª∂ÁºñËæëÂô®</code> (*.h) ÂèØ‰ª•ÈÄâÊã©ÂåÖÂê´ÈÄöËøá perf event ÊàñÁéØÂΩ¢ÁºìÂÜ≤Âå∫ÂØºÂá∫Âà∞Áî®Êà∑Á©∫Èó¥ÁöÑÁ±ªÂûã</li>
</ul>
<p>Êàë‰ª¨ÁõÆÂâçÂè™ÊîØÊåÅ‰ΩøÁî®Âü∫‰∫é libbpf ÁöÑÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÔºåBCC ‰ª£Á†ÅÊîØÊåÅÁî±‰∫éÂ≠òÂú®‰∏Ä‰∫õËØ≠Ê≥ï‰∏äÁöÑÂ∑ÆÂºÇÔºåËøòÂú®ÂºÄÂèë‰∏≠„ÄÇ</p>
<p>ÁºñÂÜôÂÆåÊàê‰ª£Á†ÅÂêéÔºåÁÇπÂáª <code>ÁºñËØë</code> ÊåâÈíÆÂç≥ÂèØÁºñËØëÊàê eBPF ÁöÑÂÜÖÊ†∏ÊÄÅÁ®ãÂ∫èÔºåÂú® <code>ÁºñËØëËæìÂá∫</code> ‰∏≠Êü•ÁúãÁºñËØëËæìÂá∫Ôºö</p>
<p><img src="img/compile-output.png" alt="imgb" /></p>
<p>Êõ¥Â§ö‰ø°ÊÅØËØ∑ÂèÇËÄÉÔºö<a href="https://eunomia-bpf.github.io/mannual.html">eunomia-bpf.github.io/mannual.html</a></p>
<p>Êõ¥Â§ö‰æãÂ≠êËØ∑ÂèÇËÄÉÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools</a></p>
<h3 id="Âú®Á∫øËøêË°å"><a class="header" href="#Âú®Á∫øËøêË°å">Âú®Á∫øËøêË°å</a></h3>
<p>ÁÇπÂáªÂè≥‰æßÁöÑÁªøËâ≤ËøêË°åÊåâÈíÆËøêË°åÔºö</p>
<p><img src="img/run-ebpf.png" alt="imgc" /></p>
<p>‰πüÂèØ‰ª•ÈÄöËøá <code>‰∏ãËΩΩÁºñËØëÂêéÁöÑÊñá‰ª∂</code> Êü•ÁúãÁºñËØëÂ•ΩÁöÑÁ®ãÂ∫èÔºåÂπ∂Âú®Êú¨Âú∞‰ΩøÁî® <code>ecli</code> Áõ¥Êé•ËøêË°åÔºö</p>
<pre><code class="language-console">$ # ‰∏ãËΩΩÂÆâË£Ö ecli ‰∫åËøõÂà∂
$ wget https://aka.pw/bpf-ecli -O ./ecli &amp;&amp; chmod +x ./ecli
$ # ËøêË°å eBPF Á®ãÂ∫èÔºàroot shellÔºâ
$ sudo ./ecli run package.json
</code></pre>
<h3 id="‰ΩøÁî®-prometheus-Âú®Á∫øËé∑ÂèñÂèØËßÜÂåñÁªìÊûú"><a class="header" href="#‰ΩøÁî®-prometheus-Âú®Á∫øËé∑ÂèñÂèØËßÜÂåñÁªìÊûú">‰ΩøÁî® Prometheus Âú®Á∫øËé∑ÂèñÂèØËßÜÂåñÁªìÊûú</a></h3>
<p>ÁÇπÂáª <code>ËøêË°åÂèØËßÜÂåñÁªÑ‰ª∂</code> ÊåâÈíÆÔºåÂú®ÂºπÂá∫ÁöÑÁ™óÂè£‰∏≠ÈÖçÁΩÆ prometheus metrics ‰ø°ÊÅØ:</p>
<p><img src="img/prometheus-config.png" alt="imgd" /></p>
<p>ÁÇπÂáª <code>Á°ÆÂÆö</code> Âç≥ÂèØË∑≥ËΩ¨Âà∞ Prometheus ÁïåÈù¢ÔºåÂèØÈÄöËøáÈÄâÊã© graph Êü•ÁúãÂèØËßÜÂåñÁªìÊûúÔºö</p>
<p><img src="img/prometheus-graph.png" alt="imgd" /></p>
<h2 id="ÂÖ≥‰∫é-eunomia-bpf"><a class="header" href="#ÂÖ≥‰∫é-eunomia-bpf">ÂÖ≥‰∫é eunomia-bpf</a></h2>
<p>eunomia-bpf ÊòØ‰∏ÄÂ•óÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂Ôºå‰ª•Âèä‰∏Ä‰∫õÈôÑÂä†È°πÁõÆÔºåÊàë‰ª¨Â∏åÊúõÂÅöÂà∞ËÆ© eBPF Á®ãÂ∫èÔºö</p>
<ul>
<li>ËÆ© eBPF Á®ãÂ∫èÁöÑÁºñËØëÂíåËøêË°åËøáÁ®ãÂ§ßÂ§ßÁÆÄÂåñÔºåÊäõÂéªÁπÅÁêêÁöÑÁî®Êà∑ÊÄÅÊ®°ÊùøÁºñÂÜô„ÄÅÁπÅÁêêÁöÑ BCC ÂÆâË£ÖÊµÅÁ®ãÔºåÂè™ÈúÄË¶ÅÁºñÂÜôÂÜÖÊ†∏ÊÄÅ eBPF Á®ãÂ∫èÔºåÁºñËØëÂêéÂç≥ÂèØÂú®‰∏çÂêåÊú∫Âô®‰∏ä‰ªªÊÑèÂÜÖÊ†∏ÁâàÊú¨‰∏ãËøêË°åÔºåÂπ∂‰∏îËΩªÊùæËé∑ÂèñÂèØËßÜÂåñÁªìÊûú„ÄÇ</li>
<li>ÁúüÊ≠£ÂÉè JavaScript ÊàñËÄÖ Wasm ÈÇ£Ê†∑Êòì‰∫éÂàÜÂèëÂíåËøêË°åÔºåÊàñËÄÖËØ¥ÂÜÖÊ†∏ÊÄÅÊàñÂèØËßÇÊµãÊÄßÂ±ÇÈù¢ÁöÑ FaaSÔºöeBPF Âç≥ÊúçÂä°ÔºåÈÄöËøá API ËØ∑Ê±ÇÂø´ÈÄüÂàÜÂèëÂíåËøêË°åÔºåÊó†ÈúÄÁÆ°ÁêÜÂü∫Á°ÄËÆæÊñΩÂíåÁî®Êà∑ÊÄÅÂä†ËΩΩÁ®ãÂ∫èÔºõ</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="common-problem"><a class="header" href="#common-problem">common problem</a></h1>
<p>if you get a error like <code>/usr/lib/x86_64-linux-gnu/libstdc++.so.6: version GLIBCXX_3.4.29 not found</code> on old version kernels,</p>
<p>try:</p>
<pre><code class="language-console">sudo apt-get upgrade libstdc++6
</code></pre>
<p>see https://stackoverflow.com/questions/65349875/where-can-i-find-glibcxx-3-4-29</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="supporting-external-btf"><a class="header" href="#supporting-external-btf">supporting external BTF</a></h1>
<p>1.Á°ÆËÆ§ÂÜÖÊ†∏BTFÈÄâÈ°πÂ∑≤ÁªèÊâìÂºÄ</p>
<pre><code class="language-conf">CONFIG_DEBUG_INFO=y
CONFIG_DEBUG_INFO_BTF=y
</code></pre>
<p>Â¶ÇÊûúÂÜÖÊ†∏ÈÄâÈ°πÊú™ÂºÄÂêØÔºåÂ∞±ÈúÄË¶ÅÈáçÊñ∞ÁºñËØëÂÜÖÊ†∏</p>
<ol start="2">
<li>Á°ÆËÆ§ÂΩìÂâçÂÜÖÊ†∏BTF‰ø°ÊÅØÊòØÂê¶ÂèØÁî®ÔºåÂ¶Ç‰∏çÂèØÁî®ÈúÄÊ∑ªÂä†Â§ñÊ∫êBTF‰ø°ÊÅØ</li>
</ol>
<p>Ëã•/sys/kernel/btf/vmlinuxÂ≠òÂú®ÔºåÂàôBTFÂèØÁî®ÔºåÂèØÈÄöËøábpftoolÁîüÊàêvmlinux.h</p>
<pre><code class="language-sh">apt install linux-tools-(uname -r)-generic
apt install linux-tools-generic
bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</code></pre>
<p>Ëã•/sys/kernel/btf/vmlinux‰∏çÂ≠òÂú®ÔºåÂàôBTF‰∏çÂèØÁî®ÔºåÂèØÈÄöËøá<a href="https://github.com/aquasecurity/btfhub">btfhub</a>Ê∑ªÂä†Â§ñÊ∫êBTF‰ø°ÊÅØÊàñÁîüÊàêÂΩìÂâçÂÜÖÊ†∏ÁöÑÂÆöÂà∂ÂåñBTF‰ø°ÊÅØ</p>
<p>Ôºà1ÔºâÊ∑ªÂä†Â§ñÊ∫êBTF‰ø°ÊÅØ</p>
<p>ÂèÇËÄÉ <a href="https://github.com/aquasecurity/btfhub/blob/main/docs/generating-tailored-btfs.md">BTFgen tool to create smaller BTF files</a></p>
<pre><code class="language-sh">$ git clone git@github.com:aquasecurity/btfhub.git
$ git clone git@github.com:aquasecurity/btfhub-archive.git
$ cd btfhub ; ls
//Â∞ÜÂÖãÈöÜÁöÑÂΩíÊ°£Êñá‰ª∂ÊîæÂÖ• btfhub ÁõÆÂΩï
$ rsync -avz ../btfhub-archive/ --exclude=.git* --exclude=README.md ./archive/
</code></pre>
<p>Êï¥‰∏™btfhub-archiveÁõÆÂΩïÁõ∏ÂΩìÂ∫ûÂ§ßÔºåÂèØ‰ª•ÂçïÁã¨‰∏ãËΩΩÊüê‰∏™BTFÂΩíÊ°£Êñá‰ª∂ÊîæÂÖ•btfhub ÁõÆÂΩï</p>
<pre><code class="language-sh">$ rsync -avz ../5.11.0-1027-azure.btf.tar.xz --exclude=.git* --exclude=README.md ./archive/
sending incremental file list

sent 77 bytes  received 12 bytes  178.00 bytes/sec
total size is 144,419  speedup is 1,622.69
</code></pre>
<p>‰πãÂêéÂ∞±ÂèØ‰ª•Ê†πÊçÆÊüê‰∏™ÂØπÂ∫îÁöÑeBPF ÂØπË±°ÁîüÊàêÂÆöÂà∂ÁöÑBTF Êñá‰ª∂</p>
<pre><code class="language-sh">#ÁîüÊàêÂÆöÂà∂ÁöÑ eBPF ÂØπË±°ÁöÑ BTF Êñá‰ª∂:
$ ./tools/btfgen.sh -a AARCH64 -o $HOME/****.bpf.core.o
</code></pre>
<p>Ê£ÄÊü•ÂÆöÂà∂ÁöÑÊñ∞ÁîüÊàêÁöÑ BTF Êñá‰ª∂ÂèäÂÖ∂Â∞∫ÂØ∏</p>
<pre><code class="language-sh">$ find custom-archive | grep ubuntu | tail -10
$ls -lah custom-archive/ubuntu/20.04/x86_64/5.8.0-1041-azure.btf
</code></pre>
<p>Ôºà2ÔºâÁîüÊàêÂΩìÂâçÂÜÖÊ†∏ÁöÑÂÆöÂà∂ÂåñBTF‰ø°ÊÅØ</p>
<pre><code class="language-sh">$ sudo ./example-static
$ sudo ./example-c-static
$ sudo EXAMPLE_BTF_FILE=5.8.0-63-generic.btf ./example-static
$ sudo EXAMPLE_BTF_FILE=5.8.0-63-generic.btf ./example-c-static
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="benchmark"><a class="header" href="#benchmark">benchmark</a></h1>
<p>Most of the time, bpf-loader work as a library to load eBPF program. It will not affect eBPF program after the program has been loaded and attached.</p>
<p>TODO: add more benchmark results</p>
<h2 id="benchmark-for-loading-with-exporter"><a class="header" href="#benchmark-for-loading-with-exporter">benchmark for loading with exporter</a></h2>
<p>Take opensnoop from <a href="https://github.com/iovisor/bcc/blob/master/libbpf-tools/opensnoop.bpf.c">bcc/libbpf-tools</a> as an example. starting with BCC, you will need about 0.8s to start the exporter and attach to the probe. With out implement, you only need about <code>50-70ms</code> which is significantly faster.</p>
<pre><code class="language-console">$ ps -aux | grep eunomia
root      171562  0.0  0.0  15176  4576 pts/6    S+   01:08   0:00 sudo ./eunomia-exporter
root      171605  0.1  0.0 350540  7740 pts/6    Sl+  01:08   0:00 ./eunomia-exporter
</code></pre>
<p>The memory usage and CPU usage is also low. see <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/eunomia-sdks/eunomia-otel">eunomia-exporter</a> for more details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="videos"><a class="header" href="#videos">videos</a></h1>
<ul>
<li><a href="https://www.bilibili.com/video/BV1DG4y1N76m/">eunomia-bpf: ‰∏Ä‰∏™ÂºÄÊ∫êÁöÑ ebpf Âä®ÊÄÅÂä†ËΩΩËøêË°åÊó∂ÂíåÂºÄÂèëÂ∑•ÂÖ∑Èìæ</a></li>
<li><a href="https://www.bilibili.com/video/BV1dG411g7G7/">eunomia-bpfÔºöeBPFËΩªÈáèÁ∫ßÂºÄÂèëÊ°ÜÊû∂</a></li>
<li><a href="https://www.bilibili.com/video/BV1vD4y1P78S/">wasm-bpfÔºöeBPF Á®ãÂ∫èÁöÑ WebAssembly ÁºñËØëÂ∑•ÂÖ∑Èìæ‰∏éËøêË°åÊó∂</a></li>
<li><a href="https://www.bilibili.com/video/BV1JN4y1A76k/?vd_source=b2fa9e4d67372fcdc983c3c25b42b628">‰ΩøÁî® WASM ÂºÄÂèëÂíåÂàÜÂèë eBPF Â∫îÁî®</a></li>
<li><a href="https://www.bilibili.com/video/BV1u84y1C7pQ/">„ÄêËææÂù¶ÁßëÊäÄDatenLord„Äëeunomia-bpf: ÁªìÂêà wasm ÁöÑ ebpf ËΩªÈáèÁ∫ßÂºÄÂèëÊ°ÜÊû∂</a></li>
<li><a href="https://www.bilibili.com/video/BV1Hs4y1a7Q8/">eunomia-bpfÔºöË∂ÖÁÆÄÊ¥ÅÁöÑ‰∫ëÁ´ØeBPFÈÉ®ÁΩ≤ÊñπÂºè</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blog"><a class="header" href="#blog">Blog</a></h1>
<p>Blogs about eunomia-bpf:</p>
<ul>
<li><a href="blog/introduce-to-wasm-bpf-bpf-community.html">Wasm-bpf: Êû∂Ëµ∑ Webassembly Âíå eBPF ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢Å</a></li>
<li><a href="blog/how-to-write-c-in-wasm.html">Âú® WebAssembly ‰∏≠‰ΩøÁî® C/C++ Âíå libbpf ÁºñÂÜô eBPF Á®ãÂ∫è</a></li>
<li><a href="blog/how-to-write-rust-in-wasm.html">Âú® WebAssembly ‰∏≠‰ΩøÁî® Rust ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÂèëÂ∏É OCI ÈïúÂÉè</a></li>
<li><a href="blog/GPTtrace.html">‰ΩøÁî® ChatGPT ÔºåÈÄöËøáËá™ÁÑ∂ËØ≠Ë®ÄÁºñÂÜô eBPF Á®ãÂ∫èÂíåËøΩË∏™ Linux Á≥ªÁªü</a></li>
<li><a href="blog/ebpf-wasm.html">ÂΩì Wasm ÈÅáËßÅ eBPF Ôºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫è</a></li>
<li><a href="blog/lmp-eunomia.html">Â¶Ç‰ΩïÂú® Linux ÊòæÂæÆÈïúÔºàLMPÔºâÈ°πÁõÆ‰∏≠ÂºÄÂêØ eBPF ‰πãÊóÖ</a></li>
<li><a href="blog/0.3.0-release.html">eunomia-bpf 0.3.0 ÂèëÂ∏ÉÔºöÂè™ÈúÄÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÔºåËΩªÊùæÊûÑÂª∫„ÄÅÊâìÂåÖ„ÄÅÂèëÂ∏ÉÂÆåÊï¥ÁöÑ eBPF Â∫îÁî®</a></li>
<li><a href="blog/coolbpf-eunomia.html">eunomia-bpfÔºöÂ±ïÊúõ 2023ÔºåËÆ© eBPF Êèí‰∏ä Wasm ÁöÑÁøÖËÜÄ</a></li>
<li><a href="blog/bpf-news.html">eBPF ËøõÈò∂: ÂÜÖÊ†∏Êñ∞ÁâπÊÄßËøõÂ±ï‰∏ÄËßà</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wasm-bpf-Êû∂Ëµ∑-webassembly-Âíå-ebpf-ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢Å"><a class="header" href="#wasm-bpf-Êû∂Ëµ∑-webassembly-Âíå-ebpf-ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢Å">Wasm-bpf: Êû∂Ëµ∑ Webassembly Âíå eBPF ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢Å</a></h1>
<blockquote>
<p>‰ΩúËÄÖÔºöÈÉëÊò±Á¨ôÔºåÈôàËåÇÊûó</p>
</blockquote>
<p>Wasm ÊúÄÂàùÊòØ‰ª•ÊµèËßàÂô®ÂÆâÂÖ®Ê≤ôÁõí‰∏∫ÁõÆÁöÑÂºÄÂèëÁöÑÔºåÂèëÂ±ïÂà∞ÁõÆÂâç‰∏∫Ê≠¢ÔºåWebAssembly Â∑≤ÁªèÊàê‰∏∫‰∏Ä‰∏™Áî®‰∫é‰∫ëÂéüÁîüËΩØ‰ª∂ÁªÑ‰ª∂ÁöÑÈ´òÊÄßËÉΩ„ÄÅË∑®Âπ≥Âè∞ÂíåÂ§öËØ≠Ë®ÄËΩØ‰ª∂Ê≤ôÁÆ±ÁéØÂ¢ÉÔºåWasm ËΩªÈáèÁ∫ßÂÆπÂô®‰πüÈùûÂ∏∏ÈÄÇÂêà‰Ωú‰∏∫‰∏ã‰∏Ä‰ª£Êó†ÊúçÂä°Âô®Âπ≥Âè∞ËøêË°åÊó∂„ÄÇÂè¶‰∏Ä‰∏™‰ª§‰∫∫ÂÖ¥Â•ãÁöÑË∂ãÂäøÊòØ eBPF ÁöÑÂÖ¥Ëµ∑ÔºåÂÆÉ‰Ωø‰∫ëÂéüÁîüÂºÄÂèë‰∫∫ÂëòËÉΩÂ§üÊûÑÂª∫ÂÆâÂÖ®ÁöÑÁΩëÁªú„ÄÅÊúçÂä°ÁΩëÊ†ºÂíåÂ§öÁßçÂèØËßÇÊµãÊÄßÁªÑ‰ª∂ÔºåÂπ∂‰∏îÂÆÉ‰πüÂú®ÈÄêÊ≠•Ê∏óÈÄèÂíåÊ∑±ÂÖ•Âà∞ÂÜÖÊ†∏ÁöÑÂêÑ‰∏™ÁªÑ‰ª∂ÔºåÊèê‰æõÊõ¥Âº∫Â§ßÁöÑÂÜÖÊ†∏ÊÄÅÂèØÁºñÁ®ã‰∫§‰∫íËÉΩÂäõ„ÄÇ</p>
<p>Wasm-bpf ÊòØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑÂºÄÊ∫êÈ°πÁõÆ[1]ÔºåÂÆÉÂÆö‰πâ‰∫Ü‰∏ÄÂ•ó eBPF Áõ∏ÂÖ≥Á≥ªÁªüÊé•Âè£ÁöÑÊäΩË±°ÔºåÂπ∂Êèê‰æõ‰∫Ü‰∏ÄÂ•óÂØπÂ∫îÁöÑÂºÄÂèëÂ∑•ÂÖ∑Èìæ„ÄÅÂ∫ì‰ª•ÂèäÈÄöÁî®ÁöÑ Wasm + eBPF ËøêË°åÊó∂Âπ≥Âè∞ÂÆû‰æãÔºåËÆ©‰ªªÊÑè Wasm ËôöÊãüÊú∫ÊàñËÄÖ Wasm ËΩªÈáèÁ∫ßÂÆπÂô®‰∏≠ÁöÑÂ∫îÁî®ÔºåÊúâËÉΩÂäõÂ∞Ü‰ΩøÁî®Âú∫ÊôØ‰∏ãÊ≤âÂíåÊãìÂ±ïÂà∞ÂÜÖÊ†∏ÊÄÅÔºåËé∑ÂèñÂÜÖÊ†∏ÊÄÅÂíåÁî®Êà∑ÊÄÅÁöÑÂá†‰πéÊâÄÊúâÊï∞ÊçÆÔºåÂú®ÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÂ§ö‰∏™ÊñπÈù¢ÂÆûÁé∞ÂØπÊï¥‰∏™Êìç‰ΩúÁ≥ªÁªüÂ±ÇÈù¢ÁöÑÂèØÁºñÁ®ãÊéßÂà∂Ôºå‰ªéËÄåÊûÅÂ§ßÁöÑÊãìÂ±ï WebAssembly ÁîüÊÄÅÂú®ÈùûÊµèËßàÂô®Á´ØÁöÑÂ∫îÁî®Âú∫ÊôØ„ÄÇ</p>
<h2 id="Âü∫‰∫é-ebpf-ÁöÑÁ≥ªÁªüÊé•Âè£‰∏∫‰∫ëÂéüÁîü-webassembly-Â∏¶Êù•Êõ¥Â§öÂèØËÉΩ"><a class="header" href="#Âü∫‰∫é-ebpf-ÁöÑÁ≥ªÁªüÊé•Âè£‰∏∫‰∫ëÂéüÁîü-webassembly-Â∏¶Êù•Êõ¥Â§öÂèØËÉΩ">Âü∫‰∫é eBPF ÁöÑÁ≥ªÁªüÊé•Âè£Ôºå‰∏∫‰∫ëÂéüÁîü WebAssembly Â∏¶Êù•Êõ¥Â§öÂèØËÉΩ</a></h2>
<h3 id="wasm--wasi"><a class="header" href="#wasm--wasi">Wasm &amp; WASI</a></h3>
<p>‰πüËÆ∏‰Ω†‰πüÂ∑≤ÁªèÁúãËøá Solomon Hykes (DockerÁöÑÂàõÂßã‰∫∫‰πã‰∏Ä)ËøôÂè•ËØùÔºö</p>
<blockquote>
<p>Â¶ÇÊûúÂú®2008Âπ¥Â∑≤ÁªèÊúâ‰∫Ü Wasm + WASIÔºåÊàë‰ª¨Ê†πÊú¨‰∏çÈúÄË¶ÅÂàõÂª∫ Docker„ÄÇ Wasm Â∞±ÊúâËøô‰πàÈáçË¶Å„ÄÇ ÊúçÂä°Á´ØÁöÑ WebAssembly ÊòØËÆ°ÁÆóÁöÑÊú™Êù•„ÄÇ</p>
</blockquote>
<p>2022 Âπ¥ÔºåWebAssemblyÔºàÈÄöÂ∏∏Áº©ÂÜô‰∏∫ WasmÔºâÊàê‰∏∫‰∫ÜÁÑ¶ÁÇπÔºöÊñ∞ÁöÑ Wasm ÂàùÂàõ‰ºÅ‰∏öÂá∫Áé∞ÔºåËÄÅÁâåÂÖ¨Âè∏ÂÆ£Â∏ÉÊîØÊåÅ WasmÔºåBytecode Alliance ÂèëÂ∏É‰∫ÜËÆ∏Â§ö Wasm Ê†áÂáÜÔºåCloud Native Computing Foundation ‰∏æÂäû‰∫Ü‰∏§Ê¨° WasmDay Ê¥ªÂä®ÔºåËÄåÂÖ∂‰∏≠ÊúÄÂ§ßÁöÑ Wasm Áî®Êà∑‰πã‰∏Ä Figma Ë¢´ Adobe ‰ª•ÊÉä‰∫∫ÁöÑ 200 ‰∫øÁæéÂÖÉÁöÑ‰ª∑Ê†ºÊî∂Ë¥≠[2]„ÄÇ</p>
<p>Wasm ÊòØ‰∏ÄÁßç‰∫åËøõÂà∂Ê†ºÂºè„ÄÇËÆ∏Â§ö‰∏çÂêåÁöÑËØ≠Ë®ÄÈÉΩÂèØ‰ª•ÁºñËØë‰∏∫Áõ∏ÂêåÁöÑÊ†ºÂºèÔºåÂπ∂‰∏îËØ•‰∫åËøõÂà∂Ê†ºÂºèÂèØ‰ª•Âú®Â§ßÈáèÊìç‰ΩúÁ≥ªÁªüÂíå‰ΩìÁ≥ªÁªìÊûÑ‰∏äËøêË°å„ÄÇJava Âíå .NET Âú®ËøôÊñπÈù¢‰πüÂæàÁõ∏‰ººÔºå‰ΩÜÊòØ Wasm Êúâ‰∏Ä‰∏™ÈáçË¶ÅÁöÑÂå∫Âà´ÔºöWasm ËøêË°åÊó∂‰∏ç‰ø°‰ªªÊâßË°åÁöÑ‰∫åËøõÂà∂Êñá‰ª∂„ÄÇWasm Â∫îÁî®Á®ãÂ∫èË¢´ÈöîÁ¶ªÂú®Ê≤ôÁõí‰∏≠ÔºåÂè™ËÉΩËÆøÈóÆÁî®Êà∑ÊòéÁ°ÆÂÖÅËÆ∏ÁöÑËµÑÊ∫êÔºàÂ¶ÇÊñá‰ª∂ÊàñÁéØÂ¢ÉÂèòÈáèÔºâ„ÄÇWasm ËøòÊúâËÆ∏Â§öÂÖ∂‰ªñÁêÜÊÉ≥ÁöÑÁâπÊÄßÔºà‰æãÂ¶ÇÈùûÂ∏∏Âá∫Ëâ≤ÁöÑÊÄßËÉΩÔºâÔºå‰ΩÜÊ≠£ÊòØÂÆÉÁöÑÂÆâÂÖ®Ê®°Âûã‰Ωø Wasm Âú®ÂπøÊ≥õÁöÑÁéØÂ¢É‰∏≠‰ΩøÁî®Ôºå‰ªéÊµèËßàÂô®Âà∞ËæπÁºòÂíå IoTÔºåÁîöËá≥Âà∞‰∫ëÁ´Ø[3]„ÄÇ</p>
<p>Âõ†‰∏∫Êó†Ê≥ï‰æùËµñÊµèËßàÂô®‰∏≠Áé∞ÊúâÂèØÁî®ÁöÑ JavaScript ÂºïÊìéÊé•Âè£ÔºåÊâÄ‰ª•ÁõÆÂâçÂ§ßÂ§öÊï∞Âú®ÊµèËßàÂô®Â§ñËøêË°åÁöÑ Wasm ËΩªÈáèÁ∫ßÂÆπÂô®ÈúÄË¶Å‰ΩøÁî® WASIÔºàWebAssembly Á≥ªÁªüÊé•Âè£Ôºâ„ÄÇËøô‰∫õËøêË°åÊó∂ÂÖÅËÆ∏ Wasm Â∫îÁî®Á®ãÂ∫è‰ª•‰∏é POSIX Á±ª‰ººÔºà‰ΩÜ‰∏çÂÆåÂÖ®Áõ∏ÂêåÔºâÁöÑÊñπÂºè‰∏éÂÖ∂ host Êìç‰ΩúÁ≥ªÁªü‰∫§‰∫í„ÄÇ</p>
<p>‰ΩÜÊòØÔºåÁõ∏ÂØπ‰∫é‰º†ÁªüÁöÑÂÆπÂô®‰∏≠ÂèØ‰ª•‰ΩøÁî®Âá†‰πéÊâÄÊúâÁöÑÁ≥ªÁªüË∞ÉÁî®ÔºåÁõÆÂâç WASI ÊâÄËÉΩÊèê‰æõÁöÑÁ≥ªÁªüËµÑÊ∫êÈùûÂ∏∏ÊúâÈôêÔºåÁõÆÂâç‰ªÖ‰ªÖÂú®Êñá‰ª∂Á≥ªÁªü„ÄÅsocket ÁΩëÁªúËøûÊé•Á≠âÊñπÈù¢Êèê‰æõ‰∫Ü‰∏Ä‰∫õÂü∫Êú¨ÁöÑÊîØÊåÅÔºåÂØπ‰∫éÊìç‰ΩúÁ≥ªÁªüÂ∫ïÂ±ÇËµÑÊ∫êÁöÑËÆøÈóÆ„ÄÅÊéßÂà∂ÂíåÁÆ°ÁêÜËÉΩÂäõ‰ªçÁÑ∂Â≠òÂú®Â§ßÈáèÁ©∫ÁôΩÔºå‰æãÂ¶ÇÂØπ Wasm Ê®°ÂùóÊàñËÄÖÂ§ñÈÉ®ÂÖ∂‰ªñËøõÁ®ãÁöÑÊâßË°åËµÑÊ∫êÈôêÂà∂‰∏éË°å‰∏∫ËßÇÊµãÔºåÂØπÁΩëÁªúÂåÖÁöÑÂø´ÈÄüËΩ¨ÂèëÂíåÂ§ÑÁêÜÔºåÁîöËá≥Âíå wasm Ê≤ôÁÆ±Â§ñÁöÑÂÖ∂‰ªñËøõÁ®ãËøõË°åÈÄö‰ø°ÔºåËÆøÈóÆÂ§ñËÆæÁ≠âÔºåÈÉΩÊ≤°Êúâ‰∏Ä‰∏™ÊØîËæÉÊàêÁÜüÁöÑËß£ÂÜ≥ÊñπÊ°à„ÄÇËøô‰πü‰ΩøÂæóÂ§ßÂ§öÊï∞ÁöÑ Wasm ËΩªÈáèÁ∫ßÂÆπÂô®Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ËøòÊòØ‰∏ªË¶ÅÈõÜ‰∏≠‰∫éÁ∫ØÁ≤πÁöÑËÆ°ÁÆóÂØÜÈõÜÂûãÂ∫îÁî®ÔºåËÄåÂú®ÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÊñπÈù¢ÔºåËøòÊòØÈúÄË¶Å‰æùËµñ‰∫é‰º†ÁªüÁöÑÂÆπÂô®ÊäÄÊúØ„ÄÇ</p>
<p>Ëøô‰πüÊòØÊàë‰ª¨Â∏åÊúõÂª∫Á´ã Wasm-bpf È°πÁõÆÁöÑÂàùË°∑ÔºöÂÄüÂä©ÂΩìÂâçÂÜÖÊ†∏ÊÄÅ eBPF Êèê‰æõÁöÑÁ≥ªÁªüÊé•Âè£‰ª•ÂèäÂíåÁî®Êà∑ÊÄÅ‰∫§‰∫íÁöÑËÉΩÂäõÔºåÊãìÂ±ïÊï¥‰∏™ WASI ÁöÑÁîüÊÄÅËìùÂõæÔºå‰∏∫ Wasm Â∫îÁî®Â∏¶Êù•Êõ¥Â§öÂèØËÉΩÁöÑ‰ΩøÁî®Âú∫ÊôØÔºåÂêåÊó∂‰πüËÉΩÂú®Áî®Êà∑ÊÄÅÂ¢ûÂº∫ eBPF Á®ãÂ∫èÁöÑËÉΩÂäõ„ÄÇ</p>
<p>ÊàñËÄÖÊç¢Âè•ËØùËØ¥ÔºåÁ±ª‰ºº‰∫éÊµèËßàÂô®‰∏≠ËøêË°åÁöÑ Wasm Á®ãÂ∫èÔºåÂèØ‰ª•ÈÄöËøá JavaScript ÂºïÊìéÊé•Âè£ËÆøÈóÆÊµèËßàÂô®Êèê‰æõÁöÑÂêÑÁßçÁ≥ªÁªüËµÑÊ∫êÔºåWasm-bpf ÁöÑÊñπÊ°àÂ∞±ÊòØÂÄüÂä© eBPF ËôöÊãüÊú∫Êé•Âè£ËÆøÈóÆÊìç‰ΩúÁ≥ªÁªüÁöÑÂêÑÁ±ªËµÑÊ∫êÔºõÂæóÁõä‰∫é eBPF ÁõÆÂâçÂú® Linux ÂÜÖÊ†∏ÁîöËá≥ Windows Á≠âÂÖ∂‰ªñÊìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑÂπøÊ≥õÊîØÊåÅÔºå‰ª•Âèä‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨ÂíåÊû∂ÊûÑ‰πãÈó¥ÁöÑÂèØÁßªÊ§çÊÄßÔºåÂíåÂÜÖÊ†∏ BPF È™åËØÅÂºïÊìéÁöÑÂèØÈù†ÊÄßÔºåÊàë‰ª¨‰ªçÁÑ∂ÂèØ‰ª•Âú®‰∏ÄÂÆöÁ®ãÂ∫¶‰∏ä‰øùËØÅÂ∫îÁî®ÁöÑÂèØÁßªÊ§çÊÄßÂíåÂÆâÂÖ®ËæπÁïå„ÄÇ</p>
<h3 id="wasm-bpfË∂ÖËΩªÈáèÁ∫ß-wasm--ebpf-ÈÄöÁî®ËøêË°åÊó∂Âπ≥Âè∞"><a class="header" href="#wasm-bpfË∂ÖËΩªÈáèÁ∫ß-wasm--ebpf-ÈÄöÁî®ËøêË°åÊó∂Âπ≥Âè∞">Wasm-bpfÔºöË∂ÖËΩªÈáèÁ∫ß Wasm + eBPF ÈÄöÁî®ËøêË°åÊó∂Âπ≥Âè∞</a></h3>
<p>Wasm-bpf È°πÁõÆÂ∑≤ÁªèÂÆûÁé∞‰∫ÜÂÜÖÊ†∏ÊÄÅ eBPF ËôöÊãüÊú∫ÂíåÁî®Êà∑ÊÄÅ‰πãÈó¥Á≥ªÁªüÊé•Âè£ÂÆåÊï¥ÁöÑÊäΩË±°Êú∫Âà∂ÔºåÂπ∂Êèê‰æõ‰∫ÜÂØπÂ∫îÁöÑÂ∑•ÂÖ∑Èìæ‰ª•Â∞Ü eBPF Â∫îÁî®ÁºñËØë‰∏∫ Wasm Ê®°ÂùóÔºåÂ∏ÆÂä©ËøõË°åÂÜÖÊ†∏ÊÄÅ eBPF ÂíåÁî®Êà∑ÊÄÅ Wasm ‰πãÈó¥Êó†Â∫èÂàóÂåñÔºåÂÖ±‰∫´ÂÜÖÂ≠òÁöÑÈ´òÊïàÂèåÂêëÈÄö‰ø°ÔºåÂπ∂ÈÄöËøá‰ª£Á†ÅÁîüÊàêÊäÄÊúØÔºåÊèê‰æõÂíåÂÖ∂‰ªñÁî®Êà∑ÊÄÅ eBPF ÂºÄÂèëÊ°ÜÊû∂Âá†‰πé‰∏ÄËá¥ÁöÑ„ÄÅÁÆÄÂçï‰æøÊç∑ÁöÑÂºÄÂèë‰ΩìÈ™å„ÄÇÂÄüÂä© Wasm ÁªÑ‰ª∂Ê®°Âûã‰∏çÊñ≠ÂÆåÂñÑÁöÑÁîüÊÄÅÊîØÊåÅÔºåÊàë‰ª¨‰πüÂèØ‰ª•‰∏∫ eBPF Á§æÂå∫Â∏¶Êù•Êõ¥Â§öÁî®Êà∑ÊÄÅÂºÄÂèëËØ≠Ë®ÄÔºå‰∏çÂêåËØ≠Ë®ÄÂÆûÁé∞ÁöÑÂèØËßÇÊµãÊÄß„ÄÅÁΩëÁªúÁ≠â eBPF Â∫îÁî®ÂíåÊï∞ÊçÆÂ§ÑÁêÜÊèí‰ª∂‰πüÂèØ‰ª•Ë¢´ËΩªÊùæÈõÜÊàê„ÄÅÂ§çÁî®„ÄÅÁªü‰∏ÄÁÆ°ÁêÜ„ÄÇ</p>
<p>Âú®Âá†‰πéÂ∑≤ÁªèÊàê‰∏∫ eBPF Áî®Êà∑ÊÄÅ‰∫ãÂÆû‰∏äÁöÑ API Ê†áÂáÜÁöÑ libbpf Â∫ìÔºåÂíå WAMR(wasm-micro-runtime) ‰πã‰∏äÔºåÂè™ÈúÄË¶Å 300+ Ë°å‰ª£Á†ÅÂç≥ÂèØÊûÑÂª∫ÂÆåÊï¥ÁöÑÈÄöÁî® Wasm-eBPF ËøêË°åÁªÑ‰ª∂ÔºåÂπ∂ÊîØÊåÅÂ§ßÂ§öÊï∞ÁöÑ eBPF ‰ΩøÁî®Âú∫ÊôØ -- ‰ªª‰Ωï‰∫∫Áî®‰ªª‰Ωï‰∏ªÊµÅ Wasm ËøêË°åÊó∂ÔºåÊàñËÄÖ‰ªª‰Ωï eBPF Áî®Êà∑ÊÄÅÂ∫ìÔºå‰ª•Âèä‰ªª‰ΩïÁºñÁ®ãËØ≠Ë®ÄÔºåÈÉΩÂèØ‰ª•ËΩªÊùæÊ∑ªÂä†ÂØπÂ∫îÁöÑËôöÊãüÊú∫ÊîØÊåÅÔºåÂπ∂Â§çÁî®Êàë‰ª¨ÁöÑÂ∑•ÂÖ∑ÈìæËΩªÊùæÂÆûÁé∞ Wasm-eBPF Á®ãÂ∫èÁöÑÁºñÂÜôÂíåÂºÄÂèë„ÄÇ</p>
<p>‰πãÂâçÂú® eunomia-bpf È°πÁõÆ‰∏≠ÔºåÂ∑≤ÁªèÊúâ‰∏Ä‰∫õÂ∞Ü eBPF Âíå Wasm ÁªìÂêàÁöÑÊé¢Á¥¢[4]Ôºå‰ΩÜÂÆÉÂπ∂‰∏çÊòØ‰∏∫‰∫Ü Wasm ÂéüÁîüÂ∫îÁî®ÂíåËΩªÈáèÁ∫ßÂÆπÂô®ÁöÑÂú∫ÊôØËÆæËÆ°ÁöÑÔºå‰∏çÁ¨¶Âêà Wasm-eBPF ÁöÑÈÄöÁî®ÁºñÁ®ãÊ®°ÂûãÔºåÂè™ÊòØÂ∞Ü Wasm ‰Ωú‰∏∫Êï∞ÊçÆÂ§ÑÁêÜÊèí‰ª∂ÔºåÊÄßËÉΩ‰πüËæÉ‰∏∫‰Ωé‰∏ã„ÄÇÂõ†Ê≠§Êàë‰ª¨ÂàõÂª∫‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂºÄÊ∫ê‰ªìÂ∫ìÔºåËÆ© Wasm-bpf È°πÁõÆ‰∏ìÊ≥®‰∫éÂà©Áî® eBPF Â¢ûÂº∫ÂíåÊâ©Â±ï WebAssembly ‰ΩøÁî®Âú∫ÊôØÔºåÂπ∂Ëøõ‰∏ÄÊ≠•ÂÆåÂñÑÂØπÂ∫îÁöÑÂ∑•ÂÖ∑ÈìæÂíåÂºÄÂèëÂ∫ìÊîØÊåÅÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a> „ÄÇÂèçËøáÊù•Ôºå‰∏Ä‰∏™ÈÄöÁî®ÁöÑ Wasm-eBPF ÂºÄÂèëÊ°ÜÊû∂ÔºåÂÄüÂä© Wasm Áõ∏ÂÖ≥ÁöÑÁîüÊÄÅ‰πüÂèØ‰ª•‰∏∫ eBPF Áõ∏ÂÖ≥Á§æÂå∫Âú®Áî®Êà∑ÊÄÅÁöÑËøõ‰∏ÄÊ≠•Ê∑±ÂÖ•ÊãìÂ±ïÔºåÊèê‰æõÊõ¥Â§öÁöÑÂèØËÉΩÊÄß„ÄÇ</p>
<h2 id="ebpfÂÆâÂÖ®ÂíåÊúâÊïàÂú∞Êâ©Â±ïÂÜÖÊ†∏"><a class="header" href="#ebpfÂÆâÂÖ®ÂíåÊúâÊïàÂú∞Êâ©Â±ïÂÜÖÊ†∏">eBPFÔºöÂÆâÂÖ®ÂíåÊúâÊïàÂú∞Êâ©Â±ïÂÜÖÊ†∏</a></h2>
<p>eBPF ÊòØ‰∏ÄÈ°πÈù©ÂëΩÊÄßÁöÑÊäÄÊúØÔºåËµ∑Ê∫ê‰∫é Linux ÂÜÖÊ†∏ÔºåÂèØ‰ª•Âú®Êìç‰ΩúÁ≥ªÁªüÁöÑÂÜÖÊ†∏‰∏≠ËøêË°åÊ≤ôÁõíÁ®ãÂ∫è„ÄÇÂÆÉË¢´Áî®Êù•ÂÆâÂÖ®ÂíåÊúâÊïàÂú∞Êâ©Â±ïÂÜÖÊ†∏ÁöÑÂäüËÉΩÔºåËÄå‰∏çÈúÄË¶ÅÊîπÂèòÂÜÖÊ†∏ÁöÑÊ∫ê‰ª£Á†ÅÊàñÂä†ËΩΩÂÜÖÊ†∏Ê®°Âùó„ÄÇeBPF ÈÄöËøáÂÖÅËÆ∏Âú®Êìç‰ΩúÁ≥ªÁªüÂÜÖËøêË°åÊ≤ôÁõíÁ®ãÂ∫èÔºåÂ∫îÁî®Á®ãÂ∫èÂºÄÂèë‰∫∫ÂëòÂèØ‰ª•Âú®ËøêË°åÊó∂ÔºåÂèØÁºñÁ®ãÂú∞ÂêëÊìç‰ΩúÁ≥ªÁªüÂä®ÊÄÅÊ∑ªÂä†È¢ùÂ§ñÁöÑÂäüËÉΩ„ÄÇÁÑ∂ÂêéÔºåÊìç‰ΩúÁ≥ªÁªü‰øùËØÅÂÆâÂÖ®ÂíåÊâßË°åÊïàÁéáÔºåÂ∞±ÂÉèÂú®Âç≥Êó∂ÁºñËØëÔºàJITÔºâÁºñËØëÂô®ÂíåÈ™åËØÅÂºïÊìéÁöÑÂ∏ÆÂä©‰∏ãËøõË°åÊú¨Âú∞ÁºñËØë‰∏ÄÊ†∑„ÄÇeBPF Á®ãÂ∫èÂú®ÂÜÖÊ†∏ÁâàÊú¨‰πãÈó¥ÊòØÂèØÁßªÊ§çÁöÑÔºåÂπ∂‰∏îÂèØ‰ª•Ëá™Âä®Êõ¥Êñ∞Ôºå‰ªéËÄåÈÅøÂÖç‰∫ÜÂ∑•‰ΩúË¥üËΩΩ‰∏≠Êñ≠ÂíåËäÇÁÇπÈáçÂêØ„ÄÇ</p>
<p>‰ªäÂ§©ÔºåeBPFË¢´ÂπøÊ≥õÁî®‰∫éÂêÑÁ±ªÂú∫ÊôØÔºöÂú®Áé∞‰ª£Êï∞ÊçÆ‰∏≠ÂøÉÂíå‰∫ëÂéüÁîüÁéØÂ¢É‰∏≠ÔºåÂèØ‰ª•Êèê‰æõÈ´òÊÄßËÉΩÁöÑÁΩëÁªúÂåÖÂ§ÑÁêÜÂíåË¥üËΩΩÂùáË°°Ôºõ‰ª•ÈùûÂ∏∏‰ΩéÁöÑËµÑÊ∫êÂºÄÈîÄÔºåÂÅöÂà∞ÂØπÂ§öÁßçÁªÜÁ≤íÂ∫¶ÊåáÊ†áÁöÑÂèØËßÇÊµãÊÄßÔºåÂ∏ÆÂä©Â∫îÁî®Á®ãÂ∫èÂºÄÂèë‰∫∫ÂëòË∑üË∏™Â∫îÁî®Á®ãÂ∫èÔºå‰∏∫ÊÄßËÉΩÊïÖÈöúÊéíÈô§Êèê‰æõÊ¥ûÂØüÂäõÔºõ‰øùÈöúÂ∫îÁî®Á®ãÂ∫èÂíåÂÆπÂô®ËøêË°åÊó∂ÁöÑÂÆâÂÖ®ÊâßË°åÔºåÁ≠âÁ≠â„ÄÇÂèØËÉΩÊÄßÊòØÊó†Á©∑ÁöÑÔºåËÄå eBPF Âú®Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏‰∏≠ÊâÄÈáäÊîæÁöÑÂàõÊñ∞ÊâçÂàöÂàöÂºÄÂßã[3]„ÄÇ</p>
<h3 id="ebpf-ÁöÑÊú™Êù•ÂÜÖÊ†∏ÁöÑ-javascript-ÂèØÁºñÁ®ãÊé•Âè£"><a class="header" href="#ebpf-ÁöÑÊú™Êù•ÂÜÖÊ†∏ÁöÑ-javascript-ÂèØÁºñÁ®ãÊé•Âè£">eBPF ÁöÑÊú™Êù•ÔºöÂÜÖÊ†∏ÁöÑ JavaScript ÂèØÁºñÁ®ãÊé•Âè£</a></h3>
<p>ÂØπ‰∫éÊµèËßàÂô®ËÄåË®ÄÔºåJavaScript ÁöÑÂºïÂÖ•Â∏¶Êù•ÁöÑÂèØÁºñÁ®ãÊÄßÂºÄÂêØ‰∫Ü‰∏ÄÂú∫Â∑®Â§ßÁöÑÈù©ÂëΩÔºå‰ΩøÊµèËßàÂô®ÂèëÂ±ïÊàê‰∏∫Âá†‰πéÁã¨Á´ãÁöÑÊìç‰ΩúÁ≥ªÁªü„ÄÇÁé∞Âú®ËÆ©Êàë‰ª¨ÂõûÂà∞ eBPFÔºö‰∏∫‰∫ÜÁêÜËß£ eBPF ÂØπ Linux ÂÜÖÊ†∏ÁöÑÂèØÁºñÁ®ãÊÄßÂΩ±ÂìçÔºåÂØπ Linux ÂÜÖÊ†∏ÁöÑÁªìÊûÑ‰ª•ÂèäÂÆÉÂ¶Ç‰Ωï‰∏éÂ∫îÁî®Á®ãÂ∫èÂíåÁ°¨‰ª∂ËøõË°å‰∫§‰∫íÊúâ‰∏Ä‰∏™È´òÂ±ÇÊ¨°ÁöÑÁêÜËß£ÊòØÊúâÂ∏ÆÂä©ÁöÑ[4]„ÄÇ</p>
<div align="center">
<img src=https://ebpf.io/static/kernel_arch-c0be6286222dcd0e6e45250d2d9a87fd.png width=60% />
</div>
<p>Linux ÂÜÖÊ†∏ÁöÑ‰∏ªË¶ÅÁõÆÁöÑÊòØÊäΩË±°Âá∫Á°¨‰ª∂ÊàñËôöÊãüÁ°¨‰ª∂ÔºåÂπ∂Êèê‰æõ‰∏Ä‰∏™‰∏ÄËá¥ÁöÑAPIÔºàÁ≥ªÁªüË∞ÉÁî®ÔºâÔºåÂÖÅËÆ∏Â∫îÁî®Á®ãÂ∫èËøêË°åÂíåÂÖ±‰∫´ËµÑÊ∫ê„ÄÇ‰∏∫‰∫ÜÂÆûÁé∞Ëøô‰∏™ÁõÆÁöÑÔºåÊàë‰ª¨Áª¥Êä§‰∫Ü‰∏ÄÁ≥ªÂàóÂ≠êÁ≥ªÁªüÂíåÂ±ÇÔºå‰ª•ÂàÜÈÖçËøô‰∫õË¥£‰ªª[5]„ÄÇÊØè‰∏™Â≠êÁ≥ªÁªüÈÄöÂ∏∏ÂÖÅËÆ∏ÊüêÁßçÁ®ãÂ∫¶ÁöÑÈÖçÁΩÆÔºå‰ª•ËÄÉËôëÂà∞Áî®Êà∑ÁöÑ‰∏çÂêåÈúÄÊ±Ç„ÄÇÂ¶ÇÊûú‰∏çËÉΩÈÖçÁΩÆÊâÄÈúÄÁöÑË°å‰∏∫ÔºåÂ∞±ÈúÄË¶ÅÊîπÂèòÂÜÖÊ†∏Ôºå‰ªéÂéÜÂè≤‰∏äÁúãÔºåÊîπÂèòÂÜÖÊ†∏ÁöÑË°å‰∏∫ÔºåÊàñËÄÖËÆ©Áî®Êà∑ÁºñÂÜôÁöÑÁ®ãÂ∫èËÉΩÂ§üÂú®ÂÜÖÊ†∏‰∏≠ËøêË°åÔºåÂ∞±Êúâ‰∏§ÁßçÈÄâÊã©:</p>
<div class="table-wrapper"><table><thead><tr><th>Êú¨Âú∞ÊîØÊåÅÂÜÖÊ†∏Ê®°Âùó</th><th>ÂÜô‰∏Ä‰∏™ÂÜÖÊ†∏Ê®°Âùó</th></tr></thead><tbody>
<tr><td>ÊîπÂèòÂÜÖÊ†∏Ê∫ê‰ª£Á†ÅÔºåÂπ∂ËØ¥ÊúçLinuxÂÜÖÊ†∏Á§æÂå∫Áõ∏‰ø°ËøôÁßçÊîπÂèòÊòØÂøÖË¶ÅÁöÑ„ÄÇÁ≠âÂæÖÂá†Âπ¥ÔºåËÆ©Êñ∞ÁöÑÂÜÖÊ†∏ÁâàÊú¨Êàê‰∏∫‰∏ÄÁßçÂïÜÂìÅ„ÄÇ</td><td>ÂÆöÊúü‰øÆÂ§çÂÆÉÔºåÂõ†‰∏∫ÊØè‰∏™ÂÜÖÊ†∏ÁâàÊú¨ÈÉΩÂèØËÉΩÁ†¥ÂùèÂÆÉ„ÄÇÁî±‰∫éÁº∫‰πèÂÆâÂÖ®ËæπÁïåÔºåÂÜíÁùÄÁ†¥Âùè‰Ω†ÁöÑLinuxÂÜÖÊ†∏ÁöÑÈ£éÈô©</td></tr>
</tbody></table>
</div>
<p>ÂÆûÈôÖ‰∏äÔºå‰∏§ÁßçÊñπÊ°àÈÉΩ‰∏çÂ∏∏Áî®ÔºåÂâçËÄÖÊàêÊú¨Â§™È´òÔºåÂêéËÄÖÂàôÂá†‰πéÊ≤°ÊúâÂèØÁßªÊ§çÊÄß„ÄÇ</p>
<p>Êúâ‰∫Ü eBPFÔºåÂ∞±Êúâ‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÈÄâÊã©ÔºåÂèØ‰ª•ÈáçÊñ∞ÁºñÁ®ã Linux ÂÜÖÊ†∏ÁöÑË°å‰∏∫ÔºåËÄå‰∏çÈúÄË¶ÅÊîπÂèòÂÜÖÊ†∏ÁöÑÊ∫ê‰ª£Á†ÅÊàñÂä†ËΩΩÂÜÖÊ†∏Ê®°ÂùóÔºåÂêåÊó∂‰øùËØÅÂú®‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨‰πãÈó¥‰∏ÄÂÆöÁ®ãÂ∫¶‰∏äÁöÑË°å‰∏∫‰∏ÄËá¥ÊÄßÂíåÂÖºÂÆπÊÄß„ÄÅ‰ª•ÂèäÂÆâÂÖ®ÊÄß[6]„ÄÇ‰∏∫‰∫ÜÂÆûÁé∞Ëøô‰∏™ÁõÆÁöÑÔºåeBPF Á®ãÂ∫è‰πüÈúÄË¶ÅÊúâ‰∏ÄÂ•óÂØπÂ∫îÁöÑ APIÔºåÂÖÅËÆ∏Áî®Êà∑ÂÆö‰πâÁöÑÂ∫îÁî®Á®ãÂ∫èËøêË°åÂíåÂÖ±‰∫´ËµÑÊ∫ê --- Êç¢Âè•ËØùËØ¥ÔºåÊüêÁßçÊÑè‰πâ‰∏äËÆ≤ eBPF ËôöÊãüÊú∫‰πüÊèê‰æõ‰∫Ü‰∏ÄÂ•óÁ±ª‰ºº‰∫éÁ≥ªÁªüË∞ÉÁî®ÁöÑÊú∫Âà∂ÔºåÂÄüÂä© eBPF ÂíåÁî®Êà∑ÊÄÅÈÄö‰ø°ÁöÑÊú∫Âà∂ÔºåWasm ËôöÊãüÊú∫ÂíåÁî®Êà∑ÊÄÅÂ∫îÁî®‰πüÂèØ‰ª•Ëé∑ÂæóËøôÂ•ó‚ÄúÁ≥ªÁªüË∞ÉÁî®‚ÄùÁöÑÂÆåÊï¥‰ΩøÁî®ÊùÉÔºå‰∏ÄÊñπÈù¢ËÉΩÂèØÁºñÁ®ãÂú∞Êâ©Â±ï‰º†ÁªüÁöÑÁ≥ªÁªüË∞ÉÁî®ÁöÑËÉΩÂäõÔºåÂè¶‰∏ÄÊñπÈù¢ËÉΩÂú®ÁΩëÁªú„ÄÅÊñá‰ª∂Á≥ªÁªüÁ≠âËÆ∏Â§öÂ±ÇÊ¨°ÂÆûÁé∞Êõ¥È´òÊïàÁöÑÂèØÁºñÁ®ã IO Â§ÑÁêÜ„ÄÇ</p>
<p><img src="blog/new-os-model.jpg" alt="new-os" /></p>
<p>Ê≠£Â¶Ç‰∏äÂõæÊâÄÁ§∫ÔºåÂΩì‰ªäÁöÑ Linux ÂÜÖÊ†∏Ê≠£Âú®Âêë‰∏Ä‰∏™Êñ∞ÁöÑÂÜÖÊ†∏Ê®°ÂûãÊºîÂåñÔºöÁî®Êà∑ÂÆö‰πâÁöÑÂ∫îÁî®Á®ãÂ∫èÂèØ‰ª•Âú®ÂÜÖÊ†∏ÊÄÅÂíåÁî®Êà∑ÊÄÅÂêåÊó∂ÊâßË°åÔºåÁî®Êà∑ÊÄÅÈÄöËøá‰º†ÁªüÁöÑÁ≥ªÁªüË∞ÉÁî®ËÆøÈóÆÁ≥ªÁªüËµÑÊ∫êÔºåÂÜÖÊ†∏ÊÄÅÂàôÈÄöËøá BPF Helper Calls ÂíåÁ≥ªÁªüÁöÑÂêÑ‰∏™ÈÉ®ÂàÜÂÆåÊàê‰∫§‰∫í„ÄÇÊà™Ê≠¢ 2023 Âπ¥ÂàùÔºåÂÜÖÊ†∏‰∏≠ÁöÑ eBPF ËôöÊãüÊú∫‰∏≠Â∑≤ÁªèÊúâ 220 Â§ö‰∏™Helper Á≥ªÁªüÊé•Âè£ÔºåÊ∂µÁõñ‰∫ÜÈùûÂ∏∏Â§öÁöÑÂ∫îÁî®Âú∫ÊôØ„ÄÇ</p>
<p>ÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØÔºåBPF Helper Call ÂíåÁ≥ªÁªüË∞ÉÁî®‰∫åËÄÖÂπ∂‰∏çÊòØÁ´û‰∫âÂÖ≥Á≥ªÔºåÂÆÉ‰ª¨ÁöÑÁºñÁ®ãÊ®°ÂûãÂíåÊúâÊÄßËÉΩ‰ºòÂäøÁöÑÂú∫ÊôØÂÆåÂÖ®‰∏çÂêåÔºå‰πü‰∏ç‰ºöÂÆåÂÖ®Êõø‰ª£ÂØπÊñπ„ÄÇÂØπ Wasm Âíå Wasi Áõ∏ÂÖ≥ÁîüÊÄÅÊù•ËØ¥ÔºåÊÉÖÂÜµ‰πüÁ±ª‰ººÔºå‰∏ìÈó®ËÆæËÆ°ÁöÑ wasi Êé•Âè£ÈúÄË¶ÅÁªèÂéÜ‰∏Ä‰∏™Êº´ÈïøÁöÑÊ†áÂáÜÂåñËøáÁ®ãÔºå‰ΩÜÂèØËÉΩÂú®ÁâπÂÆöÂú∫ÊôØËÉΩ‰∏∫Áî®Êà∑ÊÄÅÂ∫îÁî®Ëé∑ÂèñÊõ¥‰Ω≥ÁöÑÊÄßËÉΩÂíåÂèØÁßªÊ§çÊÄß‰øùËØÅÔºåËÄå eBPF Âú®‰øùËØÅÊ≤ôÁÆ±Êú¨Ë¥®ÂíåÂèØÁßªÊ§çÊÄßÁöÑÂâçÊèê‰∏ãÔºåÂèØ‰ª•Êèê‰æõ‰∏Ä‰∏™Âø´ÈÄüÁÅµÊ¥ªÁöÑÊâ©Â±ïÁ≥ªÁªüÊé•Âè£ÁöÑÊñπÊ°à„ÄÇ</p>
<p>ÁõÆÂâçÁöÑ eBPF ‰ªçÁÑ∂Â§Ñ‰∫éÊó©ÊúüÈò∂ÊÆµÔºå‰ΩÜÊòØÂÄüÂä©ÂΩìÂâç eBPF Êèê‰æõÁöÑÂÜÖÊ†∏Êé•Âè£ÂíåÁî®Êà∑ÊÄÅ‰∫§‰∫íÁöÑËÉΩÂäõÔºåÁªèÁî± Wasm-bpf ÁöÑÁ≥ªÁªüÊé•Âè£ËΩ¨Êç¢ÔºåWasm ËôöÊãüÊú∫‰∏≠ÁöÑÂ∫îÁî®Â∑≤ÁªèÂá†‰πéÊúâËÉΩÂäõËé∑ÂèñÂÜÖÊ†∏‰ª•ÂèäÁî®Êà∑ÊÄÅ‰ªªÊÑè‰∏Ä‰∏™ÂáΩÊï∞Ë∞ÉÁî®ÁöÑÊï∞ÊçÆÂíåËøîÂõûÂÄºÔºàkprobeÔºåuprobe...ÔºâÔºõ‰ª•Âæà‰ΩéÁöÑ‰ª£‰ª∑Êî∂ÈõÜÂíåÁêÜËß£ÊâÄÊúâÁ≥ªÁªüË∞ÉÁî®ÔºåÂπ∂Ëé∑ÂèñÊâÄÊúâÁΩëÁªúÊìç‰ΩúÁöÑÊï∞ÊçÆÂåÖÂíåÂ•óÊé•Â≠óÁ∫ßÂà´ÁöÑÊï∞ÊçÆÔºàtracepointÔºåsocket...ÔºâÔºõÂú®ÁΩëÁªúÂåÖÂ§ÑÁêÜËß£ÂÜ≥ÊñπÊ°à‰∏≠Ê∑ªÂä†È¢ùÂ§ñÁöÑÂçèËÆÆÂàÜÊûêÂô®ÔºåÂπ∂ËΩªÊùæÂú∞ÁºñÁ®ã‰ªª‰ΩïËΩ¨ÂèëÈÄªËæëÔºàXDPÔºåTC...ÔºâÔºå‰ª•Êª°Ë∂≥‰∏çÊñ≠ÂèòÂåñÁöÑÈúÄÊ±ÇÔºåËÄåÊó†ÈúÄÁ¶ªÂºÄLinuxÂÜÖÊ†∏ÁöÑÊï∞ÊçÆÂåÖÂ§ÑÁêÜÁéØÂ¢É„ÄÇ</p>
<p>‰∏ç‰ªÖÂ¶ÇÊ≠§ÔºåeBPF ËøòÊúâËÉΩÂäõÂæÄÁî®Êà∑Á©∫Èó¥‰ªªÊÑèËøõÁ®ãÁöÑ‰ªªÊÑèÂú∞ÂùÄÂÜôÂÖ•Êï∞ÊçÆÔºàbpf_probe_write_user[7]ÔºâÔºåÊúâÈôêÂ∫¶Âú∞‰øÆÊîπÂÜÖÊ†∏ÂáΩÊï∞ÁöÑËøîÂõûÂÄºÔºàbpf_override_return[8]ÔºâÔºåÁîöËá≥Âú®ÂÜÖÊ†∏ÊÄÅÁõ¥Êé•ÊâßË°åÊüê‰∫õÁ≥ªÁªüË∞ÉÁî®[9]ÔºõÊâÄÂπ∏ÁöÑÊòØÔºåeBPF Âú®Âä†ËΩΩËøõÂÜÖÊ†∏‰πãÂâçÂØπÂ≠óËäÇÁ†Å‰ºöËøõË°å‰∏•Ê†ºÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øùÊ≤°ÊúâÂÜÖÂ≠òË∂äÁïåÁ≠âÊìç‰ΩúÔºåÂêåÊó∂ÔºåËÆ∏Â§öÂèØËÉΩ‰ºöÊâ©Â§ßÊîªÂáªÈù¢„ÄÅÂ∏¶Êù•ÂÆâÂÖ®È£éÈô©ÁöÑÂäüËÉΩÈÉΩÊòØÈúÄË¶ÅÂú®ÁºñËØëÂÜÖÊ†∏Êó∂ÊòéÁ°ÆÈÄâÊã©ÂêØÁî®ÊâçËÉΩ‰ΩøÁî®ÁöÑÔºõÂú® Wasm ËôöÊãüÊú∫Â∞ÜÂ≠óËäÇÁ†ÅÂä†ËΩΩËøõÂÜÖÊ†∏‰πãÂâçÔºå‰πüÂèØ‰ª•ÊòéÁ°ÆÈÄâÊã©ÂêØÁî®ÊàñËÄÖÁ¶ÅÁî®Êüê‰∫õ eBPF ÂäüËÉΩÔºå‰ª•Á°Æ‰øùÊ≤ôÁÆ±ÁöÑÂÆâÂÖ®ÊÄß„ÄÇ</p>
<p>ÊâÄÊúâÁöÑËøô‰∫õÂú∫ÊôØÈÉΩ‰∏çÈúÄË¶ÅÁ¶ªÂºÄ Wasm ËΩªÈáèÁ∫ßÂÆπÂô®Ôºö‰∏çÂÉè‰º†ÁªüÁöÑ‰ΩøÁî® Wasm ‰Ωú‰∏∫Êï∞ÊçÆÂ§ÑÁêÜÊàñËÄÖÊéßÂà∂Êèí‰ª∂ÁöÑÂ∫îÁî®‰∏≠ÔºåËøô‰∫õÊ≠•È™§Áî± Wasm ËôöÊãüÊú∫Â§ñÁöÑÈÄªËæëÂÆûÁé∞ÔºåÁé∞Âú®ÂèØ‰ª•Âú® Wasm ËΩªÈáèÁ∫ßÂÆπÂô®‰∏≠ÂÆûÁé∞ÂØπ eBPF ‰ª•Âèä eBPF ËÉΩËÆøÈóÆÁöÑÂá†‰πéÊâÄÊúâÁ≥ªÁªüËµÑÊ∫êÔºåÂÆåÊï¥ÁöÑÊéßÂà∂Âíå‰∫§‰∫íÔºåÁîöËá≥ÂÆûÊó∂ÁîüÊàê eBPF ‰ª£Á†ÅÊîπÂèòÂÜÖÊ†∏ÁöÑË°å‰∏∫ÈÄªËæëÔºåÂÆûÁé∞Êï¥‰∏™Á≥ªÁªü‰ªéÁî®Êà∑ÊÄÅÊâ©Â±ïÂà∞ÂÜÖÊ†∏ÊÄÅÁöÑÂèØÁºñÁ®ãÊÄß„ÄÇ</p>
<h2 id="wasm-ÂØπ-ebpf-ÁöÑÁî®Êà∑ÊÄÅÂ¢ûÂº∫ÁªÑ‰ª∂Ê®°Âûã"><a class="header" href="#wasm-ÂØπ-ebpf-ÁöÑÁî®Êà∑ÊÄÅÂ¢ûÂº∫ÁªÑ‰ª∂Ê®°Âûã">Wasm ÂØπ eBPF ÁöÑÁî®Êà∑ÊÄÅÂ¢ûÂº∫ÔºöÁªÑ‰ª∂Ê®°Âûã</a></h2>
<p>Ê†áÂáÜÂæàÂ∞ëÊòØ‰∏Ä‰∏™ÁîüÊÄÅÁ≥ªÁªü‰∏≠ÊúÄ‰ª§‰∫∫ÂÖ¥Â•ãÁöÑÈÉ®ÂàÜ„ÄÇËÄå‰∏îÔºåÈöèÁùÄ ‚ÄúÁªÑ‰ª∂Ê®°Âûã‚Äù ËøôÊ†∑ÁöÑÂêçÂ≠óÔºåÊøÄËµ∑ÂÖ¥Â•ãÊÑüÁ°ÆÂÆûÊòØ‰∏ÄÈ°πËâ∞Â∑®ÁöÑ‰ªªÂä°„ÄÇ‰ΩÜÊòØÔºåÂú®Ëøô‰∏™‰πèÂë≥ÁöÑÂêçÂ≠óËÉåÂêéÊòØ Wasm ‰∏∫ËΩØ‰ª∂‰∏ñÁïåÂ∏¶Êù•ÁöÑÊúÄÈáçË¶ÅÁöÑÂàõÊñ∞„ÄÇ</p>
<p>ÁªÑ‰ª∂Ê®°ÂûãÊèèËø∞‰∫Ü Wasm ‰∫åËøõÂà∂Êñá‰ª∂‰πãÈó¥Â¶Ç‰Ωï‰∫§‰∫íÁöÑÊñπÂºè„ÄÇÊõ¥ÂÖ∑‰ΩìÂú∞ËØ¥Ôºå‰∏§‰∏™ÁªÑ‰ª∂ÂèØ‰ª•ÂëäËØâÂØπÊñπÂÆÉ‰ª¨Êèê‰æõÁöÑÊúçÂä°‰ª•ÂèäÈúÄË¶ÅÂ±•Ë°åÁöÑÊúüÊúõ„ÄÇÁÑ∂ÂêéÔºåWasm Ê®°ÂùóÂèØ‰ª•Âà©Áî®ÂΩºÊ≠§ÁöÑËÉΩÂäõ„ÄÇËøô‰∏∫ËΩØ‰ª∂ÂºÄÂèë‰∫∫ÂëòÊèê‰æõ‰∫Ü‰∏ÄÁßçÊñ∞ÁöÑÂª∫Á´ãÂ∫îÁî®Á®ãÂ∫èÁöÑÊñπÂºè„ÄÇÂºÄÂèë‰∫∫ÂëòÂèØ‰ª•Â£∞ÊòéÂ∫îÁî®Á®ãÂ∫èÊâÄÈúÄÁöÑÁªÑ‰ª∂ÔºàÊàñËÄÖÊõ¥ÊäΩË±°Âú∞ËØ¥ÔºåÂ∫îÁî®Á®ãÂ∫èÊâÄÈúÄÁöÑÂäüËÉΩÔºâÔºåÁÑ∂Âêé Wasm ËøêË°åÊó∂ÂèØ‰ª•‰ª£Ë°®Áî®Êà∑ÁªÑË£ÖÊ≠£Á°ÆÁöÑÁªÑ‰ª∂ÈõÜÂêà„ÄÇÁªÑ‰ª∂Ê®°ÂûãÊ≠£Âú®ËøÖÈÄüÊàêÁÜüÔºåÂ∑≤ÁªèÂá∫Áé∞‰∫ÜÂèÇËÄÉÂÆûÁé∞„ÄÇ2023 Âπ¥Â∞ÜÊòØÁªÑ‰ª∂Ê®°ÂûãÂºÄÂßãÈáçÊñ∞ÂÆö‰πâÊàë‰ª¨Â¶Ç‰ΩïÁºñÂÜôËΩØ‰ª∂ÁöÑ‰∏ÄÂπ¥[10]„ÄÇ</p>
<p>ÂÄüÂä© Wasm ÁöÑÁõ∏ÂÖ≥ÁîüÊÄÅÔºåÂ∞§ÂÖ∂ÊòØÂü∫‰∫é Wasm ÁöÑËΩªÈáèÁ∫ßÂÆπÂô®ÊäÄÊúØ„ÄÅÁªÑ‰ª∂Ê®°ÂûãÔºåÊàë‰ª¨ÂêåÊ†∑‰πüÂèØ‰ª•Áªô eBPF ÁöÑÂ∫îÁî®Ëµã‰∫àÂ¶Ç‰∏ãÁâπÊÄßÔºö</p>
<ul>
<li><code>ÂèØÁßªÊ§ç</code>ÔºöËÆ© eBPF Â∑•ÂÖ∑ÂíåÂ∫îÁî®ÂÆåÂÖ®Âπ≥Âè∞Êó†ÂÖ≥„ÄÅÂèØÁßªÊ§çÔºå‰∏çÈúÄË¶ÅËøõË°åÈáçÊñ∞ÁºñËØëÂç≥ÂèØ‰ª•Ë∑®Âπ≥Âè∞ÂàÜÂèëÔºõ</li>
<li><code>ÈöîÁ¶ªÊÄß</code>ÔºöÂÄüÂä© Wasm ÁöÑÂèØÈù†ÊÄßÂíåÈöîÁ¶ªÊÄßÔºåËÆ© eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°å„ÄÅ‰ª•ÂèäÁî®Êà∑ÊÄÅÁöÑÊï∞ÊçÆÂ§ÑÁêÜÊµÅÁ®ãÊõ¥Âä†ÂÆâÂÖ®ÂèØÈù†Ôºõ‰∫ãÂÆû‰∏ä‰∏Ä‰∏™ eBPF Â∫îÁî®ÁöÑÁî®Êà∑ÊÄÅÊéßÂà∂‰ª£Á†Å„ÄÅÊï∞ÊçÆÂ§ÑÁêÜ‰ª£Á†ÅÁöÑÈÉ®ÂàÜÈÄöÂ∏∏ËøúËøúÂ§ö‰∫éÂÜÖÊ†∏ÊÄÅÔºõ</li>
<li><code>ÂåÖÁÆ°ÁêÜ</code>ÔºöÂÄüÂä© Wasm ÁöÑÁîüÊÄÅÂíåÂ∑•ÂÖ∑ÈìæÔºåÂÆåÊàê eBPF Á®ãÂ∫èÊàñÂ∑•ÂÖ∑ÁöÑÂàÜÂèë„ÄÅÁÆ°ÁêÜ„ÄÅÂä†ËΩΩÁ≠âÂ∑•‰ΩúÔºåÁõÆÂâç eBPF Á®ãÂ∫èÊàñÂ∑•ÂÖ∑ÁîüÊÄÅ‰πüÁº∫‰πè‰∏Ä‰∏™ÈÄöÁî®ÁöÑÂåÖÁÆ°ÁêÜÊàñÊèí‰ª∂ÁÆ°ÁêÜÁ≥ªÁªüÔºõ</li>
<li><code>Ë∑®ËØ≠Ë®Ä</code>ÔºöÁõÆÂâç eBPF Á®ãÂ∫èÁî±Â§öÁßçÁî®Êà∑ÊÄÅËØ≠Ë®ÄÂºÄÂèëÔºàÂ¶Ç Go\Rust\C\C++\Python Á≠âÔºâÔºåË∂ÖËøá 30 ÁßçÁºñÁ®ãËØ≠Ë®ÄÂèØ‰ª•Ë¢´ÁºñËØëÊàê WebAssembly Ê®°ÂùóÔºåÂèØ‰ª•ÂÖÅËÆ∏ÂêÑÁßçËÉåÊôØÁöÑÂºÄÂèë‰∫∫ÂëòÔºàC„ÄÅGo„ÄÅRust„ÄÅJava„ÄÅTypeScript Á≠âÔºâÁî®‰ªñ‰ª¨ÈÄâÊã©ÁöÑËØ≠Ë®ÄÁºñÂÜô eBPF ÁöÑÁî®Êà∑ÊÄÅÁ®ãÂ∫èÔºåËÄå‰∏çÈúÄË¶ÅÂ≠¶‰π†Êñ∞ÁöÑËØ≠Ë®ÄÔºåÁîöËá≥Êàë‰ª¨ÂèØ‰ª•Â∞Ü Wasm Âä®ÊÄÅÁøªËØë‰∏∫ eBPF Á®ãÂ∫èÔºåÂä†ËΩΩËøõÂÖ•ÂÜÖÊ†∏ÔºåÊàñËÄÖÂú® Wasm ËΩªÈáèÁ∫ßÂÆπÂô®‰∏≠Áõ¥Êé•ÁîüÊàê eBPF Â≠óËäÇÁ†ÅÔºõ</li>
<li><code>ÊïèÊç∑ÊÄß</code>ÔºöÂØπ‰∫éÂ§ßÂûãÁöÑ eBPF Â∫îÁî®Á®ãÂ∫èÔºåÂèØ‰ª•‰ΩøÁî® Wasm ‰Ωú‰∏∫Êèí‰ª∂Êâ©Â±ïÂπ≥Âè∞ÔºöÊâ©Â±ïÁ®ãÂ∫èÂèØ‰ª•Âú®ËøêË°åÊó∂Áõ¥Êé•‰ªéÊéßÂà∂Âπ≥Èù¢‰∫§‰ªòÂíåÈáçÊñ∞Âä†ËΩΩ„ÄÇËøô‰∏ç‰ªÖÊÑèÂë≥ÁùÄÊØè‰∏™‰∫∫ÈÉΩÂèØ‰ª•‰ΩøÁî®ÂÆòÊñπÂíåÊú™Áªè‰øÆÊîπÁöÑÂ∫îÁî®Á®ãÂ∫èÊù•Âä†ËΩΩËá™ÂÆö‰πâÊâ©Â±ïÔºåËÄå‰∏î‰ªª‰Ωï eBPF Á®ãÂ∫èÁöÑÈîôËØØ‰øÆÂ§çÂíå/ÊàñÊõ¥Êñ∞ÈÉΩÂèØ‰ª•Âú®ËøêË°åÊó∂Êé®ÈÄÅÂíå/ÊàñÊµãËØïÔºåËÄå‰∏çÈúÄË¶ÅÊõ¥Êñ∞Âíå/ÊàñÈáçÊñ∞ÈÉ®ÁΩ≤‰∏Ä‰∏™Êñ∞ÁöÑ‰∫åËøõÂà∂ÔºõÂØπ‰∫éÂèØËßÇÊµãÊÄßÂ∫îÁî®Êù•ËØ¥ÔºåÈúÄË¶ÅÊõ¥Êñ∞Êï∞ÊçÆÂ§ÑÁêÜÊèí‰ª∂Ôºå‰πüÊó†ÈúÄÁªèÂéÜÈáçÊñ∞ÁºñËØëÈÉ®ÁΩ≤Êï¥‰∏™Â∫îÁî®Á®ãÂ∫èÁöÑËøáÁ®ãÔºõ</li>
<li><code>ËΩªÈáèÁ∫ß</code>ÔºöWebAssembly ÂæÆÊúçÂä°Ê∂àËÄó 1% ÁöÑËµÑÊ∫êÔºå‰∏é Linux ÂÆπÂô®Â∫îÁî®Áõ∏ÊØîÔºåÂÜ∑ÂêØÂä®ÁöÑÊó∂Èó¥ÊòØ 1%ÔºõÂØπ‰∫éÂ§ßÈáèÁöÑÂ∞èÂûã eBPF Á®ãÂ∫èÈúÄË¶ÅÂø´ÈÄüÈÉ®ÁΩ≤ÂíåÂÅúÊ≠¢ÁöÑÂú∫ÊôØÔºåWasm ÁöÑËΩªÈáèÁ∫ßÁâπÊÄßÂèØ‰ª•Â§ßÂ§ßÈôç‰ΩéÁ≥ªÁªüÁöÑËµÑÊ∫êÂºÄÈîÄ„ÄÇ</li>
</ul>
<p>Êàë‰ª¨Â∑≤ÁªèÂú® LMP È°πÁõÆÁöÑ eBPF Hub ‰∏≠ÔºåÊúâ‰∏Ä‰∫õÂàõÂª∫Á¨¶Âêà OCI Ê†áÂáÜÁöÑ Wasm-eBPF Â∫îÁî®Á®ãÂ∫èÔºåÂπ∂Âà©Áî® ORAS ÁÆÄÂåñÊâ©Â±ï eBPF Â∫îÁî®ÂºÄÂèëÔºåÂàÜÂèë„ÄÅÂä†ËΩΩ„ÄÅËøêË°åËÉΩÂäõÁöÑÂ∞ùËØï[11]Ôºå‰ª•ÂèäÂü∫‰∫é Wasm ÂêåÊó∂‰ΩøÁî®Â§öÁßç‰∏çÂêåËØ≠Ë®ÄÂºÄÂèë eBPF ÁöÑÁî®Êà∑ÊÄÅÊï∞ÊçÆÂ§ÑÁêÜÊèí‰ª∂ÁöÑÂÆûË∑µÔºåÂü∫‰∫éÊúÄÊñ∞ÁöÑ Wasm-bpf Ê°ÜÊû∂ÔºåÊúâÊõ¥Â§öÁöÑÊé¢Á¥¢ÊÄßÂ∑•‰ΩúÂèØ‰ª•ÁªßÁª≠Â±ïÂºÄ„ÄÇ</p>
<h2 id="Áî®Êà∑Á©∫Èó¥Âíå-ebpf-Á®ãÂ∫èÁöÑ‰∫§‰∫íÊµÅÁ®ã"><a class="header" href="#Áî®Êà∑Á©∫Èó¥Âíå-ebpf-Á®ãÂ∫èÁöÑ‰∫§‰∫íÊµÅÁ®ã">Áî®Êà∑Á©∫Èó¥Âíå eBPF Á®ãÂ∫èÁöÑ‰∫§‰∫íÊµÅÁ®ã</a></h2>
<p>eBPF Á®ãÂ∫èÊòØ‰ª•ÂáΩÊï∞‰∏∫Âçï‰ΩçÁöÑ„ÄÅ‰∫ã‰ª∂È©±Âä®ÁöÑÔºåÂΩìÂÜÖÊ†∏ÊàñÁî®Êà∑Á©∫Èó¥Â∫îÁî®Á®ãÂ∫èÈÄöËøáÊüê‰∏™ hook ÁÇπÊó∂Â∞±‰ºöËøêË°åÁâπÂÆöÁöÑ eBPF Á®ãÂ∫è„ÄÇË¶Å‰ΩøÁî®‰∏Ä‰∏™ eBPF Á®ãÂ∫èÔºåÈ¶ñÂÖàÊàë‰ª¨ÈúÄË¶Å‰ΩøÁî® clang/LLVM Â∑•ÂÖ∑ÈìæÂ∞ÜÂØπÂ∫îÁöÑÊ∫ê‰ª£Á†ÅÁºñËØë‰∏∫ bpf Â≠óËäÇÁ†ÅÔºåÂÖ∂‰∏≠ÂåÖÂê´ÂØπÂ∫îÁöÑÊï∞ÊçÆÁªìÊûÑÂÆö‰πâ„ÄÅmaps Âíå progs ÂÆö‰πâÔºåprogs Âç≥Á®ãÂ∫èÊÆµÔºåmaps ÂèØ‰ª•Áî®Êù•Â≠òÂÇ®Êï∞ÊçÆÊàñËÄÖÂíåÁî®Êà∑Á©∫Èó¥ÂÆûÁé∞ÂèåÂêëÈÄö‰ø°„ÄÇ‰πãÂêéÔºåÊàë‰ª¨ÂèØ‰ª•ÂÄüÂä©Áî®Êà∑ÊÄÅÁöÑÂºÄÂèëÊ°ÜÊû∂ÂíåÂä†ËΩΩÊ°ÜÊû∂ÔºåÂÆûÁé∞ÂÆåÊï¥ÁöÑ eBPF Â∫îÁî®„ÄÇ</p>
<h3 id="ÈÄöÂ∏∏ÁöÑÁî®Êà∑ÊÄÅ-ebpf-ÂºÄÂèëÊ°ÜÊû∂"><a class="header" href="#ÈÄöÂ∏∏ÁöÑÁî®Êà∑ÊÄÅ-ebpf-ÂºÄÂèëÊ°ÜÊû∂">ÈÄöÂ∏∏ÁöÑÁî®Êà∑ÊÄÅ eBPF ÂºÄÂèëÊ°ÜÊû∂</a></h3>
<p>ÂØπ‰∫é‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ eBPF Â∫îÁî®ÔºåÈÄöÂ∏∏ÈúÄË¶ÅÂåÖÂê´Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ‰∏§ÈÉ®ÂàÜÔºö</p>
<ul>
<li>Áî®Êà∑ÊÄÅÁ®ãÂ∫èÈúÄË¶ÅÈÄöËøá‰∏ÄÁ≥ªÂàóÁ≥ªÁªüË∞ÉÁî®Ë∑üÂÜÖÊ†∏ËøõË°å‰∫§‰∫íÔºà‰∏ªË¶ÅÊòØ bpf Á≥ªÁªüË∞ÉÁî®ÔºâÔºåÂàõÂª∫ÂØπÂ∫îÁöÑ map ‰ª•Âú®ÂÜÖÊ†∏ÊÄÅ‰øùÂ≠òÊï∞ÊçÆÊàñÂíåÁî®Êà∑ÊÄÅÈÄö‰ø°ÔºåÊ†πÊçÆÈÖçÁΩÆÂä®ÊÄÅÈÄâÊã©Âä†ËΩΩ‰∏çÂêåÁöÑÁ®ãÂ∫èÊÆµÔºåÂä®ÊÄÅ‰øÆÊîπÂ≠óËäÇÁ†ÅÊàñÈÖçÁΩÆ eBPF Á®ãÂ∫èÁöÑÂèÇÊï∞ÔºåÂ∞ÜÂØπÂ∫îÁöÑÂ≠óËäÇÁ†Å‰ø°ÊÅØÂä†ËΩΩËøõÂÜÖÊ†∏ÔºåÈÄöËøáÈ™åËØÅÂô®Á°Æ‰øùÂÆâÂÖ®ÊÄßÔºåÂπ∂ÈÄöËøá maps ÂíåÂÜÖÊ†∏‰πãÈó¥ÂÆûÁé∞ÂèåÂêëÈÄö‰ø°ÔºåÈÄöËøá ring buffer / perf buffer ‰πãÁ±ªÁöÑÊú∫Âà∂‰ªéÂÜÖÊ†∏ÊÄÅÂêëÁî®Êà∑ÊÄÅ‰º†ÈÄíÊï∞ÊçÆÔºàÊàñËÄÖÂèç‰πãÔºâ„ÄÇ</li>
<li>ÂÜÖÊ†∏ÊÄÅ‰∏ªË¶ÅË¥üË¥£ÂÖ∑‰ΩìÁöÑËÆ°ÁÆóÈÄªËæë‰∏éÊï∞ÊçÆÊî∂ÈõÜ„ÄÇ</li>
</ul>
<div align="center">
<img src=https://ebpf.io/static/libbpf-ee03b2f4d79b197554fa00671e67129d.png width=60% />
</div>
<h3 id="Âú®Áî®Êà∑ÊÄÅ-wasm-ebpf-Á≥ªÁªüÊé•Âè£‰πã‰∏äÂÆö‰πâÁöÑÂÖ®Êñ∞-ebpf-ÂºÄÂèëÊ°ÜÊû∂"><a class="header" href="#Âú®Áî®Êà∑ÊÄÅ-wasm-ebpf-Á≥ªÁªüÊé•Âè£‰πã‰∏äÂÆö‰πâÁöÑÂÖ®Êñ∞-ebpf-ÂºÄÂèëÊ°ÜÊû∂">Âú®Áî®Êà∑ÊÄÅ Wasm-eBPF Á≥ªÁªüÊé•Âè£‰πã‰∏äÂÆö‰πâÁöÑÂÖ®Êñ∞ eBPF ÂºÄÂèëÊ°ÜÊû∂</a></h3>
<p>Ëøô‰∏™È°πÁõÆÊú¨Ë¥®‰∏äÂèØ‰ª•ËØ¥ÊòØÂ∏åÊúõÊää Wasm Ê≤ôÁÆ±ÂΩìÂÅöÂú®Êìç‰ΩúÁ≥ªÁªü‰πã‰∏äÂª∫Á´ãÁöÑÂè¶‰∏Ä‰∏™Áî®Êà∑ÊÄÅËøêË°åÁ©∫Èó¥ÔºåËÆ© Wasm Â∫îÁî®Âú®Ê≤ôÁÆ±‰∏≠ÂÆûÁé∞ÂíåÈÄöÂ∏∏Áî®Êà∑ÊÄÅ‰∏≠ËøêË°åÁöÑ eBPF Â∫îÁî®‰∏ÄÊ†∑ÁöÑÁºñÁ®ãÊ®°ÂûãÂíåÊâßË°åÈÄªËæë„ÄÇWasm-bpf ‰ºöÈúÄË¶Å‰∏Ä‰∏™Âú® hostÔºàÊ≤ôÁÆ±Â§ñÈÉ®ÔºâÊûÑÂª∫ÁöÑËøêË°åÊó∂Êâ©Â±ïÔºå‰ª•Âèä‰∏Ä‰∫õÂú®Ê≤ôÁÆ±ÂÜÖÈÉ®Ë¢´ÁºñËØë‰∏∫ Wasm Â≠óËäÇÁ†ÅÁöÑËøêË°åÊó∂Â∫ìÊù•Êèê‰æõÂÆåÊï¥ÁöÑÊîØÊåÅ„ÄÇ</p>
<p><img src="blog/wasm-bpf-no-bcc.png" alt="wasm" /></p>
<p>Ë¶ÅÂÆûÁé∞ÂÆåÂ§áÁöÑÂºÄÂèëÊ®°ÂûãÔºåÊàë‰ª¨ÈúÄË¶ÅÔºö</p>
<ul>
<li>‰∏Ä‰∏™ Wasm Ê®°ÂùóÂèØ‰ª•ÂØπÂ∫îÂ§ö‰∏™ eBPF Á®ãÂ∫èÔºõ</li>
<li>‰∏Ä‰∏™ eBPF Á®ãÂ∫èÂÆû‰æã‰πüÂèØ‰ª•Ë¢´Â§ö‰∏™ Wasm Ê®°ÂùóÊâÄÂÖ±Áî®Ôºõ</li>
<li>ÂèØ‰ª•Â∞Ü eBPF Á®ãÂ∫è‰ªé Wasm Ê≤ôÁÆ±‰∏≠Âä®ÊÄÅÂä†ËΩΩËøõÂÜÖÊ†∏„ÄÅÈÄâÊã©ÊâÄÈúÄÁöÑÊåÇËΩΩÁÇπÊåÇËΩΩ„ÄÅÂç∏ËΩΩÔºåÊéßÂà∂Â§ö‰∏™ eBPF Â≠óËäÇÁ†ÅÂØπË±°ÁöÑÂÆåÊï¥ÁîüÂëΩÂë®ÊúüÔºåÂπ∂ÊîØÊåÅÂ§ßÂ§öÊï∞ÁöÑ eBPF Á®ãÂ∫èÁ±ªÂûãÔºõ</li>
<li>ÂèØ‰ª•ÈÄöËøáÂ§öÁßçÁ±ªÂûãÁöÑ Maps ÂíåÂÜÖÊ†∏ÂèåÂêëÈÄö‰ø°ÔºåÊîØÊåÅÂ§ßÂ§öÊï∞ÁöÑ Maps Á±ªÂûãÔºõ</li>
<li>ÈÄöËøá ring buffer Âíå perf event polling ‰ªéÂÜÖÊ†∏ÊÄÅÂêëÁî®Êà∑ÊÄÅÈ´òÊïàÂèëÈÄÅ‰ø°ÊÅØÔºàÂØπ‰∫é ring buffer Êù•ËØ¥Ôºå‰πüÂèØ‰ª•Âèç‰πãÔºâÔºõ</li>
<li>Âá†‰πéÂèØ‰ª•ÈÄÇÈÖç‰∫éÊâÄÊúâÁöÑ‰ΩøÁî® eBPF Á®ãÂ∫èÁöÑÂ∫îÁî®Âú∫ÊôØÔºåÂπ∂ÂèØ‰ª•ÈöèÁùÄÂÜÖÊ†∏ÂäüËÉΩÁöÑÊ∑ªÂä†‰∏çÊñ≠ÊºîÂåñÂíåÊâ©Â±ïÔºåÂêåÊó∂‰∏çÈúÄË¶ÅÂèòÂä® Wasm ËôöÊãüÊú∫ÁöÑÁ≥ªÁªüÊé•Âè£„ÄÇ</li>
</ul>
<p>ËøôÂ∞±ÊòØÁõÆÂâç Wasm-bpf È°πÁõÆÊâÄÂÅöÁöÑÂ∑•‰Ωú„ÄÇÊàë‰ª¨‰πüÊèêÂá∫‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑ WASI ÁöÑ Proposal: WASI-eBPF[12].</p>
<p>Âú® Wasm-bpf È°πÁõÆ‰∏≠ÔºåÊâÄÊúâ Wasm Âíå eBPF ËôöÊãüÊú∫‰πãÈó¥ÁöÑÈÄö‰ø°ÈÉΩÊó†ÈúÄÁªèËøáÂ∫èÂàóÂåñ„ÄÅÂèçÂ∫èÂàóÂåñÊú∫Âà∂ÔºåÈÄöËøáÂ∑•ÂÖ∑Èìæ‰∏≠‰ª£Á†ÅÁîüÊàêÊäÄÊúØÂíå BTFÔºàBPF Á±ªÂûãÊ†ºÂºè[13]Ôºâ‰ø°ÊÅØÁöÑÊîØÊåÅÔºåÊàë‰ª¨ÂèØ‰ª•ÂÆûÁé∞Âú® eBPF Âíå Wasm ‰πãÈó¥ÂèØËÉΩ‰∏çÂêåÁöÑÁªìÊûÑ‰ΩìÂÜÖÂ≠òÂ∏ÉÂ±Ä„ÄÅ‰∏çÂêåÁöÑÂ§ßÂ∞èÁ´ØÊú∫Âà∂„ÄÅ‰∏çÂêåÁöÑÊåáÈíàÂÆΩÂ∫¶‰πãÈó¥ÁöÑÊ≠£Á°ÆÈÄö‰ø°ÔºåÂú®ËøêË°åÊó∂Âá†‰πé‰∏ç‰ºöÂºïÂÖ•‰ªª‰ΩïÈ¢ùÂ§ñÁöÑÂºÄÈîÄÔºõÈÄöËøá eBPF Maps ÈÄö‰ø°ÁöÑÊó∂ÂÄôÊï∞ÊçÆÂèØ‰ª•Áõ¥Êé•Áî±ÂÜÖÊ†∏ÊÄÅÂ§çÂà∂Âà∞ Wasm ËôöÊãüÊú∫ÁöÑÂÜÖÂ≠ò‰∏≠ÔºåÈÅøÂÖçÂ§öÊ¨°Êã∑Ë¥ùÂ∏¶Êù•ÁöÑÈ¢ùÂ§ñÊçüËÄó„ÄÇÂêåÊó∂ÔºåÈÄöËøáËá™Âä®ÁîüÊàê skeleton Ôºàbpf ‰ª£Á†ÅÊ°ÜÊû∂ÔºâÂíåÁ±ªÂûãÂÆö‰πâÁöÑÊñπÂºèÔºåÁî®Êà∑ÊÄÅÁ®ãÂ∫èÁöÑ eBPF-Wasm ÂºÄÂèë‰ΩìÈ™å‰πüÂæóÂà∞‰∫ÜÈùûÂ∏∏Â§ßÁöÑÊîπÂñÑ„ÄÇ</p>
<p>ÂæóÁõä‰∫é libbpf Êèê‰æõÁöÑ CO-REÔºàCompile-Once, Run EverywhereÔºâÊäÄÊúØÔºåÂú®‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨‰πãÈó¥ÁßªÊ§ç eBPF Â≠óËäÇÁ†ÅÂØπË±°Ôºå‰πü‰∏çÈúÄË¶ÅÂºïÂÖ•È¢ùÂ§ñÁöÑÈáçÊñ∞ÁºñËØëÊµÅÁ®ãÔºåËøêË°åÊó∂‰πüÊ≤°Êúâ‰ªª‰ΩïÁöÑ LLVM/Clang ‰æùËµñ[14]„ÄÇ</p>
<p>ÈÄöÂ∏∏Ôºå‰∏Ä‰∏™ÁºñËØëÂ•ΩÁöÑ eBPF-Wasm Ê®°ÂùóÂè™ÊúâÂ§ßÁ∫¶ 90KbÔºåÂú®‰∏çÂà∞ 100ms ÂÜÖÂç≥ÂèØ‰ª•ÂÆåÊàêÂä®ÊÄÅÂä†ËΩΩËøõÂÜÖÊ†∏Âπ∂ÊâßË°åÁöÑËøáÁ®ã„ÄÇÊàë‰ª¨‰πüÂú®‰ªìÂ∫ì‰∏≠Êèê‰æõ‰∫ÜÂá†‰∏™‰æãÂ≠êÔºåÂàÜÂà´ÂØπÂ∫î‰∫éÂèØËßÇÊµã„ÄÅÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÂ§öÁßçÂú∫ÊôØÔºå‰ΩøÁî® C/C++ ËØ≠Ë®ÄÊàñ Rust ËØ≠Ë®ÄÁºñÂÜô„ÄÇ</p>
<p>ÊÑüË∞¢ÂçéÂçóÁêÜÂ∑•Â§ßÂ≠¶ËµñÊôìÈìÆÂâØÊïôÊéà„ÄÅË•øÂÆâÈÇÆÁîµÂ§ßÂ≠¶ÈôàËéâÂêõÊïôÊéàÂõ¢ÈòüÂíåËææÂù¶ÁßëÊäÄÁéãÁíû„ÄÅÊñΩÁªßÊàêËÄÅÂ∏àÂØπ Wasm Âíå eBPF Áõ∏ÁªìÂêàÁöÑÊåáÂØº‰∏éÂ∏ÆÂä©ÔºåÂú®Êé•‰∏ãÊù•ÁöÑÂ∑•‰Ωú‰∏≠ÔºåÊàë‰ª¨‰ºöÂíåÂèÇÂä† 2023 ÂºÄÊ∫êÊØïËÆæ‰πãÊóÖÁöÑÂêåÂ≠¶‰ª¨‰∏ÄÂêåÈíàÂØπ‰∏Ä‰∫õ Wasm-bpf ÂÖ∑‰ΩìÁöÑÂ∫îÁî®Âú∫ÊôØÔºåËøõË°åÊõ¥Ê∑±ÂÖ•ÁöÑÁ†îÁ©∂‰∏éÊé¢ËÆ®ÔºåÂπ∂Âú®‰∏ã‰∏ÄÁØá blog ‰∏≠ÁªôÂá∫Êõ¥ËØ¶ÁªÜÁöÑÂéüÁêÜËß£Êûê‰∏éÊÄßËÉΩÂàÜÊûêÔºå‰ª•ÂèäÂØπÂ∫îÁöÑ‰∏Ä‰∫õ‰ª£Á†ÅÁ§∫‰æã„ÄÇ</p>
<p>Wasm-bpf ÁºñËØëÂ∑•ÂÖ∑Èìæ‰∏éËøêË°åÊó∂Ê®°ÂùóÁ≠âÁõÆÂâçÁî±ÈæôËú•Á§æÂå∫ eBPF ÊäÄÊúØÊé¢Á¥¢ SIG[15] ‰∏≠Â≠µÂåñÁöÑ eunomia-bpf ÂºÄÊ∫êÁ§æÂå∫[16]ÂºÄÂèë‰∏éÁª¥Êä§ÔºåÊÑüË∞¢‰∏≠ÁßëÈô¢ËΩØ‰ª∂ÊâÄ PLCT ÂÆûÈ™åÂÆ§ÂØπÁ§æÂå∫ÁöÑÂ§ßÂäõÊîØÊåÅÂíåËµÑÂä©ÔºåÊÑüË∞¢Á§æÂå∫Âêå‰º¥‰ª¨ÁöÑË¥°ÁåÆ„ÄÇÊé•‰∏ãÊù•ÔºåÊàë‰ª¨‰πü‰ºöÂú®ÂØπÂ∫îÁöÑ eBPF Âíå Wasm Áõ∏ÂÖ≥ÁöÑÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂ÊñπÈù¢ÔºåËøõË°åÊõ¥Â§öÁöÑÂÆåÂñÑÂíåÊé¢Á¥¢ÔºåÂπ∂ÁßØÊûÅÂêë‰∏äÊ∏∏Á§æÂå∫ÂèçÈ¶àÂíåË¥°ÁåÆ„ÄÇ</p>
<h2 id="ÂèÇËÄÉËµÑÊñô"><a class="header" href="#ÂèÇËÄÉËµÑÊñô">ÂèÇËÄÉËµÑÊñô</a></h2>
<ul>
<li>[1] wasm-bpf Github ÂºÄÊ∫êÂú∞ÂùÄÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></li>
<li>[2] WebAssemblyÔºöÊó†ÈúÄÂÆπÂô®ÁöÑ DockerÔºö<a href="https://zhuanlan.zhihu.com/p/595257541">https://zhuanlan.zhihu.com/p/595257541</a></li>
<li>[3] ‰∫ëÂéüÁîüÈ°πÁõÆÂèØÊâ©Â±ïÊÄßÁöÑÂà©Âô® WebAssembly ÁÆÄ‰ªã <a href="https://mp.weixin.qq.com/s/fap0bl6GFGi8zN5BFLpkCw">https://mp.weixin.qq.com/s/fap0bl6GFGi8zN5BFLpkCw</a></li>
<li>[4] ÂΩì Wasm ÈÅáËßÅ eBPF Ôºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫èÔºö<a href="https://zhuanlan.zhihu.com/p/573941739">https://zhuanlan.zhihu.com/p/573941739</a></li>
<li>[5] <a href="https://ebpf.io/">https://ebpf.io/</a></li>
<li>[6] ‰ªÄ‰πàÊòØ eBPFÔºö<a href="https://ebpf.io/what-is-ebpf">https://ebpf.io/what-is-ebpf</a></li>
<li>[7] Offensive BPF: Understanding and using bpf_probe_write_user <a href="https://embracethered.com/blog/posts/2021/offensive-bpf-libbpf-bpf_probe_write_user/">https://embracethered.com/blog/posts/2021/offensive-bpf-libbpf-bpf_probe_write_user/</a></li>
<li>[8] ‰∫ëÂéüÁîüÂÆâÂÖ®ÊîªÈò≤ÔΩú‰ΩøÁî®eBPFÈÄÉÈÄ∏ÂÆπÂô®ÊäÄÊúØÂàÜÊûê‰∏éÂÆûË∑µÔºö<a href="https://security.tencent.com/index.php/blog/msg/206">https://security.tencent.com/index.php/blog/msg/206</a></li>
<li>[9] kernel-versions.md: <a href="https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md">https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md</a></li>
<li>[10] 2023 Âπ¥ WebAssembly ÊäÄÊúØ‰∫îÂ§ßË∂ãÂäøÈ¢ÑÊµãÔºö<a href="https://zhuanlan.zhihu.com/p/597705400">https://zhuanlan.zhihu.com/p/597705400</a></li>
<li>[11] LMP eBPF-Hub: <a href="https://github.com/linuxkerneltravel/lmp">https://github.com/linuxkerneltravel/lmp</a></li>
<li>[12] WASI-eBPF: <a href="https://github.com/WebAssembly/WASI/issues/513">https://github.com/WebAssembly/WASI/issues/513</a></li>
<li>[13] BPF BTF ËØ¶Ëß£Ôºö<a href="https://www.ebpf.top/post/kernel_btf/">https://www.ebpf.top/post/kernel_btf/</a></li>
<li>[14] BPF ÂèØÁßªÊ§çÊÄßÂíå CO-REÔºà‰∏ÄÊ¨°ÁºñËØëÔºåÂà∞Â§ÑËøêË°åÔºâÔºö<a href="https://cloud.tencent.com/developer/article/1802154">https://cloud.tencent.com/developer/article/1802154</a></li>
<li>[15] ÈæôËú•Á§æÂå∫ eBPF ÊäÄÊúØÊé¢Á¥¢ SIG <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>[16] eunomia-bpf È°πÁõÆÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>[17] eunomia-bpf È°πÁõÆÈæôËú• Gitee ÈïúÂÉèÔºö<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="Âú®-webassembly-‰∏≠‰ΩøÁî®-cc-Âíå-libbpf-ÁºñÂÜô-ebpf-Á®ãÂ∫è"><a class="header" href="#Âú®-webassembly-‰∏≠‰ΩøÁî®-cc-Âíå-libbpf-ÁºñÂÜô-ebpf-Á®ãÂ∫è">Âú® WebAssembly ‰∏≠‰ΩøÁî® C/C++ Âíå libbpf ÁºñÂÜô eBPF Á®ãÂ∫è</a></h1>
<blockquote>
<p>‰ΩúËÄÖÔºö‰∫éÊ°êÔºåÈÉëÊò±Á¨ô</p>
</blockquote>
<p>eBPFÔºàextended Berkeley Packet FilterÔºâÊòØ‰∏ÄÁßçÈ´òÊÄßËÉΩÁöÑÂÜÖÊ†∏ËôöÊãüÊú∫ÔºåÂèØ‰ª•ËøêË°åÂú®ÂÜÖÊ†∏Á©∫Èó¥‰∏≠ÔºåÁî®Êù•Êî∂ÈõÜÁ≥ªÁªüÂíåÁΩëÁªú‰ø°ÊÅØ„ÄÇÈöèÁùÄËÆ°ÁÆóÊú∫ÊäÄÊúØÁöÑ‰∏çÊñ≠ÂèëÂ±ïÔºåeBPF ÁöÑÂäüËÉΩÊó•ÁõäÂº∫Â§ßÔºåËøõËÄåË¢´Áî®Êù•ÊûÑÂª∫ÂêÑÁßçÊïàÁéáÈ´òÊïàÁöÑÂú®Á∫øËØäÊñ≠ÂíåË∑üË∏™Á≥ªÁªüÔºå‰ª•ÂèäÂÆâÂÖ®ÁöÑÁΩëÁªúÂíåÊúçÂä°ÁΩëÊ†º„ÄÇ</p>
<p>WebAssemblyÔºàWasmÔºâÊúÄÂàùÊòØ‰ª•ÊµèËßàÂô®ÂÆâÂÖ®Ê≤ôÁõí‰∏∫ÁõÆÁöÑÂºÄÂèëÁöÑÔºåÂèëÂ±ïÂà∞ÁõÆÂâç‰∏∫Ê≠¢ÔºåWebAssembly Â∑≤ÁªèÊàê‰∏∫‰∏Ä‰∏™Áî®‰∫é‰∫ëÂéüÁîüËΩØ‰ª∂ÁªÑ‰ª∂ÁöÑÈ´òÊÄßËÉΩ„ÄÅË∑®Âπ≥Âè∞ÂíåÂ§öËØ≠Ë®ÄËΩØ‰ª∂Ê≤ôÁÆ±ÁéØÂ¢ÉÔºåWasm ËΩªÈáèÁ∫ßÂÆπÂô®‰πüÈùûÂ∏∏ÈÄÇÂêà‰Ωú‰∏∫‰∏ã‰∏Ä‰ª£Êó†ÊúçÂä°Âô®Âπ≥Âè∞ËøêË°åÊó∂ÔºåÊàñÂú®ËæπÁºòËÆ°ÁÆóÁ≠âËµÑÊ∫êÂèóÈôêÁöÑÂú∫ÊôØÈ´òÊïàÊâßË°å„ÄÇ</p>
<p>Áé∞Âú®ÔºåÂÄüÂä© Wasm-bpf ÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂ÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî® Wasm Â∞Ü eBPF Á®ãÂ∫èÁºñÂÜô‰∏∫Ë∑®Âπ≥Âè∞ÁöÑÊ®°ÂùóÔºåÂêåÊó∂‰ΩøÁî® C/C++ Êàñ Rust Êù•ÁºñÂÜô Wasm Á®ãÂ∫è„ÄÇÈÄöËøáÂú® WebAssembly ‰∏≠‰ΩøÁî® eBPF Á®ãÂ∫èÔºåÊàë‰ª¨‰∏ç‰ªÖËÉΩËÆ© Wasm Â∫îÁî®‰∫´ÂèóÂà∞ eBPF ÁöÑÈ´òÊÄßËÉΩÂíåÂØπÁ≥ªÁªüÊé•Âè£ÁöÑËÆøÈóÆËÉΩÂäõÔºåËøòÂèØ‰ª•ËÆ© eBPF Á®ãÂ∫è‰ΩøÁî®Âà∞ Wasm ÁöÑÊ≤ôÁÆ±„ÄÅÁÅµÊ¥ªÊÄß„ÄÅË∑®Âπ≥Âè∞ÊÄß„ÄÅÂíåÂä®ÊÄÅÂä†ËΩΩÔºåÂπ∂‰∏î‰ΩøÁî® Wasm ÁöÑ OCI ÈïúÂÉèÊù•Êñπ‰æø„ÄÅÂø´Êç∑Âú∞ÂàÜÂèëÂíåÁÆ°ÁêÜ eBPF Á®ãÂ∫è„ÄÇÁªìÂêàËøô‰∏§ÁßçÊäÄÊúØÔºåÊàë‰ª¨Â∞Ü‰ºöÁªô eBPF Âíå Wasm ÁîüÊÄÅÊù•‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑÂºÄÂèë‰ΩìÈ™åÔºÅ</p>
<h2 id="‰ΩøÁî®-wasm-bpf-Â∑•ÂÖ∑ÈìæÂú®-wasm-‰∏≠ÁºñÂÜôÂä®ÊÄÅÂä†ËΩΩÂàÜÂèëËøêË°å-ebpf-Á®ãÂ∫è"><a class="header" href="#‰ΩøÁî®-wasm-bpf-Â∑•ÂÖ∑ÈìæÂú®-wasm-‰∏≠ÁºñÂÜôÂä®ÊÄÅÂä†ËΩΩÂàÜÂèëËøêË°å-ebpf-Á®ãÂ∫è">‰ΩøÁî® Wasm-bpf Â∑•ÂÖ∑ÈìæÂú® Wasm ‰∏≠ÁºñÂÜô„ÄÅÂä®ÊÄÅÂä†ËΩΩ„ÄÅÂàÜÂèëËøêË°å eBPF Á®ãÂ∫è</a></h2>
<p>Wasm-bpf ÊòØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑÂºÄÊ∫êÈ°πÁõÆÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a>„ÄÇÂÆÉÂÆö‰πâ‰∫Ü‰∏ÄÂ•ó eBPF Áõ∏ÂÖ≥Á≥ªÁªüÊé•Âè£ÁöÑÊäΩË±°ÔºåÂπ∂Êèê‰æõ‰∫Ü‰∏ÄÂ•óÂØπÂ∫îÁöÑÂºÄÂèëÂ∑•ÂÖ∑Èìæ„ÄÅÂ∫ì‰ª•ÂèäÈÄöÁî®ÁöÑ Wasm + eBPF ËøêË°åÊó∂ÂÆû‰æã„ÄÇÂÆÉÂèØ‰ª•Êèê‰æõÂíå libbpf-bootstrap Áõ∏‰ººÁöÑÂºÄÂèë‰ΩìÈ™åÔºåËá™Âä®ÁîüÊàêÂØπÂ∫îÁöÑ skeleton Â§¥Êñá‰ª∂Ôºå‰ª•ÂèäÁî®‰∫éÂú® Wasm Âíå eBPF ‰πãÈó¥Êó†Â∫èÂàóÂåñÈÄö‰ø°ÁöÑÊï∞ÊçÆÁªìÊûÑÂÆö‰πâ„ÄÇ‰Ω†ÂèØ‰ª•ÈùûÂ∏∏ÂÆπÊòìÂú∞‰ΩøÁî®‰ªª‰ΩïËØ≠Ë®ÄÔºåÂú®‰ªª‰ΩïÂπ≥Âè∞‰∏äÂª∫Á´ã‰Ω†Ëá™Â∑±ÁöÑ Wasm-eBPF ËøêË°åÊó∂Ôºå‰ΩøÁî®Áõ∏ÂêåÁöÑÂ∑•ÂÖ∑ÈìæÊù•ÊûÑÂª∫Â∫îÁî®„ÄÇÊõ¥ËØ¶ÁªÜÁöÑ‰ªãÁªçÔºåËØ∑ÂèÇËÄÉÊàë‰ª¨ÁöÑ‰∏ä‰∏ÄÁØáÂçöÂÆ¢Ôºö<a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">Wasm-bpf: Êû∂Ëµ∑ Webassembly Âíå eBPF ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢Å</a>„ÄÇ</p>
<p>Âü∫‰∫é WasmÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî®Â§öÁßçËØ≠Ë®ÄÊûÑÂª∫ eBPF Â∫îÁî®ÔºåÂπ∂‰ª•Áªü‰∏Ä„ÄÅËΩªÈáèÁ∫ßÁöÑÊñπÂºèÁÆ°ÁêÜÂíåÂèëÂ∏É„ÄÇ‰ª•Êàë‰ª¨ÊûÑÂª∫ÁöÑÁ§∫‰æãÂ∫îÁî® bootstrap.wasm ‰∏∫‰æãÔºåÂ§ßÂ∞è‰ªÖ‰∏∫ ~90KÔºåÂæàÂÆπÊòìÈÄöËøáÁΩëÁªúÂàÜÂèëÔºåÂπ∂ÂèØ‰ª•Âú®‰∏çÂà∞ 100ms ÁöÑÊó∂Èó¥ÂÜÖÂú®Âè¶‰∏ÄÂè∞Êú∫Âô®‰∏äÂä®ÊÄÅÈÉ®ÁΩ≤„ÄÅÂä†ËΩΩÂíåËøêË°åÔºåÂπ∂‰∏î‰øùÁïôËΩªÈáèÁ∫ßÂÆπÂô®ÁöÑÈöîÁ¶ªÁâπÊÄß„ÄÇËøêË°åÊó∂‰∏çÈúÄË¶ÅÂÜÖÊ†∏Â§¥Êñá‰ª∂„ÄÅLLVM„ÄÅclang Á≠â‰æùËµñÔºå‰πü‰∏çÈúÄË¶ÅÂÅö‰ªª‰ΩïÊ∂àËÄóËµÑÊ∫êÁöÑÈáçÈáèÁ∫ßÁöÑÁºñËØëÂ∑•‰Ωú„ÄÇ</p>
<p>Êú¨ÊñáÂ∞Ü‰ª• C/C++ ËØ≠Ë®Ä‰∏∫‰æãÔºåËÆ®ËÆ∫ C/C++ ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm Ê®°Âùó„ÄÇ‰ΩøÁî® Rust ËØ≠Ë®ÄÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm Ê®°ÂùóÁöÑÂÖ∑‰ΩìÁ§∫‰æãÔºåÂ∞ÜÂú®‰∏ã‰∏ÄÁØáÊñáÁ´†‰∏≠ÊèèËø∞„ÄÇ</p>
<p>Êàë‰ª¨Âú®‰ªìÂ∫ì‰∏≠Êèê‰æõ‰∫ÜÂá†‰∏™Á§∫‰æãÁ®ãÂ∫èÔºåÂàÜÂà´ÂØπÂ∫î‰∫éÂèØËßÇÊµã„ÄÅÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÂ§öÁßçÂú∫ÊôØ„ÄÇ</p>
<h2 id="‰ΩøÁî®-cc-ÁºñÂÜô-ebpf-Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫-wasm"><a class="header" href="#‰ΩøÁî®-cc-ÁºñÂÜô-ebpf-Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫-wasm">‰ΩøÁî® C/C++ ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm</a></h2>
<p>libbpf ÊòØ‰∏Ä‰∏™ C/C++ ÁöÑ eBPF Áî®Êà∑ÊÄÅÂä†ËΩΩÂíåÊéßÂà∂Â∫ìÔºåÈöèÁùÄÂÜÖÊ†∏‰∏ÄËµ∑ÂàÜÂèëÔºåÂá†‰πéÂ∑≤ÁªèÊàê‰∏∫ eBPF Áî®Êà∑ÊÄÅ‰∫ãÂÆû‰∏äÁöÑ API Ê†áÂáÜÔºålibbpf ‰πüÊîØÊåÅ CO-RE(Compile Once ‚Äì Run Everywhere) ÁöÑËß£ÂÜ≥ÊñπÊ°àÔºåÂç≥È¢ÑÁºñËØëÁöÑ bpf ‰ª£Á†ÅÂèØ‰ª•Âú®‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨‰∏äÊ≠£Â∏∏Â∑•‰ΩúÔºåËÄåÊó†ÈúÄ‰∏∫ÊØè‰∏™ÁâπÂÆöÂÜÖÊ†∏ÈáçÊñ∞ÁºñËØë„ÄÇÊàë‰ª¨Â∏åÊúõÂ∞ΩÂèØËÉΩÁöÑ‰øùÊåÅ‰∏é libbpf ÁöÑÁî®Êà∑ÊÄÅ API ‰ª•ÂèäË°å‰∏∫‰∏ÄËá¥ÔºåÂ∞ΩÂèØËÉΩÂáèÂ∞ëÂ∫îÁî®ËøÅÁßªÂà∞ Wasm ÔºàÂ¶ÇÊûúÈúÄË¶ÅÁöÑËØùÔºâÁöÑÊàêÊú¨„ÄÇ</p>
<p>libbpf-bootstrap ‰∏∫ÁîüÊàêÂü∫‰∫é libbpf ÁöÑ bpf Á®ãÂ∫èÊèê‰æõ‰∫ÜÊ®°Êùø,ÂºÄÂèëËÄÖÂèØ‰ª•ÂæàÊñπ‰æøÁöÑ‰ΩøÁî®ËØ•Ê®°ÊùøÁîüÊàêËá™ÂÆö‰πâÁöÑ bpf Á®ãÂ∫è„ÄÇ‰∏ÄËà¨ËØ¥Êù•ÔºåÂú®Èùû Wasm Ê≤ôÁÆ±ÁöÑÁî®Êà∑ÊÄÅÁ©∫Èó¥Ôºå‰ΩøÁî® libbpf-bootstrap ËÑöÊâãÊû∂ÔºåÂèØ‰ª•Âø´ÈÄü„ÄÅËΩªÊùæÂú∞‰ΩøÁî® C/C++ÊûÑÂª∫ BPF Â∫îÁî®Á®ãÂ∫è„ÄÇ</p>
<p>ÁºñËØë„ÄÅÊûÑÂª∫ÂíåËøêË°å eBPF Á®ãÂ∫èÔºàÊó†ËÆ∫ÊòØÈááÁî®‰ªÄ‰πàËØ≠Ë®ÄÔºâÔºåÈÄöÂ∏∏ÂåÖÂê´‰ª•‰∏ãÂá†‰∏™Ê≠•È™§Ôºö</p>
<ul>
<li>ÁºñÂÜôÂÜÖÊ†∏ÊÄÅ eBPF Á®ãÂ∫èÁöÑ‰ª£Á†ÅÔºå‰∏ÄËà¨‰ΩøÁî® C/C++ Êàñ Rust ËØ≠Ë®Ä</li>
<li>‰ΩøÁî® clang ÁºñËØëÂô®ÊàñËÄÖÁõ∏ÂÖ≥Â∑•ÂÖ∑ÈìæÁºñËØë eBPF Á®ãÂ∫èÔºàË¶ÅÂÆûÁé∞Ë∑®ÂÜÖÊ†∏ÁâàÊú¨ÁßªÊ§çÁöÑËØùÔºåÈúÄË¶ÅÂåÖÂê´ BTF ‰ø°ÊÅØÔºâ„ÄÇ</li>
<li>Âú®Áî®Êà∑ÊÄÅÁöÑÂºÄÂèëÁ®ãÂ∫è‰∏≠ÔºåÁºñÂÜôÂØπÂ∫îÁöÑÂä†ËΩΩ„ÄÅÊéßÂà∂„ÄÅÊåÇËΩΩ„ÄÅÊï∞ÊçÆÂ§ÑÁêÜÈÄªËæëÔºõ</li>
<li>Âú®ÂÆûÈôÖËøêË°åÁöÑÈò∂ÊÆµÔºå‰ªéÁî®Êà∑ÊÄÅÂ∞Ü eBPF Á®ãÂ∫èÂä†ËΩΩËøõÂÖ•ÂÜÖÊ†∏ÔºåÂπ∂ÂÆûÈôÖÊâßË°å„ÄÇ</li>
</ul>
<h3 id="bootstrap-2"><a class="header" href="#bootstrap-2">bootstrap</a></h3>
<p><code>bootstrap</code>ÊòØ‰∏Ä‰∏™ÁÆÄÂçïÔºà‰ΩÜÂÆûÁî®ÔºâÁöÑBPFÂ∫îÁî®Á®ãÂ∫èÁöÑ‰æãÂ≠ê„ÄÇÂÆÉË∑üË∏™ËøõÁ®ãÁöÑÂêØÂä®ÔºàÂáÜÁ°ÆÂú∞ËØ¥ÔºåÊòØ <code>exec()</code> Á≥ªÂàóÁöÑÁ≥ªÁªüË∞ÉÁî®ÔºâÂíåÈÄÄÂá∫ÔºåÂπ∂ÂèëÈÄÅÂÖ≥‰∫éÊñá‰ª∂Âêç„ÄÅPID Âíå Áà∂ PID ÁöÑÊï∞ÊçÆÔºå‰ª•ÂèäÈÄÄÂá∫Áä∂ÊÄÅÂíåËøõÁ®ãÁöÑÊåÅÁª≠Êó∂Èó¥„ÄÇÁî®<code>-d &lt;min-duration-ms&gt;</code> ‰Ω†ÂèØ‰ª•ÊåáÂÆöË¶ÅËÆ∞ÂΩïÁöÑËøõÁ®ãÁöÑÊúÄÂ∞èÊåÅÁª≠Êó∂Èó¥„ÄÇ</p>
<p><code>bootstrap</code> ÊòØÂú® <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a> ‰∏≠ÔºåÊ†πÊçÆ BCC ËΩØ‰ª∂ÂåÖ‰∏≠ÁöÑ<a href="https://github.com/iovisor/bcc/tree/master/libbpf-tools">libbpf-tools</a>ÁöÑÁ±ª‰ººÊÄùÊÉ≥ÂàõÂª∫ÁöÑÔºå‰ΩÜÂÆÉË¢´ËÆæËÆ°ÊàêÊõ¥Áã¨Á´ãÁöÑÔºåÂπ∂‰∏îÊúâÊõ¥ÁÆÄÂçïÁöÑ Makefile ‰ª•ÁÆÄÂåñÁî®Êà∑ÁöÑÁâπÊÆäÈúÄÊ±Ç„ÄÇÂÆÉÊºîÁ§∫‰∫ÜÂÖ∏ÂûãÁöÑBPFÁâπÊÄßÔºåÂåÖÂê´‰ΩøÁî®Â§ö‰∏™ BPF Á®ãÂ∫èÊÆµËøõË°åÂêà‰ΩúÔºå‰ΩøÁî® BPF map Êù•Áª¥Êä§Áä∂ÊÄÅÔºå‰ΩøÁî® BPF ring buffer Êù•ÂèëÈÄÅÊï∞ÊçÆÂà∞Áî®Êà∑Á©∫Èó¥Ôºå‰ª•Âèä‰ΩøÁî®ÂÖ®Â±ÄÂèòÈáèÊù•ÂèÇÊï∞ÂåñÂ∫îÁî®Á®ãÂ∫èË°å‰∏∫„ÄÇ</p>
<p>‰ª•‰∏ãÊòØÊàë‰ª¨‰ΩøÁî® Wasm ÁºñËØëËøêË°å <code>bootstrap</code> ÁöÑ‰∏Ä‰∏™ËæìÂá∫Á§∫‰æãÔºö</p>
<pre><code class="language-console">$ sudo sudo ./wasm-bpf bootstrap.wasm -h
BPF bootstrap demo application.

It traces process start and exits and shows associated
information (filename, process duration, PID and PPID, etc).

USAGE: ./bootstrap [-d &lt;min-duration-ms&gt;] -v
$ sudo ./wasm-bpf bootstrap.wasm
TIME     EVENT COMM             PID     PPID    FILENAME/EXIT CODE
18:57:58 EXEC  sed              74911   74910   /usr/bin/sed
18:57:58 EXIT  sed              74911   74910   [0] (2ms)
18:57:58 EXIT  cat              74912   74910   [0] (0ms)
18:57:58 EXEC  cat              74913   74910   /usr/bin/cat
18:57:59 EXIT  cat              74913   74910   [0] (0ms)
18:57:59 EXEC  cat              74914   74910   /usr/bin/cat
18:57:59 EXIT  cat              74914   74910   [0] (0ms)
18:57:59 EXEC  cat              74915   74910   /usr/bin/cat
18:57:59 EXIT  cat              74915   74910   [0] (1ms)
18:57:59 EXEC  sleep            74916   74910   /usr/bin/sleep
</code></pre>
<p>Êàë‰ª¨ÂèØ‰ª•Êèê‰æõ‰∏é libbpf-bootstrap ÂºÄÂèëÁõ∏‰ººÁöÑÂºÄÂèë‰ΩìÈ™å„ÄÇÂè™ÈúÄËøêË°å make Âç≥ÂèØÊûÑÂª∫ wasm ‰∫åËøõÂà∂Êñá‰ª∂Ôºö</p>
<pre><code class="language-console">git clone https://github.com/eunomia-bpf/wasm-bpf --recursive
cd examples/bootstrap
make
</code></pre>
<h3 id="ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ-ebpf-Á®ãÂ∫è-2"><a class="header" href="#ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ-ebpf-Á®ãÂ∫è-2">ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫è</a></h3>
<p>Ë¶ÅÊûÑÂª∫‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ eBPF Á®ãÂ∫èÔºåÈ¶ñÂÖàË¶ÅÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ bpf ‰ª£Á†Å„ÄÇÈÄöÂ∏∏‰ΩøÁî® C ËØ≠Ë®ÄÁºñÂÜôÔºåÂπ∂‰ΩøÁî® clang ÂÆåÊàêÁºñËØëÔºö</p>
<pre><code class="language-c">char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 8192);
    __type(key, pid_t);
    __type(value, u64);
} exec_start SEC(&quot;.maps&quot;);

struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);

const volatile unsigned long long min_duration_ns = 0;
const volatile int *name_ptr;

SEC(&quot;tp/sched/sched_process_exec&quot;)
int handle_exec(struct trace_event_raw_sched_process_exec *ctx)
{
    struct task_struct *task;
    unsigned fname_off;
    struct event *e;
    pid_t pid;
    u64 ts;
....
</code></pre>
<p>ÂèóÁØáÂπÖÊâÄÈôêÔºåËøôÈáåÊ≤°ÊúâË¥¥Âá∫ÂÆåÊï¥ÁöÑ‰ª£Á†Å„ÄÇÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÁöÑÁºñÂÜôÊñπÂºèÂíåÂÖ∂‰ªñÂü∫‰∫é libbpf ÁöÑÁ®ãÂ∫èÂÆåÂÖ®Áõ∏ÂêåÔºå‰∏ÄËà¨Êù•ËØ¥‰ºöÂåÖÂê´‰∏Ä‰∫õÂÖ®Â±ÄÂèòÈáèÔºåÈÄöËøá <code>SEC</code> Â£∞ÊòéÊåÇËΩΩÁÇπÁöÑ eBPF ÂáΩÊï∞Ôºå‰ª•ÂèäÁî®‰∫é‰øùÂ≠òÁä∂ÊÄÅÔºåÊàñËÄÖÂú®Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥Áõ∏‰∫íÈÄö‰ø°ÁöÑ map ÂØπË±°ÔºàÊàë‰ª¨ËøòÂú®ËøõË°åÂè¶Â§ñ‰∏ÄÈ°πÂ∑•‰ΩúÔºö<a href="https://github.com/iovisor/bcc/issues/4404">bcc to libbpf converter</a>ÔºåÁ≠âÂÆÉÂÆåÊàêÂêéÂ∞±ÂèØ‰ª•‰ª•ËøôÁßçÊñπÂºèÁºñËØë BCC È£éÊ†ºÁöÑ eBPF ÂÜÖÊ†∏ÊÄÅÁ®ãÂ∫èÔºâ„ÄÇÂú®ÁºñÂÜôÂÆå eBPF Á®ãÂ∫è‰πãÂêéÔºåËøêË°å <code>make</code> ‰ºöÂú® <code>Makefile</code> Ë∞ÉÁî® clang Âíå llvm-strip ÊûÑÂª∫BPFÁ®ãÂ∫èÔºå‰ª•Ââ•Á¶ªË∞ÉËØï‰ø°ÊÅØÔºö</p>
<pre><code class="language-shell">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I../../third_party/vmlinux/x86/ -idirafter /usr/local/include -idirafter /usr/include -c bootstrap.bpf.c -o bootstrap.bpf.o
llvm-strip -g bootstrap.bpf.o # strip useless DWARF info
</code></pre>
<p>‰πãÂêéÔºåÊàë‰ª¨‰ºöÊèê‰æõ‰∏Ä‰∏™‰∏∫‰∫Ü Wasm ‰∏ìÈó®ÂÆûÁé∞ÁöÑ bpftoolÔºåÁî®‰∫é‰ªé BPF Á®ãÂ∫èÁîüÊàêCÂ§¥Êñá‰ª∂Ôºö</p>
<pre><code class="language-shell">../../third_party/bpftool/src/bpftool gen skeleton -j bootstrap.bpf.o &gt; bootstrap.skel.h
</code></pre>
<p>Áî±‰∫é eBPF Êú¨Ë∫´ÁöÑÊâÄÊúâ C ÂÜÖÂ≠òÂ∏ÉÂ±ÄÊòØÂíåÂΩìÂâçÊâÄÂú®Êú∫Âô®ÁöÑÊåá‰ª§ÈõÜ‰∏ÄÊ†∑ÁöÑÔºå‰ΩÜÊòØ wasm ÊòØÊúâ‰∏ÄÂ•óÁ°ÆÂÆöÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÔºàÊØîÂ¶ÇÂΩìÂâçÊâÄÂú®Êú∫Âô®ÊòØ 64 ‰ΩçÁöÑÔºåWasm ËôöÊãüÊú∫ÈáåÈù¢ÊòØ 32 ‰ΩçÁöÑÔºåC struct layout „ÄÅÊåáÈíàÂÆΩÂ∫¶„ÄÅÂ§ßÂ∞èÁ´ØÁ≠âÁ≠âÈÉΩÂèØËÉΩ‰∏ç‰∏ÄÊ†∑ÔºâÔºå‰∏∫‰∫ÜÁ°Æ‰øù eBPF Á®ãÂ∫èËÉΩÊ≠£Á°ÆÂíå Wasm ‰πãÈó¥ËøõË°åÁõ∏‰∫íÈÄö‰ø°ÔºåÊàë‰ª¨ÈúÄË¶ÅÂÆöÂà∂‰∏Ä‰∏™‰∏ìÈó®ÁöÑ bpftool Á≠âÂ∑•ÂÖ∑ÔºåÂÆûÁé∞Ê≠£Á°ÆÁîüÊàêÂèØ‰ª•Âú® Wasm ‰∏≠Â∑•‰ΩúÁöÑÁî®Êà∑ÊÄÅÂºÄÂèëÊ°ÜÊû∂„ÄÇ</p>
<p>skel ÂåÖÂê´‰∏Ä‰∏™ BPF Á®ãÂ∫èÁöÑskeletonÔºåÁî®‰∫éÊìç‰Ωú BPF ÂØπË±°ÔºåÂπ∂ÊéßÂà∂ BPF Á®ãÂ∫èÁöÑÁîüÂëΩÂë®ÊúüÔºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-c">    struct bootstrap_bpf {
        struct bpf_object_skeleton *skeleton;
        struct bpf_object *obj;
        struct {
            struct bpf_map *exec_start;
            struct bpf_map *rb;
            struct bpf_map *rodata;
        } maps;
        struct {
            struct bpf_program *handle_exec;
            struct bpf_program *handle_exit;
        } progs;
        struct bootstrap_bpf__rodata {
            unsigned long long min_duration_ns;
        } *rodata;
        struct bootstrap_bpf__bss {
            uint64_t /* pointer */ name_ptr;
        } *bss;
    };
</code></pre>
<p>Êàë‰ª¨‰ºöÂ∞ÜÊâÄÊúâÊåáÈíàÈÉΩÂ∞ÜÊ†πÊçÆ eBPF Á®ãÂ∫èÁõÆÊ†áÊâÄÂú®ÁöÑÊåá‰ª§ÈõÜÁöÑÊåáÈíàÂ§ßÂ∞èËΩ¨Êç¢‰∏∫Êï¥Êï∞Ôºå‰æãÂ¶ÇÔºå<code>name_ptr</code>„ÄÇÊ≠§Â§ñÔºåÂ°´ÂÖÖÂ≠óËäÇÂ∞ÜÊòéÁ°ÆÊ∑ªÂä†Âà∞ÁªìÊûÑ‰Ωì‰∏≠‰ª•Á°Æ‰øùÁªìÊûÑ‰ΩìÂ∏ÉÂ±Ä‰∏éÁõÆÊ†áÁ´ØÁõ∏ÂêåÔºå‰æãÂ¶Ç‰ΩøÁî® <code>char __pad0[4];</code>„ÄÇÊàë‰ª¨Ëøò‰ºö‰ΩøÁî® <code>static_assert</code> Êù•Á°Æ‰øùÁªìÊûÑ‰ΩìÁöÑÂÜÖÂ≠òÈïøÂ∫¶ÂíåÂéüÂÖà BTF ‰ø°ÊÅØ‰∏≠ÁöÑÁ±ªÂûãÈïøÂ∫¶Áõ∏Âêå„ÄÇ</p>
<h3 id="ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ-wasm-‰ª£Á†ÅÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ-2"><a class="header" href="#ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ-wasm-‰ª£Á†ÅÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ-2">ÊûÑÂª∫Áî®Êà∑ÊÄÅÁöÑ Wasm ‰ª£Á†ÅÔºåÂπ∂Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÊï∞ÊçÆ</a></h3>
<p>Êàë‰ª¨ÈªòËÆ§‰ΩøÁî® wasi-sdk ‰ªé C/C++ ‰ª£Á†ÅÊûÑÂª∫ wasm ‰∫åËøõÂà∂Êñá‰ª∂„ÄÇÊÇ®‰πüÂèØ‰ª•‰ΩøÁî® emcc Â∑•ÂÖ∑ÈìæÊù•ÊûÑÂª∫ wasm ‰∫åËøõÂà∂Êñá‰ª∂ÔºåÂëΩ‰ª§Â∫îËØ•ÊòØÁõ∏‰ººÁöÑ„ÄÇÊÇ®ÂèØ‰ª•ËøêË°å‰ª•‰∏ãÂëΩ‰ª§Êù•ÂÆâË£Ö wasi-sdkÔºö</p>
<pre><code class="language-sh">wget https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-17/wasi-sdk-17.0-linux.tar.gz
tar -zxf wasi-sdk-17.0-linux.tar.gz
sudo mkdir -p /opt/wasi-sdk/ &amp;&amp; sudo mv wasi-sdk-17.0/* /opt/wasi-sdk/
</code></pre>
<p>ÁÑ∂ÂêéËøêË°å <code>make</code> ‰ºöÂú® <code>Makefile</code> ‰∏≠‰ΩøÁî® wasi-clang ÁºñËØë C ‰ª£Á†ÅÔºåÁîüÊàê Wasm Â≠óËäÇÁ†ÅÔºö</p>
<pre><code class="language-sh">/opt/wasi-sdk/bin/clang -O2 --sysroot=/opt/wasi-sdk/share/wasi-sysroot -Wl,--allow-undefined -o bootstrap.wasm bootstrap.c
</code></pre>
<p>Áî±‰∫éÂÆø‰∏ªÊú∫ÔºàÊàñ eBPF Á´ØÔºâÁöÑ C ÁªìÊûÑÂ∏ÉÂ±ÄÂèØËÉΩ‰∏éÁõÆÊ†áÔºàWasm Á´ØÔºâÁöÑÁªìÊûÑÂ∏ÉÂ±Ä‰∏çÂêåÔºåÂõ†Ê≠§ÊÇ®ÂèØ‰ª•‰ΩøÁî® ecc ÂíåÊàë‰ª¨ÁöÑ wasm-bpftool ÁîüÊàêÁî®Êà∑Á©∫Èó¥‰ª£Á†ÅÁöÑ C Â§¥Êñá‰ª∂Ôºö</p>
<pre><code class="language-sh">ecc bootstrap.h --header-only
../../third_party/bpftool/src/bpftool btf dump file bootstrap.bpf.o format c -j &gt; bootstrap.wasm.h
</code></pre>
<p>‰æãÂ¶ÇÔºåÂéüÂÖàÂÜÖÊ†∏ÊÄÅÁöÑÂ§¥Êñá‰ª∂‰∏≠ÁªìÊûÑ‰ΩìÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
<pre><code class="language-c">struct event {
    int pid;
    int ppid;
    unsigned exit_code;
    unsigned long long duration_ns;
    char comm[TASK_COMM_LEN];
    char filename[MAX_FILENAME_LEN];
    char exit_event;
};
</code></pre>
<p>Êàë‰ª¨ÁöÑÂ∑•ÂÖ∑‰ºöÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫Ôºö</p>
<pre><code class="language-c">struct event {
    int pid;
    int ppid;
    unsigned int exit_code;
    char __pad0[4];
    unsigned long long duration_ns;
    char comm[16];
    char filename[127];
    char exit_event;
} __attribute__((packed));
static_assert(sizeof(struct event) == 168, &quot;Size of event is not 168&quot;);
</code></pre>
<p>**Ê≥®ÊÑèÔºöÊ≠§ËøáÁ®ãÂíåÂ∑•ÂÖ∑Âπ∂‰∏çÊÄªÊòØÂøÖÈúÄÁöÑÔºåÂØπ‰∫éÁÆÄÂçïÁöÑÂ∫îÁî®Ôºå‰Ω†ÂèØ‰ª•ÊâãÂä®ÂÆåÊàê„ÄÇ**ÂØπ‰∫éÂÜÖÊ†∏ÊÄÅÂíå Wasm Â∫îÁî®ÈÉΩ‰ΩøÁî® C/C++ ËØ≠Ë®ÄÁöÑÊÉÖÂÜµ‰∏ãÔºå‰Ω†ÂèØ‰ª•ÊâãÂä®ÁºñÂÜôÊâÄÊúâ‰∫ã‰ª∂ÁªìÊûÑ‰ΩìÂÆö‰πâÔºå‰ΩøÁî® <code>__attribute__((packed))</code> ÈÅøÂÖçÂ°´ÂÖÖÂ≠óËäÇÔºåÂπ∂Âú®‰∏ªÊú∫Âíå wasm Á´Ø‰πãÈó¥ËΩ¨Êç¢ÊâÄÊúâÊåáÈíà‰∏∫Ê≠£Á°ÆÁöÑÊï¥Êï∞„ÄÇÊâÄÊúâÁ±ªÂûãÂøÖÈ°ªÂú® wasm ‰∏≠ÂÆö‰πâ‰∏é‰∏ªÊú∫Á´ØÁõ∏ÂêåÁöÑÂ§ßÂ∞èÂíåÂ∏ÉÂ±Ä„ÄÇ</p>
<p>ÂØπ‰∫éÂ§çÊùÇÁöÑÁ®ãÂ∫èÔºåÊâãÂä®Á°ÆËÆ§ÂÜÖÂ≠òÂ∏ÉÂ±ÄÁöÑÊ≠£Á°ÆÊòØÂàÜÂõ∞ÈöæÔºåÂõ†Ê≠§Êàë‰ª¨ÂàõÂª∫‰∫Ü wasm ÁâπÂÆöÁöÑ <code>bpftool</code>ÔºåÁî®‰∫é‰ªé <code>BTF</code> ‰ø°ÊÅØ‰∏≠ÁîüÊàêÂåÖÂê´ÊâÄÊúâÁ±ªÂûãÂÆö‰πâÂíåÊ≠£Á°ÆÁªìÊûÑ‰ΩìÂ∏ÉÂ±ÄÁöÑ C Â§¥Êñá‰ª∂Ôºå‰ª•‰æøÁî®Êà∑Á©∫Èó¥‰ª£Á†Å‰ΩøÁî®„ÄÇÂèØ‰ª•ÈÄöËøáÁ±ª‰ººÁöÑÊñπÊ°àÔºå‰∏ÄÊ¨°ÊÄßÂ∞Ü eBPF Á®ãÂ∫è‰∏≠ÊâÄÊúâÁöÑÁªìÊûÑ‰ΩìÂÆö‰πâËΩ¨Êç¢‰∏∫ Wasm Á´ØÁöÑÂÜÖÂ≠òÂ∏ÉÂ±ÄÔºåÂπ∂Á°Æ‰øùÂ§ßÂ∞èÁ´Ø‰∏ÄËá¥ÔºåÂç≥ÂèØÊ≠£Á°ÆËÆøÈóÆ„ÄÇ</p>
<p>ÂØπ‰∫é Wasm ‰∏≠‰∏çÊòØÁî± C ËØ≠Ë®ÄËøõË°åÂºÄÂèëÁöÑÊÉÖÂÜµ‰∏ãÔºåÂÄüÂä© Wasm ÁöÑÁªÑ‰ª∂Ê®°ÂûãÔºåÊàë‰ª¨ËøòÂèØ‰ª•Â∞ÜËøô‰∫õ BTF ‰ø°ÊÅØÁªìÊûÑ‰ΩìÂÆö‰πâ‰Ωú‰∏∫ wit Á±ªÂûãÂ£∞ÊòéËæìÂá∫ÔºåÁÑ∂ÂêéÂú®Áî®Êà∑Á©∫Èó¥‰ª£Á†Å‰∏≠‰ΩøÁî® wit-bindgen Â∑•ÂÖ∑‰∏ÄÊ¨°ÊÄßÁîüÊàêÂ§öÁßçËØ≠Ë®ÄÔºàÂ¶Ç C/C++/Rust/GoÔºâÁöÑÁ±ªÂûãÂÆö‰πâ„ÄÇËøôÈÉ®ÂàÜ‰ºöÂú®ÂÖ≥‰∫éÂ¶Ç‰Ωï‰ΩøÁî® Rust Âú® Wasm ‰∏≠ÁºñÂÜô eBPF Á®ãÂ∫èÁöÑÈÉ®ÂàÜËØ¶ÁªÜÊèèËø∞ÔºåÊàë‰ª¨‰πü‰ºöÂ∞ÜËøô‰∫õÊ≠•È™§ÂíåÂ∑•ÂÖ∑ÈìæÁªßÁª≠ÂÆåÂñÑÔºå‰ª•ÊîπËøõ Wasm-bpf Á®ãÂ∫èÁöÑÁºñÁ®ã‰ΩìÈ™å„ÄÇ</p>
<p>Êàë‰ª¨‰∏∫ wasm Á®ãÂ∫èÊèê‰æõ‰∫Ü‰∏Ä‰∏™‰ªÖÂåÖÂê´Â§¥Êñá‰ª∂ÁöÑ libbpf API Â∫ìÔºåÊÇ®ÂèØ‰ª•Âú® libbpf-wasm.hÔºàwasm-include/libbpf-wasm.hÔºâ‰∏≠ÊâæÂà∞ÂÆÉÔºåÂÆÉÂåÖÂê´‰∫Ü‰∏ÄÈÉ®ÂàÜ libbpf Â∏∏Áî®ÁöÑÁî®Êà∑ÊÄÅ API ÂíåÁ±ªÂûãÂÆö‰πâ„ÄÇWasm Á®ãÂ∫èÂèØ‰ª•‰ΩøÁî® libbpf API Êìç‰Ωú BPF ÂØπË±°Ôºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-c">/* Load and verify BPF application */
skel = bootstrap_bpf__open();
/* Parameterize BPF code with minimum duration parameter */
skel-&gt;rodata-&gt;min_duration_ns = env.min_duration_ms * 1000000ULL;
/* Load &amp; verify BPF programs */
err = bootstrap_bpf__load(skel);
/* Attach tracepoints */
err = bootstrap_bpf__attach(skel);
</code></pre>
<p>rodata ÈÉ®ÂàÜÁî®‰∫éÂ≠òÂÇ® BPF Á®ãÂ∫è‰∏≠ÁöÑÂ∏∏ÈáèÔºåËøô‰∫õÂÄºÂ∞ÜÂú® bpftool gen skeleton ÁöÑÊó∂ÂÄôÁî±‰ª£Á†ÅÁîüÊàêÊò†Â∞ÑÂà∞ object ‰∏≠Ê≠£Á°ÆÁöÑÂÅèÁßªÈáè,ÁÑ∂ÂêéÂú® open ‰πãÂêéÈÄöËøáÂÜÖÂ≠òÊò†Â∞Ñ‰øÆÊîπÂØπÂ∫îÁöÑÂÄºÔºåÂõ†Ê≠§‰∏çÈúÄË¶ÅÂú® Wasm ‰∏≠ÁºñËØë libelf Â∫ìÔºåËøêË°åÊó∂‰ªçÂèØÂä®ÊÄÅÂä†ËΩΩÂíåÊìç‰Ωú BPF ÂØπË±°„ÄÇ</p>
<p>Wasm Á´ØÁöÑ C ‰ª£Á†Å‰∏éÊú¨Âú∞ libbpf ‰ª£Á†ÅÁï•Êúâ‰∏çÂêåÔºå‰ΩÜÂÆÉÂèØ‰ª•‰ªé eBPF Á´ØÊèê‰æõÂ§ßÈÉ®ÂàÜÂäüËÉΩÔºå‰æãÂ¶ÇÔºå‰ªéÁéØÂΩ¢ÁºìÂÜ≤Âå∫Êàñ perf ÁºìÂÜ≤Âå∫ËΩÆËØ¢Ôºå‰ªé Wasm Á´ØÂíå eBPF Á´ØËÆøÈóÆÊò†Â∞ÑÔºåÂä†ËΩΩ„ÄÅÈôÑÂä†ÂíåÂàÜÁ¶ª BPF Á®ãÂ∫èÁ≠â„ÄÇÂÆÉÂèØ‰ª•ÊîØÊåÅÂ§ßÈáèÁöÑ eBPF Á®ãÂ∫èÁ±ªÂûãÂíåÊò†Â∞ÑÔºåÊ∂µÁõñ‰ªéË∑üË∏™„ÄÅÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÊñπÈù¢ÁöÑÂ§ßÂ§öÊï∞ eBPF Á®ãÂ∫èÁöÑ‰ΩøÁî®Âú∫ÊôØ„ÄÇ</p>
<p>Áî±‰∫é Wasm Á´ØÁº∫Â∞ë‰∏Ä‰∫õÂäüËÉΩÔºå‰æãÂ¶Ç signal handler Ëøò‰∏çÊîØÊåÅÔºà2023Âπ¥2ÊúàÔºâÔºåÂéüÂßãÁöÑC‰ª£Á†ÅÊúâÂèØËÉΩÊó†Ê≥ïÁõ¥Êé•ÁºñËØë‰∏∫ wasmÔºåÊÇ®ÈúÄË¶ÅÁ®çÂæÆ‰øÆÊîπ‰ª£Á†Å‰ª•‰ΩøÂÖ∂Â∑•‰Ωú„ÄÇÊàë‰ª¨Â∞ÜÂ∞ΩÊúÄÂ§ßÂä™Âäõ‰Ωø wasm Á´ØÁöÑ libbpf API ‰∏éÈÄöÂ∏∏Âú®Áî®Êà∑Á©∫Èó¥ËøêË°åÁöÑ libbpf APIÂ∞ΩÂèØËÉΩÁõ∏‰ººÔºå‰ª•‰æøÁî®Êà∑Á©∫Èó¥‰ª£Á†ÅÂèØ‰ª•Âú®Êú™Êù•Áõ¥Êé•ÁºñËØë‰∏∫ wasm„ÄÇÊàë‰ª¨ËøòÂ∞ÜÂ∞ΩÂø´Êèê‰æõÊõ¥Â§öËØ≠Ë®ÄÁªëÂÆöÔºàGoÁ≠âÔºâÁöÑ wasm ‰æß eBPF Á®ãÂ∫èÂºÄÂèëÂ∫ì„ÄÇ</p>
<p>ÂèØ‰ª•Âú®Áî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠‰ΩøÁî® polling API Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅ‰∏ä‰º†ÁöÑÊï∞ÊçÆ„ÄÇÂÆÉÂ∞ÜÊòØ ring buffer Âíå perf buffer ÁöÑ‰∏Ä‰∏™Â∞ÅË£ÖÔºåÁî®Êà∑Á©∫Èó¥‰ª£Á†ÅÂèØ‰ª•‰ΩøÁî®Áõ∏ÂêåÁöÑ API ‰ªéÁéØÂΩ¢ÁºìÂÜ≤Âå∫ÊàñÊÄßËÉΩÁºìÂÜ≤Âå∫‰∏≠ËΩÆËØ¢‰∫ã‰ª∂ÔºåÂÖ∑‰ΩìÂèñÂÜ≥‰∫éBPFÁ®ãÂ∫è‰∏≠ÊåáÂÆöÁöÑÁ±ªÂûã„ÄÇ‰æãÂ¶ÇÔºåÁéØÂΩ¢ÁºìÂÜ≤Âå∫ËΩÆËØ¢ÂÆö‰πâ‰∏∫<code>BPF_MAP_TYPE_RINGBUF</code>Ôºö</p>
<pre><code class="language-c">struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);
    __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);
</code></pre>
<p>‰Ω†ÂèØ‰ª•Âú®Áî®Êà∑ÊÄÅ‰ΩøÁî®‰ª•‰∏ã‰ª£Á†Å‰ªé ring buffer ‰∏≠ËΩÆËØ¢‰∫ã‰ª∂Ôºö</p>
<pre><code class="language-c">rb = bpf_buffer__open(skel-&gt;maps.rb, handle_event, NULL);
/* Process events */
printf(&quot;%-8s %-5s %-16s %-7s %-7s %s\n&quot;, &quot;TIME&quot;, &quot;EVENT&quot;, &quot;COMM&quot;, &quot;PID&quot;,
       &quot;PPID&quot;, &quot;FILENAME/EXIT CODE&quot;);
while (!exiting) {
    // poll buffer
    err = bpf_buffer__poll(rb, 100 /* timeout, ms */);
</code></pre>
<p>ring buffer polling ‰∏çÈúÄË¶ÅÂ∫èÂàóÂåñÂºÄÈîÄ„ÄÇbpf_buffer__poll API Â∞ÜË∞ÉÁî® handle_event ÂõûË∞ÉÂáΩÊï∞Êù•Â§ÑÁêÜÁéØÂΩ¢ÁºìÂÜ≤Âå∫‰∏≠ÁöÑ‰∫ã‰ª∂Êï∞ÊçÆÔºö</p>
<pre><code class="language-c">
static int
handle_event(void *ctx, void *data, size_t data_sz)
{
    const struct event *e = data;
    ...
    if (e-&gt;exit_event) {
        printf(&quot;%-8s %-5s %-16s %-7d %-7d [%u]&quot;, ts, &quot;EXIT&quot;, e-&gt;comm, e-&gt;pid,
               e-&gt;ppid, e-&gt;exit_code);
        if (e-&gt;duration_ns)
            printf(&quot; (%llums)&quot;, e-&gt;duration_ns / 1000000);
        printf(&quot;\n&quot;);
    }
    ...
    return 0;
}
</code></pre>
<p>ËøêË°åÊó∂Âü∫‰∫é libbpf CO-REÔºàCompile Once, Run EverywhereÔºâAPIÔºåÁî®‰∫éÂ∞Ü bpf ÂØπË±°Âä†ËΩΩÂà∞ÂÜÖÊ†∏‰∏≠ÔºåÂõ†Ê≠§ wasm-bpf Á®ãÂ∫è‰∏çÂèóÂÆÉÁºñËØëÁöÑÂÜÖÊ†∏ÁâàÊú¨ÁöÑÂΩ±ÂìçÔºåÂèØ‰ª•Âú®‰ªª‰ΩïÊîØÊåÅ BPF CO-RE ÁöÑÂÜÖÊ†∏ÁâàÊú¨‰∏äËøêË°å„ÄÇ</p>
<h3 id="‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞-ebpf-Á®ãÂ∫èÁöÑ-map-Êï∞ÊçÆ-2"><a class="header" href="#‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞-ebpf-Á®ãÂ∫èÁöÑ-map-Êï∞ÊçÆ-2">‰ªéÁî®Êà∑ÊÄÅÁ®ãÂ∫è‰∏≠ËÆøÈóÆÂíåÊõ¥Êñ∞ eBPF Á®ãÂ∫èÁöÑ map Êï∞ÊçÆ</a></h3>
<p>runqlat ÊòØ‰∏Ä‰∏™Êõ¥Â§çÊùÇÁöÑÁ§∫‰æãÔºåËøô‰∏™Á®ãÂ∫èÈÄöËøáÁõ¥ÊñπÂõæÂ±ïÁ§∫Ë∞ÉÂ∫¶Âô®ËøêË°åÈòüÂàóÂª∂ËøüÔºåÁªôÊàë‰ª¨Â±ïÁé∞‰∫Ü‰ªªÂä°Á≠â‰∫ÜÂ§ö‰πÖÊâçËÉΩËøêË°å„ÄÇ</p>
<pre><code class="language-console">$ sudo ./wasm-bpf runqlat.wasm -h
Summarize run queue (scheduler) latency as a histogram.

USAGE: runqlat [--help] [interval] [count]

EXAMPLES:
    runqlat         # summarize run queue latency as a histogram
    runqlat 1 10    # print 1 second summaries, 10 times
$ sudo ./wasm-bpf runqlat.wasm 1

Tracing run queue latency... Hit Ctrl-C to end.

     usecs               : count    distribution
         0 -&gt; 1          : 72       |*****************************           |
         2 -&gt; 3          : 93       |*************************************   |
         4 -&gt; 7          : 98       |****************************************|
         8 -&gt; 15         : 96       |*************************************** |
        16 -&gt; 31         : 38       |***************                         |
        32 -&gt; 63         : 4        |*                                       |
        64 -&gt; 127        : 5        |**                                      |
       128 -&gt; 255        : 6        |**                                      |
       256 -&gt; 511        : 0        |                                        |
       512 -&gt; 1023       : 0        |                                        |
      1024 -&gt; 2047       : 0        |                                        |
      2048 -&gt; 4095       : 1        |                                        |
</code></pre>
<p>runqlat ‰∏≠‰ΩøÁî® <code>map</code> API Êù•‰ªéÁî®Êà∑ÊÄÅËÆøÈóÆÂÜÖÊ†∏ÈáåÁöÑ <code>map</code> Âπ∂Áõ¥Êé•ËØªÂèñÊï∞ÊçÆÔºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-c">    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_lookup_elem(fd, &amp;next_key, &amp;hist);
        ...
        lookup_key = next_key;
    }
    lookup_key = -2;
    while (!bpf_map_get_next_key(fd, &amp;lookup_key, &amp;next_key)) {
        err = bpf_map_delete_elem(fd, &amp;next_key);
        ...
        lookup_key = next_key;
    }
</code></pre>
<p>ËøêË°åÊó∂ wasm ‰ª£Á†ÅÂ∞Ü‰ºö‰ΩøÁî®ÂÖ±‰∫´ÂÜÖÂ≠òÊù•ËÆøÈóÆÂÜÖÊ†∏ mapÔºåÂÜÖÊ†∏ÊÄÅÂèØ‰ª•Áõ¥Êé•ÊääÊï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑ÊÄÅ Wasm ËôöÊãüÊú∫ÁöÑÂ†ÜÊ†à‰∏≠ÔºåËÄå‰∏çÈúÄË¶ÅÈù¢ÂØπÁî®Êà∑ÊÄÅ‰∏ªÊú∫‰æßÁ®ãÂ∫èÂíå Wasm ËøêË°åÊó∂‰πãÈó¥ÁöÑÈ¢ùÂ§ñÊã∑Ë¥ùÂºÄÈîÄ„ÄÇÂêåÊ†∑ÔºåÂØπ‰∫é Wasm ËôöÊãüÊú∫ÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥ÂÖ±‰∫´ÁöÑÁ±ªÂûãÂÆö‰πâÔºåÈúÄË¶ÅÁªèËøá‰ªîÁªÜÊ£ÄÊü•‰ª•Á°Æ‰øùÂÆÉ‰ª¨Âú® Wasm ÂíåÂÜÖÊ†∏ÊÄÅ‰∏≠ÁöÑÁ±ªÂûãÊòØ‰∏ÄËá¥ÁöÑ„ÄÇ</p>
<p>ÂèØ‰ª•‰ΩøÁî® <code>bpf_map_update_elem</code> Âú®Áî®Êà∑ÊÄÅÁ®ãÂ∫èÂÜÖÊõ¥Êñ∞ÂÜÖÊ†∏ÁöÑ eBPF mapÔºåÊØîÂ¶Ç:</p>
<pre><code class="language-c">        cg_map_fd = bpf_map__fd(obj-&gt;maps.cgroup_map);
        cgfd = open(env.cgroupspath, O_RDONLY);
        if (cgfd &lt; 0) {
            ...
        }
        if (bpf_map_update_elem(cg_map_fd, &amp;idx, &amp;cgfd, BPF_ANY)) {
            ...
        }
</code></pre>
<p>Âõ†Ê≠§ÂÜÖÊ†∏ÁöÑ eBPF Á®ãÂ∫èÂèØ‰ª•‰ªé Wasm ‰æßÁöÑÁ®ãÂ∫èËé∑ÂèñÈÖçÁΩÆÔºåÊàñËÄÖÂú®ËøêË°åÁöÑÊó∂ÂÄôÊé•Êî∂Ê∂àÊÅØ„ÄÇ</p>
<h3 id="Êõ¥Â§öÁöÑ‰æãÂ≠êsocket-filter-Âíå-lsm-1"><a class="header" href="#Êõ¥Â§öÁöÑ‰æãÂ≠êsocket-filter-Âíå-lsm-1">Êõ¥Â§öÁöÑ‰æãÂ≠êÔºösocket filter Âíå lsm</a></h3>
<p>Âú®‰ªìÂ∫ì‰∏≠ÔºåÊàë‰ª¨ËøòÊèê‰æõ‰∫ÜÊõ¥Â§öÁöÑÁ§∫‰æãÔºå‰æãÂ¶Ç‰ΩøÁî® socket filter ÁõëÊéßÂíåËøáÊª§Êï∞ÊçÆÂåÖÔºö</p>
<pre><code class="language-c">SEC(&quot;socket&quot;)
int socket_handler(struct __sk_buff *skb)
{
    struct so_event *e;
    __u8 verlen;
    __u16 proto;
    __u32 nhoff = ETH_HLEN;

    bpf_skb_load_bytes(skb, 12, &amp;proto, 2);
    ...

    bpf_skb_load_bytes(skb, nhoff + 0, &amp;verlen, 1);
    bpf_skb_load_bytes(skb, nhoff + ((verlen &amp; 0xF) &lt;&lt; 2), &amp;(e-&gt;ports), 4);
    e-&gt;pkt_type = skb-&gt;pkt_type;
    e-&gt;ifindex = skb-&gt;ifindex;
    bpf_ringbuf_submit(e, 0);

    return skb-&gt;len;
}
</code></pre>
<p>Linux Security ModulesÔºàLSMÔºâÊòØ‰∏Ä‰∏™Âü∫‰∫éÈí©Â≠êÁöÑÊ°ÜÊû∂ÔºåÁî®‰∫éÂú®LinuxÂÜÖÊ†∏‰∏≠ÂÆûÁé∞ÂÆâÂÖ®Á≠ñÁï•ÂíåÂº∫Âà∂ËÆøÈóÆÊéßÂà∂„ÄÇÁõ¥Âà∞Áé∞Âú®ÔºåËÉΩÂ§üÂÆûÁé∞ÂÆûÊñΩÂÆâÂÖ®Á≠ñÁï•ÁõÆÊ†áÁöÑÊñπÂºèÂè™Êúâ‰∏§ÁßçÈÄâÊã©ÔºåÈÖçÁΩÆÁé∞ÊúâÁöÑLSMÊ®°ÂùóÔºàÂ¶ÇAppArmor„ÄÅSELinuxÔºâÔºåÊàñÁºñÂÜôËá™ÂÆö‰πâÂÜÖÊ†∏Ê®°Âùó„ÄÇ</p>
<p>Linux Kernel 5.7 ÂºïÂÖ•‰∫ÜÁ¨¨‰∏âÁßçÊñπÂºèÔºöLSM eBPF„ÄÇLSM BPF ÂÖÅËÆ∏ÂºÄÂèë‰∫∫ÂëòÁºñÂÜôËá™ÂÆö‰πâÁ≠ñÁï•ÔºåËÄåÊó†ÈúÄÈÖçÁΩÆÊàñÂä†ËΩΩÂÜÖÊ†∏Ê®°Âùó„ÄÇLSM BPF Á®ãÂ∫èÂú®Âä†ËΩΩÊó∂Ë¢´È™åËØÅÔºåÁÑ∂ÂêéÂú®Ë∞ÉÁî®Ë∑ØÂæÑ‰∏≠ÔºåÂà∞ËææLSMÈí©Â≠êÊó∂Ë¢´ÊâßË°å„ÄÇ‰æãÂ¶ÇÔºåÊàë‰ª¨ÂèØ‰ª•Âú® Wasm ËΩªÈáèÁ∫ßÂÆπÂô®‰∏≠Ôºå‰ΩøÁî® lsm ÈôêÂà∂Êñá‰ª∂Á≥ªÁªüÊìç‰ΩúÔºö</p>
<pre><code class="language-c">// all lsm the hook point refer https://www.kernel.org/doc/html/v5.2/security/LSM.html
SEC(&quot;lsm/path_rmdir&quot;)
int path_rmdir(const struct path *dir, struct dentry *dentry) {
  char comm[16];
  bpf_get_current_comm(comm, sizeof(comm));
  unsigned char dir_name[] = &quot;can_not_rm&quot;;
  unsigned char d_iname[32];
  bpf_probe_read_kernel(&amp;d_iname[0], sizeof(d_iname),
                        &amp;(dir-&gt;dentry-&gt;d_iname[0]));

  bpf_printk(&quot;comm %s try to rmdir %s&quot;, comm, d_iname);
  for (int i = 0;i&lt;sizeof(dir_name);i++){
    if (d_iname[i]!=dir_name[i]){
        return 0;
    }
  }
  return -1;
}
</code></pre>
<h2 id="ÊÄªÁªì"><a class="header" href="#ÊÄªÁªì">ÊÄªÁªì</a></h2>
<p>Êú¨‰ª• C/C++ ËØ≠Ë®Ä‰∏∫‰æãÔºåËÆ®ËÆ∫‰∫ÜÂ¶Ç‰Ωï‰ΩøÁî® C/C++ ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm Ê®°Âùó„ÄÇÊõ¥ÂÆåÊï¥ÁöÑ‰ª£Á†ÅÔºåËØ∑ÂèÇËÄÉÊàë‰ª¨ÁöÑ Github ‰ªìÂ∫ìÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a>.</p>
<p>Âú®‰∏ã‰∏ÄÁØáÊñáÁ´†‰∏≠ÔºåÊàë‰ª¨‰ºöËÆ®ËÆ∫‰ΩøÁî® Rust ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm Ê®°ÂùóÔºåÂπ∂‰ΩøÁî® OCI ÈïúÂÉèÂèëÂ∏É„ÄÅÈÉ®ÁΩ≤„ÄÅÁÆ°ÁêÜ eBPF Á®ãÂ∫èÔºåËé∑ÂæóÁ±ª‰ºº Docker ÁöÑ‰ΩìÈ™å„ÄÇ</p>
<p>Êé•‰∏ãÊù•ÔºåÊàë‰ª¨‰πü‰ºöÁªßÁª≠ÂÆåÂñÑÂú® Wasm ‰∏≠‰ΩøÁî®Â§öÁßçËØ≠Ë®ÄÂºÄÂèëÂíåËøêË°å eBPF Á®ãÂ∫èÁöÑ‰ΩìÈ™åÔºåÊèê‰æõÊõ¥ÂÆåÂñÑÁöÑÁ§∫‰æãÂíåÁî®Êà∑ÊÄÅÂºÄÂèëÂ∫ì/Â∑•ÂÖ∑ÈìæÔºå‰ª•ÂèäÊõ¥ÂÖ∑‰ΩìÁöÑÂ∫îÁî®Âú∫ÊôØ„ÄÇ</p>
<h2 id="ÂèÇËÄÉËµÑÊñô-1"><a class="header" href="#ÂèÇËÄÉËµÑÊñô-1">ÂèÇËÄÉËµÑÊñô</a></h2>
<ul>
<li>wasm-bpf Github ÂºÄÊ∫êÂú∞ÂùÄÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></li>
<li>‰ªÄ‰πàÊòØ eBPFÔºö<a href="https://ebpf.io/what-is-ebpf">https://ebpf.io/what-is-ebpf</a></li>
<li>WASI-eBPF: <a href="https://github.com/WebAssembly/WASI/issues/513">https://github.com/WebAssembly/WASI/issues/513</a></li>
<li>ÈæôËú•Á§æÂå∫ eBPF ÊäÄÊúØÊé¢Á¥¢ SIG <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>eunomia-bpf È°πÁõÆÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>eunomia-bpf È°πÁõÆÈæôËú• Gitee ÈïúÂÉèÔºö<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
<li>Wasm-bpf: Êû∂Ëµ∑ Webassembly Âíå eBPF ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢ÅÔºö<a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew</a></li>
<li>ÂΩì WASM ÈÅáËßÅ eBPF Ôºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫èÔºö<a href="https://zhuanlan.zhihu.com/p/573941739">https://zhuanlan.zhihu.com/p/573941739</a></li>
<li>Êïô‰Ω†‰ΩøÁî®eBPF LSMÁÉ≠‰øÆÂ§çLinuxÂÜÖÊ†∏ÊºèÊ¥ûÔºö<a href="https://www.bilibili.com/read/cv19597563">https://www.bilibili.com/read/cv19597563</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="Âú®-webassembly-‰∏≠‰ΩøÁî®-rust-ÁºñÂÜô-ebpf-Á®ãÂ∫èÂπ∂ÂèëÂ∏É-oci-ÈïúÂÉè"><a class="header" href="#Âú®-webassembly-‰∏≠‰ΩøÁî®-rust-ÁºñÂÜô-ebpf-Á®ãÂ∫èÂπ∂ÂèëÂ∏É-oci-ÈïúÂÉè">Âú® WebAssembly ‰∏≠‰ΩøÁî® Rust ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÂèëÂ∏É OCI ÈïúÂÉè</a></h1>
<blockquote>
<p>‰ΩúËÄÖÔºö‰∫éÊ°êÔºåÈÉëÊò±Á¨ô</p>
</blockquote>
<p>eBPFÔºàextended Berkeley Packet FilterÔºâÊòØ‰∏ÄÁßçÈ´òÊÄßËÉΩÁöÑÂÜÖÊ†∏ËôöÊãüÊú∫ÔºåÂèØ‰ª•ËøêË°åÂú®ÂÜÖÊ†∏Á©∫Èó¥‰∏≠Ôºå‰ª•Êî∂ÈõÜÁ≥ªÁªüÂíåÁΩëÁªú‰ø°ÊÅØ„ÄÇÈöèÁùÄËÆ°ÁÆóÊú∫ÊäÄÊúØÁöÑ‰∏çÊñ≠ÂèëÂ±ïÔºåeBPF ÁöÑÂäüËÉΩÊó•ÁõäÂº∫Â§ßÔºåÂπ∂‰∏îÂ∑≤ÁªèÊàê‰∏∫ÂêÑÁßçÊïàÁéáÈ´òÊïàÁöÑÂú®Á∫øËØäÊñ≠ÂíåË∑üË∏™Á≥ªÁªüÔºå‰ª•ÂèäÊûÑÂª∫ÂÆâÂÖ®ÁöÑÁΩëÁªú„ÄÅÊúçÂä°ÁΩëÊ†ºÁöÑÈáçË¶ÅÁªÑÊàêÈÉ®ÂàÜ„ÄÇ</p>
<p>WebAssemblyÔºàWasmÔºâÊúÄÂàùÊòØ‰ª•ÊµèËßàÂô®ÂÆâÂÖ®Ê≤ôÁõí‰∏∫ÁõÆÁöÑÂºÄÂèëÁöÑÔºåÂèëÂ±ïÂà∞ÁõÆÂâç‰∏∫Ê≠¢ÔºåWebAssembly Â∑≤ÁªèÊàê‰∏∫‰∏Ä‰∏™Áî®‰∫é‰∫ëÂéüÁîüËΩØ‰ª∂ÁªÑ‰ª∂ÁöÑÈ´òÊÄßËÉΩ„ÄÅË∑®Âπ≥Âè∞ÂíåÂ§öËØ≠Ë®ÄËΩØ‰ª∂Ê≤ôÁÆ±ÁéØÂ¢ÉÔºåWasm ËΩªÈáèÁ∫ßÂÆπÂô®‰πüÈùûÂ∏∏ÈÄÇÂêà‰Ωú‰∏∫‰∏ã‰∏Ä‰ª£Êó†ÊúçÂä°Âô®Âπ≥Âè∞ËøêË°åÊó∂ÔºåÊàñÂú®ËæπÁºòËÆ°ÁÆóÁ≠âËµÑÊ∫êÂèóÈôêÁöÑÂú∫ÊôØÈ´òÊïàÊâßË°å„ÄÇ</p>
<p>Áé∞Âú®ÔºåÂÄüÂä© Wasm-bpf ÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂ÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî® Wasm Â∞Ü eBPF Á®ãÂ∫èÁºñÂÜô‰∏∫Ë∑®Âπ≥Âè∞ÁöÑÊ®°ÂùóÔºå‰ΩøÁî® C/C++ Âíå Rust ÁºñÂÜôÁ®ãÂ∫è„ÄÇÈÄöËøáÂú® WebAssembly ‰∏≠‰ΩøÁî® eBPF Á®ãÂ∫èÔºåÊàë‰ª¨‰∏ç‰ªÖËÆ© Wasm Â∫îÁî®Ëé∑Âæó eBPF ÁöÑÈ´òÊÄßËÉΩ„ÄÅÂØπÁ≥ªÁªüÊé•Âè£ÁöÑËÆøÈóÆËÉΩÂäõÔºåËøòÂèØ‰ª•ËÆ© eBPF Á®ãÂ∫è‰∫´ÂèóÂà∞ Wasm ÁöÑÊ≤ôÁÆ±„ÄÅÁÅµÊ¥ªÊÄß„ÄÅË∑®Âπ≥Âè∞ÊÄß„ÄÅÂíåÂä®ÊÄÅÂä†ËΩΩÁöÑËÉΩÂäõÔºåÂπ∂‰∏î‰ΩøÁî® Wasm ÁöÑ OCI ÈïúÂÉèÊù•Êñπ‰æø„ÄÅÂø´Êç∑Âú∞ÂàÜÂèëÂíåÁÆ°ÁêÜ eBPF Á®ãÂ∫è„ÄÇ‰æãÂ¶ÇÔºåÂèØ‰ª•Á±ª‰ºº docker ‰∏ÄÊ†∑Ôºå‰ªé‰∫ëÁ´Ø‰∏ÄË°åÂëΩ‰ª§Ëé∑Âèñ Wasm ËΩªÈáèÁ∫ßÂÆπÂô®ÈïúÂÉèÔºåÂπ∂ËøêË°å‰ªªÊÑè eBPF Á®ãÂ∫è„ÄÇÈÄöËøáÁªìÂêàËøô‰∏§ÁßçÊäÄÊúØÔºåÊàë‰ª¨Â∞Ü‰ºöÁªô eBPF Âíå Wasm ÁîüÊÄÅÊù•‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑÂºÄÂèë‰ΩìÈ™åÔºÅ</p>
<h2 id="‰ΩøÁî®-wasm-bpf-Â∑•ÂÖ∑ÈìæÂú®-wasm-‰∏≠ÁºñÂÜôÂä®ÊÄÅÂä†ËΩΩÂàÜÂèëËøêË°å-ebpf-Á®ãÂ∫è-1"><a class="header" href="#‰ΩøÁî®-wasm-bpf-Â∑•ÂÖ∑ÈìæÂú®-wasm-‰∏≠ÁºñÂÜôÂä®ÊÄÅÂä†ËΩΩÂàÜÂèëËøêË°å-ebpf-Á®ãÂ∫è-1">‰ΩøÁî® Wasm-bpf Â∑•ÂÖ∑ÈìæÂú® Wasm ‰∏≠ÁºñÂÜô„ÄÅÂä®ÊÄÅÂä†ËΩΩ„ÄÅÂàÜÂèëËøêË°å eBPF Á®ãÂ∫è</a></h2>
<p>Âú®Ââç‰∏§ÁØáÁü≠Êñá‰∏≠ÔºåÊàë‰ª¨Â∑≤Áªè‰ªãÁªç‰∫Ü Wasm-bpf ÁöÑËÆæËÆ°ÊÄùË∑ØÔºå‰ª•ÂèäÂ¶Ç‰Ωï‰ΩøÁî® C/C++ Âú® Wasm ‰∏≠ÁºñÂÜô eBPF Á®ãÂ∫è:</p>
<ul>
<li>Wasm-bpf: Êû∂Ëµ∑ Webassembly Âíå eBPF ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢Å: <a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew</a></li>
<li>Âú® WebAssembly ‰∏≠‰ΩøÁî® C/C++ Âíå libbpf ÁºñÂÜô eBPF Á®ãÂ∫è: <a href="https://zhuanlan.zhihu.com/p/605542090">https://zhuanlan.zhihu.com/p/605542090</a></li>
</ul>
<p>Âü∫‰∫é WasmÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî®Â§öÁßçËØ≠Ë®ÄÊûÑÂª∫ eBPF Â∫îÁî®ÔºåÂπ∂‰ª•Áªü‰∏Ä„ÄÅËΩªÈáèÁ∫ßÁöÑÊñπÂºèÁÆ°ÁêÜÂíåÂèëÂ∏É„ÄÇ‰ª•Êàë‰ª¨ÊûÑÂª∫ÁöÑÁ§∫‰æãÂ∫îÁî® bootstrap.wasm ‰∏∫‰æãÔºå‰ΩøÁî® C/C++ ÊûÑÂª∫ÁöÑÈïúÂÉèÂ§ßÂ∞èÊúÄÂ∞è‰ªÖ‰∏∫ ~90KÔºåÂæàÂÆπÊòìÈÄöËøáÁΩëÁªúÂàÜÂèëÔºåÂπ∂ÂèØ‰ª•Âú®‰∏çÂà∞ 100ms ÁöÑÊó∂Èó¥ÂÜÖÂú®Âè¶‰∏ÄÂè∞Êú∫Âô®‰∏äÂä®ÊÄÅÈÉ®ÁΩ≤„ÄÅÂä†ËΩΩÂíåËøêË°åÔºåÂπ∂‰∏î‰øùÁïôËΩªÈáèÁ∫ßÂÆπÂô®ÁöÑÈöîÁ¶ªÁâπÊÄß„ÄÇËøêË°åÊó∂‰∏çÈúÄË¶ÅÂÜÖÊ†∏ÁâπÂÆöÁâàÊú¨Â§¥Êñá‰ª∂„ÄÅLLVM„ÄÅclang Á≠â‰æùËµñÔºå‰πü‰∏çÈúÄË¶ÅÂÅö‰ªª‰ΩïÊ∂àËÄóËµÑÊ∫êÁöÑÈáçÈáèÁ∫ßÁöÑÁºñËØëÂ∑•‰Ωú„ÄÇÂØπ‰∫é Rust ËÄåË®ÄÔºåÁºñËØë‰∫ßÁâ©‰ºöÁ®çÂ§ß‰∏ÄÁÇπÔºåÂ§ßÁ∫¶Âú® 2M Â∑¶Âè≥„ÄÇ</p>
<p>Êú¨ÊñáÂ∞Ü‰ª• Rust ËØ≠Ë®Ä‰∏∫‰æãÔºåËÆ®ËÆ∫Ôºö</p>
<ul>
<li>‰ΩøÁî® Rust ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm Ê®°Âùó</li>
<li>‰ΩøÁî® OCI ÈïúÂÉèÂèëÂ∏É„ÄÅÈÉ®ÁΩ≤„ÄÅÁÆ°ÁêÜ eBPF Á®ãÂ∫èÔºåËé∑ÂæóÁ±ª‰ºº Docker ÁöÑ‰ΩìÈ™å</li>
</ul>
<p>Êàë‰ª¨Âú®‰ªìÂ∫ì‰∏≠Êèê‰æõ‰∫ÜÂá†‰∏™Á§∫‰æãÁ®ãÂ∫èÔºåÂàÜÂà´ÂØπÂ∫î‰∫éÂèØËßÇÊµã„ÄÅÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÂ§öÁßçÂú∫ÊôØ„ÄÇ</p>
<h2 id="ÁºñÂÜô-ebpf-Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫-wasm-ÁöÑÂ§ßËá¥ÊµÅÁ®ã"><a class="header" href="#ÁºñÂÜô-ebpf-Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫-wasm-ÁöÑÂ§ßËá¥ÊµÅÁ®ã">ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm ÁöÑÂ§ßËá¥ÊµÅÁ®ã</a></h2>
<p>‰∏ÄËà¨ËØ¥Êù•ÔºåÂú®Èùû Wasm Ê≤ôÁÆ±ÁöÑÁî®Êà∑ÊÄÅÁ©∫Èó¥Ôºå‰ΩøÁî® libbpf-bootstrap ËÑöÊâãÊû∂ÔºåÂèØ‰ª•Âø´ÈÄü„ÄÅËΩªÊùæÂú∞‰ΩøÁî® C/C++ÊûÑÂª∫ BPF Â∫îÁî®Á®ãÂ∫è„ÄÇÁºñËØë„ÄÅÊûÑÂª∫ÂíåËøêË°å eBPF Á®ãÂ∫èÔºàÊó†ËÆ∫ÊòØÈááÁî®‰ªÄ‰πàËØ≠Ë®ÄÔºâÔºåÈÄöÂ∏∏ÂåÖÂê´‰ª•‰∏ãÂá†‰∏™Ê≠•È™§Ôºö</p>
<ul>
<li>ÁºñÂÜôÂÜÖÊ†∏ÊÄÅ eBPF Á®ãÂ∫èÁöÑ‰ª£Á†ÅÔºå‰∏ÄËà¨‰ΩøÁî® C/C++ Êàñ Rust ËØ≠Ë®Ä</li>
<li>‰ΩøÁî® clang ÁºñËØëÂô®ÊàñËÄÖÁõ∏ÂÖ≥Â∑•ÂÖ∑ÈìæÁºñËØë eBPF Á®ãÂ∫èÔºàË¶ÅÂÆûÁé∞Ë∑®ÂÜÖÊ†∏ÁâàÊú¨ÁßªÊ§çÁöÑËØùÔºåÈúÄË¶ÅÂåÖÂê´ BTF ‰ø°ÊÅØÔºâ„ÄÇ</li>
<li>Âú®Áî®Êà∑ÊÄÅÁöÑÂºÄÂèëÁ®ãÂ∫è‰∏≠ÔºåÁºñÂÜôÂØπÂ∫îÁöÑÂä†ËΩΩ„ÄÅÊéßÂà∂„ÄÅÊåÇËΩΩ„ÄÅÊï∞ÊçÆÂ§ÑÁêÜÈÄªËæëÔºõ</li>
<li>Âú®ÂÆûÈôÖËøêË°åÁöÑÈò∂ÊÆµÔºå‰ªéÁî®Êà∑ÊÄÅÂ∞Ü eBPF Á®ãÂ∫èÂä†ËΩΩËøõÂÖ•ÂÜÖÊ†∏ÔºåÂπ∂ÂÆûÈôÖÊâßË°å„ÄÇ</li>
</ul>
<h2 id="‰ΩøÁî®-rust-ÁºñÂÜô-ebpf-Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫-wasm"><a class="header" href="#‰ΩøÁî®-rust-ÁºñÂÜô-ebpf-Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫-wasm">‰ΩøÁî® Rust ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm</a></h2>
<p>Rust ÂèØËÉΩÊòØ WebAssembly ÁîüÊÄÅÁ≥ªÁªü‰∏≠ÊîØÊåÅÊúÄÂ•ΩÁöÑËØ≠Ë®Ä„ÄÇRust ‰∏ç‰ªÖÊîØÊåÅÂá†‰∏™ WebAssembly ÁºñËØëÁõÆÊ†áÔºåËÄå‰∏î wasmtime„ÄÅSpin„ÄÅWagi ÂíåÂÖ∂‰ªñËÆ∏Â§ö WebAssembly Â∑•ÂÖ∑ÈÉΩÊòØÁî® Rust ÁºñÂÜôÁöÑ„ÄÇÂõ†Ê≠§ÔºåÊàë‰ª¨‰πüÊèê‰æõ‰∫Ü Rust ÁöÑÂºÄÂèëÁ§∫‰æãÔºö</p>
<ul>
<li>Wasm Âíå WASI ÁöÑ Rust ÁîüÊÄÅÁ≥ªÁªüÈùûÂ∏∏Ê£í</li>
<li>ËÆ∏Â§ö Wasm Â∑•ÂÖ∑ÈÉΩÊòØÁî® Rust ÁºñÂÜôÁöÑÔºåËøôÊÑèÂë≥ÁùÄÊúâÂ§ßÈáèÁöÑ‰ª£Á†ÅÂèØ‰ª•Â§çÁî®„ÄÇ</li>
<li>Spin ÈÄöÂ∏∏Âú®ÂØπÂÖ∂‰ªñËØ≠Ë®ÄÁöÑÊîØÊåÅ‰πãÂâçÂ∞±ÊúâRustÁöÑÂäüËÉΩÊîØÊåÅ</li>
<li>Wasmtime ÊòØÁî® RustÁºñÂÜôÁöÑÔºåÈÄöÂ∏∏Âú®ÂÖ∂‰ªñËøêË°åÊó∂‰πãÂâçÂ∞±ÊúâÊúÄÂÖàËøõÁöÑÂäüËÉΩ„ÄÇ</li>
<li>ÂèØ‰ª•Âú® WebAssembly ‰∏≠‰ΩøÁî®ËÆ∏Â§öÁé∞ÊàêÁöÑ Rust Â∫ì„ÄÇ</li>
<li>Áî±‰∫é Cargo ÁöÑÁÅµÊ¥ªÊûÑÂª∫Á≥ªÁªüÔºå‰∏Ä‰∫õ Crates ÁîöËá≥ÊúâÁâπÊÆäÁöÑÂäüËÉΩÊ†áÂøóÊù•ÂêØÁî®WasmÁöÑÂäüËÉΩÔºà‰æãÂ¶ÇChronoÔºâ„ÄÇ</li>
<li>Áî±‰∫é Rust ÁöÑÂÜÖÂ≠òÁÆ°ÁêÜÊäÄÊúØÔºå‰∏éÂêåÁ±ªËØ≠Ë®ÄÁõ∏ÊØîÔºåRust ÁöÑ‰∫åËøõÂà∂Â§ßÂ∞èÂæàÂ∞è„ÄÇ</li>
</ul>
<p>Êàë‰ª¨ÂêåÊ†∑Êèê‰æõ‰∫Ü‰∏Ä‰∏™ Rust ÁöÑ eBPF SDKÔºåÂèØ‰ª•‰ΩøÁî® Rust ÁºñÂÜô eBPF ÁöÑÁî®Êà∑ÊÄÅÁ®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm„ÄÇÂÄüÂä© aya-rs Êèê‰æõÁöÑÁõ∏ÂÖ≥Â∑•ÂÖ∑ÈìæÊîØÊåÅÔºåÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫è‰πüÂèØ‰ª•Áî® Rust ËøõË°åÁºñÂÜôÔºå‰∏çËøáÂú®ËøôÈáåÔºåÊàë‰ª¨ËøòÊòØÂ§çÁî®‰πãÂâç‰ΩøÁî® C ËØ≠Ë®ÄÁºñÂÜôÁöÑÂÜÖÊ†∏ÊÄÅÁ®ãÂ∫è„ÄÇ</p>
<p>È¶ñÂÖàÔºåÊàë‰ª¨ÈúÄË¶Å‰ΩøÁî® rust Êèê‰æõÁöÑ wasi Â∑•ÂÖ∑ÈìæÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÈ°πÁõÆÔºö</p>
<pre><code class="language-sh">rustup target add wasm32-wasi
cargo new rust-helloworld
</code></pre>
<p>‰πãÂêéÔºåÂèØ‰ª•‰ΩøÁî® <code>Makefile</code> ËøêË°å make ÂÆåÊàêÊï¥‰∏™ÁºñËØëÊµÅÁ®ãÔºåÂπ∂ÁîüÊàê <code>bootstrap.bpf.o</code> eBPF Â≠óËäÇÁ†ÅÊñá‰ª∂„ÄÇ</p>
<h3 id="‰ΩøÁî®-wit-bindgen-ÁîüÊàêÁ±ªÂûã‰ø°ÊÅØÁî®‰∫éÂÜÖÊ†∏ÊÄÅÂíå-wasm-Ê®°Âùó‰πãÈó¥ÈÄö‰ø°"><a class="header" href="#‰ΩøÁî®-wit-bindgen-ÁîüÊàêÁ±ªÂûã‰ø°ÊÅØÁî®‰∫éÂÜÖÊ†∏ÊÄÅÂíå-wasm-Ê®°Âùó‰πãÈó¥ÈÄö‰ø°">‰ΩøÁî® wit-bindgen ÁîüÊàêÁ±ªÂûã‰ø°ÊÅØÔºåÁî®‰∫éÂÜÖÊ†∏ÊÄÅÂíå Wasm Ê®°Âùó‰πãÈó¥ÈÄö‰ø°</a></h3>
<p>wit-bindgen È°πÁõÆÊòØ‰∏ÄÂ•óÁùÄÁúº‰∫é WebAssemblyÔºåÂπ∂‰ΩøÁî®ÁªÑ‰ª∂Ê®°ÂûãÁöÑËØ≠Ë®ÄÁöÑÁªëÂÆöÁîüÊàêÂô®„ÄÇÁªëÂÆöÊòØÁî® *.wit Êñá‰ª∂ÊèèËø∞ÁöÑÔºåÊñá‰ª∂‰∏≠ÊèèËø∞‰∫Ü Wasm Ê®°ÂùóÂØºÂÖ•„ÄÅÂØºÂá∫ÁöÑÂáΩÊï∞ÂíåÊé•Âè£„ÄÇÊàë‰ª¨ÂèØ‰ª• wit-bindgen ÂÆÉÊù•ÁîüÊàêÂ§öÁßçËØ≠Ë®ÄÁöÑÁ±ªÂûãÂÆö‰πâÔºå‰ª•‰æøÂú®ÂÜÖÊ†∏ÊÄÅÁöÑ eBPF ÂíåÁî®Êà∑ÊÄÅÁöÑ Wasm Ê®°Âùó‰πãÈó¥‰º†ÈÄíÊï∞ÊçÆ„ÄÇ</p>
<p>Êàë‰ª¨È¶ñÂÖàÈúÄË¶ÅÂú® <code>Cargo.toml</code> ÈÖçÁΩÆÊñá‰ª∂‰∏≠Âä†ÂÖ• <code>wasm-bpf-binding</code> Âíå <code>wit-bindgen-guest-rust</code> ‰æùËµñÔºö</p>
<pre><code class="language-toml">wasm-bpf-binding = { path = &quot;wasm-bpf-binding&quot; }
</code></pre>
<p>Ëøô‰∏™ÂåÖÊèê‰æõ‰∫Ü wasm-bpf Áî±ËøêË°åÊó∂Êèê‰æõÁªô Wasm Ê®°ÂùóÔºåÁî®‰∫éÂä†ËΩΩÂíåÊéßÂà∂ eBPF Á®ãÂ∫èÁöÑÂáΩÊï∞ÁöÑÁªëÂÆö„ÄÇ</p>
<ul>
<li><code>wasm-bpf-binding</code> Âú® wasm-bpf ‰ªìÂ∫ì‰∏≠ÊúâÊèê‰æõ„ÄÇ</li>
</ul>
<pre><code class="language-toml">[dependencies]
wit-bindgen-guest-rust = { git = &quot;https://github.com/bytecodealliance/wit-bindgen&quot;, version = &quot;0.3.0&quot; }

[patch.crates-io]
wit-component = {git = &quot;https://github.com/bytecodealliance/wasm-tools&quot;, version = &quot;0.5.0&quot;, rev = &quot;9640d187a73a516c42b532cf2a10ba5403df5946&quot;}
wit-parser = {git = &quot;https://github.com/bytecodealliance/wasm-tools&quot;, version = &quot;0.5.0&quot;, rev = &quot;9640d187a73a516c42b532cf2a10ba5403df5946&quot;}
</code></pre>
<p>Ëøô‰∏™ÂåÖÊîØÊåÅÁî® wit Êñá‰ª∂‰∏∫ rust ÂÆ¢Êà∑Á®ãÂ∫èÁîüÊàêÁªëÂÆö„ÄÇ‰ΩøÁî®Ëøô‰∏™ÂåÖÁöÑÊÉÖÂÜµ‰∏ãÔºåÊàë‰ª¨‰∏çÈúÄË¶ÅÂÜçÊâãÂä®ËøêË°å wit-bindgen„ÄÇ</p>
<p>Êé•‰∏ãÊù•ÔºåÊàë‰ª¨‰ΩøÁî® <code>btf2wit</code> Â∑•ÂÖ∑Ôºå‰ªé BTF ‰ø°ÊÅØÁîüÊàê wit Êñá‰ª∂„ÄÇÂèØ‰ª•‰ΩøÁî® <code>cargo install btf2wit</code> ÂÆâË£ÖÊàë‰ª¨Êèê‰æõÁöÑ btf2wit Â∑•ÂÖ∑ÔºåÂπ∂ÁºñËØëÁîüÊàê wit ‰ø°ÊÅØÔºö</p>
<pre><code class="language-console">cd btf
clang -target bpf -g event-def.c -c -o event.def.o
btf2wit event.def.o -o event-def.wit
cp *.wit ../wit/
</code></pre>
<ul>
<li>ÂÖ∂‰∏≠ <code>event-def.c</code> ÊòØÂåÖÂê´‰∫ÜÊàë‰ª¨ÈúÄË¶ÅÁöÑÁªìÊûÑ‰Ωì‰ø°ÊÅØÁöÑÁöÑ C Á®ãÂ∫èÊñá‰ª∂„ÄÇÂè™ÊúâÂú®ÂØºÂá∫Á¨¶Âè∑‰∏≠Áî®Âà∞ÁöÑÁªìÊûÑ‰ΩìÊâç‰ºöË¢´ËÆ∞ÂΩïÂú® BTF ‰∏≠„ÄÇ</li>
</ul>
<p>ÂØπ‰∫é C ÁªìÊûÑ‰ΩìÁîüÊàêÁöÑ wit ‰ø°ÊÅØÔºåÂ§ßËá¥Â¶Ç‰∏ãÔºö</p>
<pre><code class="language-wit">default world host {
    record event {
         pid: s32,
        ppid: s32,
        exit-code: u32,
        --pad0: list&lt;s8&gt;,
        duration-ns: u64,
        comm: list&lt;s8&gt;,
        filename: list&lt;s8&gt;,
        exit-event: s8,
    }
}
</code></pre>
<p><code>wit-bindgen-guest-rust</code> ‰ºö‰∏∫ wit Êñá‰ª∂Â§π‰∏≠ÁöÑÊâÄÊúâÁ±ªÂûã‰ø°ÊÅØÔºåËá™Âä®ÁîüÊàê rust ÁöÑÁ±ªÂûãÔºå‰æãÂ¶ÇÔºö</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[repr(C, packed)]
#[derive(Debug, Copy, Clone)]
struct Event {
    pid: i32,
    ppid: i32,
    exit_code: u32,
    __pad0: [u8; 4],
    duration_ns: u64,
    comm: [u8; 16],
    filename: [u8; 127],
    exit_event: u8,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="ÁºñÂÜôÁî®Êà∑ÊÄÅÂä†ËΩΩÂíåÂ§ÑÁêÜ‰ª£Á†Å"><a class="header" href="#ÁºñÂÜôÁî®Êà∑ÊÄÅÂä†ËΩΩÂíåÂ§ÑÁêÜ‰ª£Á†Å">ÁºñÂÜôÁî®Êà∑ÊÄÅÂä†ËΩΩÂíåÂ§ÑÁêÜ‰ª£Á†Å</a></h3>
<p>‰∏∫‰∫ÜÂú® WASI ‰∏äËøêË°åÔºåÈúÄË¶Å‰∏∫ main.rs Ê∑ªÂä† <code>#![no_main]</code> Â±ûÊÄßÔºåÂπ∂‰∏î main ÂáΩÊï∞ÈúÄË¶ÅÈááÁî®Á±ª‰ººÂ¶Ç‰∏ãÁöÑÂΩ¢ÊÄÅÔºö</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[export_name = &quot;__main_argc_argv&quot;]
fn exam_main(_env_json: u32, _str_len: i32) -&gt; i32 {

    return 0;
}
<span class="boring">}</span></code></pre></pre>
<p>Áî®Êà∑ÊÄÅÂä†ËΩΩÂíåÊåÇËΩΩ‰ª£Á†ÅÔºåÂíå C/C++ ‰∏≠Á±ª‰ººÔºö</p>
<pre><code class="language-rust ignore">    let obj_ptr =
        binding::wasm_load_bpf_object(bpf_object.as_ptr() as u32, bpf_object.len() as i32);
    if obj_ptr == 0 {
        println!(&quot;Failed to load bpf object&quot;);
        return 1;
    }
    let attach_result = binding::wasm_attach_bpf_program(
        obj_ptr,
        &quot;handle_exec\0&quot;.as_ptr() as u32,
        &quot;\0&quot;.as_ptr() as u32,
    );
    ..</code></pre>
<p>polling ring bufferÔºö</p>
<pre><code class="language-rust ignore">    let map_fd = binding::wasm_bpf_map_fd_by_name(obj_ptr, &quot;rb\0&quot;.as_ptr() as u32);
    if map_fd &lt; 0 {
        println!(&quot;Failed to get map fd: {}&quot;, map_fd);
        return 1;
    }
    // binding::wasm
    let buffer = [0u8; 256];
    loop {
        // polling the buffer
        binding::wasm_bpf_buffer_poll(
            obj_ptr,
            map_fd,
            handle_event as i32,
            0,
            buffer.as_ptr() as u32,
            buffer.len() as i32,
            100,
        );
    }</code></pre>
<p>‰ΩøÁî® handler Êé•Êî∂ËøîÂõûÂÄºÔºö</p>
<pre><code class="language-rust ignore">
extern &quot;C&quot; fn handle_event(_ctx: u32, data: u32, _data_sz: u32) {
    let event_slice = unsafe { slice::from_raw_parts(data as *const Event, 1) };
    let event = &amp;event_slice[0];
    let pid = event.pid;
    let ppid = event.ppid;
    let exit_code = event.exit_code;
    if event.exit_event == 1 {
        print!(
            &quot;{:&lt;8} {:&lt;5} {:&lt;16} {:&lt;7} {:&lt;7} [{}]&quot;,
            &quot;TIME&quot;,
            &quot;EXIT&quot;,
            unsafe { CStr::from_ptr(event.comm.as_ptr() as *const i8) }
                .to_str()
                .unwrap(),
            pid,
            ppid,
            exit_code
        );
        ..
}</code></pre>
<p>Êé•‰∏ãÊù•Âç≥ÂèØ‰ΩøÁî® cargo ÁºñËØëËøêË°åÔºö</p>
<pre><code class="language-console">$ cargo build --target wasi32-wasm
$ sudo wasm-bpf ./target/wasm32-wasi/debug/rust-helloworld.wasm
TIME     EXEC  sh               180245  33666   /bin/sh
TIME     EXEC  which            180246  180245  /usr/bin/which
TIME     EXIT  which            180246  180245  [0] (1ms)
TIME     EXIT  sh               180245  33666   [0] (3ms)
TIME     EXEC  sh               180247  33666   /bin/sh
TIME     EXEC  ps               180248  180247  /usr/bin/ps
TIME     EXIT  ps               180248  180247  [0] (23ms)
TIME     EXIT  sh               180247  33666   [0] (25ms)
TIME     EXEC  sh               180249  33666   /bin/sh
TIME     EXEC  cpuUsage.sh      180250  180249  /root/.vscode-server-insiders/bin/a7d49b0f35f50e460835a55d20a00a735d1665a3/out/vs/base/node/cpuUsage.sh
</code></pre>
<h2 id="‰ΩøÁî®-oci-ÈïúÂÉèÂèëÂ∏ÉÂíåÁÆ°ÁêÜ-ebpf-Á®ãÂ∫è"><a class="header" href="#‰ΩøÁî®-oci-ÈïúÂÉèÂèëÂ∏ÉÂíåÁÆ°ÁêÜ-ebpf-Á®ãÂ∫è">‰ΩøÁî® OCI ÈïúÂÉèÂèëÂ∏ÉÂíåÁÆ°ÁêÜ eBPF Á®ãÂ∫è</a></h2>
<p>ÂºÄÊîæÂÆπÂô®ÂçèËÆÆ (OCI) ÊòØ‰∏Ä‰∏™ËΩªÈáèÁ∫ßÔºåÂºÄÊîæÁöÑÊ≤ªÁêÜÁªìÊûÑÔºå‰∏∫ÂÆπÂô®ÊäÄÊúØÂÆö‰πâ‰∫ÜËßÑËåÉÂíåÊ†áÂáÜ„ÄÇÂú® Linux Âü∫Èáë‰ºöÁöÑÊîØÊåÅ‰∏ãÊàêÁ´ãÔºåÁî±ÂêÑÂ§ßËΩØ‰ª∂‰ºÅ‰∏öÊûÑÊàêÔºåËá¥Âäõ‰∫éÂõ¥ÁªïÂÆπÂô®Ê†ºÂºèÂíåËøêË°åÊó∂ÂàõÂª∫ÂºÄÊîæÁöÑË°å‰∏öÊ†áÂáÜ„ÄÇÂÖ∂‰∏≠ÂåÖÊã¨‰∫Ü‰ΩøÁî® Container Registries ËøõË°åÂ∑•‰ΩúÁöÑ APIÔºåÊ≠£ÂºèÂêçÁß∞‰∏∫ OCI ÂàÜÂèëËßÑËåÉ (ÂèàÂêç‚Äúdistribution-spec‚Äù)„ÄÇ</p>
<p>Docker ‰πüÂÆ£Â∏ÉÊé®Âá∫‰∏é WebAssembly ÈõÜÊàê (Docker+Wasm) ÁöÑÈ¶ñ‰∏™ÊäÄÊúØÈ¢ÑËßàÁâàÔºåÂπ∂Ë°®Á§∫ÂÖ¨Âè∏Â∑≤Âä†ÂÖ•Â≠óËäÇÁ†ÅËÅîÁõü (Bytecode Alliance)ÔºåÊàê‰∏∫ÊäïÁ•®ÊàêÂëò„ÄÇDocker+Wasm ËÆ©ÂºÄÂèëËÄÖËÉΩÂ§üÊõ¥ÂÆπÊòìÂú∞Âø´ÈÄüÊûÑÂª∫Èù¢Âêë Wasm ËøêË°åÊó∂ÁöÑÂ∫îÁî®Á®ãÂ∫è„ÄÇ</p>
<p>ÂÄüÂä©‰∫é Wasm ÁöÑÁõ∏ÂÖ≥ÁîüÊÄÅÔºåÂèØ‰ª•ÈùûÂ∏∏Êñπ‰æøÂú∞ÂèëÂ∏É„ÄÅ‰∏ãËΩΩÂíåÁÆ°ÁêÜ eBPF Á®ãÂ∫èÔºå‰æãÂ¶ÇÔºå‰ΩøÁî® <code>wasm-to-oci</code> Â∑•ÂÖ∑ÔºåÂèØ‰ª•Â∞Ü Wasm Á®ãÂ∫èÊâìÂåÖ‰∏∫ OCI ÈïúÂÉèÔºåËé∑ÂèñÁ±ª‰ºº docker ÁöÑ‰ΩìÈ™åÔºö</p>
<pre><code class="language-console">wasm-to-oci push testdata/hello.wasm &lt;oci-registry&gt;.azurecr.io/wasm-to-oci:v1
wasm-to-oci pull &lt;oci-registry&gt;.azurecr.io/wasm-to-oci:v1 --out test.wasm
</code></pre>
<p>Êàë‰ª¨‰πüÂ∞ÜÂÖ∂ÈõÜÊàêÂà∞‰∫Ü eunomia-bpf ÁöÑ ecli Â∑•ÂÖ∑‰∏≠ÔºåÂèØ‰ª•‰∏ÄË°åÂëΩ‰ª§‰ªé‰∫ëÁ´ØÁöÑ Github Packages ‰∏≠‰∏ãËΩΩÂπ∂ËøêË°å eBPF Á®ãÂ∫èÔºåÊàñÈÄöËøá Github Packages ÂèëÂ∏ÉÔºö</p>
<pre><code class="language-bash"># push to Github Packages
ecli push https://ghcr.io/eunomia-bpf/sigsnoop:latest
# pull from Github Packages
ecli pull https://ghcr.io/eunomia-bpf/sigsnoop:latest
# run eBPF program
ecli run https://ghcr.io/eunomia-bpf/sigsnoop:latest
</code></pre>
<p>Êàë‰ª¨Â∑≤ÁªèÂú® LMP È°πÁõÆÁöÑ eBPF Hub ‰∏≠ÔºåÊúâ‰∏Ä‰∫õÂàõÂª∫Á¨¶Âêà OCI Ê†áÂáÜÁöÑ Wasm-eBPF Â∫îÁî®Á®ãÂ∫èÔºåÂπ∂Âà©Áî® ORAS ÁÆÄÂåñÊâ©Â±ï eBPF Â∫îÁî®ÂºÄÂèëÔºåÂàÜÂèë„ÄÅÂä†ËΩΩ„ÄÅËøêË°åËÉΩÂäõÁöÑÂ∞ùËØï[11]Ôºå‰ª•ÂèäÂü∫‰∫é Wasm ÂêåÊó∂‰ΩøÁî®Â§öÁßç‰∏çÂêåËØ≠Ë®ÄÂºÄÂèë eBPF ÁöÑÁî®Êà∑ÊÄÅÊï∞ÊçÆÂ§ÑÁêÜÊèí‰ª∂ÁöÑÂÆûË∑µ„ÄÇÂü∫‰∫éÊúÄÊñ∞ÁöÑ Wasm-bpf Ê°ÜÊû∂ÔºåÊúâÊõ¥Â§öÁöÑÊé¢Á¥¢ÊÄßÂ∑•‰ΩúÂèØ‰ª•ÁªßÁª≠Â±ïÂºÄÔºåÊàë‰ª¨Â∏åÊúõÂ∞ùËØïÊûÑÂª∫‰∏Ä‰∏™ÂÆåÊï¥ÁöÑÈíàÂØπ eBPF Âíå Wasm Á®ãÂ∫èÁöÑÂåÖÁÆ°ÁêÜÁ≥ªÁªüÔºå‰ª•ÂèäÊõ¥Â§öÁöÑÂèØ‰ª•Êé¢Á¥¢ÁöÑÂ∫îÁî®Âú∫ÊôØ„ÄÇ</p>
<h2 id="ÊÄªÁªì-1"><a class="header" href="#ÊÄªÁªì-1">ÊÄªÁªì</a></h2>
<p>Êú¨Êñá‰ª• Rust ËØ≠Ë®Ä‰∏∫‰æãÔºåËÆ®ËÆ∫‰∫Ü‰ΩøÁî® Rust ÁºñÂÜô eBPF Á®ãÂ∫èÂπ∂ÁºñËØë‰∏∫ Wasm Ê®°Âùó‰ª•Âèä‰ΩøÁî® OCI ÈïúÂÉèÂèëÂ∏É„ÄÅÈÉ®ÁΩ≤„ÄÅÁÆ°ÁêÜ eBPF Á®ãÂ∫èÔºåËé∑ÂæóÁ±ª‰ºº Docker ÁöÑ‰ΩìÈ™å„ÄÇÊõ¥ÂÆåÊï¥ÁöÑ‰ª£Á†ÅÔºåËØ∑ÂèÇËÄÉÊàë‰ª¨ÁöÑ Github ‰ªìÂ∫ìÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a>.</p>
<p>Êé•‰∏ãÊù•ÔºåÊàë‰ª¨‰ºöÁªßÁª≠ÂÆåÂñÑÂú® Wasm ‰∏≠‰ΩøÁî®Â§öÁßçËØ≠Ë®ÄÂºÄÂèëÂíåËøêË°å eBPF Á®ãÂ∫èÁöÑ‰ΩìÈ™åÔºåÊèê‰æõÊõ¥ÂÆåÂñÑÁöÑÁ§∫‰æãÂíåÁî®Êà∑ÊÄÅÂºÄÂèëÂ∫ì/Â∑•ÂÖ∑ÈìæÔºå‰ª•ÂèäÊõ¥ÂÖ∑‰ΩìÁöÑÂ∫îÁî®Âú∫ÊôØ„ÄÇ</p>
<h2 id="ÂèÇËÄÉËµÑÊñô-2"><a class="header" href="#ÂèÇËÄÉËµÑÊñô-2">ÂèÇËÄÉËµÑÊñô</a></h2>
<ul>
<li>wasm-bpf Github ÂºÄÊ∫êÂú∞ÂùÄÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></li>
<li>‰ªÄ‰πàÊòØ eBPFÔºö<a href="https://ebpf.io/what-is-ebpf">https://ebpf.io/what-is-ebpf</a></li>
<li>WASI-eBPF: <a href="https://github.com/WebAssembly/WASI/issues/513">https://github.com/WebAssembly/WASI/issues/513</a></li>
<li>ÈæôËú•Á§æÂå∫ eBPF ÊäÄÊúØÊé¢Á¥¢ SIG <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>eunomia-bpf È°πÁõÆÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>eunomia-bpf È°πÁõÆÈæôËú• Gitee ÈïúÂÉèÔºö<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
<li>Wasm-bpf: Êû∂Ëµ∑ Webassembly Âíå eBPF ÂÜÖÊ†∏ÂèØÁºñÁ®ãÁöÑÊ°•Ê¢ÅÔºö<a href="https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew">https://mp.weixin.qq.com/s/2InV7z1wcWic5ifmAXSiew</a></li>
<li>ÂΩì Wasm ÈÅáËßÅ eBPF Ôºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫èÔºö<a href="https://zhuanlan.zhihu.com/p/573941739">https://zhuanlan.zhihu.com/p/573941739</a></li>
<li>Docker+WasmÊäÄÊúØÈ¢ÑËßàÔºö<a href="https://zhuanlan.zhihu.com/p/583614628">https://zhuanlan.zhihu.com/p/583614628</a></li>
<li>LMP eBPF-Hub: <a href="https://github.com/linuxkerneltravel/lmp">https://github.com/linuxkerneltravel/lmp</a></li>
<li>wasm-to-oci: <a href="https://github.com/engineerd/wasm-to-oci">https://github.com/engineerd/wasm-to-oci</a></li>
<li>btf2wit: <a href="https://github.com/eunomia-bpf/btf2wit">https://github.com/eunomia-bpf/btf2wit</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="‰ΩøÁî®-chatgpt-ÈÄöËøáËá™ÁÑ∂ËØ≠Ë®ÄÁºñÂÜô-ebpf-Á®ãÂ∫èÂíåËøΩË∏™-linux-Á≥ªÁªü"><a class="header" href="#‰ΩøÁî®-chatgpt-ÈÄöËøáËá™ÁÑ∂ËØ≠Ë®ÄÁºñÂÜô-ebpf-Á®ãÂ∫èÂíåËøΩË∏™-linux-Á≥ªÁªü">‰ΩøÁî® ChatGPT ÔºåÈÄöËøáËá™ÁÑ∂ËØ≠Ë®ÄÁºñÂÜô eBPF Á®ãÂ∫èÂíåËøΩË∏™ Linux Á≥ªÁªü</a></h1>
<p>eBPF ÊòØ‰∏ÄÈ°πÈù©ÂëΩÊÄßÁöÑÊäÄÊúØÔºåËµ∑Ê∫ê‰∫é Linux ÂÜÖÊ†∏ÔºåÂèØ‰ª•Âú®Êìç‰ΩúÁ≥ªÁªüÁöÑÂÜÖÊ†∏‰∏≠ËøêË°åÊ≤ôÁõíÁ®ãÂ∫è„ÄÇÂÆÉË¢´Áî®Êù•ÂÆâÂÖ®ÂíåÊúâÊïàÂú∞Êâ©Â±ïÂÜÖÊ†∏ÁöÑÂäüËÉΩÔºåËÄå‰∏çÈúÄË¶ÅÊîπÂèòÂÜÖÊ†∏ÁöÑÊ∫ê‰ª£Á†ÅÊàñÂä†ËΩΩÂÜÖÊ†∏Ê®°Âùó„ÄÇ‰ªäÂ§©ÔºåeBPFË¢´ÂπøÊ≥õÁî®‰∫éÂêÑÁ±ªÂú∫ÊôØÔºöÂú®Áé∞‰ª£Êï∞ÊçÆ‰∏≠ÂøÉÂíå‰∫ëÂéüÁîüÁéØÂ¢É‰∏≠ÔºåÂèØ‰ª•Êèê‰æõÈ´òÊÄßËÉΩÁöÑÁΩëÁªúÂåÖÂ§ÑÁêÜÂíåË¥üËΩΩÂùáË°°Ôºõ‰ª•ÈùûÂ∏∏‰ΩéÁöÑËµÑÊ∫êÂºÄÈîÄÔºåÂÅöÂà∞ÂØπÂ§öÁßçÁªÜÁ≤íÂ∫¶ÊåáÊ†áÁöÑÂèØËßÇÊµãÊÄßÔºåÂ∏ÆÂä©Â∫îÁî®Á®ãÂ∫èÂºÄÂèë‰∫∫ÂëòË∑üË∏™Â∫îÁî®Á®ãÂ∫èÔºå‰∏∫ÊÄßËÉΩÊïÖÈöúÊéíÈô§Êèê‰æõÊ¥ûÂØüÂäõÔºõ‰øùÈöúÂ∫îÁî®Á®ãÂ∫èÂíåÂÆπÂô®ËøêË°åÊó∂ÁöÑÂÆâÂÖ®ÊâßË°åÔºåÁ≠âÁ≠â„ÄÇeBPF Â∑≤ÁªèÊàê‰∏∫‰∫Ü‰∏Ä‰∏™Ë∂äÊù•Ë∂äÂèóÊ¨¢ËøéÁöÑÊäÄÊúØÔºåÂÆÉÂèØ‰ª•Â∏ÆÂä©Êàë‰ª¨Êõ¥Âä†È´òÊïàÂú∞ÂØπÂÜÖÊ†∏ÂíåÁî®Êà∑ÊÄÅÁöÑÂá†‰πéÊâÄÊúâÂ∫îÁî®ËøõË°åËøΩË∏™ÂíåÂàÜÊûê„ÄÇ</p>
<p>‰ΩÜÊòØÔºåeBPF ÁöÑÂºÄÂèëÔºåÊàñËÄÖËøΩË∏™ÂÜÖÊ†∏‰∫ßÁîüÁöÑÂêÑÁ±ª‰∫ã‰ª∂ÔºåÈúÄË¶Å‰∏ÄÂÆöÁöÑ‰∏ì‰∏öÁü•ËØÜÔºåÂØπ‰∫é‰∏Ä‰∫õ‰∏çÁÜüÊÇâËØ•ÊäÄÊúØÁöÑÂºÄÂèë‰∫∫ÂëòÊù•ËØ¥ÔºåÂèØËÉΩ‰ºöÊúâ‰∏ÄÂÆöÁöÑÂõ∞Èöæ„ÄÇËøôÊó∂ÔºåÊàë‰ª¨ÁöÑ demo Â∑•ÂÖ∑ GPTtrace ÊâÄÂ∏¶Êù•ÁöÑ‰∏Ä‰∫õÊñ∞ÁöÑÊÄùË∑ØÔºå‰πüËÆ∏Â∞±ÂèØ‰ª•Â∏ÆÂä©‰Ω†Ëß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢ò„ÄÇÂÆÉ‰ΩøÁî® ChatGPT ÔºåÈÄöËøáËá™ÁÑ∂ËØ≠Ë®ÄÁºñÂÜô eBPF Á®ãÂ∫èÂíåËøΩË∏™ Linux ÂÜÖÊ†∏Ôºö<a href="https://github.com/eunomia-bpf/GPTtrace">https://github.com/eunomia-bpf/GPTtrace</a></p>
<p>Â¶ÇÊûú‰Ω†ÊòØ‰∏ÄÂêçÂºÄÂèë‰∫∫ÂëòÔºåÊÉ≥Ë¶ÅÊõ¥Âä†È´òÊïàÂú∞ËøõË°åËøΩË∏™ÂíåÂàÜÊûêÔºåÈÇ£‰πàÁ±ª‰ººÁöÑÊñπÊ°àÁªùÂØπÂÄºÂæóÂ∞ùËØïÔºöËøôÁßç ChatGPT Âíå eBPF ÊäÄÊúØÁöÑÁªìÂêàÂ∞ÜÂú®Êú™Êù•ÁöÑËΩØ‰ª∂ÂºÄÂèë„ÄÅË∞ÉËØï„ÄÅ‰ª•ÂèäÂèØËßÇÊµãÊÄßÂú∫ÊôØ‰∏≠ÂèëÊå•Êõ¥Âä†ÈáçË¶ÅÁöÑ‰ΩúÁî®ÔºåÂêåÊó∂ÂÆÉÂèØËÉΩ‰πü‰ºöÂ∏¶Êù•‰∏ÄÁßçÂÖ®Êñ∞ÁöÑ„ÄÅ‰∫§‰∫íÂºèÂú∞Â≠¶‰π†ËåÉÂºè„ÄÇ</p>
<h2 id="Êàë‰ª¨ÂÅö‰∫ÜÂì™‰∫õÂ∞ùËØï"><a class="header" href="#Êàë‰ª¨ÂÅö‰∫ÜÂì™‰∫õÂ∞ùËØï">Êàë‰ª¨ÂÅö‰∫ÜÂì™‰∫õÂ∞ùËØïÔºü</a></h2>
<p>GPTtrace ‰ΩøÁî® ChatGPT ÊäÄÊúØÔºåÂÖÅËÆ∏ÂºÄÂèë‰∫∫ÂëòÈÄöËøáËá™ÁÑ∂ËØ≠Ë®ÄÁºñÂÜô eBPF Á®ãÂ∫èÂíåËøΩË∏™ Linux ÂÜÖÊ†∏ÔºåÊó†ÈúÄ‰∫ãÂÖà‰∫ÜËß£ËØ•ÊäÄÊúØÁöÑ‰∏ì‰∏öÁü•ËØÜ„ÄÇÂÆÉ‰ΩøÂæóÂºÄÂèë‰∫∫ÂëòÂèØ‰ª•Êõ¥Âø´„ÄÅÊõ¥ÂáÜÁ°ÆÂú∞ÂÆö‰ΩçÂíåËß£ÂÜ≥ËΩØ‰ª∂‰∏≠ÁöÑÈóÆÈ¢ò„ÄÇ‰æãÂ¶ÇÔºåÊ†πÊçÆËøõÁ®ãÂêçÁß∞ÁªüËÆ° Page Faults Ê¨°Êï∞Ôºö</p>
<p><img src="blog/result.gif" alt="result" /></p>
<p>Êàë‰ª¨ËøòÊúâ‰∏Ä‰∏™ËßÜÈ¢ëÊºîÁ§∫‰∏éËÆ≤Ëß£ÔºåÂèØ‰ª•Âú®ËøôÈáåËßÇÁúãÔºö<a href="https://www.bilibili.com/video/BV1oM411J7gp/"><a href="https://www.bilibili.com/video/BV1oM411J7gp/">https://www.bilibili.com/video/BV1oM411J7gp/</a></a></p>
<h2 id="Êàë‰ª¨ÊòØÊÄéÊ†∑ÂÅöÂà∞ÁöÑ"><a class="header" href="#Êàë‰ª¨ÊòØÊÄéÊ†∑ÂÅöÂà∞ÁöÑ">Êàë‰ª¨ÊòØÊÄéÊ†∑ÂÅöÂà∞ÁöÑÔºü</a></h2>
<p>Êàë‰ª¨ÁõÆÂâçÁöÑÊÄùË∑ØÊòØÈÄöËøáÈ¢ÑËÆ≠ÁªÉ eBPF Á®ãÂ∫èÔºåËÆ© ChatGPT Â≠¶‰ºöÂ¶Ç‰ΩïÁºñÂÜôÂêÑÁßç eBPF Á®ãÂ∫èÊàñ bpftrace ÁöÑ DSL„ÄÇÂ§ßÊ¶ÇÂàÜ‰∏∫ËøôÂá†Ê≠•Ôºö</p>
<ol>
<li>È¢ÑËÆ≠ÁªÉ ebpf Á®ãÂ∫èÔºåÂà©Áî®‰∏Ä‰∫õ ebpf ÁöÑÂºÄÂèëËµÑÊñôÔºåÂÖàÂíå ChatGPT ÂØπËØùÂ§öÊ¨°ÔºåËÆ© ChatGPT ÈÄöËøáÂØπËØù‰∏ä‰∏ãÊñáÂ¶Ç‰ΩïÂÜôÂêÑÁßç eBPF Á®ãÂ∫èÊàñËÄÖ bpftrace ÁöÑ DSLÔºàÂÖ∂ÂÆûÊàë‰ª¨Âú®ÂçÅ‰∫åÊúà‰ªΩÂ∞±ÂÅöËøá‰∏Ä‰∫õÁ±ª‰ººÁöÑÂÆûË∑µÔºå‰∫ßÂá∫‰∫Ü‰∏Ä‰ªΩÊïôÁ®ãÊñáÊ°£Ôºå‰ΩÜÊ≤°ÊúâÊääÂÆÉÂèòÊàê‰∏Ä‰ªΩÂ∑•ÂÖ∑Ôºö<a href="https://github.com/eunomia-bpf/bpf-developer-tutorial">https://github.com/eunomia-bpf/bpf-developer-tutorial</a>ÔºâÔºõ</li>
<li>Ë∞ÉÁî® ChatGPT apiÔºåÂπ∂ÊääËøîÂõûÁöÑÁªìÊûúËß£Êûê‰πãÂêé‰Ωú‰∏∫ÂëΩ‰ª§ËæìÂÖ• shell ÊâßË°åÔºåÊàñËÄÖÂ∞Ü eBPF Á®ãÂ∫èÂÜôÂà∞Êñá‰ª∂ÈáåÈù¢ÁºñËØëËøêË°å</li>
<li>Â¶ÇÊûúÁºñËØëÂíåÂä†ËΩΩÊä•ÈîôÔºåÊääÂØπÂ∫îÁöÑÊä•Èîô‰ø°ÊÅØËøîÂõûÁªô ChatGPTÔºåËÆ©ÂÆÉÂÜçÁîüÊàê‰∏Ä‰∏™Êñ∞ÁöÑ eBPF Á®ãÂ∫èÊàñËÄÖÂëΩ‰ª§</li>
</ol>
<p>Êàë‰ª¨‰ΩøÁî®‰∫Ü ChatGPT ÁöÑ Python APIÔºåËä±‰∫Ü‰∏Ä‰∏™‰∏ãÂçàÁÆÄÂçïÂÆûÁé∞‰∫ÜËøô‰∏™Â∞èÁé©ÂÖ∑ÔºåÂÆÉÂèØ‰ª•‰ΩøÁî®‰∏≠ÊñáÊàñËÄÖËã±ÊñáÁ≠âÂ§öÁßçËØ≠Ë®ÄËæìÂÖ•‰ªªÊÑèËá™ÁÑ∂ËØ≠Ë®ÄÁöÑÊèèËø∞Ôºå‰æãÂ¶Ç ‚ÄúËøΩË∏™ËøõÁ®ãÊâìÂºÄÁöÑÊñá‰ª∂‚Äù &quot;Show per-second syscall rates&quot; Á≠âÁ≠âÔºåÊ≠£Á°ÆÁéá‰∏çÊòØ 100%Ôºå‰∏çËøáÂçÅÊ¨°ÈáåÈù¢Â§ßÊ¶ÇÂ∑≤ÁªèÂèØ‰ª•Êúâ‰∏ÉÂÖ´Ê¨°ÂèØ‰ª•Ê≠£Á°ÆËøõË°åËøΩË∏™‰∫ÜÔºåÈÅáÂà∞Êä•ÈîôËøò‰ºöËá™Ë°åËøõË°å‰øÆÊ≠£ÂíåË∞ÉÊï¥„ÄÇ</p>
<h2 id="Ëøõ‰∏ÄÊ≠•ÁöÑ‰ºòÂåñ"><a class="header" href="#Ëøõ‰∏ÄÊ≠•ÁöÑ‰ºòÂåñ">Ëøõ‰∏ÄÊ≠•ÁöÑ‰ºòÂåñÔºü</a></h2>
<p>Ëøô‰∏™Áé©ÂÖ∑È°πÁõÆÊú¨Ë∫´Âè™ÊòØÊÉ≥Â±ïÁ§∫‰∏Ä‰∏ãÂèØËÉΩÊÄßÔºåÂæàÂø´Â∫îËØ•‰ºöÊúâÊõ¥Â•ΩÁöÑÁ±ª‰ºº ChatGPT ËøôÊ†∑ÁöÑÁöÑ apiÔºåÂíåÊõ¥ÈÄöÁî®ÁöÑËÆ≠ÁªÉ/ÊâßË°åÊ°ÜÊû∂Âá∫Êù•ÁöÑÔºåÂ∏åÊúõÂÆÉËÉΩËµ∑Âà∞ÊäõÁ†ñÂºïÁéâÁöÑÊïàÊûú„ÄÇÁõÆÂâçÁúãËµ∑Êù•ËøòÊúâÂæàÂ§öÂèØ‰ª•‰ºòÂåñÁöÑÁ©∫Èó¥:</p>
<ol>
<li>ËÉΩËÅîÁΩëÊêúÁ¥¢‰πãÂêéÔºåËÆ©Ëøô‰∏™Â∑•ÂÖ∑ÂéªËé∑Âèñ bcc/bpftrace ‰ªìÂ∫ìÈáåÈù¢ÁöÑÁ§∫‰æãÁ®ãÂ∫èÂ≠¶‰π†ÔºåÊïàÊûúÂ∫îËØ•Ëøò‰ºöÂ•ΩÂæàÂ§ö;</li>
<li>ÊàñËÄÖËÆ©Ëøô‰∏™Â∫îÁî®Ëá™Â∑±ËÉΩËÅîÁΩëÊêúÁ¥¢ Stack Overflow ‰πãÁ±ªÁöÑÁªìÊûúÔºåÊü•ËØ¢Â¶Ç‰ΩïÁºñÂÜô eBPF Á®ãÂ∫èÔºåÁ±ª‰ººÊñ∞ Bing ÁöÑÊêúÁ¥¢ÊñπÂºèÔºõ</li>
<li>Êèê‰æõÊõ¥Â§öÈ´òË¥®ÈáèÁöÑÊñáÊ°£ÂíåÊïôÁ®ãÔºåÁúãËµ∑Êù•ËæìÂá∫ÁöÑÂáÜÁ°ÆÂ∫¶ÂíåÊïôÁ®ã„ÄÅ‰ª£Á†ÅÁ§∫‰æãÁöÑË¥®ÈáèÂØÜÂàáÁõ∏ÂÖ≥Ôºõ</li>
<li>ÂÖ∂ÂÆûËøòÂèØ‰ª•Â§öÊ¨°Ë∞ÉÁî®ÂÖ∂‰ªñÂ∑•ÂÖ∑ÊâßË°åÂëΩ‰ª§ËøîÂõûÁªìÊûúÔºåÊØîÂ¶ÇËØ¥ ChatGPT ËæìÂá∫ÂëΩ‰ª§ÔºåÁî® bpftrace Êü•ËØ¢‰∏Ä‰∏ãÂΩìÂâçÂÜÖÊ†∏ÁâàÊú¨ÂíåÊîØÊåÅÁöÑ tracepointÔºåÁÑ∂ÂêéËøîÂõûËæìÂá∫ÔºàËøô‰πüÊòØ‰∏ÄÊ¨°ÂØπËØùÔºâÔºåÂÜçÁªôÂá∫Á®ãÂ∫èÔºåÊïàÊûúÂ∫îËØ•ËøòË¶ÅÂ•Ω‰∏çÂ∞ë</li>
</ol>
<p>Áü≠ÊúüÊù•ÁúãÔºåÊàë‰ª¨Â∏åÊúõÂ∞ùËØïÂü∫‰∫éËøô‰∏™Â∑•ÂÖ∑ÊûÑÂª∫‰∏Ä‰∏™‰∫§‰∫íÂºèÁöÑ„ÄÅÂ∏¶ÊúâÊèêÁ§∫ÁöÑÂÜÖÊ†∏ËøΩË∏™Â∑•ÂÖ∑ÂíåÂ≠¶‰π† eBPF Á®ãÂ∫èÁöÑÊïôÁ®ãÔºåÂ∏ÆÂä©Áî®Êà∑Âú®ÁºñÂÜô eBPF Á®ãÂ∫èÊó∂Êõ¥Âø´Âú∞‰∫ÜËß£ËØ≠Ê≥ïÂíåË∞ÉËØïÈîôËØØÔºåÂπ∂‰∏îÂèØ‰ª•Ê†πÊçÆÁî®Êà∑ÁöÑÂèçÈ¶àË∞ÉÊï¥ÊèêÁ§∫ÂíåÂª∫ËÆÆÁöÑË¥®ÈáèÔºõ‰ª•ÂèäÊèê‰æõ‰∏Ä‰∏™ÁªìÊûÑÂåñÁöÑÂ≠¶‰π† eBPF Á®ãÂ∫èÁöÑÊïôÁ®ãÔºå‰ªéÂü∫Á°ÄÁöÑËØ≠Ê≥ïÂíå API ÂºÄÂßãÔºåÁªìÂêàÈÄöËøáÁî®Êà∑ÊúÄÁªàÊÉ≥ÁºñÂÜôÁöÑ eBPF Á®ãÂ∫èÁöÑÈúÄÊ±ÇÔºåÈÄêÊ≠•ÂêëÁî®Êà∑‰ªãÁªçÂ∏∏Áî®ÁöÑ eBPF Â∫îÁî®Âú∫ÊôØÂíåÁºñÂÜôÊäÄÂ∑ß„ÄÇ</p>
<p>ÊüêÁßçÊÑè‰πâ‰∏äÊù•ËØ¥ÔºåÂÆÉÁîöËá≥ÂèØ‰ª•‰∏ç‰ªÖ‰ªÖÊòØ‰∏ÄÁßçËØ≠Ë®ÄÊ®°ÂûãÔºåÂÄüÂä©ÁÆÄÂçïÁöÑÂØπËØùÁöÑ‰∫§‰∫íÊ®°ÂºèÔºå‰ª•ÂèäËÉΩÊìçÊéßÂêÑÁ±ªÂ∑•ÂÖ∑„ÄÅËÆøÈóÆÁΩëÁªúÁöÑÊâãÊÆµÔºåÂÆÉ‰πüËÆ∏ÂèØ‰ª•Ëµ∑Âà∞‰∏Ä‰∏™Â∑®Â§ßÁöÑ„ÄÅÂâçÊó†Âè§‰∫∫ÁöÑÁü•ËØÜÂ∫ìÁöÑ‰ΩúÁî®ÔºöËøûÊé•ÂêÑË°åÂêÑ‰∏öÔºåÊ†πÊçÆËá™ÁÑ∂ËØ≠Ë®ÄËæìÂÖ•ËÄåÈùûÂÖ≥ÈîÆËØçÔºåÁªôÂá∫ÁªºÂêàÊ¶ÇÊã¨ÁöÑ„ÄÅÊó†Ê≥ïË¢´ÊêúÁ¥¢ÂºïÊìéÁÆÄÂçïËé∑ÂèñÂà∞ÁöÑÊÄùËÄÉÂíåÁ≠îÊ°à„ÄÇ</p>
<p>Âú®ÂΩì‰ªä‰ø°ÊÅØÁàÜÁÇ∏ÁöÑÊó∂‰ª£ÔºåÊàë‰ª¨ÂèØ‰ª•ËΩªÊòìÂú∞Ëé∑ÂæóÂêÑÁßçÊµ∑ÈáèÁöÑ‰ø°ÊÅØÔºå‰ΩÜËøô‰πüÂ∏¶Êù•‰∫ÜÂè¶‰∏Ä‰∏™ÈóÆÈ¢òÔºåÂ∞±ÊòØ‰ø°ÊÅØÁöÑÂàÜÊï£ÂíåÁ¢éÁâáÂåñÔºåÂæàÈöæÂ∞ÜËøô‰∫õ‰ø°ÊÅØÊï¥ÂêàËµ∑Êù•ÔºåÂΩ¢ÊàêÊúâ‰ª∑ÂÄºÁöÑÁü•ËØÜ„ÄÇËÄå ChatGPT ÂèØ‰ª•ÈÄöËøáËá™ÁÑ∂ËØ≠Ë®Ä‰∫§‰∫íÁöÑÊñπÂºèÔºåÂ∞ÜÂêÑÁßç‰ø°ÊÅØÂíåÁü•ËØÜÊï¥ÂêàËµ∑Êù•Ôºå‰πÉËá≥‰∏ªÂä®ÂéªËé∑ÂèñÁü•ËØÜÂíåÊé•Êî∂ÂèçÈ¶àÔºàÂ∞±ÂÉèÊàë‰ª¨Âú® GPTtrace ‰∏≠ÂÅöÁöÑ‰∏ÄÊ†∑ÔºâÔºåÂΩ¢Êàê‰∏Ä‰∏™Â∑®Â§ßÁöÑÁü•ËØÜÂ∫ìÔºå‰∏∫‰∫∫‰ª¨Êèê‰æõÁªºÂêàÁöÑÊÄùËÄÉÂíåÁ≠îÊ°à„ÄÇ</p>
<p>ËøôÁßçÊñπÂºèÂèØ‰ª•ËøûÊé•ÂêÑË°åÂêÑ‰∏öÔºå‰∏çÂèóÁâπÂÆöÈ¢ÜÂüüÊàñË°å‰∏öÁöÑÈôêÂà∂ÔºåÊ†πÊçÆËá™ÁÑ∂ËØ≠Ë®ÄËæìÂÖ•ËÄåÈùûÂÖ≥ÈîÆËØçÔºåÁªôÂá∫Êõ¥Âä†ÂáÜÁ°Æ„ÄÅÁªºÂêàÁöÑÊ¶ÇÊã¨„ÄÇÊ≠§Â§ñÔºåÁî±‰∫é ChatGPT ÂèØ‰ª•ÊìçÊéßÂêÑÁ±ªÂ∑•ÂÖ∑ÂíåËÆøÈóÆÁΩëÁªúÔºåÂÆÉÂèØ‰ª•Êõ¥Âä†Ê∑±ÂÖ•Âú∞‰∫ÜËß£ÂêÑÁßçÁü•ËØÜÂíå‰ø°ÊÅØÔºåÂπ∂‰∏∫Áî®Êà∑Êèê‰æõÊõ¥Âä†ÂÖ®Èù¢ÂíåÊ∑±ÂÖ•ÁöÑËß£Á≠î„ÄÇ</p>
<p>ËøôÁßçÈù©ÂëΩÊÄßÁöÑÂèòÂåñÂèØËÉΩÂ∑≤ÁªèÁ´ôÂú®‰∫∫Á±ªÊñáÊòéÂèòÈù©ÁöÑÂâçÂ§úÔºåÊàë‰ª¨Ëé∑ÂèñÁü•ËØÜÂíåÊÄùËÄÉÁöÑÊñπÂºèÂ∞ÜË¢´È¢†Ë¶ÜÔºåÁ±ª‰ººÁöÑÂ§ßÊ®°ÂûãÁöÑÂá∫Áé∞Â∞ÜÊàê‰∏∫Ëøô‰∏™ÂèòÈù©ÁöÑÈáçË¶ÅÊé®Êâã„ÄÇ</p>
<h2 id="Êú™Êù•Âú®‰ΩïÊñπ"><a class="header" href="#Êú™Êù•Âú®‰ΩïÊñπ">Êú™Êù•Âú®‰ΩïÊñπÔºü</a></h2>
<p>ÂÖ∂ÂÆûËøô‰∏™Ê®°ÂûãÊú¨Ë∫´ÁöÑÊïàÊûúÔºåÂπ∂‰∏çÁÆóÊÉäËâ≥ÔºåÁîöËá≥ÂèØ‰ª•ËØ¥ËøòÊúâÈùûÂ∏∏Â§öÁöÑÊàêÈïøÁ©∫Èó¥„ÄÇÂØπ‰∫éÊàëËøôÊ†∑ÁöÑÈùû AI ‰∏ì‰∏öÁ†îÁ©∂‰∫∫ÂëòÔºàAIÂ∑•ÂÖ∑ÂíåÊ®°ÂûãÁöÑÊ∂àË¥πËÄÖÔºâÊù•ËØ¥ÔºåÂíå‰º†ÁªüÁöÑËÆ≠ÁªÉÊ∑±Â∫¶Â≠¶‰π†Ê®°ÂûãÁöÑÊñπÂºèÊØîËµ∑Êù•Ôºö</p>
<ul>
<li>ËÆ≠ÁªÉÊ®°Âûã‰∏çÈúÄË¶ÅÊï¥ÁêÜÊï∞ÊçÆÈõÜÂíåÊ∏ÖÊ¥óÊï∞ÊçÆÈõÜÔºå‰ªÖ‰ªÖÈúÄË¶ÅÂá†ÁØáÈ´òË¥®ÈáèÁöÑÊñáÊ°£ÂíåÊïôÁ®ãÔºåÊï∞ÈáèÈùûÂ∏∏Â∞ëÔºå‰ΩøÁî®Ëá™ÁÑ∂ËØ≠Ë®ÄÊèèËø∞Âç≥ÂèØÔºõÊûÅÂ§ßÂú∞ÂáèÂ∞ë‰∫ÜÈùû‰∏ì‰∏ö‰∫∫Â£´ÁöÑÂáÜÂ§áÂ∑•‰ΩúÔºõ</li>
<li>Âè™ÈúÄË¶ÅÂØπËØù‰∏ä‰∏ãÊñáÂç≥ÂèØÁõ¥ËßÇÂíåÊñπ‰æøÂú∞ËøõË°åËÆ≠ÁªÉÔºå‰ªª‰Ωï‰∫∫ÈÉΩÂèØ‰ª•ËΩªÊùæÁêÜËß£ÔºàÊàñËÄÖÂ∞ùËØïÁ±ªÊØîÔºâAI ÊòØÊÄé‰πàËøõË°åÂ≠¶‰π†ÁöÑÔºõ</li>
<li>ÂèØ‰ª•ÈÄÇÂ∫îÈùûÂ∏∏Â§öÁßç‰∏çÂêåÈ¢ÜÂüüÁöÑ‰ªªÂä°ÔºåÂè™Ë¶Å‰ªª‰Ωï‰ªªÂä°ËÉΩË¢´ËΩ¨Êç¢Êàê‰∏ÄÊÆµÊñáÊú¨ÊàñÊåá‰ª§Ôºõ</li>
</ul>
<p>Ê≠£Â¶ÇÂìàÂ∞îÊª®Â∑•‰∏öÂ§ßÂ≠¶ËΩ¶‰∏áÁøîÂÖàÁîüÂú®ÈùíÊ∫êWorkshop‰∏≠ÊèêÂèäÁöÑÔºåChatGPT Êó∂‰ª£ÔºåNLPer ÁöÑÂç±‰∏éÊú∫‰∏≠ÊâÄËØ¥ÁöÑÈÇ£Ê†∑Ôºö</p>
<blockquote>
<p>ChatGPTÊó∂‰ª£Ôºå‰∏∫‰∫ÜÂ∫îÂØπÂΩìÂâçÁöÑÊåëÊàòÔºåËá™ÁÑ∂ËØ≠Ë®ÄÈ¢ÜÂüüÁöÑÁ†îÁ©∂ËÄÖÂèØ‰ª•ÂÄüÈâ¥‰ø°ÊÅØÊ£ÄÁ¥¢Á†îÁ©∂ËÄÖÁöÑÁªèÈ™å„ÄÇÈ¶ñÂÖàÔºåÂ≠¶ÊúØÁïåÂèØËÉΩ‰∏çÂÜçËøõË°åÁ≥ªÁªüÁ∫ßÂà´ÁöÑÁ†îÁ©∂Ôºå‰∏ªË¶ÅÈõÜ‰∏≠Âú®Áõ∏ÂØπËæπÁºòÁöÑÁ†îÁ©∂ÊñπÂêë‰∏äÔºõÂÖ∂Ê¨°Ôºå‰ΩøÁî®Â∑•‰∏öÁïåÂ∑®Â§¥Êèê‰æõÁöÑÊï∞ÊçÆËøõË°åÂÆûÈ™åÔºåÂπ∂‰∏ç‰∏ÄÂÆöËÉΩÂæóÂá∫ÂèØÈù†ÁöÑÁªìËÆ∫ÔºåÁî±‰∫éÂ≠òÂú®ÈöêÁßÅÈóÆÈ¢òÔºåÊï∞ÊçÆÁöÑÁúüÂÆûÊÄßÂ≠òÁñëÔºõÈÄöËøáË∞ÉÁî®ÂÖ¨Âè∏Êèê‰æõÁöÑ API ËøõË°åÁ†îÁ©∂Ôºå‰∏ÄÊó¶Ê®°ÂûãË¢´Ë∞ÉÊï¥ÔºåÂÖ∂ÁªìËÆ∫ÊúâÂèØËÉΩ‰πü‰ºöÊîπÂèò„ÄÇ</p>
</blockquote>
<p>ÂΩì‰ΩøÁî® AI Ëß£ÂÜ≥ÁâπÂÆöÈóÆÈ¢òÁöÑÈó®ÊßõÂèòÂæóË∂≥Â§üÁöÑ‰ΩéÂªâÔºåÂèçËÄåÊòØ AI Êõ¥Ëøõ‰∏ÄÊ≠•ÊôÆÂèä„ÄÅÊõ¥Ëøõ‰∏ÄÊ≠•Ëß£ÂÜ≥Êõ¥Â§öÁªÜÂàÜÂú∫ÊôØ‰∏ãÁöÑÈóÆÈ¢òÁöÑÂ∑®Â§ßÊú∫‰ºö„ÄÇÂè¶‰∏ÄÊñπÈù¢ÂèØËÉΩÊòØÊîØÊíë AI ÁöÑÂü∫Á°ÄËÆæÊñΩÔºöÂΩìÁîüÊàêÁöÑÂÜÖÂÆπÔºà‰æãÂ¶Ç‰ª£Á†ÅÔºåÊñáÊú¨ÔºåÁÆóÊ≥ïÔºåÈü≥È¢ëËßÜÈ¢ëÔºâÁöÑÊàêÊú¨ÂèòÂæóÊõ¥Âªâ‰ª∑Ôºå‰πüËÆ∏ÂèØÁºñÁ®ã„ÄÅ‰Ωé‰ª£Á†ÅÁöÑÂπ≥Âè∞‰πü‰ºöÂèòÂæóÁõ∏ÂØπÂéüÂÖàÂ∑®Â§ßÁöÑÂçï‰ΩìÂ∫îÁî®Êù•ËØ¥ÔºåÂèòÂæóÊõ¥Âä†ÂÖ∑ÊúâÂèØÊâ©Â±ïÊÄßÂíåÂèØÂ§çÁî®ÊÄß„ÄÇ‰æãÂ¶ÇÔºå‰ªé‰∏ÄÊÆµÊèèËø∞Êàñ‰∫§‰∫íÂºèÂú∞ÂØπËØù‰∏≠Áõ¥Êé•ÁîüÊàê‰∏Ä‰∏™ FaaS ÁöÑÊé•Âè£ÂèëÂ∏ÉÔºåÁõ¥Êé•ÁîüÊàê‰∏Ä‰∏™ÁΩëÈ°µÂâçÁ´ØÂπ∂ÈÉ®ÁΩ≤ÔºåÊàñ‰ΩøÁî® ChatGPT ÁîüÊàêÁöÑ‰ª£Á†ÅÁõ¥Êé•‰Ωú‰∏∫ÂèØËßÇÊµãÁöÑÈááÈõÜÂíåÊï∞ÊçÆÂ§ÑÁêÜÁ®ãÂ∫èÔºåÈÉ®ÁΩ≤Âà∞Â§ßÂûãÁöÑÂèØËßÇÊµãÊÄßÂπ≥Âè∞‰∏≠„ÄÇ</p>
<p>Êàë‰ª¨Áé∞Âú®‰πüÂú®Êé¢Á¥¢‰∏Ä‰∫õ eBPF Âíå Wasm ÁªìÂêàÁöÑÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂ÔºåÂ∏åÊúõÂÆûÁé∞‰ªéÂÜÖÊ†∏ÊÄÅÂà∞Áî®Êà∑ÊÄÅÁöÑÂèØÁºñÁ®ãÊâ©Â±ïÊïàÊûúÔºö<a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></p>
<h2 id="‰∏Ä‰∫õÂèÇËÄÉÈìæÊé•"><a class="header" href="#‰∏Ä‰∫õÂèÇËÄÉÈìæÊé•">‰∏Ä‰∫õÂèÇËÄÉÈìæÊé•</a></h2>
<ul>
<li>ChatGPTÔºö<a href="https://chat.openai.com/chat">https://chat.openai.com/chat</a></li>
<li>GPTtraceÔºö<a href="https://github.com/eunomia-bpf/GPTtrace">https://github.com/eunomia-bpf/GPTtrace</a></li>
<li>ChatGPT Python API: <a href="https://github.com/mmabrouk/chatgpt-wrapper">https://github.com/mmabrouk/chatgpt-wrapper</a></li>
<li>Âü∫‰∫é CO-RE (‰∏ÄÊ¨°ÁºñÂÜôÔºåÂà∞Â§ÑËøêË°åÔºâ libbpf ÁöÑ eBPF ÂºÄÂèëËÄÖÊïôÁ®ãÔºöÈÄöËøá 20 ‰∏™Â∞èÂ∑•ÂÖ∑‰∏ÄÊ≠•Ê≠•Â≠¶‰π† eBPFÔºàÂ∞ùËØïÊïô‰ºö ChatGPT ÁºñÂÜô eBPF Á®ãÂ∫èÔºâÔºö<a href="https://github.com/eunomia-bpf/bpf-developer-tutorial">https://github.com/eunomia-bpf/bpf-developer-tutorial</a></li>
<li>ChatGPTÁ±ªÂ∑•ÂÖ∑Â¶Ç‰ΩïÂÆûÁé∞„ÄåÈôçÁª¥ÊâìÂáª„Äç| ËÅäÂ§©Êú∫Âô®‰∫∫Èó≠Èó®Á†îËÆ®ËßÇÁÇπÊÄªÁªìÔºö<a href="https://mp.weixin.qq.com/s/fB9rguy26ej-alm7l_i8iQ">https://mp.weixin.qq.com/s/fB9rguy26ej-alm7l_i8iQ</a></li>
<li>eunomia-bpf ÂºÄÊ∫êÁ§æÂå∫Ôºö<a href="https://github.com/eunomia-bpf">https://github.com/eunomia-bpf</a></li>
</ul>
<blockquote>
<p>Ê≥®ÔºöÊú¨Êñá‰ΩøÁî® ChatGPT ËøõË°åËæÖÂä©ÂÜô‰ΩúÂÆåÊàê„ÄÇ</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><p>#!<a href="https://zhuanlan.zhihu.com/p/573941739">https://zhuanlan.zhihu.com/p/573941739</a></p>
<h1 id="ÂΩì-wasm-ÈÅáËßÅ-ebpf-‰ΩøÁî®-webassembly-ÁºñÂÜôÂàÜÂèëÂä†ËΩΩËøêË°å-ebpf-Á®ãÂ∫è"><a class="header" href="#ÂΩì-wasm-ÈÅáËßÅ-ebpf-‰ΩøÁî®-webassembly-ÁºñÂÜôÂàÜÂèëÂä†ËΩΩËøêË°å-ebpf-Á®ãÂ∫è">ÂΩì Wasm ÈÅáËßÅ eBPF Ôºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫è</a></h1>
<p>ÂΩì‰ªä‰∫ëÂéüÁîü‰∏ñÁïå‰∏≠‰∏§‰∏™ÊúÄÁÉ≠Èó®ÁöÑËΩªÈáèÁ∫ß‰ª£Á†ÅÊâßË°åÊ≤ôÁÆ±/ËôöÊãüÊú∫ÊòØ eBPF Âíå WebAssembly„ÄÇÂÆÉ‰ª¨ÈÉΩËøêË°å‰ªé C„ÄÅC++ Âíå Rust Á≠âËØ≠Ë®ÄÁºñËØëÁöÑÈ´òÊÄßËÉΩÂ≠óËäÇÁ†ÅÁ®ãÂ∫èÔºåÂπ∂‰∏îÈÉΩÊòØË∑®Âπ≥Âè∞„ÄÅÂèØÁßªÊ§çÁöÑ„ÄÇ‰∫åËÄÖÊúÄÂ§ßÁöÑÂå∫Âà´Âú®‰∫éÔºö eBPF Âú® Linux ÂÜÖÊ†∏‰∏≠ËøêË°åÔºåËÄå WebAssembly Âú®Áî®Êà∑Á©∫Èó¥‰∏≠ËøêË°å„ÄÇÊàë‰ª¨Â∏åÊúõËÉΩÂÅö‰∏Ä‰∫õÂ∞Ü‰∫åËÄÖÁõ∏‰∫íËûçÂêàÁöÑÂ∞ùËØïÔºö‰ΩøÁî® Wasm Êù•ÁºñÂÜôÈÄöÁî®ÁöÑ eBPF Á®ãÂ∫èÔºåÁÑ∂ÂêéÂèØ‰ª•Â∞ÜÂÖ∂ÂàÜÂèëÂà∞‰ªªÊÑè‰∏çÂêåÁâàÊú¨„ÄÅ‰∏çÂêåÊû∂ÊûÑÁöÑ Linux ÂÜÖÊ†∏‰∏≠ÔºåÊó†ÈúÄÈáçÊñ∞ÁºñËØëÂç≥ÂèØËøêË°å„ÄÇ</p>
<h2 id="webassembly-vs-ebpf"><a class="header" href="#webassembly-vs-ebpf">WebAssembly vs. eBPF</a></h2>
<p>WebAssembly(Áº©ÂÜô Wasm)ÊòØÂü∫‰∫éÂ†ÜÊ†àËôöÊãüÊú∫ÁöÑ‰∫åËøõÂà∂Êåá‰ª§Ê†ºÂºè„ÄÇWasm ÊòØ‰∏∫‰∫Ü‰∏Ä‰∏™ÂèØÁßªÊ§çÁöÑÁõÆÊ†áËÄåËÆæËÆ°ÁöÑÔºåÂèØ‰Ωú‰∏∫ C/C+/RUST Á≠âÈ´òÁ∫ßËØ≠Ë®ÄÁöÑÁºñËØëÁõÆÊ†áÔºå‰ΩøÂÆ¢Êà∑Á´ØÂíåÊúçÂä°Âô®Â∫îÁî®Á®ãÂ∫èËÉΩÂ§üÂú® Web ‰∏äÈÉ®ÁΩ≤„ÄÇWasm ÁöÑËøêË°åÊó∂ÊúâÂ§öÁßçÂÆûÁé∞ÔºåÂåÖÊã¨ÊµèËßàÂô®ÂíåÁã¨Á´ãÁöÑÁ≥ªÁªüÔºåÂÆÉÂèØ‰ª•Áî®‰∫éËßÜÈ¢ëÂíåÈü≥È¢ëÁºñËß£Á†ÅÂô®„ÄÅÂõæÂΩ¢Âíå 3D„ÄÅÂ§öÂ™í‰ΩìÂíåÊ∏∏Êàè„ÄÅÂØÜÁ†ÅËÆ°ÁÆóÊàñ‰æøÊê∫ÂºèËØ≠Ë®ÄÂÆûÁé∞Á≠âÂ∫îÁî®„ÄÇ</p>
<p>Â∞ΩÁÆ° Wasm ÊòØ‰∏∫‰∫ÜÊèêÈ´òÁΩëÈ°µ‰∏≠ÊÄßËÉΩÊïèÊÑüÊ®°ÂùóË°®Áé∞ËÄåÊèêÂá∫ÁöÑÂ≠óËäÇÁ†ÅÊ†áÂáÜ, ‰ΩÜÊòØ Wasm Âç¥‰∏ç‰ªÖËÉΩÁî®Âú®ÊµèËßàÂô®(broswer)‰∏≠, ‰πüÂèØ‰ª•Áî®Âú®ÂÖ∂‰ªñÁéØÂ¢É‰∏≠„ÄÇWasm Â∑≤ÁªèÂèëÂ±ïÊàê‰∏∫‰∏Ä‰∏™ËΩªÈáèÁ∫ß„ÄÅÈ´òÊÄßËÉΩ„ÄÅË∑®Âπ≥Âè∞ÂíåÂ§öËØ≠ÁßçÁöÑËΩØ‰ª∂Ê≤ôÁõíÁéØÂ¢ÉÔºåË¢´ËøêÁî®‰∫é‰∫ëÂéüÁîüËΩØ‰ª∂ÁªÑ‰ª∂„ÄÇ‰∏é Linux ÂÆπÂô®Áõ∏ÊØîÔºåWebAssembly ÁöÑÂêØÂä®ÈÄüÂ∫¶ÂèØ‰ª•ÊèêÈ´ò 100 ÂÄçÔºåÂÜÖÂ≠òÂíåÁ£ÅÁõòÂç†Áî®Á©∫Èó¥Ë¶ÅÂ∞èÂæóÂ§öÔºåÂπ∂‰∏îÂÖ∑ÊúâÊõ¥Â•ΩÂÆö‰πâÁöÑÂÆâÂÖ®Ê≤ôÁÆ±„ÄÇÁÑ∂ËÄåÔºåÊùÉË°°ÊòØ WebAssembly ÈúÄË¶ÅËá™Â∑±ÁöÑËØ≠Ë®Ä SDK ÂíåÁºñËØëÂô®Â∑•ÂÖ∑ÈìæÔºå‰ΩøÂÖ∂Êàê‰∏∫ÊØî Linux ÂÆπÂô®Êõ¥ÂèóÈôêÂà∂ÁöÑÂºÄÂèëÁéØÂ¢É„ÄÇWebAssembly Ë∂äÊù•Ë∂äÂ§öÂú∞Áî®‰∫éÈöæ‰ª•ÈÉ®ÁΩ≤ Linux ÂÆπÂô®ÊàñÂ∫îÁî®Á®ãÂ∫èÊÄßËÉΩËá≥ÂÖ≥ÈáçË¶ÅÁöÑËæπÁºòËÆ°ÁÆóÂú∫ÊôØ„ÄÇ</p>
<p>Wasm ÁöÑÁºñËØëÂíåÈÉ®ÁΩ≤ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<p><img src="blog/../img/wasm-compile.png" alt="wasm-compile-deploy" /></p>
<p>ÈÄöÂ∏∏ÂèØ‰ª•Â∞Ü C/C+/RUST Á≠âÈ´òÁ∫ßËØ≠Ë®ÄÁºñËØë‰∏∫ Wasm Â≠óËäÇÁ†ÅÔºåÂú® Wasm ËôöÊãüÊú∫‰∏≠ËøõË°åÂä†ËΩΩËøêË°å„ÄÇWasm ËôöÊãüÊú∫‰ºöÈÄöËøáËß£ÈáäÊâßË°åÊàñ JIT ÁöÑÊñπÂºèÔºåÂ∞Ü Wasm Â≠óËäÇÁ†ÅÁøªËØë‰∏∫ÂØπÂ∫îÂπ≥Âè∞Ôºà x86/arm Á≠âÔºâÁöÑÊú∫Âô®Á†ÅËøêË°å„ÄÇ</p>
<p>eBPF Ê∫ê‰∫é BPFÔºåÊú¨Ë¥®‰∏äÊòØÂ§Ñ‰∫éÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™È´òÊïà‰∏éÁÅµÊ¥ªÁöÑËôöÊãüÊú∫ÁªÑ‰ª∂Ôºå‰ª•‰∏ÄÁßçÂÆâÂÖ®ÁöÑÊñπÂºèÂú®ËÆ∏Â§öÂÜÖÊ†∏ hook ÁÇπÊâßË°åÂ≠óËäÇÁ†Å„ÄÇBPF ÊúÄÂàùÁöÑÁõÆÁöÑÊòØÁî®‰∫éÈ´òÊïàÁΩëÁªúÊä•ÊñáËøáÊª§ÔºåÁªèËøáÈáçÊñ∞ËÆæËÆ°ÔºåeBPF ‰∏çÂÜçÂ±ÄÈôê‰∫éÁΩëÁªúÂçèËÆÆÊ†àÔºåÂ∑≤ÁªèÊàê‰∏∫ÂÜÖÊ†∏È°∂Á∫ßÁöÑÂ≠êÁ≥ªÁªüÔºåÊºîËøõ‰∏∫‰∏Ä‰∏™ÈÄöÁî®ÊâßË°åÂºïÊìé„ÄÇÂºÄÂèëËÄÖÂèØÂü∫‰∫é eBPF ÂºÄÂèëÊÄßËÉΩÂàÜÊûêÂ∑•ÂÖ∑„ÄÅËΩØ‰ª∂ÂÆö‰πâÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âËØ∏Â§öÂú∫ÊôØ„ÄÇeBPF Êúâ‰∏Ä‰∫õÁºñÁ®ãÈôêÂà∂ÔºåÈúÄË¶ÅÁªèËøáÈ™åËØÅÂô®Á°Æ‰øùÂÖ∂Âú®ÂÜÖÊ†∏Â∫îÁî®Âú∫ÊôØ‰∏≠ÊòØÂÆâÂÖ®ÁöÑÔºà‰æãÂ¶ÇÔºåÊ≤°ÊúâÊó†ÈôêÂæ™ÁéØ„ÄÅÂÜÖÂ≠òË∂äÁïåÁ≠âÔºâÔºå‰ΩÜËøô‰πüÊÑèÂë≥ÁùÄ eBPF ÁöÑÁºñÁ®ãÊ®°Âûã‰∏çÊòØÂõæÁÅµÂÆåÂ§áÁöÑ„ÄÇÁõ∏ÊØî‰πã‰∏ãÔºåWebAssembly ÊòØ‰∏ÄÁßçÂõæÁÅµÂÆåÂ§áÁöÑËØ≠Ë®ÄÔºåÂÖ∑ÊúâËÉΩÂ§üÊâìÁ†¥Ê≤ôÁõíÂíåËÆøÈóÆÂéüÁîü OS Â∫ìÁöÑÊâ©Â±ï WASI (WebAssembly System Interface, Wasm Á≥ªÁªüÊé•Âè£) ÔºåÂêåÊó∂ Wasm ËøêË°åÊó∂ÂèØ‰ª•ÂÆâÂÖ®Âú∞ÈöîÁ¶ªÂπ∂‰ª•Êé•ËøëÂéüÁîüÁöÑÊÄßËÉΩÊâßË°åÁî®Êà∑Á©∫Èó¥‰ª£Á†Å„ÄÇ‰∫åËÄÖÁöÑÈ¢ÜÂüü‰∏ª‰Ωì‰∏äÊúâ‰∏çÂ∞ëÂ∑ÆÂºÇÔºå‰ΩÜ‰πüÊúâ‰∏çÂ∞ëÁõ∏‰∫íÈáçÂè†ÁöÑÂú∞Êñπ„ÄÇ</p>
<p>Êúâ‰∏Ä‰∫õÂú® Linux ÂÜÖÊ†∏‰∏≠ËøêË°å WebAssembly ÁöÑÂ∞ùËØïÔºåÁÑ∂ËÄåÂü∫Êú¨‰∏ä‰∏çÂ§™ÊàêÂäü„ÄÇ eBPF ÊòØËøô‰∏™Â∫îÁî®Âú∫ÊôØ‰∏ãÊõ¥Â•ΩÁöÑÈÄâÊã©„ÄÇ‰ΩÜÊòØ WebAssembly Á®ãÂ∫èÂèØ‰ª•Â§ÑÁêÜËÆ∏Â§öÁ±ªÂÜÖÊ†∏ÁöÑ‰ªªÂä°ÔºåÂèØ‰ª•Ë¢´ AOT ÁºñËØëÊàêÂéüÁîüÂ∫îÁî®Á®ãÂ∫è„ÄÇÊù•Ëá™ CNCF ÁöÑ WasmEdge Runtime ÊòØ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑÂü∫‰∫é LLVM ÁöÑ‰∫ëÂéüÁîü WebAssembly ÁºñËØëÂô®„ÄÇÂéüÁîüÂ∫îÁî®Á®ãÂ∫èÂ∞ÜÊâÄÊúâÊ≤ôÁÆ±Ê£ÄÊü•ÂêàÂπ∂Âà∞ÂéüÁîüÂ∫ì‰∏≠ÔºåËøôÂÖÅËÆ∏ WebAssembly Á®ãÂ∫èË°®Áé∞ÂæóÂÉè‰∏Ä‰∏™Áã¨Á´ãÁöÑ unikernel ‚ÄúÂ∫ìÊìç‰ΩúÁ≥ªÁªü‚Äù„ÄÇÊ≠§Â§ñÔºåËøôÁßç AOT ÁºñËØëÁöÑÊ≤ôÁõí WebAssembly Â∫îÁî®Á®ãÂ∫èÂèØ‰ª•Âú®ÂæÆÂÜÖÊ†∏Êìç‰ΩúÁ≥ªÁªüÔºàÂ¶Ç seL4Ôºâ‰∏äËøêË°åÔºåÂπ∂‰∏îÂèØ‰ª•Êé•ÁÆ°ËÆ∏Â§ö‚ÄúÂÜÖÊ†∏Á∫ß‚Äù‰ªªÂä°[1]„ÄÇ</p>
<p>ËôΩÁÑ∂ WebAssembly ÂèØ‰ª•‰∏ãÈôçÂà∞ÂÜÖÊ†∏Á∫ßÂà´Ôºå‰ΩÜ eBPF ‰πüÂèØ‰ª•‰∏äÂçáÂà∞Â∫îÁî®Á®ãÂ∫èÁ∫ßÂà´„ÄÇÂú® sidecar ‰ª£ÁêÜ‰∏≠ÔºåEnvoy Proxy ÂºÄÂàõ‰∫Ü‰ΩøÁî® Wasm ‰Ωú‰∏∫Êâ©Â±ïÊú∫Âà∂ÂØπÊï∞ÊçÆÂπ≥Èù¢ËøõË°åÁºñÁ®ãÁöÑÊñπÊ≥ï„ÄÇÂºÄÂèë‰∫∫ÂëòÂèØ‰ª•Áî® C„ÄÅC++„ÄÅRust„ÄÅAssemblyScript„ÄÅSwift Âíå TinyGo Á≠âËØ≠Ë®ÄÁºñÂÜôÁâπÂÆöÂ∫îÁî®ÁöÑ‰ª£ÁêÜÈÄªËæëÔºåÂπ∂Â∞ÜËØ•Ê®°ÂùóÁºñËØëÂà∞ Wasm ‰∏≠„ÄÇÈÄöËøá proxy-Wasm Ê†áÂáÜÔºå‰ª£ÁêÜÂèØ‰ª•Âú® Wasmtime Âíå WasmEdge Á≠âÈ´òÊÄßËÉΩËøêË°åÊú∫Âà∂‰∏≠ÊâßË°åÈÇ£‰∫õ Wasm Êèí‰ª∂[2]„ÄÇ</p>
<p>Â∞ΩÁÆ°ÁõÆÂâçÊúâ‰∏çÂ∞ëÂ∫îÁî®Á®ãÂ∫èÂêåÊó∂‰ΩøÁî®‰∫Ü‰∫åËÄÖÔºå‰ΩÜÂ§ßÂ§öÊï∞Êó∂ÂÄôËøô‰∏§‰∏™ËôöÊãüÊú∫ÊòØÁõ∏‰∫íÁã¨Á´ãÂπ∂‰∏îÊ≤°Êúâ‰∫§ÈõÜÁöÑÔºö‰æãÂ¶ÇÂú®ÂèØËßÇÊµãÊÄßÂ∫îÁî®‰∏≠ÔºåÈÄöËøá eBPF Êé¢ÈíàËé∑ÂèñÊï∞ÊçÆÔºåËé∑ÂèñÊï∞ÊçÆ‰πãÂêéÂú®Áî®Êà∑ÊÄÅÂºïÂÖ• Wasm Êèí‰ª∂Ê®°ÂùóÔºåËøõË°åÂèØÈÖçÁΩÆÁöÑÊï∞ÊçÆÂ§ÑÁêÜ„ÄÇWasm Ê®°ÂùóÂíå eBPF Á®ãÂ∫èÁöÑÂàÜÂèë„ÄÅËøêË°å„ÄÅÂä†ËΩΩ„ÄÅÊéßÂà∂Áõ∏‰∫íÁã¨Á´ãÔºå‰ªÖ‰ªÖÂ≠òÂú®Êï∞ÊçÆÊµÅÁöÑÂÖ≥ËÅî„ÄÇ</p>
<h2 id="Êàë‰ª¨ÁöÑ‰∏ÄÊ¨°Â∞ùËØï"><a class="header" href="#Êàë‰ª¨ÁöÑ‰∏ÄÊ¨°Â∞ùËØï">Êàë‰ª¨ÁöÑ‰∏ÄÊ¨°Â∞ùËØï</a></h2>
<p>‰∏ÄËà¨Êù•ËØ¥Ôºå‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ eBPF Â∫îÁî®Á®ãÂ∫èÂàÜ‰∏∫Áî®Êà∑Á©∫Èó¥Á®ãÂ∫èÂíåÂÜÖÊ†∏Á®ãÂ∫è‰∏§ÈÉ®ÂàÜÔºö</p>
<ul>
<li>Áî®Êà∑Á©∫Èó¥Á®ãÂ∫èË¥üË¥£Âä†ËΩΩ BPF Â≠óËäÇÁ†ÅËá≥ÂÜÖÊ†∏ÔºåÊàñË¥üË¥£ËØªÂèñÂÜÖÊ†∏Âõû‰º†ÁöÑÁªüËÆ°‰ø°ÊÅØÊàñËÄÖ‰∫ã‰ª∂ËØ¶ÊÉÖÔºåËøõË°åÁõ∏ÂÖ≥ÁöÑÊï∞ÊçÆÂ§ÑÁêÜÂíåÊéßÂà∂Ôºõ</li>
<li>ÂÜÖÊ†∏‰∏≠ÁöÑ BPF Â≠óËäÇÁ†ÅË¥üË¥£Âú®ÂÜÖÊ†∏‰∏≠ÊâßË°åÁâπÂÆö‰∫ã‰ª∂ÔºåÂ¶ÇÈúÄË¶Å‰πü‰ºöÂ∞ÜÊâßË°åÁöÑÁªìÊûúÈÄöËøá maps ÊàñËÄÖ perf-event ‰∫ã‰ª∂ÂèëÈÄÅËá≥Áî®Êà∑Á©∫Èó¥</li>
</ul>
<p>Áî®Êà∑ÊÄÅÁ®ãÂ∫èÂèØ‰ª•Âú®Âä†ËΩΩ eBPF Á®ãÂ∫èÂâçÊéßÂà∂‰∏Ä‰∫õ eBPF Á®ãÂ∫èÁöÑÂèÇÊï∞ÂíåÂèòÈáèÔºå‰ª•ÂèäÊåÇËΩΩÁÇπÔºõ‰πüÂèØ‰ª•ÈÄöËøá map Á≠âÁ≠âÊñπÂºèËøõË°åÁî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥ÁöÑÂèåÂêëÈÄö‰ø°„ÄÇÈÄöÂ∏∏Êù•ËØ¥Áî®Êà∑ÊÄÅÁöÑ eBPF Á®ãÂ∫èÂèØ‰ª•Âü∫‰∫é <code>libbpf</code> Â∫ìËøõË°åÂºÄÂèëÔºåÊù•ÊéßÂà∂ÂÜÖÊ†∏ÊÄÅ eBPF Á®ãÂ∫èÁöÑË£ÖËΩΩÂíåËøêË°å„ÄÇÈÇ£‰πàÔºåÂ¶ÇÊûúÂ∞ÜÁî®Êà∑ÊÄÅÁöÑÊâÄÊúâÊéßÂà∂ÂíåÊï∞ÊçÆÂ§ÑÁêÜÈÄªËæëÂÖ®ÈÉ®ÁßªÂà∞ Wasm ËôöÊãüÊú∫‰∏≠ÔºåÈÄöËøá Wasm module ÊâìÂåÖÂíåÂàÜÂèë eBPF Â≠óËäÇÁ†ÅÔºåÂêåÊó∂Âú® Wasm ËôöÊãüÊú∫ÂÜÖÈÉ®ÊéßÂà∂Êï¥‰∏™ eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°åÔºå‰πüËÆ∏Êàë‰ª¨Â∞±ÂèØ‰ª•Â∞Ü‰∫åËÄÖÁöÑ‰ºòÂäøÁªìÂêàËµ∑Êù•ÔºåËÆ©‰ªªÊÑè eBPF Á®ãÂ∫èËÉΩÊúâÂ¶Ç‰∏ãÁâπÊÄßÔºö</p>
<ul>
<li><code>ÂèØÁßªÊ§ç</code>ÔºöËÆ© eBPF Â∑•ÂÖ∑ÂíåÂ∫îÁî®ÂÆåÂÖ®Âπ≥Âè∞Êó†ÂÖ≥„ÄÅÂèØÁßªÊ§çÔºå‰∏çÈúÄË¶ÅËøõË°åÈáçÊñ∞ÁºñËØëÂç≥ÂèØ‰ª•Ë∑®Âπ≥Âè∞ÂàÜÂèëÔºõ</li>
<li><code>ÈöîÁ¶ªÊÄß</code>ÔºöÂÄüÂä© Wasm ÁöÑÂèØÈù†ÊÄßÂíåÈöîÁ¶ªÊÄßÔºåËÆ© eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°å„ÄÅ‰ª•ÂèäÁî®Êà∑ÊÄÅÁöÑÊï∞ÊçÆÂ§ÑÁêÜÊµÅÁ®ãÊõ¥Âä†ÂÆâÂÖ®ÂèØÈù†Ôºõ‰∫ãÂÆû‰∏ä‰∏Ä‰∏™ eBPF Â∫îÁî®ÁöÑÁî®Êà∑ÊÄÅÊéßÂà∂‰ª£Á†ÅÈÄöÂ∏∏ËøúËøúÂ§ö‰∫éÂÜÖÊ†∏ÊÄÅÔºõ</li>
<li><code>ÂåÖÁÆ°ÁêÜ</code>ÔºöÂÄüÂä© Wasm ÁöÑÁîüÊÄÅÂíåÂ∑•ÂÖ∑ÈìæÔºåÂÆåÊàê eBPF Á®ãÂ∫èÊàñÂ∑•ÂÖ∑ÁöÑÂàÜÂèë„ÄÅÁÆ°ÁêÜ„ÄÅÂä†ËΩΩÁ≠âÂ∑•‰ΩúÔºåÁõÆÂâç eBPF Á®ãÂ∫èÊàñÂ∑•ÂÖ∑ÁîüÊÄÅÂèØËÉΩÁº∫‰πè‰∏Ä‰∏™ÈÄöÁî®ÁöÑÂåÖÁÆ°ÁêÜÊàñÊèí‰ª∂ÁÆ°ÁêÜÁ≥ªÁªüÔºõ</li>
<li><code>Ë∑®ËØ≠Ë®Ä</code>ÔºöÁõÆÂâç eBPF Á®ãÂ∫èÁî±Â§öÁßçÁî®Êà∑ÊÄÅËØ≠Ë®ÄÂºÄÂèëÔºàÂ¶Ç Go\Rust\C\C++\Python Á≠âÔºâÔºåË∂ÖËøá 30 ÁßçÁºñÁ®ãËØ≠Ë®ÄÂèØ‰ª•Ë¢´ÁºñËØëÊàê WebAssembly Ê®°ÂùóÔºåÂÖÅËÆ∏ÂêÑÁßçËÉåÊôØÁöÑÂºÄÂèë‰∫∫ÂëòÔºàC„ÄÅGo„ÄÅRust„ÄÅJava„ÄÅTypeScript Á≠âÔºâÁî®‰ªñ‰ª¨ÈÄâÊã©ÁöÑËØ≠Ë®ÄÁºñÂÜô eBPF ÁöÑÁî®Êà∑ÊÄÅÁ®ãÂ∫èÔºåËÄå‰∏çÈúÄË¶ÅÂ≠¶‰π†Êñ∞ÁöÑËØ≠Ë®ÄÔºõ</li>
<li><code>ÊïèÊç∑ÊÄß</code>ÔºöÂØπ‰∫éÂ§ßÂûãÁöÑ eBPF Â∫îÁî®Á®ãÂ∫èÔºåÂèØ‰ª•‰ΩøÁî® Wasm ‰Ωú‰∏∫Êèí‰ª∂Êâ©Â±ïÂπ≥Âè∞ÔºöÊâ©Â±ïÁ®ãÂ∫èÂèØ‰ª•Âú®ËøêË°åÊó∂Áõ¥Êé•‰ªéÊéßÂà∂Âπ≥Èù¢‰∫§‰ªòÂíåÈáçÊñ∞Âä†ËΩΩ„ÄÇËøô‰∏ç‰ªÖÊÑèÂë≥ÁùÄÊØè‰∏™‰∫∫ÈÉΩÂèØ‰ª•‰ΩøÁî®ÂÆòÊñπÂíåÊú™Áªè‰øÆÊîπÁöÑÂ∫îÁî®Á®ãÂ∫èÊù•Âä†ËΩΩËá™ÂÆö‰πâÊâ©Â±ïÔºåËÄå‰∏î‰ªª‰Ωï eBPF Á®ãÂ∫èÁöÑÈîôËØØ‰øÆÂ§çÂíå/ÊàñÊõ¥Êñ∞ÈÉΩÂèØ‰ª•Âú®ËøêË°åÊó∂Êé®ÈÄÅÂíå/ÊàñÊµãËØïÔºåËÄå‰∏çÈúÄË¶ÅÊõ¥Êñ∞Âíå/ÊàñÈáçÊñ∞ÈÉ®ÁΩ≤‰∏Ä‰∏™Êñ∞ÁöÑ‰∫åËøõÂà∂Ôºõ</li>
<li><code>ËΩªÈáèÁ∫ß</code>ÔºöWebAssembly ÂæÆÊúçÂä°Ê∂àËÄó 1% ÁöÑËµÑÊ∫êÔºå‰∏é Linux ÂÆπÂô®Â∫îÁî®Áõ∏ÊØîÔºåÂÜ∑ÂêØÂä®ÁöÑÊó∂Èó¥ÊòØ 1%ÔºöÊàë‰ª¨‰πüËÆ∏ÂèØ‰ª•ÂÄüÊ≠§ÂÆûÁé∞ eBPF as a serviceÔºåËÆ© eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°åÂèòÂæóÊõ¥Âä†ËΩªÈáèÁ∫ß„ÄÅÂø´ÈÄü„ÄÅÁÆÄ‰æøÊòìË°åÔºõ</li>
</ul>
<p>eunomia-bpf ÊòØ <code>eBPF ÊäÄÊúØÊé¢Á¥¢ SIG</code> [3] [5] ‰∏≠ÂèëËµ∑Âπ∂Â≠µÂåñÁöÑÈ°πÁõÆÔºåÁõÆÂâç‰πüÂ∑≤ÁªèÂú® <a href="https://github.com/eunomia-bpf/eunomia-bpf">github</a> [4] ‰∏äÂºÄÊ∫ê„ÄÇeunomia-bpf ÊòØ‰∏Ä‰∏™ eBPF Á®ãÂ∫èÁöÑËΩªÈáèÁ∫ßÂºÄÂèëÂä†ËΩΩÊ°ÜÊû∂ÔºåÂåÖÂê´‰∫Ü‰∏Ä‰∏™Áî®Êà∑ÊÄÅÂä®ÊÄÅÂä†ËΩΩÊ°ÜÊû∂/ËøêË°åÊó∂Â∫ìÔºå‰ª•Âèä‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁºñËØë Wasm Âíå eBPF Â≠óËäÇÁ†ÅÁöÑÂ∑•ÂÖ∑ÈìæÂÆπÂô®„ÄÇ‰∫ãÂÆû‰∏äÔºåÂú® Wasm Ê®°Âùó‰∏≠ÁºñÂÜô eBPF ‰ª£Á†ÅÂíåÈÄöÂ∏∏ÁÜüÊÇâÁöÑ‰ΩøÁî® libbpf Ê°ÜÊû∂Êàñ Coolbpf ÂºÄÂèë eBPF Á®ãÂ∫èÁöÑÊñπÂºèÊòØÂü∫Êú¨‰∏ÄÊ†∑ÁöÑÔºåWasm ÁöÑÂ§çÊùÇÊÄß‰ºöË¢´ÈöêËóèÂú® eunomia-bpf ÁöÑÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂Â∫ì‰∏≠ÔºåÂºÄÂèëËÄÖÂèØ‰ª•‰∏ìÊ≥®‰∫é eBPF Á®ãÂ∫èÁöÑÂºÄÂèëÂíåË∞ÉËØïÔºå‰∏çÈúÄË¶Å‰∫ÜËß£ Wasm ÁöÑËÉåÊôØÁü•ËØÜÔºå‰πü‰∏çÈúÄË¶ÅÊãÖÂøÉ Wasm ÁöÑÁºñËØëÁéØÂ¢ÉÈÖçÁΩÆ„ÄÇ</p>
<h3 id="‰ΩøÁî®-wasm-Ê®°ÂùóÂàÜÂèëÂä®ÊÄÅÂä†ËΩΩ-ebpf-Á®ãÂ∫è-1"><a class="header" href="#‰ΩøÁî®-wasm-Ê®°ÂùóÂàÜÂèëÂä®ÊÄÅÂä†ËΩΩ-ebpf-Á®ãÂ∫è-1">‰ΩøÁî® Wasm Ê®°ÂùóÂàÜÂèë„ÄÅÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫è</a></h3>
<p>eunomia-bpf Â∫ìÂåÖÂê´‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑ÔºàecliÔºâÔºåÂåÖÂê´‰∫Ü‰∏Ä‰∏™Â∞èÂûãÁöÑ Wasm ËøêË°åÊó∂Ê®°ÂùóÂíå eBPF Âä®ÊÄÅË£ÖËΩΩÁöÑÂäüËÉΩÔºåÂèØ‰ª•Áõ¥Êé•‰∏ãËΩΩ‰∏ãÊù•ÂêéËøõË°å‰ΩøÁî®Ôºö</p>
<pre><code class="language-console"># download the release from https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecli
$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
$ sudo ./ecli run https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/app.wasm
2022-10-11 14:05:50 URL:https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/app.wasm [70076/70076] -&gt; &quot;/tmp/ebpm/app.wasm&quot; [1]
running and waiting for the ebpf events from perf event...
{&quot;pid&quot;:1709490,&quot;tpid&quot;:1709077,&quot;sig&quot;:0,&quot;ret&quot;:0,&quot;comm&quot;:&quot;node&quot;,&quot;sig_name&quot;:&quot;N/A&quot;}
{&quot;pid&quot;:1712603,&quot;tpid&quot;:1717412,&quot;sig&quot;:2,&quot;ret&quot;:0,&quot;comm&quot;:&quot;kworker/u4:3&quot;,&quot;sig_name&quot;:&quot;SIGINT&quot;}
{&quot;pid&quot;:1712603,&quot;tpid&quot;:1717411,&quot;sig&quot;:2,&quot;ret&quot;:0,&quot;comm&quot;:&quot;kworker/u4:3&quot;,&quot;sig_name&quot;:&quot;SIGINT&quot;}
{&quot;pid&quot;:0,&quot;tpid&quot;:847,&quot;sig&quot;:14,&quot;ret&quot;:0,&quot;comm&quot;:&quot;swapper/1&quot;,&quot;sig_name&quot;:&quot;SIGALRM&quot;}
{&quot;pid&quot;:1709490,&quot;tpid&quot;:1709077,&quot;sig&quot;:0,&quot;ret&quot;:0,&quot;comm&quot;:&quot;node&quot;,&quot;sig_name&quot;:&quot;N/A&quot;}
{&quot;pid&quot;:1709139,&quot;tpid&quot;:1709077,&quot;sig&quot;:0,&quot;ret&quot;:0,&quot;comm&quot;:&quot;node&quot;,&quot;sig_name&quot;:&quot;N/A&quot;}
{&quot;pid&quot;:1717420,&quot;tpid&quot;:1717419,&quot;sig&quot;:17,&quot;ret&quot;:0,&quot;comm&quot;:&quot;cat&quot;,&quot;sig_name&quot;:&quot;SIGCHLD&quot;}
</code></pre>
<p>ecli ‰ºöËá™Âä®‰ªéÁΩëÈ°µ‰∏ä‰∏ãËΩΩÂπ∂Âä†ËΩΩ sigsnoop/app.wasm Ëøô‰∏™ wasm Ê®°ÂùóÔºåÂÆÉÂåÖÂê´‰∫Ü‰∏Ä‰∏™ eBPF Á®ãÂ∫èÔºåÁî®‰∫éË∑üË∏™ÂÜÖÊ†∏‰∏≠ËøõÁ®ãÁöÑ‰ø°Âè∑ÂèëÈÄÅÂíåÊé•Êî∂„ÄÇËøôÈáåÊàë‰ª¨ÂèØ‰ª•ÁúãÂà∞‰∏Ä‰∏™ÁÆÄÂçïÁöÑ JSON Ê†ºÂºèÁöÑËæìÂá∫ÔºåÂåÖÂê´‰∫ÜËøõÁ®ãÁöÑ PID„ÄÅ‰ø°Âè∑ÁöÑÁ±ªÂûã„ÄÅÂèëÈÄÅËÄÖÂíåÊé•Êî∂ËÄÖÔºå‰ª•Âèä‰ø°Âè∑ÂêçÁß∞Á≠â‰ø°ÊÅØ„ÄÇÂÆÉ‰πüÂèØ‰ª•ÈôÑÂ∏¶‰∏Ä‰∫õÂëΩ‰ª§Ë°åÂèÇÊï∞Ôºå‰æãÂ¶ÇÔºö</p>
<pre><code class="language-console">$ wget https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/app.wasm
2022-10-11 14:08:07 (40.5 MB/s) - ‚Äòapp.wasm.1‚Äô saved [70076/70076]

$ sudo ./ecli run app.wasm -h
Usage: sigsnoop [-h] [-x] [-k] [-n] [-p PID] [-s SIGNAL]
Trace standard and real-time signals.


    -h, --help  show this help message and exit
    -x, --failed  failed signals only
    -k, --killed  kill only
    -p, --pid=&lt;int&gt;  target pid
    -s, --signal=&lt;int&gt;  target signal

$ sudo ./ecli run app.wasm -p 1641
running and waiting for the ebpf events from perf event...
{&quot;pid&quot;:1641,&quot;tpid&quot;:14900,&quot;sig&quot;:23,&quot;ret&quot;:0,&quot;comm&quot;:&quot;YDLive&quot;,&quot;sig_name&quot;:&quot;SIGURG&quot;}
{&quot;pid&quot;:1641,&quot;tpid&quot;:14900,&quot;sig&quot;:23,&quot;ret&quot;:0,&quot;comm&quot;:&quot;YDLive&quot;,&quot;sig_name&quot;:&quot;SIGURG&quot;}
</code></pre>
<p>Êàë‰ª¨ÂèØ‰ª•ÈÄöËøá -p ÊéßÂà∂ÂÆÉËøΩË∏™Âì™‰∏™ËøõÁ®ãÔºåÂú®ÂÜÖÊ†∏ÊÄÅ eBPF Á®ãÂ∫è‰∏≠ËøõË°å‰∏Ä‰∫õËøáÊª§ÂíåÂ§ÑÁêÜ„ÄÇÂêåÊ†∑‰πüÂèØ‰ª•‰ΩøÁî® ecli Êù•Âä®ÊÄÅÂä†ËΩΩ‰ΩøÁî®ÂÖ∂‰ªñÁöÑÂ∑•ÂÖ∑Ôºå‰æãÂ¶Ç opensnoopÔºö</p>
<pre><code class="language-console">$ sudo ./ecli run https://eunomia-bpf.github.io/eunomia-bpf/opensnoop/app.wasm
2022-10-11 14:11:56 URL:https://eunomia-bpf.github.io/eunomia-bpf/opensnoop/app.wasm [61274/61274] -&gt; &quot;/tmp/ebpm/app.wasm&quot; [1]
running and waiting for the ebpf events from perf event...
{&quot;ts&quot;:0,&quot;pid&quot;:2344,&quot;uid&quot;:0,&quot;ret&quot;:26,&quot;flags&quot;:0,&quot;comm&quot;:&quot;YDService&quot;,&quot;fname&quot;:&quot;/proc/1718823/cmdline&quot;}
{&quot;ts&quot;:0,&quot;pid&quot;:2344,&quot;uid&quot;:0,&quot;ret&quot;:26,&quot;flags&quot;:0,&quot;comm&quot;:&quot;YDService&quot;,&quot;fname&quot;:&quot;/proc/1718824/cmdline&quot;}
{&quot;ts&quot;:0,&quot;pid&quot;:2344,&quot;uid&quot;:0,&quot;ret&quot;:26,&quot;flags&quot;:0,&quot;comm&quot;:&quot;YDService&quot;,&quot;fname&quot;:&quot;/proc/self/stat&quot;}
</code></pre>
<p>opensnoop ‰ºöËøΩË∏™ËøõÁ®ãÁöÑ open() Ë∞ÉÁî®ÔºåÂç≥ÂÜÖÊ†∏‰∏≠ÊâÄÊúâÁöÑÊâìÂºÄÊñá‰ª∂Êìç‰ΩúÔºåËøôÈáåÊàë‰ª¨ÂèØ‰ª•ÁúãÂà∞ËøõÁ®ãÁöÑ PID„ÄÅUID„ÄÅËøîÂõûÂÄº„ÄÅË∞ÉÁî®Ê†áÂøó„ÄÅËøõÁ®ãÂêçÂíåÊñá‰ª∂ÂêçÁ≠â‰ø°ÊÅØ„ÄÇÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫è‰ºöË¢´ÂåÖÂê´Âú® Wasm Ê®°Âùó‰∏≠ËøõË°åÂàÜÂèëÔºåÂú®Âä†ËΩΩÁöÑÊó∂ÂÄôÈÄöËøá BTF ‰ø°ÊÅØÂíå libbpf ËøõË°åÈáçÂÆö‰ΩçÊìç‰ΩúÔºå‰ª•ÈÄÇÂ∫î‰∏çÂêåÁöÑÂÜÖÊ†∏ÁâàÊú¨„ÄÇÂêåÊó∂ÔºåÁî±‰∫éÁî®Êà∑ÊÄÅÁöÑÁõ∏ÂÖ≥Â§ÑÁêÜ‰ª£Á†ÅÂÆåÂÖ®Áî± Wasm ÁºñÂÜôÔºåÂÜÖÊ†∏ÊÄÅÁî± eBPF Êåá‰ª§ÁºñÂÜôÔºåÂõ†Ê≠§‰∏çÂèóÂÖ∑‰ΩìÊåá‰ª§ÈõÜÔºàx86„ÄÅARM Á≠âÔºâÁöÑÈôêÂà∂ÔºåÂèØ‰ª•Âú®‰∏çÂêåÁöÑÂπ≥Âè∞‰∏äËøêË°å„ÄÇ</p>
<h3 id="‰ΩøÁî®-wasm-ÂºÄÂèëÂíåÊâìÂåÖ-ebpf-Á®ãÂ∫è-1"><a class="header" href="#‰ΩøÁî®-wasm-ÂºÄÂèëÂíåÊâìÂåÖ-ebpf-Á®ãÂ∫è-1">‰ΩøÁî® Wasm ÂºÄÂèëÂíåÊâìÂåÖ eBPF Á®ãÂ∫è</a></h3>
<p>ÂêåÊ†∑Ôºå‰ª•‰∏äÊñáÊâÄËø∞ÁöÑ sigsnoop ‰∏∫‰æãÔºåË¶ÅË∑üË∏™ËøõÁ®ãÁöÑ‰ø°Âè∑ÂèëÈÄÅÂíåÊé•Êî∂ÔºåÊàë‰ª¨È¶ñÂÖàÈúÄË¶ÅÂú® sigsnoop.bpf.c ‰∏≠ÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF ‰ª£Á†ÅÔºö</p>
<pre><code class="language-c">#include &lt;vmlinux.h&gt;
#include &lt;bpf/bpf_helpers.h&gt;
#include &quot;sigsnoop.h&quot;

const volatile pid_t filtered_pid = 0;
.....

struct {
 __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);
 __uint(key_size, sizeof(__u32));
 __uint(value_size, sizeof(__u32));
} events SEC(&quot;.maps&quot;);

SEC(&quot;tracepoint/signal/signal_generate&quot;)
int sig_trace(struct trace_event_raw_signal_generate *ctx)
{
 struct event event = {};
 pid_t tpid = ctx-&gt;pid;
 int ret = ctx-&gt;errno;
 int sig = ctx-&gt;sig;
 __u64 pid_tgid;
 __u32 pid;

 ...
 pid_tgid = bpf_get_current_pid_tgid();
 pid = pid_tgid &gt;&gt; 32;
 if (filtered_pid &amp;&amp; pid != filtered_pid)
  return 0;

 event.pid = pid;
 event.tpid = tpid;
 event.sig = sig;
 event.ret = ret;
 bpf_get_current_comm(event.comm, sizeof(event.comm));
 bpf_perf_event_output(ctx, &amp;events, BPF_F_CURRENT_CPU, &amp;event, sizeof(event));
 return 0;
}

char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;
</code></pre>
<p>ËøôÈáåÊàë‰ª¨‰ΩøÁî® <code>tracepoint/signal/signal_generate</code> Ëøô‰∏™ tracepoint Êù•Âú®ÂÜÖÊ†∏‰∏≠ËøΩË∏™‰ø°Âè∑ÁöÑ‰∫ßÁîü‰∫ã‰ª∂„ÄÇÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÈÄöËøá BPF_MAP_TYPE_PERF_EVENT_ARRAY ÂæÄÁî®Êà∑ÊÄÅÂØºÂá∫‰ø°ÊÅØÔºå‰∏∫Ê≠§Êàë‰ª¨ÈúÄË¶ÅÂú® sigsnoop.h Â§¥Êñá‰ª∂Ôºå‰∏≠ÂÆö‰πâ‰∏Ä‰∏™ÂØºÂá∫‰ø°ÊÅØÁöÑÁªìÊûÑ‰ΩìÔºö</p>
<pre><code class="language-c">#ifndef __SIGSNOOP_H
#define __SIGSNOOP_H

#define TASK_COMM_LEN 16

struct event {
 unsigned int pid;
 unsigned int tpid;
 int sig;
 int ret;
 char comm[TASK_COMM_LEN];
};

#endif /* __SIGSNOOP_H */
</code></pre>
<p>ÂèØ‰ª•Áõ¥Êé•‰ΩøÁî® eunomia-bpf ÁöÑÁºñËØëÂ∑•ÂÖ∑ÈìæÂ∞ÜÂÖ∂ÁºñËØë‰∏∫ JSON Ê†ºÂºèÔºåÁîüÊàê‰∏Ä‰∏™ package.json Êñá‰ª∂ÔºåÂπ∂‰∏îÂèØ‰ª•Áõ¥Êé•‰ΩøÁî® ecli Âä†ËΩΩËøêË°åÔºö</p>
<pre><code class="language-console">$ docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest
make
  BPF      .output/client.bpf.o
  GEN-SKEL .output/client.skel.h
  CC       .output/client.o
  CC       .output/cJSON.o
  CC       .output/create_skel_json.o
  BINARY   client
  DUMP_LLVM_MEMORY_LAYOUT
  DUMP_EBPF_PROGRAM
  FIX_TYPE_INFO_IN_EBPF
  GENERATE_PACKAGE_JSON

$ sudo ./ecli run package.json
running and waiting for the ebpf events from perf event...
time pid tpid sig ret comm
14:39:39 1723835 1723834 17 0 dirname
14:39:39 1723836 1723834 17 0 chmod
14:39:39 1723838 1723837 17 0 ps
14:39:39 1723839 1723837 17 0 grep
14:39:39 1723840 1723837 17 0 grep
14:39:39 1723841 1723837 17 0 wc
</code></pre>
<p>Êàë‰ª¨ÊâÄÊúâÁöÑÁºñËØëÂ∑•ÂÖ∑ÈìæÈÉΩÂ∑≤ÁªèÊâìÂåÖÊàê‰∫Ü docker ÈïúÂÉèÁöÑÂΩ¢ÂºèÂπ∂ÂèëÂ∏ÉÂà∞‰∫Ü docker hub ‰∏äÔºåÂèØ‰ª•Áõ¥Êé•ÂºÄÁÆ±Âç≥Áî®„ÄÇÊ≠§Êó∂Âä®ÊÄÅÂä†ËΩΩËøêË°åÁöÑÂè™ÊúâÂÜÖÊ†∏ÊÄÅÁöÑ eBPF ‰ª£Á†ÅÂíå‰∏Ä‰∫õËæÖÂä©‰ø°ÊÅØÔºåÂ∏ÆÂä© eunomia-bpf Â∫ìËá™Âä®Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÂæÄÁî®Êà∑ÊÄÅ‰∏äÊä•ÁöÑ‰∫ã‰ª∂„ÄÇÂ¶ÇÊûúÊàë‰ª¨ÊÉ≥Ë¶ÅÂú®Áî®Êà∑ÊÄÅËøõË°å‰∏Ä‰∫õÂèÇÊï∞ÈÖçÁΩÆÂíåË∞ÉÊï¥Ôºå‰ª•ÂèäÊï∞ÊçÆÂ§ÑÁêÜÊµÅÁ®ãÔºåÊàë‰ª¨ÈúÄË¶ÅÂú®Áî®Êà∑ÊÄÅÁºñÂÜô‰ª£Á†ÅÔºåÂ∞ÜÂÜÖÊ†∏ÊÄÅÁöÑ eBPF ‰ª£Á†ÅÂíåÁî®Êà∑ÊÄÅÁöÑ‰ª£Á†ÅÊâìÂåÖÊàê‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ eBPF Á®ãÂ∫è„ÄÇ</p>
<p>ÂèØ‰ª•Áõ¥Êé•‰∏ÄË°åÂëΩ‰ª§ÔºåÁîüÊàê eBPF Á®ãÂ∫èÁöÑÁî®Êà∑ÊÄÅ WebAssembly ÂºÄÂèëÊ°ÜÊû∂Ôºö</p>
<pre><code class="language-console">$ docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest gen-wasm-skel
make
  GENERATE_PACKAGE_JSON
  GEN-Wasm-SKEL
$ ls
app.c eunomia-include ewasm-skel.h package.json README.md  sigsnoop.bpf.c  sigsnoop.h
</code></pre>
<p>Êàë‰ª¨Êèê‰æõÁöÑÊòØ C ËØ≠Ë®ÄÁâàÊú¨ÁöÑ Wasm ÂºÄÂèëÊ°ÜÊû∂ÔºåÂÆÉÂåÖÂê´Â¶Ç‰∏ãËøô‰∫õÊñá‰ª∂Ôºö</p>
<ul>
<li>ewasm-skel.hÔºöÁî®Êà∑ÊÄÅ WebAssembly ÂºÄÂèëÊ°ÜÊû∂ÁöÑÂ§¥Êñá‰ª∂ÔºåÂåÖÂê´‰∫ÜÈ¢ÑÁºñËØëÁöÑ eBPF Á®ãÂ∫èÂ≠óËäÇÁ†ÅÔºåÂíå eBPF Á®ãÂ∫èÊ°ÜÊû∂ËæÖÂä©‰ø°ÊÅØÔºåÁî®Êù•Âä®ÊÄÅÂä†ËΩΩÔºõ</li>
<li>eunomia-includeÔºö‰∏Ä‰∫õ header-only ÁöÑÂ∫ìÂáΩÊï∞ÂíåËæÖÂä©Êñá‰ª∂ÔºåÁî®Êù•ËæÖÂä©ÂºÄÂèëÔºõ</li>
<li>app.cÔºöÁî®Êà∑ÊÄÅ WebAssembly Á®ãÂ∫èÁöÑ‰∏ªË¶Å‰ª£Á†ÅÔºåÂåÖÂê´‰∫Ü eBPF Á®ãÂ∫èÁöÑ‰∏ªË¶ÅÈÄªËæëÔºå‰ª•Âèä eBPF Á®ãÂ∫èÁöÑÊï∞ÊçÆÂ§ÑÁêÜÊµÅÁ®ã„ÄÇ</li>
</ul>
<p>‰ª• sigsnoop ‰∏∫‰æãÔºåÁî®Êà∑ÊÄÅÂåÖÂê´‰∏Ä‰∫õÂëΩ‰ª§Ë°åËß£Êûê„ÄÅÈÖçÁΩÆ eBPF Á®ãÂ∫èÂíåÊï∞ÊçÆÂ§ÑÁêÜÁöÑ‰ª£Á†ÅÔºå‰ºöÂ∞ÜÊ†πÊçÆ signal number Â∞Ü‰ø°Âè∑‰∫ã‰ª∂ÁöÑËã±ÊñáÂêçÁß∞Ê∑ªÂä†Âà∞‰∫ã‰ª∂‰∏≠Ôºö</p>
<pre><code class="language-c">....
int main(int argc, const char** argv)
{
  struct argparse_option options[] = {
        OPT_HELP(),
        OPT_BOOLEAN('x', &quot;failed&quot;, &amp;failed_only, &quot;failed signals only&quot;, NULL, 0, 0),
        OPT_BOOLEAN('k', &quot;killed&quot;, &amp;kill_only, &quot;kill only&quot;, NULL, 0, 0),
        OPT_INTEGER('p', &quot;pid&quot;, &amp;target_pid, &quot;target pid&quot;, NULL, 0, 0),
  OPT_INTEGER('s', &quot;signal&quot;, &amp;target_signal, &quot;target signal&quot;, NULL, 0, 0),
        OPT_END(),
    };

  struct argparse argparse;
  argparse_init(&amp;argparse, options, usages, 0);
  argparse_describe(&amp;argparse, &quot;Trace standard and real-time signals.\n&quot;, &quot;&quot;);
  argc = argparse_parse(&amp;argparse, argc, argv);

  cJSON *program = cJSON_Parse(program_data);
  program = set_bpf_program_global_var(program, &quot;filtered_pid&quot;, cJSON_CreateNumber(target_pid));
  program = set_bpf_program_global_var(program, &quot;target_signal&quot;, cJSON_CreateNumber(target_signal));
  program = set_bpf_program_global_var(program, &quot;failed_only&quot;, cJSON_CreateBool(failed_only));
  return start_bpf_program(cJSON_PrintUnformatted(program));
}

int process_event(int ctx, char *e, int str_len)
{
 cJSON *json = cJSON_Parse(e);
 int sig = cJSON_GetObjectItem(json, &quot;sig&quot;)-&gt;valueint;
 const char *name = sig_name[sig];
 cJSON_AddItemToObject(json, &quot;sig_name&quot;, cJSON_CreateString(name));
 char *out = cJSON_PrintUnformatted(json);
 printf(&quot;%s\n&quot;, out);
 return 0;
}
</code></pre>
<p>ÊúÄÂêé‰ΩøÁî®ÂÆπÂô®ÈïúÂÉèÂç≥ÂèØ‰∏ÄË°åÂëΩ‰ª§ÂÆåÊàê WebAssembly/eBPF Á®ãÂ∫èÁöÑÁºñËØëÂíåÊâìÂåÖÔºå‰ΩøÁî® ecli Âç≥ÂèØ‰∏ÄÈîÆËøêË°åÔºö</p>
<pre><code class="language-console">$ docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest build-wasm
make
  GENERATE_PACKAGE_JSON
  BUILD-Wasm
build app.wasm success
$ sudo ./ecli run app.wasm -h
Usage: sigsnoop [-h] [-x] [-k] [-n] [-p PID] [-s SIGNAL]
</code></pre>
<p>Áî±‰∫éÊàë‰ª¨Âü∫‰∫é‰∏ÄÊ¨°ÁºñËØë„ÄÅÂà∞Â§ÑËøêË°åÁöÑ libbpf Ê°ÜÊû∂ÂÆåÊàêÂä†ËΩΩÂíåÂêØÂä® eBPF Á®ãÂ∫èÁöÑÊìç‰ΩúÔºåÂõ†Ê≠§ÁºñËØëÂíåËøêË°å‰∏§‰∏™Ê≠•È™§ÊòØÂÆåÂÖ®ÂàÜÁ¶ªÁöÑÔºåÂèØ‰ª•ÈÄöËøáÁΩëÁªúÊàñ‰ªªÊÑèÊñπÂºèÁõ¥Êé•ËøõË°å eBPF Á®ãÂ∫èÁöÑÂàÜÂèëÂíåÈÉ®ÁΩ≤Ôºå‰∏ç‰æùËµñ‰∫éÁâπÂÆöÂÜÖÊ†∏ÁâàÊú¨„ÄÇÂÄüÂä© WebAssembly ÁöÑËΩªÈáèÁ∫ßÁâπÊÄßÔºåeBPF Á®ãÂ∫èÁöÑÂêØÂä®ÈÄüÂ∫¶‰πüÊØîÈÄöÂ∏∏ÁöÑ‰ΩøÁî®ÈïúÂÉèÂΩ¢ÂºèÂàÜÂèëÁöÑ libbpf Á®ãÂ∫èÂø´‰∏ä‰∏çÂ∞ëÔºåÈÄöÂ∏∏Âè™ÈúÄ‰∏çÂà∞ 100 ms ÁöÑÊó∂Èó¥Âç≥ÂèØÂÆåÊàêÔºåÊØîËµ∑‰ΩøÁî® BCC ÈÉ®ÁΩ≤ÂêØÂä®Êó∂Ôºå‰ΩøÁî® LLVM„ÄÅClang ÁºñËØëËøêË°åÊ∂àËÄóÁöÑÊó∂Èó¥ÂíåÂ§ßÈáèËµÑÊ∫êÔºåÊõ¥ÊòØÊúâ‰∫ÜË¥®ÁöÑÈ£ûË∑É„ÄÇ</p>
<p>‰∏äÈù¢ÊèêÂèäÁöÑÁ§∫‰æãÁ®ãÂ∫èÁöÑÂÆåÊï¥‰ª£Á†ÅÔºåÂèØ‰ª•ÂèÇËÄÉËøôÈáå[6]„ÄÇ</p>
<h3 id="ÊºîÁ§∫ËßÜÈ¢ë-1"><a class="header" href="#ÊºîÁ§∫ËßÜÈ¢ë-1">ÊºîÁ§∫ËßÜÈ¢ë</a></h3>
<p>Êàë‰ª¨‰πüÊúâ‰∏Ä‰∏™Âú® B Á´ô‰∏äÁöÑÊºîÁ§∫ËßÜÈ¢ëÔºåÊºîÁ§∫‰∫ÜÂ¶Ç‰Ωï‰ªé bcc/libbpf-tools ‰∏≠ÁßªÊ§ç‰∏Ä‰∏™ eBPF Â∑•ÂÖ∑Á®ãÂ∫èÂà∞ eunomia-bpf ‰∏≠ÔºåÂπ∂‰∏î‰ΩøÁî® Wasm Êàñ JSON Êñá‰ª∂Êù•ÂàÜÂèë„ÄÅÂä†ËΩΩ eBPF Á®ãÂ∫èÔºö<a href="https://www.bilibili.com/video/BV1JN4y1A76k">https://www.bilibili.com/video/BV1JN4y1A76k</a></p>
<h2 id="Êàë‰ª¨ÊòØÂ¶Ç‰ΩïÂÅöÂà∞ÁöÑ"><a class="header" href="#Êàë‰ª¨ÊòØÂ¶Ç‰ΩïÂÅöÂà∞ÁöÑ">Êàë‰ª¨ÊòØÂ¶Ç‰ΩïÂÅöÂà∞ÁöÑ</a></h2>
<p><code>ecli</code> ÊòØÂü∫‰∫éÊàë‰ª¨Â∫ïÂ±ÇÁöÑ eunomia-bpf Â∫ìÂíåËøêË°åÊó∂ÂÆûÁé∞ÁöÑ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑„ÄÇÊàë‰ª¨ÁöÑÈ°πÁõÆÊû∂ÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="blog/../img/eunomia-arch.png" alt="arch" /></p>
<p><code>ecli</code> Â∑•ÂÖ∑Âü∫‰∫é <code>ewasm</code> Â∫ìÂÆûÁé∞Ôºå<code>ewasm</code> Â∫ìÂåÖÂê´‰∏Ä‰∏™ WAMR(wasm-micro-runtime) ËøêË°åÊó∂Ôºå‰ª•ÂèäÂü∫‰∫é libbpf Â∫ìÊûÑÂª∫ÁöÑ eBPF Âä®ÊÄÅË£ÖËΩΩÊ®°Âùó„ÄÇÂ§ßËá¥Êù•ËØ¥ÔºåÊàë‰ª¨Âú® <code>Wasm</code> ËøêË°åÊó∂ÂíåÁî®Êà∑ÊÄÅÁöÑ <code>libbpf</code> ‰∏≠Èó¥Â§öÂä†‰∫Ü‰∏ÄÂ±ÇÊäΩË±°Â±ÇÔºà<code>eunomia-bpf</code> Â∫ìÔºâÔºå‰ΩøÂæó‰∏ÄÊ¨°ÁºñËØë„ÄÅÂà∞Â§ÑËøêË°åÁöÑ eBPF ‰ª£Á†ÅÂèØ‰ª•‰ªé JSON ÂØπË±°‰∏≠Âä®ÊÄÅÂä†ËΩΩ„ÄÇJSON ÂØπË±°‰ºöÂú®ÁºñËØëÊó∂Ë¢´ÂåÖÂê´Âú® Wasm Ê®°Âùó‰∏≠ÔºåÂõ†Ê≠§Âú®ËøêË°åÊó∂ÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøáËß£Êûê JSON ÂØπË±°Êù•Ëé∑Âèñ eBPF Á®ãÂ∫èÁöÑ‰ø°ÊÅØÔºåÁÑ∂ÂêéÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫è„ÄÇ</p>
<p>‰ΩøÁî® Wasm Êàñ JSON ÁºñËØëÂàÜÂèë eBPF Á®ãÂ∫èÁöÑÊµÅÁ®ãÂõæÂ§ßËá¥Â¶Ç‰∏ãÔºö</p>
<p><img src="blog/../img/eunomia-bpf-flow.png" alt="flow" /></p>
<p>Â§ßËá¥Êù•ËØ¥ÔºåÊï¥‰∏™ eBPF Á®ãÂ∫èÁöÑÁºñÂÜôÂíåÂä†ËΩΩÂàÜ‰∏∫‰∏â‰∏™ÈÉ®ÂàÜÔºö</p>
<ol>
<li>Áî® eunomia-cc Â∑•ÂÖ∑ÈìæÂ∞ÜÂÜÖÊ†∏ÁöÑ eBPF ‰ª£Á†ÅÈ™®Êû∂ÂíåÂ≠óËäÇÁ†ÅÁºñËØë‰∏∫ JSON Ê†ºÂºè</li>
<li>Âú®Áî®Êà∑ÊÄÅÂºÄÂèëÁöÑÈ´òÁ∫ßËØ≠Ë®ÄÔºà‰æãÂ¶Ç C ËØ≠Ë®ÄÔºâ‰∏≠ÂµåÂÖ• JSON Êï∞ÊçÆÔºåÂπ∂Êèê‰æõ‰∏Ä‰∫õ API Áî®‰∫éÊìç‰Ωú JSON ÂΩ¢ÊÄÅÁöÑ eBPF Á®ãÂ∫èÈ™®Êû∂</li>
<li>Â∞ÜÁî®Êà∑ÊÄÅÁ®ãÂ∫èÂíå JSON Êï∞ÊçÆ‰∏ÄËµ∑ÁºñËØë‰∏∫ Wasm Â≠óËäÇÁ†ÅÂπ∂ÊâìÂåÖ‰∏∫ Wasm Ê®°ÂùóÔºåÁÑ∂ÂêéÂú®ÁõÆÊ†áÊú∫Âô®‰∏äÂä†ËΩΩÂπ∂ËøêË°å Wasm Á®ãÂ∫è</li>
<li>‰ªé Wasm Ê®°Âùó‰∏≠Âä†ËΩΩÂÜÖÂµåÁöÑ JSON Êï∞ÊçÆÔºåÁî® eunomia-bpf Â∫ìÂä®ÊÄÅË£ÖËΩΩÂíåÈÖçÁΩÆ eBPF Á®ãÂ∫èÈ™®Êû∂„ÄÇ</li>
</ol>
<p>Êàë‰ª¨ÈúÄË¶ÅÂÆåÊàêÁöÑ‰ªÖ‰ªÖÊòØÂ∞ëÈáèÁöÑ native API Âíå Wasm ËøêË°åÊó∂ÁöÑÁªëÂÆöÔºåÂπ∂‰∏îÂú® Wasm ‰ª£Á†Å‰∏≠Â§ÑÁêÜ JSON Êï∞ÊçÆ„ÄÇ‰Ω†ÂèØ‰ª•Âú®‰∏Ä‰∏™Âçï‰∏ÄÁöÑ <code>Wasm</code> Ê®°Âùó‰∏≠Êã•ÊúâÂ§ö‰∏™ <code>eBPF</code> Á®ãÂ∫è„ÄÇÂ¶ÇÊûú‰∏ç‰ΩøÁî®Êàë‰ª¨Êèê‰æõÁöÑ Wasm ËøêË°åÊó∂ÔºåÊàñËÄÖÊÉ≥Ë¶Å‰ΩøÁî®ÂÖ∂‰ªñËØ≠Ë®ÄËøõË°åÁî®Êà∑ÊÄÅÁöÑ eBPF ËæÖÂä©‰ª£Á†ÅÁöÑÂºÄÂèëÔºåÂú®Êàë‰ª¨Êèê‰æõÁöÑ <code>eunomia-bpf</code> Â∫ìÂü∫Á°Ä‰∏äÂÆåÊàê‰∏Ä‰∫õ WebaAssembly ÁöÑÁªëÂÆöÂç≥ÂèØ„ÄÇ</p>
<p>Âè¶Â§ñÔºåÂØπ‰∫é eunomia-bpf Â∫ìËÄåË®ÄÔºå‰∏çÈúÄË¶Å Wasm Ê®°ÂùóÂíåËøêË°åÊó∂ÂêåÊ†∑ÂèØ‰ª•ÂêØÂä®ÂíåÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫èÔºå‰∏çËøáÊ≠§Êó∂Âä®ÊÄÅÂä†ËΩΩËøêË°åÁöÑÂ∞±Âè™ÊòØÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫èÂ≠óËäÇÁ†Å„ÄÇ‰Ω†ÂèØ‰ª•ÊâãÂä®Êàñ‰ΩøÁî®‰ªªÊÑèËØ≠Ë®Ä‰øÆÊîπ JSON ÂØπË±°Êù•ÊéßÂà∂ eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÂèÇÊï∞ÔºåÂπ∂‰∏îÈÄöËøá eunomia-bpf Ëá™Âä®Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅ‰∏äÊä•ÁöÑËøîÂõûÊï∞ÊçÆ„ÄÇÂØπ‰∫éÂàùÂ≠¶ËÄÖËÄåË®ÄÔºåËøôÂèØËÉΩÊØî‰ΩøÁî® WebAssembly Êõ¥Âä†ÁÆÄÂçïÊñπ‰æøÔºöÂè™ÈúÄË¶ÅÁºñÂÜôÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Á®ãÂ∫èÔºåÁÑ∂Âêé‰ΩøÁî® eunomia-cc Â∑•ÂÖ∑ÈìæÂ∞ÜÂÖ∂ÁºñËØë‰∏∫ JSON Ê†ºÂºèÔºåÊúÄÂêé‰ΩøÁî® eunomia-bpf Â∫ìÂä†ËΩΩÂíåËøêË°åÂç≥ÂèØ„ÄÇÂÆåÂÖ®‰∏çÁî®ËÄÉËôë‰ªª‰ΩïÁî®Êà∑ÊÄÅÁöÑËæÖÂä©Á®ãÂ∫èÔºåÂåÖÊã¨ Wasm Âú®ÂÜÖ„ÄÇÂÖ∑‰ΩìÂèØ‰ª•ÂèÇËÄÉÊàë‰ª¨ÁöÑ‰ΩøÁî®ÊâãÂÜå[7]ÊàñÁ§∫‰æã‰ª£Á†Å[8]„ÄÇ</p>
<h2 id="Êú™Êù•ÁöÑÊñπÂêë"><a class="header" href="#Êú™Êù•ÁöÑÊñπÂêë">Êú™Êù•ÁöÑÊñπÂêë</a></h2>
<p>ÁõÆÂâç eunomia-bpf ÁöÑÂ∑•ÂÖ∑ÈìæÁöÑÂÆûÁé∞ËøòËøúËøúË∞à‰∏ç‰∏äÂÆåÂñÑÔºåÂè™ÊòØÊúâ‰∏Ä‰∏™ÂèØË°åÊÄßÈ™åËØÅÁöÑÁâàÊú¨„ÄÇÂØπ‰∫é‰∏Ä‰∏™ÂºÄÂèëÂ∑•ÂÖ∑ÈìæÊù•ËØ¥ÔºåÂÖ∑‰ΩìÁöÑ API Ê†áÂáÜÂíåÁõ∏ÂÖ≥ÁöÑÁîüÊÄÅÊòØÈùûÂ∏∏ÈáçË¶ÅÁöÑÔºåÊàë‰ª¨Â∏åÊúõÂ¶ÇÊûúÊúâÊú∫‰ºöÁöÑËØùÔºå‰πüËÆ∏ÂèØ‰ª•Âíå SIG Á§æÂå∫ÁöÑÂÖ∂‰ªñÊàêÂëò‰∏ÄËµ∑ËÆ®ËÆ∫Âπ∂ÂΩ¢Êàê‰∏Ä‰∏™ÂÖ∑‰ΩìÁöÑ API Ê†áÂáÜÔºåËÉΩÂ§üÂü∫‰∫é eBPF Âíå Wasm Á≠âÊäÄÊúØÔºåÂÖ±ÂêåÊèê‰æõ‰∏Ä‰∏™ÈÄöÁî®ÁöÑ„ÄÅË∑®Âπ≥Âè∞ÂíåÂÜÖÊ†∏ÁâàÊú¨ÁöÑÊèí‰ª∂ÁîüÊÄÅÔºå‰∏∫ÂêÑËá™ÁöÑÂ∫îÁî®Â¢ûÂä† eBPF Âíå Wasm ÁöÑË∂ÖËÉΩÂäõ„ÄÇ</p>
<p>ÁõÆÂâç eunomia-bpf Ë∑®ÂÜÖÊ†∏ÁâàÊú¨ÁöÑÂä®ÊÄÅÂä†ËΩΩÁâπÊÄßËøò‰æùËµñ‰∫éÂÜÖÊ†∏ÁöÑ BTF ‰ø°ÊÅØÔºåSIG Á§æÂå∫ÁöÑ Coolbpf È°πÁõÆ[9]Êú¨Ë∫´ËÉΩÊèê‰æõ BTF ÁöÑËá™Âä®ÁîüÊàê„ÄÅ‰ΩéÁâàÊú¨ÂÜÖÊ†∏ÁöÑÈÄÇÈÖçÂäüËÉΩÔºåÊú™Êù•‰ΩéÁâàÊú¨ÂÜÖÊ†∏ÁöÑÊîØÊåÅ‰ºöÂü∫‰∫é Coolbpf ÁöÑÁé∞ÊúâÁöÑÈÉ®ÂàÜÂÆåÊàê„ÄÇÂêåÊó∂ÔºåÊàë‰ª¨‰πü‰ºöÁªô Coolbpf ÁöÑ API ÂÆûÁé∞„ÄÅËøúÁ®ãÁºñËØëÂêéÁ´ØÊèê‰æõÁ±ª‰ºº‰∫é eunomia-bpf ÁöÑÂÜÖÊ†∏ÊÄÅÁºñËØëÂíåËøêË°åÂÆåÂÖ®ÂàÜÁ¶ªÁöÑÂäüËÉΩÔºåËÆ©‰ΩøÁî® Coolbpf API ÂºÄÂèë eBPF ÁöÑÁ®ãÂ∫èÔºåÂú®ËøúÁ®ãÁºñËØë‰∏ÄÊ¨°ËøáÂêéÂèØ‰ª•Âú®‰ªªÊÑèÂÜÖÊ†∏ÁâàÊú¨ÂíåÊû∂ÊûÑ‰∏äÁõ¥Êé•‰ΩøÁî®ÔºåÂú®ÈÉ®ÁΩ≤Êó∂Êó†ÈúÄÂÜçÊ¨°ËøûÊé•ËøúÁ®ãÊúçÂä°Âô®Ôºõ‰πüÂèØ‰ª•Â∞ÜÁºñËØëÂÆåÊàêÁöÑ eBPF Á®ãÂ∫è‰Ωú‰∏∫ Go„ÄÅPython„ÄÅRust Á≠âËØ≠Ë®ÄÁöÑÂºÄÂèëÂåÖÁõ¥Êé•‰ΩøÁî®ÔºåËÆ©ÂºÄÂèëËÄÖËÉΩËΩªÊùæËé∑Âæó eBPF Á®ãÂ∫è‰∏äÊä•ÁöÑ‰ø°ÊÅØÔºåËÄåÂÆåÂÖ®‰∏çÈúÄË¶ÅÂÜçÊ¨°ËøõË°å‰ªª‰Ωï eBPF Á®ãÂ∫èÁöÑÁºñËØëËøáÁ®ã„ÄÇ</p>
<p>SIG Á§æÂå∫Â≠µÂåñ‰∫éÈ´òÊ†°ÁöÑ Linux Microscope (LMP) È°πÁõÆ[10]‰∏≠Ôºå‰πüÂ∑≤ÁªèÊúâ‰∏Ä‰∫õÂü∫‰∫é eunomia-bpf Êèê‰æõÈÄöÁî®ÁöÑ„ÄÅËßÑËåÉÂåñ„ÄÅÂèØ‰ª•ÈöèÊó∂‰∏ãËΩΩËøêË°åÁöÑ eBPF Á®ãÂ∫èÊàñÂ∑•ÂÖ∑Â∫ìÁöÑËÆ°ÂàíÔºåÁõÆÂâçËøòÂú®ÁªßÁª≠ÂÆåÂñÑÁöÑÈò∂ÊÆµ„ÄÇ</p>
<h2 id="ÂèÇËÄÉËµÑÊñô-3"><a class="header" href="#ÂèÇËÄÉËµÑÊñô-3">ÂèÇËÄÉËµÑÊñô</a></h2>
<ol>
<li>eBPF Âíå WebAssemblyÔºöÂì™Áßç VM ‰ºöÂà∂Èú∏‰∫ëÂéüÁîüÊó∂‰ª£? <a href="https://juejin.cn/post/7043721713602789407">https://juejin.cn/post/7043721713602789407</a></li>
<li>eBPF Âíå WasmÔºöÊé¢Á¥¢ÊúçÂä°ÁΩëÊ†ºÊï∞ÊçÆÂπ≥Èù¢ÁöÑÊú™Êù•: <a href="https://cloudnative.to/blog/ebpf-wasm-service-mesh/">https://cloudnative.to/blog/ebpf-wasm-service-mesh/</a></li>
<li>eBPF ÊäÄÊúØÊé¢Á¥¢ SIG ‰∏ªÈ°µÔºö <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>eunomia-bpf Github ‰ªìÂ∫ìÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>eunomia-bpf ÈæôËú•Á§æÂå∫ÈïúÂÉè‰ªìÂ∫ìÔºö<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
<li>sigsnoop Á§∫‰æã‰ª£Á†ÅÔºö<a href="https://gitee.com/anolis/eunomia/tree/master/examples/bpftools/sigsnoop">https://gitee.com/anolis/eunomia/tree/master/examples/bpftools/sigsnoop</a></li>
<li>eunomia-bpf Áî®Êà∑ÊâãÂÜåÔºö<a href="https://openanolis.cn/sig/ebpfresearch/doc/646023027267993641">https://openanolis.cn/sig/ebpfresearch/doc/646023027267993641</a></li>
<li>Êõ¥Â§öÁ§∫‰æã‰ª£Á†ÅÔºö<a href="https://gitee.com/anolis/eunomia/tree/master/examples/bpftools/sigsnoop">https://gitee.com/anolis/eunomia/tree/master/examples/bpftools/sigsnoop</a></li>
<li>Coolbpf È°πÁõÆ‰ªãÁªçÔºö<a href="https://openanolis.cn/sig/ebpfresearch/doc/633529753894377555">https://openanolis.cn/sig/ebpfresearch/doc/633529753894377555</a></li>
<li>LMP È°πÁõÆ‰ªãÁªçÔºö<a href="https://openanolis.cn/sig/ebpfresearch/doc/633661297090877527">https://openanolis.cn/sig/ebpfresearch/doc/633661297090877527</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><p>#! https://zhuanlan.zhihu.com/p/589784489</p>
<h1 id="Â¶Ç‰ΩïÂú®-linux-ÊòæÂæÆÈïúlmpÈ°πÁõÆ‰∏≠ÂºÄÂêØ-ebpf-‰πãÊóÖ"><a class="header" href="#Â¶Ç‰ΩïÂú®-linux-ÊòæÂæÆÈïúlmpÈ°πÁõÆ‰∏≠ÂºÄÂêØ-ebpf-‰πãÊóÖ">Â¶Ç‰ΩïÂú® Linux ÊòæÂæÆÈïúÔºàLMPÔºâÈ°πÁõÆ‰∏≠ÂºÄÂêØ eBPF ‰πãÊóÖÔºü</a></h1>
<p>eBPF ‰∏∫ Linux ÂÜÖÊ†∏Êèê‰æõ‰∫ÜÂèØÊâ©Â±ïÊÄßÔºå‰ΩøÂºÄÂèë‰∫∫ÂëòËÉΩÂ§üÂØπ Linux ÂÜÖÊ†∏ËøõË°åÁºñÁ®ãÔºå‰ª•‰æøÊ†πÊçÆ‰ªñ‰ª¨ÁöÑ‰∏öÂä°ÈúÄÊ±ÇÂø´ÈÄüÊûÑÂª∫Êô∫ËÉΩÁöÑÊàñ‰∏∞ÂØåÁöÑÂäüËÉΩ„ÄÇ</p>
<p>Êàë‰ª¨ÁöÑ <a href="https://github.com/linuxkerneltravel/lmp">LMP(Linux Microscope) È°πÁõÆ</a> ÊòØ‰∏∫‰∫ÜÂÖÖÂàÜÊåñÊéò ebpf ÁöÑÂèØËÉΩÊÄßËÄåÂª∫Á´ãÁöÑÔºåÈ°πÁõÆ‰ª•ÊûÑÂª∫ eBPF Â≠¶‰π†Á§æÂå∫„ÄÅÊàê‰∏∫ eBPF Â∑•ÂÖ∑ÈõÜÊï£Âú∞„ÄÅÂ≠µÂåñ eBPF ÊÉ≥Ê≥ïÂíåÈ°πÁõÆ‰∏∫ÁõÆÊ†áÔºåÊ≠£Âú®Â§ßÂäõÂª∫ËÆæ‰∏≠„ÄÇ‰πãÂâçÊàë‰ª¨Âú® LMP ÂÖ∂‰∏≠ÁöÑ eBPF Supermarket ‰∏≠ÂåÖÂê´‰∫ÜÂ§ßÈáèÁî±‰∏™‰∫∫ÂºÄÂèëËÄÖÁºñÂÜôÁöÑ eBPF Â∑•ÂÖ∑ÔºåË¶ÜÁõñ‰∫ÜÁΩëÁªú„ÄÅÊÄßËÉΩÂàÜÊûê„ÄÅÂÆâÂÖ®Á≠âÂ§öÁßçÂäüËÉΩÔºåÊàë‰ª¨Ê≠£Âú®Â∞ùËØïÊääÂÖ∂‰∏≠ÁöÑ‰∏Ä‰∫õÁ®ãÂ∫èËøÅÁßªÂà∞ eBPF HubÔºå‰∏Ä‰∫õËßÑËåÉÂåñÁöÑ eBPF Á®ãÂ∫èÂ∫ìÔºåÂèØ‰ª•ÈöèÊó∂‰∏ãËΩΩËøêË°åÔºåÊàñÂµåÂÖ•Â§ßÂûãÂ∫îÁî®Á®ãÂ∫è‰∏≠‰Ωú‰∏∫Êèí‰ª∂‰ΩøÁî®„ÄÇ</p>
<p>Êàë‰ª¨Â∞ùËØïÂú® eBPF Hub ‰∏≠ÔºåÂü∫‰∫é eunomia-bpf ÂºÄÂèëÊ°ÜÊû∂ÂàõÂª∫Á¨¶Âêà OCI Ê†áÂáÜÁöÑ Wasm Âíå eBPF Á®ãÂ∫èÔºåÂπ∂Âà©Áî® ORAS ÁÆÄÂåñÊâ©Â±ï LMP ÁöÑ eBPF ÂàÜÂèë„ÄÅÂä†ËΩΩ„ÄÅËøêË°åËÉΩÂäõ„ÄÇ</p>
<h2 id="Âø´ÈÄü‰ΩøÁî®"><a class="header" href="#Âø´ÈÄü‰ΩøÁî®">Âø´ÈÄü‰ΩøÁî®</a></h2>
<p>Â¶ÇÊûúÊÇ®ÊÉ≥Âø´ÈÄüÂºÄÂßã eBPFÔºåÂèØ‰ª•‰ΩøÁî®Êàë‰ª¨ÂºÄÂèëÁöÑËΩªÈáèÁ∫ßÊ°ÜÊû∂‰πã‰∏äÁöÑÂëΩ‰ª§Ë°åÁ®ãÂ∫è lmp-cli„ÄÇÂΩì‰ΩøÁî®ËÑöÊú¨ÂÆâË£ÖÂ•ΩÊàë‰ª¨ÁöÑÊ°ÜÊû∂‰πãÂêéÔºåÊÇ®Âè™ÈúÄË¶Å‰∏ÄÊù°ÂëΩ‰ª§ÔºåÊó†ÈúÄ‰ªª‰ΩïÁºñËØëÔºåÂç≥ÂèØ‰Ωì‰ºöÂà∞ eBPF ÁöÑÂº∫Â§ß‰πãÂ§ÑÔºö</p>
<pre><code class="language-console">$ lmp run sigsnoop
download with curl: https://linuxkerneltravel.github.io/lmp/sigsnoop/package.json
running and waiting for the eBPF events from perf event...
time pid tpid sig ret comm
00:21:41 109955 112863 28 0 gnome-terminal-
00:21:41 109955 112862 28 0 gnome-terminal-
...
</code></pre>
<p>Â¶ÇÊûúÊÇ®‰ΩøÁî®Ëøá bcc Á≠â eBPF ÂºÄÂèëÂ∑•ÂÖ∑ÔºåÊÇ®‰∏ÄÂÆö‰ºöÊÉäÂñú‰∫é LMP ÁöÑ‰æøÊç∑ÊÄß„ÄÇLMP ‰∏≠ÂåÖÂê´‰∫ÜÂêÑÁßçÂêÑÊ†∑ÁöÑ eBPF Á®ãÂ∫èÔºåËøôÁßç‰æøÊç∑ÁöÑËøêË°åÔºåÁ¶ª‰∏çÂºÄÊàë‰ª¨Âü∫‰∫éÁöÑÂ∫ïÂ±ÇÊ°ÜÊû∂ eunomia-bpfÔºåÂÆÉÂÆåÂÖ®ÂÆûÁé∞‰∫Ü‚Äú‰∏ÄÊ¨°ÁºñËØëÔºåÂ§ÑÂ§ÑËøêË°å‚ÄùÁöÑ eBPF Ë∑®Âπ≥Âè∞ÁõÆÊ†á„ÄÇÂú® eunomia-bpf Ê°ÜÊû∂‰∏ãÔºåLMP ÂºÄÂèëÁöÑ eBPF Â∫îÁî®‰∏ç‰ªÖÂèØ‰ª•ÈÄÇÈÖç‰ªªÊÑèÊû∂ÊûÑÂíå‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨ÔºåËÄå‰∏îËøòÂÖ∑ÊúâËΩªÈáèÁ∫ß„ÄÅËâØÂ•ΩÁöÑÈöîÁ¶ªÊÄßÁ≠â‰ºòÁÇπÔºåÂèØ‰ª•‰Ωú‰∏∫Êèí‰ª∂Âà∞ÂµåÂÖ•Â§ßÂûãÂ∫îÁî®‰πã‰∏≠„ÄÇ</p>
<h2 id="eunomia-bpfÁªìÂêà-ebpf-Âíå-wasm-ÁöÑËΩªÈáèÁ∫ßÂºÄÂèëÊ°ÜÊû∂"><a class="header" href="#eunomia-bpfÁªìÂêà-ebpf-Âíå-wasm-ÁöÑËΩªÈáèÁ∫ßÂºÄÂèëÊ°ÜÊû∂">eunomia-bpfÔºöÁªìÂêà eBPF Âíå Wasm ÁöÑËΩªÈáèÁ∫ßÂºÄÂèëÊ°ÜÊû∂</a></h2>
<p>‰Ωú‰∏∫‰∏Ä‰∏™ eBPF Á®ãÂ∫èÁöÑËΩªÈáèÁ∫ßÂºÄÂèëÂä†ËΩΩÊ°ÜÊû∂Ôºåeunomia-bpf Âü∫‰∫é Wasm ËøêË°åÊó∂Âíå BTF ÊäÄÊúØÔºåÂåÖÂê´‰∫Ü‰∏Ä‰∏™Áî®Êà∑ÊÄÅÂä®ÊÄÅÂä†ËΩΩÊ°ÜÊû∂/ËøêË°åÊó∂Â∫ìÔºå‰ª•Âèä‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁºñËØë Wasm Âíå eBPF Â≠óËäÇÁ†ÅÁöÑÂ∑•ÂÖ∑ÈìæÂÆπÂô®„ÄÇ</p>
<p>Wasm ÊòØ‰∏∫‰∫Ü‰∏Ä‰∏™ÂèØÁßªÊ§çÁöÑÁõÆÊ†áËÄåËÆæËÆ°ÁöÑÔºåÂèØ‰Ωú‰∏∫ C/C+/RUST Á≠âÈ´òÁ∫ßËØ≠Ë®ÄÁöÑÁºñËØëÁõÆÊ†áÔºå‰ΩøÂÆ¢Êà∑Á´ØÂíåÊúçÂä°Âô®Â∫îÁî®Á®ãÂ∫èËÉΩÂ§üÂú® Web ‰∏äÈÉ®ÁΩ≤„ÄÇÁõÆÂâçÂ∑≤ÁªèÂèëÂ±ïÊàê‰∏∫‰∏Ä‰∏™ËΩªÈáèÁ∫ß„ÄÅÈ´òÊÄßËÉΩ„ÄÅË∑®Âπ≥Âè∞ÂíåÂ§öËØ≠ÁßçÁöÑËΩØ‰ª∂Ê≤ôÁõíÁéØÂ¢ÉÔºåË¢´ËøêÁî®‰∫é‰∫ëÂéüÁîüËΩØ‰ª∂ÁªÑ‰ª∂„ÄÇ eunomia-bpf Â∞Ü eBPF Áî®Êà∑ÊÄÅÁöÑÊâÄÊúâÊéßÂà∂ÂíåÊï∞ÊçÆÂ§ÑÁêÜÈÄªËæëÂÖ®ÈÉ®ÁßªÂà∞ Wasm ËôöÊãüÊú∫‰∏≠ÔºåÈÄöËøá Wasm module ÊâìÂåÖÂíåÂàÜÂèë eBPF Â≠óËäÇÁ†ÅÔºåÂêåÊó∂Âú® Wasm ËôöÊãüÊú∫ÂÜÖÈÉ®ÊéßÂà∂Êï¥‰∏™ eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°åÔºåÂ∞Ü‰∫åËÄÖÁöÑ‰ºòÂäøÁªìÂêà‰∫ÜËµ∑Êù•„ÄÇ</p>
<p>Âú® Wasm Ê®°Âùó‰∏≠ÁºñÂÜô eBPF ‰ª£Á†ÅÂíåÈÄöÂ∏∏ÁÜüÊÇâÁöÑ‰ΩøÁî® libbpf Ê°ÜÊû∂Êàñ Coolbpf ÂºÄÂèë eBPF Á®ãÂ∫èÁöÑÊñπÂºèÊòØÂü∫Êú¨‰∏ÄÊ†∑ÁöÑÔºåWasm ÁöÑÂ§çÊùÇÊÄß‰ºöË¢´ÈöêËóèÂú® eunomia-bpf ÁöÑÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂Â∫ì‰∏≠ÔºåÂºÄÂèëËÄÖÂèØ‰ª•‰∏ìÊ≥®‰∫é eBPF Á®ãÂ∫èÁöÑÂºÄÂèëÂíåË∞ÉËØïÔºå‰∏çÈúÄË¶Å‰∫ÜËß£ Wasm ÁöÑËÉåÊôØÁü•ËØÜÔºå‰πü‰∏çÈúÄË¶ÅÊãÖÂøÉ Wasm ÁöÑÁºñËØëÁéØÂ¢ÉÈÖçÁΩÆ„ÄÇ</p>
<p>Â§ßËá¥Êù•ËØ¥Ôºåeunomia-bpf Âú® Wasm ËøêË°åÊó∂ÂíåÁî®Êà∑ÊÄÅÁöÑ libbpf ‰∏≠Èó¥Â§öÂä†‰∫Ü‰∏ÄÂ±ÇÊäΩË±°Â±ÇÔºå‰ΩøÂæó‰∏ÄÊ¨°ÁºñËØë„ÄÅÂà∞Â§ÑËøêË°åÁöÑ eBPF ‰ª£Á†ÅÂèØ‰ª•‰ªé JSON ÂØπË±°‰∏≠Âä®ÊÄÅÂä†ËΩΩ„ÄÇJSON ÂØπË±°‰ºöÂú®ÁºñËØëÊó∂Ë¢´ÂåÖÂê´Âú® Wasm Ê®°Âùó‰∏≠ÔºåÂõ†Ê≠§Âú®ËøêË°åÊó∂ÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøáËß£Êûê JSON ÂØπË±°Êù•Ëé∑Âèñ eBPF Á®ãÂ∫èÁöÑ‰ø°ÊÅØÔºåÁÑ∂ÂêéÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫è„ÄÇÈÄöËøá Wasm module ÊâìÂåÖÂíåÂàÜÂèë eBPF Â≠óËäÇÁ†ÅÔºåÂêåÊó∂Âú® Wasm ËôöÊãüÊú∫ÂÜÖÈÉ®ÊéßÂà∂Êï¥‰∏™ eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°åÔºåeunomia-bpf Â∞±ÂèØ‰ª•Â∞Ü‰∫åËÄÖÁöÑ‰ºòÂäøÁªìÂêàËµ∑Êù•ÔºåËÆ©‰ªªÊÑè eBPF Á®ãÂ∫èËÉΩÊúâÂ¶Ç‰∏ãÁâπÊÄßÔºö</p>
<ul>
<li>ÂèØÁßªÊ§çÔºöËÆ© eBPF Â∑•ÂÖ∑ÂíåÂ∫îÁî®‰∏çÈúÄË¶ÅËøõË°åÈáçÊñ∞ÁºñËØëÂç≥ÂèØ‰ª•Ë∑®Âπ≥Âè∞ÂàÜÂèëÔºåÁúÅÂéª‰∫ÜÂ§çÊùÇÁöÑ‰∫§ÂèâÁºñËØëÊµÅÁ®ãÔºõ</li>
<li>ÈöîÁ¶ªÊÄßÔºöËÆ© eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°å„ÄÅ‰ª•ÂèäÁî®Êà∑ÊÄÅÁöÑÊï∞ÊçÆÂ§ÑÁêÜÊµÅÁ®ãÊõ¥Âä†ÂÆâÂÖ®ÂèØÈù†„ÄÇ</li>
<li>ÂåÖÁÆ°ÁêÜÔºöÂÆåÊàê eBPF Á®ãÂ∫èÊàñÂ∑•ÂÖ∑ÁöÑÂàÜÂèë„ÄÅÁÆ°ÁêÜ„ÄÅÂä†ËΩΩÁ≠âÂ∑•‰Ωú„ÄÇ</li>
<li>ÊïèÊç∑ÊÄßÔºö‰ΩøÊØè‰∏™‰∫∫ÈÉΩÂèØ‰ª•‰ΩøÁî®ÂÆòÊñπÂíåÊú™Áªè‰øÆÊîπÁöÑÂ∫îÁî®Á®ãÂ∫èÊù•Âä†ËΩΩËá™ÂÆö‰πâÊâ©Â±ïÔºå‰ªª‰Ωï eBPF Á®ãÂ∫èÁöÑÈîôËØØ‰øÆÂ§çÂíå/ÊàñÊõ¥Êñ∞ÈÉΩÂèØ‰ª•Âú®ËøêË°åÊó∂Êé®ÈÄÅÂíå/ÊàñÊµãËØïÔºåËÄå‰∏çÈúÄË¶ÅÊõ¥Êñ∞Âíå/ÊàñÈáçÊñ∞ÈÉ®ÁΩ≤‰∏Ä‰∏™Êñ∞ÁöÑ‰∫åËøõÂà∂„ÄÇ</li>
<li>ËΩªÈáèÁ∫ßÔºö‰∏é Linux ÂÆπÂô®Â∫îÁî®Áõ∏ÊØîÔºåWasm ÂæÆÊúçÂä°ÂÜ∑ÂêØÂä®ÁöÑÊó∂Èó¥ÊòØ 1%ÔºåÂèØ‰ª•ÂÆûÁé∞ eBPF as a serviceÔºåËÆ© eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°åÂèòÂæóÊõ¥Âä†ËΩªÈáèÁ∫ß„ÄÅÂø´ÈÄü„ÄÅÁÆÄ‰æøÊòìË°å„ÄÇ</li>
</ul>
<p>Êàë‰ª¨Â∑≤ÁªèÊµãËØï‰∫ÜÂú® x86„ÄÅARM Á≠â‰∏çÂêåÊû∂ÊûÑ‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨ÁöÑ Linux Á≥ªÁªü‰∏äÔºåeunomia-bpf Ê°ÜÊû∂ÈÉΩÂèØ‰ª•‰ΩøÁî®Âêå‰∏Ä‰∏™È¢ÑÁºñËØë eBPF Á®ãÂ∫è‰∫åËøõÂà∂Ôºå‰ªé‰∫ëÁ´Ø‰∏ÄË°åÂëΩ‰ª§Ëé∑ÂèñÂà∞Êú¨Âú∞‰πãÂêéËøêË°å„ÄÇ‰πãÂêé eunomia-bpf Ëøò‰ºöÊ∑ªÂä† RISC-V Á≠âÊõ¥Â§öÊû∂ÊûÑÁöÑÊîØÊåÅ„ÄÇ</p>
<h2 id="‰ΩøÁî®-lmp-cli-ÊûÑÂª∫‰∏Ä‰∏™-ebpf-È°πÁõÆ"><a class="header" href="#‰ΩøÁî®-lmp-cli-ÊûÑÂª∫‰∏Ä‰∏™-ebpf-È°πÁõÆ">‰ΩøÁî® lmp-cli ÊûÑÂª∫‰∏Ä‰∏™ eBPF È°πÁõÆ</a></h2>
<p>Â¶ÇÊûúÊÇ®ÊòØ‰∏Ä‰∏™ eBPF Â∑•ÂÖ∑ÁöÑ‰ΩøÁî®ËÄÖÔºåÊÇ®ÂèØ‰ª•Êó†ÈúÄ‰ªª‰ΩïÁºñËØëÊµÅÁ®ãÔºå‰πü‰∏çÈúÄË¶Å‰∫ÜËß£‰ªª‰Ωï eBPF Âíå Wasm ÁöÑÁõ∏ÂÖ≥Áü•ËØÜÔºå‰ΩøÁî® <code>lmp run &lt;name&gt;</code> Â∞±ÂèØ‰ª•Áõ¥Êé•ËøêË°å LMP ‰ªìÂ∫ìÁöÑÂ∞èÁ®ãÂ∫èÔºåÂÖ∂‰∏≠‰ºöË∞ÉÁî®<code>lmp pull &lt;name&gt;</code>ÂëΩ‰ª§‰ªé‰∫ëÁ´Ø‰ªéÂ∫ì‰∏≠‰∏ãËΩΩÂØπÂ∫îÁöÑÂ∞èÁ®ãÂ∫è„ÄÇ</p>
<p>Â¶ÇÊûúÊÇ®ÊòØ‰∏Ä‰∏™ eBPF Á®ãÂ∫èÁöÑÂºÄÂèëËÄÖÔºåËÆ©Êàë‰ª¨ÂºÄÂßãÂàõÂª∫„ÄÅÁºñËØëÂπ∂ËøêË°å‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁ®ãÂ∫è„ÄÇÂú®ËøôÈáåÔºåÊàë‰ª¨‰ΩøÁî®Âü∫ÁÆÄÂçïÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑ lmp-cliÔºåÊ¶ÇËø∞Â¶Ç‰Ωï‰ªéÂõõ‰∏™Ê≠•È™§ÂºÄÂßãÊûÑÂª∫„ÄÇ</p>
<h3 id="1-ÂáÜÂ§á‰Ω†ÁöÑÁéØÂ¢É"><a class="header" href="#1-ÂáÜÂ§á‰Ω†ÁöÑÁéØÂ¢É"><strong>1. ÂáÜÂ§á‰Ω†ÁöÑÁéØÂ¢É</strong></a></h3>
<p>eBPF Êú¨Ë∫´ÊòØ‰∏ÄÁßç Linux ÂÜÖÊ†∏ÊäÄÊúØÔºåÂõ†Ê≠§‰ªª‰ΩïÂÆûÈôÖÁöÑ BPF Á®ãÂ∫èÈÉΩÂøÖÈ°ªÂú® Linux ÂÜÖÊ†∏‰∏≠ËøêË°å„ÄÇÊàëÂª∫ËÆÆÊÇ®‰ªéÂÜÖÊ†∏ 5.4 ÊàñÊõ¥Êñ∞ÁöÑÁâàÊú¨ÂºÄÂßã„ÄÇ‰ªé SSH ÁªàÁ´ØÔºåÊ£ÄÊü•ÂÜÖÊ†∏ÁâàÊú¨ÔºåÂπ∂Á°ÆËÆ§ÊÇ®Â∑≤ÁªèÂêØÁî®‰∫Ü CONFIG_DEBUG_INFO_BTFÔºö</p>
<pre><code class="language-bash">uname -r
cat /boot/config-$(uname -r) | grep CONFIG_DEBUG_INFO_BTF
</code></pre>
<p>‰Ω†‰ºöÁúãÂà∞Á±ª‰ººËøôÊ†∑ÁöÑËæìÂá∫Ôºö</p>
<pre><code class="language-console">$ uname -r
5.15.0-48-generic

$ cat /boot/config-$(uname -r) | grep CONFIG_DEBUG_INFO_BTF
CONFIG_DEBUG_INFO_BTF=y
CONFIG_DEBUG_INFO_BTF_MODULES=y
</code></pre>
<p>ÂÆâË£ÖÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑ lmp-cliÔºö</p>
<pre><code class="language-bash">curl https://github.com/GorilaMond/lmp_cli/releases/download/lmp/install.sh | sh
</code></pre>
<h3 id="2-ÂàõÂª∫È°πÁõÆÁöÑÂÜÖÊ†∏ÈÉ®ÂàÜ"><a class="header" href="#2-ÂàõÂª∫È°πÁõÆÁöÑÂÜÖÊ†∏ÈÉ®ÂàÜ"><strong>2. ÂàõÂª∫</strong>È°πÁõÆÁöÑÂÜÖÊ†∏ÈÉ®ÂàÜ</a></h3>
<p>‰ΩøÁî®<code>lmp init</code>ÂàõÂª∫‰∏Ä‰∏™È°πÁõÆÊ®°ÊùøÔºåÊù•ÂàùÂßãÂåñ‰Ω†ÁöÑÂÜÖÊ†∏Á®ãÂ∫èÔºåÂø´ÈÄüÂú∞ÊäïÂÖ•Âà∞‰ª£Á†ÅÁöÑÁºñÂÜô‰∏≠Ôºö</p>
<pre><code class="language-bash">lmp init hello
</code></pre>
<p>ÊàêÂäüÂàõÂª∫È°πÁõÆÂêéÔºåÊÇ®Â∞ÜÁúãÂà∞Â¶Ç‰∏ãÁ±ª‰ººÁöÑËæìÂá∫Ôºö</p>
<pre><code class="language-console">$ lmp init hello
Cloning into 'ebpm-template'...
</code></pre>
<p>ÂÆÉÂÆûÈôÖ‰∏äÂàõÂª∫‰∫Ü‰∏Ä‰∏™È°πÁõÆÂêçÂØπÂ∫îÁöÑÊñá‰ª∂Â§πÔºåÈáåÈù¢ÊúâËøô‰∫õÊñá‰ª∂Ôºö</p>
<pre><code class="language-console">$ cd hello/
$ ll
...
-rw-rw-r--  1 a a 2910 10Êúà 17 23:18 bootstrap.bpf.c
-rw-rw-r--  1 a a  392 10Êúà 17 23:18 bootstrap.h
-rw-rw-r--  1 a a  221 10Êúà 17 23:18 config.json
drwxrwxr-x  8 a a 4096 10Êúà 17 23:18 .git/
drwxrwxr-x  3 a a 4096 10Êúà 17 23:18 .github/
-rw-rw-r--  1 a a   21 10Êúà 17 23:18 .gitignore
-rw-rw-r--  1 a a 2400 10Êúà 17 23:18 README.md
</code></pre>
<p>ÂÜÖÊ†∏Á®ãÂ∫èÊ®°Êùø bootstrap.bpf.c ‰∏≠ÈªòËÆ§ÁöÑË∑üË∏™ÁÇπ‰∏∫ <code>tp/sched/sched_process_exec</code>Âíå<code>tp/sched/sched_process_exit</code>ÔºåÁî®Êù•Ë∑üË∏™Êñ∞Á®ãÂ∫èÁöÑÊâßË°åÂíåÈÄÄÂá∫ÔºåËøôÈáå‰∏çÂÅö‰øÆÊîπ„ÄÇ</p>
<p>ÊûÑÂª∫ÂÜÖÊ†∏È°πÁõÆÔºåÂ¶Ç‰∏ãÊâÄÁ§∫„ÄÇ‰øùÂ≠òÊÇ®ÁöÑÊõ¥ÊîπÔºå‰ΩøÁî® <code>sudo lmp build</code> ÊûÑÂª∫ÂÜÖÊ†∏Á®ãÂ∫èÔºåËøô‰ºöÂàõÂª∫‰∏Ä‰∏™Âêç‰∏∫ package.json ÁöÑÂØπË±°Êñá‰ª∂„ÄÇ</p>
<pre><code class="language-console">$ sudo lmp build
make
  ...
  BINARY   client
  DUMP_LLVM_MEMORY_LAYOUT
  DUMP_EBPF_PROGRAM
  FIX_TYPE_INFO_IN_EBPF
  GENERATE_PACKAGE_JSON
</code></pre>
<h3 id="3-ËøêË°åÂÜÖÊ†∏Á®ãÂ∫è"><a class="header" href="#3-ËøêË°åÂÜÖÊ†∏Á®ãÂ∫è"><strong>3. ËøêË°å</strong>ÂÜÖÊ†∏Á®ãÂ∫è</a></h3>
<p>ÂèØ‰ª•‰ΩøÁî®<code>lmp run package.json</code>ËøêË°åÂÜÖÊ†∏Á®ãÂ∫èÔºåÊ≤°ÊúâÁî®Êà∑Á´ØÁ®ãÂ∫èÂØπÊï∞ÊçÆÁöÑÂ§ÑÁêÜÁöÑÊÉÖÂÜµ‰∏ãÔºåËØ•Ê°ÜÊû∂‰∏ãÂÜÖÊ†∏Á®ãÂ∫èÂ∞Ü‰ºöËæìÂá∫ÊâÄÊúâË¢´ output ÁöÑÊï∞ÊçÆÔºö</p>
<pre><code class="language-console">$ sudo lmp run ./package.json
running and waiting for the ebpf events from ring buffer...
time pid ppid exit_code duration_ns comm filename exit_event
</code></pre>
<p>‰∏ÄÂºÄÂßãÊÇ®‰∏ç‰ºöÁúãÂà∞‰ªª‰ΩïÊï∞ÊçÆÔºåÂè™ÊúâÂΩìÂÜÖÊ†∏ÁöÑË∑üË∏™ÁÇπË¢´Ëß¶ÂèëÊó∂ÔºåËøôÈáåÊòØÊñ∞ÁöÑËøõÁ®ãË¢´ÂàõÂª∫ÊàñÈÄÄÂá∫Êó∂ÔºåÊâç‰ºöËæìÂá∫Êï∞ÊçÆ„ÄÇËøôÈáåÊñ∞Âª∫‰∫Ü‰∏Ä‰∏™ËôöÊãüÁªàÁ´ØÔºåËæìÂá∫‰∫ÜÂ¶Ç‰∏ãÊï∞ÊçÆÔºö</p>
<pre><code class="language-console">23:31:31 111788 109955 0 0 bash /bin/bash 0
23:31:31 111790 111788 0 0 lesspipe /usr/bin/lesspipe 0
...
</code></pre>
<h3 id="4-Ê∑ªÂä†Áî®Êà∑ÊÄÅÁ®ãÂ∫è"><a class="header" href="#4-Ê∑ªÂä†Áî®Êà∑ÊÄÅÁ®ãÂ∫è"><strong>4. Ê∑ªÂä†</strong>Áî®Êà∑ÊÄÅÁ®ãÂ∫è</a></h3>
<p>Êàë‰ª¨Êèê‰æõÁöÑÊòØ demo ÊòØ C ËØ≠Ë®ÄÁâàÊú¨ÁöÑ Wasm ÂºÄÂèëÊ°ÜÊû∂ÔºåÂú®ÊûÑÂª∫Â•ΩÁöÑÂÜÖÊ†∏È°πÁõÆÊñá‰ª∂Â§πÂÜÖÔºå‰ΩøÁî® <code>sudo lmp gen-wasm-skel</code> ÁîüÊàê‰∏Ä‰∏™ Wasm Áî®Êà∑ÊÄÅÈ°πÁõÆÊ®°ÊùøÔºåapp.c„ÄÅeunomia-include„ÄÅewasm-skel.h Ëøô‰∫õÊñá‰ª∂‰ºöË¢´ÁîüÊàê„ÄÇewasm-skel.h ÊòØË¢´ÊâìÂåÖ‰∏∫Â§¥Êñá‰ª∂ÁöÑÂÜÖÊ†∏Á®ãÂ∫èÔºåapp.c ÊòØÁî®Êà∑ÊÄÅÁ®ãÂ∫èÁöÑÊ®°ÊùøÊñá‰ª∂ÔºåÊàë‰ª¨ÂèØ‰ª•‰øÆÊîπÂÆÉÊù•ËøõË°åËá™ÂÆö‰πâÁöÑÊï∞ÊçÆÂ§ÑÁêÜÔºåËøôÈáå‰∏çÂÅö‰øÆÊîπ„ÄÇ</p>
<pre><code class="language-console">$ sudo lmp gen-wasm-skel
make
  BPF      .output/client.bpf.o
...
</code></pre>
<p>‰ΩøÁî®<code>sudo lmp build-wasm</code>ÊûÑÂª∫Áî®Êà∑ÊÄÅÁ®ãÂ∫èÔºåÁîüÊàê app.wasm Êñá‰ª∂</p>
<pre><code class="language-console">$ sudo lmp build-wasm
make
  BPF      .output/client.bpf.o
...
</code></pre>
<p>‰ΩøÁî®<code>lmp run app.wasm</code>ËøêË°åÁî®Êà∑ÊÄÅÁ®ãÂ∫èÔºåjson Ê†ºÂºèÁöÑËæìÂá∫‰∏∫ÈÄöÁî®ÁöÑÊï∞ÊçÆÂ§ÑÁêÜÂÅöÂ•Ω‰∫ÜÂáÜÂ§áÔºö</p>
<pre><code class="language-console">$ lmp run app.wasm
running and waiting for the ebpf events from ring buffer...
{&quot;pid&quot;:112665,&quot;ppid&quot;:109955,&quot;exit_code&quot;:0,&quot;duration_ns&quot;:0,&quot;comm&quot;:&quot;bash&quot;,&quot;filename&quot;:&quot;/bin/bash&quot;,&quot;exit_event&quot;:0}
{&quot;pid&quot;:112667,&quot;ppid&quot;:112665,&quot;exit_code&quot;:0,&quot;duration_ns&quot;:0,&quot;comm&quot;:&quot;lesspipe&quot;,&quot;filename&quot;:&quot;/usr/bin/lesspipe&quot;,&quot;exit_event&quot;:0}
{&quot;pid&quot;:112668,&quot;ppid&quot;:112667,&quot;exit_code&quot;:0,&quot;duration_ns&quot;:0,&quot;comm&quot;:&quot;basename&quot;,&quot;filename&quot;:&quot;/usr/bin/basename&quot;,&quot;exit_event&quot;:0}
...
</code></pre>
<h2 id="Âè¶‰∏Ä‰∏™‰æãÂ≠ê‰ΩøÁî®-ebpf-ÊâìÂç∞ËøõÁ®ãÂÜÖÂ≠ò‰ΩøÁî®Áä∂ÂÜµ"><a class="header" href="#Âè¶‰∏Ä‰∏™‰æãÂ≠ê‰ΩøÁî®-ebpf-ÊâìÂç∞ËøõÁ®ãÂÜÖÂ≠ò‰ΩøÁî®Áä∂ÂÜµ">Âè¶‰∏Ä‰∏™‰æãÂ≠êÔºö‰ΩøÁî® eBPF ÊâìÂç∞ËøõÁ®ãÂÜÖÂ≠ò‰ΩøÁî®Áä∂ÂÜµ</a></h2>
<p>ÂèØ‰ª•Â∞Ü bootstrap.bpf.c ÈáçÂëΩÂêç‰∏∫ procstat.bpf.cÔºåÂ∞Ü bootstrap.h ÈáçÂëΩÂêç‰∏∫ procstat.hÔºåÁÑ∂ÂêéÁºñËØëËøêË°å„ÄÇÂØπÂ∫îÁöÑÊ∫ê‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<p>procstat.bpf.c</p>
<pre><code class="language-c">#include &quot;vmlinux.h&quot;
#include &lt;bpf/bpf_helpers.h&gt;
#include &lt;bpf/bpf_tracing.h&gt;
#include &lt;bpf/bpf_core_read.h&gt;
#include &quot;procstat.h&quot;

char LICENSE[] SEC(&quot;license&quot;) = &quot;Dual BSD/GPL&quot;;

struct {
 __uint(type, BPF_MAP_TYPE_RINGBUF);
 __uint(max_entries, 256 * 1024);
} rb SEC(&quot;.maps&quot;);


SEC(&quot;kprobe/finish_task_switch&quot;)
int BPF_KPROBE(finish_task_switch, struct task_struct *prev)
{
 struct event *e;
 struct mm_rss_stat rss = {};
 struct mm_struct *mms;
 long long *t;

 e = bpf_ringbuf_reserve(&amp;rb, sizeof(*e), 0);
 if (!e)
  return 0;

 e-&gt;pid = BPF_CORE_READ(prev, pid);
 e-&gt;vsize = BPF_CORE_READ(prev, mm, total_vm);
 e-&gt;Vdata = BPF_CORE_READ(prev, mm, data_vm);
 e-&gt;Vstk = BPF_CORE_READ(prev, mm, stack_vm);
 e-&gt;nvcsw = BPF_CORE_READ(prev, nvcsw);
 e-&gt;nivcsw = BPF_CORE_READ(prev, nivcsw);

 rss = BPF_CORE_READ(prev, mm, rss_stat);
 t = (long long *)(rss.count);
 e-&gt;rssfile = *t;
 e-&gt;rssanon = *(t + 1);
 e-&gt;vswap = *(t + 2);
 e-&gt;rssshmem = *(t + 3);
 e-&gt;size = *t + *(t + 1) + *(t + 3);

 bpf_ringbuf_submit(e, 0);
 return 0;
}
</code></pre>
<p>proc.h</p>
<pre><code class="language-c">#ifndef __BOOTSTRAP_H
#define __BOOTSTRAP_H

#define TASK_COMM_LEN 16
#define MAX_FILENAME_LEN 127

struct event {
/*ËøõÁ®ãÂÜÖÂ≠òÁä∂ÊÄÅÊä•Âëä*/
    pid_t pid;
    long nvcsw;
    long nivcsw;
    long vsize;              //ËôöÊãüÂÜÖÂ≠ò
    long size;               //Áâ©ÁêÜÂÜÖÂ≠ò
    long long rssanon;       //ÂåøÂêçÈ°µÈù¢
    long long rssfile;       //Êñá‰ª∂È°µÈù¢
    long long rssshmem;      //ÂÖ±‰∫´È°µÈù¢
    long long vswap;         //‰∫§Êç¢È°µÈù¢
    long long Hpages;        //hugetlbPages
    long Vdata;              //Private data segments
    long Vstk;               //User stack
    long long VPTE;
};
#endif /* __BOOTSTRAP_H */
</code></pre>
<p>ÂÖ∑‰ΩìÁöÑ‰∏äÊä•‰∫ã‰ª∂‰ø°ÊÅØÂú® event ÁªìÊûÑ‰Ωì‰∏≠ÂÆö‰πâÔºö</p>
<div class="table-wrapper"><table><thead><tr><th>ÂèÇÊï∞</th><th>Âê´‰πâ</th></tr></thead><tbody>
<tr><td>vsize</td><td>ËøõÁ®ã‰ΩøÁî®ÁöÑËôöÊãüÂÜÖÂ≠ò</td></tr>
<tr><td>size</td><td>ËøõÁ®ã‰ΩøÁî®ÁöÑÊúÄÂ§ßÁâ©ÁêÜÂÜÖÂ≠ò</td></tr>
<tr><td>rssanon</td><td>ËøõÁ®ã‰ΩøÁî®ÁöÑÂåøÂêçÈ°µÈù¢</td></tr>
<tr><td>rssfile</td><td>ËøõÁ®ã‰ΩøÁî®ÁöÑÊñá‰ª∂Êò†Â∞ÑÈ°µÈù¢</td></tr>
<tr><td>rssshmem</td><td>ËøõÁ®ã‰ΩøÁî®ÁöÑÂÖ±‰∫´ÂÜÖÂ≠òÈ°µÈù¢</td></tr>
<tr><td>vswap</td><td>ËøõÁ®ã‰ΩøÁî®ÁöÑ‰∫§Êç¢ÂàÜÂå∫Â§ßÂ∞è</td></tr>
<tr><td>vdata</td><td>ËøõÁ®ã‰ΩøÁî®ÁöÑÁßÅÊúâÊï∞ÊçÆÊÆµÂ§ßÂ∞è</td></tr>
<tr><td>vpte</td><td>ËøõÁ®ãÈ°µË°®Â§ßÂ∞è</td></tr>
<tr><td>vstk</td><td>ËøõÁ®ãÁî®Êà∑Ê†àÂ§ßÂ∞è</td></tr>
</tbody></table>
</div>
<p>ÊåÇËΩΩÁÇπ‰∏éÊåÇËΩΩÂéüÂõ†ÂàÜÊûêÔºö</p>
<ul>
<li>È¶ñÂÖàÔºåËé∑ÂèñËøõÁ®ãÁ∫ßÂà´ÂÜÖÂ≠ò‰ΩøÁî®‰ø°ÊÅØÈúÄË¶ÅËé∑ÂèñÂà∞ËøõÁ®ãÁöÑ task_struct ÁªìÊûÑ‰ΩìÔºåÂÖ∂‰∏≠Âú® mm_struct ÊàêÂëò‰∏≠Â≠òÂú®‰∏Ä‰∏™‰øùÂ≠òËøõÁ®ãÂΩìÂâçÂÜÖÂ≠ò‰ΩøÁî®Áä∂ÊÄÅÁöÑÊï∞ÁªÑÁªìÊûÑÔºåÂõ†Ê≠§ÊúâÂÖ≥ËøõÁ®ãÁöÑÂ§ßÈÉ®ÂàÜÂÜÖÂ≠ò‰ΩøÁî®‰ø°ÊÅØÈÉΩÂèØ‰ª•ÈÄöËøáËøô‰∏™Êï∞ÁªÑËé∑Âæó„ÄÇ</li>
<li>ÂÖ∂Ê¨°ÔºåÈúÄË¶ÅÊ≥®ÊÑèÂáΩÊï∞ÁöÑÊèíÂÖ•ÁÇπÔºåÊèíÂÖ•ÁÇπÁöÑÈÄâÂèñÂÖ≥Á≥ªÂà∞Êï∞ÊçÆÂáÜÁ°ÆÊÄßÊòØÂê¶ÂæóÂà∞‰øùËØÅÔºåËÄåÂú®ËøõÁ®ãÁöÑÂÜÖÂ≠òÁî≥ËØ∑ÔºåÈáäÊîæÔºåËßÑÊï¥Á≠â‰ª£Á†ÅË∑ØÂæÑ‰∏äÈÉΩÂ≠òÂú®È°µÈù¢Áä∂ÊÄÅÊîπÂèòÔºå‰ΩÜÊòØÊï∞Èáè‰ø°ÊÅØËøòÊ≤°ÊúâÊõ¥Êñ∞ÁöÑÁõ∏ÂÖ≥ÁªìÊûÑ‰∏≠ÁöÑÊÉÖÂÜµÔºåÂ¶ÇÊûúÊèíÂÖ•ÁÇπËøô‰∏§ËÄÖ‰∏≠Èó¥ÔºåÊï∞ÊçÆÂ∞±‰ºöÂíåÂÆûÈôÖÊÉÖÂÜµÂ≠òÂú®Â∑ÆÂºÇÔºåÊâÄÊúâÂú®Á°Æ‰øùÂèØ‰ª•Ëé∑ÂèñÂà∞ËøõÁ®ã PCB ÁöÑÂâçÊèê‰∏ãÔºåÈÄâÊã©Âú®ËøõÁ®ãË∞ÉÂ∫¶‰ª£Á†ÅË∑ØÂæÑ‰∏äËÄÉËôë„ÄÇËÄå finish_task_switch ÂáΩÊï∞ÊòØÊñ∞‰∏Ä‰∏™ËøõÁ®ãÁ¨¨‰∏Ä‰∏™ÊâßË°åÁöÑÂáΩÊï∞ÔºåÂÅöÁöÑ‰∫ãÂç¥ÊòØÁªô‰∏ä‰∏Ä‰∏™Ë¢´Ë∞ÉÂ∫¶Âá∫ÂéªÁöÑËøõÁ®ãÂÅöÊî∂Â∞æÂ∑•‰ΩúÔºåÊâÄ‰ª•Ëøô‰∏™ÂáΩÊï∞ÁöÑÂèÇÊï∞ÊòØ‰∏ä‰∏Ä‰∏™ËøõÁ®ãÁöÑ PCBÔºå‰ªéËøôÂùóËé∑Âæó‰∏ä‰∏Ä‰∏™ËøõÁ®ãÁöÑÂÜÖÂ≠ò‰ø°ÊÅØÂ∞±ÂèØ‰ª•Á°Æ‰øùÂú®ÂÆÉÊ≤°ÊúâÂÜçÊ¨°Ë¢´Ë∞ÉÂ∫¶‰∏ä CPU ÊâßË°åÁöÑËøôÊÆµÊó∂Èó¥ÂÜÖÁöÑÂÜÖÂ≠òÊï∞ÊçÆÁ®≥ÂÆöÊÄß„ÄÇ</li>
<li>Âõ†Ê≠§ÊúÄÂêéÈÄâÊã©Â∞ÜÁ®ãÂ∫èÊåÇËΩΩÂà∞ finish_task_switch ÂáΩÊï∞‰∏ä„ÄÇÊï∞ÊçÆÊù•Ê∫êÊúâ‰∏§ÈÉ®ÂàÜÔºå‰∏Ä‰∏™ÊòØ mm_struc ÁªìÊûÑÊú¨Ë∫´Â≠òÂú®ÁöÑÁä∂ÊÄÅ‰ø°ÊÅØÔºåÂè¶‰∏Ä‰∏™ÊòØÂú® mm_rss_stat ÁªìÊûÑ‰∏≠„ÄÇ</li>
</ul>
<p>‰πüÂèØ‰ª•Âú® bolipi ÁöÑÂπ≥Âè∞‰∏≠Âú®Á∫øÁºñËØëÔºåÂú®Á∫ø‰ΩìÈ™åËøêË°å eBPF Á®ãÂ∫èÔºö<a href="https://bolipi.com/ebpf/home/online">https://bolipi.com/ebpf/home/online</a></p>
<p>ÂÆåÊï¥ÁöÑ‰ª£Á†Å„ÄÅÊñáÊ°£ÂíåËøêË°åÁªìÊûúÂèØ‰ª•Âú® LMP ‰∏≠ eBPF_Supermarket Â§ÑÊâæÂà∞Ôºö<a href="https://github.com/linuxkerneltravel/lmp/tree/develop/eBPF_Supermarket/Memory_Subsystem/memstat/procstat">eBPF_Supermarket/Memory_Subsystem/memstat/procstat</a></p>
<h2 id="Áõ∏ÂÖ≥ËÉåÊôØ"><a class="header" href="#Áõ∏ÂÖ≥ËÉåÊôØ">Áõ∏ÂÖ≥ËÉåÊôØ</a></h2>
<p>LMP È°πÁõÆÁöÑÊàêÁ´ãÂàùË°∑ÊòØÔºö</p>
<ul>
<li>Èù¢Âêë eBPF ÂàùÂ≠¶ËÄÖÂíåÁà±Â•ΩËÄÖÔºåÊèê‰æõ eBPF Â≠¶‰π†ËµÑÊñô„ÄÅÁ®ãÂ∫è/È°πÁõÆÊ°à‰æãÔºåÊûÑÂª∫ eBPF Â≠¶‰π†Á§æÂå∫</li>
<li>Êàê‰∏∫ eBPF Â∑•ÂÖ∑ÈõÜÊï£Âú∞ÔºåÊàë‰ª¨Áõ∏‰ø°ÊØè‰∏Ä‰Ωç eBPF ÂàùÂ≠¶ËÄÖÂíåÁà±Â•ΩËÄÖÈÉΩÊúâÊó†ÈôêÁöÑÂàõÈÄ†Âäõ</li>
<li>Â≠µÂåñ eBPF ÊÉ≥Ê≥ï„ÄÅÁõ∏ÂÖ≥Â∑•ÂÖ∑„ÄÅÈ°πÁõÆ</li>
</ul>
<p>LMP ÁõÆÂâçÂàÜ‰∏∫Âõõ‰∏™Â≠êÈ°πÁõÆÔºö</p>
<ul>
<li>eBPF_Supermarket ‰∏≠ÂåÖÂê´‰∫ÜÂ§ßÈáèÁî±‰∏™‰∫∫ÂºÄÂèëËÄÖÁºñÂÜôÁöÑ eBPF Â∑•ÂÖ∑ÔºåË¶ÜÁõñ‰∫ÜÁΩëÁªú„ÄÅÊÄßËÉΩÂàÜÊûê„ÄÅÂÆâÂÖ®Á≠âÂ§öÁßçÂäüËÉΩÔºõ</li>
<li>eBPF_Hub ÊòØËßÑËåÉÂåñÁöÑ eBPF Á®ãÂ∫èÂ∫ìÔºåÂèØ‰ª•ÈöèÊó∂‰∏ãËΩΩËøêË°åÔºõ</li>
<li>eBPF_Visualization ÊòØ‰∏∫ eBPF Á®ãÂ∫èÁÆ°ÁêÜËÄåÂºÄÂèëÁöÑ web ÁÆ°ÁêÜÁ≥ªÁªüÔºåËÅöÁÑ¶ eBPF Êï∞ÊçÆÂèØËßÜÂåñÂíåÂÜÖÊ†∏ÂèØËßÜÂåñÔºõ</li>
<li>eBPF_Documentation ‰∏∫Á§æÂå∫Êî∂ÈõÜ„ÄÅÊ¢≥ÁêÜÂíåÂéüÂàõÁöÑ eBPF Áõ∏ÂÖ≥ËµÑÊñôÂíåÊñáÊ°£„ÄÇ</li>
</ul>
<p>ÂΩìÂâç LMP È°πÁõÆ‰πüÂ≠òÂú®‰∏Ä‰∫õÈóÆÈ¢òÔºå‰æãÂ¶ÇÂØπ‰∫é eBPF Â∑•ÂÖ∑ÁöÑÂºÄÂèëËÄÖÔºåÂ≠òÂú®ÈùûÂ∏∏Â§öËÄå‰∏îÂ§çÊùÇÁöÑÁî®Êà∑ÊÄÅÂèØËßÜÂåñ„ÄÅÂ±ïÁ§∫ÊñπÊ°àÔºåÊúâËÆ∏Â§öÂ•óÁ≥ªÁªüÊèê‰æõÂèØËßÜÂåñÁöÑÂÆûÁé∞Âπ∂‰∏îÊúâÂ§öÁßçËØ≠Ë®ÄÊ∑∑ÂêàÔºåÁº∫‰πèÂ±ïÁ§∫Ê†áÂáÜ„ÄÅ‰πüÈöæ‰ª•ËøõË°åÂèØËßÜÂåñÁöÑÊï¥ÂêàÁ≠â„ÄÇÂõ†Ê≠§ÔºåÊàë‰ª¨Â∏åÊúõÂ∞ùËØïÂÄüÂä© eunomia-bpf Êèê‰æõÁöÑÁ¨¶Âêà OCI Ê†áÂáÜÁöÑ Wasm Âíå eBPF Á®ãÂ∫èÔºåÊèê‰æõÊ†áÂáÜÂåñ„ÄÅÈ´òÂèØÊâ©Â±ïÊÄßÁöÑÂü∫‰∫é eBPF ÁöÑÂèØËßÜÂåñ„ÄÅÊï∞ÊçÆÂ±ïÁ§∫„ÄÅÂàÜÊûêÂπ≥Âè∞ÔºåÂà©Áî® ORAS ÁÆÄÂåñÊâ©Â±ï eBPF ÁöÑÂàÜÂèë„ÄÅÂä†ËΩΩ„ÄÅËøêË°åËÉΩÂäõÔºå‰∏∫ eBPF Â∑•ÂÖ∑ÁöÑÂºÄÂèëËÄÖÂíå‰ΩøÁî®ËÄÖÊèê‰æõÊõ¥Âä†ÁÆÄÂçï„ÄÅÈ´òÊïàÁöÑ‰ΩìÈ™å„ÄÇ</p>
<h3 id="webassembly"><a class="header" href="#webassembly">WebAssembly</a></h3>
<p>WebAssembly ÊòØ‰∏ÄÁßçÊñ∞ÁöÑÁºñÁ†ÅÊñπÂºèÔºåÂèØ‰ª•Âú®Áé∞‰ª£ÁöÑÁΩëÁªúÊµèËßàÂô®‰∏≠ËøêË°å Ôºç ÂÆÉÊòØ‰∏ÄÁßç‰ΩéÁ∫ßÁöÑÁ±ªÊ±áÁºñËØ≠Ë®ÄÔºåÂÖ∑ÊúâÁ¥ßÂáëÁöÑ‰∫åËøõÂà∂Ê†ºÂºèÔºåÂèØ‰ª•Êé•ËøëÂéüÁîüÁöÑÊÄßËÉΩËøêË°åÔºåÂπ∂‰∏∫ËØ∏Â¶Ç c\c++ Á≠âËØ≠Ë®ÄÊèê‰æõ‰∏Ä‰∏™ÁºñËØëÁõÆÊ†áÔºå‰ª•‰æøÂÆÉ‰ª¨ÂèØ‰ª•Âú® Web ‰∏äËøêË°å„ÄÇÂÆÉ‰πüË¢´ËÆæËÆ°‰∏∫ÂèØ‰ª•‰∏é JavaScript ÂÖ±Â≠òÔºåÂÖÅËÆ∏‰∏§ËÄÖ‰∏ÄËµ∑Â∑•‰Ωú„ÄÇËÄå‰∏îÔºåÊõ¥Ê£íÁöÑÊòØÔºåËøôÊòØÈÄöËøá W3C WebAssembly Community Group ÂºÄÂèëÁöÑ‰∏ÄÈ°πÁΩëÁªúÊ†áÂáÜÔºåÂπ∂ÂæóÂà∞‰∫ÜÊù•Ëá™ÂêÑÂ§ß‰∏ªË¶ÅÊµèËßàÂô®ÂéÇÂïÜÁöÑÁßØÊûÅÂèÇ‰∏é„ÄÇ</p>
<p>Â∞ΩÁÆ° WebAssembly ÊòØ‰∏∫ËøêË°åÂú® Web ‰∏äËÆæËÆ°ÁöÑÔºåÂÆÉ‰πüÂèØ‰ª•Âú®ÂÖ∂ÂÆÉÁöÑÁéØÂ¢É‰∏≠ËâØÂ•ΩÂú∞ËøêË°å„ÄÇÂåÖÊã¨‰ªéÁî®‰ΩúÊµãËØïÁöÑÊúÄÂ∞èÂåñ shell ÔºåÂà∞ÂÆåÂÖ®ÁöÑÂ∫îÁî®ÁéØÂ¢É ‚Äî‚Äî ‰æãÂ¶ÇÔºöÂú®Êï∞ÊçÆ‰∏≠ÂøÉÁöÑÊúçÂä°Âô®„ÄÅÁâ©ËÅîÁΩëÔºàIoTÔºâËÆæÂ§áÊàñËÄÖÊòØÁßªÂä®/Ê°åÈù¢Â∫îÁî®Á®ãÂ∫è„ÄÇÁîöËá≥ÔºåËøêË°åÂµåÂÖ•Âú®ËæÉÂ§ßÁ®ãÂ∫èÈáåÁöÑ WebAssembly ‰πüÊòØÂèØË°åÁöÑ„ÄÇÈÄöÂ∏∏ÔºåÈÄöËøáÁª¥ÊåÅ‰∏çÈúÄË¶Å Web API ÁöÑÈùû Web Ë∑ØÂæÑÔºåWebAssembly ËÉΩÂ§üÂú®ËÆ∏Â§öÂπ≥Âè∞‰∏äÁî®‰Ωú‰æøÊê∫ÂºèÁöÑ‰∫åËøõÂà∂Ê†ºÂºèÔºå‰∏∫ÁßªÊ§çÊÄß„ÄÅÂ∑•ÂÖ∑ÂíåËØ≠Ë®ÄÊó†ÂÖ≥ÊÄßÂ∏¶Êù•Â∑®Â§ßÁöÑÂ•ΩÂ§Ñ„ÄÇÔºàÂõ†‰∏∫ÂÆÉÊîØÊåÅ c\c++ Á∫ßËØ≠‰πâÔºâ</p>
<p>Wasm ÁöÑÁºñËØëÂíåÈÉ®ÁΩ≤ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/xHicTWic3y1Dtt9CBh8SCA6QQdW7jTrAibKoxAVrXfe0slwf8iav97kbxe2bRVXclfias4hlTDI4fNBQ2RXvFBe9BEA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="xxx" />‚Äã
<em>wasm-compile-deploy</em></p>
<h3 id="ociopen-container-initiative"><a class="header" href="#ociopen-container-initiative">OCI(Open Container Initiative)</a></h3>
<p>ÂºÄÊîæÂÆπÂô®ÂçèËÆÆ(OCI)ÊòØ‰∏Ä‰∏™ËΩªÈáèÁ∫ßÔºåÂºÄÊîæÁöÑÊ≤ªÁêÜÁªìÊûÑÔºå‰∏∫ÂÆπÂô®ÊäÄÊúØÂÆö‰πâ‰∫ÜËßÑËåÉÂíåÊ†áÂáÜ„ÄÇÂú® Linux Âü∫Èáë‰ºöÁöÑÊîØÊåÅ‰∏ãÊàêÁ´ãÔºåÁî±ÂêÑÂ§ßËΩØ‰ª∂‰ºÅ‰∏öÊûÑÊàêÔºåËá¥Âäõ‰∫éÂõ¥ÁªïÂÆπÂô®Ê†ºÂºèÂíåËøêË°åÊó∂ÂàõÂª∫ÂºÄÊîæÁöÑË°å‰∏öÊ†áÂáÜ„ÄÇÂÖ∂‰∏≠ÂåÖÊã¨‰∫Ü‰ΩøÁî® Container Registries ËøõË°åÂ∑•‰ΩúÁöÑ APIÔºåÊ≠£ÂºèÂêçÁß∞‰∏∫ OCI ÂàÜÂèëËßÑËåÉ(ÂèàÂêç‚Äúdistribution-spec‚Äù)„ÄÇËøô‰∏™ÂèëÂ∏ÉËßÑËåÉÊòØÂü∫‰∫é Docker ÂÖ¨Âè∏ÊúÄÂàùÂèëÂ∏ÉÁöÑÂºÄÊ∫êÊ≥®ÂÜåÊúçÂä°Âô®ÁºñÂÜôÁöÑÔºåÂÆÉÂ≠òÂú®‰∫é GitHub ÁöÑ<a href="https://github.com/distribution/distribution">distribution/distribution</a>ÔºàÁé∞Âú®ÊòØ<a href="https://www.cncf.io/">CNCF</a>È°πÁõÆÔºâ‰∏ä„ÄÇ</p>
<p>OCI ÁõÆÂâçÊèêÂá∫ÁöÑËßÑËåÉÊúâÂ¶Ç‰∏ãËøô‰∫õÔºö</p>
<div class="table-wrapper"><table><thead><tr><th>ÂêçÁß∞</th><th>ÁâàÊú¨</th></tr></thead><tbody>
<tr><td><a href="https://github.com/opencontainers/runtime-spec">Runtime Specification</a></td><td>v1.0.2</td></tr>
<tr><td><a href="https://github.com/opencontainers/image-spec">Image Format</a></td><td>v1.0.2</td></tr>
<tr><td><a href="https://github.com/opencontainers/distribution-spec">Distribution Specification</a></td><td>v1.0.1</td></tr>
</tbody></table>
</div>
<p>ÂÖ∂‰∏≠ runtime Âíå image ÁöÑËßÑËåÉÈÉΩÂ∑≤ÁªèÊ≠£ÂºèÂèëÂ∏ÉÔºåËÄå distribution ÁöÑËøòÂú®Â∑•‰Ωú‰πã‰∏≠„ÄÇruntime ËßÑËåÉ‰∏≠‰ªãÁªç‰∫ÜÂ¶Ç‰ΩïËøêË°åËß£ÂéãÁº©Âà∞Á£ÅÁõò‰∏äÁöÑ <a href="https://github.com/opencontainers/runtime-spec/blob/master/bundle.md"><code>Filesystem Bundle</code></a>„ÄÇÂú® OCI Ê†áÂáÜ‰∏ãÔºåËøêË°å‰∏Ä‰∏™ÂÆπÂô®ÁöÑËøáÁ®ãÂ∞±ÊòØ‰∏ãËΩΩ‰∏Ä‰∏™ OCI ÁöÑÈïúÂÉèÔºåÂ∞ÜÂÖ∂Ëß£ÂéãÂà∞Êüê‰∏™ <code>Filesystem Bundle</code> ‰∏≠ÔºåÁÑ∂ÂêéÊüê‰∏™ OCI Runtime Â∞±‰ºöËøêË°åËøô‰∏™ Bundle„ÄÇ</p>
<p>‰º¥ÈöèÁùÄ image spec ‰∏é distribution spec ÁöÑÊºîÂåñÔºå‰∫∫‰ª¨ÂºÄÂßãÈÄêÊ≠•ËÆ§ËØÜÂà∞Èô§‰∫Ü Container Images ‰πãÂ§ñÔºåRegistries ËøòËÉΩÂ§üÁî®Êù•ÂàÜÂèë Kubernetes Deployment Files, Helm Charts, docker-compose, <a href="https://cnab.io/">CNAB</a> Á≠â‰∫ßÁâ©„ÄÇÂÆÉ‰ª¨ÂèØ‰ª•ÂÖ±Áî®Âêå‰∏ÄÂ•ó APIÔºåÂêå‰∏ÄÂ•óÂ≠òÂÇ®ÔºåÂ∞Ü Registries ‰Ωú‰∏∫‰∏Ä‰∏™‰∫ëÂ≠òÂÇ®Á≥ªÁªü„ÄÇËøôÂ∞±‰∏∫Â∏¶Êù•‰∫Ü OCI Artifacts ÁöÑÊ¶ÇÂøµÔºåÁî®Êà∑ËÉΩÂ§üÊääÊâÄÊúâÁöÑ‰∫ßÁâ©ÈÉΩÂ≠òÂÇ®Âú® OCI ÂÖºÂÆπÁöÑ Registiry ÂΩì‰∏≠Âπ∂ËøõË°åÂàÜÂèë„ÄÇ‰∏∫Ê≠§ÔºåMicrosoft Â∞Ü <a href="https://github.com/deislabs/oras">oras</a> ‰Ωú‰∏∫‰∏Ä‰∏™ client Á´ØÂÆûÁé∞ÊçêËµ†Áªô‰∫ÜÁ§æÂå∫ÔºåÂåÖÊã¨ Harbor Âú®ÂÜÖÁöÑÂ§ö‰∏™È°πÁõÆÈÉΩÂú®ÁßØÊûÅÁöÑÂèÇ‰∏é„ÄÇ</p>
<h3 id="orasoci-registry-as-storage"><a class="header" href="#orasoci-registry-as-storage">ORAS(OCI Registry As Storage)</a></h3>
<p>Registries Ê≠£Âú®ÈÄêÊ∏êÊºîÂèò‰∏∫ÈÄöÁî®ÁöÑÁªÑ‰ª∂Â≠òÂÇ®Â∫ì„ÄÇ‰∏∫‰∫ÜÂÆûÁé∞Ëøô‰∏ÄÁõÆÊ†áÔºåORAS È°πÁõÆÊèê‰æõ‰∫Ü‰∏ÄÁßçÂ∞Ü OCI Artifacts ‰ªé OCI Registries Êèê‰∫§ÂíåÊãâÂèñÁöÑÊñπÊ≥ï„ÄÇÊ≠£Âú®ÂØªÊ±ÇÈÄöÁî® Registries ÂÆ¢Êà∑Á´ØÁöÑÁî®Êà∑ÂèØ‰ª•‰ªé<a href="https://oras.land/CLI/">ORAS CLI</a>‰∏≠ÂæóÂà∞Â∏ÆÂä©ÔºåËÄåÂºÄÂèë‰∫∫ÂëòÂèØ‰ª•Âú®<a href="https://oras.land/client_libraries/">ORAS ÂÆ¢Êà∑Á´ØÁöÑÂºÄÂèëÂ∫ì</a>‰πã‰∏äÊûÑÂª∫Ëá™Â∑±ÁöÑÂÆ¢Êà∑Á´Ø„ÄÇ</p>
<p>ORAS ÁöÑÂ∑•‰ΩúÂéüÁêÜ‰∏éÊÇ®ÂèØËÉΩÂ∑≤ÁªèÁÜüÊÇâÁöÑÂ∑•ÂÖ∑(Â¶Ç docker)Á±ª‰ºº„ÄÇÂÆÉÂÖÅËÆ∏ÊÇ®Âêë OCI Registries Êé®ÈÄÅ(‰∏ä‰º†)ÂíåÊèêÂèñ(‰∏ãËΩΩ)ÂÜÖÂÆπÔºåÂπ∂Â§ÑÁêÜÁôªÂΩï(Ë∫´‰ªΩÈ™åËØÅ)Âíå‰ª§ÁâåÊµÅ(ÊéàÊùÉ)„ÄÇORAS ÁöÑ‰∏çÂêå‰πãÂ§ÑÂú®‰∫éÂ∞ÜÁÑ¶ÁÇπ‰ªéÂÆπÂô®Êò†ÂÉèËΩ¨ÁßªÂà∞ÂÖ∂‰ªñÁ±ªÂûãÁöÑÁªÑ‰ª∂‰∏ä„ÄÇ</p>
<p>Âõ†Ê≠§ÔºåÈºìÂä±Êñ∞ÁöÑ OCI Artifacts ÁöÑ‰ΩúËÄÖÂÆö‰πâ‰ªñ‰ª¨Ëá™Â∑±ÁöÑÁªÑ‰ª∂Â™í‰ΩìÁ±ªÂûãÔºå‰ª•‰ΩøÂæó‰ªñ‰ª¨ÁöÑÁî®Êà∑Áü•ÈÅìÂ¶Ç‰ΩïÂØπÂÖ∂ËøõË°åÊìç‰Ωú„ÄÇ</p>
<p>Â¶ÇÊûúÊÇ®Â∏åÊúõÁ´ãÂç≥ÂºÄÂßãÂèëÂ∏É OCI ArtifactsÔºåËØ∑Êü•Áúã<a href="https://oras.land/CLI/">ORAS CLI</a>„ÄÇÂ∏åÊúõÊèê‰æõÁªôËá™Â∑±Áî®Êà∑‰ΩìÈ™åÁöÑÂºÄÂèë‰∫∫ÂëòÂ∫îËØ•‰ΩøÁî®‰∏Ä‰∏™ ORAS ÂÆ¢Êà∑Á´ØÂºÄÂèëÂ∫ì„ÄÇ</p>
<h2 id="Êú™Êù•ÁöÑÂèëÂ±ïÊñπÂêë"><a class="header" href="#Êú™Êù•ÁöÑÂèëÂ±ïÊñπÂêë">Êú™Êù•ÁöÑÂèëÂ±ïÊñπÂêë</a></h2>
<p>Êú™Êù• LMP ‰ºö‰∏ìÊ≥®‰∫éÊõ¥Â§öÁöÑÂü∫‰∫é eBPF ÁöÑÂ∫îÁî®Â∑•ÂÖ∑ÂíåÂÆûË∑µÁöÑÂºÄÂèëÔºö</p>
<ol>
<li>Ëøõ‰∏ÄÊ≠•ÂÆåÂñÑ ORAS Âíå OCI ÈïúÂÉèÁõ∏ÂÖ≥ÁöÑÊîØÊåÅÔºõ</li>
<li>ÈáçÊûÑÂπ∂ËøÅÁßªÁé∞ÊúâÁöÑ eBPF Â∑•ÂÖ∑ÔºåÊèê‰æõÂÆåÊï¥ÁöÑ„ÄÅÂºÄÁÆ±Âç≥Áî®ÁöÑÂàÜÊûêÂ∑•ÂÖ∑ÁªÑ‰ª∂Ôºå‰æãÂ¶ÇÊÄßËÉΩÂ∑•Á®ãÁ≠âÊñπÈù¢Ôºõ</li>
<li>Êé¢Á¥¢ÂíåÂ≠µÂåñÊõ¥Â§öÁöÑ eBPF ÊÉ≥Ê≥ï„ÄÅÁõ∏ÂÖ≥Â∑•ÂÖ∑„ÄÅÈ°πÁõÆÔºõ</li>
</ol>
<p>Êàë‰ª¨ÊâÄÂü∫‰∫éÁöÑ eunomia-bpf È°πÁõÆ‰πü‰ºöÁªßÁª≠ÂÆåÂñÑÔºå‰∏ìÊ≥®‰∫éÊèê‰æõ‰∏Ä‰∏™Â∫ïÂ±ÇÁöÑ eBPF ÂºÄÂèëÂπ≥Âè∞ÂíåËøêË°åÊó∂Âü∫Á°ÄËÆæÊñΩÔºåÂäõÊ±ÇÂ∏¶Êù•Êõ¥Â•ΩÁöÑÂºÄÂèëÂíåÁßªÊ§ç‰ΩìÈ™åÔºö</p>
<ol>
<li>ÊµãËØïÊõ¥Â§öÂπ≥Âè∞ÂíåÂÜÖÊ†∏ÁâàÊú¨ÁöÑÊîØÊåÅÔºåÁõÆÂâçÂ∑≤ÁªèÂú® <code>ARM64</code> Âíå <code>x86_64</code> ‰∏äÊàêÂäüÁßªÊ§çÂπ∂ËøêË°åÔºåÊé•‰∏ãÊù•‰ºöÂØπ‰ΩéÂÜÖÊ†∏ÁâàÊú¨„ÄÅAndroid„ÄÅRISC-V Á≠âÂπ≥Âè∞Ôºå‰ª•ÂèäÂµåÂÖ•Âºè„ÄÅËæπÁºòËÆ°ÁÆóÁõ∏ÂÖ≥ÁöÑËÆæÂ§áËøõË°åÊõ¥Ëøõ‰∏ÄÊ≠•ÁöÑÊµãËØïÔºõ‰πüËÆ∏Âú®Êú™Êù•ÔºåÊàë‰ª¨ËøòÂèØ‰ª•Êèê‰æõ Windows ‰∏äÁöÑ eBPF Á®ãÂ∫èÊîØÊåÅÂíåÁ±ª‰ººÁöÑÂºÄÂèë‰ΩìÈ™åÔºõ</li>
<li>Êèê‰æõÊ†áÂáÜÂåñ„ÄÅÁ®≥ÂÆöÁöÑ JSON Âíå Wasm Êé•Âè£ÂçèËÆÆËßÑËåÉ‰ª•Âèä OCI ÈïúÂÉèËßÑËåÉÔºå‰∏çÂíå‰ªª‰ΩïÁöÑ‰æõÂ∫îÂïÜÊàñ‰∫ëÊúçÂä°ÁªëÂÆö„ÄÇÂ¶ÇÊûú‰∏ç‰ΩøÁî® eunomia-bpf Áõ∏ÂÖ≥ÁöÑÂ∫ïÂ±ÇËøêË°åÊó∂ÔºåÊàñ‰ΩøÁî®Ëá™ÂÆö‰πâÁöÑ Wasm ËøêË°åÊó∂Ôºå‰πüÂèØ‰ª•ÈÄöËøáÊ†áÂáÜÂåñÁöÑÊé•Âè£Êù•‰ΩøÁî® LMP ‰∏≠Â∑≤ÁªèÊúâÁöÑÂ§ßÈáè eBPF Á®ãÂ∫èÁîüÊÄÅ„ÄÇ</li>
<li>Êèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÁî®Êà∑ÊÄÅÂºÄÂèëÊé•Âè£Ôºå‰ª•ÂèäÊõ¥Â§öÁöÑÁî®Êà∑ÊÄÅÂºÄÂèëËØ≠Ë®Ä SDKÔºå‰æãÂ¶Ç Go„ÄÅRust„ÄÅPython Á≠âÔºõ</li>
<li>ËøõË°åÊõ¥Â§öÂÖ≥‰∫é Wasm Âíå eBPF ÁªìÂêàÁöÑÊé¢Á¥¢Ôºõ</li>
</ol>
<h2 id="ÂèÇËÄÉËµÑÊñô--Êé®ËçêÈòÖËØª"><a class="header" href="#ÂèÇËÄÉËµÑÊñô--Êé®ËçêÈòÖËØª">ÂèÇËÄÉËµÑÊñô &amp; Êé®ËçêÈòÖËØª</a></h2>
<ul>
<li><a href="https://github.com/eunomia-bpf/eunomia-bpf">eunomia-bpf: ‰∏Ä‰∏™ eBPF Á®ãÂ∫èÂä®ÊÄÅÂä†ËΩΩÊ°ÜÊû∂</a></li>
<li><a href="https://github.com/linuxkerneltravel/lmp">LMP project: Linux ÊòæÂæÆÈïú</a></li>
<li><a href="https://oras.land/">OCI Registry As Storage (oras.land)</a></li>
<li><a href="https://mp.weixin.qq.com/s/ryT7OqWngCjcCkfeSKjutA">ÂΩì Wasm ÈÅáËßÅ eBPFÔºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫è | ÈæôËú•ÊäÄÊúØ (qq.com)</a></li>
<li><a href="https://xuanwo.io/2019/08/06/oci-intro/">ÂºÄÊîæÂÆπÂô®Ê†áÂáÜ(OCI) ÂÜÖÈÉ®ÂàÜ‰∫´ (xuanwo.io)</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly">WebAssembly | MDN (mozilla.org)</a></li>
<li><a href="http://webassembly.org.cn/docs/non-web/">ÈùûÁΩëÁªúÂµåÂÖ• - WebAssembly ‰∏≠ÊñáÁΩë|Wasm ‰∏≠ÊñáÊñáÊ°£</a></li>
<li><a href="https://bolipi.com/ebpf/home/online">eBPF Âú®Á∫øÂ≠¶‰π†Âπ≥Âè∞Ôºöbolipi.com/ebpf/home/online</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>#! https://zhuanlan.zhihu.com/p/589784295</p>
<h1 id="eunomia-bpf-030-ÂèëÂ∏ÉÂè™ÈúÄÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅËΩªÊùæÊûÑÂª∫ÊâìÂåÖÂèëÂ∏ÉÂÆåÊï¥ÁöÑ-ebpf-Â∫îÁî®"><a class="header" href="#eunomia-bpf-030-ÂèëÂ∏ÉÂè™ÈúÄÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅËΩªÊùæÊûÑÂª∫ÊâìÂåÖÂèëÂ∏ÉÂÆåÊï¥ÁöÑ-ebpf-Â∫îÁî®">eunomia-bpf 0.3.0 ÂèëÂ∏ÉÔºöÂè™ÈúÄÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÔºåËΩªÊùæÊûÑÂª∫„ÄÅÊâìÂåÖ„ÄÅÂèëÂ∏ÉÂÆåÊï¥ÁöÑ eBPF Â∫îÁî®</a></h1>
<h2 id="eunomia-bpf-ÁÆÄ‰ªã"><a class="header" href="#eunomia-bpf-ÁÆÄ‰ªã">eunomia-bpf ÁÆÄ‰ªã</a></h2>
<p>eBPF Ê∫ê‰∫é BPFÔºåÊú¨Ë¥®‰∏äÊòØÂ§Ñ‰∫éÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™È´òÊïà‰∏éÁÅµÊ¥ªÁöÑËôöÊãüÊú∫ÁªÑ‰ª∂Ôºå‰ª•‰∏ÄÁßçÂÆâÂÖ®ÁöÑÊñπÂºèÂú®ËÆ∏Â§öÂÜÖÊ†∏ hook ÁÇπÊâßË°åÂ≠óËäÇÁ†ÅÔºåÂºÄÂèëËÄÖÂèØÂü∫‰∫é eBPF ÂºÄÂèëÊÄßËÉΩÂàÜÊûêÂ∑•ÂÖ∑„ÄÅËΩØ‰ª∂ÂÆö‰πâÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âËØ∏Â§öÂú∫ÊôØ„ÄÇ‰ΩÜÊòØÔºåÁõÆÂâçÂØπ‰∫éÂºÄÂèëÂíå‰ΩøÁî® eBPF Â∫îÁî®ËÄåË®ÄËøòÂèØËÉΩÂ≠òÂú®‰∏Ä‰∫õ‰∏çÂ§üÊñπ‰æøÁöÑÂú∞ÊñπÔºö</p>
<ul>
<li>Êê≠Âª∫ÂíåÂºÄÂèë eBPF Á®ãÂ∫èÊòØ‰∏Ä‰∏™Èó®ÊßõÊØîËæÉÈ´ò„ÄÅÊØîËæÉÂ§çÊùÇÁöÑÂ∑•‰ΩúÔºåÂøÖÈ°ªÂêåÊó∂ÂÖ≥Ê≥®ÂÜÖÊ†∏ÊÄÅÂíåÁî®Êà∑ÊÄÅ‰∏§‰∏™ÊñπÈù¢ÁöÑ‰∫§‰∫íÂíå‰ø°ÊÅØÂ§ÑÁêÜÔºåÊúâÊó∂ËøòË¶ÅÈÖçÁΩÆÁéØÂ¢ÉÂíåÁºñÂÜôÂØπÂ∫îÁöÑÊûÑÂª∫ËÑöÊú¨Ôºõ</li>
<li>ÁõÆÂâç‰∏çÂêåÁî®Êà∑ÊÄÅËØ≠Ë®ÄÂ¶Ç C„ÄÅGo„ÄÅRust Á≠âÁºñÂÜôÁöÑÂ∑•ÂÖ∑Èöæ‰ª•ÂÖºÂÆπ„ÄÅÈöæ‰ª•Áªü‰∏ÄÁÆ°ÁêÜÔºåÂ§öÁßçÂºÄÂèëÁîüÊÄÅÈöæ‰ª•Êï¥ÂêàÔºöÂ¶Ç‰ΩïË∑®Êû∂ÊûÑ„ÄÅË∑®ËØ≠Ë®ÄÂíåÂÜÖÊ†∏ÁâàÊú¨Ôºå‰ΩøÁî®Ê†áÂáÜÂåñÁöÑÊñπÂºèÊñπ‰æøÂèàÂø´Êç∑ÁöÑÊâìÂåÖ„ÄÅÂàÜÂèë„ÄÅÂèëÂ∏É‰∫åËøõÂà∂ eBPF Á®ãÂ∫èÔºåÂêåÊó∂ËøòÈúÄË¶ÅËÉΩÂæàÊñπ‰æøÂú∞Âä®ÊÄÅË∞ÉÊï¥ eBPF Á®ãÂ∫èÁöÑÊåÇËΩΩÁÇπ„ÄÅÂèÇÊï∞Á≠âÁ≠âÔºü</li>
<li>Â¶Ç‰ΩïÊõ¥Êñπ‰æøÂú∞‰ΩøÁî® eBPF ÁöÑÂ∑•ÂÖ∑ÔºöÊúâÊ≤°ÊúâÂèØËÉΩ‰ªé‰∫ëÁ´Ø‰∏ÄË°åÂëΩ‰ª§Êãâ‰∏ãÊù•Â∞±‰ΩøÁî®ÔºåÁ±ª‰ºº docker ÈÇ£Ê†∑ÔºüÊàñËÄÖÊää eBPF Á®ãÂ∫è‰Ωú‰∏∫ÊúçÂä°ËøêË°åÔºåÈÄöËøá HTTP ËØ∑Ê±ÇÂíå URL Âç≥ÂèØÁÉ≠Êõ¥Êñ∞„ÄÅÂä®ÊÄÅÊèíÊãîËøêË°å‰ªªÊÑè‰∏Ä‰∏™ eBPF Á®ãÂ∫èÔºü</li>
</ul>
<p><a href="https://github.com/eunomia-bpf/eunomia-bpf">eunomia-bpf</a> ÊòØ‰∏Ä‰∏™ÂºÄÊ∫êÁöÑ eBPF Âä®ÊÄÅÂä†ËΩΩËøêË°åÊó∂ÂíåÂºÄÂèëÂ∑•ÂÖ∑ÈìæÔºåÊòØ‰∏∫‰∫ÜÁÆÄÂåñ eBPF Á®ãÂ∫èÁöÑÂºÄÂèë„ÄÅÊûÑÂª∫„ÄÅÂàÜÂèë„ÄÅËøêË°åËÄåËÆæËÆ°ÁöÑÔºåÂü∫‰∫é libbpf ÁöÑ CO-RE ËΩªÈáèÁ∫ßÂºÄÂèëÊ°ÜÊû∂„ÄÇ</p>
<p>‰ΩøÁî® eunomia-bpf ÔºåÂèØ‰ª•Ôºö</p>
<ul>
<li>Âú®ÁºñÂÜô eBPF Á®ãÂ∫èÊàñÂ∑•ÂÖ∑Êó∂Âè™ÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÔºåËá™Âä®Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÂØºÂá∫‰ø°ÊÅØÔºõ</li>
<li>‰ΩøÁî® Wasm ËøõË°åÁî®Êà∑ÊÄÅ‰∫§‰∫íÁ®ãÂ∫èÁöÑÂºÄÂèëÔºåÂú® Wasm ËôöÊãüÊú∫ÂÜÖÈÉ®ÊéßÂà∂Êï¥‰∏™ eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°åÔºå‰ª•ÂèäÂ§ÑÁêÜÁõ∏ÂÖ≥Êï∞ÊçÆÔºõ</li>
<li>eunomia-bpf ÂèØ‰ª•Â∞ÜÈ¢ÑÁºñËØëÁöÑ eBPF Á®ãÂ∫èÊâìÂåÖ‰∏∫ÈÄöÁî®ÁöÑ JSON Êàñ Wasm Ê®°ÂùóÔºåË∑®Êû∂ÊûÑÂíåÂÜÖÊ†∏ÁâàÊú¨ËøõË°åÂàÜÂèëÔºåÊó†ÈúÄÈáçÊñ∞ÁºñËØëÂç≥ÂèØÂä®ÊÄÅÂä†ËΩΩËøêË°å„ÄÇ</li>
</ul>
<p>eunomia-bpf Áî±‰∏Ä‰∏™ÁºñËØëÂ∑•ÂÖ∑ÈìæÂíå‰∏Ä‰∏™ËøêË°åÊó∂Â∫ìÁªÑÊàê, ÂØπÊØî‰º†ÁªüÁöÑ BCC„ÄÅÂéüÁîü libbpf Á≠âÊ°ÜÊû∂ÔºåÂ§ßÂπÖÁÆÄÂåñ‰∫Ü eBPF Á®ãÂ∫èÁöÑÂºÄÂèëÊµÅÁ®ãÔºåÂú®Â§ßÂ§öÊï∞Êó∂ÂÄôÂè™ÈúÄÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÔºåÂç≥ÂèØËΩªÊùæÊûÑÂª∫„ÄÅÊâìÂåÖ„ÄÅÂèëÂ∏ÉÂÆåÊï¥ÁöÑ eBPF Â∫îÁî®ÔºåÂêåÊó∂ÂÜÖÊ†∏ÊÄÅ eBPF ‰ª£Á†Å‰øùËØÅÂíå‰∏ªÊµÅÁöÑ libbpf, libbpfgo, libbpf-rs Á≠âÂºÄÂèëÊ°ÜÊû∂ÁöÑ 100% ÂÖºÂÆπÊÄß„ÄÇÈúÄË¶ÅÁºñÂÜôÁî®Êà∑ÊÄÅ‰ª£Á†ÅÁöÑÊó∂ÂÄôÔºå‰πüÂèØ‰ª•ÂÄüÂä© Webassembly(Wasm) ÂÆûÁé∞ÈÄöËøáÂ§öÁßçËØ≠Ë®ÄËøõË°åÁî®Êà∑ÊÄÅÂºÄÂèë„ÄÇÂíå bpftrace Á≠âËÑöÊú¨Â∑•ÂÖ∑Áõ∏ÊØî, eunomia-bpf ‰øùÁïô‰∫ÜÁ±ª‰ººÁöÑ‰æøÊç∑ÊÄß, ÂêåÊó∂‰∏ç‰ªÖÂ±ÄÈôê‰∫é trace ÊñπÈù¢, ÂèØ‰ª•Áî®‰∫éÊõ¥Â§öÁöÑÂú∫ÊôØ, Â¶ÇÁΩëÁªú„ÄÅÂÆâÂÖ®Á≠âÁ≠â„ÄÇ</p>
<blockquote>
<ul>
<li>eunomia-bpf È°πÁõÆ Github Âú∞ÂùÄ: <a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>gitee ÈïúÂÉè: <a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
</ul>
</blockquote>
<p>Êàë‰ª¨ÂèëÂ∏É‰∫ÜÊúÄÊñ∞ÁöÑ 0.3 ÁâàÊú¨, ÂØπ‰∫éÊï¥‰ΩìÁöÑÂºÄÂèëÂíå‰ΩøÁî®ÊµÅÁ®ãËøõË°å‰∫Ü‰ºòÂåñÔºåÂêåÊó∂‰πüÊîØÊåÅ‰∫ÜÊõ¥Â§öÁöÑ eBPF Á®ãÂ∫èÂíå maps Á±ªÂûã„ÄÇ</p>
<h2 id="ËøêË°åÊó∂‰ºòÂåñÂ¢ûÂº∫ÂäüËÉΩÊÄß-Â¢ûÂä†Â§öÁßçÁ®ãÂ∫èÁ±ªÂûã"><a class="header" href="#ËøêË°åÊó∂‰ºòÂåñÂ¢ûÂº∫ÂäüËÉΩÊÄß-Â¢ûÂä†Â§öÁßçÁ®ãÂ∫èÁ±ªÂûã">ËøêË°åÊó∂‰ºòÂåñÔºöÂ¢ûÂº∫ÂäüËÉΩÊÄß, Â¢ûÂä†Â§öÁßçÁ®ãÂ∫èÁ±ªÂûã</a></h2>
<ol>
<li>
<p>Âè™ÈúÄÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†Å, Âç≥ÂèØËé∑ÂæóÂØπÂ∫îÁöÑËæìÂá∫‰ø°ÊÅØ, ‰ª•ÂèØËØª„ÄÅËßÑÊï¥ÁöÑÊñπÂºèÊâìÂç∞Âà∞Ê†áÂáÜËæìÂá∫. ‰ª•‰∏Ä‰∏™ÁÆÄÂçïÁöÑ eBPF Á®ãÂ∫è, Ë∑üË∏™ÊâÄÊúâ open Á±ªÂûãÁ≥ªÁªüË∞ÉÁî®ÁöÑ opensnoop ‰∏∫‰æã:</p>
<p>Â§¥Êñá‰ª∂ opensnoop.h</p>
<pre><code class="language-c">#ifndef __OPENSNOOP_H
#define __OPENSNOOP_H

#define TASK_COMM_LEN 16
#define NAME_MAX 255
#define INVALID_UID ((uid_t)-1)

// used for export event
struct event {
  /* user terminology for pid: */
  unsigned long long ts;
  int pid;
  int uid;
  int ret;
  int flags;
  char comm[TASK_COMM_LEN];
  char fname[NAME_MAX];
};

#endif /* __OPENSNOOP_H */
</code></pre>
<p>ÂÜÖÊ†∏ÊÄÅ‰ª£Á†Å opensnoop.bpf.c</p>
<pre><code class="language-c">#include &lt;vmlinux.h&gt;
#include &lt;bpf/bpf_helpers.h&gt;
#include &quot;opensnoop.h&quot;

struct args_t {
  const char *fname;
  int flags;
};

/// Process ID to trace
const volatile int pid_target = 0;
/// Thread ID to trace
const volatile int tgid_target = 0;
/// @description User ID to trace
const volatile int uid_target = 0;
/// @cmdarg {&quot;default&quot;: false, &quot;short&quot;: &quot;f&quot;, &quot;long&quot;: &quot;failed&quot;}
const volatile bool targ_failed = false;

struct {
  __uint(type, BPF_MAP_TYPE_HASH);
  __uint(max_entries, 10240);
  __type(key, u32);
  __type(value, struct args_t);
} start SEC(&quot;.maps&quot;);

struct {
  __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);
  __uint(key_size, sizeof(u32));
  __uint(value_size, sizeof(u32));
} events SEC(&quot;.maps&quot;);

static __always_inline bool valid_uid(uid_t uid) {
  return uid != INVALID_UID;
}

static __always_inline
bool trace_allowed(u32 tgid, u32 pid)
{
  u32 uid;

  /* filters */
  if (tgid_target &amp;&amp; tgid_target != tgid)
    return false;
  if (pid_target &amp;&amp; pid_target != pid)
    return false;
  if (valid_uid(uid_target)) {
    uid = (u32)bpf_get_current_uid_gid();
    if (uid_target != uid) {
      return false;
    }
  }
  return true;
}

SEC(&quot;tracepoint/syscalls/sys_enter_open&quot;)
int tracepoint__syscalls__sys_enter_open(struct trace_event_raw_sys_enter* ctx)
{
  u64 id = bpf_get_current_pid_tgid();
  /* use kernel terminology here for tgid/pid: */
  u32 tgid = id &gt;&gt; 32;
  u32 pid = id;

  /* store arg info for later lookup */
  if (trace_allowed(tgid, pid)) {
    struct args_t args = {};
    args.fname = (const char *)ctx-&gt;args[0];
    args.flags = (int)ctx-&gt;args[1];
    bpf_map_update_elem(&amp;start, &amp;pid, &amp;args, 0);
  }
  return 0;
}

SEC(&quot;tracepoint/syscalls/sys_enter_openat&quot;)
int tracepoint__syscalls__sys_enter_openat(struct trace_event_raw_sys_enter* ctx)
{
  u64 id = bpf_get_current_pid_tgid();
  /* use kernel terminology here for tgid/pid: */
  u32 tgid = id &gt;&gt; 32;
  u32 pid = id;

  /* store arg info for later lookup */
  if (trace_allowed(tgid, pid)) {
    struct args_t args = {};
    args.fname = (const char *)ctx-&gt;args[1];
    args.flags = (int)ctx-&gt;args[2];
    bpf_map_update_elem(&amp;start, &amp;pid, &amp;args, 0);
  }
  return 0;
}

static __always_inline
int trace_exit(struct trace_event_raw_sys_exit* ctx)
{
  struct event event = {};
  struct args_t *ap;
  int ret;
  u32 pid = bpf_get_current_pid_tgid();

  ap = bpf_map_lookup_elem(&amp;start, &amp;pid);
  if (!ap)
    return 0; /* missed entry */
  ret = ctx-&gt;ret;
  if (targ_failed &amp;&amp; ret &gt;= 0)
    goto cleanup; /* want failed only */

  /* event data */
  event.pid = bpf_get_current_pid_tgid() &gt;&gt; 32;
  event.uid = bpf_get_current_uid_gid();
  bpf_get_current_comm(&amp;event.comm, sizeof(event.comm));
  bpf_probe_read_user_str(&amp;event.fname, sizeof(event.fname), ap-&gt;fname);
  event.flags = ap-&gt;flags;
  event.ret = ret;

  /* emit event */
  bpf_perf_event_output(ctx, &amp;events, BPF_F_CURRENT_CPU,
            &amp;event, sizeof(event));

cleanup:
  bpf_map_delete_elem(&amp;start, &amp;pid);
  return 0;
}

SEC(&quot;tracepoint/syscalls/sys_exit_open&quot;)
int tracepoint__syscalls__sys_exit_open(struct trace_event_raw_sys_exit* ctx)
{
  return trace_exit(ctx);
}

SEC(&quot;tracepoint/syscalls/sys_exit_openat&quot;)
int tracepoint__syscalls__sys_exit_openat(struct trace_event_raw_sys_exit* ctx)
{
  return trace_exit(ctx);
}

/// Trace open family syscalls.
char LICENSE[] SEC(&quot;license&quot;) = &quot;GPL&quot;;
</code></pre>
<p>ÁºñËØëËøêË°å:</p>
<pre><code class="language-console">$ ecc opensnoop.bpf.c opensnoop.h
Compiling bpf object...
Generating export types...
Packing ebpf object and config into package.json...
$ sudo ecli examples/bpftools/opensnoop/package.json
TIME     TS      PID     UID     RET     FLAGS   COMM    FNAME
20:31:50  0      1       0       51      524288  systemd /proc/614/cgroup
20:31:50  0      33182   0       25      524288  ecli    /etc/localtime
20:31:53  0      754     0       6       0       irqbalance /proc/interrupts
20:31:53  0      754     0       6       0       irqbalance /proc/stat
20:32:03  0      754     0       6       0       irqbalance /proc/interrupts
20:32:03  0      754     0       6       0       irqbalance /proc/stat
20:32:03  0      632     0       7       524288  vmtoolsd /etc/mtab
20:32:03  0      632     0       9       0       vmtoolsd /proc/devices

$ sudo ecli examples/bpftools/opensnoop/package.json --pid_target 754
TIME     TS      PID     UID     RET     FLAGS   COMM    FNAME
20:34:13  0      754     0       6       0       irqbalance /proc/interrupts
20:34:13  0      754     0       6       0       irqbalance /proc/stat
20:34:23  0      754     0       6       0       irqbalance /proc/interrupts
20:34:23  0      754     0       6       0       irqbalance /proc/stat
</code></pre>
<p>Êàñ‰ΩøÁî® docker ÁºñËØë:</p>
<pre><code class="language-shell">docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest
</code></pre>
<p>ÁºñËØëÂèëÂ∏ÉÂêé, ‰πüÂèØ‰ª•ËΩªÊùæ‰ªé‰∫ëÁ´Ø‰∏ÄË°åÂëΩ‰ª§ÂêØÂä®‰ªªÊÑè eBPF Á®ãÂ∫è, ‰æãÂ¶Ç:</p>
<pre><code class="language-bash">wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli     # download the release from https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecli
sudo ./ecli https://eunomia-bpf.github.io/eunomia-bpf/sigsnoop/package.json # simply run a pre-compiled ebpf code from a url
sudo ./ecli sigsnoop:latest # run with a name and download the latest version bpf tool from our repo
</code></pre>
<p>ÂÆåÊï¥‰ª£Á†ÅÂú®ËøôÈáå: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/opensnoop</a></p>
</li>
<li>
<p>ÊîØÊåÅÊ†πÊçÆ‰ª£Á†Å‰∏≠ÁöÑÊ≥®Èáä‰ø°ÊÅØËá™Âä®ÁîüÊàêÁî®Êà∑ÊÄÅÂëΩ‰ª§Ë°åÂèÇÊï∞„ÄÇ</p>
<p>ÊØîÂ¶ÇÈúÄË¶ÅÂÆûÁé∞‰∏Ä‰∏™ ebpf Á®ãÂ∫èÈáåÈù¢ÁöÑ pid ËøáÊª§Âô®ÔºåÂè™ÈúÄË¶ÅÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÔºåÂú® eBPF ‰∏≠Â£∞ÊòéÂÖ®Â±ÄÂèòÈáèÔºåÂç≥ÂèØËá™Âä®ÁîüÊàêÂëΩ‰ª§Ë°åÂèÇÊï∞Ôºö</p>
<pre><code class="language-c">/// Process ID to trace
const volatile pid_t pid_target = 0;
/// Thread ID to trace
const volatile pid_t tgid_target = 0;
/// @description User ID to trace
const volatile uid_t uid_target = 0;
/// @cmdarg {&quot;default&quot;: false, &quot;short&quot;: &quot;f&quot;, &quot;long&quot;: &quot;failed&quot;}
/// @description target pid to trace
const volatile bool targ_failed = false;
</code></pre>
<p>Êàë‰ª¨‰ºöÂ∞ÜÊ≥®ÈáäÊñáÊ°£ÁöÑÊèèËø∞‰ø°ÊÅØÊèêÂèñÔºåÊîæÂú®ÈÖçÁΩÆÊñá‰ª∂ÈáåÈù¢ÔºåÂπ∂‰∏îÂèòÊàê eBPF Â∫îÁî®ÁöÑÂëΩ‰ª§Ë°åÂèÇÊï∞. ‰ΩøÁî®ÊñπÂºè‰ª•Ë∑üË∏™ÊâÄÊúâ open Á≥ªÁªüË∞ÉÁî®ÁöÑ opensnoop ‰∏∫‰æãÔºö</p>
<pre><code class="language-console">$ sudo ecli  examples/bpftools/opensnoop/package.json -h
Usage: opensnoop_bpf [--help] [--version] [--verbose] [--pid_target VAR] [--tgid_target VAR] [--uid_target VAR] [--failed]

Trace open family syscalls.

Optional arguments:
  -h, --help    shows help message and exits
  -v, --version prints version information and exits
  --verbose     prints libbpf debug information
  --pid_target  Process ID to trace
  --tgid_target Thread ID to trace

$ sudo ecli examples/bpftools/opensnoop/package.json --pid_target 754
TIME     TS      PID     UID     RET     FLAGS   COMM    FNAME
20:34:13  0      754     0       6       0       irqbalance /proc/interrupts
20:34:13  0      754     0       6       0       irqbalance /proc/stat
20:34:23  0      754     0       6       0       irqbalance /proc/interrupts
20:34:23  0      754     0       6       0       irqbalance /proc/stat
</code></pre>
</li>
<li>
<p>ÊîØÊåÅËá™Âä®ÈááÈõÜÂíåÁªºÂêàÈùû ring buffer Âíå perf event ÁöÑ mapÔºåÊØîÂ¶Ç hash mapÔºåÊâìÂç∞Âá∫‰ø°ÊÅØÊàñÁîüÊàêÁõ¥ÊñπÂõæ„ÄÇ</p>
<p>‰πãÂâç‰ΩøÁî® ring buffer Âíå perf event ÁöÑÂú∫ÊôØ‰ºöÁ®çÂæÆÂèóÈôêÔºåÂõ†Ê≠§ÈúÄË¶ÅÊúâ‰∏ÄÁßçÊñπÊ≥ïÂèØ‰ª•Ëá™Âä®‰ªé maps ÈáåÈù¢ÈááÈõÜÊï∞ÊçÆÔºåÂú®Ê∫ê‰ª£Á†ÅÈáåÈù¢Ê∑ªÂä†Ê≥®ÈáäÂç≥ÂèØÔºö</p>
<pre><code class="language-c">/// @sample {&quot;interval&quot;: 1000, &quot;type&quot; : &quot;log2_hist&quot;}
struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, MAX_ENTRIES);
    __type(key, u32);
    __type(value, struct hist);
} hists SEC(&quot;.maps&quot;);
</code></pre>
<p>Â∞±‰ºöÊØèÈöî‰∏ÄÁßíÂéªÈááÈõÜ‰∏ÄÊ¨° counters ÈáåÈù¢ÁöÑÂÜÖÂÆπÔºàprint_mapÔºâÔºå‰ª• runqlat ‰∏∫‰æãÔºö</p>
<pre><code class="language-console">$ sudo ecli examples/bpftools/runqlat/package.json -h
Usage: runqlat_bpf [--help] [--version] [--verbose] [--filter_cg] [--targ_per_process] [--targ_per_thread] [--targ_per_pidns] [--targ_ms] [--targ_tgid VAR]

Summarize run queue (scheduler) latency as a histogram.

Optional arguments:
  -h, --help            shows help message and exits
  -v, --version         prints version information and exits
  --verbose             prints libbpf debug information
  --filter_cg           set value of bool variable filter_cg
  --targ_per_process    set value of bool variable targ_per_process
  --targ_per_thread     set value of bool variable targ_per_thread
  --targ_per_pidns      set value of bool variable targ_per_pidns
  --targ_ms             set value of bool variable targ_ms
  --targ_tgid           set value of pid_t variable targ_tgid

Built with eunomia-bpf framework.
See https://github.com/eunomia-bpf/eunomia-bpf for more information.

$ sudo ecli examples/bpftools/runqlat/package.json
key =  4294967295
comm = rcu_preempt

    (unit)              : count    distribution
        0 -&gt; 1          : 9        |****                                    |
        2 -&gt; 3          : 6        |**                                      |
        4 -&gt; 7          : 12       |*****                                   |
        8 -&gt; 15         : 28       |*************                           |
       16 -&gt; 31         : 40       |*******************                     |
       32 -&gt; 63         : 83       |****************************************|
       64 -&gt; 127        : 57       |***************************             |
      128 -&gt; 255        : 19       |*********                               |
      256 -&gt; 511        : 11       |*****                                   |
      512 -&gt; 1023       : 2        |                                        |
     1024 -&gt; 2047       : 2        |                                        |
     2048 -&gt; 4095       : 0        |                                        |
     4096 -&gt; 8191       : 0        |                                        |
     8192 -&gt; 16383      : 0        |                                        |
    16384 -&gt; 32767      : 1        |                                        |

$ sudo ecli examples/bpftools/runqlat/package.json --targ_per_process
key =  3189
comm = cpptools

    (unit)              : count    distribution
        0 -&gt; 1          : 0        |                                        |
        2 -&gt; 3          : 0        |                                        |
        4 -&gt; 7          : 0        |                                        |
        8 -&gt; 15         : 1        |***                                     |
       16 -&gt; 31         : 2        |*******                                 |
       32 -&gt; 63         : 11       |****************************************|
       64 -&gt; 127        : 8        |*****************************           |
      128 -&gt; 255        : 3        |**********                              |
</code></pre>
<p>ÂÆåÊï¥‰ª£Á†ÅÂú®ËøôÈáå: <a href="https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/runqlat">https://github.com/eunomia-bpf/eunomia-bpf/tree/master/examples/bpftools/runqlat</a></p>
</li>
<li>
<p>Ê∑ªÂä†ÂØπ uprobe, tc Á≠âÂ§öÁßçÁ±ªÂûã map ÁöÑÊîØÊåÅ, ÂÖÅËÆ∏Áî®Ê†áËÆ∞ÂÆûÁé∞Ê∑ªÂä†È¢ùÂ§ñ attach ‰ø°ÊÅØ, ‰æãÂ¶Ç:</p>
<pre><code class="language-c">
/// @tchook {&quot;ifindex&quot;:1, &quot;attach_point&quot;:&quot;BPF_TC_INGRESS&quot;}
/// @tcopts {&quot;handle&quot;:1,  &quot;priority&quot;:1}
SEC(&quot;tc&quot;)
int tc_ingress(struct __sk_buff *ctx)
{
    void *data_end = (void *)(__u64)ctx-&gt;data_end;
    void *data = (void *)(__u64)ctx-&gt;data;
    struct ethhdr *l2;
    struct iphdr *l3;

    if (ctx-&gt;protocol != bpf_htons(ETH_P_IP))
        return TC_ACT_OK;

    l2 = data;
    if ((void *)(l2 + 1) &gt; data_end)
        return TC_ACT_OK;

    l3 = (struct iphdr *)(l2 + 1);
    if ((void *)(l3 + 1) &gt; data_end)
        return TC_ACT_OK;

    bpf_printk(&quot;Got IP packet: tot_len: %d, ttl: %d&quot;, bpf_ntohs(l3-&gt;tot_len), l3-&gt;ttl);
    return TC_ACT_OK;
}
</code></pre>
</li>
</ol>
<h2 id="ÁºñËØëÊñπÈù¢ÁºñËØë‰ΩìÈ™å‰ºòÂåñÊ†ºÂºèÊîπËøõ"><a class="header" href="#ÁºñËØëÊñπÈù¢ÁºñËØë‰ΩìÈ™å‰ºòÂåñÊ†ºÂºèÊîπËøõ">ÁºñËØëÊñπÈù¢ÔºöÁºñËØë‰ΩìÈ™å‰ºòÂåñ„ÄÅÊ†ºÂºèÊîπËøõ</a></h2>
<ol>
<li>ÂÆåÂÖ®ÈáçÊûÑ‰∫ÜÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºèÔºåÂõûÂΩíÊú¨Ë¥®ÁöÑÈÖçÁΩÆÊñá‰ª∂ + ebpf Â≠óËäÇÁ†Å .o ÁöÑÂΩ¢ÂºèÔºå‰∏çÂº∫Âà∂ÊâìÂåÖÊàê JSON Ê†ºÂºèÔºåÂØπÂàÜÂèë‰ΩøÁî®Âíå‰∫∫Á±ªÁºñËæëÈÖçÁΩÆÊñá‰ª∂Êõ¥ÂèãÂ•ΩÔºåÂêåÊó∂‰πüÂèØ‰ª•Êõ¥Â•ΩÂú∞Âíå libbpf Áõ∏ÂÖ≥Â∑•ÂÖ∑ÈìæÂÖºÂÆπ;</li>
<li>ÊîØÊåÅ JSON Âíå YAML ‰∏§ÁßçÂΩ¢ÂºèÁöÑÈÖçÁΩÆÊñá‰ª∂Ôºàxxx.skel.yaml Âíå xxx.skel.jsonÔºâÔºåÊàñÊâìÂåÖÊàê package.json Âíå package.yaml ËøõË°åÂàÜÂèë;</li>
<li>Â∞ΩÂèØËÉΩ‰ΩøÁî® BTF ‰ø°ÊÅØË°®ËææÁ¨¶Âè∑Á±ªÂûãÔºåÂπ∂‰∏îÊää BTF ‰ø°ÊÅØÈöêËóèÂú®‰∫åËøõÂà∂Êñá‰ª∂‰∏≠ÔºåËÆ©ÈÖçÁΩÆÊñá‰ª∂Êõ¥ÂèØËØªÂíåÂèØÁºñËæëÔºåÂêåÊó∂Â§çÁî® libbpf Êèê‰æõÁöÑ BTF Â§ÑÁêÜÊú∫Âà∂ÔºåÂÆåÂñÑÂØπ‰∫éÁ±ªÂûãÁöÑÂ§ÑÁêÜÔºõ</li>
<li>ÊîØÊåÅÊõ¥Â§öÁöÑÊï∞ÊçÆÂØºÂá∫Á±ªÂûãÔºöenum„ÄÅstruct„ÄÅbool Á≠âÁ≠â</li>
<li>ÁºñËØëÈÉ®ÂàÜÂèØ‰ª•‰∏ç‰æùËµñ‰∫é docker ËøêË°åÔºåÂèØ‰ª•ÂÆâË£Ö‰∫åËøõÂà∂ÂíåÂ§¥Êñá‰ª∂Âà∞ ~/.eunomiaÔºàÂØπÂµåÂÖ•ÂºèÊàñËÄÖÂõΩÂÜÖÁΩëÁªúÊõ¥ÂèãÂ•ΩÔºåÊõ¥Êñπ‰æø‰ΩøÁî®ÔºâÔºåÂéüÊú¨ docker ÁöÑ‰ΩøÁî®ÊñπÂºèËøòÊòØÂèØ‰ª•ÁªßÁª≠‰ΩøÁî®Ôºõ</li>
<li>Êñá‰ª∂ÂêçÊ≤°ÊúâÁâπÂÆöÈôêÂà∂Ôºå‰∏çÈúÄË¶Å‰∏ÄÂÆöÊòØ xxx.bpf.h Âíå xxx.bpf.cÔºåÂèØ‰ª•ÈÄöËøá ecc ÊåáÂÆöÂΩìÂâçÁõÆÂΩï‰∏ãÈúÄË¶ÅÁºñËØëÁöÑÊñá‰ª∂;</li>
<li>Êää example ‰∏≠ÊóßÁöÑ xxx.bpf.h Â§¥Êñá‰ª∂‰øÆÊîπ‰∏∫ xxx.hÔºåÂíå libbpf-tools Âíå libbpf-boostrap ‰øùÊåÅ‰∏ÄËá¥ÔºåÁ°Æ‰øù 0 ‰ª£Á†Å‰øÆÊîπÂç≥ÂèØÂ§çÁî® libbpf Áõ∏ÂÖ≥‰ª£Á†ÅÁîüÊÄÅÔºõ</li>
<li>Â§ßÂπÖÂ∫¶‰ºòÂåñÁºñËØëÈÄüÂ∫¶ÂíåÂáèÂ∞ëÁºñËØë‰æùËµñÔºå‰ΩøÁî® Rust ÈáçÊûÑ‰∫ÜÁºñËØëÂ∑•ÂÖ∑ÈìæÔºåÊõøÊç¢ÂéüÂÖàÁöÑ python ËÑöÊú¨;</li>
</ol>
<p>Âú®ÈÖçÁΩÆÊñá‰ª∂‰∏≠, ÂèØ‰ª•Áõ¥Êé•‰øÆÊîπ progs/attach ÊéßÂà∂ÊåÇËΩΩÁÇπÔºåvariables/value ÊéßÂà∂ÂÖ®Â±ÄÂèòÈáèÔºåmaps/data ÊéßÂà∂Âú®Âä†ËΩΩ ebpf Á®ãÂ∫èÊó∂ÂæÄ map ÈáåÈù¢Êîæ‰ªÄ‰πàÊï∞ÊçÆÔºåexport_types/members ÊéßÂà∂ÂæÄÁî®Êà∑ÊÄÅ‰º†Ëæì‰ªÄ‰πàÊï∞ÊçÆÊ†ºÂºèÔºåËÄå‰∏çÈúÄË¶ÅÈáçÊñ∞ÁºñËØë eBPF Á®ãÂ∫è„ÄÇÈÖçÁΩÆÊñá‰ª∂Âíå bpf.o ‰∫åËøõÂà∂ÊòØÈÖçÂ•óÁöÑÔºåÂ∫îËØ•Êê≠ÈÖç‰ΩøÁî®ÔºåÊàñËÄÖÊâìÂåÖÊàê‰∏Ä‰∏™ package.json/yaml ÂàÜÂèë„ÄÇÊâìÂåÖÁöÑÊó∂ÂÄô‰ºöËøõË°åÂéãÁº©Ôºå‰∏ÄËà¨Êù•ËØ¥ÂéãÁº©ÂêéÁöÑÈÖçÁΩÆÊñá‰ª∂Âíå‰∫åËøõÂà∂ÂêàËµ∑Êù•ÁöÑÂ§ßÂ∞èÂú®Êï∞ÂçÅ kb „ÄÇ</p>
<p>ÈÖçÁΩÆÊñá‰ª∂‰∏æ‰æã:</p>
<pre><code class="language-yaml">bpf_skel:
  data_sections:
  - name: .rodata
    variables:
    - name: min_duration_ns
      type: unsigned long long
      value: 100
  maps:
  - ident: exec_start
    name: exec_start
    data:
      - key: 123
        value: 456
  - ident: rb
    name: rb
  - ident: rodata
    mmaped: true
    name: client_b.rodata
  obj_name: client_bpf
  progs:
  - attach: tp/sched/sched_process_exec
    link: true
    name: handle_exec
export_types:
- members:
  - name: pid
    type: int
  - name: ppid
    type: int
  - name: comm
    type: char[16]
  - name: filename
    type: char[127]
  - name: exit_event
    type: bool
  name: event
  type_id: 613
</code></pre>
<h2 id="‰∏ãËΩΩÂÆâË£Ö-eunomia-bpf"><a class="header" href="#‰∏ãËΩΩÂÆâË£Ö-eunomia-bpf">‰∏ãËΩΩÂÆâË£Ö eunomia-bpf</a></h2>
<ul>
<li>
<p>Install the <code>ecli</code> tool for running eBPF program from the cloud:</p>
<pre><code class="language-console">$ wget https://aka.pw/bpf-ecli -O ecli &amp;&amp; chmod +x ./ecli
$ ./ecli -h
Usage: ecli [--help] [--version] [--json] [--no-cache] url-and-args
....
</code></pre>
</li>
<li>
<p>Install the compiler-toolchain for compiling eBPF kernel code to a <code>config</code> file or <code>Wasm</code> module:</p>
<pre><code class="language-console">$ wget https://github.com/eunomia-bpf/eunomia-bpf/releases/latest/download/ecc &amp;&amp; chmod +x ./ecc
$ ./ecc -h
eunomia-bpf compiler
Usage: ecc [OPTIONS] &lt;SOURCE_PATH&gt; [EXPORT_EVENT_HEADER]
....
....
</code></pre>
<p>or use the docker image for compile:</p>
<pre><code class="language-bash">docker run -it -v `pwd`/:/src/ yunwei37/ebpm:latest # compile with docker. `pwd` should contains *.bpf.c files and *.h files.
</code></pre>
</li>
</ul>
<h2 id="‰∏ã‰∏ÄÊ≠•ÂèëÂ±ïÁöÑËÆ°Âàí"><a class="header" href="#‰∏ã‰∏ÄÊ≠•ÂèëÂ±ïÁöÑËÆ°Âàí">‰∏ã‰∏ÄÊ≠•ÂèëÂ±ïÁöÑËÆ°Âàí</a></h2>
<ol>
<li>ÂíåÊõ¥Â§öÁöÑÁ§æÂå∫‰ºô‰º¥Âêà‰Ωú, Âπ∂ÈÄêÊ≠•ÂΩ¢ÊàêÊ†áÂáÜÂåñÁöÑ, ‰ΩøÁî®ÈÖçÁΩÆÊñá‰ª∂Êàñ Wasm ‰∫åËøõÂà∂ËøõË°åÊâìÂåÖÂàÜÂèë, ‰∏ÄÊ¨°ÁºñËØë, Âà∞Â§ÑËøêË°åÁöÑ eBPF Á®ãÂ∫èÊ†ºÂºè;</li>
<li>Âíå LMP Á§æÂå∫‰∏ÄËµ∑, ÂÆåÂñÑÂü∫‰∫é ORAS, OCI Âíå Wasm ÁöÑ eBPF Á®ãÂ∫èÂàÜÂèëÂíåËøêË°åÊó∂Ê†áÂáÜ, ËÆ©‰ªªÊÑè eBPF Â∫îÁî®ÂùáÂèØ‰ªé‰∫ëÁ´Ø‰∏ÄË°åÂëΩ‰ª§Êãâ‰∏ãÊù•Áõ¥Êé•ËøêË°å, ÊàñËΩªÊùæÂµåÂÖ•ÂÖ∂‰ªñÂ∫îÁî®‰∏≠‰ΩøÁî®, Êó†ÈúÄÂÖ≥Ê≥®Êû∂ÊûÑ, ÂÜÖÊ†∏ÁâàÊú¨Á≠âÁªÜËäÇ;</li>
<li>Â∞ùËØïÂíå Coolbpf Á§æÂå∫‰∏ÄÂêåÂÆåÂñÑËøúÁ®ãÁºñËØë, ‰ΩéÁâàÊú¨ÊîØÊåÅÁöÑÁâπÊÄß, ‰ª•ÂèäÊîØÊåÅ RPC ÁöÑ libbpf Â∫ì;</li>
<li>ÂÆåÂñÑÁî®Êà∑ÊÄÅ Wasm Âíå eBPF Á®ãÂ∫è‰πãÈó¥ÁöÑ‰∫íÊìç‰ΩúÊÄß, Êé¢Á¥¢ WASI ÁöÑÁõ∏ÂÖ≥Êâ©Â±ï;</li>
</ol>
<h2 id="ÂèÇËÄÉËµÑÊñô-4"><a class="header" href="#ÂèÇËÄÉËµÑÊñô-4">ÂèÇËÄÉËµÑÊñô</a></h2>
<ol>
<li><a href="https://eunomia-bpf.github.io/blog/ebpf-wasm.html">ÂΩì Wasm ÈÅáËßÅ eBPF Ôºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫è</a></li>
<li><a href="https://eunomia-bpf.github.io/blog/lmp-eunomia.html">Â¶Ç‰ΩïÂú® Linux ÊòæÂæÆÈïúÔºàLMPÔºâÈ°πÁõÆ‰∏≠ÂºÄÂêØ eBPF ‰πãÊóÖÔºü</a></li>
<li><a href="https://openanolis.cn/sig/ebpfresearch/doc/640013458629853191">ÈæôËú•Á§æÂå∫ eunomia-bpf È°πÁõÆ‰∏ªÈ°µ</a></li>
<li><a href="https://eunomia-bpf.github.io/">eunomia-bpf È°πÁõÆÊñáÊ°£</a></li>
<li><a href="https://github.com/linuxkerneltravel/lmp">LMP È°πÁõÆ</a></li>
</ol>
<h2 id="Êàë‰ª¨ÁöÑÂæÆ‰ø°Áæ§"><a class="header" href="#Êàë‰ª¨ÁöÑÂæÆ‰ø°Áæ§">Êàë‰ª¨ÁöÑÂæÆ‰ø°Áæ§</a></h2>
<div style="break-before: page; page-break-before: always;"></div><p>#! https://zhuanlan.zhihu.com/p/600638396</p>
<h1 id="eunomia-bpfÂ±ïÊúõ-2023ËÆ©-ebpf-Êèí‰∏ä-wasm-ÁöÑÁøÖËÜÄ"><a class="header" href="#eunomia-bpfÂ±ïÊúõ-2023ËÆ©-ebpf-Êèí‰∏ä-wasm-ÁöÑÁøÖËÜÄ">eunomia-bpfÔºöÂ±ïÊúõ 2023ÔºåËÆ© eBPF Êèí‰∏ä Wasm ÁöÑÁøÖËÜÄ</a></h1>
<p>ÂõûÊúõËøáÂéªÁöÑ 2022 Âπ¥ÔºåÊúâ‰∏§È°πÊäÄÊúØÂ§áÂèóÁû©ÁõÆÔºöeBPF Âíå WebAssembly„ÄÇ</p>
<h2 id="ebpf-ÂÖ®Êñ∞ÁöÑÂèØËÉΩÊÄß"><a class="header" href="#ebpf-ÂÖ®Êñ∞ÁöÑÂèØËÉΩÊÄß">eBPF: ÂÖ®Êñ∞ÁöÑÂèØËÉΩÊÄß</a></h2>
<p>eBPF ÊòØ‰∏ÄÈ°πÈù©ÂëΩÊÄßÁöÑÊäÄÊúØÔºåËµ∑Ê∫ê‰∫éLinuxÂÜÖÊ†∏ÔºåÂèØ‰ª•Âú®Êìç‰ΩúÁ≥ªÁªüÁöÑÂÜÖÊ†∏‰∏≠ËøêË°åÊ≤ôÁõíÁ®ãÂ∫è„ÄÇÂÆÉË¢´Áî®Êù•ÂÆâÂÖ®ÂíåÊúâÊïàÂú∞Êâ©Â±ïÂÜÖÊ†∏ÁöÑÂäüËÉΩÔºåËÄå‰∏çÈúÄË¶ÅÊîπÂèòÂÜÖÊ†∏ÁöÑÊ∫ê‰ª£Á†ÅÊàñÂä†ËΩΩÂÜÖÊ†∏Ê®°Âùó„ÄÇ</p>
<p>ËøáÂéª‰∏ÄÂπ¥‰∏≠ÔºåÂèØËßÇÊµãÊäÄÊúØÂæóÂà∞‰∫ÜÊûÅÂ§ßÂÖ≥Ê≥®Ôºå‰πüË¢´ Gartner Âàó‰∏∫ 2023 Âπ¥ÂçÅÂ§ßÊàòÁï•ÊäÄÊúØË∂ãÂäø‰πã‰∏Ä„ÄÇeBPF Êú¨Ë∫´ÊòØÂØπ‰º†ÁªüËßÇÊµãËÉΩÂäõ‰∏Ä‰∏™ÈùûÂ∏∏Â•ΩÁöÑË°•ÂÖÖÔºåÂú®ÂØπÂÜÖÊ†∏Êó†‰æµÂÖ•ÁöÑÂâçÊèê‰∏ãÔºåÂÆÉÈÄöËøáÂä®ÊÄÅÂú∞ÂêëÂÜÖÊ†∏‰∏≠ÊèíÂÖ•‰∏ÄÊÆµËá™Â∑±ÁöÑ‰ª£Á†ÅÔºåÂÆûÁé∞ÂÆö‰πâÁõëÊéßÂèäË∑üË∏™Á≠âÂ§öÁßçÂ§öÊ†∑ÁöÑËÉΩÂäõ„ÄÇÂêåÊó∂Ôºå eBPF ‰πü‰øÉËøõ‰∫ÜÁΩëÁªúÔºåÂÆâÂÖ®ÊÄßÔºåÂ∫îÁî®Á®ãÂ∫èÈÖçÁΩÆË∑üË∏™ÂíåÊÄßËÉΩÊïÖÈöúÊéíÈô§Á≠âÁ≠âÈ¢ÜÂüüÁöÑÊñ∞‰∏Ä‰ª£Â∑•ÂÖ∑ÁöÑÂºÄÂèëÔºåËøô‰∫õÂ∑•ÂÖ∑‰∏çÂÜç‰æùËµñÁé∞ÊúâÁöÑÂÜÖÊ†∏ÂäüËÉΩÔºåËÄåÊòØÂú®‰∏çÂΩ±ÂìçÊâßË°åÊïàÁéáÊàñÂÆâÂÖ®ÊÄßÁöÑÊÉÖÂÜµ‰∏ã‰∏ªÂä®ÈáçÊñ∞ËøêË°å„ÄÇ</p>
<p>Â¶Ç‰ªäÔºå eBPF Ë¢´ÂπøÊ≥õÂ∫îÁî®Âú®‰∫ëÂéüÁîü„ÄÅÂèØËßÇÊµã„ÄÅÊÄßËÉΩË∞É‰ºò„ÄÅÂÆâÂÖ®„ÄÅÁ°¨‰ª∂Âä†ÈÄüÁ≠âÈ¢ÜÂüüÔºåÂπ∂‰∏îÂÖ∂Â∫îÁî®Âú∫ÊôØËøòÂú®Âø´ÈÄüÊâ©Â±ïÔºåÂêÑÁßçÂú∫ÊôØÂü∫‰∫é eBPF ÊäÄÊúØÁöÑÂàõÊñ∞È°πÁõÆÂëàÁé∞‰∫ïÂñ∑Áé∞Ë±°ÔºåÂØπ‰∫éÊìç‰ΩúÁ≥ªÁªüÁ§æÂå∫ËÄåË®ÄÔºåeBPF ÊäÄÊúØÂ∏¶Êù•‰∫Ü‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑÂèØËÉΩÊÄß‰ª•ÂèäÂπøÈòîÁöÑÂ§©Âú∞Ôºå eBPF ÁöÑÊó∂‰ª£Â∑≤ÁÑ∂Êù•‰∏¥„ÄÇ</p>
<p>ËøáÂéªÁöÑ eBPF summit 2022 ‰∏≠Ôºå„ÄäThe future of eBPF in the Linux Kernel„ÄãÂ±ïÊúõ‰∫Ü eBPF Áõ∏ÂÖ≥ÊäÄÊúØÁöÑÂèëÂ±ïÊñπÂêëÔºåÂÖ∑‰ΩìÁöÑÊºîËøõÊñπÂêëÂèØËÉΩÂåÖÂê´Âá†‰∏™ÊñπÈù¢Ôºö</p>
<ul>
<li>Êõ¥ÂÆåÂ§áÁöÑÁºñÁ®ãËØ≠‰πâÊîØÊåÅÔºöÂΩìÂâç eBPF ÁöÑÁºñÁ®ãËÉΩÂäõÂ≠òÂú®‰∏Ä‰∫õÂ±ÄÈôêÊÄßÔºàÊØîÂ¶Ç‰∏çÊîØÊåÅÂèòÈáèËæπÁïåÁöÑÂæ™ÁéØÔºåÊåá‰ª§Êï∞ÈáèÂèóÈôêÁ≠âÔºâÔºåÊú™Êù•Â∏åÊúõËÉΩËøõ‰∏ÄÊ≠•Êèê‰æõÂõæÁÅµÂÆåÂ§áÁöÑÁºñÁ®ãËÉΩÂäõÔºåÂ¢ûÂº∫ eBPF ÁöÑÂæ™ÁéØ„ÄÅÂÜÖÂ≠òÂàÜÈÖçÁ≠âÂ§öÁßçËØ≠Ë®ÄÁâπÊÄß„ÄÇ</li>
<li>Êõ¥Âº∫ÁöÑÂÆâÂÖ®ÊÄßÔºöÊîØÊåÅÁ±ªÂûãÂÆâÂÖ®ÔºåÂ¢ûÂº∫ËøêË°åÊó∂ VerifierÔºåÂ∏åÊúõ BPF ‰πüËÉΩÊèê‰æõÂ™≤Áæé Rust ÁöÑÂÆâÂÖ®ÁºñÁ®ãËÉΩÂäõÔºå‰ª•ÂèäÂ∞ùËØïÊúâÊ≤°ÊúâÂèØËÉΩÁªìÂêà Rust Âíå BPF ÁöÑÁâπÊÄßÔºåÊèê‰æõÊõ¥Ëøõ‰∏ÄÊ≠•ÁöÑ„ÄÅÂêåÊó∂‰øùËØÅÂèØÁßªÊ§çÂíåÂÆâÂÖ®ÊÄßÁöÑÂÜÖÊ†∏ÂäüËÉΩ„ÄÇ</li>
<li>Êõ¥ÂπøÊ≥õÁöÑÁßªÊ§çËÉΩÂäõÔºöÂ¢ûÂº∫ CO-REÔºåÂä†Âº∫ Helper Êé•Âè£ÂèØÁßªÊ§çËÉΩÂäõÔºåÂÆûÁé∞Ë∑®‰ΩìÁ≥ª„ÄÅÂπ≥Âè∞ÁöÑÁßªÊ§çËÉΩÂäõ„ÄÇ</li>
<li>Êõ¥Âº∫ÁöÑÂÜÖÊ†∏ÂèØÁºñÁ®ãËÉΩÂäõÔºöÊîØÊåÅËÆøÈóÆ/‰øÆÊîπÂÜÖÊ†∏‰ªªÊÑèÂèÇÊï∞„ÄÅËøîÂõûÂÄºÔºåÂÆûÁé∞Êõ¥Âº∫ÁöÑÂÜÖÊ†∏ÁºñÁ®ãËÉΩÂäõÔºåÁîöËá≥‰ΩøÁî® BPF Êù•Â∏ÆÂä©ÊûÑÂª∫ÂíåÂ¢ûÂº∫ÂÜÖÊ†∏Êú¨Ë∫´ÁöÑÂÆâÂÖ®ÊÄß„ÄÇ</li>
</ul>
<h2 id="wasm-ÂºïÈ¢Ü‰∏ã‰∏Ä‰ª£ËÆ°ÁÆóËåÉÂºè"><a class="header" href="#wasm-ÂºïÈ¢Ü‰∏ã‰∏Ä‰ª£ËÆ°ÁÆóËåÉÂºè">Wasm: ÂºïÈ¢Ü‰∏ã‰∏Ä‰ª£ËÆ°ÁÆóËåÉÂºè</a></h2>
<p>Áõ∏ÂØπ‰∫é eBPF ‰∏ªË¶ÅÂÖ≥Ê≥®‰∫éÂÜÖÊ†∏ÊÄÅÊàñËÄÖÂíåÂÜÖÊ†∏Áõ∏ÂÖ≥ÁöÑÂ∫îÁî®ÔºåÁî®Êà∑ÊÄÅÁöÑ WebAssembly ‰πüÊàê‰∏∫‰∫Ü 2022 Âπ¥Êñ∞ÁöÑÁÑ¶ÁÇπ„ÄÇ</p>
<p>WebAssemblyÔºàÁÆÄÁß∞ WasmÔºâÊòØ‰∏Ä‰∏™Ëá™ËØûÁîü‰πãÊó•Ëµ∑Â∞±ÂÖÖÊª°ÊΩúÂäõÁöÑÊäÄÊúØÔºå‰∏ÄÂºÄÂßã‰∏∫‰∫Ü‰∏Ä‰∏™ÂèØÁßªÊ§çÁöÑÁõÆÊ†áËÄåËÆæËÆ°ÁöÑ‰∏ÄÁßçÁ±ª‰ººÊ±áÁºñÂ≠óËäÇÁ†ÅÁöÑÊåá‰ª§Ê†ºÂºèÊ†áÂáÜÔºåÂèØÁî®‰∫éÁºñËØëC/C+/RUSTÁ≠âÈ´òÁ∫ßËØ≠Ë®ÄÔºå‰ΩøÂÆ¢Êà∑Á´ØÂíåÊúçÂä°Âô®Â∫îÁî®Á®ãÂ∫èËÉΩÂ§üÂú®ÊµèËßàÂô®‰∏äÈÉ®ÁΩ≤ÔºõÊó∂Ëá≥‰ªäÊó•ÔºåWebAssembly Ê≠£Âú®Ê≤øÁùÄÂÖ∂ÂêçÂ≠ó‰∏≠ Web Âíå Assembly ‰∏§‰∏™È¢ÜÂüü‰πãÂ§ñÁöÑÊñπÂêëÂèëÂ±ïÔºå‰ΩøÁî®‰∏é Wasm ÂÖºÂÆπÁöÑËøêË°åÊó∂ÔºåWasm Êñá‰ª∂ÂèØ‰ª•Âú®ÂÆ¢Êà∑Á´ØÂíåÊúçÂä°Âô®Á´ØÊâßË°åÔºå‰ªé &quot;JavaScript ÊùÄÊâã&quot; Âà∞ &quot;‰∫ëËÆ°ÁÆóÁöÑ‰∏ã‰∏Ä‰∏™ÂâçÊ≤øÊñπÂêë&quot; Âá†‰πéË¶ÜÁõñ‰∫ÜÂÖ®ÈÉ®Êñ∞ÂÖ¥È¢ÜÂüüÔºåÂêåÊó∂Âú®‰ªé‰∫ëËÆ°ÁÆó„ÄÅserverless ÂêëËæπÁºòËÆ°ÁÆóÊ∏óÈÄèÔºåWasm Â∑≤ÁªèËøúËøúË∂ÖÂá∫‰∫ÜËµ∑‰Ωú‰∏∫Á¨¨ÂõõÁßç Web Ê†áÂáÜËØ≠Ë®ÄÁöÑËßíËâ≤„ÄÇÁîöËá≥ÈáçÊñ∞ÂÆö‰πâ‰∫ÜÂ∫îÁî®ËΩØ‰ª∂ÁöÑÂºÄÂèëÊ®°ÂºèÔºåÊ≠£ÈÄêÊ∏êÊé•ËøëÂÖ∂ ‚Äú‰∏ÄÊ¨°ÁºñÂÜôÔºåÈöèÂ§ÑËøêË°å‚Äù ÁöÑÊÑøÊôØ„ÄÇ</p>
<p>Wasm ÊúâÂá†‰∏™ÂÖ≥ÈîÆÁöÑËÆæËÆ°ÁõÆÊ†á‰ΩøÂÖ∂Âá∫ÁîüÂºÄÂßãÂ∞±Ëá™Â∏¶‰ª§‰∫∫‰∫ÆÁúºÁöÑÂÖ≥Ê≥®Ôºö</p>
<ul>
<li>ÂèØÁßªÊ§çÔºöWasm Ë¢´ËÆæËÆ°‰∏∫ÈíàÂØπ‰ΩéÁ∫ßËôöÊãüÊú∫Êû∂ÊûÑÔºåÂÖ∂Êåá‰ª§Áî±Áâ©ÁêÜÊú∫ÂçïÁã¨ÁøªËØëÊàêÊú∫Âô®‰ª£Á†Å„ÄÇËøôÊÑèÂë≥ÁùÄ Wasm ‰∫åËøõÂà∂Êñá‰ª∂ÊúÄÁªàÂèØ‰ª•Âú®ÂêÑÁßçÊìç‰ΩúÁ≥ªÁªüÂíåËäØÁâáÊû∂ÊûÑ‰∏äËøêË°å ‚Äî‚Äî Êó†ËÆ∫ÊòØÂú®ËøêË°å X86 Á¨îËÆ∞Êú¨ÁîµËÑëÁöÑÊµèËßàÂô®‰∏≠ÔºåËøòÊòØÂú®ÂÜÖÈÉ®Êàñ‰∫ëÁ´ØÁöÑÊúçÂä°Âô®‰∏äÔºåÂú®ÁßªÂä®ËÆæÂ§á„ÄÅÁâ©ËÅîÁΩëËÆæÂ§á‰∏äÁ≠âÁ≠â„ÄÇ</li>
<li>Â§öËØ≠Ë®ÄÔºöÂõ†‰∏∫ Wasm ÊòØ‰∏Ä‰∏™ÁºñËØëÁõÆÊ†áÔºåÁî®‰∫éÁºñÁ®ãÊ®°ÂùóÁöÑÂÖ∑‰ΩìËØ≠Ë®ÄÂπ∂‰∏çÈáçË¶ÅÔºåÈáçË¶ÅÁöÑÊòØÊòØÂê¶ÊúâÊîØÊåÅÂ∞ÜËØ•ËØ≠Ë®ÄÁºñËØëÂà∞ Wasm„ÄÇÂºÄÂèë‰∫∫ÂëòÂèØ‰ª•ÁÅµÊ¥ªÂú∞‰ΩøÁî®Â§öÁßçËØ≠Ë®ÄÔºàÂ¶Ç C„ÄÅC++„ÄÅRust„ÄÅÂáπËØ≠Ë®ÄÁ≠âÔºâÊù•ÊûÑÂª∫‰∫åËøõÂà∂Êñá‰ª∂ÔºåÂπ∂‰∫´Âèó Wasm Â∏¶Êù•ÁöÑÁ∫¢Âà©„ÄÇ</li>
<li>ËΩªÈáèÂíåÈ´òÊïàÔºö‰Ωú‰∏∫‰∏Ä‰∏™‰ΩéÁ∫ßÂà´ÁöÑ‰∫åËøõÂà∂Êåá‰ª§Ê†ºÂºèÔºåÂè™ÈúÄË¶ÅËæÉÂ∞ëÁöÑÊìç‰ΩúÊù•Â∞Ü Wasm ÁøªËØëÊàê‰ºòÂåñÁöÑÊú∫Âô®‰ª£Á†Å„ÄÇ</li>
<li>ÂÆâÂÖ®ÔºöWasm ÁõÆÊ†á‰πã‰∏ÄÊòØÂÆâÂÖ®ÔºåÂÆÉÂú®‰∏Ä‰∏™Ê≤ôÁõíÁéØÂ¢É‰∏≠ÊâßË°åÔºåÂØπ‰∏ªÊú∫ËøêË°åÊó∂Ê≤°ÊúâÂàùÂßãÂèØËßÅÊÄß„ÄÇËøôÊÑèÂë≥ÁùÄÂØπÁ≥ªÁªüËµÑÊ∫êÔºàÂ¶ÇÊñá‰ª∂Á≥ªÁªüÔºåÁ°¨‰ª∂Á≠âÔºâÁöÑËÆøÈóÆÊòØÂèóÈôêÂà∂ÁöÑÔºåÈô§ÈùûÊòéÁ°ÆÂØºÂÖ•‰∫ÜÂØπÂ∫îÁöÑÂáΩÊï∞‰ª•ÊîØÊåÅ„ÄÇÂõ†Ê≠§ Wasm ÊûÅÂ§ßÈôêÂà∂‰∫ÜÊîªÂáªÈù¢ÔºåÂÆûÁé∞‰∫ÜÂ§öÁßüÊà∑ÁéØÂ¢É‰∏≠‰∏çÂèó‰ø°‰ªªÁöÑ‰ª£Á†ÅÂÆâÂÖ®ÂèóÈôêÂú∞ÊâßË°å„ÄÇ</li>
</ul>
<p>ËøáÂéªÁöÑ 2022 Âπ¥ Wasm ÂèñÂæó‰∫Ü‰∏çÂ∞ëÊøÄÂä®‰∫∫ÂøÉÁöÑÊàêÂ∞±ÔºåËÆ∏Â§öÊñ∞ÁöÑ Wasm ÂàùÂàõÂÖ¨Âè∏Ê∂åÁé∞ÔºåËÄÅÁâå‰∫ëÊúçÂä°ÂïÜÂíåÂÖ¨Âè∏ÂÆ£Â∏ÉÊîØÊåÅ WasmÔºåÂ≠óËäÇÁ†ÅËÅîÁõüÊé®Âá∫‰∫ÜËÆ∏Â§öÊñ∞ÁöÑ Wasm Ê†áÂáÜÔºåCNCF‰∏ªÂäû‰∫Ü‰∏§Ê¨° WasmDay Ê¥ªÂä®ÔºåËÄå Wasm ÊúÄÂ§ßÁöÑÁî®Êà∑‰πã‰∏Ä Figma Ë¢´ Adobe ‰ª•ÊÉä‰∫∫ÁöÑ 200 ‰∫øÁæéÂÖÉÊî∂Ë¥≠„ÄÇÂØπ‰∫é WebAssembly ËÄåË®ÄÔºå2023 Âπ¥ÂæàÊúâÂèØËÉΩ‰πü‰ºöÊòØÁàÜÂèëÁöÑ‰∏ÄÂπ¥Ôºö</p>
<ul>
<li>ÁªÑ‰ª∂Ê®°ÂûãÊèèËø∞‰∫ÜWasm‰∫åËøõÂà∂Êñá‰ª∂Áõ∏‰∫í‰∫§‰∫íÁöÑÊñπÂºèÔºåÊ≠£Âú®ËøÖÈÄüÊàêÁÜüÔºåÂ∑≤ÁªèÂá∫Áé∞‰∫ÜÂèÇËÄÉÂÆûÁé∞„ÄÇÂºÄÂèë‰∫∫ÂëòÂèØ‰ª•Â£∞Êòé‰ªñ‰ª¨ÁöÑÂ∫îÁî®Á®ãÂ∫èÈúÄË¶ÅÂì™‰∫õÁªÑ‰ª∂ÔºåÊàñËÄÖÊõ¥ÊäΩË±°Âú∞ËØ¥Ôºå‰ªñ‰ª¨ÁöÑÂ∫îÁî®ÈúÄË¶ÅÂì™‰∫õÂäüËÉΩÔºàËÄå‰∏çÊòØÁî®‰ªñ‰ª¨È¶ñÈÄâÁöÑÊ∫êËØ≠Ë®ÄÊü•ÊâæÂ∫ìÔºâÔºåÁÑ∂ÂêéWasmËøêË°åÊó∂ÂèØ‰ª•‰ª£Ë°®Áî®Êà∑ÁªÑË£ÖÊ≠£Á°ÆÁöÑÁªÑ‰ª∂ÈõÜ„ÄÇ2023 Âπ¥Â∞ÜÊòØÁªÑ‰ª∂Ê®°ÂûãÂºÄÂßãÈáçÊñ∞ÂÆö‰πâÊàë‰ª¨Â¶Ç‰ΩïÁºñÂÜôËΩØ‰ª∂ÁöÑ‰∏ÄÂπ¥„ÄÇ</li>
<li>WasmÊîπÂèò‰∫ÜÊó†ÊúçÂä°Âô®ÁéØÂ¢ÉÁöÑÊΩúÂäõ„ÄÇÁî±‰∫éÂá†‰πéÂç≥Êó∂ÁöÑÂêØÂä®Êó∂Èó¥„ÄÅËæÉÂ∞èÁöÑ‰∫åËøõÂà∂Êñá‰ª∂Â§ßÂ∞è‰ª•ÂèäÂπ≥Âè∞ÂíåÊû∂ÊûÑ‰∏≠Á´ãÊÄßÔºåWasm‰∫åËøõÂà∂Êñá‰ª∂ÂèØ‰ª•Áî®ËøêË°åÂΩì‰ªäÊó†ÊúçÂä°Âô®Âü∫Á°ÄËÆæÊñΩÊâÄÈúÄÁöÑ‰∏ÄÂ∞èÈÉ®ÂàÜËµÑÊ∫êÊù•ÊâßË°å„ÄÇ</li>
<li>2022Âπ¥Â∫ïÔºåOCI RegistryÂ∑•‰ΩúÁªÑÂÆ£Â∏É‰∫Ü‰∏ÄÁßçÂ≠òÂÇ®ÂÆπÂô®ÈïúÂÉè‰ª•Â§ñÁöÑÂÖ∂‰ªñÂÜÖÂÆπÁöÑÂÆòÊñπÊñπÂºè„ÄÇËøôÂèØËÉΩÂåÖÊã¨HelmÂõæË°®„ÄÅÁÖßÁâáÊàñWasmÂ∫îÁî®Á®ãÂ∫è„ÄÇËøô‰∏™Êñ∞ÂäüËÉΩË¢´Áß∞‰∏∫‚ÄúÂ∑•‰ª∂Â≠òÂÇ®‚Äù„ÄÇ</li>
<li>ÊâÄÊúâÂ§ßÂûãÁºñÁ®ãËØ≠Ë®ÄÈÉΩÂ∞ÜÂæóÂà∞WasmÊîØÊåÅÔºöWasm GCÊèêÊ°àÂæàÂèØËÉΩÂú® 2023 Âπ¥ÂàùÂ∞±ËÉΩÂèØÁî®Âπ∂ÂæóÂà∞ÊîØÊåÅÔºåÂõ†Ê≠§ Kotlin Âíå Dart Â∞ÜÂæàÂø´ÂèëÂ∏ÉWasmÁºñËØëÂô®ÔºåJava ‰πüÂæàÂèØËÉΩÂ∞ÜÊàê‰∏∫ÊúÄÊµÅË°åÁöÑ Wasm ÂºÄÂèëËØ≠Ë®Ä„ÄÇ</li>
</ul>
<h2 id="coolbpf--eunomia-bpf--eunomia-lcc"><a class="header" href="#coolbpf--eunomia-bpf--eunomia-lcc">Coolbpf + eunomia-bpf = eunomia-lcc</a></h2>
<p>Âú®ËøáÂéªÁöÑ‰∏ÄÂπ¥‰∏≠ÔºåÈòøÈáå‰∫ëÈæôËú•Á§æÂå∫Á≥ªÁªüËøêÁª¥SIGÔºàSpecial Interest GroupÔºâ Ê≠£ÂºèÂºÄÊ∫ê‰∫Ü Coolbpf È°πÁõÆ„ÄÇCoolbpf ‰ª• CO-REÔºàCompile Once-Run EverywhereÔºâ‰∏∫Âü∫Á°ÄÂÆûÁé∞Ôºå‰øùÁïô‰∫ÜËµÑÊ∫êÂç†Áî®‰Ωé„ÄÅÂèØÁßªÊ§çÊÄßÂº∫Á≠â‰ºòÁÇπÔºåËûçÂêà‰∫ÜBCCÂä®ÊÄÅÁºñËØëÁâπÊÄßÔºåÈÄöËøáËøúÁ®ãÊúçÂä°ËÉΩÂäõÔºåÊûÅÂ§ßÁÆÄÂåñÂºÄÂèëÁºñËØëÂíåËøêË°åÊïàÁéáÔºåÈÄÇÂêàÂú®Áîü‰∫ßÁéØÂ¢ÉÊâπÈáèÈÉ®ÁΩ≤Â∫îÁî®„ÄÇCoolbpf ËøòÊîØÊåÅÂú®Ê≤°Êúâ eBPF ÁâπÊÄßÁöÑ‰ΩéÂÜÖÊ†∏ÁâàÊú¨‰∏äÔºåÈÄöËøáÊèê‰æõÁöÑ eBPF È©±Âä®ÔºåÂ∏ÆÂä©ÂÆÉÂÆâÂÖ®ÁöÑÂú®‰ΩéÁâàÊú¨‰∏äËøêË°åÔºå‰ªéÂÜÖÊ†∏ÊÄÅÂíåÊâπÈáèÈÉ®ÁΩ≤‰∏§‰∏™ËßíÂ∫¶ÂÖÖÂàÜÂ¢ûÂº∫‰∫Ü eBPF Á®ãÂ∫è&quot;‰∏ÄÊ¨°ÁºñËØëÔºåÂà∞Â§ÑËøêË°å‚Äù ÁöÑËÉΩÂäõ„ÄÇ</p>
<p>eunomia-bpf ‰πüÊòØ‰∏Ä‰∏™ÁªìÂêà Wasm ÁöÑÈÄöÁî®„ÄÅËΩªÈáèÁ∫ß„ÄÅÂ§öËØ≠Ë®ÄÁöÑ‰∏ã‰∏Ä‰ª£ eBPF ÂºÄÂèëÊ°ÜÊû∂/ÁªÑ‰ª∂Â∫ìÔºå2022 Âπ¥‰∏ãÂçäÂπ¥Âú®ÈæôËú•Á§æÂå∫ <code>eBPF ÊäÄÊúØÊé¢Á¥¢ SIG</code> [3] [5] ÂèëËµ∑Âπ∂Â≠µÂåñ„ÄÇeunomia-bpf ÂåÖÂê´‰∏Ä‰∏™ËøêË°åÊó∂ÂíåÁºñËØëÂ∑•ÂÖ∑ÈìæÔºå‰∏ªË¶ÅÂÖ≥Ê≥®‰∫éÊîπËøõ eBPF Á®ãÂ∫èÁî®Êà∑ÊÄÅÁöÑÂºÄÂèëÂíå‰ΩøÁî®‰ΩìÈ™åÔºå‰∏ªË¶ÅÊúâ‰∏â‰∏™ÁâπÊÄßÔºö</p>
<ol>
<li>Âè™ÈúÄÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÂç≥ÂèØËøêË°å eBPF Á®ãÂ∫èÔºåÂÜÖÊ†∏ÊÄÅÂâçÁ´ØÂÆåÂÖ®ÂÖºÂÆπ bcc„ÄÅÂéüÁîü libbpf Á≠âÂ§öÁßçËØ≠Ê≥ïÔºåÂèØ‰ª•Èôç‰Ωé eBPF ÂºÄÂèëÁöÑÂ≠¶‰π†ÊàêÊú¨ÔºåÊèêÈ´òÂºÄÂèëÊïàÁéáÔºõ</li>
<li>ÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂ÂÆåÂÖ®ÂàÜÁ¶ªÔºå‰øùËØÅ‰∏çÂêåÁâàÊú¨ÁºñËØëÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂‰πãÈó¥ÁöÑÂÖºÂÆπÊÄßÔºå‰ª• CO-REÔºà‰∏ÄÊ¨°ÁºñËØë„ÄÅÂà∞Â§ÑËøêË°åÔºâÁöÑÊñπÂºèÂä†ËΩΩÔºåÈôç‰ΩéÈÉ®ÁΩ≤Âíå‰ΩøÁî®ÁöÑËµÑÊ∫êÊ∂àËÄóÔºõËøòÂèØ‰ª•ËÆ© BCC/bpftrace Á±ªÂûãÁöÑ‰ª£Á†Å‰πüÊîØÊåÅ AOT ÁºñËØëÔºåÂú®Âä†ËΩΩÁöÑÁöÑÊó∂ÂÄô‰∏ç‰æùËµñ llvm Á≠âÂ∫ìÔºåÂêåÊó∂‰øùÁïô bpftrace Á±ª‰ººËÑöÊú¨‰∏ÄÊ†∑ÁöÑÁÆÄÂçï‰ΩøÁî®ÊñπÂºèÔºõ</li>
<li>Áî®Êà∑ÊÄÅ‰πüÊîØÊåÅÂ§öÁßçËØ≠Ë®ÄÔºå‰æãÂ¶Ç C++/C/Rust Á≠âÔºåÂèØ‰ª•‰ΩøÁî®Â§öÁßçËØ≠Ë®ÄÂú® Wasm ‰∏≠ÂºÄÂèë eBPF ÁöÑÁî®Êà∑ÊÄÅÁ®ãÂ∫èÔºåÂπ∂‰∏î‰ª• Wasm Ê®°ÂùóÔºåÊàñËÄÖ JSON/YAML ÈÖçÁΩÆÊñá‰ª∂ÁöÑÊñπÂºèÂàÜÂèëÂíåÂä®ÊÄÅÂä†ËΩΩ eBPF Á®ãÂ∫èÔºåÂêåÊó∂‰ª• Wasm OCI ÈïúÂÉèÁöÑÂΩ¢ÂºèÂ≠òÂÇ®ÂíåÁÆ°ÁêÜ‰ªªÊÑèÂåÖÂê´Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅÁöÑ eBPF Â∫îÁî®„ÄÇ</li>
</ol>
<p>eunomia-bpf Â∏åÊúõÊàê‰∏∫‰∏Ä‰∏™‰ª•Á±ªÂ∫ìÊàñËÄÖÊùæÊï£ÁªÑÂêàÁöÑÊ°ÜÊû∂ÁöÑÊñπÂºèÊèê‰æõÔºåÂú®ÁºñËØëÊûÑÂª∫ÂíåÂàÜÂèëËøêË°å eBPF Á®ãÂ∫èÊñπÈù¢ÂÅöÊõ¥Â§öÁöÑÊé¢Á¥¢Â∑•‰ΩúÔºåËÆ©ÂÖ∂‰ªñÂÖ¨Âè∏Âíå‰∏™‰∫∫ÔºåÊÉ≥Ë¶ÅÂü∫‰∫éËá™Â∑±ÁöÑÂÜÖÊ†∏ÊÄÅ ebpf Âü∫Á°ÄËÆæÊñΩÔºåÊê≠Âª∫‰∏Ä‰∏™Á±ª‰ººÁöÑÁî®Êà∑ÊÄÅÂºÄÂèëËøêË°åÁéØÂ¢ÉÔºåÊàñËÄÖÂÆåÊï¥ÁöÑÂºÄÂèëÂπ≥Âè∞„ÄÅÊèí‰ª∂ËøêË°åÊó∂ÔºåÂèòÂæóÊõ¥ÂÆπÊòìÂæàÂ§ö„ÄÇ</p>
<p>Âú® 2022 Âπ¥Â∫ïÔºåÊàë‰ª¨Â∞ùËØïÂ∞Ü Coolbpf Âíå eunomia-bpf ÁªìÂêàËµ∑Êù•ÔºåÂÄüÂä© Coolbpf Êèê‰æõÁöÑ‰ΩéÂÜÖÊ†∏ÁâàÊú¨ÊîØÊåÅÁöÑÂÜÖÊ†∏ÊÄÅÂü∫Á°ÄËÆæÊñΩÔºå‰ª•ÂèäÊâπÈáèÈÉ®ÁΩ≤Â∫îÁî®ÁöÑËÉΩÂäõÔºå‰ª•Âèä eunomia-bpf Êèê‰æõÁöÑÁªìÂêà Wasm ÁöÑÁî®Êà∑ÊÄÅÂºÄÂèë„ÄÅÂàÜÂèëÁâπÊÄßÔºåÂú® Coolbpf ÁöÑÂ§ßÊ°ÜÊû∂‰∏ãÂàõÂª∫‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑ eBPF Áî®Êà∑ÊÄÅÂºÄÂèëÂ∫ìÔºö<a href="https://gitee.com/anolis/coolbpf/pulls/17">eunomia-lcc</a>ÔºåÂ∏åÊúõËÆ© Coolbpf ‰πüËÉΩÔºö</p>
<ul>
<li>Âú®ÁºñÂÜô eBPF Á®ãÂ∫èÊàñÂ∑•ÂÖ∑Êó∂Âè™ÁºñÂÜôÂÜÖÊ†∏ÊÄÅ‰ª£Á†ÅÔºåÂ∞±ËÉΩËá™Âä®Ëé∑ÂèñÂÜÖÊ†∏ÊÄÅÂØºÂá∫‰ø°ÊÅØÔºåËá™Âä®ÁîüÊàêÂëΩ‰ª§Ë°åÂèÇÊï∞„ÄÅÁõ¥ÊñπÂõæËæìÂá∫Á≠âÔºõ</li>
<li>‰ΩøÁî® Wasm ËøõË°åÁî®Êà∑ÊÄÅ‰∫§‰∫íÁ®ãÂ∫èÁöÑÂºÄÂèëÔºåÂú® Wasm ËôöÊãüÊú∫ÂÜÖÈÉ®ÊéßÂà∂Êï¥‰∏™ eBPF Á®ãÂ∫èÁöÑÂä†ËΩΩÂíåÊâßË°åÔºå‰ª•ÂèäÂ§ÑÁêÜ eBPF ‰∏äÊä•ÁöÑÊï∞ÊçÆÔºõ</li>
<li>ÂèØ‰ª•Â∞ÜÈ¢ÑÁºñËØëÁöÑ eBPF Á®ãÂ∫èÊâìÂåÖ‰∏∫ÈÄöÁî®ÁöÑ JSON Êàñ Wasm Ê®°ÂùóÔºåË∑®Êû∂ÊûÑÂíåÂÜÖÊ†∏ÁâàÊú¨ËøõË°åÂàÜÂèëÔºåÊó†ÈúÄÈáçÊñ∞ÁºñËØëÂç≥ÂèØÂä®ÊÄÅÂä†ËΩΩËøêË°å„ÄÇ</li>
</ul>
<p>ÂêåÊó∂ËøòËÉΩ‰øùÁïô Coolbpf ÁöÑ‰ΩéÁâàÊú¨ÂÖºÂÆπ„ÄÅBTF Ëá™Âä®Ëé∑Âèñ„ÄÅËøúÁ®ãÁºñËØëÁ≠âÁâπÊÄßÔºåËÆ© eBPF Á®ãÂ∫èÁöÑÂºÄÂèëÊõ¥Âä†ÁÆÄ‰æøÊòìË°å„ÄÇ</p>
<p>Â±ïÊúõÊú™Êù•Ôºåeunomia-bpf ÁöÑÂõ¢ÈòüÂú® 2023 Âπ¥‰πüÂ∏åÊúõÂ∞ùËØïÊé¢Á¥¢„ÄÅÊîπËøõ„ÄÅÂÆåÂñÑ eBPF Á®ãÂ∫èÂºÄÂèë„ÄÅÁºñËØë„ÄÅÊâìÂåÖ„ÄÅÂèëÂ∏É„ÄÅÂÆâË£Ö„ÄÅÂçáÁ∫ßÁ≠âÁöÑÊµÅÁ®ãÂíåÂ∑•ÂÖ∑„ÄÅSDKÔºåÂπ∂ÁßØÊûÅÂêë‰∏äÊ∏∏Á§æÂå∫ÂèçÈ¶àÔºåËøõ‰∏ÄÊ≠•Â¢ûÂº∫ eBPF ÁöÑÁºñÁ®ã‰ΩìÈ™åÂíåËØ≠Ë®ÄËÉΩÂäõÔºõ‰ª•ÂèäÊõ¥Ëøõ‰∏ÄÊ≠•Âú∞Âíå WebAssembly Áõ∏ÁªìÂêàÔºåÂú®ÂèØËßÇÊµãÊÄß„ÄÅserverless„ÄÅÂèØÁºñÁ®ãÂÜÖÊ†∏Á≠âËØ∏Â§öÊñπÈù¢ÂÅöÊõ¥Â§öÁöÑÊé¢Á¥¢ÂíåÂÆûË∑µÔºåÊúùÁùÄÂõæÁÅµÂÆåÂ§áÂíåÊõ¥ÂÆåÂñÑÁöÑËØ≠Ë®ÄÊîØÊåÅËøàËøõ„ÄÇ</p>
<h2 id="ÂèÇËÄÉËµÑÊñô-5"><a class="header" href="#ÂèÇËÄÉËµÑÊñô-5">ÂèÇËÄÉËµÑÊñô</a></h2>
<ol>
<li>Wasm Â∞ÜÂºïÈ¢Ü‰∏ã‰∏Ä‰ª£ËÆ°ÁÆóËåÉÂºè [ËØë]Ôºö<a href="https://www.oschina.net/news/214580">https://www.oschina.net/news/214580</a></li>
<li>WebAssemblyÔºö2023Âπ¥ÁöÑ5‰∏™È¢ÑÊµã: <a href="https://www.sohu.com/a/626985661_121119003">https://www.sohu.com/a/626985661_121119003</a></li>
<li>eBPF ÊäÄÊúØÊé¢Á¥¢ SIG ‰∏ªÈ°µÔºö <a href="https://openanolis.cn/sig/ebpfresearch">https://openanolis.cn/sig/ebpfresearch</a></li>
<li>Coolbpf È°πÁõÆÂºÄÊ∫ê‰ªìÂ∫ì: <a href="https://gitee.com/anolis/coolbpf">https://gitee.com/anolis/coolbpf</a></li>
<li>eunomia-bpf ÈæôËú•Á§æÂå∫ÈïúÂÉè‰ªìÂ∫ìÔºö<a href="https://gitee.com/anolis/eunomia">https://gitee.com/anolis/eunomia</a></li>
<li>eunomia-bpf Github ‰ªìÂ∫ìÔºö<a href="https://github.com/eunomia-bpf/eunomia-bpf">https://github.com/eunomia-bpf/eunomia-bpf</a></li>
<li>ÂΩì Wasm ÈÅáËßÅ eBPFÔºö‰ΩøÁî® WebAssembly ÁºñÂÜô„ÄÅÂàÜÂèë„ÄÅÂä†ËΩΩËøêË°å eBPF Á®ãÂ∫è | ÈæôËú•ÊäÄÊúØ: <a href="https://developer.aliyun.com/article/1050439">https://developer.aliyun.com/article/1050439</a></li>
<li>2023ÔºåÂèØËßÇÊµãÊÄßÈúÄÊ±ÇÂ∞ÜËøéÊù•‚ÄúÁàÜÂèë‰πãÂπ¥‚ÄùÔºü<a href="https://36kr.com/p/dp2063589382737542">https://36kr.com/p/dp2063589382737542</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ebpf-ËøõÈò∂-ÂÜÖÊ†∏Êñ∞ÁâπÊÄßËøõÂ±ï‰∏ÄËßà"><a class="header" href="#ebpf-ËøõÈò∂-ÂÜÖÊ†∏Êñ∞ÁâπÊÄßËøõÂ±ï‰∏ÄËßà">eBPF ËøõÈò∂: ÂÜÖÊ†∏Êñ∞ÁâπÊÄßËøõÂ±ï‰∏ÄËßà</a></h1>
<p>Linux ÂÜÖÊ†∏Âú® 2022 Âπ¥‰∏ªË¶ÅÂèëÂ∏É‰∫Ü 5.16-5.19 ‰ª•Âèä 6.0 Âíå 6.1 ËøôÂá†‰∏™ÁâàÊú¨ÔºåÊØè‰∏™ÁâàÊú¨ÈÉΩ‰∏∫ eBPF ÂºïÂÖ•‰∫ÜÂ§ßÈáèÁöÑÊñ∞ÁâπÊÄß„ÄÇÊú¨ÊñáÂ∞ÜÂØπËøô‰∫õÊñ∞ÁâπÊÄßËøõË°å‰∏ÄÁÇπÁÆÄË¶ÅÁöÑ‰ªãÁªçÔºåÊõ¥ËØ¶ÁªÜÁöÑËµÑÊñôËØ∑ÂèÇËÄÉÂØπÂ∫îÁöÑÈìæÊé•‰ø°ÊÅØ„ÄÇÊÄª‰ΩìËÄåË®ÄÔºåeBPF Âú®ÂÜÖÊ†∏‰∏≠‰æùÁÑ∂ÊòØÊúÄÊ¥ªË∑ÉÁöÑÊ®°Âùó‰πã‰∏ÄÔºåÂÆÉÁöÑÂäüËÉΩÁâπÊÄß‰πüËøòÂú®È´òÈÄüÂèëÂ±ï‰∏≠„ÄÇÊüêÁßçÊÑè‰πâ‰∏äËØ¥ÔºåeBPF Ê≠£ÊúùÁùÄ‰∏Ä‰∏™ÂÆåÂ§áÁöÑÂÜÖÊ†∏ÊÄÅÂèØÁºñÁ®ãÊé•Âè£Âø´ÈÄüËøõÂåñ„ÄÇ</p>
<!-- TOC -->
<ul>
<li><a href="blog/bpf-news.html#ebpf-%E8%BF%9B%E9%98%B6-%E5%86%85%E6%A0%B8%E6%96%B0%E7%89%B9%E6%80%A7%E8%BF%9B%E5%B1%95%E4%B8%80%E8%A7%88">eBPF ËøõÈò∂: ÂÜÖÊ†∏Êñ∞ÁâπÊÄßËøõÂ±ï‰∏ÄËßà</a>
<ul>
<li><a href="blog/bpf-news.html#bpf-kfuncs">BPF kfuncs</a></li>
<li><a href="blog/bpf-news.html#bloom-filter-map516">Bloom Filter MapÔºö5.16</a></li>
<li><a href="blog/bpf-news.html#compile-once--run-everywherelinux-517">Compile Once ‚Äì Run EverywhereÔºöLinux 5.17</a></li>
<li><a href="blog/bpf-news.html#bpf_loop-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0517">bpf_loop() ËæÖÂä©ÂáΩÊï∞Ôºö5.17</a></li>
<li><a href="blog/bpf-news.html#bpf_link_type_kprobe_multi518">BPF_LINK_TYPE_KPROBE_MULTIÔºö5.18</a></li>
<li><a href="blog/bpf-news.html#%E5%8A%A8%E6%80%81%E6%8C%87%E9%92%88%E5%92%8C%E7%B1%BB%E5%9E%8B%E6%8C%87%E9%92%88519">Âä®ÊÄÅÊåáÈíàÂíåÁ±ªÂûãÊåáÈíàÔºö5.19</a></li>
<li><a href="blog/bpf-news.html#usdt519">USDTÔºö5.19</a></li>
<li><a href="blog/bpf-news.html#bpf-panic61">bpf panicÔºö6.1</a></li>
<li><a href="blog/bpf-news.html#bpf-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8%E9%93%BE%E8%A1%A861">BPF ÂÜÖÂ≠òÂàÜÈÖçÂô®„ÄÅÈìæË°®Ôºö6.1</a></li>
<li><a href="blog/bpf-news.html#user-ring-buffer-61">user ring buffer 6.1</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="bpf-kfuncs"><a class="header" href="#bpf-kfuncs">BPF kfuncs</a></h2>
<p>BPFÂ≠êÁ≥ªÁªüÊö¥Èú≤‰∫ÜÂÜÖÊ†∏ÂÜÖÈÉ®ÁÆóÊ≥ïÂíåÊï∞ÊçÆÁªìÊûÑÁöÑËÆ∏Â§öÊñπÈù¢ÔºõËøôËá™ÁÑ∂ÂØºËá¥‰∫ÜÂØπÂú®ÂÜÖÊ†∏ÂèòÂåñÊó∂‰øùÊåÅÊé•Âè£Á®≥ÂÆöÊÄßÁöÑÂÖ≥Ê≥®„ÄÇÈïøÊúü‰ª•Êù•ÔºåBPFÂØπÁî®Êà∑Á©∫Èó¥‰∏çÊèê‰æõÊé•Âè£Á®≥ÂÆöÊÄß‰øùËØÅÁöÑÁ´ãÂú∫‰ºº‰πé‰∏ÄÁõ¥ÊúâÁÇπÈóÆÈ¢òÔºõËøáÂéªÔºåÂÜÖÊ†∏ÂºÄÂèëËÄÖÂèëÁé∞‰ªñ‰ª¨‰∏çÂæó‰∏çÁª¥Êä§ÈÇ£‰∫õ‰∏çÊâìÁÆóÁ®≥ÂÆöÁöÑÊé•Âè£„ÄÇÁé∞Âú®BPFÁ§æÂå∫ÂºÄÂßãËÄÉËôëËá≥Â∞ë‰∏∫ÂÆÉÁöÑ‰∏Ä‰∫õÊé•Âè£Êèê‰æõÊòéÁ°ÆÁöÑÁ®≥ÂÆöÊÄßÊâøËØ∫ÂèØËÉΩÊÑèÂë≥ÁùÄ‰ªÄ‰πà„ÄÇ</p>
<p>BPFÂÖÅËÆ∏Áî±Áî®Êà∑Á©∫Èó¥Âä†ËΩΩÁöÑÁ®ãÂ∫èË¢´ÈôÑÂä†Âà∞Â§ßÈáèÈí©Â≠ê‰∏≠ÁöÑ‰ªª‰Ωï‰∏Ä‰∏™ÔºåÂπ∂Âú®ÂÜÖÊ†∏‰∏≠ËøêË°å--Âú®Â≠êÁ≥ªÁªüÁöÑÈ™åËØÅÂô®ÂæóÂá∫Ëøô‰∫õÁ®ãÂ∫è‰∏ç‰ºöÊçüÂÆ≥Á≥ªÁªüÁöÑÁªìËÆ∫‰πãÂêé„ÄÇ‰∏Ä‰∏™Á®ãÂ∫èÂ∞ÜËé∑ÂæóÁî±ÂÆÉÊâÄËøûÊé•ÁöÑÈí©Â≠êÊèê‰æõÁªôÂÆÉÁöÑÂÜÖÊ†∏Êï∞ÊçÆÁªìÊûÑÁöÑËÆøÈóÆÊùÉ„ÄÇÂú®Êüê‰∫õÊÉÖÂÜµ‰∏ãÔºåÁ®ãÂ∫èÂèØ‰ª•Áõ¥Êé•‰øÆÊîπËøô‰∫õÊï∞ÊçÆÔºå‰ªéËÄåÁõ¥Êé•ÂΩ±ÂìçÂÜÖÊ†∏ÁöÑËøêË°åÔºõÂú®ÂÖ∂‰ªñÊÉÖÂÜµ‰∏ãÔºåÂÜÖÊ†∏Â∞ÜÂØπBPFÁ®ãÂ∫èËøîÂõûÁöÑÂÄºÈááÂèñË°åÂä®Ôºå‰æãÂ¶ÇÔºåÂÖÅËÆ∏Êàñ‰∏çÂÖÅËÆ∏ÊüêÈ°πÊìç‰Ωú„ÄÇ</p>
<p>ËøòÊúâ‰∏§ÁßçÊú∫Âà∂ÔºåÂÜÖÊ†∏ÂèØ‰ª•ÈÄöËøáÂÆÉ‰ª¨‰ΩøBPFÁ®ãÂ∫èËé∑ÂæóÈ¢ùÂ§ñÁöÑÂäüËÉΩ„ÄÇÂ∏ÆÂä©ÂáΩÊï∞ÔºàÊàñ &quot;helpers&quot;ÔºâÊòØ‰∏∫Êèê‰æõÁªôBPFÁ®ãÂ∫èËÄåÁºñÂÜôÁöÑÁâπÊÆäÂáΩÊï∞ÔºõÂÆÉ‰ª¨‰ªéÊâ©Â±ïBPFÊó∂‰ª£ÂºÄÂßãÂ∞±Â≠òÂú®‰∫Ü„ÄÇË¢´Áß∞‰∏∫kfuncsÁöÑÊú∫Âà∂ÊØîËæÉÊñ∞ÔºõÂÆÉÂÖÅËÆ∏‰ªª‰ΩïÂÜÖÊ†∏ÂáΩÊï∞Ë¢´Êèê‰æõÁªôBPFÔºåÂèØËÉΩ‰ºöÊúâ‰∏Ä‰∫õÈôêÂà∂„ÄÇKfuncsÊõ¥ÁÆÄÂçï„ÄÅÊõ¥ÁÅµÊ¥ªÔºõÂ¶ÇÊûúÂÆÉ‰ª¨È¶ñÂÖàË¢´ÂÆûÁé∞ÔºåÈÇ£‰πà‰ºº‰πé‰∏çÂ§™ÂèØËÉΩÊúâ‰∫∫‰ºöÂú®ÂêéÊù•Ê∑ªÂä†Â∏ÆÂä©Âô®„ÄÇ‰πüÂ∞±ÊòØËØ¥ÔºåkfuncsÊúâ‰∏Ä‰∏™ÈáçË¶ÅÁöÑÈôêÂà∂ÔºåÂç≥ÂÆÉ‰ª¨Âè™ËÉΩË¢´JITÁºñËØëÁöÑBPF‰ª£Á†ÅËÆøÈóÆÔºåÊâÄ‰ª•ÂÆÉ‰ª¨Âú®Áº∫‰πèJITÊîØÊåÅÁöÑÊû∂ÊûÑ‰∏äÊòØ‰∏çÂèØÁî®ÁöÑÔºàËøô‰∏™ÂàóË°®ÁõÆÂâçÂåÖÊã¨32‰ΩçArmÂíåRISC-VÔºåÂ∞ΩÁÆ°Â¢ûÂä†Ëøô‰∏§ÁßçÊîØÊåÅÁöÑË°•‰∏ÅÊ≠£Âú®ÂºÄÂèë‰∏≠Ôºâ. ÊØè‰∏™kfuncÈÉΩ‰∏∫BPFÁ®ãÂ∫èÊèê‰æõ‰∫Ü‰∏Ä‰∫õÊúâÁî®ÁöÑÂäüËÉΩÔºå‰ΩÜÂá†‰πéÊØè‰∏™kfuncÈÉΩÊö¥Èú≤‰∫ÜÂÜÖÊ†∏ÂÜÖÈÉ®Â∑•‰ΩúÊñπÂºèÁöÑÊüê‰∫õÊñπÈù¢„ÄÇ</p>
<ul>
<li>Reconsidering BPF ABI stability: <a href="https://mp.weixin.qq.com/s/wYDSXuwVgmGw-wmFgBNJcA">https://mp.weixin.qq.com/s/wYDSXuwVgmGw-wmFgBNJcA</a></li>
<li>Documentation/bpf: Add a description of &quot;stable kfuncs&quot; <a href="https://www.spinics.net/lists/kernel/msg4676660.html">https://www.spinics.net/lists/kernel/msg4676660.html</a></li>
</ul>
<h2 id="bloom-filter-map516"><a class="header" href="#bloom-filter-map516">Bloom Filter MapÔºö5.16</a></h2>
<p>Â∏ÉÈöÜËøáÊª§Âô®ÊòØ‰∏ÄÁßçËäÇÁúÅÁ©∫Èó¥ÁöÑÊ¶ÇÁéáÊï∞ÊçÆÁªìÊûÑÔºåÁî®‰∫éÂø´ÈÄüÊµãËØï‰∏Ä‰∏™ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®‰∫é‰∏Ä‰∏™ÈõÜÂêà‰∏≠„ÄÇÂú®Â∏ÉÈöÜËøáÊª§Âô®‰∏≠ÔºåÂÅáÈò≥ÊÄßÊòØÂèØËÉΩÁöÑÔºåËÄåÂÅáÈò¥ÊÄßÂàô‰∏çÂèØËÉΩ„ÄÇ</p>
<p>Ëøô‰∏™Ë°•‰∏ÅÈõÜÂåÖÊã¨Â∏ÉÈöÜËøáÊª§Âô®‰∏≠ÂèØÈÖçÁΩÆÊï∞ÈáèÁöÑÂìàÂ∏åÂÄºÂíåÊù°ÁõÆÁöÑÂü∫ÂáÜÊµãËØï„ÄÇËøô‰∫õÂü∫ÂáÜÂ§ßËá¥Ë°®ÊòéÔºåÂπ≥ÂùáËÄåË®ÄÔºå‰ΩøÁî®3‰∏™ÂìàÂ∏åÂáΩÊï∞ÊòØÊúÄÁêÜÊÉ≥ÁöÑÈÄâÊã©‰πã‰∏Ä„ÄÇÂΩìÊØîËæÉhashmapÊü•Êâæ‰∏≠‰ΩøÁî®3‰∏™ÂìàÂ∏åÂÄºÁöÑbloom filterÂíå‰∏ç‰ΩøÁî®bloom filterÁöÑhashmapÊü•ÊâæÊó∂Ôºå‰ΩøÁî®bloom filterÁöÑÊü•ÊâæÂØπ‰∫é5‰∏á‰∏™Êù°ÁõÆÂ§ßÁ∫¶Âø´15%ÔºåÂØπ‰∫é10‰∏á‰∏™Êù°ÁõÆÂø´25%ÔºåÂØπ‰∫é5‰∏á‰∏™Êù°ÁõÆÂø´180%ÔºåÂØπ‰∫é1Áôæ‰∏á‰∏™Êù°ÁõÆÂø´200%„ÄÇ</p>
<ul>
<li>BPF: Implement bloom filter map <a href="https://lwn.net/Articles/868024/">https://lwn.net/Articles/868024/</a></li>
</ul>
<h2 id="compile-once--run-everywherelinux-517"><a class="header" href="#compile-once--run-everywherelinux-517">Compile Once ‚Äì Run EverywhereÔºöLinux 5.17</a></h2>
<p>Linux 5.17 ‰∏∫ eBPF Ê∑ªÂä†‰∫Ü‰∏ÄÊ¨°ÁºñËØëÂà∞Â§ÑÊâßË°åÔºàCompile Once ‚Äì Run EverywhereÔºåÁÆÄÁß∞ CO-REÔºâÔºåÂ§ßÂ§ßÁÆÄÂåñ‰∫Ü eBPF Á®ãÂ∫èÂ§ÑÁêÜÂ§öÁâàÊú¨ÂÜÖÊ†∏ÂÖºÂÆπÊó∂ÁöÑÂ§çÊùÇÊÄß‰ª•ÂèäÂæ™ÁéØÈÄªËæëÁöÑÂ§ÑÁêÜ„ÄÇ</p>
<p>eBPF ÁöÑ‰∏ÄÊ¨°ÁºñËØëÂà∞Â§ÑÊâßË°åÔºàÁÆÄÁß∞ CO-REÔºâÈ°πÁõÆÂÄüÂä©‰∫Ü BPF Á±ªÂûãÊ†ºÂºèÔºàBPF Type Format, ÁÆÄÁß∞ BTFÔºâÊèê‰æõÁöÑË∞ÉËØï‰ø°ÊÅØÔºåÂÜçÈÄöËøá‰∏ãÈù¢ÁöÑÂõõ‰∏™Ê≠•È™§Ôºå‰ΩøÂæó eBPF Á®ãÂ∫èÂèØ‰ª•ÈÄÇÈÖç‰∏çÂêåÁâàÊú¨ÁöÑÂÜÖÊ†∏Ôºö</p>
<ul>
<li>Á¨¨‰∏ÄÔºåÂú® bpftool Â∑•ÂÖ∑‰∏≠Êèê‰æõ‰∫Ü‰ªé BTF ÁîüÊàêÂ§¥Êñá‰ª∂ÁöÑÂ∑•ÂÖ∑Ôºå‰ªéËÄåÊëÜËÑ±‰∫ÜÂØπÂÜÖÊ†∏Â§¥Êñá‰ª∂ÁöÑ‰æùËµñ„ÄÇ</li>
<li>Á¨¨‰∫åÔºåÈÄöËøáÂØπ BPF ‰ª£Á†Å‰∏≠ÁöÑËÆøÈóÆÂÅèÁßªÈáèËøõË°åÈáçÂÜôÔºåËß£ÂÜ≥‰∫Ü‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨‰∏≠Êï∞ÊçÆÁªìÊûÑÂÅèÁßªÈáè‰∏çÂêåÁöÑÈóÆÈ¢ò„ÄÇ</li>
<li>Á¨¨‰∏âÔºåÂú® libbpf ‰∏≠È¢ÑÂÆö‰πâ‰∏çÂêåÂÜÖÊ†∏ÁâàÊú¨‰∏≠Êï∞ÊçÆÁªìÊûÑÁöÑ‰øÆÊîπÔºåËß£ÂÜ≥‰∫Ü‰∏çÂêåÂÜÖÊ†∏‰∏≠Êï∞ÊçÆÁªìÊûÑ‰∏çÂÖºÂÆπÁöÑÈóÆÈ¢ò„ÄÇ</li>
<li>Á¨¨ÂõõÔºåÂú® libbpf ‰∏≠Êèê‰æõ‰∏ÄÁ≥ªÂàóÁöÑÂÜÖÊ†∏ÁâπÊÄßÊé¢ÊµãÂ∫ìÂáΩÊï∞ÔºåËß£ÂÜ≥‰∫Ü eBPF Á®ãÂ∫èÂú®‰∏çÂêåÂÜÖÊ†∏ÂÜÖÁâàÊú¨‰∏≠ÈúÄË¶ÅÊâßË°å‰∏çÂêåË°å‰∏∫ÁöÑÈóÆÈ¢ò„ÄÇÊØîÂ¶ÇÔºå‰Ω†ÂèØ‰ª•Áî® bpf_core_type_exists() Âíåbpf_core_field_exists() ÂàÜÂà´Ê£ÄÊü•ÂÜÖÊ†∏Êï∞ÊçÆÁ±ªÂûãÂíåÊàêÂëòÂèòÈáèÊòØÂê¶Â≠òÂú®Ôºå‰πüÂèØ‰ª•Áî®Á±ª‰ºº extern int LINUX_KERNEL_VERSION __kconfig ÁöÑÊñπÂºèÊü•ËØ¢ÂÜÖÊ†∏ÁöÑÈÖçÁΩÆÈÄâÈ°π„ÄÇ</li>
</ul>
<p>ÈááÁî®Ëøô‰∫õÊñπÊ≥ï‰πãÂêéÔºåCO-RE Â∞±‰ΩøÂæó eBPF Á®ãÂ∫èÂèØ‰ª•Âú®ÂºÄÂèëÁéØÂ¢ÉÁºñËØëÂÆåÊàê‰πãÂêéÔºåÂàÜÂèëÂà∞‰∏çÂêåÁâàÊú¨ÂÜÖÊ†∏ÁöÑÊú∫Âô®‰∏≠ËøêË°åÔºåÂπ∂‰∏î‰πü‰∏çÂÜçÈúÄË¶ÅÁõÆÊ†áÊú∫Âô®ÂÆâË£ÖÂêÑÁßçÂºÄÂèëÂ∑•ÂÖ∑ÂíåÂÜÖÊ†∏Â§¥Êñá‰ª∂„ÄÇÊâÄ‰ª•ÔºåLinux ÂÜÖÊ†∏Á§æÂå∫Êõ¥Êé®ËçêÊâÄÊúâÂºÄÂèëËÄÖ‰ΩøÁî® CO-RE Âíå libbpf Êù•ÊûÑÂª∫ eBPF Á®ãÂ∫è„ÄÇÂÆûÈôÖ‰∏äÔºåÂ¶ÇÊûú‰Ω†ÁúãËøá BCC ÁöÑÊ∫ê‰ª£Á†ÅÔºå‰Ω†‰ºöÂèëÁé∞ BCC Â∑≤ÁªèÊääÂæàÂ§öÂ∑•ÂÖ∑ÈÉΩËøÅÁßªÂà∞‰∫Ü CO-RE„ÄÇ</p>
<ul>
<li>eBPFÂ§öÂÜÖÊ†∏ÁâàÊú¨ÂÖºÂÆπËØ¶Ëß£Ôºö <a href="https://time.geekbang.org/column/article/534577">https://time.geekbang.org/column/article/534577</a></li>
<li>BPF CO-RE reference guideÔºö<a href="https://nakryiko.com/posts/bpf-core-reference-guide/">https://nakryiko.com/posts/bpf-core-reference-guide/</a></li>
</ul>
<h2 id="bpf_loop-ËæÖÂä©ÂáΩÊï∞517"><a class="header" href="#bpf_loop-ËæÖÂä©ÂáΩÊï∞517">bpf_loop() ËæÖÂä©ÂáΩÊï∞Ôºö5.17</a></h2>
<p>Êâ©Â±ïÁöÑBPFËôöÊãüÊú∫ÁöÑ‰∏ªË¶ÅÁâπÂæÅ‰πã‰∏ÄÊòØÂÜÖÁΩÆ‰∫éÂÜÖÊ†∏ÁöÑÈ™åËØÅÂô®ÔºåÂÆÉÁ°Æ‰øùÊâÄÊúâBPFÁ®ãÂ∫èÈÉΩËÉΩÂÆâÂÖ®ËøêË°å„ÄÇ‰∏çËøáÔºåBPFÂºÄÂèëËÄÖÂ∏∏Â∏∏ËÆ§‰∏∫È™åËØÅÂô®ÊúâÁÇπÂñúÂøßÂèÇÂçäÔºõËôΩÁÑ∂ÂÆÉËÉΩÂú®ÂæàÂ§öÈóÆÈ¢òÂèëÁîü‰πãÂâçÊäì‰ΩèÂÆÉ‰ª¨Ôºå‰ΩÜÂÆÉ‰πüÂæàÈöæËÆ©‰∫∫Êª°ÊÑè„ÄÇÂ∞ÜÂÖ∂‰∏é‰∏Ä‰∏™ÂñÑÊÑè‰ΩÜÂèóËßÑÂàôÁ∫¶Êùü‰∏îÊåëÂâîÁöÑÂÆòÂÉöÊú∫ÊûÑÁõ∏ÊèêÂπ∂ËÆ∫Âπ∂‰∏çÊòØÂÆåÂÖ®ÈîôÁöÑ„ÄÇJoanne KoongÊèêÂá∫ÁöÑ bpf_loop() Âª∫ËÆÆÊòØ‰∏∫‰∫ÜËÆ©‰∏ÄÁßçÁ±ªÂûãÁöÑÂæ™ÁéØÁªìÊûÑÊõ¥ÂÆπÊòìÂèñÊÇ¶BPFÁöÑÂÆòÂÉö‰ª¨„ÄÇ</p>
<p>ÁÆÄËÄåË®Ä‰πãÔºåËøôÂ∞±ÊòØKoongÁöÑË°•‰∏ÅÁöÑÁõÆÁöÑ„ÄÇÂÆÉÂ¢ûÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑËæÖÂä©ÂáΩÊï∞ÔºåÂèØ‰ª•‰ªéBPF‰ª£Á†Å‰∏≠Ë∞ÉÁî®„ÄÇ</p>
<pre><code class="language-c">    long bpf_loop(u32 iterations, long (*loop_fn)(u32 index, void *ctx),
          void *ctx, u64 flags);
</code></pre>
<p>ÂØπ bpf_loop() ÁöÑË∞ÉÁî®Â∞ÜÂØºËá¥ÂØπ loop_fn() ÁöÑËø≠‰ª£Ë∞ÉÁî®ÔºåËø≠‰ª£Êï∞Âíå‰º†ÂÖ•ÁöÑ ctx ‰Ωú‰∏∫ÂèÇÊï∞„ÄÇflags ÂÄºÁõÆÂâçÊú™‰ΩøÁî®ÔºåÂøÖÈ°ª‰∏∫Èõ∂„ÄÇloop_fn() ÈÄöÂ∏∏Â∞ÜËøîÂõû0ÔºõËøîÂõûÂÄº‰∏∫1Â∞ÜÁ´ãÂç≥ÁªìÊùüËø≠‰ª£„ÄÇ‰∏çÂÖÅËÆ∏ÊúâÂÖ∂‰ªñÁöÑËøîÂõûÂÄº„ÄÇ</p>
<p>‰∏çÂÉè bpf_for_each_map_elem() ÂèóÈôê‰∫é bpf map Â§ßÂ∞èÔºåbpf_loop() ÁöÑÂæ™ÁéØÊ¨°Êï∞È´òËææ 1&lt;&lt;23 = 8388608ÔºàË∂ÖËøá 8 Áôæ‰∏áÔºâÊ¨°ÔºõÂ§ßÂ§ßÂú∞Êâ©Â±ï‰∫Ü bpf_loop() ÁöÑÂ∫îÁî®Âú∫ÊôØ„ÄÇ‰∏çËøáÔºåbpf_loop() Âπ∂Ê≤°ÊúâÂèóÈôê‰∫é BPF Êåá‰ª§Êï∞Ôºà1 Áôæ‰∏áÊù°ÔºâÔºåËøôÊòØÂõ†‰∏∫Âæ™ÁéØÂèëÁîüÂú® bpf_loop() Â∏ÆÂä©ÂáΩÊï∞ÂÜÖÈÉ®„ÄÇ</p>
<ul>
<li>A different approach to BPF loopsÔºö<a href="https://lwn.net/Articles/877062/">https://lwn.net/Articles/877062/</a></li>
<li>eBPF Talk: ÂÆûÊàòÁªèÈ™å‰πã loopÔºö<a href="https://mp.weixin.qq.com/s/neOVsMNVWFbwpTSek-_YsA">https://mp.weixin.qq.com/s/neOVsMNVWFbwpTSek-_YsA</a></li>
</ul>
<h2 id="bpf_link_type_kprobe_multi518"><a class="header" href="#bpf_link_type_kprobe_multi518">BPF_LINK_TYPE_KPROBE_MULTIÔºö5.18</a></h2>
<p>Ëøô‰∏™Ë°•‰∏ÅÈõÜÂ¢ûÂä†‰∫ÜÊñ∞ÁöÑÈìæÊé•Á±ªÂûãBPF_TRACE_KPROBE_MULTIÔºåÂÆÉÈÄöËøáMasamiÂà∂‰ΩúÁöÑfprobe API [1]Êù•ËøûÊé•kprobeÁ®ãÂ∫è„ÄÇfprobe APIÂÖÅËÆ∏‰∏ÄÊ¨°Âú®Â§ö‰∏™ÂáΩÊï∞‰∏äÈôÑÂä†Êé¢ÈíàÔºåÈÄüÂ∫¶ÈùûÂ∏∏Âø´ÔºåÂõ†‰∏∫ÂÆÉÂ∑•‰ΩúÂú®ftrace‰πã‰∏ä„ÄÇÂè¶‰∏ÄÊñπÈù¢ÔºåÂÆÉÂ∞ÜÊé¢ÊµãÁÇπÈôêÂà∂Âú®ÂáΩÊï∞ÂÖ•Âè£ÊàñËøîÂõû„ÄÇ</p>
<ul>
<li>bpf: Add kprobe multi linkÔºö<a href="https://lwn.net/Articles/885811/">https://lwn.net/Articles/885811/</a></li>
</ul>
<h2 id="Âä®ÊÄÅÊåáÈíàÂíåÁ±ªÂûãÊåáÈíà519"><a class="header" href="#Âä®ÊÄÅÊåáÈíàÂíåÁ±ªÂûãÊåáÈíà519">Âä®ÊÄÅÊåáÈíàÂíåÁ±ªÂûãÊåáÈíàÔºö5.19</a></h2>
<p>BPFÁ®ãÂ∫è‰∏≠ÁöÑÊâÄÊúâÂÜÖÂ≠òËÆøÈóÆÈÉΩ‰ΩøÁî®È™åËØÅÂô®ËøõË°åÂÆâÂÖ®ÊÄßÈùôÊÄÅÊ£ÄÊü•ÔºåÈ™åËØÅÂô®Âú®ÂÖÅËÆ∏Á®ãÂ∫èËøêË°å‰πãÂâçÂØπÂÖ∂ËøõË°åÂÖ®Èù¢ÂàÜÊûê„ÄÇËôΩÁÑ∂ËøôÂÖÅËÆ∏ BPF Á®ãÂ∫èÂú®ÂÜÖÊ†∏Á©∫Èó¥‰∏≠ÂÆâÂÖ®ËøêË°åÔºå‰ΩÜÂÆÉÈôêÂà∂‰∫ÜËØ•Á®ãÂ∫èÂ¶Ç‰Ωï‰ΩøÁî®ÊåáÈíà„ÄÇÁõ¥Âà∞ÊúÄËøëÔºå‰∏Ä‰∏™ËøôÊ†∑ÁöÑÈôêÂà∂ÊòØÂú® BPF Á®ãÂ∫è‰∏≠Ë¢´ÊåáÈíàÂºïÁî®ÁöÑÂÜÖÂ≠òÂå∫ÂüüÁöÑÂ§ßÂ∞èÂøÖÈ°ªÂú®Âä†ËΩΩ BPF Á®ãÂ∫èÊó∂ÈùôÊÄÅÁü•ÈÅì„ÄÇJoanne Koong ÊúÄËøëËÆæÁΩÆÁöÑ‰∏Ä‰∏™Ë°•‰∏ÅÈõÜÂ¢ûÂº∫‰∫Ü BPFÔºå‰ª•ÊîØÊåÅ‰ΩøÁî®ÊåáÂêëÂä®ÊÄÅÂ§ßÂ∞èÁöÑÂÜÖÂ≠òÂå∫ÂüüÁöÑÊåáÈíàÂä†ËΩΩÁ®ãÂ∫è„ÄÇ</p>
<p>Koong ÁöÑË°•‰∏ÅÈõÜÂ¢ûÂä†‰∫ÜÂØπËÆøÈóÆ BPF Á®ãÂ∫è‰∏≠Âä®ÊÄÅÂ§ßÂ∞èÁöÑÂÜÖÂ≠òÂå∫ÂüüÁöÑÊîØÊåÅÔºåÂÖ∂‰∏≠ÂåÖÂê´‰∏Ä‰∏™Âêç‰∏∫ dynptrs ÁöÑÊñ∞ÁâπÊÄß„ÄÇdynptrs ËÉåÂêéÁöÑ‰∏ªË¶ÅÊÄùÊÉ≥ÊòØÂ∞ÜÊåáÂêëÂä®ÊÄÅÂ§ßÂ∞èÁöÑÊï∞ÊçÆÂå∫ÂüüÁöÑÊåáÈíà‰∏éÈ™åËØÅÂô®Âíå‰∏Ä‰∫õ BPF ËæÖÂä©ÂáΩÊï∞‰ΩøÁî®ÁöÑÂÖÉÊï∞ÊçÆÁõ∏ÂÖ≥ËÅîÔºå‰ª•Á°Æ‰øùÂØπËØ•Âå∫ÂüüÁöÑËÆøÈóÆÊòØÊúâÊïàÁöÑ„ÄÇKoong ÁöÑË°•‰∏ÅÈõÜÂú®‰∏Ä‰∏™Êñ∞ÂÆö‰πâÁöÑÁ±ªÂûã‰∏≠ÂàõÂª∫‰∫ÜËøôÁßçÂÖ≥ËÅîÔºåÁß∞‰∏∫struct bpf_dynptr„ÄÇËøôÁßçÁªìÊûÑÂØπ BPF Á®ãÂ∫èÊòØ‰∏çÈÄèÊòéÁöÑ„ÄÇ</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/rz4pd41Y-Cet5YVSAKmCRw">https://mp.weixin.qq.com/s/rz4pd41Y-Cet5YVSAKmCRw</a></li>
</ul>
<h2 id="usdt519"><a class="header" href="#usdt519">USDTÔºö5.19</a></h2>
<p>ÈùôÊÄÅË∑üË∏™ÁÇπÔºàtracepointÔºâÔºåÂú®Áî®Êà∑Á©∫Èó¥‰πüË¢´Áß∞‰∏∫ USDTÔºàÁî®Êà∑ÈùôÊÄÅÂÆö‰πâÁöÑË∑üË∏™ÔºâÊé¢ÈíàÔºàÂ∫îÁî®Á®ãÂ∫è‰∏≠ÊÑüÂÖ¥Ë∂£ÁöÑÁâπÂÆö‰ΩçÁΩÆÔºâÔºåË∑üË∏™Âô®ÂèØ‰ª•Âú®Ê≠§Â§ÑÊåÇËΩΩÊ£ÄÊü•‰ª£Á†ÅÊâßË°åÂíåÊï∞ÊçÆ„ÄÇÂÆÉ‰ª¨Áî±ÂºÄÂèë‰∫∫ÂëòÂú®Ê∫ê‰ª£Á†Å‰∏≠ÊòéÁ°ÆÂÆö‰πâÔºåÈÄöÂ∏∏Âú®ÁºñËØëÊó∂Áî® ‚Äú‚Äìenable-trace‚Äù Á≠âÊ†áÂøóÂêØÁî®„ÄÇÈùôÊÄÅË∑üË∏™ÁÇπÁöÑ‰ºòÂäøÂú®‰∫éÂÆÉ‰ª¨‰∏ç‰ºöÁªèÂ∏∏ÂèòÂåñÔºöÂºÄÂèë‰∫∫ÂëòÈÄöÂ∏∏‰ºö‰øùÊåÅÁ®≥ÂÆöÁöÑÈùôÊÄÅË∑üË∏™ ABIÔºåÊâÄ‰ª•Ë∑üË∏™Â∑•ÂÖ∑Âú®‰∏çÂêåÁöÑÂ∫îÁî®Á®ãÂ∫èÁâàÊú¨‰πãÈó¥Â∑•‰ΩúÔºåËøôÂæàÊúâÁî®Ôºå‰æãÂ¶ÇÂΩìÂçáÁ∫ß PostgreSQL ÂÆâË£ÖÂπ∂ÈÅáÂà∞ÊÄßËÉΩÈôç‰ΩéÊó∂„ÄÇ</p>
<ul>
<li>eBPF Ê¶ÇËø∞ÔºöÁ¨¨ 5 ÈÉ®ÂàÜÔºöË∑üË∏™Áî®Êà∑ËøõÁ®ãÔºö<a href="https://www.ebpf.top/post/ebpf-overview-part-5/">https://www.ebpf.top/post/ebpf-overview-part-5/</a></li>
<li>Using user-space tracepoints with BPFÔºö<a href="https://lwn.net/Articles/753601/">https://lwn.net/Articles/753601/</a></li>
</ul>
<h2 id="bpf-panic61"><a class="header" href="#bpf-panic61">bpf panicÔºö6.1</a></h2>
<p>BPFÂ≠êÁ≥ªÁªüÁöÑÂÖ≥ÈîÆÂçñÁÇπ‰πã‰∏ÄÊòØÂä†ËΩΩBPFÁ®ãÂ∫èÊòØÂÆâÂÖ®ÁöÑÔºöBPFÈ™åËØÅÂô®Âú®ÂÖÅËÆ∏Âä†ËΩΩ‰πãÂâçÁ°Æ‰øùËØ•Á®ãÂ∫è‰∏ç‰ºö‰º§ÂÆ≥ÂÜÖÊ†∏„ÄÇÈöèÁùÄÊõ¥Â§öÁöÑÂäüËÉΩË¢´Êèê‰æõÁªôBPFÁ®ãÂ∫èÔºåËøôÁßç‰øùËØÅ‰πüËÆ∏‰ºöÂ§±Âéª‰∏Ä‰∫õÂäõÈáèÔºå‰ΩÜÂç≥‰æøÂ¶ÇÊ≠§ÔºåÁúãÂà∞ Artem Savkov ÁöÑËøô‰∏™ÊèêËÆÆÂä†ÂÖ•‰∫Ü‰∏Ä‰∏™ÊòéÁ°ÆËÆæËÆ°‰∏∫‰ΩøÁ≥ªÁªüÂ¥©Ê∫ÉÁöÑBPFÂä©ÊâãÔºåÂèØËÉΩ‰ºöËÆ©‰∫∫ÊúâÁÇπÂêÉÊÉä„ÄÇÂ¶ÇÊûúËøô‰∏™Ë°•‰∏ÅÈõÜ‰ª•Á±ª‰ºº‰∫éÁõÆÂâçÁöÑÂΩ¢ÂºèË¢´ÂêàÂπ∂ÔºåÂÆÉÂ∞ÜÊòØ‰∏Ä‰∏™Êñ∞Êó∂‰ª£ÁöÑÈ¢ÑÂÖÜÔºåÂç≥Ëá≥Â∞ëÂú®Êüê‰∫õÊÉÖÂÜµ‰∏ãÔºåBPFÁ®ãÂ∫èË¢´ÂÖÅËÆ∏ÂÖ¨ÂºÄÂú∞ËøõË°åÁ†¥Âùè„ÄÇ</p>
<p>Ê≠£Â¶Ç Savkov ÊâÄÊåáÂá∫ÁöÑÔºåBPF ÁöÑ‰∏ªË¶ÅÁî®‰æã‰πã‰∏ÄÊòØÂÜÖÊ†∏Ë∞ÉËØïÔºåËøôÈ°π‰ªªÂä°‰πüÁªèÂ∏∏Âõ†‰∏∫Â≠òÂú®‰∏Ä‰∏™ÈÄÇÊó∂ÁöÑÂ¥©Ê∫ÉËΩ¨ÂÇ®ËÄåÂæóÂà∞Â∏ÆÂä©„ÄÇÈÄöËøá‰ΩøÂÜÖÊ†∏ÁöÑpanic() ÂáΩÊï∞ÂØπBPFÁ®ãÂ∫èÂèØÁî®ÔºåSavkovËØïÂõæÂ∞ÜËøô‰∏§ËÄÖÁªìÂêàËµ∑Êù•ÔºåÂÖÅËÆ∏BPFÁ®ãÂ∫èÂú®Ê£ÄÊµãÂà∞Ë°®ÊòéÂºÄÂèë‰∫∫ÂëòÊ≠£Âú®ÂØªÊâæÁöÑÈóÆÈ¢òÁöÑÊù°‰ª∂Êó∂ÂØºËá¥Â¥©Ê∫ÉÔºåÂπ∂ÂàõÂª∫Â¥©Ê∫ÉËΩ¨ÂÇ®„ÄÇSavkov‰ºº‰πé‰∏çÊòØÂîØ‰∏ÄÊÉ≥Ë¶ÅËøôÁßçËÉΩÂäõÁöÑ‰∫∫ÔºõJiri OlsaÊåáÂá∫Ôºå‰ªñ‰πüÊî∂Âà∞‰∫ÜÂÖ≥‰∫éËøôÁßçÂäüËÉΩÁöÑËØ∑Ê±Ç„ÄÇ</p>
<ul>
<li>The BPF panic function: <a href="https://lwn.net/Articles/901284/">https://lwn.net/Articles/901284/</a></li>
</ul>
<h2 id="bpf-ÂÜÖÂ≠òÂàÜÈÖçÂô®ÈìæË°®61"><a class="header" href="#bpf-ÂÜÖÂ≠òÂàÜÈÖçÂô®ÈìæË°®61">BPF ÂÜÖÂ≠òÂàÜÈÖçÂô®„ÄÅÈìæË°®Ôºö6.1</a></h2>
<p>Êú¨Á≥ªÂàó‰ªãÁªç‰∫ÜÁî®Êà∑ÂÆö‰πâÁöÑBPFÂØπË±°Âú®Á®ãÂ∫è‰∏≠ÁöÑ BTF Á±ªÂûã„ÄÇËøôÂÖÅËÆ∏BPFÁ®ãÂ∫èÂàÜÈÖç‰ªñ‰ª¨Ëá™Â∑±ÁöÑÂØπË±°ÔºåÂª∫Á´ã‰ªñ‰ª¨ÁöÑËá™Â∑±ÁöÑÂØπË±°Â±ÇÊ¨°ÔºåÂπ∂‰ΩøÁî®Áî±BPF ËøêË°åÊó∂Êèê‰æõÁöÑÂü∫Êú¨ÊûÑ‰ª∂Êù•ÁÅµÊ¥ªÂú∞Âª∫Á´ãËá™Â∑±ÁöÑÊï∞ÊçÆÁªìÊûÑ„ÄÇ</p>
<p>ÁÑ∂ÂêéÔºåÊàë‰ª¨‰ªãÁªç‰∫ÜÂØπÂçï‰∏ÄÊâÄÊúâÊùÉBPFÈìæË°®ÁöÑÊîØÊåÅ„ÄÇÂÆÉÂèØ‰ª•ÊîæÂú®BPFÊò†Â∞ÑÊàñÂàÜÈÖçÁöÑÂØπË±°‰∏≠ÔºåÂπ∂ÊääËøô‰∫õË¢´ÂàÜÈÖçÁöÑÂØπË±°‰Ωú‰∏∫ÂÖÉÁ¥†„ÄÇÂÆÉ‰Ωú‰∏∫‰∏Ä‰∏™‰æµÂÖ•ÊÄßÁöÑÈõÜÂêàÂ∑•‰Ωú„ÄÇËøôÊ†∑ÂÅöÁöÑÁõÆÁöÑÊòØ‰∏∫‰∫ÜÂú®Â∞ÜÊù•‰ΩøÂàÜÈÖçÁöÑÂØπË±°Êàê‰∏∫Â§ö‰∏™Êï∞ÊçÆÁªìÊûÑÁöÑ‰∏ÄÈÉ®ÂàÜ„ÄÇ</p>
<p>Ëøô‰∏™Ë°•‰∏ÅÂíåÊú™Êù•Ë°•‰∏ÅÁöÑÊúÄÁªàÁõÆÊ†áÊòØÂÖÅËÆ∏‰∫∫‰ª¨Âú® BPF C ‰∏≠ÂÅö‰∏Ä‰∫õÊúâÈôêÁöÑÂÜÖÊ†∏ÂºèÁºñÁ®ãÔºåÂπ∂ÂÖÅËÆ∏Á®ãÂ∫èÂëòÁÅµÊ¥ªÂú∞‰ªéÂü∫Êú¨ÁöÑÊûÑÂª∫Âùó‰∏≠ÁÅµÊ¥ªÂú∞ÊûÑÂª∫Ëá™Â∑±ÁöÑÂ§çÊùÇÊï∞ÊçÆÁªìÊûÑ„ÄÇ</p>
<p>ÂÖ≥ÈîÆÁöÑÂå∫Âà´Âú®‰∫éÔºåËøôÁßçÁ®ãÂ∫èÊòØÁªèËøáÈ™åËØÅÁöÑÔºåÊòØÂÆâÂÖ®ÁöÑÔºå‰øùÂ≠òÁ≥ªÁªüÁöÑËøêË°åÊó∂ÂÆåÊï¥ÊÄßÔºåÂπ∂Ë¢´ËØÅÊòéÊòØÊ≤°ÊúâÈîôËØØÁöÑ</p>
<p>ÂÖ∑‰ΩìÁöÑÂäüËÉΩÂåÖÂê´</p>
<ul>
<li>ÂàÜÈÖçÂØπË±°</li>
<li>bpf_obj_new, bpf_obj_drop Êù•ÂàÜÈÖçÂíåÈáäÊîæÂØπË±°</li>
<li>Âçï‰∏ÄÊâÄÊúâÊùÉÁöÑBPFÈìæË°®
<ul>
<li>Âú® BPF maps ‰∏≠ÊîØÊåÅÂÆÉ‰ª¨</li>
<li>Âú®ÂàÜÈÖçÁöÑÂØπË±°‰∏≠ÊîØÊåÅÂÆÉ‰ª¨</li>
</ul>
</li>
<li>ÂÖ®Â±ÄËá™ÊóãÈîÅ„ÄÇ</li>
<li>Âú®Ë¢´ÂàÜÈÖçÂØπË±°‰∏≠ÁöÑËá™ÊóãÈîÅ„ÄÇ</li>
</ul>
<p>ÂèÇËÄÉÔºö<a href="https://lwn.net/Articles/914833/">https://lwn.net/Articles/914833/</a></p>
<h2 id="user-ring-buffer-61"><a class="header" href="#user-ring-buffer-61">user ring buffer 6.1</a></h2>
<p>Ëøô‰∏™Ë°•‰∏ÅÈõÜÂÆö‰πâ‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÊò†Â∞ÑÁ±ªÂûãÔºåBPF_MAP_TYPE_USER_RINGBUFÔºåÂÆÉÂú®‰∏Ä‰∏™ÁéØÂΩ¢ÁºìÂÜ≤Âô®‰∏äÊèê‰æõ‰∫ÜÂçïÁî®Êà∑Á©∫Èó¥Áîü‰∫ßËÄÖ/ÂçïÂÜÖÊ†∏Ê∂àË¥πËÄÖÁöÑËØ≠‰πâ„ÄÇ  Èô§‰∫ÜÊñ∞ÁöÑÊò†Â∞ÑÁ±ªÂûãÂ§ñÔºåËøòÂ¢ûÂä†‰∫Ü‰∏Ä‰∏™Âêç‰∏∫bpf_user_ringbuf_drain()ÁöÑËæÖÂä©ÂáΩÊï∞ÔºåÂÆÉÂÖÅËÆ∏BPFÁ®ãÂ∫èÊåáÂÆö‰∏Ä‰∏™ÂÖ∑ÊúâÂ¶Ç‰∏ãÁ≠æÂêçÁöÑÂõûË∞ÉÔºåÊ†∑Êú¨Áî±ËæÖÂä©ÂáΩÊï∞ÂèëÂ∏ÉÂà∞ËØ•ÂõûË∞É„ÄÇ</p>
<pre><code class="language-c">voidÔºàstruct bpf_dynptr *dynptr, void *contextÔºâ„ÄÇ
</code></pre>
<p>ÁÑ∂ÂêéÁ®ãÂ∫èÂèØ‰ª•‰ΩøÁî®bpf_dynptr_read()Êàñbpf_dynptr_data()ËæÖÂä©ÂáΩÊï∞Êù•ÂÆâÂÖ®Âú∞‰ªédynptr‰∏≠ËØªÂèñÊ†∑Êú¨„ÄÇÁõÆÂâçÊ≤°ÊúâÂèØÁî®ÁöÑËæÖÂä©ÂáΩÊï∞Êù•Á°ÆÂÆöÊ†∑Êú¨ÁöÑÂ§ßÂ∞èÔºå‰ΩÜÊòØÂ¶ÇÊûúÈúÄË¶ÅÁöÑËØùÔºåÂèØ‰ª•ÂæàÂÆπÊòìÂú∞Ê∑ªÂä†‰∏Ä‰∏™„ÄÇ</p>
<p>libbpf ‰πüÊ∑ªÂä†‰∫Ü‰∏Ä‰∫õÂØπÂ∫îÁöÑ API:</p>
<pre><code class="language-c">struct ring_buffer_user *
ring_buffer_user__new(int map_fd,
                      const struct ring_buffer_user_opts *opts);
void ring_buffer_user__free(struct ring_buffer_user *rb);
void *ring_buffer_user__reserve(struct ring_buffer_user *rb,
        uint32_t size);
void *ring_buffer_user__poll(struct ring_buffer_user *rb, uint32_t size,
           int timeout_ms);
void ring_buffer_user__discard(struct ring_buffer_user *rb, void *sample);
void ring_buffer_user__submit(struct ring_buffer_user *rb, void *sample);
</code></pre>
<ul>
<li>bpf: Add user-space-publisher ring buffer map typeÔºö <a href="https://lwn.net/Articles/907056/">https://lwn.net/Articles/907056/</a></li>
</ul>
<blockquote>
<ul>
<li>Êú¨ÊñáÁî± eunomia-bpf Âõ¢ÈòüÂÆåÊàêÔºåÊàë‰ª¨Ê≠£Âú®Êé¢Á¥¢ eBPF Âíå WebAssembly Áõ∏‰∫íÁªìÂêàÁöÑÂ∑•ÂÖ∑ÈìæÂíåËøêË°åÊó∂: <a href="https://github.com/eunomia-bpf/wasm-bpf">https://github.com/eunomia-bpf/wasm-bpf</a></li>
<li>‰ª•ÂèäÂú® Wasm Âíå eBPF ‰πã‰∏äÔºåÂ∞ùËØïÊûÑÂª∫‰∏Ä‰∫õÊúâË∂£ÁöÑÂ∫îÁî®Âú∫ÊôØÔºö</li>
</ul>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
